<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Comprehensive TARE Test Suite</title>
    <script src = "../src/moment.js"></script>
    <script src = "../src/polyfit.js"></script>
    <script src = "../src/butil.js"></script>
    <script src = "../src/broad.js"></script>
    <script src = "../src/beebrain.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 20px 0; padding: 15px; }
        .test-section h2 { color: #333; border-bottom: 2px solid #007acc; }
        .test-section h3 { color: #666; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>

<h1>Comprehensive TARE Test Suite</h1>
<p>Testing #TARE functionality, odom mode behavior, and transition scenarios.</p>

<div id="results"></div>
  
<script>
function getTestParams(goalName = "test/tare") {
  return {
    yoog: goalName,
    tini: "20240101", 
    vini: 100,
    tfin: "20240110",
    vfin: 300,
    runits: "d",
    yaw: 1,
    dir: 1,
    kyoom: false,
    asof: "20240110",  // Add explicit asof parameter
    aggday: "last",    // Use last for TARE testing to avoid aggregation
    road: [
      [null, 150, 10],
      ["20240110", 300, null]
    ]
  };
}

function runComprehensiveTests() {
  const resultsDiv = document.getElementById('results');
  let results = "";
  
  // Test Suite 1: Basic #TARE Functionality
  results += '<div class="test-section">';
  results += "<h2>Test Suite 1: Basic #TARE Functionality</h2>";
  
  const testData = [
    ["20240101", 100, "first reading"],
    ["20240102", 120, "second reading"], 
    ["20240103", 140, "third reading"],
    ["20240104", 160, "fourth reading #TARE"], // This should be tared
    ["20240105", 180, "fifth reading"],
    ["20240106", 200, "sixth reading"]
  ];
  
  try {
    const bb = new beebrain({params: {...getTestParams("test/basic_tare"), odom: true}, data: testData});
    
    results += "<h3>Original Data:</h3>";
    testData.forEach(d => {
      results += `${d[0]}: ${d[1]} - ${d[2]}<br/>`;
    });
    
    results += "<h3>Processed Data:</h3>";
    bb.data.forEach(d => {
      results += `${new Date(d[0]*1000).toISOString().substr(0,10)}: ${d[1]}<br/>`;
    });
    
    results += "<h3>Tarings Detected:</h3>";
    if (bb.tarings && bb.tarings.length > 0) {
      bb.tarings.forEach(reset => {
        results += `Taring at: ${new Date(reset*1000).toISOString().substr(0,10)}<br/>`;
      });
    } else {
      results += "No tarings detected<br/>";
    }
    
    results += `<h3>Status:</h3><span class="success">${bb.getStats().error || "No errors"}</span>`;
    
  } catch (error) {
    results += `<h3>Error:</h3><span class="error">${error.toString()}</span>`;
  }
  results += '</div>';
  
  // Test Suite 2: Odom Mode Behavior
  results += '<div class="test-section">';
  results += "<h2>Test Suite 2: Odom Mode Behavior</h2>";
  
  const zeroData = [
    ["20240101", 100, "first reading"],
    ["20240102", 150, "second reading"],
    ["20240103", 0, "zero value"],
    ["20240104", 50, "continuing"],
    ["20240105", 75, "more data"]
  ];
  
  const tareData = [
    ["20240101", 100, "first reading"],
    ["20240102", 150, "second reading"],
    ["20240103", 200, "finished book #TARE"],
    ["20240104", 25, "new book"],
    ["20240105", 50, "continuing"]
  ];
  
  // Test 2.1: odom=true - zeros trigger resets
  results += "<h3>Test 2.1: odom=true - zeros trigger resets</h3>";
  try {
    const params1 = {...getTestParams("test/odom_true"), odom: true};
    const bb1 = new beebrain({params: params1, data: zeroData});
    results += "Original: [100, 150, 0, 50, 75]<br/>";
    results += "Processed: [" + bb1.data.map(d => d[1]).join(", ") + "]<br/>";
    results += "Tarings: [" + bb1.tarings.map(t => new Date(t*1000).toISOString().substr(0,10)).join(", ") + "]<br/>";
    results += `Status: <span class="success">${bb1.getStats().error || "No errors"}</span><br/><br/>`;
  } catch (e) {
    results += `Error: <span class="error">${e.toString()}</span><br/><br/>`;
  }
  
  // Test 2.2: odom=false - zeros ignored
  results += "<h3>Test 2.2: odom=false - zeros ignored</h3>";
  try {
    const params2 = {...getTestParams("test/odom_false"), odom: false};
    const bb2 = new beebrain({params: params2, data: zeroData});
    results += "Original: [100, 150, 0, 50, 75]<br/>";
    results += "Processed: [" + bb2.data.map(d => d[1]).join(", ") + "]<br/>";
    results += "Tarings: [" + bb2.tarings.map(t => new Date(t*1000).toISOString().substr(0,10)).join(", ") + "]<br/>";
    results += `Status: <span class="success">${bb2.getStats().error || "No errors"}</span><br/><br/>`;
  } catch (e) {
    results += `Error: <span class="error">${e.toString()}</span><br/><br/>`;
  }
  
  // Test 2.3: #TARE works with odom=true
  results += "<h3>Test 2.3: #TARE works with odom=true</h3>";
  try {
    const params3 = {...getTestParams("test/tare_odom_true"), odom: true};
    const bb3 = new beebrain({params: params3, data: tareData});
    results += "Original: [100, 150, 200, 25, 50]<br/>";
    results += "Processed: [" + bb3.data.map(d => d[1]).join(", ") + "]<br/>";
    results += "Tarings: [" + bb3.tarings.map(t => new Date(t*1000).toISOString().substr(0,10)).join(", ") + "]<br/>";
    results += `Status: <span class="success">${bb3.getStats().error || "No errors"}</span><br/><br/>`;
  } catch (e) {
    results += `Error: <span class="error">${e.toString()}</span><br/><br/>`;
  }
  
  // Test 2.4: #TARE works with odom=false
  results += "<h3>Test 2.4: #TARE works with odom=false</h3>";
  try {
    const params4 = {...getTestParams("test/tare_odom_false"), odom: false};
    const bb4 = new beebrain({params: params4, data: tareData});
    results += "Original: [100, 150, 200, 25, 50]<br/>";
    results += "Processed: [" + bb4.data.map(d => d[1]).join(", ") + "]<br/>";
    results += "Tarings: [" + bb4.tarings.map(t => new Date(t*1000).toISOString().substr(0,10)).join(", ") + "]<br/>";
    results += `Status: <span class="success">${bb4.getStats().error || "No errors"}</span><br/><br/>`;
  } catch (e) {
    results += `Error: <span class="error">${e.toString()}</span><br/><br/>`;
  }
  
  results += '</div>';
  
  // Test Suite 3: Transition Scenarios
  results += '<div class="test-section">';
  results += "<h2>Test Suite 3: Transition Scenarios</h2>";
  
  // Test 3.1: Legacy zero-based resets (no #TARE tags)
  results += "<h3>Test 3.1: Legacy zero-based resets only</h3>";
  try {
    const legacyData = [
      ["20240101", 100, "first reading"],
      ["20240102", 150, "second reading"],
      ["20240103", 0, "odometer reset"],    // Legacy zero reset
      ["20240104", 50, "new book started"],
      ["20240105", 75, "continuing"]
    ];
    
    const bb1 = new beebrain({params: {...getTestParams("test/legacy"), odom: true}, data: legacyData});
    results += "Original: [100, 150, 0, 50, 75]<br/>";
    results += "Processed: [" + bb1.data.map(d => d[1]).join(", ") + "]<br/>";
    results += "Tarings: [" + bb1.tarings.map(t => new Date(t*1000).toISOString().substr(0,10)).join(", ") + "]<br/>";
    results += `Status: <span class="success">${bb1.getStats().error || "No errors"}</span><br/><br/>`;
  } catch (e) {
    results += `Error: <span class="error">${e.toString()}</span><br/><br/>`;
  }
  
  // Test 3.2: #TARE tags only (new system)
  results += "<h3>Test 3.2: #TARE tags only (new system)</h3>";
  try {
    const newTareData = [
      ["20240101", 100, "first reading"],
      ["20240102", 150, "second reading"],
      ["20240103", 200, "book finished #TARE"], // Explicit tare
      ["20240104", 25, "new book started"],
      ["20240105", 50, "continuing"]
    ];
    
    const bb2 = new beebrain({params: {...getTestParams("test/new_system"), odom: true}, data: newTareData});
    results += "Original: [100, 150, 200, 25, 50]<br/>";
    results += "Processed: [" + bb2.data.map(d => d[1]).join(", ") + "]<br/>";
    results += "Tarings: [" + bb2.tarings.map(t => new Date(t*1000).toISOString().substr(0,10)).join(", ") + "]<br/>";
    results += `Status: <span class="success">${bb2.getStats().error || "No errors"}</span><br/><br/>`;
  } catch (e) {
    results += `Error: <span class="error">${e.toString()}</span><br/><br/>`;
  }
  
  // Test 3.3: Mixed system - #TARE takes precedence
  results += "<h3>Test 3.3: Mixed - #TARE takes precedence over zeros</h3>";
  try {
    const mixedData = [
      ["20240101", 100, "first reading"],
      ["20240102", 0, "accidental zero"],      // Zero but no #TARE
      ["20240103", 150, "second reading"],
      ["20240104", 200, "book finished #TARE"], // Explicit tare - this should win
      ["20240105", 25, "new book started"]
    ];
    
    const bb3 = new beebrain({params: {...getTestParams("test/mixed"), odom: true}, data: mixedData});
    results += "Original: [100, 0, 150, 200, 25]<br/>";
    results += "Processed: [" + bb3.data.map(d => d[1]).join(", ") + "]<br/>";
    results += "Tarings: [" + bb3.tarings.map(t => new Date(t*1000).toISOString().substr(0,10)).join(", ") + "]<br/>";
    results += "System used: " + (bb3.data.some(d => bb3.tarings.includes(d[0]) && d[1] !== 0) ? "#TARE" : "Legacy") + "<br/>";
    results += `Status: <span class="success">${bb3.getStats().error || "No errors"}</span><br/><br/>`;
  } catch (e) {
    results += `Error: <span class="error">${e.toString()}</span><br/><br/>`;
  }
  
  // Test 3.4: Migration scenario - zero with #TARE added
  results += "<h3>Test 3.4: Migration - zero value with #TARE tag</h3>";
  try {
    const migrationData = [
      ["20240101", 100, "first reading"],
      ["20240102", 150, "second reading"],
      ["20240103", 0, "odometer reset #TARE"],   // Migrated: zero + #TARE
      ["20240104", 50, "new book started"],
      ["20240105", 75, "continuing"]
    ];
    
    const bb4 = new beebrain({params: {...getTestParams("test/migration"), odom: true}, data: migrationData});
    results += "Original: [100, 150, 0, 50, 75]<br/>";
    results += "Processed: [" + bb4.data.map(d => d[1]).join(", ") + "]<br/>";
    results += "Tarings: [" + bb4.tarings.map(t => new Date(t*1000).toISOString().substr(0,10)).join(", ") + "]<br/>";
    results += "System used: #TARE (migrated)<br/>";
    results += `Status: <span class="success">${bb4.getStats().error || "No errors"}</span><br/><br/>`;
  } catch (e) {
    results += `Error: <span class="error">${e.toString()}</span><br/><br/>`;
  }
  
  results += '</div>';
  
  // Test Suite 4: User's Complex Sample Data
  results += '<div class="test-section">';
  results += "<h2>Test Suite 4: Complex Sample Data with Multiple Tare Scenarios</h2>";
  
  const complexSampleData = [
    ["20250827", 0, "#TARE but taring is a no-op on an initial zero              =20"],
    ["20250827", 20, "first real datapoint                                      =20"],
    ["20250901", 50, "if this were kyoom-y we'd plot '70' but it's not          =50"],
    ["20250905", 0, "#TARE traditional odometer reset                           =50"],
    ["20250910", 10, "odometer shows 10 + previous 50                           =60"],
    ["20250915", 15, "again, add 50 to current odometer reading                 =65"],
    ["20250917", 100, "#TARE ignore current reading of '100' but remember it    =65"],
    ["20250918", 140, "40 added from previous 100 so add it to 65              =105"]
  ];
  
  // Sort data chronologically before processing to ensure correct comparisons
  complexSampleData.sort((a, b) => a[0].localeCompare(b[0]));
  
  try {
    const params = {
      ...getTestParams("test/complex_sample"), 
      odom: true, 
      tini: "20250825", 
      vini: 0, 
      tfin: "20250930", 
      vfin: 200, 
      asof: "20250930",
      road: [
        ["20250930", 200, null]
      ]
    };
    const bb = new beebrain({params: params, data: complexSampleData});
    
    results += "<h3>Original Data (with expected results in comments):</h3>";
    complexSampleData.forEach(d => {
      results += `${d[0]}: ${d[1]} - ${d[2]}<br/>`;
    });
    
    results += "<h3>Processed Data:</h3>";
    bb.data.forEach((d, i) => {
      const date = new Date(d[0]*1000).toISOString().substr(0,10);
      const expected = complexSampleData[i] ? complexSampleData[i][2].match(/=(\d+)/)?.[1] : 'unknown';
      results += `${date}: ${d[1]} (expected: ${expected})<br/>`;
    });
    
    results += "<h3>Tarings Detected:</h3>";
    if (bb.tarings && bb.tarings.length > 0) {
      bb.tarings.forEach(reset => {
        results += `Taring at: ${new Date(reset*1000).toISOString().substr(0,10)}<br/>`;
      });
    } else {
      results += "No tarings detected<br/>";
    }
    
    results += `<h3>Status:</h3><span class="success">${bb.getStats().error || "No errors"}</span>`;
    
  } catch (error) {
    results += `<h3>Error:</h3><span class="error">${error.toString()}</span>`;
  }
  results += '</div>';
  
  // Summary
  results += '<div class="test-section">';
  results += "<h2>Test Summary</h2>";
  results += "<p>All test suites completed. Check individual test results above for any errors.</p>";
  results += "<p><strong>Key behaviors verified:</strong></p>";
  results += "<ul>";
  results += "<li>#TARE tags always work regardless of odom setting</li>";
  results += "<li>Zero values only trigger resets when odom=true AND no #TARE tags exist</li>";
  results += "<li>#TARE system takes precedence over legacy zero-based resets</li>";
  results += "<li>Mixed scenarios handle gracefully with #TARE taking priority</li>";
  results += "</ul>";
  results += '</div>';
  
  resultsDiv.innerHTML = results;
}

// Run comprehensive tests when page loads
runComprehensiveTests();

</script>

</body>
</html>