<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="pikaday.css">
    <link rel="stylesheet" href="roadeditor.css">
    <script src = "https://d3js.org/d3.v4.js"></script>
    <script src = "moment.min.js"></script>
    <script src = "pikaday.js"></script>
    <script src = "polyfit.js"></script>
</head>
<style>

</style>

<body>

<h1>Beeminder Visual Road Editor and Client-Side Graphs</h1>

<form name="graphType">
<input type="radio" name="typeButton" value="graph" onclick="handleRadio(this);" checked >Graph&nbsp;&nbsp;
<input type="radio" name="typeButton" value="editor" onclick="handleRadio(this);">Editor<br>
 <select id="roadselect" class="roadselect" onchange="editor.loadGoal(this.value);editor2.loadGoal(this.value);">
  <option value="data/testroad0.json">Test Road 0</option>
  <option value="data/testroad1.json">Test Road 1</option>
  <option value="data/testroad2.json">Test Road 2</option>
  <option value="data/testroad3.json">Test Road 3</option>
  <option value="data/testroad4.json">Test Road 4</option>
  <option value="data/testroad5.json">Test Road 5</option>
  <option value="data/testroad6.json">Test Road 6</option>
  <option value="data/testroad7.json">Test Road 7</option>
  <option value="data/bug-d-bump.bb">bug-d-bump</option>
  <option value="data/bug-d-mmuvi.bb">bug-d-mmuvi</option>
  <option value="data/bug-d-pocket.bb">bug-d-pocket</option>
  <option value="data/bug-meta-pledged.bb">bug-meta-pledged</option>
  <option value="data/bug-bweight.bb">bug-bweight</option>
  <option value="data/bugroad1.bb">bugroad1</option>
  <option value="data/bugroad2.bb">bugroad2</option>
  <option value="data/bugroad3.bb">bugroad3</option>
</select> 
 
</form>
<div id="diveditor">
<ul>
<li>Drag dots, vertical lines or roads to edit, double-click to add new node, Ctrl-Z to undo, Ctrl-y to redo</li>
</ul>

<table>
  <tr>
    <td valign="top"><div id="roadgraph"></div>

<form action="">
<input id="showdata" type="checkbox" onclick="editor.showData(this.checked);" checked>Show datapoints
<input id="showalldata" type="checkbox" onclick="if (this.checked) editor.maxDataDays(-1); else editor.maxDataDays(100);" checked>Show all datapoints
<input id="showcontext" type="checkbox" onclick="editor.showContext(this.checked);" checked>Show context graph<br>
<input id="keepslopes" type="checkbox" onclick="editor.keepSlopes(this.checked);" checked>Keep slopes fixed&nbsp;<input id="keepintervals" onclick="editor.keepIntervals(this.checked);" type="checkbox">Keep intervals fixed
</form>

<button id="zoomall" onclick="editor.zoomAll();">View All</button>
<button id="zoomdflt" onclick="editor.zoomDefault();">Default Zoom</button>
<button id="undo" onclick="editor.undo();">Undo (0)</button>
<button id="redo" onclick="editor.redo();">Redo (0)</button><br/><br/>
Safe days: <input type = "number" value="0" min="0" id="ratchetdays"><button id="retroratchet" onclick="var val = document.getElementById(&quot;ratchetdays&quot;).value; if (!isNaN(val)) editor.retroRatchet(Number(val));">Retroratchet</button><br/><br/>
<button id="submit" onclick="window.alert('new road matrix:\n'+JSON.stringify(editor.getRoad(),null,2));">Submit</button>
<button id="savesvg" onclick="editor.saveGraph();">Save SVG</button><br/>

</td>
    <td valign="top">
      <div id="roadtable"></div>
      <br/>
      <input id="autoscroll" type="checkbox" onclick="editor.autoScroll(this.checked);">Auto-scroll table<br>
      <input id="updateondrag" type="checkbox" onclick="editor.tableUpdateOnDrag(this.checked);">Update table on drag<br>
      <input id="reversetable" type="checkbox" onclick="editor.reverseTable(this.checked);">Reverse table order<br/>

    </td>
  </tr>
</table>
</div>

<div id="divgraph">
<table>
  <tr>
    <td valign="top"><div id="roadgraph2"></div>
      <input id="showalldata2" type="checkbox" onclick="if (this.checked) editor2.maxDataDays(-1); else editor2.maxDataDays(100);" checked>Show all datapoints<br/>
      <button id="zoomall2" onclick="editor2.zoomAll();">View All</button>
      <button id="zoomdflt2" onclick="editor2.zoomDefault();">Default Zoom</button><br/><br/>
      <button id="savesvg" onclick="editor2.saveGraph();">Save SVG</button><br/>
    </td>
    <td valign="top">
      <div id="roadtable2"></div>
      <br/>
      <input id="reversetable2" type="checkbox" 
             onclick="editor2.reverseTable(this.checked);">
      Reverse table order<br/>
    </td>
  </tr>
</table>
</div>

<script src = "roadeditor.js"></script>

<script>
  var undoBtn = document.getElementById("undo");
  var redoBtn = document.getElementById("redo");
  function roadChanged() {
    var bufStates = editor.undoBufferState();
    if (bufStates.undo === 0)  {
      undoBtn.disabled = true;
      undoBtn.innerHTML = "Undo (0)";
    } else {
      undoBtn.disabled = false;
      undoBtn.innerHTML = "Undo ("+bufStates.undo+")";
    }
    if (bufStates.redo === 0)  {
      redoBtn.disabled = true;
      redoBtn.innerHTML = "Redo (0)";
    } else {
      redoBtn.disabled = false;
      redoBtn.innerHTML = "Redo ("+bufStates.redo+")";
    }
  }
  
  var editor = new bmndr({divGraph: document.getElementById('roadgraph'),
                          divTable: document.getElementById('roadtable'),
                          roadEditor:true,
                          maxFutureDays: 365,
                          showFocusRect: false,
                          showContext: true,
                          onRoadChange: roadChanged});
  editor.showData(document.getElementById("showdata").checked);
  if (document.getElementById("showalldata").checked) editor.maxDataDays(-1); else editor.maxDataDays(100);
  editor.showData(document.getElementById("showdata").checked);
  editor.showContext(document.getElementById("showcontext").checked);
  editor.keepSlopes(document.getElementById("keepslopes").checked);
  editor.keepIntervals(document.getElementById("keepintervals").checked);
  editor.reverseTable(document.getElementById("reversetable").checked);
  editor.tableAutoScroll(document.getElementById("autoscroll").checked);
  editor.tableUpdateOnDrag(document.getElementById("updateondrag").checked);

  var editor2 = new bmndr({divGraph: document.getElementById('roadgraph2'),
                          divTable: document.getElementById('roadtable2'),
                          roadEditor:false,
                          maxFutureDays: 365,
                          showFocusRect: false,
                          showContext: true});
  if (document.getElementById("showalldata2").checked) editor2.maxDataDays(-1); else editor2.maxDataDays(100);
  editor2.reverseTable(document.getElementById("reversetable2").checked);


  var curRadio = 0;
  var divEditor = document.getElementById("diveditor");
  var divGraph = document.getElementById("divgraph");
  function handleRadio(myRadio) {
    if (curRadio !== myRadio.value) {
      curRadio = myRadio.value;
      if (curRadio === "editor") { 
        divEditor.style.display = "block";
        divGraph.style.display = "none";
        editor.show();
        editor2.hide();
     } else {
        divEditor.style.display = "none";
        divGraph.style.display = "block";
        editor.hide();
        editor2.show();
      }
    }
  }
  document.graphType.typeButton[0].checked = true;
  divEditor.style.display = "none";
  divGraph.style.display = "block";
  editor.hide();
  editor2.show();

  editor.loadGoal(document.getElementById("roadselect").value);
  editor2.loadGoal(document.getElementById("roadselect").value);


  function documentKeyDown(e) {
    var evtobj = window.event? window.event : e;
    if (evtobj.keyCode == 89 && evtobj.ctrlKey) editor.redo();
    if (evtobj.keyCode == 90 && evtobj.ctrlKey) editor.undo();
  }
        
  document.onkeydown = documentKeyDown;
</script>

</body>
</html>
