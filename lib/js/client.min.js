console.log("user = "+username);var undoBtn=document.getElementById("undo"),redoBtn=document.getElementById("redo"),submitBtn=document.getElementById("roadsubmit"),submitMsg=document.getElementById("submitmsg"),breakpicker=new Pikaday({field:document.getElementById("breakstart")}),endSlope=document.getElementById("endslope"),slopeType=document.getElementById("slopetype"),roadSelect=document.getElementById("roadselect");function roadChanged(){var e=editor.undoBufferState();0===e.undo?(undoBtn.disabled=!0,undoBtn.innerHTML="Undo (0)"):(undoBtn.disabled=!1,undoBtn.innerHTML="Undo ("+e.undo+")"),0===e.redo?(redoBtn.disabled=!0,redoBtn.innerHTML="Redo (0)"):(redoBtn.disabled=!1,redoBtn.innerHTML="Redo ("+e.redo+")");var t=editor.getRoad();if(t?t.valid?t.loser?(submitBtn.disabled=!0,submitMsg.innerHTML="Submitting this road would insta-derail you!"):(submitBtn.disabled=!1,submitMsg.innerHTML=""):(submitBtn.disabled=!0,submitMsg.innerHTML="Road can't be easier within the akrasia horizon!"):(submitBtn.disabled=!0,submitMsg.innerHTML="Ill-defined yellow brick road!"),null!=t){var o=moment(moment.unix(t.horizon).utc().format("YYYY-MM-DD")).toDate();breakpicker.setMinDate(o),breakstart.value.trim()||breakpicker.setDate(o),slopeType.value=t.siru}updateCommitFields()}function updateCommitFields(){var e=parseInt(slopeType.value),t=editor.getRoad();if(t){var o=t.siru,a=t.road;endSlope.value=a[a.length-1][2]/o*e}}function commitTo(){if(!isNaN(endSlope.value)){var e=parseInt(slopeType.value),t=parseInt(endSlope.value);editor.commitTo(t/e)}}function scheduleBreak(e){var t=document.getElementById("breakstart").value,o=document.getElementById("breakdays").value;isNaN(o)||editor.scheduleBreak(t,o,e)}null!=username?loadJSON("/getusergoals",prepareGoalSelect):prepareGoalSelect(["testroad0.bb","testroad1.bb","testroad2.bb","testroad3.bb"]);var graph=new bgraph({divGraph:document.getElementById("roadgraph2"),divTable:document.getElementById("roadtable2"),tableAutoScroll:!0,tableUpdateOnDrag:!0,reverseTable:!1,roadEditor:!1,maxFutureDays:365,showFocusRect:!1,showContext:!0});document.getElementById("showalldata2").checked?graph.maxDataDays(-1):graph.maxDataDays(100);var editor=new bgraph({divGraph:document.getElementById("roadgraph"),divTable:document.getElementById("roadtable"),tableAutoScroll:!0,tableUpdateOnDrag:!0,reverseTable:!1,roadEditor:!0,maxFutureDays:365,showFocusRect:!1,showContext:!0,onRoadChange:roadChanged});document.getElementById("showalldata").checked?editor.maxDataDays(-1):editor.maxDataDays(100),editor.showData(document.getElementById("showdata").checked),editor.showContext(document.getElementById("showcontext").checked),editor.keepSlopes(document.getElementById("keepslopes").checked),editor.keepIntervals(document.getElementById("keepintervals").checked),username||handleGoalSelect();var curRadio=0,divEditor=document.getElementById("diveditor"),divGraph=document.getElementById("divgraph");function handleRadio(e){curRadio!==e.value&&("editor"===(curRadio=e.value)?(divEditor.style.display="block",divGraph.style.display="none",editor.show(),graph.hide()):(divEditor.style.display="none",divGraph.style.display="block",editor.hide(),graph.show()))}function loadJSON(e,t){var o=new XMLHttpRequest;o.overrideMimeType("application/json"),o.onreadystatechange=function(){4==o.readyState&&"200"==o.status&&t(JSON.parse(o.responseText))},o.open("GET",e,!0),o.send(null)}function postJSON(e,t,o){var a=new XMLHttpRequest;a.open("POST",e,!0),a.setRequestHeader("Content-Type","application/json"),a.onreadystatechange=function(){4==a.readyState&&"200"==a.status&&o(JSON.parse(a.responseText))},console.log("posting data to "+e),a.send(JSON.stringify(t))}function documentKeyDown(e){var t=window.event?window.event:e;89==t.keyCode&&t.ctrlKey&&editor.redo(),90==t.keyCode&&t.ctrlKey&&editor.undo()}function prepareGoalSelect(e){for(let e=roadSelect.options.length-1;e>=0;e--)roadSelect.remove(e);document.createDocumentFragment();e.forEach(function(e,t){var o=document.createElement("option");o.text=e,o.value=e,roadSelect.add(o)}),roadSelect.addEventListener("change",handleGoalSelect),roadSelect.value=e[0],breakstart.value="",username&&(editor.loadGoal("/getgoaljson/"+roadSelect.value),graph.loadGoal("/getgoaljson/"+roadSelect.value))}function handleGoalSelect(){breakstart.value="",username?(editor.loadGoal("/getgoaljson/"+roadSelect.value),graph.loadGoal("/getgoaljson/"+roadSelect.value)):(editor.loadGoal("/data/"+roadSelect.value),graph.loadGoal("/data/"+roadSelect.value))}function handleRoadSubmit(){var e=roadSelect.value,t=editor.getRoad();t?t.valid?t.loser?window.alert("New road causes derailment!"):username?postJSON("/submitroad/"+e,t,function(t){t.error?submitMsg.innerHTML='ERROR! "'+t.error+'". Email support@beeminder.com for more help!':(submitMsg.innerHTML="(successfully submitted road!)",console.log("success!"),console.log(t),editor.loadGoal("/getgoaljson/"+e),graph.loadGoal("/getgoaljson/"+e))}):window.alert("new road matrix:\n"+JSON.stringify(editor.getRoad())):window.alert("New road intersects pink region (i.e., violates the akrasia horizon)!"):window.alert("Road is null! Graph with errors?")}document.graphType.typeButton[0].checked=!0,divEditor.style.display="none",divGraph.style.display="block",editor.hide(),graph.show(),document.onkeydown=documentKeyDown;