let local=!1;"undefined"!=typeof username?console.log("Live version: user = "+username):(console.log("Local version: no username"),local=!0);const cols={red:butil.Cols.REDDOT,green:butil.Cols.GRNDOT,blue:butil.Cols.BLUDOT,orange:butil.Cols.ORNDOT};let graph,editor,sandbox,sandboxgr,gload=!0,eload=!0,sload=!0;function openTab(e,t,d,a){let o,n,r;for(n=document.getElementsByClassName(d),o=0;o<n.length;o++)n[o].style.display="none";for(r=document.getElementsByClassName(a),o=0;o<r.length;o++)r[o].className=r[o].className.replace(" active","");document.getElementById(t).style.display="block",e&&(e.currentTarget.className+=" active")}let roadSelect,divGraph,divGraphRoad,divGraphDueBy,divGraphData,divGraphProgress,divGraphSummary,dataDate,dataValue,dataComment,dataAdd,divEditor,divEditorTable,divEditorDueBy,divEditorData,divEditorProgress,divEditorSummary,editorTab,undoBtn,redoBtn,endSlope,slopeType,submitButton,submitMsg,divSandbox,divSandboxTable,divSandboxDueBy,divSandboxData,divSandboxProgress,divSandboxSummary,sandboxTab,undoBtnSandbox,redoBtnSandbox,endSlopeSandbox,slopeTypeSandbox,datePicker,curMainTab="graph";function openMainTab(e,t){openTab(e,t,"tabcontent","tablinks"),"graph"==t?(graph&&graph.show(),editor&&editor.hide(),sandboxgr&&sandboxgr.hide()):"editor"==t?(graph&&graph.hide(),editor&&editor.show(),sandboxgr&&sandboxgr.hide()):"sandbox"==t&&(graph&&graph.hide(),editor&&editor.hide(),sandboxgr&&sandboxgr.show()),curMainTab=t}function openGraphTab(e,t){openTab(e,t,"gtabcontent","gtablinks")}function openEditorTab(e,t){openTab(e,t,"etabcontent","etablinks")}function openSandboxTab(e,t){openTab(e,t,"stabcontent","stablinks")}async function loadGoals(e){let t;graph&&graph.loading(!0),editor&&editor.loading(!0),sandboxgr&&sandboxgr.loading(!0),t=local?await butil.loadJSON(e):await butil.loadJSON("/getgoaljson/"+e),graph&&graph.loading(!1),editor&&editor.loading(!1),sandboxgr&&sandboxgr.loading(!1),t?(await graph.loadGoalJSON(t),await editor.loadGoalJSON(t),await sandbox.loadGoalJSON(t),sandboxgr=sandbox.getGraphObj()):console.log("Failed to load goal")}function updateProgress(e,t){let d,a,o=t.getProgress();for(;e.firstChild;)e.removeChild(e.firstChild);(a=(d=d3.select(e).append("div").attr("class","progtable")).append("div").attr("class","progrow")).append("div").attr("class","proghdr").text("START"),a.append("div").attr("class","progcell").text(o[0][0]+" → "+o[0][1]),(a=d.append("div").attr("class","progrow")).append("div").attr("class","proghdr").text("NOW"),a.append("div").attr("class","progcell").text(o[1][0]+" → "+o[1][1]),(a=d.append("div").attr("class","progrow")).append("div").attr("class","proghdr").text("TARGET"),a.append("div").attr("class","progcell").text(o[2][0]+" → "+o[2][1]);let n=butil.dayparse(o[0][0],"-"),r=butil.dayparse(o[1][0],"-"),i=butil.dayparse(o[2][0],"-"),l=Math.round(100*(r-n)/(i-n));l=Math.min(100,Math.max(0,l));let s=Math.round(100*(o[1][1]-o[0][1])/(o[2][1]-o[0][1]));s=Math.min(100,Math.max(0,s)),d3.select(e).append("div").attr("class","progcont").append("div").attr("class","progbar").style("width",l+"%"),d3.select(e).append("div").attr("class","progcont").append("div").attr("class","progbar").style("width",s+"%")}function updateSummary(e,t){let d=t.getGoalObj(),a="due in";for(;e.firstChild;)e.removeChild(e.firstChild);let o=d3.select(e);matches=d.limsum.match(/(.*) in ([^\(]*).*/),matches||(matches=d.limsum.match(/(.*) (today)/),a="due"),o.append("div").attr("class","yoog").text(d.yoog+":"),o.append("div").attr("class","baremin").text(matches[1]),o.append("div").attr("class","doom-modifier").text(a),o.append("div").attr("class","doom").text(matches[2]).style("background-color",cols[d.color]),o.append("div").attr("class","pledgepre").text("or pay"),o.append("div").attr("class","pledge").text(d.waterbux)}function updateCommitFields(e=!1){let t,d,a,o;e?(t=parseInt(slopeTypeSandbox.value),a=(d=sandbox.getGraphObj().getRoad()).siru,o=d.road,endSlopeSandbox.value=butil.shn(o[o.length-1][2]*(t/a))):(t=parseInt(slopeType.value),a=(d=editor.getRoad()).siru,o=d.road,endSlope.value=o[o.length-1][2]*(t/a))}function commitTo(e=!1){let t,d;if(e){if(isNaN(endSlopeSandbox.value))return;t=parseInt(slopeTypeSandbox.value),d=parseInt(endSlopeSandbox.value),sandbox.newRate(d/t)}else{if(isNaN(endSlope.value))return;t=parseInt(slopeType.value),d=parseInt(endSlope.value),editor.commitTo(d/t)}}function sandboxChanged(){sload=!1;let e=sandbox.undoBufferState();0===e.undo?(undoBtnSandbox.disabled=!0,undoBtnSandbox.innerHTML="Undo (0)"):(undoBtnSandbox.disabled=!1,undoBtnSandbox.innerHTML="Undo ("+e.undo+")"),0===e.redo?(redoBtnSandbox.disabled=!0,redoBtnSandbox.innerHTML="Redo (0)"):(redoBtnSandbox.disabled=!1,redoBtnSandbox.innerHTML="Redo ("+e.redo+")"),updateCommitFields(!0),updateProgress(divSandboxProgress,sandbox.getGraphObj()),updateSummary(divSandboxSummary,sandbox.getGraphObj())}function graphChanged(){gload=!1,updateProgress(divGraphProgress,graph),updateSummary(divGraphSummary,graph),dataDate.value="",setEntryToday(),dataAdd.disabled=!1}function editorBeforeUnload(e){e.preventDefault(),e.returnValue=""}function editorChanged(){if((eload=!1)||gload)return;let e=editor.undoBufferState();0===e.undo?(window.removeEventListener("beforeunload",editorBeforeUnload),d3.select(editorTab).style("color","black").text("Editor"),submitButton.disabled=!0,undoBtn.disabled=!0,resetBtn.disabled=!0,undoBtn.innerHTML="Undo (0)"):(window.addEventListener("beforeunload",editorBeforeUnload),d3.select(editorTab).style("color","red").text("Editor ("+e.undo+")"),submitButton.disabled=!1,undoBtn.disabled=!1,resetBtn.disabled=!1,undoBtn.innerHTML="Undo ("+e.undo+")"),0===e.redo?(redoBtn.disabled=!0,redoBtn.innerHTML="Redo (0)"):(redoBtn.disabled=!1,redoBtn.innerHTML="Redo ("+e.redo+")"),updateProgress(divEditorProgress,editor);let t=editor.getRoad();t?t.valid?t.loser?(submitButton.disabled=!0,submitMsg.innerHTML="Submitting this road would insta-derail!"):submitMsg.innerHTML="":(submitButton.disabled=!0,submitMsg.innerHTML="Road can't be easier within the horizon!"):(submitButton.disabled=!0,submitMsg.innerHTML="Ill-defined yellow brick road!"),slopeType.value=t.siru,updateCommitFields(!1),updateSummary(divEditorSummary,editor)}function documentKeyDown(e){let t=window.event?window.event:e;"editor"==curMainTab?(89==t.keyCode&&t.ctrlKey&&editor.redo(),90==t.keyCode&&t.ctrlKey&&editor.undo()):"sandbox"==curMainTab&&(89==t.keyCode&&t.ctrlKey&&sandbox.redo(),90==t.keyCode&&t.ctrlKey&&sandbox.undo())}function prepareGoalSelect(e){for(let e=roadSelect.options.length-1;e>=0;e--)roadSelect.remove(e);let t;document.createDocumentFragment();if(null==e)return(t=document.createElement("option")).text="load failed!",t.value="load failed!",void roadSelect.add(t);e.forEach(function(e,d){(t=document.createElement("option")).text=e,t.value=e,roadSelect.add(t)}),roadSelect.value=e[0],loadGoals(roadSelect.value)}function loadJSON(e,t){let d=new XMLHttpRequest;d.overrideMimeType("application/json"),d.onreadystatechange=function(){4==d.readyState&&"200"==d.status&&(""==d.responseText?t(null):t(JSON.parse(d.responseText)))},d.open("GET",e,!0),d.send(null)}function postJSON(e,t,d){let a=new XMLHttpRequest;a.open("POST",e,!0),a.setRequestHeader("Content-Type","application/json"),a.onreadystatechange=function(){4==a.readyState&&"200"==a.status&&d(JSON.parse(a.responseText))},a.send(JSON.stringify(t))}function handleRoadSubmit(){let e=roadSelect.value,t=editor.getRoad();t?t.valid?t.loser?window.alert("New road causes derailment!"):local?(submitMsg.innerHTML='<a id="download">Right-click to download SVG</a>',editor.saveGraph(document.getElementById("download")),window.alert("new road matrix:\n"+JSON.stringify(editor.getRoad()))):(submitButton.disabled=!0,submitButton.innerHTML="Submitting...",postJSON("/submitroad/"+e,t,function(t){submitButton.innerHTML="Submit Changes",t.error?submitMsg.innerHTML='ERROR! "'+t.error+'". Email support@beeminder.com for more help!':(submitMsg.innerHTML="(successfully submitted road!)",loadGoals(e))})):window.alert("New road intersects pink region (i.e., violates the akrasia horizon)!"):window.alert("Road is null! Graph with errors?")}function handleDataSubmit(){let e=roadSelect.value,t=butil.dayify(butil.dayparse(dataDate.value,"-")),d=dataValue.value,a={daystamp:t,value:d,comment:dataComment.value};isNaN(d)||""==d?window.alert("Invalid value entry"):local?(submitMsg.innerHTML='<a id="download">Right-click to download SVG</a>',window.alert("new datapoint: \n"+JSON.stringify(a))):(dataAdd.disabled=!0,dataAdd.innerHTML="ADDING...",postJSON("/submitpoint/"+e,a,function(t){dataAdd.innerHTML="ADD PROGRESS",t.error?console.log('ERROR! "'+t.error):loadGoals(e)}))}function setEntryToday(){var e=moment().format("YYYY-MM-DD");dataDate.value.trim()||datePicker.setDate(e)}function initialize(){if(roadSelect=document.getElementById("roadselect"),divGraph=document.getElementById("roadgraph"),divGraphRoad=document.getElementById("graphroad"),divGraphDueBy=document.getElementById("gdueby"),divGraphData=document.getElementById("graphdata"),divGraphProgress=document.getElementById("gprogress"),divGraphSummary=document.getElementById("gsummary"),divEditor=document.getElementById("roadeditor"),divEditorRoad=document.getElementById("editorroad"),divEditorDueBy=document.getElementById("edueby"),divEditorData=document.getElementById("editordata"),divEditorProgress=document.getElementById("eprogress"),divEditorSummary=document.getElementById("esummary"),editorTab=document.getElementById("editortab"),undoBtn=document.getElementById("eundo"),redoBtn=document.getElementById("eredo"),resetBtn=document.getElementById("ereset"),endSlope=document.getElementById("endslope"),slopeType=document.getElementById("slopetype"),submitButton=document.getElementById("submit"),submitMsg=document.getElementById("submitmsg"),divSandbox=document.getElementById("roadsandbox"),divSandboxRoad=document.getElementById("sandboxroad"),divSandboxDueBy=document.getElementById("sdueby"),divSandboxData=document.getElementById("sandboxdata"),divSandboxProgress=document.getElementById("sprogress"),divSandboxSummary=document.getElementById("ssummary"),sandboxTab=document.getElementById("sandboxtab"),undoBtnSandbox=document.getElementById("sundo"),redoBtnSandbox=document.getElementById("sredo"),resetBtnSandbox=document.getElementById("sreset"),endSlopeSandbox=document.getElementById("sendslope"),slopeTypeSandbox=document.getElementById("sslopetype"),graph=new bgraph({divGraph:divGraph,divTable:divGraphRoad,divDueby:divGraphDueBy,divData:divGraphData,svgSize:{width:696,height:453},focusRect:{x:0,y:0,width:696,height:453},ctxRect:{x:0,y:453,width:696,height:32},roadEditor:!1,tableHeight:212,maxFutureDays:365,showFocusRect:!1,showContext:!1,onRoadChange:graphChanged}),(editor=new bgraph({divGraph:divEditor,divTable:divEditorRoad,divDueby:divEditorDueBy,divData:divEditorData,svgSize:{width:696,height:553},focusRect:{x:0,y:0,width:696,height:453},ctxRect:{x:0,y:453,width:696,height:100},roadEditor:!0,tableHeight:212,maxFutureDays:365,showFocusRect:!0,showContext:!0,onRoadChange:editorChanged})).showData(document.getElementById("showdata").checked),editor.keepSlopes(document.getElementById("keepslopes").checked),sandbox=new bsandbox({divGraph:divSandbox,divTable:divSandboxRoad,divDueby:divSandboxDueBy,divData:divSandboxData,svgSize:{width:696,height:453},focusRect:{x:0,y:0,width:696,height:453},ctxRect:{x:0,y:453,width:696,height:32},tableHeight:212,showContext:!1,onRoadChange:sandboxChanged},!1),editor.hide(),local)loadGoals(roadSelect.value);else{loadJSON("/getusergoals",prepareGoalSelect);for(let e=roadSelect.options.length-1;e>=0;e--)roadSelect.remove(e);document.createDocumentFragment();let e=document.createElement("option");e.text="Loading...",e.value="",roadSelect.add(e)}dataDate=document.getElementById("datadate"),dataValue=document.getElementById("datavalue"),dataComment=document.getElementById("datacmt"),dataAdd=document.getElementById("dataadd"),datePicker=new Pikaday({field:dataDate}),setEntryToday(),document.onkeydown=documentKeyDown}