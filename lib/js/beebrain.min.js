((n,t)=>{"use strict";"function"==typeof define&&define.amd?define(["fili","moment","butil","broad"],t):"object"==typeof module&&module.exports?module.exports=t(require("./fili"),require("./moment"),require("./butil"),require("./broad")):n.beebrain=t(n.Fili,n.moment,n.butil,n.broad)})(this,(n,t,i,a)=>{"use strict";const r=Math.max,e=Math.min,l=Math.abs,o=Math.exp,s=Math.floor,u=Math.ceil,f=Math.sign,m=365.25,d=86400;let c=1;const p={quantum:1e-5,timey:!1,ppr:!0,deadline:0,asof:null,tini:null,vini:null,road:[],tfin:null,vfin:null,rfin:null,runits:"w",gunits:"units",yaw:0,dir:0,pinkzone:[],tmin:null,tmax:null,vmin:null,vmax:null,kyoom:!1,odom:!1,maxflux:0,monotone:!1,aggday:null,plotall:!0,steppy:!1,rosy:!1,movingav:!1,aura:!1,hashtags:!0,yaxis:"",waterbuf:null,waterbux:"",hidey:!1,stathead:!0,yoog:"U/G",goal:null,rate:null},h={sadbrink:!1,safebump:null,dueby:[],fullroad:[],pinkzone:[],tluz:null,tcur:null,vcur:null,vprev:null,rcur:null,ravg:null,tdat:null,stdflux:0,delta:0,lane:666,cntdn:0,numpts:0,mean:0,meandelt:0,proctm:0,statsum:"",ratesum:"",deltasum:"",graphsum:"",progsum:"",safesum:"",rah:0,safebuf:null,error:"",limsum:"",headsum:"",titlesum:"",lnw:0,color:"black",loser:!1,gldt:null,goal:null,rate:null,road:[],tini:null,vini:null,tfin:null,vfin:null,rfin:null},g=["timezone","usr","graph","ybhp","integery","noisy","abslnw","tagtime","backroad","edgy","offred","sadlhole","imgsz"],y={AGGPAST:0,AGGFUTURE:1,RAWPAST:2,RAWFUTURE:3,FLATLINE:4,HOLLOW:5};return function(v){let b=this,x=c;c++,v=i.deepcopy(v);let w=[],A={},z=[],k=[],R=[],M=[],E=[],F=[],S=[],U={},G={},T={},P={},O=[];A.yaw=1,A.dir=1,A.tcur=0,A.vcur=0,A.vprev=0;const L=t.utc();function N(n){if(n.fullroad=n.fullroad.map(n=>(function(n){return Array.isArray(n)?n.length<=3?n:n.slice(0,3):n})(n)),n.road=n.fullroad,n.error)n.gldt=i.dayify(A.tfin),n.goal=A.vfin,n.rate=A.rfin*A.siru;else{const t=n.fullroad.length;t>0&&(n.gldt=n.fullroad[t-1][0],n.goal=n.fullroad[t-1][1],n.rate=n.fullroad[t-1][2])}n.tini=i.dayify(A.tini),n.vini=A.vini,n.tfin=i.dayify(A.tfin),n.vfin=A.vfin,n.rfin=A.rfin}function D(n){return Array.isArray(n)&&3===n.length?[i.dayparse(n[0]),n[1],n[2]]:n}function K(n){if(n.length<1)return n;let t=n.slice();return t[0]=i.dayify(n[0]),t}function q(n,t){let i=.25/d;"meta/derev"===A.yoog&&(i=.03/d),"meta/dpledge"===A.yoog&&(i=.03/d);let a,r,e,l,s,u=n[0][0],f=n[0][1],m=f;if(t<u)return m;for(e=1;e<n.length;e++){if(a=(r=n[e])[0]-u,l=(r[1]-f)/a,s=f,t<r[0])return s+l*(a=t-u)-l/i+(m-s+l/i)*o(-i*a);m=s+l*a-l/i+(m-s+l/i)*o(-i*a),u=r[0],f=r[1]}return s+l*(a=t-u)-l/i+(m-s+l/i)*o(-i*a)}function I(n,t,a){let r=i.zip(n);return r[1]=function(n,t,a){return function(n,t,i){let a=[t];for(let t=0;t<i.length;t++)a.push(n(a[t],i[t]));return a}((n,a)=>i.clip(n,a-t,a+t),n[0]+a*t,n.slice(1,n.length))}(r[1],t,a),i.zip(r)}function $(n,t,i){return I(n.slice().reverse(),t,i).reverse()}let B;L.hour(0),L.minute(0),L.second(0),L.millisecond(0),A.asof=L.unix(),A.horizon=A.asof+i.AKH,A.xMin=A.asof,A.xMax=A.horizon,A.yMin=-1,A.yMax=1;try{B=new RegExp("(?:^|\\s)(#\\p{L}[\\p{L}0-9_]*)(?=$|[\\s])","gu")}catch{B=/(?:^|\s)(#[a-zA-Z]\w*)(?=$|\s)/g}function H(n){let t,i=new Set;for(B.lastIndex=0;null!=(t=B.exec(n));)""!=t[1]&&i.add(t[1]);return i}function C(n){return n[1]}function j(n,t){const a=A.kyoom&&"sum"===A.aggday;if(1===n.length)return[n[0][2],n[0][3],n[0][4]];{let r;return(r=a?i.accumulate(n.map(C)).indexOf(t):n.map(C).indexOf(t))<0?[A.aggday,null,null]:[n[r][1]+" ("+A.aggday+")",n[r][3],n[r][4]]}}let W=null;function Y(n){return JSON.stringify(null===n[0]?n:[i.formatDate(n[0]),n[1],n[2]])}function J(n){return!(!i.listy(n)||3!=n.length)&&(null==n[0]&&i.nummy(n[1])&&i.nummy(n[2])||i.nummy(n[0])&&null==n[1]&&i.nummy(n[2])||i.nummy(n[0])&&i.nummy(n[1])&&null==n[2])}const V=n=>i.nummy(n)&&0<n&&n<i.BDUSK,Z=n=>"boolean"==typeof n,_=n=>i.nummy(n)||null===n,Q=n=>V(n)||null===n,X={quantum:[i.nummy,"isn't numeric"],timey:[Z,"isn't boolean"],ppr:[Z,"isn't boolean"],deadline:[n=>i.nummy(n)&&-64800<=n&&n<=21600,"outside 6am earlybird and 6am nightowl"],asof:[V,"isn't a valid timestamp"],tini:[V,"isn't a valid timestamp"],vini:[i.nummy,"isn't numeric"],road:[i.listy,"(graph matrix) isn't a list"],tfin:[Q,"isn't a valid timestamp or null"],vfin:[_,"isn't numeric or null"],rfin:[_,"isn't numeric or null"],runits:[n=>n in i.SECS,"isn't a valid rate unit"],gunits:[i.stringy,"isn't a string"],yaw:[n=>-1===n||0===n||1===n,"isn't -1 or 1 or 0"],dir:[n=>1==n||-1==n,"isn't -1 or 1"],pinkzone:[i.listy,"isn't a a list"],tmin:[Q,"isn't a valid timestamp or null"],tmax:[Q,"isn't a valid timestamp or null"],vmin:[_,"isn't numeric or null"],vmax:[_,"isn't numeric or null"],kyoom:[Z,"isn't boolean"],odom:[Z,"isn't boolean"],monotone:[Z,"isn't boolean"],aggday:[n=>n in a.AGGR,"isn't one of max, sum, last, mean, etc"],plotall:[Z,"isn't boolean"],steppy:[Z,"isn't boolean"],rosy:[Z,"isn't boolean"],movingav:[Z,"isn't boolean"],aura:[Z,"isn't boolean"],hashtags:[Z,"isn't boolean"],yaxis:[n=>i.stringy(n)&&n.length<80,"isn't a string of at most 79 chars"],waterbuf:[n=>i.stringy(n)||null===n,"isn't a string or null"],waterbux:[i.stringy,"isn't a string"],hidey:[Z,"isn't boolean"],stathead:[Z,"isn't boolean"],yoog:[i.stringy,"isn't a string"],goal:[_,"isn't numeric or null"],rate:[_,"isn't numeric or null"]};function nn(){A.dtf=a.stepify(k),A.road=a.fillroad(A.road,A);const t=A.road.length;A.tfin=A.road[t-1][0],A.vfin=A.road[t-1][1],A.rfin=A.road[t-1][2];const l=A.road.map(n=>n[0]);if(A.tini>l[0])return"Graph matrix error\\n(There are segments of your bright red line\\nthat are somehow dated before your goal's start date!)";if(!i.orderedq(l))return"Dial error\\n(Your goal date, goal "+(A.kyoom?"total":"value")+", and rate are inconsistent!\\nIs your rate positive when you meant negative?\\nOr is your goal "+(A.kyoom?"total":"value")+" such that the implied goal date is in the past?)";A.stdflux=a.stdflux(w,k.filter(n=>n[0]>=A.tini)),function(){const n=0===k.length?[A.tini,A.vini]:k[k.length-1],t=n[0],i=n[1];if(t>A.tfin)return;const r=n=>!a.aok(w,A,n,i);let l=e(A.asof,A.tfin);if(A.yaw*A.dir>0)for(;r(l-d)&&l-d>t&&r(l-2*d)&&l-d>A.tini;)l-=d;l in G||(W=[l,i,"PPR",y.FLATLINE,t,i,null],t==l&&"PPR"==n[2]?k[k.length-1]=W:k.push(W))}();const o=k.length;if(A.movingav)if(o<=1||k[o-1][0]-k[0][0]<=0)A.filtpts=[];else if(void 0!==n){let n=(new Fili.FirCoeffs).lowpass({order:20,Fs:1e3,Fc:50}),t=(new Fili.FirFilter(n),(new Fili.CalcCascades).lowpass({order:1,characteristic:"bessel",Fs:1e3,Fc:50,gain:0,preGain:!1})),a=new Fili.IirFilter(t),r=k[0][0],e=k[o-1][0],l=i.linspace(r,e,1+u((e-r)/d)),s=k[0][1],f=k[o-1][1],m=k[0][0],c=(f-s)/(k[o-1][0]-m),p=[0],h=0,g=(k[h+1][1]-k[h][1])/(k[h+1][0]-k[h][0]);for(let n=1;n<l.length;n++)if(l[n]==k[h+1][0]){if(p.push(k[h+1][1]-s-c*(l[n]-m)),++h==k.length-1)break;g=(k[h+1][1]-k[h][1])/(k[h+1][0]-k[h][0])}else{if(l[n]>k[h+1][0]){if(++h==k.length)break;g=(k[h+1][1]-k[h][1])/(k[h+1][0]-k[h][0])}p.push(k[h][1]+(l[n]-k[h][0])*g-s-c*(l[n]-m))}const y=50;for(let n=0;n<y;n++)p.push(0);let v=a.filtfilt(p);v.splice(1-y,y-1),A.filtpts=i.zip([l,v.map(n=>n+s)]).map(n=>[n[0],n[1]+c*(n[0]-m)]),console.log(i.shd(r)),console.log(i.shd(e)),console.log(A.filtpts)}else{const n=function(n,t,a=6e3){return i.linspace(n,t,s(i.clip((t-n)/(d+1),e(600,640),a)))}(k[0][0],k[o-1][0],4*(k[o-1][0]-k[0][0])/d);A.filtpts=n.map(n=>[n,q(k,n)])}else A.filtpts=[];return A.tcur=0===o?A.tini:k[o-1][0],A.vcur=0===o?A.vini:k[o-1][1],A.vprev=k[r(o-2,0)][1],A.safebuf=a.dtd(w,A,A.tcur,A.vcur),A.tluz=e(A.tcur+A.safebuf*d,A.tfin+d,i.BDUSK),A.tluz>A.tfin&&(A.tluz=i.BDUSK),A.delta=i.chop(A.vcur-a.rdf(w,A.tcur)),A.rah=a.rdf(w,A.tcur+i.AKH),A.dueby=a.dueby(w,A,7),A.safebump=a.lim(w,A,A.safebuf),A.rcur=a.rtf(w,A.tcur)*A.siru,A.ravg=a.tvr(A.tini,A.vini,A.tfin,A.vfin,null)*A.siru,A.cntdn=u((A.tfin-A.tcur)/d),A.lane=A.yaw*(A.safebuf-(A.safebuf<=1?2:1)),A.color=A.safebuf<1?"red":A.safebuf<2?"orange":A.safebuf<3?"blue":"green",A.loser=a.redyest(w,A,A.tcur),A.sadbrink=A.tcur-d>A.tini&&a.dotcolor(w,A,A.tcur-d,A.dtf(A.tcur-d,A.isolines))==i.BHUE.REDDOT,function(){if(null==A.tmin&&(A.tmin=e(A.tini,A.asof)),null==A.tmax){const n=s((A.tcur-A.tmin)/(m*d));A.tmax=i.daysnap(2*(1+n/2)*i.AKH+A.tcur)}if(null!=A.vmin&&null!=A.vmax)return void(A.vmin==A.vmax?(A.vmin-=1,A.vmax+=1):A.vmin>A.vmax&&([A.vmin,A.vmax]=[A.vmax,A.vmin]));const n=a.rdf(w,A.tmin),t=a.rdf(w,A.tmax),l=k.filter(n=>n[0]<=A.tmax&&n[0]>=A.tmin).map(n=>n[1]);let o=i.arrMin(l),u=i.arrMax(l);if(null!=W&&W[0]<=A.tmax&&W[0]>=A.tmin){const n=W[1]+a.ppr(w,A,A.asof);o=e(o,n),u=r(u,n)}const f=r(0,.015*(u-o)*2);let c=o-f,p=u+f;A.monotone&&A.dir>0?(c=i.arrMin([c,n,t]),p=i.arrMax([p,n,t])):(A.monotone&&A.dir,c=i.arrMin([c,n,t]),p=i.arrMax([p,n,t])),A.plotall&&A.tmin<=A.tini&&A.tini<=A.tmax&&A.tini in U&&(c=e(c,i.arrMin(U[A.tini].map(n=>n[1]))),p=r(p,i.arrMax(U[A.tini].map(n=>n[1])))),null==A.vmin&&null==A.vmax?(A.vmin=c,A.vmax=p,A.vmin==A.vmax?(A.vmin-=1,A.vmax+=1):A.vmin>A.vmax&&([A.vmin,A.vmax]=[A.vmax,A.vmin])):null==A.vmin?A.vmin=c<A.vmax?c:A.vmax-1:null==A.vmax&&(A.vmax=p>A.vmin?p:A.vmin+1)}(),""}function tn(n,t){const r=t.yaw,e=t.dir,o=t.lane,u=t.delta,m=t.quantum,c=r>0&&e>0,p=r<0&&e<0,h=r<0&&e>0,g=r>0&&e<0,y=(n,t=r,a=4,e=2)=>null===m?i.shn(n,a,e,t):i.conservaround(n,m,t),v=(n,t=r,i=4,a=2)=>(n>=0?"+":"")+y(n,t,i,a);if(""!=t.error)return void(t.statsum=" error:    "+t.error+"\\n");const b=i.zip(t.road)[2];let x=i.arrMin(b),A=i.arrMax(b);if(l(x)>l(A)){const n=x;x=A,A=n}const z=i.shn(x,4,2),R=i.shn(A,4,2),M=i.shn(t.ravg,4,2),E=i.shn(t.rcur,4,2);t.ratesum=(x===A?z:"between "+z+" and "+R)+" per "+i.UNAM[t.runits]+(x!==A?" (current: "+E+", average: "+M+")":"");const F=i.daysnap(t.tini),S=i.daysnap(t.tcur),U=i.daysnap(t.tfin),G=t.vini,T=t.vcur,P=t.vfin;let O,L,N,D;O=F===U?"??":i.shn(i.rescale(S,F,U,0,100),1,1),L=G===P?T<G&&t.yaw>0||T>G&&t.yaw<0?"00":"100":l(G-P)<1e-7?T<(G+P)/2&&t.yaw>0||T>(G+P)/2&&t.yaw<0?"~0":"~100":i.shn(i.rescale(t.vcur,t.vini,t.vfin,0,100),1,1),t.progsum=O==L?O+"% done":O+"% done by time -- "+L+"% by value",t.cntdn<7?(N=f(t.rfin)*(t.vfin-t.vcur),D="w/ "+y(N,0,2,1)+" to go to goal"):D="@ "+((N=a.rdf(w,t.tcur+t.siru)-a.rdf(w,t.tcur))>=0?"+":"")+i.shn(N,2,1,0)+" / "+i.UNAM[t.runits],t.graphsum=(t.asof!==t.tcur?"["+i.shd(t.asof)+"] ":"")+y(t.vcur,0,3,1)+" on "+i.shd(t.tcur)+" ("+i.splur(t.numpts,"datapoint")+" in "+i.splur(1+s((t.tcur-t.tini)/d),"day")+") targeting "+y(t.vfin,0,3,1)+" on "+i.shd(t.tfin)+" ("+i.splur(t.cntdn,"more day")+") "+D,t.deltasum=y(l(u),0)+" "+t.gunits+(u<0?" below":" above")+" the bright line";const K=t.safebuf,q=i.splur(K,"day"),I=a.lim(w,t,c||p?K:0),$=a.limd(w,t,c||p?K:0);t.kyoom?(c&&(t.limsum=v($)+" in "+q),p&&(t.limsum=v($)+" in "+q),h&&(t.limsum=v($)+" today"),g&&(t.limsum=v($)+" today")):(c&&(t.limsum=v($)+" in "+q+" ("+y(I)+")"),p&&(t.limsum=v($)+" in "+q+" ("+y(I)+")"),h&&(t.limsum=v($)+" today ("+y(I)+")"),g&&(t.limsum=v($)+" today ("+y(I)+")")),t.titlesum=i.toTitleCase(t.color)+": bmndr.com/"+t.yoog+" is safe for ~"+q+(0===K?" (beemergency!)":""),t.headsum=t.titlesum,t.statsum=" progress: "+i.shd(t.tini)+"  "+(null==k?"?":i.shn(t.vini,4,2,0))+"\\n           "+i.shd(t.tcur)+"  "+i.shn(t.vcur,4,2,0)+"   ["+t.progsum+"]\\n           "+i.shd(t.tfin)+"  "+i.shn(t.vfin,4,2,0)+"\\n rate:     "+t.ratesum+"\\n lane:     "+(666==l(o)?"n/a":o)+"\\n safebuf:  "+t.safebuf+"\\n delta:    "+t.deltasum+"\\n ",t.statsum+=0==r?"limit:    ":r<0?"hard cap: ":"bare min: ",t.statsum+=t.limsum+"\\n",function(n,t){const a=t.yaw,r=t.dir,e=(t.delta,t.quantum,t.safebuf),l=i.splur(e,"day");t.safesum=a*r<0?"unknown days of safety buffer":e>999?"more than 999 days of safety buffer":"~"+l+" of safety buffer"}(0,t)}this.reloadRoad=function(){const n=nn();if(""!=n)return n;if(tn(0,A),A.fullroad=A.road.slice(),A.fullroad.unshift([A.tini,A.vini,0,0]),""==A.error&&(A.pinkzone=[[A.asof,a.rdf(w,A.asof),0]],A.road.forEach(function(n){n[0]>A.asof&&n[0]<A.asof+i.AKH&&A.pinkzone.push([n[0],n[1],null])}),A.pinkzone.push([A.asof+i.AKH,a.rdf(w,A.asof+i.AKH),null]),A.pinkzone=a.fillroadall(A.pinkzone,A)),A.aura){const n=k.filter(n=>n[0]>=A.tmin),t=a.gapFill(n);A.auraf=a.smooth(t)}else A.auraf=(n=>0);A.dtdarray=a.dtdarray(w,A),A.isolines=[];for(let n=0;n<4;n++)A.isolines[n]=a.isoline(w,A.dtdarray,A,n);return""};let an={};this.getStats=function(){return i.deepcopy(an)},this.setRoadObj=function(n){if(0!=n.length){w=n,b.roads=w,A.road=[];for(let n=1;n<w.length;n++)A.road.push([w[n].sta[0],w[n].sta[1],w[n].slope]);b.gol=A,b.reloadRoad()}else console.log("id="+x+", setRoadObj(), null redline!")},function(n,l,o=null){try{null==o&&(o=t.utc().unix()),function(n){"goal"in n&&!("vfin"in n)&&(n.vfin=n.goal),"rate"in n&&!("rfin"in n)&&(n.rfin=n.rate)}(n),function(){k=[],W=null,M=[],U={},G={},T={},(A={}).siru=null,E=[],F=[],P={};for(const n in h)A[n]=h[n];for(const n in p)A[n]=p[n]}(),A.proctm=o,k=function(n,t){return["asof","tini","tfin","tmin","tmax"].map(t=>{t in n&&(n[t]=i.dayparse(n[t]))}),"road"in n&&i.listy(n.road)&&(n.road=n.road.map(D)),t.map((n,t)=>[i.dayparse(n[0]),n[1],n[2],t,n[1]]).sort((n,t)=>n[0]!==t[0]?n[0]-t[0]:n[3]-t[3])}(n,l);const s=[];for(const t in n)t in n&&(t in p||g.includes(t)?A[t]=n[t]:s.push(`${t}=${n[t]}`));s.length>0&&(A.error+=`Unknown param${1===s.length?"":"s"}: ${s.join(", ")}`),"aggday"in n||(n.aggday=A.kyoom?"sum":"last"),A.siru=i.SECS[A.runits],A.horizon=A.asof+i.AKH-d,A.waterbuf0=A.waterbuf,i.listy(A.road)&&A.road.push([A.tfin,A.vfin,A.rfin]),""==A.error&&(A.error=function(){for(const n in X){const t=X[n][0],i=X[n][1];if(!t(A[n]))return`${n} = ${JSON.stringify(A[n])}\\nERROR: ${i}`}for(const n of A.road)if(!J(n))return"Invalid graph matrix row: "+Y(n);for(const n of A.pinkzone)if(!J(n))return"Invalid pinkzone row: "+Y(n);const n=A.road.slice(1,A.road.length-1);if(n.length!==i.deldups(n).length){let t=n[0];for(const a of n){if(i.arrayEquals(a,t))return"Graph matrix has duplicate row: "+Y(a);t=a}}return A.kyoom&&A.odom?"The odometer setting doesn't make sense for an auto-summing goal!":A.tmin>A.asof?"You can't set the graph bounds to be solely in the future!":""}()),""==A.error&&(A.error=function(){if(!k||!k.length)return"No datapoints";const n=k.length;let t;for(t=0;t<n;t++){const n=k[t];if(!(i.nummy(n[0])&&n[0]>0&&i.nummy(n[1])&&i.stringy(n[2])))return"Invalid datapoint: "+n[0]+" "+n[1]+' "'+n[3];if(A.hashtags){const t=H(n[2]);if(0==t.size)continue;n[0]in P||(P[n[0]]=new Set);for(const i of t)P[n[0]].add(i)}}if(A.hashtags){O=[];for(const n in P)O.push([n,Array.from(P[n]).join(" ")])}for(F=(F=k.filter(n=>(function(n){return/(?:^|\s)#DERAIL(?=$|\s)/.test(n)||n.startsWith("RECOMMITTED ON")})(n[2]))).map(n=>n.slice()),t=0;t<F.length;t++)F[t][0]<1562299200&&(F[t][0]-=d);A.odom&&(E=k.filter(n=>0==n[1]).map(n=>n[0]),a.odomify(k));const r=k.filter(n=>n[0]<=A.asof);A.plotall&&(A.numpts=r.length),U={},G={};let e,l=[],o=k[0][0],s=[],u=0;for(a.rsk8=A.rfin*d/A.siru,t=0;t<=n;t++)if(t<n&&k[t][0]==o&&s.push(k[t].slice()),t>=k.length||k[t][0]!=o){let n=s.map(C),r=a.AGGR[A.aggday](n);e=l.length>0?l[l.length-1]:[o,r+u];let f=j(s,r);l.push([o,u+r,f[0],o<=A.asof?y.AGGPAST:y.AGGFUTURE,e[0],e[1],f[2],f[1]]),A.kyoom?("sum"===A.aggday?U[o]=i.accumulate(n).map((n,t)=>[o,n+u,s[t][2],s[t][3],s[t][4]]):U[o]=s.map(n=>[o,n[1]+u,n[2],n[3],n[4]]),G[o]=u+r,u+=r):(U[o]=s,G[o]=r);const m=U[o].map(n=>n[1]);T[o]=A.yaw<0?i.arrMax(m):i.arrMin(m),t<k.length&&(o=k[t][0],s=[k[t].slice()])}let f=[];for(let n in U)f=f.concat(U[n].map(t=>[Number(n),t[1],t[2],Number(n)<=A.asof?y.AGGPAST:y.AGGFUTURE,null,null,t[4],t[3]]));if(z=f,M=l.filter(n=>n[0]>A.asof),k=l.filter(n=>n[0]<=A.asof),A.plotall||(A.numpts=k.length),0==k.length)return A.tdat=A.tcur,A.mean=0,S=[],"";const m=a.gapFill(k).map(n=>n[1]);for(k.length>0&&(A.mean=i.mean(m)),k.length>1&&(A.meandelt=i.mean(i.partition(m,2,1).map(n=>n[1]-n[0]))),A.tdat=k[k.length-1][0],t=0;t<F.length;t++){const n=1562299200;(o=F[t][0]<n?F[t][0]+d:F[t][0])in T&&(F[t][1]=G[o])}return S=k.filter(n=>n[0]in U&&n[0]<A.asof&&!U[n[0]].map(n=>n[1]).includes(n[1])),""}()),""==A.error&&(A.error=function(n){const t=i.BDUSK;w=[];const r=n;if(!r)return"Road param missing";const l=r.length;let o,s=A.tini,u=A.vini;null!=r[0][0]&&r[0][0]<s&&(s=r[0][0],null!=r[0][1]&&(u=r[0][1])),(o={sta:[s,Number(u)],slope:0,auto:a.RP.SLOPE}).end=o.sta.slice(),o.sta[0]=i.daysnap(o.sta[0]-100*d*m),w.push(o);for(let n=0;n<l;n++){let i={};i.sta=w[w.length-1].end.slice();let l=null,o=null,s=null;l=r[n][0],o=r[n][1],s=r[n][2],null==l?(i.end=[0,Number(o)],i.slope=Number(s)/A.siru,0!=i.slope?i.end[0]=i.sta[0]+(i.end[1]-i.sta[1])/i.slope:(i.end[0]=t,i.end[1]=i.sta[1]),i.end[0]=e(t,i.end[0]),i.end[1]=i.sta[1]+i.slope*(i.end[0]-i.sta[0]),i.auto=a.RP.DATE):null==o?(i.end=[l,0],i.slope=Number(s)/A.siru,i.end[1]=i.sta[1]+i.slope*(i.end[0]-i.sta[0]),i.auto=a.RP.VALUE):null==s&&(i.end=[l,Number(o)],i.slope=a.segSlope(i),i.auto=a.RP.SLOPE),i.end[0]>=i.sta[0]&&w.push(i)}const f=w[w.length-1],c={sta:f.end.slice(),end:f.end.slice(),slope:0,auto:a.RP.VALUE};return c.end[0]=i.daysnap(c.end[0]+100*d*m),w.push(c),""}(n.road)),""==A.error&&(A.error=b.reloadRoad()),function(){if(!A.rosy||0==k.length)return;const n=r(0,A.stdflux);let t,a;A.dir>0?(t=I(k,n,-1),a=$(k,n,1)):(t=$(k,n,-1),a=I(k,n,1));const e=t.map(n=>n[1]),l=a.map(n=>n[1]),o=i.zip([e,l]).map(n=>(n[0]+n[1])/2),s=k.map(n=>n[0]);R=(R=i.zip([s,o])).map(n=>[n[0],n[1],"rosy data",y.RAWPAST,n[0],n[1],n[1]]);for(let n=1;n<R.length-1;n++)R[n][4]=R[n-1][0],R[n][5]=R[n-1][1]}()}finally{an=Object.assign({},h);for(const n in an)an[n]=A[n];!function(n){n.fullroad=n.fullroad.map(K),"razrmatr"in h&&(n.razrmatr=n.razrmatr.map(K)),n.pinkzone=n.pinkzone.map(K),n.tluz=i.dayify(n.tluz),n.tcur=i.dayify(n.tcur),n.tdat=i.dayify(n.tdat)}(an),N(an)}}(v.params,v.data),A.graphurl=i.BBURL,A.thumburl=i.BBURL,this.id=x,this.DPTYPE=y,this.roads=w,this.gol=A,this.data=k,this.rosydata=R,this.alldata=z,this.allvals=U,this.fuda=M,this.flad=W,this.oresets=E,this.derails=F,this.hollow=S,this.hashtags=O}});