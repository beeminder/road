((n,t)=>{"use strict";"function"==typeof define&&define.amd?define(["moment","butil","broad"],t):"object"==typeof module&&module.exports?module.exports=t(require("./moment"),require("./butil"),require("./broad")):n.beebrain=t(n.moment,n.butil,n.broad)})(this,(n,t,r)=>{"use strict";const i=Math.max,a=Math.min,e=Math.abs,l=Math.exp,o=Math.floor,s=Math.ceil,u=Math.sign,f=365.25,m=86400;let d=1;const c={quantum:1e-5,timey:!1,ppr:!0,deadline:0,sadlhole:!0,asof:null,tini:null,vini:null,road:[],tfin:null,vfin:null,rfin:null,runits:"w",gunits:"units",yaw:0,dir:0,pinkzone:[],tmin:null,tmax:null,vmin:null,vmax:null,kyoom:!1,odom:!1,maxflux:0,monotone:!1,aggday:null,plotall:!0,steppy:!1,rosy:!1,movingav:!1,aura:!1,hashtags:!0,yaxis:"",waterbuf:null,waterbux:"",hidey:!1,stathead:!0,imgsz:760,yoog:"U/G",usr:null,graph:null,goal:null,rate:null},p={sadbrink:!1,safebump:null,dueby:[],fullroad:[],pinkzone:[],tluz:null,tcur:null,vcur:null,vprev:null,rcur:null,ravg:null,tdat:null,stdflux:0,delta:0,lane:666,cntdn:0,numpts:0,mean:0,meandelt:0,proctm:0,statsum:"",ratesum:"",deltasum:"",graphsum:"",progsum:"",safesum:"",rah:0,safebuf:null,error:"",limsum:"",headsum:"",titlesum:"",lnw:0,color:"black",loser:!1,gldt:null,goal:null,rate:null,road:[],tini:null,vini:null,tfin:null,vfin:null,rfin:null},h=["ybhp","integery","noisy","abslnw","tagtime","timezone","backroad","edgy","offred"],g={AGGPAST:0,AGGFUTURE:1,RAWPAST:2,RAWFUTURE:3,FLATLINE:4,HOLLOW:5};return function(y){let v=this,b=d;d++,y=t.deepcopy(y);let x=[],w={},A=[],z=[],R=[],k=[],M=[],E=[],S=[],T={},G={},U={},O={},P=[];w.yaw=1,w.dir=1,w.tcur=0,w.vcur=0,w.vprev=0;const N=n.utc();function L(n){if(n.fullroad=n.fullroad.map(n=>(function(n){return Array.isArray(n)?n.length<=3?n:n.slice(0,3):n})(n)),n.road=n.fullroad,n.error)n.gldt=t.dayify(w.tfin),n.goal=w.vfin,n.rate=w.rfin*w.siru;else{const t=n.fullroad.length;t>0&&(n.gldt=n.fullroad[t-1][0],n.goal=n.fullroad[t-1][1],n.rate=n.fullroad[t-1][2])}n.tini=t.dayify(w.tini),n.vini=w.vini,n.tfin=t.dayify(w.tfin),n.vfin=w.vfin,n.rfin=w.rfin}function D(n){return Array.isArray(n)&&3===n.length?[t.dayparse(n[0]),n[1],n[2]]:n}function K(n){if(n.length<1)return n;let r=n.slice();return r[0]=t.dayify(n[0]),r}function $(n,t){let r=.25/m;"meta/derev"===w.yoog&&(r=.03/m),"meta/dpledge"===w.yoog&&(r=.03/m);let i,a,e,o,s,u=n[0][0],f=n[0][1],d=f;if(t<u)return d;for(e=1;e<n.length;e++){if(i=(a=n[e])[0]-u,o=(a[1]-f)/i,s=f,t<a[0])return s+o*(i=t-u)-o/r+(d-s+o/r)*l(-r*i);d=s+o*i-o/r+(d-s+o/r)*l(-r*i),u=a[0],f=a[1]}return s+o*(i=t-u)-o/r+(d-s+o/r)*l(-r*i)}function q(n,r,i){let a=t.zip(n);return a[1]=function(n,r,i){return t.foldlist((n,i)=>t.clip(n,i-r,i+r),n[0]+i*r,n.slice(1,n.length))}(a[1],r,i),t.zip(a)}function B(n,t,r){return q(n.slice().reverse(),t,r).reverse()}let F;N.hour(0),N.minute(0),N.second(0),N.millisecond(0),w.asof=N.unix(),w.horizon=w.asof+t.AKH,w.xMin=w.asof,w.xMax=w.horizon,w.yMin=-1,w.yMax=1;try{F=new RegExp("(?:^|\\s)(#\\p{L}[\\p{L}0-9_]*)(?=$|[\\s])","gu")}catch{F=/(?:^|\s)(#[a-zA-Z]\w*)(?=$|\s)/g}function H(n){let t,r=new Set;for(F.lastIndex=0;null!=(t=F.exec(n));)""!=t[1]&&r.add(t[1]);return r}function I(n){return n[1]}function j(n,r){const i=w.kyoom&&"sum"===w.aggday;if(1===n.length)return[n[0][2],n[0][3],n[0][4]];{let a;return(a=i?t.accumulate(n.map(I)).indexOf(r):n.map(I).indexOf(r))<0?[w.aggday,null,null]:[n[a][1]+" ("+w.aggday+")",n[a][3],n[a][4]]}}let C=null;function W(n){return JSON.stringify(null==n[0]?n:[t.formatDate(n[0]),n[1],n[2]])}const Y=[["deadline",n=>-64800<=n&&n<=21600,"outside 6am earlybird to 6am nightowl"],["asof",n=>null!=n,"can't be null"],["asof",t.torn,"isn't a valid timestamp"],["tini",t.timy,"isn't a valid timestamp"],["vini",t.nummy,"isn't numeric"],["road",t.listy,"(graph matrix) isn't a list"],["tfin",t.torn,"isn't a valid timestamp"],["vfin",t.norn,"isn't numeric or null"],["rfin",t.norn,"isn't numeric or null"],["runits",n=>n in t.SECS,"isn't a valid rate unit"],["yaw",n=>0==n||1==n||-1==n,"isn't in [0,-1,1]"],["dir",n=>1==n||-1==n,"isn't in -1,1]"],["tmin",t.torn,"isn't a number/timestamp"],["tmax",t.torn,"isn't a valid timestamp"],["vmin",t.norn,"isn't numeric or null"],["vmax",t.norn,"isn't numeric or null"],["kyoom",t.torf,"isn't boolean"],["odom",t.torf,"isn't boolean"],["monotone",t.torf,"isn't boolean"],["aggday",n=>n in r.AGGR,"isn't one of max, sum, last, mean, etc"],["plotall",t.torf,"isn't boolean"],["steppy",t.torf,"isn't boolean"],["rosy",t.torf,"isn't boolean"],["movingav",t.torf,"isn't boolean"],["aura",t.torf,"isn't boolean"],["yaxis",t.stringy,"isn't a string"],["yaxis",n=>n.length<80,"string is too long\\n"],["waterbuf",t.sorn,"isn't a string or null"],["waterbux",t.stringy,"isn't a string"],["hidey",t.torf,"isn't boolean"],["stathead",t.torf,"isn't boolean"],["imgsz",t.nummy,"isn't numeric"],["yoog",t.stringy,"isn't a string"]];function J(){w.dtf=r.stepify(z),w.road=r.fillroad(w.road,w);const n=w.road.length;w.tfin=w.road[n-1][0],w.vfin=w.road[n-1][1],w.rfin=w.road[n-1][2];const e=w.road.map(n=>n[0]);if(w.tini>e[0])return"Graph matrix error\\n(There are segments of your bright red line\\nthat are somehow dated before your goal's start date!)";if(!t.orderedq(e))return"Dial error\\n(Your goal date, goal "+(w.kyoom?"total":"value")+", and rate are inconsistent!\\nIs your rate positive when you meant negative?\\nOr is your goal "+(w.kyoom?"total":"value")+" such that the implied goal date is in the past?)";w.stdflux=r.stdflux(x,z.filter(n=>n[0]>=w.tini)),function(){const n=w.asof,i=z.length,e=0===z.length?w.tini:z[i-1][0],l=0===z.length?w.vini:z[i-1][1];if(e>w.tfin)return;let o=e;if(w.yaw*w.dir<0)o=a(n,w.tfin);else{let e,s=null;for(;o<=a(n,w.tfin)&&(s!==(e=r.dotcolor(x,w,o,l,w.isolines))||s!==t.Cols.REDDOT);)s=e,o+=m;o=a(o,n,w.tfin);for(let n=0;n<i;n++)if(o==z[n][0])return}if(!(o in G)){const n=0===z.length?[w.tini,w.vini]:z[i-1];C=[o,l,"PPR",g.FLATLINE,n[0],n[1],null],z.push(C)}}();const l=z.length;if(w.movingav)if(l<=1||z[l-1][0]-z[0][0]<=0)w.filtpts=[];else{const n=function(n,r,i=6e3){return t.linspace(n,r,o(t.clip((r-n)/(m+1),a(600,640),i)))}(z[0][0],z[l-1][0],4*(z[l-1][0]-z[0][0])/m);JSON.stringify(n),w.filtpts=n.map(n=>[n,$(z,n)])}else w.filtpts=[];return w.tcur=z[l-1][0],w.vcur=z[l-1][1],w.vprev=z[i(l-2,0)][1],w.safebuf=r.dtd(x,w,w.tcur,w.vcur),w.tluz=a(w.tcur+w.safebuf*m,w.tfin+m,t.BDUSK),w.tluz>w.tfin&&(w.tluz=t.BDUSK),w.delta=t.chop(w.vcur-r.rdf(x,w.tcur)),w.rah=r.rdf(x,w.tcur+t.AKH),w.dueby=r.dueby(x,w,7),w.safebump=r.lim(x,w,w.safebuf),w.rcur=r.rtf(x,w.tcur)*w.siru,w.ravg=r.tvr(w.tini,w.vini,w.tfin,w.vfin,null)*w.siru,w.cntdn=s((w.tfin-w.tcur)/m),w.lane=w.yaw*(w.safebuf-(w.safebuf<=1?2:1)),w.color=w.safebuf<1?"red":w.safebuf<2?"orange":w.safebuf<3?"blue":"green",w.loser=r.redyest(x,w,w.tcur),w.sadbrink=w.tcur-m>w.tini&&r.dotcolor(x,w,w.tcur-m,w.dtf(w.tcur-m,w.isolines))==t.Cols.REDDOT,function(){if(null==w.tmin&&(w.tmin=a(w.tini,w.asof)),null==w.tmax){const n=o((w.tcur-w.tmin)/(f*m));w.tmax=t.daysnap(2*(1+n/2)*t.AKH+w.tcur)}if(null!=w.vmin&&null!=w.vmax)return void(w.vmin==w.vmax?(w.vmin-=1,w.vmax+=1):w.vmin>w.vmax&&([w.vmin,w.vmax]=[w.vmax,w.vmin]));const n=r.rdf(x,w.tmin),e=r.rdf(x,w.tmax),l=z.filter(n=>n[0]<=w.tmax&&n[0]>=w.tmin).map(n=>n[1]);let s=t.arrMin(l),u=t.arrMax(l);if(null!=C&&C[0]<=w.tmax&&C[0]>=w.tmin){const n=C[1]+r.ppr(x,w,w.asof);s=a(s,n),u=i(u,n)}const d=i(0,.015*(u-s)*2);let c=s-d,p=u+d;w.monotone&&w.dir>0?(c=t.arrMin([c,n,e]),p=t.arrMax([p,n,e])):(w.monotone&&w.dir,c=t.arrMin([c,n,e]),p=t.arrMax([p,n,e])),w.plotall&&w.tmin<=w.tini&&w.tini<=w.tmax&&w.tini in T&&(c=a(c,t.arrMin(T[w.tini].map(n=>n[1]))),p=i(p,t.arrMax(T[w.tini].map(n=>n[1])))),null==w.vmin&&null==w.vmax?(w.vmin=c,w.vmax=p,w.vmin==w.vmax?(w.vmin-=1,w.vmax+=1):w.vmin>w.vmax&&([w.vmin,w.vmax]=[w.vmax,w.vmin])):null==w.vmin?w.vmin=c<w.vmax?c:w.vmax-1:null==w.vmax&&(w.vmax=p>w.vmin?p:w.vmin+1)}(),""}function V(n,i){const a=i.yaw,l=i.dir,s=i.lane,f=i.delta,d=i.quantum,c=a>0&&l>0,p=a<0&&l<0,h=a<0&&l>0,g=a>0&&l<0,y=(n,r=a,i=4,e=2)=>null===d?t.shn(n,i,e,r):t.conservaround(n,d,r),v=(n,t=a,r=4,i=2)=>(n>=0?"+":"")+y(n,t,r,i);if(""!=i.error)return void(i.statsum=" error:    "+i.error+"\\n");const b=t.zip(i.road)[2];let w=t.arrMin(b),A=t.arrMax(b);if(e(w)>e(A)){const n=w;w=A,A=n}const R=t.shn(w,4,2),k=t.shn(A,4,2),M=t.shn(i.ravg,4,2),E=t.shn(i.rcur,4,2);i.ratesum=(w===A?R:"between "+R+" and "+k)+" per "+t.UNAM[i.runits]+(w!==A?" (current: "+E+", average: "+M+")":"");const S=t.daysnap(i.tini),T=t.daysnap(i.tcur),G=t.daysnap(i.tfin),U=i.vini,O=i.vcur,P=i.vfin;let N,L,D,K;N=S===G?"??":t.shn(t.rescale(T,S,G,0,100),1,1),L=U===P?O<U&&i.yaw>0||O>U&&i.yaw<0?"00":"100":e(U-P)<1e-7?O<(U+P)/2&&i.yaw>0||O>(U+P)/2&&i.yaw<0?"~0":"~100":t.shn(t.rescale(i.vcur,i.vini,i.vfin,0,100),1,1),i.progsum=N==L?N+"% done":N+"% done by time -- "+L+"% by value",i.cntdn<7?(D=u(i.rfin)*(i.vfin-i.vcur),K="To go to goal: "+y(D,0,2,1)+"."):K="Yellow Brick Rd = "+((D=r.rdf(x,i.tcur+i.siru)-r.rdf(x,i.tcur))>=0?"+":"")+t.shn(D,2,1,0)+" / "+t.UNAM[i.runits]+".",i.graphsum=y(i.vcur,0,3,1)+" on "+t.shd(i.tcur)+" ("+t.splur(i.numpts,"datapoint")+" in "+t.splur(1+o((i.tcur-i.tini)/m),"day")+") targeting "+y(i.vfin,0,3,1)+" on "+t.shd(i.tfin)+" ("+t.splur(i.cntdn,"more day")+"). "+K,i.deltasum=y(e(f),0)+" "+i.gunits+(f<0?" below":" above")+" the bright line";const $=i.safebuf,q=t.splur($,"day"),B=r.lim(x,i,c||p?$:0),F=r.limd(x,i,c||p?$:0);i.kyoom?(c&&(i.limsum=v(F)+" in "+q),p&&(i.limsum=v(F)+" in "+q),h&&(i.limsum=v(F)+" today"),g&&(i.limsum=v(F)+" today")):(c&&(i.limsum=v(F)+" in "+q+" ("+y(B)+")"),p&&(i.limsum=v(F)+" in "+q+" ("+y(B)+")"),h&&(i.limsum=v(F)+" today ("+y(B)+")"),g&&(i.limsum=v(F)+" today ("+y(B)+")")),i.titlesum=t.toTitleCase(i.color)+": bmndr.com/"+i.yoog+" is safe for ~"+q+(0===$?" (beemergency!)":""),i.headsum=i.titlesum,i.statsum=" progress: "+t.shd(i.tini)+"  "+(null==z?"?":t.shn(i.vini,4,2,0))+"\\n           "+t.shd(i.tcur)+"  "+t.shn(i.vcur,4,2,0)+"   ["+i.progsum+"]\\n           "+t.shd(i.tfin)+"  "+t.shn(i.vfin,4,2,0)+"\\n rate:     "+i.ratesum+"\\n lane:     "+(666==e(s)?"n/a":s)+"\\n safebuf:  "+i.safebuf+"\\n delta:    "+i.deltasum+"\\n ",i.statsum+=0==a?"limit:    ":a<0?"hard cap: ":"bare min: ",i.statsum+=i.limsum+"\\n",function(n,r){const i=r.yaw,a=r.dir,e=(r.delta,r.quantum,r.safebuf),l=t.splur(e,"day");r.safesum=i*a<0?"unknown days of safety buffer":e>999?"more than 999 days of safety buffer":"~"+l+" of safety buffer"}(0,i)}this.reloadRoad=function(){const n=J();if(""!=n)return n;if(V(0,w),w.fullroad=w.road.slice(),w.fullroad.unshift([w.tini,w.vini,0,0]),""==w.error&&(w.pinkzone=[[w.asof,r.rdf(x,w.asof),0]],w.road.forEach(function(n){n[0]>w.asof&&n[0]<w.asof+t.AKH&&w.pinkzone.push([n[0],n[1],null])}),w.pinkzone.push([w.asof+t.AKH,r.rdf(x,w.asof+t.AKH),null]),w.pinkzone=r.fillroadall(w.pinkzone,w)),w.aura){const n=z.filter(n=>n[0]>=w.tmin),t=r.gapFill(n);w.auraf=r.smooth(t)}else w.auraf=(n=>0);w.dtdarray=r.dtdarray(x,w),w.isolines=[];for(let n=0;n<4;n++)w.isolines[n]=r.isoline(x,w.dtdarray,w,n);return""};let Z={};this.getStats=function(){return t.deepcopy(Z)},this.setRoadObj=function(n){if(0!=n.length){x=n,v.roads=x,w.road=[];for(let n=1;n<x.length;n++)w.road.push([x[n].sta[0],x[n].sta[1],x[n].slope]);v.gol=w,v.reloadRoad()}else console.log("id="+b+", setRoadObj(), null redline!")},function(e,l,o=null){try{null==o&&(o=n.utc().unix()),function(n){"goal"in n&&!("vfin"in n)&&(n.vfin=n.goal),"rate"in n&&!("rfin"in n)&&(n.rfin=n.rate),"usr"in n&&"graph"in n&&!("yoog"in n)&&(n.yoog=n.usr+"/"+n.graph)}(e),function(){z=[],C=null,k=[],T={},G={},U={},(w={}).siru=null,M=[],E=[],O={};for(const n in p)w[n]=p[n];for(const n in c)w[n]=c[n]}(),w.proctm=o,z=function(n,r){return["asof","tini","tfin","tmin","tmax"].map(r=>{r in n&&(n[r]=t.dayparse(n[r]))}),"road"in n&&t.listy(n.road)&&(n.road=n.road.map(D)),r.map((n,r)=>[t.dayparse(n[0]),n[1],n[2],r,n[1]]).sort((n,t)=>n[0]!==t[0]?n[0]-t[0]:n[3]-t[3])}(e,l);const s=[];for(const n in e)n in e&&(n in c||h.includes(n)?w[n]=e[n]:s.push(`${n}=${e[n]}`));s.length>0&&(w.error+=`Unknown param${1===s.length?"":"s"}: ${s.join(", ")}`),"aggday"in e||(e.aggday=w.kyoom?"sum":"last"),w.siru=t.SECS[w.runits],w.horizon=w.asof+t.AKH-m,w.waterbuf0=w.waterbuf,t.listy(w.road)&&w.road.push([w.tfin,w.vfin,w.rfin]),""==w.error&&(w.error=function(){const n=n=>JSON.stringify(n);let r;for(r=0;r<Y.length;r++){const t=Y[r];if(!t[1](w[t[0]]))return`'${t[0]}' ${t[2]}: ${n(w[t[0]])}`}const i=w.road;for(r=0;r<i.length;r++)if(a=i[r],!t.listy(a)||3!=a.length||!(null==a[0]&&t.nummy(a[1])&&t.nummy(a[2])||t.nummy(a[0])&&null==a[1]&&t.nummy(a[2])||t.nummy(a[0])&&t.nummy(a[1])&&null==a[2]))return"Invalid graph matrix row: "+W(i[r]);var a;const e=i.slice(1,i.length-1);if(e.length!=t.deldups(e).length){let n=e[0];for(r=1;r<e.length;r++){if(t.arrayEquals(e[r],n))return"Graph matrix has duplicate row: "+W(e[r]);n=e[r]}return"Graph matrix duplicate row error!"}return w.kyoom&&w.odom?"The odometer setting doesn't make sense for an auto-summing goal!":w.tmin>w.asof?"You can't set the graph bounds to be solely in the future!":""}()),""==w.error&&(w.error=function(){if(!z||!z.length)return"No datapoints";const n=z.length;let i;for(i=0;i<n;i++){const n=z[i];if(!(t.nummy(n[0])&&n[0]>0&&t.nummy(n[1])&&t.stringy(n[2])))return"Invalid datapoint: "+n[0]+" "+n[1]+' "'+n[3];if(w.hashtags){const t=H(n[2]);if(0==t.size)continue;n[0]in O||(O[n[0]]=new Set);for(const r of t)O[n[0]].add(r)}}if(w.hashtags){P=[];for(const n in O)P.push([n,Array.from(O[n]).join(" ")])}for(E=(E=z.filter(n=>(function(n){return n.startsWith("RECOMMITTED")})(n[2]))).map(n=>n.slice()),i=0;i<E.length;i++)E[i][0]<1562299200&&(E[i][0]-=m);w.odom&&(M=z.filter(n=>0==n[1]).map(n=>n[0]),r.odomify(z));const a=z.filter(n=>n[0]<=w.asof);w.plotall&&(w.numpts=a.length),T={},G={};let e,l=[],o=z[0][0],s=[],u=0;for(r.rsk8=w.rfin*m/w.siru,i=0;i<=n;i++)if(i<n&&z[i][0]==o&&s.push(z[i].slice()),i>=z.length||z[i][0]!=o){let n=s.map(I),a=r.AGGR[w.aggday](n);e=l.length>0?l[l.length-1]:[o,a+u];let f=j(s,a);l.push([o,u+a,f[0],o<=w.asof?g.AGGPAST:g.AGGFUTURE,e[0],e[1],f[2],f[1]]),w.kyoom?("sum"===w.aggday?T[o]=t.accumulate(n).map((n,t)=>[o,n+u,s[t][2],s[t][3],s[t][4]]):T[o]=s.map(n=>[o,n[1]+u,n[2],n[3],n[4]]),G[o]=u+a,u+=a):(T[o]=s,G[o]=a);const m=T[o].map(n=>n[1]);U[o]=w.yaw<0?t.arrMax(m):t.arrMin(m),i<z.length&&(o=z[i][0],s=[z[i].slice()])}let f=[];for(let n in T)f=f.concat(T[n].map(t=>[Number(n),t[1],t[2],Number(n)<=w.asof?g.AGGPAST:g.AGGFUTURE,null,null,t[4],t[3]]));if(A=f,k=l.filter(n=>n[0]>w.asof),z=l.filter(n=>n[0]<=w.asof),w.plotall||(w.numpts=z.length),0==z.length)return w.tdat=w.tcur,w.mean=0,S=[],"";const d=r.gapFill(z).map(n=>n[1]);for(z.length>0&&(w.mean=t.mean(d)),z.length>1&&(w.meandelt=t.mean(t.partition(d,2,1).map(n=>n[1]-n[0]))),w.tdat=z[z.length-1][0],i=0;i<E.length;i++){const n=1562299200;(o=E[i][0]<n?E[i][0]+m:E[i][0])in U&&(E[i][1]=G[o])}return S=z.filter(n=>n[0]in T&&n[0]<w.asof&&!T[n[0]].map(n=>n[1]).includes(n[1])),""}()),""==w.error&&(w.error=function(n){const i=t.BDUSK;x=[];const e=n;if(!e)return"Road param missing";const l=e.length;let o,s=w.tini,u=w.vini;null!=e[0][0]&&e[0][0]<s&&(s=e[0][0],null!=e[0][1]&&(u=e[0][1])),(o={sta:[s,Number(u)],slope:0,auto:r.RP.SLOPE}).end=o.sta.slice(),o.sta[0]=t.daysnap(o.sta[0]-100*m*f),x.push(o);for(let n=0;n<l;n++){let t={};t.sta=x[x.length-1].end.slice();let l=null,o=null,s=null;l=e[n][0],o=e[n][1],s=e[n][2],null==l?(t.end=[0,Number(o)],t.slope=Number(s)/w.siru,0!=t.slope?t.end[0]=t.sta[0]+(t.end[1]-t.sta[1])/t.slope:(t.end[0]=i,t.end[1]=t.sta[1]),t.end[0]=a(i,t.end[0]),t.end[1]=t.sta[1]+t.slope*(t.end[0]-t.sta[0]),t.auto=r.RP.DATE):null==o?(t.end=[l,0],t.slope=Number(s)/w.siru,t.end[1]=t.sta[1]+t.slope*(t.end[0]-t.sta[0]),t.auto=r.RP.VALUE):null==s&&(t.end=[l,Number(o)],t.slope=r.segSlope(t),t.auto=r.RP.SLOPE),t.end[0]>=t.sta[0]&&x.push(t)}const d=x[x.length-1],c={sta:d.end.slice(),end:d.end.slice(),slope:0,auto:r.RP.VALUE};return c.end[0]=t.daysnap(c.end[0]+100*m*f),x.push(c),""}(e.road)),""==w.error&&(w.error=v.reloadRoad()),function(){if(!w.rosy||0==z.length)return;const n=i(0,w.stdflux);let r,a;w.dir>0?(r=q(z,n,-1),a=B(z,n,1)):(r=B(z,n,-1),a=q(z,n,1));const e=r.map(n=>n[1]),l=a.map(n=>n[1]),o=t.zip([e,l]).map(n=>(n[0]+n[1])/2),s=z.map(n=>n[0]);R=(R=t.zip([s,o])).map(n=>[n[0],n[1],"rosy data",g.RAWPAST,n[0],n[1],n[1]]);for(let n=1;n<R.length-1;n++)R[n][4]=R[n-1][0],R[n][5]=R[n-1][1]}()}finally{Z=Object.assign({},p);for(const n in Z)Z[n]=w[n];!function(n){n.fullroad=n.fullroad.map(K),"razrmatr"in p&&(n.razrmatr=n.razrmatr.map(K)),n.pinkzone=n.pinkzone.map(K),n.tluz=t.dayify(n.tluz),n.tcur=t.dayify(n.tcur),n.tdat=t.dayify(n.tdat)}(Z),L(Z)}}(y.params,y.data),w.graphurl=t.BBURL,w.thumburl=t.BBURL,this.id=b,this.DPTYPE=g,this.roads=x,this.gol=w,this.data=z,this.rosydata=R,this.alldata=A,this.allvals=T,this.fuda=k,this.flad=C,this.oresets=M,this.derails=E,this.hollow=S,this.hashtags=P}});