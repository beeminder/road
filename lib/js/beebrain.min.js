((n,t)=>{"use strict";"function"==typeof define&&define.amd?define(["moment","butil","broad"],t):"object"==typeof module&&module.exports?module.exports=t(require("./moment"),require("./butil"),require("./broad")):n.beebrain=t(n.moment,n.butil,n.broad)})(this,(n,t,a)=>{"use strict";const i=Math.max,r=Math.min,e=Math.abs,l=Math.exp,o=Math.floor,s=Math.ceil,u=Math.sign,f=365.25,m=86400;let d=1;const c={quantum:1e-5,timey:!1,ppr:!0,deadline:0,asof:null,tini:null,vini:null,road:[],tfin:null,vfin:null,rfin:null,runits:"w",gunits:"units",yaw:0,dir:0,pinkzone:[],tmin:null,tmax:null,vmin:null,vmax:null,kyoom:!1,odom:!1,maxflux:0,monotone:!1,aggday:null,plotall:!0,steppy:!1,rosy:!1,movingav:!1,aura:!1,hashtags:!0,yaxis:"",waterbuf:null,waterbux:"",hidey:!1,stathead:!0,yoog:"U/G",goal:null,rate:null},p={sadbrink:!1,safebump:null,dueby:[],fullroad:[],pinkzone:[],tluz:null,tcur:null,vcur:null,vprev:null,rcur:null,ravg:null,tdat:null,stdflux:0,delta:0,lane:666,cntdn:0,numpts:0,mean:0,meandelt:0,proctm:0,statsum:"",ratesum:"",deltasum:"",graphsum:"",progsum:"",safesum:"",rah:0,safebuf:null,error:"",limsum:"",headsum:"",titlesum:"",lnw:0,color:"black",loser:!1,gldt:null,goal:null,rate:null,road:[],tini:null,vini:null,tfin:null,vfin:null,rfin:null},h=["timezone","usr","graph","ybhp","integery","noisy","abslnw","tagtime","backroad","edgy","offred","sadlhole","imgsz"],g={AGGPAST:0,AGGFUTURE:1,RAWPAST:2,RAWFUTURE:3,FLATLINE:4,HOLLOW:5};return function(y){let v=this,b=d;d++,y=t.deepcopy(y);let x=[],w={},A=[],z=[],R=[],k=[],M=[],E=[],S=[],U={},G={},T={},P={},O=[];w.yaw=1,w.dir=1,w.tcur=0,w.vcur=0,w.vprev=0;const N=n.utc();function L(n){if(n.fullroad=n.fullroad.map(n=>(function(n){return Array.isArray(n)?n.length<=3?n:n.slice(0,3):n})(n)),n.road=n.fullroad,n.error)n.gldt=t.dayify(w.tfin),n.goal=w.vfin,n.rate=w.rfin*w.siru;else{const t=n.fullroad.length;t>0&&(n.gldt=n.fullroad[t-1][0],n.goal=n.fullroad[t-1][1],n.rate=n.fullroad[t-1][2])}n.tini=t.dayify(w.tini),n.vini=w.vini,n.tfin=t.dayify(w.tfin),n.vfin=w.vfin,n.rfin=w.rfin}function D(n){return Array.isArray(n)&&3===n.length?[t.dayparse(n[0]),n[1],n[2]]:n}function K(n){if(n.length<1)return n;let a=n.slice();return a[0]=t.dayify(n[0]),a}function $(n,t){let a=.25/m;"meta/derev"===w.yoog&&(a=.03/m),"meta/dpledge"===w.yoog&&(a=.03/m);let i,r,e,o,s,u=n[0][0],f=n[0][1],d=f;if(t<u)return d;for(e=1;e<n.length;e++){if(i=(r=n[e])[0]-u,o=(r[1]-f)/i,s=f,t<r[0])return s+o*(i=t-u)-o/a+(d-s+o/a)*l(-a*i);d=s+o*i-o/a+(d-s+o/a)*l(-a*i),u=r[0],f=r[1]}return s+o*(i=t-u)-o/a+(d-s+o/a)*l(-a*i)}function q(n,a,i){let r=t.zip(n);return r[1]=function(n,a,i){return function(n,t,a){let i=[t];for(let t=0;t<a.length;t++)i.push(n(i[t],a[t]));return i}((n,i)=>t.clip(n,i-a,i+a),n[0]+i*a,n.slice(1,n.length))}(r[1],a,i),t.zip(r)}function B(n,t,a){return q(n.slice().reverse(),t,a).reverse()}let H;N.hour(0),N.minute(0),N.second(0),N.millisecond(0),w.asof=N.unix(),w.horizon=w.asof+t.AKH,w.xMin=w.asof,w.xMax=w.horizon,w.yMin=-1,w.yMax=1;try{H=new RegExp("(?:^|\\s)(#\\p{L}[\\p{L}0-9_]*)(?=$|[\\s])","gu")}catch{H=/(?:^|\s)(#[a-zA-Z]\w*)(?=$|\s)/g}function I(n){let t,a=new Set;for(H.lastIndex=0;null!=(t=H.exec(n));)""!=t[1]&&a.add(t[1]);return a}function F(n){return n[1]}function j(n,a){const i=w.kyoom&&"sum"===w.aggday;if(1===n.length)return[n[0][2],n[0][3],n[0][4]];{let r;return(r=i?t.accumulate(n.map(F)).indexOf(a):n.map(F).indexOf(a))<0?[w.aggday,null,null]:[n[r][1]+" ("+w.aggday+")",n[r][3],n[r][4]]}}let W=null;function C(n){return JSON.stringify(null===n[0]?n:[t.formatDate(n[0]),n[1],n[2]])}function J(n){return!(!t.listy(n)||3!=n.length)&&(null==n[0]&&t.nummy(n[1])&&t.nummy(n[2])||t.nummy(n[0])&&null==n[1]&&t.nummy(n[2])||t.nummy(n[0])&&t.nummy(n[1])&&null==n[2])}const Y=n=>t.nummy(n)&&0<n&&n<t.BDUSK,V=n=>"boolean"==typeof n,Z=n=>t.nummy(n)||null===n,_=n=>Y(n)||null===n,Q={quantum:[t.nummy,"isn't numeric"],timey:[V,"isn't boolean"],ppr:[V,"isn't boolean"],deadline:[n=>t.nummy(n)&&-64800<=n&&n<=21600,"outside 6am earlybird and 6am nightowl"],asof:[Y,"isn't a valid timestamp"],tini:[Y,"isn't a valid timestamp"],vini:[t.nummy,"isn't numeric"],road:[t.listy,"(graph matrix) isn't a list"],tfin:[_,"isn't a valid timestamp or null"],vfin:[Z,"isn't numeric or null"],rfin:[Z,"isn't numeric or null"],runits:[n=>n in t.SECS,"isn't a valid rate unit"],gunits:[t.stringy,"isn't a string"],yaw:[n=>-1===n||0===n||1===n,"isn't -1 or 1 or 0"],dir:[n=>1==n||-1==n,"isn't -1 or 1"],pinkzone:[t.listy,"isn't a a list"],tmin:[_,"isn't a valid timestamp or null"],tmax:[_,"isn't a valid timestamp or null"],vmin:[Z,"isn't numeric or null"],vmax:[Z,"isn't numeric or null"],kyoom:[V,"isn't boolean"],odom:[V,"isn't boolean"],monotone:[V,"isn't boolean"],aggday:[n=>n in a.AGGR,"isn't one of max, sum, last, mean, etc"],plotall:[V,"isn't boolean"],steppy:[V,"isn't boolean"],rosy:[V,"isn't boolean"],movingav:[V,"isn't boolean"],aura:[V,"isn't boolean"],hashtags:[V,"isn't boolean"],yaxis:[n=>t.stringy(n)&&n.length<80,"isn't a string of at most 79 chars"],waterbuf:[n=>t.stringy(n)||null===n,"isn't a string or null"],waterbux:[t.stringy,"isn't a string"],hidey:[V,"isn't boolean"],stathead:[V,"isn't boolean"],yoog:[t.stringy,"isn't a string"],goal:[Z,"isn't numeric or null"],rate:[Z,"isn't numeric or null"]};function X(){w.dtf=a.stepify(z),w.road=a.fillroad(w.road,w);const n=w.road.length;w.tfin=w.road[n-1][0],w.vfin=w.road[n-1][1],w.rfin=w.road[n-1][2];const e=w.road.map(n=>n[0]);if(w.tini>e[0])return"Graph matrix error\\n(There are segments of your bright red line\\nthat are somehow dated before your goal's start date!)";if(!t.orderedq(e))return"Dial error\\n(Your goal date, goal "+(w.kyoom?"total":"value")+", and rate are inconsistent!\\nIs your rate positive when you meant negative?\\nOr is your goal "+(w.kyoom?"total":"value")+" such that the implied goal date is in the past?)";w.stdflux=a.stdflux(x,z.filter(n=>n[0]>=w.tini)),function(){const n=0===z.length?[w.tini,w.vini]:z[z.length-1],t=n[0],i=n[1];if(t>w.tfin)return;const e=n=>!a.aok(x,w,n,i);let l=r(w.asof,w.tfin);if(w.yaw*w.dir>0)for(;e(l-m)&&l-m>t&&e(l-2*m)&&l-m>w.tini;)l-=m;l in G||(W=[l,i,"PPR",g.FLATLINE,t,i,null],t==l&&"PPR"==n[2]?z[z.length-1]=W:z.push(W))}();const l=z.length;if(w.movingav)if(l<=1||z[l-1][0]-z[0][0]<=0)w.filtpts=[];else{const n=function(n,a,i=6e3){return t.linspace(n,a,o(t.clip((a-n)/(m+1),r(600,640),i)))}(z[0][0],z[l-1][0],4*(z[l-1][0]-z[0][0])/m);JSON.stringify(n),w.filtpts=n.map(n=>[n,$(z,n)])}else w.filtpts=[];return w.tcur=0===l?w.tini:z[l-1][0],w.vcur=0===l?w.vini:z[l-1][1],w.vprev=z[i(l-2,0)][1],w.safebuf=a.dtd(x,w,w.tcur,w.vcur),w.tluz=r(w.tcur+w.safebuf*m,w.tfin+m,t.BDUSK),w.tluz>w.tfin&&(w.tluz=t.BDUSK),w.delta=t.chop(w.vcur-a.rdf(x,w.tcur)),w.rah=a.rdf(x,w.tcur+t.AKH),w.dueby=a.dueby(x,w,7),w.safebump=a.lim(x,w,w.safebuf),w.rcur=a.rtf(x,w.tcur)*w.siru,w.ravg=a.tvr(w.tini,w.vini,w.tfin,w.vfin,null)*w.siru,w.cntdn=s((w.tfin-w.tcur)/m),w.lane=w.yaw*(w.safebuf-(w.safebuf<=1?2:1)),w.color=w.safebuf<1?"red":w.safebuf<2?"orange":w.safebuf<3?"blue":"green",w.loser=a.redyest(x,w,w.tcur),w.sadbrink=w.tcur-m>w.tini&&a.dotcolor(x,w,w.tcur-m,w.dtf(w.tcur-m,w.isolines))==t.BHUE.REDDOT,function(){if(null==w.tmin&&(w.tmin=r(w.tini,w.asof)),null==w.tmax){const n=o((w.tcur-w.tmin)/(f*m));w.tmax=t.daysnap(2*(1+n/2)*t.AKH+w.tcur)}if(null!=w.vmin&&null!=w.vmax)return void(w.vmin==w.vmax?(w.vmin-=1,w.vmax+=1):w.vmin>w.vmax&&([w.vmin,w.vmax]=[w.vmax,w.vmin]));const n=a.rdf(x,w.tmin),e=a.rdf(x,w.tmax),l=z.filter(n=>n[0]<=w.tmax&&n[0]>=w.tmin).map(n=>n[1]);let s=t.arrMin(l),u=t.arrMax(l);if(null!=W&&W[0]<=w.tmax&&W[0]>=w.tmin){const n=W[1]+a.ppr(x,w,w.asof);s=r(s,n),u=i(u,n)}const d=i(0,.015*(u-s)*2);let c=s-d,p=u+d;w.monotone&&w.dir>0?(c=t.arrMin([c,n,e]),p=t.arrMax([p,n,e])):(w.monotone&&w.dir,c=t.arrMin([c,n,e]),p=t.arrMax([p,n,e])),w.plotall&&w.tmin<=w.tini&&w.tini<=w.tmax&&w.tini in U&&(c=r(c,t.arrMin(U[w.tini].map(n=>n[1]))),p=i(p,t.arrMax(U[w.tini].map(n=>n[1])))),null==w.vmin&&null==w.vmax?(w.vmin=c,w.vmax=p,w.vmin==w.vmax?(w.vmin-=1,w.vmax+=1):w.vmin>w.vmax&&([w.vmin,w.vmax]=[w.vmax,w.vmin])):null==w.vmin?w.vmin=c<w.vmax?c:w.vmax-1:null==w.vmax&&(w.vmax=p>w.vmin?p:w.vmin+1)}(),""}function nn(n,i){const r=i.yaw,l=i.dir,s=i.lane,f=i.delta,d=i.quantum,c=r>0&&l>0,p=r<0&&l<0,h=r<0&&l>0,g=r>0&&l<0,y=(n,a=r,i=4,e=2)=>null===d?t.shn(n,i,e,a):t.conservaround(n,d,a),v=(n,t=r,a=4,i=2)=>(n>=0?"+":"")+y(n,t,a,i);if(""!=i.error)return void(i.statsum=" error:    "+i.error+"\\n");const b=t.zip(i.road)[2];let w=t.arrMin(b),A=t.arrMax(b);if(e(w)>e(A)){const n=w;w=A,A=n}const R=t.shn(w,4,2),k=t.shn(A,4,2),M=t.shn(i.ravg,4,2),E=t.shn(i.rcur,4,2);i.ratesum=(w===A?R:"between "+R+" and "+k)+" per "+t.UNAM[i.runits]+(w!==A?" (current: "+E+", average: "+M+")":"");const S=t.daysnap(i.tini),U=t.daysnap(i.tcur),G=t.daysnap(i.tfin),T=i.vini,P=i.vcur,O=i.vfin;let N,L,D,K;N=S===G?"??":t.shn(t.rescale(U,S,G,0,100),1,1),L=T===O?P<T&&i.yaw>0||P>T&&i.yaw<0?"00":"100":e(T-O)<1e-7?P<(T+O)/2&&i.yaw>0||P>(T+O)/2&&i.yaw<0?"~0":"~100":t.shn(t.rescale(i.vcur,i.vini,i.vfin,0,100),1,1),i.progsum=N==L?N+"% done":N+"% done by time -- "+L+"% by value",i.cntdn<7?(D=u(i.rfin)*(i.vfin-i.vcur),K="w/ "+y(D,0,2,1)+" to go to goal"):K="@ "+((D=a.rdf(x,i.tcur+i.siru)-a.rdf(x,i.tcur))>=0?"+":"")+t.shn(D,2,1,0)+" / "+t.UNAM[i.runits],i.graphsum=(i.asof!==i.tcur?"["+t.shd(i.asof)+"] ":"")+y(i.vcur,0,3,1)+" on "+t.shd(i.tcur)+" ("+t.splur(i.numpts,"datapoint")+" in "+t.splur(1+o((i.tcur-i.tini)/m),"day")+") targeting "+y(i.vfin,0,3,1)+" on "+t.shd(i.tfin)+" ("+t.splur(i.cntdn,"more day")+") "+K,i.deltasum=y(e(f),0)+" "+i.gunits+(f<0?" below":" above")+" the bright line";const $=i.safebuf,q=t.splur($,"day"),B=a.lim(x,i,c||p?$:0),H=a.limd(x,i,c||p?$:0);i.kyoom?(c&&(i.limsum=v(H)+" in "+q),p&&(i.limsum=v(H)+" in "+q),h&&(i.limsum=v(H)+" today"),g&&(i.limsum=v(H)+" today")):(c&&(i.limsum=v(H)+" in "+q+" ("+y(B)+")"),p&&(i.limsum=v(H)+" in "+q+" ("+y(B)+")"),h&&(i.limsum=v(H)+" today ("+y(B)+")"),g&&(i.limsum=v(H)+" today ("+y(B)+")")),i.titlesum=t.toTitleCase(i.color)+": bmndr.com/"+i.yoog+" is safe for ~"+q+(0===$?" (beemergency!)":""),i.headsum=i.titlesum,i.statsum=" progress: "+t.shd(i.tini)+"  "+(null==z?"?":t.shn(i.vini,4,2,0))+"\\n           "+t.shd(i.tcur)+"  "+t.shn(i.vcur,4,2,0)+"   ["+i.progsum+"]\\n           "+t.shd(i.tfin)+"  "+t.shn(i.vfin,4,2,0)+"\\n rate:     "+i.ratesum+"\\n lane:     "+(666==e(s)?"n/a":s)+"\\n safebuf:  "+i.safebuf+"\\n delta:    "+i.deltasum+"\\n ",i.statsum+=0==r?"limit:    ":r<0?"hard cap: ":"bare min: ",i.statsum+=i.limsum+"\\n",function(n,a){const i=a.yaw,r=a.dir,e=(a.delta,a.quantum,a.safebuf),l=t.splur(e,"day");a.safesum=i*r<0?"unknown days of safety buffer":e>999?"more than 999 days of safety buffer":"~"+l+" of safety buffer"}(0,i)}this.reloadRoad=function(){const n=X();if(""!=n)return n;if(nn(0,w),w.fullroad=w.road.slice(),w.fullroad.unshift([w.tini,w.vini,0,0]),""==w.error&&(w.pinkzone=[[w.asof,a.rdf(x,w.asof),0]],w.road.forEach(function(n){n[0]>w.asof&&n[0]<w.asof+t.AKH&&w.pinkzone.push([n[0],n[1],null])}),w.pinkzone.push([w.asof+t.AKH,a.rdf(x,w.asof+t.AKH),null]),w.pinkzone=a.fillroadall(w.pinkzone,w)),w.aura){const n=z.filter(n=>n[0]>=w.tmin),t=a.gapFill(n);w.auraf=a.smooth(t)}else w.auraf=(n=>0);w.dtdarray=a.dtdarray(x,w),w.isolines=[];for(let n=0;n<4;n++)w.isolines[n]=a.isoline(x,w.dtdarray,w,n);return""};let tn={};this.getStats=function(){return t.deepcopy(tn)},this.setRoadObj=function(n){if(0!=n.length){x=n,v.roads=x,w.road=[];for(let n=1;n<x.length;n++)w.road.push([x[n].sta[0],x[n].sta[1],x[n].slope]);v.gol=w,v.reloadRoad()}else console.log("id="+b+", setRoadObj(), null redline!")},function(e,l,o=null){try{null==o&&(o=n.utc().unix()),function(n){"goal"in n&&!("vfin"in n)&&(n.vfin=n.goal),"rate"in n&&!("rfin"in n)&&(n.rfin=n.rate)}(e),function(){z=[],W=null,k=[],U={},G={},T={},(w={}).siru=null,M=[],E=[],P={};for(const n in p)w[n]=p[n];for(const n in c)w[n]=c[n]}(),w.proctm=o,z=function(n,a){return["asof","tini","tfin","tmin","tmax"].map(a=>{a in n&&(n[a]=t.dayparse(n[a]))}),"road"in n&&t.listy(n.road)&&(n.road=n.road.map(D)),a.map((n,a)=>[t.dayparse(n[0]),n[1],n[2],a,n[1]]).sort((n,t)=>n[0]!==t[0]?n[0]-t[0]:n[3]-t[3])}(e,l);const s=[];for(const n in e)n in e&&(n in c||h.includes(n)?w[n]=e[n]:s.push(`${n}=${e[n]}`));s.length>0&&(w.error+=`Unknown param${1===s.length?"":"s"}: ${s.join(", ")}`),"aggday"in e||(e.aggday=w.kyoom?"sum":"last"),w.siru=t.SECS[w.runits],w.horizon=w.asof+t.AKH-m,w.waterbuf0=w.waterbuf,t.listy(w.road)&&w.road.push([w.tfin,w.vfin,w.rfin]),""==w.error&&(w.error=function(){for(const n in Q){const t=Q[n][0],a=Q[n][1];if(!t(w[n]))return`${n} = ${JSON.stringify(w[n])}\\nERROR: ${a}`}for(const n of w.road)if(!J(n))return"Invalid graph matrix row: "+C(n);for(const n of w.pinkzone)if(!J(n))return"Invalid pinkzone row: "+C(n);const n=w.road.slice(1,w.road.length-1);if(n.length!==t.deldups(n).length){let a=n[0];for(const i of n){if(t.arrayEquals(i,a))return"Graph matrix has duplicate row: "+C(i);a=i}}return w.kyoom&&w.odom?"The odometer setting doesn't make sense for an auto-summing goal!":w.tmin>w.asof?"You can't set the graph bounds to be solely in the future!":""}()),""==w.error&&(w.error=function(){if(!z||!z.length)return"No datapoints";const n=z.length;let i;for(i=0;i<n;i++){const n=z[i];if(!(t.nummy(n[0])&&n[0]>0&&t.nummy(n[1])&&t.stringy(n[2])))return"Invalid datapoint: "+n[0]+" "+n[1]+' "'+n[3];if(w.hashtags){const t=I(n[2]);if(0==t.size)continue;n[0]in P||(P[n[0]]=new Set);for(const a of t)P[n[0]].add(a)}}if(w.hashtags){O=[];for(const n in P)O.push([n,Array.from(P[n]).join(" ")])}for(E=(E=z.filter(n=>(function(n){return/(?:^|\s)#DERAIL(?=$|\s)/.test(n)||n.startsWith("RECOMMITTED ON")})(n[2]))).map(n=>n.slice()),i=0;i<E.length;i++)E[i][0]<1562299200&&(E[i][0]-=m);w.odom&&(M=z.filter(n=>0==n[1]).map(n=>n[0]),a.odomify(z));const r=z.filter(n=>n[0]<=w.asof);w.plotall&&(w.numpts=r.length),U={},G={};let e,l=[],o=z[0][0],s=[],u=0;for(a.rsk8=w.rfin*m/w.siru,i=0;i<=n;i++)if(i<n&&z[i][0]==o&&s.push(z[i].slice()),i>=z.length||z[i][0]!=o){let n=s.map(F),r=a.AGGR[w.aggday](n);e=l.length>0?l[l.length-1]:[o,r+u];let f=j(s,r);l.push([o,u+r,f[0],o<=w.asof?g.AGGPAST:g.AGGFUTURE,e[0],e[1],f[2],f[1]]),w.kyoom?("sum"===w.aggday?U[o]=t.accumulate(n).map((n,t)=>[o,n+u,s[t][2],s[t][3],s[t][4]]):U[o]=s.map(n=>[o,n[1]+u,n[2],n[3],n[4]]),G[o]=u+r,u+=r):(U[o]=s,G[o]=r);const m=U[o].map(n=>n[1]);T[o]=w.yaw<0?t.arrMax(m):t.arrMin(m),i<z.length&&(o=z[i][0],s=[z[i].slice()])}let f=[];for(let n in U)f=f.concat(U[n].map(t=>[Number(n),t[1],t[2],Number(n)<=w.asof?g.AGGPAST:g.AGGFUTURE,null,null,t[4],t[3]]));if(A=f,k=l.filter(n=>n[0]>w.asof),z=l.filter(n=>n[0]<=w.asof),w.plotall||(w.numpts=z.length),0==z.length)return w.tdat=w.tcur,w.mean=0,S=[],"";const d=a.gapFill(z).map(n=>n[1]);for(z.length>0&&(w.mean=t.mean(d)),z.length>1&&(w.meandelt=t.mean(t.partition(d,2,1).map(n=>n[1]-n[0]))),w.tdat=z[z.length-1][0],i=0;i<E.length;i++){const n=1562299200;(o=E[i][0]<n?E[i][0]+m:E[i][0])in T&&(E[i][1]=G[o])}return S=z.filter(n=>n[0]in U&&n[0]<w.asof&&!U[n[0]].map(n=>n[1]).includes(n[1])),""}()),""==w.error&&(w.error=function(n){const i=t.BDUSK;x=[];const e=n;if(!e)return"Road param missing";const l=e.length;let o,s=w.tini,u=w.vini;null!=e[0][0]&&e[0][0]<s&&(s=e[0][0],null!=e[0][1]&&(u=e[0][1])),(o={sta:[s,Number(u)],slope:0,auto:a.RP.SLOPE}).end=o.sta.slice(),o.sta[0]=t.daysnap(o.sta[0]-100*m*f),x.push(o);for(let n=0;n<l;n++){let t={};t.sta=x[x.length-1].end.slice();let l=null,o=null,s=null;l=e[n][0],o=e[n][1],s=e[n][2],null==l?(t.end=[0,Number(o)],t.slope=Number(s)/w.siru,0!=t.slope?t.end[0]=t.sta[0]+(t.end[1]-t.sta[1])/t.slope:(t.end[0]=i,t.end[1]=t.sta[1]),t.end[0]=r(i,t.end[0]),t.end[1]=t.sta[1]+t.slope*(t.end[0]-t.sta[0]),t.auto=a.RP.DATE):null==o?(t.end=[l,0],t.slope=Number(s)/w.siru,t.end[1]=t.sta[1]+t.slope*(t.end[0]-t.sta[0]),t.auto=a.RP.VALUE):null==s&&(t.end=[l,Number(o)],t.slope=a.segSlope(t),t.auto=a.RP.SLOPE),t.end[0]>=t.sta[0]&&x.push(t)}const d=x[x.length-1],c={sta:d.end.slice(),end:d.end.slice(),slope:0,auto:a.RP.VALUE};return c.end[0]=t.daysnap(c.end[0]+100*m*f),x.push(c),""}(e.road)),""==w.error&&(w.error=v.reloadRoad()),function(){if(!w.rosy||0==z.length)return;const n=i(0,w.stdflux);let a,r;w.dir>0?(a=q(z,n,-1),r=B(z,n,1)):(a=B(z,n,-1),r=q(z,n,1));const e=a.map(n=>n[1]),l=r.map(n=>n[1]),o=t.zip([e,l]).map(n=>(n[0]+n[1])/2),s=z.map(n=>n[0]);R=(R=t.zip([s,o])).map(n=>[n[0],n[1],"rosy data",g.RAWPAST,n[0],n[1],n[1]]);for(let n=1;n<R.length-1;n++)R[n][4]=R[n-1][0],R[n][5]=R[n-1][1]}()}finally{tn=Object.assign({},p);for(const n in tn)tn[n]=w[n];!function(n){n.fullroad=n.fullroad.map(K),"razrmatr"in p&&(n.razrmatr=n.razrmatr.map(K)),n.pinkzone=n.pinkzone.map(K),n.tluz=t.dayify(n.tluz),n.tcur=t.dayify(n.tcur),n.tdat=t.dayify(n.tdat)}(tn),L(tn)}}(y.params,y.data),w.graphurl=t.BBURL,w.thumburl=t.BBURL,this.id=b,this.DPTYPE=g,this.roads=x,this.gol=w,this.data=z,this.rosydata=R,this.alldata=A,this.allvals=U,this.fuda=k,this.flad=W,this.oresets=M,this.derails=E,this.hollow=S,this.hashtags=O}});