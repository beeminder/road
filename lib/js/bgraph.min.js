!function(t,e){"use strict";"function"==typeof define&&define.amd?define(["d3","moment","butil","broad","beebrain"],e):"object"==typeof module&&module.exports?module.exports=e(require("d3"),require("./moment"),require("./butil"),require("./broad"),require("./beebrain")):t.bgraph=e(t.d3,t.moment,t.butil,t.broad,t.beebrain)}(this,function(t,e,a,r,n){"use strict";const l=!1,o=Math.max,i=Math.min,s=Math.abs,d=Math.floor,c=Math.ceil,u=Math.round,p=365.25,f=86400;let h=1,g={noGraph:!1,divGraph:null,divTable:null,divPoints:null,divDueby:null,divData:null,divJSON:null,svgSize:{width:700,height:450},focusRect:{x:0,y:0,width:700,height:370},focusPad:{left:25,right:5,top:25,bottom:30},ctxRect:{x:0,y:370,width:700,height:80},ctxPad:{left:25,right:5,top:0,bottom:30},tableHeight:387,zoomButton:{size:40,opacity:.6,factor:1.5},bullsEye:{size:40,ctxsize:20},roadDot:{size:5,ctxsize:3,border:1.5,ctxborder:1},roadKnot:{width:3,rmbtnscale:.6},roadLine:{width:3,ctxwidth:2},oldRoadLine:{width:3,ctxwidth:2,dash:32,ctxdash:16},dataPoint:{size:5,fsize:5,hsize:2.5,border:1},horizon:{width:2,ctxwidth:1,dash:8,ctxdash:6,font:10,ctxfont:9},today:{width:2,ctxwidth:1,font:12,ctxfont:9},axis:{font:11},watermark:{height:170,fntsize:150,color:"#000000"},guidelines:{width:2,weekwidth:4},maxfluxline:4,stdfluxline:2,razrline:3,textBox:{margin:3},odomReset:{width:.5,dash:8},roadLineCol:{valid:"black",invalid:"#ca1212",selected:"yellow"},roadDotCol:{fixed:"darkgray",editable:"#c2c2c2",selected:"yellow"},roadKnotCol:{dflt:"#c2c2c2",selected:"yellow",rmbtn:"black",rmbtnsel:"red"},textBoxCol:{bg:"#ffffff",stroke:"#d0d0d0"},roadTableCol:{bg:"#ffffff",bgHighlight:"#fffb55",text:"#000000",textDisabled:"#aaaaaa",bgDisabled:"#f2f2f2"},dataPointCol:{future:"#909090",stroke:"#eeeeee"},halfPlaneCol:{fill:"#ffffe8"},pastBoxCol:{fill:"#f8f8f8",opacity:.5},odomResetCol:{dflt:"#c2c2c2"},headless:!1,scrollZoom:!0,buttonZoom:!0,roadEditor:!1,showContext:!1,showFocusRect:!1,showData:!0,maxDataDays:-1,maxFutureDays:365,keepSlopes:!0,showGuidelines:!0,keepIntervals:!1,reverseTable:!1,tableAutoScroll:!0,tableUpdateOnDrag:!1,duebyUpdateOnDrag:!0,tableCheckboxes:!0,onRoadChange:null,onDataEdit:null,dataTableSize:11,dataAutoScroll:!0,onError:null};const m={svgSize:{width:700,height:530},focusRect:{x:0,y:0,width:700,height:400},focusPad:{left:25,right:10,top:35,bottom:30},ctxRect:{x:0,y:400,width:700,height:80},ctxPad:{left:25,right:10,top:0,bottom:30},tableHeight:540,zoomButton:{size:50,opacity:.7,factor:1.5},bullsEye:{size:40,ctxsize:20},roadDot:{size:10,ctxsize:4,border:1.5,ctxborder:1},roadKnot:{width:7,rmbtnscale:.9},roadLine:{width:7,ctxwidth:2},oldRoadLine:{width:3,ctxwidth:1,dash:32,ctxdash:16},dataPoint:{size:4,fsize:6},horizon:{width:2,ctxwidth:1,dash:8,ctxdash:8,font:14,ctxfont:10},today:{width:2,ctxwidth:1,font:16,ctxfont:10},watermark:{height:150,fntsize:100,color:"#000000"},guidelines:{width:2,weekwidth:4},maxfluxline:4,stdfluxline:2,razrline:3,textBox:{margin:3}},y=".svg{shape-rendering:crispEdges}.axis path,.axis line{fill:none;stroke:black;shape-rendering:crispEdges}.axis .minor line{stroke:#777;stroke-dasharray:0,2,4,3}.grid line{fill:none;stroke:#dddddd;stroke-width:1px;shape-rendering:crispEdges}.aura{fill-opacity:0.3;stroke-opacity:0.3;}.aurapast{fill-opacity:0.15;stroke-opacity:0.3}.grid .minor line{stroke:none}.axis text{font-family:sans-serif;font-size:11px;}.axislabel{font-family:sans-serif;font-size:11px;text-anchor:middle}circle.dots{stroke:black}line.roads{stroke:black}.pasttext,.ctxtodaytext,.ctxhortext,.horizontext,.hashtag{text-anchor:middle;font-family:sans-serif}.waterbuf,.waterbux{opacity:0.05882353;text-anchor:middle;font-family:Dejavu Sans,sans-serif}.loading{text-anchor:middle;font-family:Dejavu Sans,sans-serif}.zoomarea{fill:none}circle.ap{stroke:none}circle.rd{stroke:none;pointer-events:none;fill:"+a.BHUE.ROSE+"}circle.std{stroke:none;pointer-events:none;fill:"+(l?"#c0c0c0":a.BHUE.PURP)+"}circle.hp{stroke:none;fill:"+a.BHUE.WITE+"}.dp.gra,.ap.gra{fill:"+a.BHUE.GRADOT+"}.dp.grn,.ap.grn{fill:"+a.BHUE.GRNDOT+"}.dp.blu,.ap.blu{fill:"+a.BHUE.BLUDOT+"}.dp.orn,.ap.orn{fill:"+a.BHUE.ORNDOT+"}.dp.red,.ap.red{fill:"+a.BHUE.REDDOT+"}.dp.blk,.ap.blk{fill:"+a.BHUE.BLCK+"}.dp.fuda,.ap.fuda{fill-opacity:0.3}.guides{pointer-events:none;fill:none;stroke:"+a.BHUE.LYEL+"}.ybhp{pointer-events:none}.rosy{fill:none;stroke:"+a.BHUE.ROSE+";pointer-events:none}.steppy{fill:none;stroke:"+(l?"#c0c0c0":a.BHUE.PURP)+";pointer-events:none}.steppyppr{fill:none;stroke-opacity:0.8;stroke:"+a.BHUE.LPURP+";pointer-events:none}.derails{fill:"+a.BHUE.REDDOT+";pointer-events:none}.overlay .textbox{fill:#ffffcc;fill-opacity:0.5;stroke:black;stroke-width:1;pointer-events:none;rx:5;ry:5}",x=.015,v=1e3,b={NOBBFILE:0,BADBBFILE:1,BBERROR:2},w=["Could not find goal (.bb) file.","Bad .bb file.","Beeminder error"],k=()=>{if("undefined"==typeof navigator&&"undefined"==typeof window)return!1;var t=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0)}(navigator.userAgent||navigator.vendor||window.opera),t};return function(E){let z=((t,e)=>{t.opts||(t.opts=a.extendo({},g,!0)),k()&&a.extendo(t.opts,m);let r=a.extendo(t.opts,e,!0);return r.divGraph=r.divGraph&&r.divGraph.nodeName?r.divGraph:null,r.headless?(r.divTable=null,r.divPoints=null,r.divDueby=null,r.divData=null,r.scrollZoom=!1,r.roadEditor=!1,r.showContext=!1,r.showFocusRect=!1):(r.divTable=r.divTable&&r.divTable.nodeName?r.divTable:null,r.divPoints=r.divPoints&&r.divPoints.nodeName?r.divPoints:null),r})(this,E);const T=h;h++;let R,M,D,A,P,B,L,S,U,C,N,G,H,O,Y,K,V,I,j,Z,F,q,J,W,X,_,$,Q,tt,et,at,rt,nt,lt,ot,it,st,dt,ct,ut,pt,ft,ht,gt,mt,yt,xt,vt,bt,wt,kt,Et,zt,Tt,Rt,Mt,Dt,At,Pt,Bt,Lt,St,Ut,Ct,Nt,Gt,Ht,Ot,Yt,Kt,Vt,It,jt,Zt,Ft,qt,Jt,Wt,Xt,_t,$t,Qt,te,ee,ae,re=50,ne=z.svgSize.width,le=z.svgSize.height,oe=z.zoomButton.size,ie=oe/540,se=1,de=0,ce=null,ue=[],pe=[],fe=!1,he=!1,ge=!1,me=k(),ye=null,xe=[],ve={},be={},we=[],ke=[],Ee=[],ze=[],Te=[],Re=[];function Me(t){return void 0===Re[t]&&(Re[t]=r.isoline(we,Te,be,t)),Re[t]}function De(t){return u(10*t)/10}function Ae(t){return u(1e3*t)/1e3}function Pe(){(be={}).yaw=1,be.dir=1,be.tcur=0,be.vcur=0;const t=e.utc();t.hour(0),t.minute(0),t.second(0),t.millisecond(0),be.asof=t.unix(),be.horizon=be.asof+a.AKH-f,be.xMin=be.asof,be.xMax=be.horizon,be.tmin=be.asof,be.tmax=be.horizon,be.yMin=-1,be.yMax=1,ve=a.deepcopy(be),we=[],xe=[],ke=[],ze=[]}function Be(){D=a.extendo({},z.focusPad),A=a.extendo({},z.ctxPad),be.stathead&&!z.roadEditor&&(D.top+=15),D.left+=re,D.right+=re+(be.hidey?8:0),A.left+=re,A.right+=re+(be.hidey?8:0),R={x:z.focusRect.x+D.left,y:z.focusRect.y+D.top,width:z.focusRect.width-D.left-D.right,height:z.focusRect.height-D.top-D.bottom},M={x:z.ctxRect.x+A.left,y:z.ctxRect.y+A.top,width:z.ctxRect.width-A.left-A.right,height:z.ctxRect.height-A.top-A.bottom},P={botin:"translate("+(R.width-2*(oe+5))+","+(R.height-(oe+5))+") scale("+ie+","+ie+")",botout:"translate("+(R.width-(oe+5))+","+(R.height-(oe+5))+") scale("+ie+","+ie+")",topin:"translate("+(R.width-2*(oe+5))+",5) scale("+ie+","+ie+")",topout:"translate("+(R.width-(oe+5))+",5) scale("+ie+","+ie+")"}}function Le(t,e=-1,r="bold",n=null,l="overlay",o=!0,i=!1,s=null){if(null==z.divGraph)return;null==n&&(n={x:ne/20,y:le/5,w:ne-2*ne/20,h:le-2*le/5}),null==s&&(s=B);let d=s.select("g."+l);d.empty()&&(d=s.append("g").attr("class",l),o&&d.append("svg:rect").attr("x",0).attr("y",0).attr("width",ne).attr("height",le).style("fill",a.BHUE.WITE).style("fill-opacity",.5),d.append("svg:rect").attr("class","textbox").attr("x",n.x).attr("y",n.y).attr("width",n.w).attr("height",n.h)),d.selectAll(".loading").remove();const c=t.length;e<0&&(e=le/15);const u=1.1*e;for(let a=0;a<c;a++)d.append("svg:text").attr("class","loading").attr("x",n.x+n.w/2).attr("y",n.y+n.h/2-(c-1)*u/2+a*u+e/2-3).attr("font-size",e).style("font-size",e).style("font-weight",r).text(t[a]);i&&d.style("opacity",0).transition().duration(200).style("opacity",1)}function Se(t="overlay",e=!1,a=null){if(null==z.divGraph)return;null==a&&(a=B);let r=a.selectAll("g."+t);e?r.style("opacity",1).transition().duration(200).style("opacity",0).remove():r.remove()}function Ue(){if(null===z.divGraph)return;const e=[V.invert(0),V.invert(R.width)];Be(),L.select("#plotclip"+T+" > rect").attr("width",R.width).attr("height",R.height),L.select("#brushclip"+T+" > rect").attr("width",M.width).attr("height",M.height),L.select("#buttonareaclip"+T+" > rect").attr("x",R.x).attr("y",0).attr("width",R.width).attr("height",R.height),Yt.attr("x",R.x).attr("y",R.y).attr("width",R.width).attr("height",R.height),Kt.extent([[0,0],[R.width,R.height]]).scaleExtent([1,1/0]).translateExtent([[0,0],[R.width,R.height]]),N.attr("transform","translate("+D.left+","+D.top+")"),Vt.attr("transform",P.botin),It.attr("transform",P.botout),K.range([0,R.width]),V.range([0,R.width]),F.attr("transform","translate("+R.x+","+(D.top+R.height)+")").call(I.scale(V)),J.attr("transform","translate(0,"+R.height+")").call(Z),q.attr("transform","translate("+R.x+","+D.top+")").call(j.scale(V)),Ot.select("rect").attr("width",R.width).attr("height",R.height),Ot.select("text").attr("x",R.width/2),W.range([0,R.height]),X.range([0,R.height]),Q.attr("transform","translate("+D.left+","+D.top+")").call(_.scale(X)),tt.attr("transform","translate("+(D.left+R.width)+","+D.top+")").call($.scale(X)),et.attr("transform","translate(15,"+(R.height/2+D.top)+") rotate(-90)"),O.attr("transform","translate("+A.left+","+A.top+")"),at.range([0,M.width]),nt.attr("transform","translate("+M.x+","+(A.top+M.height)+")").call(rt),lt.range([M.height,0]),jt.extent([[0,0],[M.width,M.height]]),Zt.call(jt);let a=e.map(K);Yt.call(Kt.transform,t.zoomIdentity.scale(R.width/(a[1]-a[0])).translate(-a[0],0)),ya()}Pe(),Be();let Ce,Ne,Ge,He=!1,Oe=0,Ye=-1;function Ke(){Ne&&(Ne.node().value=Oe)}function Ve(t){He=!0,Oe=parseInt(t),na(),He=!1}function Ie(){if(!qe){if(t.event.preventDefault(),t.event.deltaY<0){if(0==Oe)return;Oe-=1}else{if(Oe>=Ee.length-z.dataTableSize)return;Oe+=1}Ke(),na()}}const je=["id","dt","vl","cmt","mod","del"],Ze=["span","div","div","div","button","button"];let Fe=!1,qe=null;function Je(){return event.currentTarget.parentElement.getAttribute("id")}function We(){const t=Je().match(/drow(\d+)/);return!t||t.length<2?null:t[1]}function Xe(){const t=We();if(!t)return null;const e=Ee[t];return e[3]?e[3]:t}function _e(){const e=We();if(qe){if(ta.changed){const r=Xe(),n=t.select(event.currentTarget.parentNode),l=a.dayparse(n.select(".dt").text(),"-"),o=n.select(".vl").text(),i=n.select(".cmt").text();isNaN(l)||isNaN(o)||e!=qe||!z.onDataEdit||z.onDataEdit(r,[l,o,i])}Ne.attr("disabled",null),qe=null}else Je(),qe=e,Ne.attr("disabled",!0),ta.field=null,ta.oldText=null,ta.changed=!1;na()}function $e(){const t=We(),e=Xe();qe&&qe!=t||(z.onDataEdit&&z.onDataEdit(e,null),na())}function Qe(){Ne.attr("disabled",null),qe=null,na()}const ta={field:null,oldText:null,changed:!1};function ea(e,a){if(z.onDataEdit&&0!=a&&!(a>3)){if(qe){if(!e.edit)return}else _e();if(ta.field=t.select(this),ta.oldText=ta.field.text(),pn(),1==a){let e=t.select(z.divData).select(".floating");fn(ta.field,null,null,e,Jt)}}}function aa(e,r){if(!z.onDataEdit||!e.edit||0==r||r>3)return;const n=t.select(this).text();if(pn(),or(),n===ta.oldText)return;if(ta.changed=!0,null==ta.oldText)return;const l=1==r?a.dayparse(n,"-"):n;if(3!=r&&isNaN(l))return t.select(this).text(ta.oldText),ta.oldText=null,void(ta.field=null);ta.oldText=null,ta.field=null}function ra(e,r){if(z.onDataEdit&&e.edit&&0!=r&&!(r>3)&&13==t.event.keyCode){this.blur();const e=t.select(this).text(),n=1==r?a.dayparse(e,"-"):e;if(3!=r&&isNaN(n))return t.select(this).text(ta.oldText),void(ta.oldText=null);ta.oldText=t.select(this).text(),t.event.ctrlKey&&_e()}}function na(){if(Fe)return;if(Fe=!0,fe)return;if(null===z.divData)return;He||(Ee.length<=z.dataTableSize?Ne.style("visibility","hidden"):Ne.style("visibility","visible").attr("max",Ee.length-z.dataTableSize).attr("value",0)),Ge=Array(Math.min(Ee.length,z.dataTableSize)).fill().map((t,e)=>e+Oe);const t=Ce.selectAll(".drow").data(Ge);t.enter().append("div").attr("class","drow").attr("id",t=>"drow"+(Ee.length-t-1)),t.exit().remove(),t.style("box-shadow",t=>t==Ye?"0 0 0 4px yellow":null).attr("id",t=>"drow"+(Ee.length-t-1)),Ce.selectAll(".drow").selectAll(".dcell").data((t,e)=>{if(t>=Ee.length)return[null,null,null,null,null,null];t=Ee.length-t-1;let r=a.dayify(a.dayparse(Ee[t][0]),"-"),n=!!qe&&t==qe;return[{txt:t,clk:null,edit:n},{txt:r,clk:null,edit:n},{txt:Ee[t][1],clk:null,edit:n},{txt:Ee[t][2],clk:null,edit:n},{txt:n?'<img class="dicon" src="../src/check.svg"></img>':'<img class="dicon" src="../src/edit.svg" ></img>',clk:_e,edit:n},{txt:n?'<img class="dicon" src="../src/cancel.svg" ></img>':'<img class="dicon" src="../src/trash.svg"></img>',clk:n?Qe:$e,edit:n}]}).join(t=>t.append((t,e)=>(function(t){return document.createElementNS("http://www.w3.org/1999/xhtml",t)})(Ze[e])).attr("class",(t,e)=>"dcell "+je[e]).style("border",(t,e)=>0==e?"0":null).style("text-align",(t,e)=>0==e?"right":null).on("click",t=>t.clk?t.clk():null),t=>t).html(t=>t.txt).style("visibility",function(t){return"BUTTON"===this.tagName&&qe&&!t.edit?"hidden":null}).attr("contenteditable",(t,e)=>!!z.onDataEdit&&e>0&&e<4).on("focusin",ea).on("focusout",aa).on("keydown",ra).style("opacity",t=>!qe||t.edit?null:.2);const e=Ce.selectAll("button.dcell");z.onDataEdit?e.style("display",null):e.style("display","none"),Fe=!1}let la;function oa(){if(fe)return;if(null===z.divDueby)return;const t=a.nowstamp(be.timezone,be.deadline,be.asof),n=a.dayparse(t)/f;let l=r.dueby(we,be,7);la.selectAll(".dbrow").selectAll(".dbcell").data((t,r)=>{const o=function(t,r){const n=e.unix(be.asof+t*f).utc(),l=a.dayparse(n.format("YYYYMMDD"))/f;if(l==r-1)return["Yesterday",a.BHUE.REDDOT];if(l==r)return["Today",a.BHUE.ORNG];if(l==r+1)return["Tomorrow",a.BHUE.BLUDOT];const o=n.format("ddd (Do)");return l==r+2?[o,a.BHUE.GRNDOT]:[o,a.BHUE.BLCK]}(r,n),i=l[r][1];return[o,[i>0||be.dir<0?a.shn(i):"&#10004;",o[1]],[a.shn(l[r][2]),o[1]]]}).join(t=>t.append("span").attr("class","dbcell"),t=>t).html(t=>t[0]).style("color",t=>t[1])}function ia(){ve.tini==xe[0].end[0]&&(be.tini=we[0].end[0],be.vini=we[0].end[1]),Cn||ae.setRoadObj(we),Sa(!0),ye=r.findSeg(we,be.horizon),ba(),Gr(),Un(!0),Sn(),Ln(),oa(),"function"==typeof z.onRoadChange&&z.onRoadChange.call()}function sa(t,e,a,r,n=null){let l={};if(e<20-D.top&&(e=20-D.top),e>R.height-15&&(e=R.height-15),l.grp=C.append("g"),l.rect=l.grp.append("svg:rect").attr("pointer-events","none").attr("fill",z.textBoxCol.bg).style("stroke",r),l.text=l.grp.append("svg:text").attr("pointer-events","none").attr("text-anchor","middle"),null==n)l.text.text(a).attr("class","svgtxt");else{l.text.append("tspan").attr("x",0).attr("dy","0.6em").text(a).attr("class","svgtxt");for(let t=0;t<n.length;t++)l.text.append("tspan").attr("dy","1.2em").attr("x",0).text(n[t]).attr("font-size","0.7em")}const o=l.text.node().getBBox(),i=z.textBox.margin;return l.rect.attr("x",o.x-i).attr("y",o.y-i).attr("width",o.width+2*i).attr("height",o.height+2*i),t<o.width/2&&(t=o.width/2),t>R.width-o.width/2&&(t=R.width-o.width/2),l.grp.attr("transform","translate("+(t+D.left)+","+(e+D.top)+")"),l}function da(t,e,a,r){if(!t)return void console.debug("updateTextBox: null input");a<20-D.top&&(a=20-D.top),a>R.height-15&&(a=R.height-15),t.text.text(r);const n=t.text.node().getBBox(),l=z.textBox.margin;t.rect.attr("x",n.x-l).attr("y",n.y-l).attr("width",n.width+2*l).attr("height",n.height+2*l),e<n.width/2&&(e=n.width/2),e>R.width-n.width/2&&(e=R.width-n.width/2),t.grp.attr("transform","translate("+(e+D.left)+","+(a+D.top)+")")}function ca(t){t?t.grp.remove():console.debug("updateTextBox: null input")}let ua,pa=1,fa=7;function ha(){const e=K.domain(),r=e.map(t=>t.getTime()/v),n=r.slice();n[0]=a.monthsnap(n[0]);const l=r.slice();l[0]=a.yearsnap(l[0]);const o=n.map(t=>new Date(t*v)),i=l.map(t=>new Date(t*v));(ua=[]).push([t.utcDay.range(e[0],e[1],1),"%b %d"]),ua.push([t.utcDay.range(e[0],e[1],2),"%b %d"]),ua.push([t.utcWeek.range(o[0],o[1],1),"%b %d"]),ua.push([t.utcWeek.range(o[0],o[1],2),"%b %d"]),ua.push([t.utcMonth.every(1).range(i[0],i[1]),"%b %Y"]),ua.push([t.utcMonth.every(2).range(i[0],i[1]),"%b %Y"]),ua.push([t.utcMonth.every(3).range(i[0],i[1]),"%Y"]),ua.push([t.utcYear.every(1).range(i[0],i[1]),"%Y"])}function ga(){const e=[V.invert(0).getTime(),V.invert(R.width).getTime()],a=(e[1]-e[0])/(v*f);z.focusRect.width<500?a*=1.6:z.focusRect.width<550?a*=1.4:z.focusRect.width<600&&(a*=1.2),a<10?(pa=0,fa=1):a<20?(pa=0,fa=2):a<45?(pa=0,fa=7):a<120?(pa=1,fa=7):a<240?(pa=2,fa=4):a<320?(pa=4,fa=1):a<547.5?(pa=4,fa=2):a<949?(pa=4,fa=3):a<1825?(pa=5,fa=3):a<3650?(pa=6,fa=4):(pa=7,fa=1);const r=ua[pa][0].filter(t=>t.getTime()<e[0]),n=(fa-r.length%fa)%fa,l=ua[pa][0].filter(t=>t.getTime()>=e[0]&&t.getTime()<=e[1]);I.tickValues(l).tickSize(6).tickSizeOuter(0).tickFormat((e,a)=>t.utcFormat(a%fa==n?ua[pa][1]:"")(e)),F.call(I.scale(V)),F.selectAll("g").classed("minor",!1),F.selectAll("g").filter((t,e)=>e%fa!=n).classed("minor",!0),F.selectAll("g").selectAll(".tick line").attr("transform","translate(0,-5)"),Z.tickValues(l).tickSize(R.width),J.call(Z.scale(V)),J.selectAll("g").classed("minor",!1),J.selectAll("g").filter((t,e)=>e%fa!=n).classed("minor",!0),j.tickValues(l).tickSize(6).tickSizeOuter(0).tickFormat((e,a)=>t.utcFormat(a%fa==n?ua[pa][1]:"")(e)),q.call(j.scale(V)),q.selectAll("g").classed("minor",!1),q.selectAll("g").filter((t,e)=>e%fa!=n).classed("minor",!0),q.selectAll("g").selectAll(".tick line").attr("transform","translate(0,6)")}function ma(){if(null!=z.divGraph&&!ge){et.text(be.yaxis),be.hidey&&!z.roadEditor?(Q.selectAll("text").attr("display","none"),tt.selectAll("text").attr("display","none")):(Q.selectAll("text").attr("display",null),tt.selectAll("text").attr("display",null));const t=Q.node().getBBox();s(t.width-re)>5&&(re=d(t.width),Ue())}}function ya(){const e=[V.invert(0),V.invert(R.width)];let a;if(z.headless){const t=be.vmin-x*(be.vmax-be.vmin);a=[be.vmax+x*(be.vmax-be.vmin),t]}else{const t=s(x*(be.vmax-be.vmin)),r=e.map(t=>d(t.getTime()/v)),n=Ba(we,r[0],r[1],!1);let l;if(n.yMin-=t,n.yMax+=t,z.roadEditor){const e=Ba(xe,r[0],r[1],!1);e.yMin-=t,e.yMax+=t,l=Da(n,e)}else l=n;const o=Pa(be.plotall&&!z.roadEditor?ze:ke,r[0],r[1],!1);null!=o&&(l=Da(l,o)),Aa(l,z.roadEditor?{xmin:0,xmax:0,ymin:.05,ymax:.05}:{xmin:0,xmax:0,ymin:.02,ymax:.02}),l.yMax-l.yMin<2*t&&(l.yMax+=t,l.yMin-=t),a=[l.yMax,l.yMin]}const r=o(1e-5,i(1,.001*a[0]));a[0]-a[1]<r&&(a[0]=a[0]+r,a[1]=a[1]-r);const n=t.zoomIdentity.scale(R.height/(W(a[1])-W(a[0]))).translate(0,-W(a[0]));X=n.rescaleY(W),Q.call(_.scale(X)),tt.call($.scale(X)),a[0]>be.yMax&&(be.yMax=a[0]),a[1]<be.yMin&&(be.yMin=a[1]),xa();const l=e.map(t=>at(t)),c=a.map(t=>lt(t));Ft.attr("x",l[0]+1).attr("width",o(0,l[1]-l[0]-2)).attr("y",c[0]+1).attr("height",o(0,c[1]-c[0]-2))}function xa(){null!=z.divGraph&&(at.domain([new Date(i(be.tmin,be.xMin)*v),new Date(o(be.tmax,be.xMax)*v)]),nt.call(rt.scale(at)),lt.domain([be.yMin,be.yMax]))}function va(){if(null==z.divGraph)return;const t=[at(V.invert(0)),at(V.invert(R.width))];t[0]<0&&(t[0]=0),t[1]>M.width&&(t[1]=M.width),Zt.call(jt.move,t)}function ba(){xa(),va()}function wa(){if(0==we.length)return;if(t.event&&t.event.sourceEvent&&"brush"===t.event.sourceEvent.type)return;const e=t.zoomTransform(Yt.node());null!=e&&(V=e.rescaleX(K),ga(),ya(),Q.selectAll("g").selectAll(".tick line").attr("transform","translate(6,0)"),tt.selectAll("g").selectAll(".tick line").attr("transform","translate(-5,0)"),ma(),va(),Un())}function ka(){if(0==we.length)return;if(t.event.sourceEvent&&"zoom"===t.event.sourceEvent.type)return;const e=t.event.selection||at.range();V.domain(e.map(at.invert,at)),ga(),ya(),ma(),Yt.call(Kt.transform,t.zoomIdentity.scale(M.width/(e[1]-e[0])).translate(-e[0],0)),Un()}function Ea(){if(null==z.divGraph)return;const e=be.tmin-x*(be.tmax-be.tmin),a=be.tmax+x*(be.tmax-be.tmin),r=[new Date(e*v),new Date(a*v)];V.domain(r);const n=r.map(at);ga(),ya(),Yt.call(Kt.transform,t.zoomIdentity.scale(M.width/(n[1]-n[0])).translate(-n[0],0))}function za(){null!=z.divGraph&&(Sa(!1),K.domain([new Date(i(be.tmin,be.xMin)*v),new Date(o(be.tmax,be.xMax)*v)]),ha(),W.domain([be.yMin,be.yMax]),V=K,X=W,xa(),Yt.call(Kt.transform,t.zoomIdentity),be.dir>0?(Vt.attr("transform",P.botin),It.attr("transform",P.botout)):(Vt.attr("transform",P.topin),It.attr("transform",P.topout)),ba())}function Ta(){ue=[],pe=[]}function Ra(t=!1){0!=ue.length&&r.sameRoads(ue[ue.length-1],we)||(ue.push(r.copyRoad(we)),t||(pe=[]))}function Ma(t){const e=xe,a=be.asof,n=be.horizon;if(be.yaw*r.rdf(t,a)<be.yaw*r.rdf(e,a)-1e-6)return!1;if(be.yaw*r.rdf(t,n)<be.yaw*r.rdf(e,n)-1e-6)return!1;const l=r.findSeg(t,a),o=r.findSeg(t,n);for(let a=l;a<o;a++)if(be.yaw*r.rdf(t,t[a].end[0])<be.yaw*r.rdf(e,t[a].end[0])-1e-6)return!1;const i=r.findSeg(e,a),s=r.findSeg(e,n);for(let a=i;a<s;a++)if(be.yaw*r.rdf(t,e[a].end[0])<be.yaw*r.rdf(e,e[a].end[0])-1e-6)return!1;return!0}function Da(t,e){let a={};return a.xMin=i(t.xMin,e.xMin),a.xMax=o(t.xMax,e.xMax),a.yMin=i(t.yMin,e.yMin),a.yMax=o(t.yMax,e.yMax),a}function Aa(t,e){let a=t.xMax-t.xMin;a<1e-7&&(a=1e-7);let r=t.yMax-t.yMin;r<1e-7&&(r=1e-7),t.xMin=t.xMin-e.xmin*a,t.xMax=t.xMax+e.xmax*a,t.yMin=t.yMin-e.ymin*r,t.yMax=t.yMax+e.ymax*r}function Pa(t,e,n,l=!1){let s={},d=t.filter(t=>t[0]>e&&t[0]<n);if(0==d.length){let a=-1;for(let r=0;r<t.length-1;r++)if(t[r][0]<=e&&t[r+1][0]>=n){a=r;break}a>0&&(d=t.slice(a,a+1))}if(0==d.length)return null;if(s.xMin=a.arrMin(d.map(t=>t[0])),s.xMax=a.arrMax(d.map(t=>t[0])),s.yMin=a.arrMin(d.map(t=>t[1])),s.yMax=a.arrMax(d.map(t=>t[1])),null!=ae.flad&&ae.flad[0]<=n&&ae.flad[0]>=e){const t=ae.flad[1]+r.ppr(we,be,be.asof);s.yMin=i(s.yMin,t),s.yMax=o(s.yMax,t)}return l&&Aa(s,{xmin:.1,xmax:.1,ymin:.1,ymax:.1}),s}function Ba(t,e,n,l=!1){let o={};return o.xMin=e,o.xMax=n,o.yMin=a.arrMin(t.map(function(t){return t.sta[0]<e||t.sta[0]>n?1/0:t.sta[1]})),o.yMax=a.arrMax(t.map(function(t){return t.sta[0]<e||t.sta[0]>n?-1/0:t.sta[1]})),o.yMin=a.arrMin([o.yMin,r.rdf(t,e),r.rdf(t,n)]),o.yMax=a.arrMax([o.yMax,r.rdf(t,e),r.rdf(t,n)]),l&&Aa(o,{xmin:.1,xmax:.1,ymin:.1,ymax:.1}),o}function La(){if(null!==be.waterbuf0)return;be.safebuf=r.dtd(we,be,be.tcur,be.vcur),be.tluz=i(be.tcur+be.safebuf*f,be.tfin+f,a.BDUSK),be.tluz>be.tfin&&(be.tluz=a.BDUSK),be.loser=r.redyest(we,be,be.tcur);const t=a.chop(be.yaw*(be.vcur-be.vfin)),n=be.asof===be.tfin&&t>=0,l=be.asof===be.tfin&&t<0;var o,s;be.waterbuf=be.loser?":(":be.asof>be.tfin?"fin":n?":)":l?"eke":be.tluz>be.tfin?"inf":be.safebuf<=0?(s=be.deadline,e.unix(s).utc().format("h:mma").replace(":00","")+"!"):be.safebuf<7?(o=be.tluz,e.unix(o).utc().format("ddd")):be.safebuf<365?be.safebuf+"d":be.safebuf<=999?be.safebuf+"d":be.safebuf>999?">999d":"???"}function Sa(e=!0){if(0==we.length)return;const r=be.asof,n=a.daysnap(i(r+z.maxFutureDays*f,we[we.length-1].sta[0])),l=Ba(we,we[0].end[0],n,!1);let s;s=z.roadEditor?Da(l,Ba(xe,we[0].end[0],n,!1)):l;const d=Pa(be.plotall&&!z.roadEditor?ze:ke,we[0].end[0],ke[ke.length-1][0],!1);if(null!=d&&(s=Da(s,d)),0!=ae.fuda.length){const t=Pa(ae.fuda,we[0].end[0],n,!1);null!=t&&(s=Da(s,t))}const c={xmin:.1,xmax:.1,ymin:.1,ymax:.1};if(z.roadEditor||(c.xmin=.02,c.xmax=.02),Aa(s,c),be.xMin=a.daysnap(s.xMin),be.xMax=a.daysnap(s.xMax),be.yMin=s.yMin,be.yMax=s.yMax,e&&null!=z.divGraph){const e=[V.invert(0),V.invert(R.width)];X.invert(0),X.invert(R.height),K.domain([new Date(i(be.tmin,be.xMin)*v),new Date(o(be.tmax,be.xMax)*v)]),ha(),W.domain([be.yMin,be.yMax]);const a=t.zoomIdentity.scale(R.width/(K(e[1])-K(e[0]))).translate(-K(e[0]),0);Yt.call(Kt.transform,a)}}function Ua(t,e,r=6e3){return a.linspace(t,e,d(a.clip((e-t)/(f+1),i(300,R.width/8),r)))}const Ca=`bgraph(${T}): Goal stats`,Na=`bgraph(${T}): Goal graph`;function Ga(t,e=!0){if(!("params"in t&&"data"in t))throw new Error("loadGoal: JSON input lacks params or data");Ta(),fe=!0;let l=t.params.yoog?" ("+t.params.yoog+")":"";if(e&&console.time(Ca+l),ae=new n(t),be=ae.gol,z.divJSON&&(z.headless?z.divJSON.innerText=JSON.stringify(ae.getStats()):z.divJSON.innerText=JSON.stringify(ae.getStats(),null,4)),e&&console.timeEnd(Ca+l),""!=be.error){console.log("Beebrain error: "+ae.gol.error),ce=b.BBERROR;const t=ae.gol.error.split("\\n");return Le(["The following errors prevented us from generating "+ae.gol.yoog,"(We've pinged Beeminder support to come help fix things up here!)",""].concat(t),le/30,null),Pe(),void(fe=!1)}if(z.noGraph)return Le(["Beebrain was called with 'NOGRAPH_*' as the slug","so no graph or thumbnail was generated, just this","static placeholder!"],le/30,null),Pe(),void(fe=!1);we=ae.roads,xe=r.copyRoad(we),ke=ae.data,Ee=a.deepcopy(t.data),ve=a.deepcopy(be),ze=ae.alldata,z.maxDataDays<0?(te=ke.slice(),ee=ze.slice()):(te=ke.filter(function(t){return t[0]>be.asof-z.maxDataDays*f}),ee=ze.filter(function(t){return t[0]>be.asof-z.maxDataDays*f})),z.divGraph&&(!z.roadEditor&&be.stathead?U.text(be.graphsum):U.text("")),e&&console.time(Na+l),Gr(),za(),Ea(),fe=!1,Ln(),oa(),null!==z.divData&&(Oe=0,qe=null,Ne.attr("disabled",null),Ke(),na()),Sn(),Ue(),function(){if(null!=z.divTable){var t,e,a="Daily Slope";"h"===be.runits&&(a="Hourly Slope"),"d"===be.runits&&(a="Daily Slope"),"w"===be.runits&&(a="Weekly Slope"),"m"===be.runits&&(a="Monthly Slope"),"y"===be.runits&&(a="Yearly Slope"),z.roadEditor?(t=["","End Date","Value",a,"",""],e=["","Goal Date","Value",a,"",""]):(t=["","End Date","Value",a],e=["","Goal Date","Value",a]),qr.selectAll("span.rdhdrcell").data(t).text(t=>t),Ir.selectAll("span.rdhdrcell").data(t).text(t=>t),sn.selectAll("span.rdhdrcell").data(e).text(t=>t),Pn()}}(),"function"==typeof z.onRoadChange&&z.onRoadChange.call(),e&&console.timeEnd(Na+l)}function Ha(e,n=null){let l=r.findSeg(we,e);if(l>=0){let o={},i=a.daysnap(e+f/2),s=n;null==n&&(s=we[l].sta[1]+we[l].slope*(i-we[l].sta[0])),Ra(),o.sta=[i,s],0==l?(o.end=we[l+1].sta.slice(),null!=n&&(o.end[1]=o.sta[1]+we[l].slope*(o.end[0]-i)),we[l].end=[i,s]):(l==we.length-1?(o.end=we[l].end.slice(),o.end[1]=s):(o.end=we[l+1].sta.slice(),null!=n&&z.keepSlopes&&(o.end[1]=o.sta[1]+we[l].slope*(o.end[0]-i))),we[l].end=[i,s],we[l].slope=r.segSlope(we[l]),we[l].sta[0]==we[l].end[0]&&(we[l].auto=r.RP.SLOPE)),o.slope=r.segSlope(o),o.auto=r.RP.VALUE,we.splice(l+1,0,o),r.fixRoadArray(we,z.keepSlopes?r.RP.VALUE:r.RP.SLOPE,!1),ia();let d=t.select(z.divTable).select(".roadrow [name=endvalue"+(l+1)+"]");d.empty()||kn(d,!1)}return l}function Oa(t,e){Ra();const a=we[t].slope;we.splice(t,1),e||!z.keepSlopes||isNaN(a)||(we[t].slope=a),r.fixRoadArray(we,z.keepSlopes&&!e?r.RP.VALUE:r.RP.SLOPE,e),ia()}let Ya=null,Ka=null,Va=null;function Ia(t,r){let n=V(a.daysnap(t[0])*v),l=t[1];if(Ja=e.unix(t[0]).utc(),Ya=sa(n,R.height-15,Ja.format("YYYY-MM-DD")+" ("+Ja.format("ddd")+")",z.textBoxCol.stroke),Ka=sa(n,X(l)-15,a.shn(t[1]),z.textBoxCol.stroke),null!=r){const t=V(a.daysnap(r[0])*v),e=X(r[1]);Va=sa(t,e,"s:"+a.shn(r[2]),z.textBoxCol.stroke),n-t<50&&(i=!0,(o=Va)?o.grp.attr("visibility",i?"hidden":"visible"):console.debug("updateTextBox: null input"))}var o,i}function ja(t,r){const n=a.daysnap(t[0]),l=t[1];if(Ja=e.unix(n).utc(),da(Ya,V(n*v),R.height-15,Ja.format("YYYY-MM-DD")+" ("+Ja.format("ddd")+")"),da(Ka,V(n*v),X(l)-15,a.shn(t[1])),null!=r){const t=a.daysnap(r[0]),e=r[1];da(Va,V(t*v),X(e),"s:"+a.shn(r[2]))}}function Za(){null!=Ya&&ca(Ya),Ya=null,null!=Ka&&ca(Ka),Ka=null,null!=Va&&ca(Va),Va=null}function Fa(e,r){const n=we,l=t.select(z.divGraph);for(let t=e;t<n.length;t++)l.select("[name=dot"+t+"]").attr("cx",De(V(n[t].end[0]*v))).attr("cy",De(X(n[t].end[1]))),l.select("[name=ctxdot"+t+"]").attr("cx",De(at(n[t].end[0]*v))).attr("cy",De(lt(n[t].end[1]))),l.select("[name=road"+t+"]").attr("x1",De(V(n[t].sta[0]*v))).attr("y1",De(X(n[t].sta[1]))).attr("x2",De(V(n[t].end[0]*v))).attr("y2",De(X(n[t].end[1]))),l.select("[name=ctxroad"+t+"]").attr("x1",De(at(n[t].sta[0]*v))).attr("y1",De(lt(n[t].sta[1]))).attr("x2",De(at(n[t].end[0]*v))).attr("y2",De(lt(n[t].end[1]))),r&&(l.select("[name=knot"+t+"]").attr("x1",De(V(n[t].end[0]*v))).attr("x2",De(V(n[t].end[0]*v))),l.select("[name=remove"+t+"]").attr("transform",t=>"translate("+(V(t.end[0]*v)+D.left-8)+","+(D.top-20)+") scale(0.6,0.6)")),l.select("[name=enddate"+t+"]").text(a.dayify(n[t].end[0],"-")),l.select("[name=endvalue"+t+"]").text(a.shn(n[t].end[1])),l.select("[name=slope"+t+"]").text(a.shn(n[t].slope*be.siru));z.tableUpdateOnDrag&&Bn(),z.duebyUpdateOnDrag&&oa(),Gr(),Hr(),kr(),br(),wr(),an(),rn(),zr(),Lr(),Tr(),Sr(),Ur()}let qa,Ja,Wa,Xa=null,_a=null,$a=null;function Qa(e,a=!0){if(null==z.divGraph)return;En(e,!0,a),Xa=e,_a=r.RP.DATE,t.select("[name=knot"+e+"]").attr("stroke-width",Ae(z.roadKnot.width));const n=V(we[e].end[0]*v);$a=bt.append("svg:line").attr("class","selectedknot").attr("pointer-events","none").attr("x1",n).attr("x2",n).attr("y1",0).attr("y2",R.height).attr("stroke",z.roadKnotCol.selected).attr("stroke-opacity",.9).attr("stroke-width",Ae(z.roadKnot.width+4)).lower()}function tr(e){En(e,!1),t.select("[name=knot"+e+"]").attr("stroke",z.roadKnotCol.dflt).attr("stroke-width",Ae(z.roadKnot.width))}function er(e,a=!0){null!=z.divGraph&&(zn(e,!0,a),Xa=e,_a=r.RP.VALUE,t.select("[name=dot"+e+"]").attr("r",Ae(z.roadDot.size)),$a=Ut.append("svg:circle").attr("class","selecteddot").attr("pointer-events","none").attr("cx",De(V(we[e].end[0]*v))).attr("cy",De(X(we[e].end[1]))).attr("fill",z.roadDotCol.selected).attr("fill-opacity",.6).attr("r",Ae(z.roadDot.size+4)).attr("stroke","none").lower())}function ar(e){zn(e,!1),t.select("[name=dot"+e+"]").attr("fill",z.roadDotCol.editable).attr("r",Ae(z.roadDot.size))}function rr(e,a=!0){null!=z.divGraph&&(Tn(e,!0,a),Xa=e,_a=r.RP.SLOPE,t.select("[name=road"+e+"]").attr("shape-rendering","geometricPrecision").attr("stroke-width",(z.roadLine.width,3)),$a=St.append("svg:line").attr("class","selectedroad").attr("shape-rendering","geometricPrecision").attr("pointer-events","none").attr("x1",V(we[e].sta[0]*v)).attr("x2",V(we[e].end[0]*v)).attr("y1",X(we[e].sta[1])).attr("y2",X(we[e].end[1])).attr("stroke",z.roadKnotCol.selected).attr("stroke-opacity",.9).attr("stroke-width",Ae(z.roadLine.width+4)).lower())}function nr(e){Tn(e,!1);const a=Ma(we)?z.roadLineCol.valid:z.roadLineCol.invalid;t.select("[name=road"+e+"]").style("stroke",a).attr("stroke-width",Ae(z.roadLine.width))}function lr(){Xa=null,_a=null,null!=$a&&($a.remove(),$a=null)}function or(){null!=Xa&&(_a==r.RP.DATE?tr(Xa):_a==r.RP.VALUE?ar(Xa):_a==r.RP.SLOPE&&nr(Xa),Za(),lr())}let ir=!1;function sr(e,a){t.event.sourceEvent.stopPropagation(),ir=!0,Ra();var n=Number(this.id);qa=r.copyRoad(we),null==Xa?Qa(n):null!=Xa&&Xa==n&&_a==r.RP.DATE?or():(or(),Qa(n)),Ia(e.end),Ya.grp.raise(),(Wa=[])[0]=we[n].slope,Wa[1]=we[n+1].slope}function dr(e,n){lr();let l=a.daysnap(V.invert(t.event.x)/v);const o=Number(this.id),i=we;l<i[o].sta[0]&&(l=i[o].sta[0]),l>i[o+1].end[0]&&(l=i[o+1].end[0]);const s=o+1;z.keepIntervals&&(s=i.length);for(let t=o;t<s;t++)i[t].end[0]=l+qa[t].end[0]-qa[o].end[0];isFinite(Wa[0])&&we[o].sta[0]!=we[o].end[0]&&(we[o].slope=Wa[0]),isFinite(Wa[1])&&we[o+1].sta[0]!=we[o+1].end[0]&&(we[o+1].slope=Wa[1]),r.fixRoadArray(i,z.keepSlopes?r.RP.VALUE:r.RP.SLOPE,!1,r.RP.DATE),Fa(o,!0),ja(e.end)}function cr(t,e){ir=!1,null==Xa&&(tr(e),Za(),ia()),qa=null}function ur(t){Oa(Number(this.id),!1)}let pr=!1;let fr,hr=!1;const gr={buf:!1,bux:!1,aura:!1,aurap:!1,hor:!1,hort:!1,ybr:!1,ybrc:!1,guides:!1,rosy:!1,rosyd:!1,data:!1,dataa:!1,mav:!1};function mr(t,e,a,r,n){var l,o=t.transition().duration(e);for(l=0;l<a.length;l++)o=o.attr(a[l][0],a[l][1]);for(l=0;l<r.length;l++)o=o.style(r[l][0],r[l][1]);for(o=o.transition().duration(e),l=0;l<a.length;l++)o=o.attr(a[l][0],a[l][2]);for(l=0;l<r.length;l++)o=o.style(r[l][0],r[l][2]);o.on("end",()=>{gr[n]&&mr(t,e,a,r,n)}),gr[n]=!0}function yr(t,e,a,r,n){gr[n]=!1;let l=t.transition().duration(e);for(let t=0;t<a.length;t++)l=l.attr(a[t][0],a[t][2]);for(let t=0;t<r.length;t++)l=l.style(r[t][0],r[t][2]);l.on("end",()=>{gr[n]=!1})}function xr(){(Wt=L.append("g").attr("id","beye")).append("ellipse").attr("cx",56.5).attr("cy",60).attr("rx",23).attr("ry",53).attr("fill","red"),Wt.append("path").attr("d","M41 7h15a23 53 0 0 1 0 106H41z").attr("fill","#fbb"),Wt.append("ellipse").attr("cx",41).attr("cy",60).attr("rx",23).attr("ry",53).attr("fill","red"),Wt.append("ellipse").attr("cx",40).attr("cy",60).attr("rx",17).attr("ry",41).attr("fill","#fff"),Wt.append("ellipse").attr("cx",39).attr("cy",60).attr("rx",14).attr("ry",31).attr("fill","red"),Wt.append("ellipse").attr("cx",38).attr("cy",60).attr("rx",9).attr("ry",20).attr("fill","#fff"),Wt.append("ellipse").attr("cx",37.5).attr("cy",60).attr("rx",5).attr("ry",10).attr("fill","red")}function vr(){(Xt=L.append("g").attr("id","beyepre")).append("ellipse").attr("cx",56.5).attr("cy",60).attr("rx",23).attr("ry",53).attr("fill","#ffe407"),Xt.append("path").attr("d","M41 7h15a23 53 0 0 1 0 106H41z").attr("fill","#fef7bc"),Xt.append("ellipse").attr("cx",41).attr("cy",60).attr("rx",23).attr("ry",53).attr("fill","#ffe407"),Xt.append("ellipse").attr("cx",40).attr("cy",60).attr("rx",17).attr("ry",41).attr("fill","#fff"),Xt.append("ellipse").attr("cx",39).attr("cy",60).attr("rx",14).attr("ry",31).attr("fill","#ffe407"),Xt.append("ellipse").attr("cx",38).attr("cy",60).attr("rx",9).attr("ry",20).attr("fill","#fff"),Xt.append("ellipse").attr("cx",37.5).attr("cy",60).attr("rx",5).attr("ry",10).attr("fill","#ffe407")}function br(){if(!fe&&null!=z.divGraph&&0!=we.length){var t=Lt.select(".bullseye");null==Wt&&xr();var e=De(V(be.tfin*v)),a=De(X(r.rdf(we,be.tfin)));t.empty()?Lt.append("svg:use").attr("xlink:href","#beye").attr("class","bullseye").attr("x",e).attr("y",a).attr("transform","scale(0.33) translate(-40,-60)").attr("transform-origin",e+" "+a):t.attr("x",e).attr("y",a).attr("transform-origin",e+" "+a)}}function wr(){if(!fe&&null!=z.divGraph&&0!=we.length){var t=Y.select(".ctxbullseye");null==Wt&&xr();var e=at(be.tfin*v),a=lt(r.rdf(we,be.tfin));t.empty()?Y.append("svg:use").attr("xlink:href","#beye").attr("class","ctxbullseye").attr("x",e).attr("y",a).attr("transform","scale(0.16) translate(-40,-60)").attr("transform-origin",e+" "+a):t.attr("x",e).attr("y",a).attr("transform-origin",e+" "+a).attr("transform-origin",e+" "+a)}}function kr(){if(fe||null==z.divGraph||0==we.length||ge)return;const t=[0,0],e=[0,R.height/2],a=[R.width/2,0],r=[R.width/2,R.height/2];let n,l,o,i,s,d,c,u=null,p=1;La(),":("===be.waterbuf&&(function(){if(null!=$t)return;let t;(t=($t=L.append("g").attr("id","skl")).append("g").attr("fill","#222").attr("stroke","#fff")).append("path").attr("d","m51.3 169 140-69.7s17.7 4.6 21.9 0.707c4.24-3.89 6.01-10.6 3.18-13.8-2.83-3.18-5.3 1.06-10.6-3.54s-1.06-4.6-6.01-8.84c-4.95-4.24-8.84-2.12-12 0.354s0 8.49-2.83 11c-2.83 2.47-141 72.5-141 72.5s-16.6 2.12-22.3 6.72c-5.66 4.6 1.41 7.07 4.6 11.7 3.18 4.6 1.77 6.01 6.01 8.84 4.24 2.83 5.66 1.77 9.9-1.77s5.66-11.3 9.55-14.1z"),t.append("path").attr("d","m41.4 86.3s127 66.1 133 68.9c6.01 2.83 15.2-2.47 19.8-0.354 4.6 2.12 5.66 6.72 3.89 10.3-1.77 3.54-7.42 14.1-9.9 18.7-2.47 4.6-4.6 3.89-10.6 0.707s-4.24-13.8-6.36-14.8-127-65.8-132-68.2c-4.6-2.47-16.3 4.95-25.1 0.707-8.84-4.24-5.66-11.3-5.66-13.1s2.47-2.47 4.24-8.13c1.77-5.66-2.12-7.42 1.41-11.3 3.54-3.89 6.72-2.83 11-0.354 4.24 2.47 13.4 15.2 16.3 17z"),t.append("path").attr("d","m109 20.9c17.9-0.508 44.6 7.07 51.6 14.5 7.07 7.42 15.9 17.7 17.3 45.3 1.41 27.6-5.02 22.2-9.55 35-4.12 11.7 2.15 16.3 1.06 22.3-2.14 11.8-19.8 8.77-24 10.2-2.32 0.8-4.24 6.01-4.24 6.01l-7.07 2.12s-1.1 2.93-0.62 8.75c-0.68-0.27-2.32 1.26-2.97 0.89-3.53-1.99-6.31-5.75-6.31-5.75l-0.36 8.13-7.77-0.35-0.71-4.25-1.42 4.6-5.3-0.35-2.12-4.95-4.6 2.47-3.53-1.06-1.06-11-3.54 8.84-4.6-1.77-1.41-5.3-1.41 2.83-3.18-2.48-1.41-9.19s-5.87-3.86-9.19-3.89c-2.54 0-4.58 3.34-7.07 2.83-3.43-0.7-6.34-4.1-7.42-7.42-1.4-4.32 2.84-8.96 2.12-13.4-2.72-17-15.2-18.2-15.2-49.5 0.02-12.3 2.37-25.3 11.6-34 9.21-8.73 31-19.5 52.4-20.1z"),t.append("path").attr("d","m73.7 177c0.34 2.72 21 25.1 39.2 25 7.11-0.0235 33.2-11.7 36.4-21.1 0.752-2.19-1.86-6.06-1.94-9.19-0.144-5.21 2.93-14.1 2.39-15.5s-3.65-2.06-4.68-1.59-5.21 12.5-5.21 12.5l-1.94-0.884-3.45 0.884 1.41 6.54-2.3 2.39-1.94-6.1-3.89 1.33-0.354 3.18-1.68-0.177-1.68-3.45-3.18 0.442-2.3 6.72-2.39-0.442-2.21-4.86-4.33-1.33-1.41 4.77-2.92-0.442-1.41-4.86-4.51 0.177-1.06 3.18-1.41-0.884-1.68-5.57-5.3 0.884-0.354 5.39-1.59-0.265-0.795-8.57-3.8-0.177 1.24 8.31-3.01-4.77s-2.48-10.1-3.31-15.5c-0.111-0.731-1.98-0.492-2.86-0.126-1.16 0.481-2.82 1.34-2.54 2.78 0.452 2.26 3.62 10.5 3.75 12.6s-3.26 6.03-2.92 8.75z"),(t=$t.append("g").attr("fill","#fff").attr("stroke","#fff")).append("path").attr("d","m67.9 97.1c2.4-4.36 9.18-4.48 14.1-4.77 4.06-0.237 14.1 2.22 19.6 4.95 3.86 1.89 4.98 6.82 2.65 9.19-2.28 2.32-3.89 8.51-7.07 11.3-2.6 2.29-6.82 2.01-10.3 1.59-3.17-0.388-5.65-3.55-8.84-3.71-2.4-0.119-5.42 4.02-6.89 2.12-1.8-2.31-0.205-6.51-0.707-9.72-0.58-3.71-4.47-7.67-2.65-11z"),t.append("path").attr("d","m122 102c2.06-3.69 11.8-5.75 17.3-7.78 3.18-1.16 6.85 0.177 10.5 1.49 2.75 0.984 5.97 1.8 6.44 2.4 0.647 0.812 0.362 4.38 0.797 7.36 0.508 3.48 1.61 6.46 0.44 8.2-2.16 3.19-10.1 7.83-16.1 7.78-4.69-0.0443-9.21-3.07-12.6-6.36-3.51-3.46-9.3-8.78-6.89-13.1z"),t.append("path").attr("d","m114 112c2.25-0.23 4.3 6.35 6.79 9.3 1.64 1.94 3.31 2.8 5.01 5.68 1.55 2.63 0.192 7.63-1.5 8.52-1.44 0.758-5.6-1.44-6.6-2.56-1.59-1.76-0.862-6.48-3-6.44-2.6 0.0487-0.309 5.91-2.22 7.84-1.52 1.55-4.21 2.63-6.24 1.86-1.68-0.636-2.76-2.78-2.86-4.57-0.137-2.56 2.89-8.27 4.48-11.9 0.864-1.96 3.22-7.44 6.12-7.74z")}(),u="#skl",p=.76),"inf"===be.waterbuf?(null==_t&&((_t=L.append("g").attr("id","inf")).append("path").attr("fill","black").attr("d","M 50.2,164.0 C 21.3,163.6 4.6,140.4 4.7,116.2 5,92 27.4,60.9 56.9,61.1 c 29.5,0.2 49.5,21.8 59.3,35.4 0,0 30.7,-36.0 59.6,-35.6 28.9,0.4 45.7,23.6 45.5,47.8 -0.2,24.2 -22.6,55.3 -52.2,55.1 -29.5,-0.2 -49.5,-21.8 -59.3,-35.4 0,0 -30.7,36 -59.6,35.6 z"),_t.append("path").attr("fill","white").attr("d","m 100.6,117.2 c 0,0 -25.8,25.5 -43.1,25 C 40.1,141.7 30.5,122 31,105.1 31.5,88.3 38.7,71.2 53.4,71.4 68.1,71.7 86.6,93.1 100.6,117.2 Z"),_t.append("path").attr("fill","white").attr("d","m 126.6,105.5 c 0,0 25.8,-25.5 43.1,-25 17.3,0.5 27,20.2 26.5,37.1 -0.5,16.9 -7.7,33.9 -22.4,33.7 -14.7,-0.2 -33.2,-21.7 -47.2,-45.7 z")),u="#inf",p=.76):":)"===be.waterbuf&&(function(){if(null!=Qt)return;let t;(Qt=L.append("g").attr("id","sml")).append("path").attr("fill","#000").attr("d","m116 9c82 0.2 78 32 78 107 0 75 1 103-79 103-80 0-79-22-80-103-1-82-1-107 81-107z"),Qt.append("path").attr("fill","#fff").attr("d","m115 32c55 0.1 51 25 51 83 0 58 7 80-49 80-56 0-54-19-55-81-0.8-63-2-82 53-81z"),(t=Qt.append("g").attr("fill","#000")).append("path").attr("d","m115 146c10 0.2 18-8 19-14 2-6 5-11 11-11s10 5 10 13-11 33-40 33c-29 0-41-25-41-33s6-12 11-12c5 0 10 2 12 9 2 6 10 14 19 14z"),t.append("circle").attr("cx",136).attr("cy",83).attr("r",18),t.append("circle").attr("cx",90).attr("cy",83).attr("r",18)}(),u="#sml",p=.76),be.dir>0&&be.yaw<0?(n=r,l=t):be.dir<0&&be.yaw>0?(n=a,l=e):be.dir<0&&be.yaw<0?(n=e,l=a):(n=t,l=r);let f=Ct.select(".waterbuf");const h=z.watermark.fntsize,g=z.watermark.height;f.remove(),null!=u?(o=(R.width/2-g)/2,i=(R.height/2-g)/2,f=Ct.append("svg:use").attr("class","waterbuf").attr("transform","scale("+p+")").attr("transform-origin",o+n[0]+" "+(i+n[1])).attr("xlink:href",u)):(o=R.width/4,i=R.height/4+h/3,(s=(f=Ct.append("svg:text").attr("class","waterbuf").style("font-size",h+"px").style("font-weight","bolder").style("fill",z.watermark.color).text(be.waterbuf)).node().getBBox()).width>R.width/2.2&&(c=(d=h*(R.width/2.2)/s.width)/h*s.height,i=R.height/4+c/3,f.style("font-size",d+"px"))),f.attr("x",o+n[0]).attr("y",i+n[1]);let m=Ct.select(".waterbux");m.remove(),z.roadEditor?m.remove():(o=R.width/4,i=R.height/4+h/3,(s=(m=Ct.append("svg:text").attr("class","waterbux").style("font-size",h+"px").style("font-weight","bolder").style("fill",z.watermark.color).text(be.waterbux)).node().getBBox()).width>R.width/2.2&&(c=(d=h*(R.width/2.2)/s.width)/h*s.height,i=R.height/4+c/3,m.style("font-size",d+"px")),m.attr("x",o+l[0]).attr("y",i+l[1]))}function Er(){if(fe||null==z.divGraph||0==we.length||ge)return;const t=Rt.selectAll(".aura"),e=Rt.selectAll(".aurapast");if(be.aura&&z.showData){const r=s(X.invert(0)-X.invert(z.dataPoint.size*se)),n=o(be.stdflux,De(2*r)),l=i(0,-n),d=o(0,n),c=x*(be.tmax-be.tmin),u=[V.invert(0).getTime()/v,V.invert(R.width).getTime()/v];let p,f;p=Ua(o(u[0],be.tmin,i(be.tini,ke[0][0])),a.arrMin([u[1],be.horizon,be.tmax+c]),R.width/8);let h="M"+De(V(p[0]*v))+" "+De(X(be.auraf(p[0])+d));for(f=1;f<p.length;f++)h+=" L"+De(V(p[f]*v))+" "+De(X(be.auraf(p[f])+d));for(f=p.length-1;f>=0;f--)h+=" L"+De(V(p[f]*v))+" "+De(X(be.auraf(p[f])+l));if(h+=" Z",t.empty()?Rt.append("svg:path").attr("class","aura").attr("d",h).style("fill",a.BHUE.LPURP).style("stroke-width",2).style("stroke",a.BHUE.LPURP):t.attr("d",h),u[0]<be.tmin){for(p=Ua(u[0],be.tmin,R.width/8),h="M"+De(V(p[0]*v))+" "+De(X(be.auraf(p[0])+d)),f=1;f<p.length;f++)h+=" L"+De(V(p[f]*v))+" "+De(X(be.auraf(p[f])+d));for(f=p.length-1;f>=0;f--)h+=" L"+De(V(p[f]*v))+" "+De(X(be.auraf(p[f])+l));h+=" Z",e.empty()?Rt.append("svg:path").attr("class","aurapast").attr("d",h).style("fill",a.BHUE.LPURP).style("stroke-width",2).style("stroke-dasharray","4,4").style("stroke",a.BHUE.LPURP):e.attr("d",h)}else e.remove()}else t.remove(),e.remove()}function zr(){if(fe||null==z.divGraph||0==we.length)return;const e=t.selectAll("#svg"+T+" #ybhpgrp path"),n=t.selectAll("#svg"+T+" #ybhplinesgrp path"),l=e.size()+n.size(),i=[be.tini,be.tfin],s=(be.asof,be.asof,a.BHUE.RAZR3),d=a.BHUE.RAZR2,c=a.BHUE.RAZR1,u=(be.tfin-be.tini)/f,p=[[0,2,"#ffff88","none",0,.72,i],[u,-1,"#ffffbd","none",0,.72,i]],h=[[6,6,"none",s,.99,1,i],[2,2,"none",d,.99,1,i],[1,1,"none",c,.99,1,i],[0,2,"#ffff88","none",0,.72,i],[u,-1,"#ffffbd","none",0,.72,i]];let g;g=be.maxflux>0?p:h;for(let t=0;t<o(l,g.length);t++){const e="halfplane"+t,a=g[t];if(null==a||null==a[2]&&null==a[3]){it.select("."+e).remove(),st.select("."+e).remove();continue}let n,l;a[0]!=a[1]?(l=it,st.select("."+e).remove()):(l=st,it.select("."+e).remove()),n=l.select("."+e);const o="r"+a[0]+a[1],i=be.yaw*a[4]/2;let s=a[6];null==s&&(s=[-1/0,1/0]);const d=a[0],c=a[1];if(d<0){console.log("updateYBHP(): Invalid region definition");continue}let u,p,f=we[0].end[0],h=we[we.length-1].sta[0];f<s[0]&&(f=s[0]),h>s[1]&&(h=s[1]),be.yaw<0?(u=be.yMin-.1*(be.yMax-be.yMin),p=be.yMax+.1*(be.yMax-be.yMin)):(u=be.yMax+.1*(be.yMax-be.yMin),p=be.yMin-.1*(be.yMax-be.yMin));const m=Me(d);let y=m[0][0],x=m[0][1];y<f&&(y=f,x=r.isoval(m,y));let b="M"+De(V(y*v))+" "+De(X(x)+i);for(let t=1;t<m.length&&(y=m[t][0],x=m[t][1],y<f||(y>h&&(y=h,x=r.isoval(m,y)),b+=" L"+De(V(y*v))+" "+De(X(x)+i),!(m[t][0]>h)));t++);if(-1==c)b+=" L"+De(V(h*v))+" "+De(X(r.isoval(m,h))+i),b+=" L"+De(V(h*v))+" "+De(X(u)),b+=" L"+De(V(f*v))+" "+De(X(u)),b+=" Z";else if(-2==c)b+=" L"+V(h*v)+" "+De(X(r.isoval(m,h))+i),b+=" L"+De(V(h*v))+" "+De(X(p)),b+=" L"+De(V(f*v))+" "+De(X(p)),b+=" Z";else if(d!=c){const t=Me(c),e=t.length;let a=t[e-1][0],n=t[e-1][1];a>h&&(a=h,n=r.isoval(t,a)),b+=" L"+De(V(a*v))+" "+De(X(n)+i);for(let l=e-2;l>=0&&(a=t[l][0],n=t[l][1],a>h||(a<f&&(a=f,n=r.isoval(t,a)),b+=" L"+De(V(a*v))+" "+De(X(n)+i),!(t[l][0]<f)));l--);b+=" Z"}n.empty()?l.append("svg:path").attr("class","ybhp "+e).attr("id",o).attr("d",b).attr("fill",a[2]).attr("fill-opacity",a[5]).attr("stroke",a[3]).attr("stroke-width",a[4]):n.attr("d",b).attr("id",o).attr("fill",a[2]).attr("fill-opacity",a[5]).attr("stroke",a[3]).attr("stroke-width",a[4])}}function Tr(){if(fe||null==z.divGraph||0==we.length)return;const e=dt.select(".pinkregion"),n=Ma(we);let l=xe;z.roadEditor||(l=we);const o=be.asof,i=be.horizon;let s;s=be.yaw>0?be.yMin-5*(be.yMax-be.yMin):be.yMax+5*(be.yMax-be.yMin);const d="url(#pinkzonepat"+T+")",c=t.select(" #pinkzonepat"+T+" rect"),u=t.select(" #pinkzonepat"+T+" line");c.attr("fill",n||!z.roadEditor?a.BHUE.PINK:"#ffbbbb"),u.style("stroke",n||!z.roadEditor?"#aaaaaa":"#666666");const p=r.findSeg(l,o),f=r.findSeg(l,i);let h="M"+V(o*v)+" "+X(r.rdf(l,o));for(let t=p;t<f;t++)h+=" L"+V(l[t].end[0]*v)+" "+X(l[t].end[1]);h+=" L"+V(i*v)+" "+X(r.rdf(l,i)),h+=" L"+V(i*v)+" "+X(s),h+=" L"+V(o*v)+" "+X(s),h+=" Z",ct.attr("patternTransform",be.dir>0?"rotate(135)":"rotate(45)").attr("x",-be.dir*V(o*v)),e.empty()?dt.append("svg:path").attr("class","pinkregion").attr("d",h).attr("fill-opacity",.4).attr("fill",d):e.attr("d",h).attr("fill",d)}function Rr(t,e,n,l,o,i){if(fe||null==z.divGraph||0==we.length)return;const s=n.select("."+l);if(null==o)return void s.remove();const d=z.oldRoadLine.dash+","+c(z.oldRoadLine.dash/2),u=i?d:null;let p=V(t[0].sta[0]*v),f=X(t[0].sta[1]+o),h=V(t[0].end[0]*v),g=X(t[0].end[1]+o);if(t[0].sta[0]<e.tini&&(p=V(e.tini*v),f=X(r.rdf(t,e.tini)+o)),i){const t=-V(e.tini*v)%c(1.5*z.oldRoadLine.dash);h!==p&&(f+=(-t-p)*(g-f)/(h-p)),(p<0||t>0)&&(p=-t)}let m="M"+De(p)+" "+De(f);for(const r of t){let t=a.daysnap(r.end[0]);if(h=V(r.end[0]*v),!(t<e.tini)){if(t>e.tfin)break;if(g=X(r.end[1]+o),m+=" L"+De(h)+" "+De(g),h>R.width)break}}s.empty()?n.append("svg:path").attr("class",l).attr("d",m).style("stroke-dasharray",u):s.attr("d",m).style("stroke-dasharray",u)}function Mr(t,e){let a=[t[1][0]-t[0][0],t[1][1]-t[0][1]];const r=1/a[0],n=1/a[1],l=Math.sign(r),o=Math.sign(n),i=(e[0]-l*e[2]-t[0][0])*r,s=(e[1]-o*e[3]-t[0][1])*n,d=(e[0]+l*e[2]-t[0][0])*r,c=(e[1]+o*e[3]-t[0][1])*n;return!(i>c||s>d||(i>s?i:s)>1||(d<c?d:c)<0)}function Dr(t,e){if(!t||!t.length)return!1;const r=e[0]-e[2],n=e[0]+e[2];let l=a.searchLow(t,t=>t[0]<r?-1:1),o=a.searchLow(t,t=>t[0]<n?-1:1);l<0&&(l=0),o>t.length-2&&(o=t.length-2);for(let a=l;a<=o;a++)if(Mr([t[a],t[a+1]],e))return!0;return!1}let Ar,Pr=-1;function Br(t){const e=Me(t),n=[V.invert(0)/v,V.invert(R.width)/v],l=[X.invert(R.height),X.invert(0)],d=[(n[0]+n[1])/2,(l[0]+l[1])/2,(n[1]-n[0])/2,(l[1]-l[0])/2];if(t!=Pr&&(Pr=t,Ar=Array(t).fill().map((t,e)=>e)),Dr(e,d)){const t=a.searchHigh(Ar,t=>!function(t,e,n){if(!(t&&t.length&&e&&e.length))return!1;const l=n[0]-n[2],o=n[0]+n[2];if(s(r.isoval(t,l)-r.isoval(e,l))>1e-5||s(r.isoval(t,o)-r.isoval(e,o))>1e-5)return!1;let i=a.searchHigh(t,t=>t[0]<l?-1:1),d=a.searchLow(t,t=>t[0]<o?-1:1),c=a.searchHigh(e,t=>t[0]<l?-1:1),u=a.searchLow(e,t=>t[0]<o?-1:1);for(let a=i;a<d;a++)if(s(r.isoval(e,t[a][0])-t[a][1])>1e-5)return!1;for(let a=c;a<u;a++)if(s(r.isoval(t,e[a][0])-e[a][1])>1e-5)return!1;return!0}(e,Me(t),d)?-1:1);return i(t,Ar.length-1)}const c=a.searchLow(Ar,t=>Dr(Me(t),d)?-1:1);return o(c,0)}function Lr(){if(fe||null==z.divGraph||0==we.length)return;let t=gt.selectAll(".guides");if(z.roadEditor&&!z.showGuidelines)return void t.remove();let e=1;const n=[V.invert(0)/v,V.invert(R.width)/v],l=(t,e)=>(function(t,e){const n=Me(t);null==e&&(e=[-1/0,1/0]);let l=n[0][0],o=n[0][1];l<e[0]&&(l=e[0],o=r.isoval(n,l));let i="M"+De(V(l*v))+" "+De(X(o)),s=a.searchHigh(n,t=>t[0]<e[0]?-1:1),d=a.searchHigh(n,t=>t[0]<e[1]?-1:1);d>n.length-1&&(d=n.length-1);for(let t=s;t<=d;t++)i+=" L"+De(V(n[t][0]*v))+" "+De(X(n[t][1]));return i})(t,[o(be.tini,n[0]),i(be.tfin,n[1])]),d=function(t){let e=0;const a=i(z.maxFutureDays,c((be.tfin-be.tini)/f)),n=Me(0),l=Me(a);return e=be.yaw*be.dir>0?s(r.isoval(n,t[0])-r.isoval(l,t[0]))/a:s(r.isoval(n,t[1])-r.isoval(l,t[1]))/a}(n),u=s(X(0)-X(d));let p=Br(c((be.tfin-be.tini)/f));p=c(p/(e=u>8||p<42?1:7*u>8||p<168?7:28*u>12||p<672?28:112*u>12||p<2016?112:336));let h=Ar.slice(0,p+1).map(t=>(t+1)*e-1);(t=t.data(h)).exit().remove(),t.enter().append("svg:path").attr("class","guides").attr("d",l).attr("id",t=>"g"+t).attr("transform",null),t.attr("d",l).attr("id",t=>"g"+t).attr("transform",null)}function Sr(){fe||null==z.divGraph||0==we.length||Rr(we,be,mt,"maxflux",0!=be.maxflux?be.yaw*be.maxflux:null,!1)}function Ur(){fe||null==z.divGraph||0==we.length||Rr(we,be,yt,"stdflux",0!=be.maxflux?be.yaw*be.stdflux:null,!0)}function Cr(){if(fe||null==z.divGraph||0==we.length)return;const e=bt.selectAll(".knots").data(we),a=S.selectAll(".remove").data(we);if(!z.roadEditor)return e.remove(),void a.remove();e.exit().remove(),e.attr("x1",function(t){return V(t.end[0]*v)}).attr("y1",0).attr("x2",function(t){return V(t.end[0]*v)}).attr("y2",R.height).attr("stroke","rgb(200,200,200)").attr("stroke-width",z.roadKnot.width),e.enter().append("svg:line").attr("class","knots").attr("id",function(t,e){return e}).attr("name",function(t,e){return"knot"+e}).attr("x1",function(t){return V(t.end[0]*v)}).attr("x2",function(t){return V(t.end[0]*v)}).attr("stroke","rgb(200,200,200)").attr("stroke-width",z.roadKnot.width).on("wheel",function(e){const a=new t.event.constructor(t.event.type,t.event);Yt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseover",function(e,a){ir||pr||hr||_a==r.RP.DATE&&a==Xa||(En(a,!0),t.select(this).attr("stroke-width",z.roadKnot.width+2))}).on("mouseout",function(e,a){ir||pr||hr||_a==r.RP.DATE&&a==Xa||(En(a,!1),t.select(this).attr("stroke-width",z.roadKnot.width))}).on("click",function(e,a){t.event.ctrlKey&&function(e,a){const n=Number(a),l=t.select(z.divTable);we[n].auto==r.RP.DATE&&(z.keepSlopes?Rn(a):Mn(a));const o=l.select("[name=enddate"+n+"]").node();let i,s;o.focus(),document.body.createTextRange?((i=document.body.createTextRange()).moveToElementText(o),i.select()):window.getSelection&&(s=window.getSelection(),(i=document.createRange()).selectNodeContents(o),s.removeAllRanges(),s.addRange(i))}(0,this.id)}).call(t.drag().on("start",sr).on("drag",dr).on("end",cr)),a.exit().remove(),a.attr("transform",function(t){return"translate("+(V(t.end[0]*v)+D.left-14*z.roadKnot.rmbtnscale)+","+(D.top-28*z.roadKnot.rmbtnscale-3)+") scale("+z.roadKnot.rmbtnscale+")"}).style("visibility",function(t,e){return e>0&&e<we.length-2?"visible":"hidden"}),a.enter().append("use").attr("class","remove").attr("xlink:href","#removebutton").attr("id",function(t,e){return e}).attr("name",function(t,e){return"remove"+e}).attr("transform",function(t){return"translate("+(V(t.end[0]*v)+D.left-14*z.roadKnot.rmbtnscale)+","+(D.top-28*z.roadKnot.rmbtnscale-3)+") scale("+z.roadKnot.rmbtnscale+")"}).style("visibility",function(t,e){return e>0&&e<we.length-2?"visible":"hidden"}).on("mouseenter",function(e,a){t.select(this).attr("fill",z.roadKnotCol.rmbtnsel),En(a,!0)}).on("mouseout",function(e,a){t.select(this).attr("fill",z.roadKnotCol.rmbtns),En(a,!1)}).on("click",ur)}function Nr(){if(fe||null==z.divGraph||0==we.length)return;const e=St.selectAll(".roads").data(we);z.roadEditor?(e.exit().remove(),e.attr("x1",function(t){return V(t.sta[0]*v)}).attr("y1",function(t){return X(t.sta[1])}).attr("x2",function(t){return V(t.end[0]*v)}).attr("y2",function(t){return X(t.end[1])}).attr("stroke-dasharray",function(t,e){return 0==e||e==we.length-1?"3,3":"none"}).style("stroke",z.roadLineCol.invalid),e.enter().append("svg:line").attr("class","roads").attr("id",function(t,e){return e}).attr("name",function(t,e){return"road"+e}).attr("x1",function(t){return V(t.sta[0]*v)}).attr("y1",function(t){return X(t.sta[1])}).attr("x2",function(t){return V(t.end[0]*v)}).attr("y2",function(t){return X(t.end[1])}).style("stroke",z.roadLineCol.invalid).attr("stroke-dasharray",function(t,e){return 0==e||e==we.length-1?"3,3":"none"}).attr("stroke-width",z.roadLine.width).on("wheel",function(e){const a=new t.event.constructor(t.event.type,t.event);Yt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseover",function(e,a){ir||pr||hr||_a==r.RP.SLOPE&&a==Xa||a>0&&a<we.length-1&&(t.select(this).attr("stroke-width",z.roadLine.width+2),Tn(a,!0))}).on("mouseout",function(e,a){ir||pr||hr||_a==r.RP.SLOPE&&a==Xa||a>0&&a<we.length-1&&(t.select(this).attr("stroke-width",z.roadLine.width),Tn(a,!1))}).on("click",function(e,a){t.event.ctrlKey&&function(e,a){const n=Number(a),l=t.select(z.divTable);e.auto==r.RP.SLOPE&&Rn(a);const o=l.select("[name=slope"+n+"]").node();let i,s;o.focus(),document.body.createTextRange?((i=document.body.createTextRange()).moveToElementText(o),i.select()):window.getSelection&&(s=window.getSelection(),(i=document.createRange()).selectNodeContents(o),s.removeAllRanges(),s.addRange(i))}(e,this.id)}).call(t.drag().on("start",function(e,n){n>0&&n<we.length-1&&function(e,n){t.event.sourceEvent.stopPropagation(),hr=!0,fr=a.daysnap(V.invert(t.event.x)/v),Ra(),qa=r.copyRoad(we),null==Xa?rr(n):null!=Xa&&Xa==n&&_a==r.RP.SLOPE?or():(or(),rr(n));let l=(e.sta[0]+e.end[0])/2;l<V.invert(0)/v&&(l=V.invert(0)/v),l>V.invert(R.width)/v-10&&(l=V.invert(R.width)/v-10),Ia(e.end,[l,e.sta[1]+e.slope*(l-e.sta[0]),e.slope*be.siru]),Va.grp.raise()}(e,Number(this.id))}).on("drag",function(e,n){n>0&&n<we.length-1&&function(e,n){lr(),be.asof;const l=a.daysnap(V.invert(t.event.x)/v),i=X.invert(t.event.y),s=n,d=we;we[s].slope=(i-e.sta[1])/o(l-e.sta[0],f),we[s].end[1]=we[s].sta[1]+we[s].slope*(we[s].end[0]-we[s].sta[0]),we[s+1].sta[1]=we[s].end[1],z.keepSlopes||(we[s+1].slope=r.segSlope(we[s+1])),r.fixRoadArray(d,r.RP.VALUE,!1,r.RP.SLOPE),Fa(s,!0);let c=(e.sta[0]+e.end[0])/2;c<V.invert(0)/v&&(c=V.invert(0)/v),c>V.invert(R.width)/v-10&&(c=V.invert(R.width)/v-10),ja(e.end,[c,e.sta[1]+e.slope*(c-e.sta[0]),e.slope*be.siru])}(e,Number(this.id))}).on("end",function(t,e){var a;e>0&&e<we.length-1&&(a=Number(this.id),hr=!1,null==Xa&&(nr(a),Za(),ia()),qa=null)}))):e.remove()}function Gr(){Te=fe?be.dtdarray:r.dtdarray(we,be),Re=[];for(let t=0;t<7;t++)Re[t]=r.isoline(we,Te,be,t)}function Hr(){fe||null==z.divGraph||0==we.length||z.roadEditor&&(Ma(we)?Ot.attr("visibility","hidden"):Ot.attr("visibility","visible"))}function Or(){if(fe||null==z.divGraph)return;const e=Ut.selectAll(".dots").data(we);z.roadEditor?(e.exit().remove(),e.attr("cx",function(t){return De(V(t.sta[0]*v))}).attr("cy",function(t){return De(X(t.sta[1]))}),e.enter().append("svg:circle").attr("class","dots").attr("id",function(t,e){return e-1}).attr("name",function(t,e){return"dot"+(e-1)}).attr("cx",function(t){return De(V(t.sta[0]*v))}).attr("cy",function(t){return De(X(t.sta[1]))}).attr("r",Ae(z.roadDot.size)).attr("fill",z.roadDotCol.editable).style("stroke-width",z.roadDot.border).on("wheel",function(e){const a=new t.event.constructor(t.event.type,t.event);Yt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseover",function(e,a){ir||pr||hr||_a==r.RP.VALUE&&a-1==Xa||(zn(a-1,!0),t.select(this).attr("r",Ae(z.roadDot.size+2)))}).on("mouseout",function(e,a){ir||pr||hr||_a==r.RP.VALUE&&a-1==Xa||(zn(a-1,!1),t.select(this).attr("r",Ae(z.roadDot.size)))}).on("click",function(e,a){t.event.ctrlKey&&function(e,a){const n=Number(a),l=t.select(z.divTable);we[n].auto==r.RP.VALUE&&Mn(a);const o=l.select("[name=endvalue"+n+"]").node();let i,s;o.focus(),document.body.createTextRange?((i=document.body.createTextRange()).moveToElementText(o),i.select()):window.getSelection&&(s=window.getSelection(),(i=document.createRange()).selectNodeContents(o),s.removeAllRanges(),s.addRange(i))}(0,this.id)}).call(t.drag().on("start",function(e,a){!function(e,a){t.event.sourceEvent.stopPropagation(),pr=!0,Ra(),qa=r.copyRoad(we);const n=a;if(null==Xa?er(n):null!=Xa&&Xa==n&&_a==r.RP.VALUE?or():(or(),er(n)),0!=n){const t=we[n];Ia(e.sta,[(t.sta[0]+t.end[0])/2,(t.sta[1]+t.end[1])/2,t.slope*be.siru])}else Ia(e.sta);Ka.grp.raise()}(e,Number(this.id))}).on("drag",function(e,a){!function(e,a){lr(),be.asof;const n=X.invert(t.event.y),l=a,o=we,i=we[l];i.end[1]=n,i.slope=r.segSlope(i),r.fixRoadArray(o,z.keepSlopes?r.RP.VALUE:r.RP.SLOPE,!1,r.RP.VALUE),Fa(0==l?0:l-1,!1),0!=l?ja(e.sta,[(i.sta[0]+i.end[0])/2,(i.sta[1]+i.end[1])/2,i.slope*be.siru]):ja(e.sta)}(e,Number(this.id))}).on("end",function(t,e){var a;a=Number(this.id),pr=!1,null==Xa&&(ar(a),Za(),ia()),qa=null}))):e.remove()}let Yr={};function Kr(t){let e="";const a=r.dotcolor(we,be,t[0],t[1],Re);return t[3]!=ae.DPTYPE.AGGPAST&&(e+=" fuda"),e+=Yr[a]}Yr[a.BHUE.GRADOT]=" gra",Yr[a.BHUE.GRNDOT]=" grn",Yr[a.BHUE.BLUDOT]=" blu",Yr[a.BHUE.ORNDOT]=" orn",Yr[a.BHUE.REDDOT]=" red",Yr[a.BHUE.BLCK]=" blk";var Vr,Ir,jr,Zr,Fr,qr,Jr=null,Wr=null;function Xr(t){const n=V(a.daysnap(t[0])*v),l=X(t[1]),o=(null!=t[7]?"#"+t[7]+": ":"")+e.unix(t[0]).utc().format("YYYY-MM-DD")+", "+(null!=t[6]?a.shn(t[6]):a.shn(t[1]));null!=Wr&&ca(Wr);const i=[];""!==t[2]&&i.push('"'+t[2]+'"'),null!==t[6]&&t[1]!==t[6]&&i.push("total:"+t[1]);var s=r.dotcolor(we,be,t[0],t[1],Re);Wr=sa(n,l-(15+18*i.length),o,s,i)}function _r(){ca(Wr)}function $r(e,a,r,n=null,l=!0){let o;null==n&&(n=r),(o=e.selectAll("."+r).data(a)).exit().remove(),o.attr("cx",function(t){return De(V(t[0]*v))}).attr("cy",function(t){return De(X(t[1]))}).attr("class",n);var i=o.enter().append("svg:circle");i.attr("class",n).attr("cx",function(t){return De(V(t[0]*v))}).attr("cy",function(t){return De(X(t[1]))}),z.headless||i.on("wheel",function(e){var a=new t.event.constructor(t.event.type,t.event);Yt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseenter",function(t){null!=z.divData&&z.dataAutoScroll&&null!=t[7]&&function(t){if(t=Ee.length-t-1,!Ce.node().offsetParent)return;Ye=t;const e=Math.floor(z.dataTableSize/2),a=Math.max(0,Math.min(t-e,Ee.length-z.dataTableSize));Oe=a,Ke(),na()}(t[7]),null!=Jr&&window.clearTimeout(Jr),Jr=window.setTimeout(function(){Xr(t),Jr=null},500)}).on("mouseout",function(){Ye=-1,na(),null!=Wr&&(_r(),Wr=null),window.clearTimeout(Jr),Jr=null})}function Qr(){if(!fe&&null!=z.divGraph&&!z.roadEditor){var t=[V.invert(0).getTime()/v,V.invert(R.width).getTime()/v],e=Et.selectAll(".rosy"),a=zt.selectAll(".rd");if(z.showData||!z.roadEditor)if(be.rosy){var r,n=(null!=ae.flad?ae.rosydata.slice(0,ae.rosydata.length-1):ae.rosydata).filter(function(e){return e[0]>=t[0]&&e[0]<=t[1]||e[4]>=t[0]&&e[4]<=t[1]});if(0==ae.rosydata.length){var l=-1;for(r=0;r<ae.rosydata.length-1;r++)if(ae.rosydata[r][0]<=t[0]&&ae.rosydata[r+1][0]>=t[1]){l=r;break}l>0&&(n=ae.rosydata.slice(l,l+2))}if(0!=n.length){let t="M"+De(V(n[0][4]*v))+" "+De(X(n[0][5]));for(r=0;r<n.length;r++)t+=" L"+De(V(n[r][0]*v))+" "+De(X(n[r][1]));e.empty()?Et.append("svg:path").attr("class","rosy").attr("d",t):e.attr("d",t)}else e.remove();$r(zt,n,"rd","rd",!0)}else e.remove(),a.remove();else e.remove(),a.remove()}}function tn(){if(fe||null==z.divGraph)return;const t=V.invert(0).getTime()/v,e=V.invert(R.width).getTime()/v,a=function(a){return a[0]>=t&&a[0]<=e||a[4]>=t&&a[4]<=e};let n=wt.selectAll(".steppy"),o=kt.selectAll(".std");if(z.showData||!z.roadEditor)if(!z.roadEditor&&be.steppy&&0!==te.length){const o=te.filter(a);let i;if(0===o.length){let a=-1;for(i=0;i<te.length-1;i++)if(te[i][0]<=t&&te[i+1][0]>=e){a=i;break}a>0&&(o=te.slice(a,a+2))}if(0!==o.length){let a;if(te[0][0]>t&&te[0][0]<e&&te[0][0]in ae.allvals){const t=ae.allvals[te[0][0]][0][1];a="M"+De(V(te[0][0]*v))+" "+De(X(t)),a+=" L"+De(V(o[0][4]*v))+" "+De(X(o[0][5]))}else a="M"+De(V(o[0][4]*v))+" "+De(X(o[0][5]));for(i=0;i<o.length;i++)l||(a+=" L"+De(V(o[i][0]*v))+" "+De(X(o[i][5]))),a+=" L"+De(V(o[i][0]*v))+" "+De(X(o[i][1]));n.empty()?wt.append("svg:path").attr("class","steppy").attr("d",a):n.attr("d",a);let s=wt.selectAll(".steppyppr");if(null!==ae.flad)if(be.yaw*be.dir<0&&be.asof!==be.tdat){const t=ae.flad[1]+r.ppr(we,be,be.asof);a="M"+De(V(o[o.length-1][0]*v))+" "+De(X(o[o.length-1][1])),a+=" L"+De(V(o[o.length-1][0]*v))+" "+De(X(t)),s.empty()?wt.append("svg:path").attr("class","steppyppr").attr("d",a):s.attr("d",a)}else s.remove();else s.remove()}else n.remove();$r(kt,ae.flad?o.slice(0,o.length-1):o,"std","std",!0)}else n.remove(),o.remove();else n.remove(),o.remove()}function en(){if(!fe&&null!=z.divGraph){var t,e=[V.invert(0).getTime()/v,V.invert(R.width).getTime()/v];if(z.showData||!z.roadEditor){var a=ae.derails.filter(function(t){return t[0]>=e[0]&&t[0]<=e[1]}),r=be.yaw>0?"#downarrow":"#uparrow";(t=Mt.selectAll(".derails").data(a)).exit().remove(),t.attr("transform",function(t){return"translate("+V(t[0]*v)+","+X(t[1])+"),scale("+z.dataPoint.fsize*se/24+")"}),t.enter().append("svg:use").attr("class","derails").attr("xlink:href",r).attr("transform",function(t){return"translate("+V(t[0]*v)+","+X(t[1])+"),scale("+z.dataPoint.fsize*se/24+")"})}else(t=Mt.selectAll(".derails")).remove()}}function an(){if(!fe&&null!=z.divGraph&&0!=we.length){var t=[V.invert(0).getTime()/v,V.invert(R.width).getTime()/v],e=function(e){return e[0]>=t[0]&&e[0]<=t[1]||e[4]>=t[0]&&e[4]<=t[1]};if(be.asof,z.showData||!z.roadEditor){var a=null!=ae.flad?te.slice(0,te.length-1):te;a=a.filter(e),be.plotall&&!z.roadEditor?$r(Dt,ee.filter(function(e){return e[0]>=t[0]&&e[0]<=t[1]}),"ap",t=>"ap"+Kr(t),!0):Dt.selectAll(".ap").remove(),z.roadEditor?$r(At,a.concat(ae.fuda),"dp",t=>"dp"+Kr(t),!0):($r(At,a.concat(ae.fuda),"dp",t=>"dp"+Kr(t),!0),$r(Pt,ae.hollow.filter(e),"hp",t=>"hp"+Kr(t),!0));var n=Bt.selectAll(".fladp");if(null!=ae.flad){const t=r.ppr(we,be,be.asof),e=ae.flad[1]+t,a=0==t?1:.5;n.empty()?Bt.append("svg:use").attr("class","fladp").attr("xlink:href","#rightarrow").attr("fill",r.dotcolor(we,be,ae.flad[0],e,Re)).attr("fill-opacity",a).attr("transform","translate("+V(ae.flad[0]*v)+","+X(e)+"),scale("+z.dataPoint.fsize*se/24+")").style("pointer-events",function(){return z.roadEditor?"none":"all"}).on("mouseenter",function(){null!=Jr&&window.clearTimeout(Jr),Jr=window.setTimeout(function(){Xr(ae.flad),Jr=null},500)}).on("mouseout",function(){null!=Wr&&(_r(),Wr=null),window.clearTimeout(Jr),Jr=null}):n.attr("fill",r.dotcolor(we,be,ae.flad[0],e,Re)).attr("fill-opacity",a).attr("transform","translate("+V(ae.flad[0]*v)+","+X(e)+"),scale("+z.dataPoint.fsize*se/24+")")}else n.empty()||n.remove()}else At.selectAll(".dp").remove(),(n=At.selectAll(".fladp")).remove()}}function rn(){if(!fe){var t=Tt.selectAll(".movingav");if(!z.roadEditor&&be.movingav&&z.showData){var e=[V.invert(0).getTime()/v,V.invert(R.width).getTime()/v],r=be.filtpts.filter(function(t){return t[0]>e[0]-2*f&&t[0]<e[1]+2*f});if(r.length>0){var n="M"+De(V(r[0][0]*v))+" "+De(X(r[0][1]));for(let t=1;t<r.length;t++)n+=" L"+De(V(r[t][0]*v))+" "+De(X(r[t][1]));t.empty()?Tt.append("svg:path").attr("class","movingav").attr("d",n).style("fill","none").attr("stroke-width",Ae(3*se)).style("stroke",a.BHUE.PURP):t.attr("d",n).attr("stroke-width",Ae(3*se))}else t.remove()}else t.remove()}}function nn(){t.select(z.divTable).attr("class","bmndrroad"),Vr=t.select(z.divTable).select(".rtbmain"),Ir=t.select(z.divTable).select(".rtable"),jr=Ir.append("div").attr("class","roadbody")}const ln=["dt","vl","sl"];function on(){var e,a;z.roadEditor?(e=["","Start Date","Value","",""],a=["","End Date","Value","Daily Slope",""]):(e=["","Start Date","Value",""],a=["","End Date","Value","Daily Slope"]),(Zr=t.select(z.divTable).select(".rtbstart")).append("div").attr("class","roadhdr").append("div").attr("class","roadhdrrow").selectAll("span.rdhdrcell").data(e).enter().append("span").attr("class",(t,e)=>"rdhdrcell "+ln[e]).text(t=>t),Fr=Zr.append("div").attr("class","roadbody"),(qr=Zr.append("div").attr("class","roadhdr")).append("div").attr("class","roadhdrrow").selectAll("span.rdhdrcell").data(a).enter().append("span").attr("class",(t,e)=>"rdhdrcell "+ln[e]).text(t=>t)}var sn,dn;function cn(){var e;e=z.roadEditor?["","Goal Date","Value","Daily Slope","",""]:["","Goal Date","Value","Daily Slope"],(sn=t.select(z.divTable).select(".rtbgoal")).append("div").attr("class","roadhdr").append("div").attr("class","roadhdrrow").selectAll("span.rdhdrcell").data(e).enter().append("span").attr("class",(t,e)=>"rdhdrcell "+ln[e]).text(t=>t),dn=sn.append("div").attr("class","roadbody")}let un=null;function pn(){null!=un&&(un.picker&&un.picker.destroy(),un=null)}function fn(t,r,n,l,o){console.log("createDatePicker()"+r),pn(),un={min:r,max:n,flt:l,tl:o,fld:t,oldText:t.text()},k()&&(t.attr("contenteditable",!1),setTimeout(function(){t.attr("contenteditable",!0)},100));let i=e(un.oldText);un.picker=new Pikaday({keyboardInput:!1,onSelect:function(t){var e=un.picker.toString(),r=a.dayparse(e,"-");e!==un.oldText&&(isNaN(r)||(un.fld.text(e),un.oldText=e,pn(),document.activeElement.blur()))},minDate:r,maxDate:n}),un.picker.setMoment(i);var s=t.node().getBoundingClientRect(),d=o.node().getBoundingClientRect();l.style("left",s.right-d.left+"px").style("top",s.bottom+3-d.top+"px"),l.node().appendChild(un.picker.el,t.node())}let hn={field:null,oldText:null};function gn(a,r){if(z.roadEditor){console.debug("tableFocusIn("+r+") for "+this.parentNode.id),hn.field=t.select(this),hn.oldText=hn.field.text(),pn();var n=Number(hn.field.node().parentNode.id);if(null!=Xa&&or(),0==r){Qa(n,!1);var l=0==n?be.xMin-10*f*p:we[n].sta[0],o=n==we.length-1?we[n].end[0]:we[n+1].end[0],i=e(e.unix(l).utc().format("YYYY-MM-DD")),s=e(e.unix(o).utc().format("YYYY-MM-DD")),d=t.select(z.divTable).select(".floating");fn(hn.field,i.toDate(),s.toDate(),d,qt)}else 1==r?er(n,!1):2==r&&rr(n,!1)}}function mn(e,r){if(!z.roadEditor)return;let n=Number(this.parentNode.id),l=t.select(this).text();if(pn(),or(),l===hn.oldText)return;if(null==hn.oldText)return;let o=0==r?a.dayparse(l,"-"):l;if(isNaN(o))return t.select(this).text(hn.oldText),hn.oldText=null,void(hn.field=null);0==r&&(vn(n,o),or()),1==r&&(bn(n,o),or()),2==r&&(wn(n,o),or()),hn.oldText=null,hn.field=null}function yn(e,r){if(13==t.event.keyCode){window.getSelection().removeAllRanges();var n=t.select(this).text(),l=0==r?a.dayparse(n,"-"):n;if(isNaN(l))return t.select(this).text(hn.oldText),void(hn.oldText=null);0==r&&vn(Number(this.parentNode.id),l),1==r&&bn(Number(this.parentNode.id),l),2==r&&wn(Number(this.parentNode.id),l),hn.oldText=t.select(this).text()}}function xn(e,a){var n=Number(this.parentNode.id);z.roadEditor&&a==we[n].auto&&(0==a?Rn(n):1==a?Mn(n):2==a&&function(e){we[e].auto=r.RP.DATE;var a=t.select(z.divTable);a.select(".roadrow [name=enddate"+e+"]").style("color",z.roadTableCol.textDisabled).style("background-color",z.roadTableCol.bgDisabled).attr("contenteditable",!1),a.select(".roadrow [name=endvalue"+e+"]").style("color",z.roadTableCol.text).style("background-color",z.roadTableCol.bg).attr("contenteditable",z.roadEditor),a.select(".roadrow [name=slope"+e+"]").style("color",z.roadTableCol.text).style("background-color",z.roadTableCol.bg).attr("contenteditable",z.roadEditor),a.select(".roadrow [name=btndate"+e+"]").property("checked",!0),a.select(".roadrow [name=btnvalue"+e+"]").property("checked",!1),a.select(".roadrow [name=btnslope"+e+"]").property("checked",!1)}(n),this.focus())}function vn(t,e){isNaN(e)?Bn():function(t,e,n=!0){Ra();const l=0==t?be.xMin-10*f*p:we[t].sta[0]+.01,o=t==we.length-1?we[t].end[0]+.01:we[t+1].end[0]+.01;e<=l&&(e=a.daysnap(l)),e>=o&&(e=a.daysnap(l)),we[t].end[0]=e,r.fixRoadArray(we,null,n,r.RP.DATE),ia()}(t,Number(e),!0)}function bn(t,e){isNaN(e)?Bn():function(t,e,a=!1){Ra(),we[t].end[1]=e,a||(z.keepSlopes||(we[t].slope=r.segSlope(we[t])),1==t?we[t-1].sta[1]=e:t==we.length-1?(we[t].end[1]=e,we[t-1].slope=(we[t].sta[1]-we[t-1].sta[1])/(we[t].sta[0]-we[t-1].sta[0])):we[t-1].slope=(we[t].sta[1]-we[t-1].sta[1])/(we[t].sta[0]-we[t-1].sta[0])),r.fixRoadArray(we,z.keepSlopes?r.RP.VALUE:null,a,r.RP.VALUE),ia()}(t,Number(e),!0)}function wn(t,e){isNaN(e)?Bn():function(t,e,a=!1){t!=we.length-1&&(Ra(),we[t].slope=e/be.siru,a||z.keepSlopes||(we[t].end[1]=we[t].sta[1]+we[t].slope*(we[t].end[0]-we[t].sta[0]),we[t+1].sta[1]=we[t].end[1],we[t+1].slope=r.segSlope(we[t+1])),r.fixRoadArray(we,null,a,r.RP.SLOPE),ia())}(t,Number(e),!0)}function kn(t,e=!0){if(z.tableAutoScroll&&null==Xa&&0!==z.tableHeight){let a=t.node().parentNode.getBoundingClientRect();if(0==a.height)return;let r=t.data(),n=a.height+1,l=r[0].i-1,o=l*n;if(null!=z.divTable){let t=Vr.node(),a=(l-Math.floor(t.scrollTop/n))*n;(e||a<0||a-n>z.tableHeight)&&(t.scrollTop=o-z.tableHeight/2)}}}function En(e,a,r=!0){if(null==z.divTable)return;let n=a?z.roadTableCol.bgHighlight:0==we[e].auto?z.roadTableCol.bgDisabled:z.roadTableCol.bg,l=t.select(z.divTable).select(".roadrow [name=enddate"+e+"]");l.empty()||(l.style("background-color",n),r&&a&&kn(l))}function zn(e,a,r=!0){if(null!=z.divTable){var n=a?z.roadTableCol.bgHighlight:1==we[e].auto?z.roadTableCol.bgDisabled:z.roadTableCol.bg,l=t.select(z.divTable).select(".roadrow [name=endvalue"+e+"]");l.empty()||(l.style("background-color",n),r&&a&&kn(l))}}function Tn(e,a,r=!0){if(null!=z.divTable){var n=a?z.roadTableCol.bgHighlight:2==we[e].auto?z.roadTableCol.bgDisabled:z.roadTableCol.bg,l=t.select(z.divTable).select(".roadrow [name=slope"+e+"]");l.empty()||(l.style("background-color",n),r&&a&&kn(l))}}function Rn(e){we[e].auto=r.RP.VALUE;var a=t.select(z.divTable);a.select(".roadrow [name=enddate"+e+"]").style("color",z.roadTableCol.text).style("background-color",z.roadTableCol.bg).attr("contenteditable",z.roadEditor),a.select(".roadrow [name=endvalue"+e+"]").style("color",z.roadTableCol.textDisabled).style("background-color",z.roadTableCol.bgDisabled).attr("contenteditable",!1),a.select(".roadrow [name=slope"+e+"]").style("color",z.roadTableCol.text).style("background-color",z.roadTableCol.bg).attr("contenteditable",z.roadEditor),a.select(".roadrow [name=btndate"+e+"]").property("checked",!1),a.select(".roadrow [name=btnvalue"+e+"]").property("checked",!0),a.select(".roadrow [name=btnslope"+e+"]").property("checked",!1)}function Mn(e){we[e].auto=r.RP.SLOPE;var a=t.select(z.divTable);a.select(".roadrow [name=enddate"+e+"]").style("color",z.roadTableCol.text).style("background-color",z.roadTableCol.bg).attr("contenteditable",z.roadEditor),a.select(".roadrow [name=endvalue"+e+"]").style("color",z.roadTableCol.text).style("background-color",z.roadTableCol.bg).attr("contenteditable",z.roadEditor),a.select(".roadrow [name=slope"+e+"]").style("color",z.roadTableCol.textDisabled).style("background-color",z.roadTableCol.bgDisabled).attr("contenteditable",!1),a.select(".roadrow [name=btndate"+e+"]").property("checked",!1),a.select(".roadrow [name=btnvalue"+e+"]").property("checked",!1),a.select(".roadrow [name=btnslope"+e+"]").property("checked",!0)}function Dn(){if(null!=z.divTable){var e=t.select(z.divTable).selectAll(".rtbstart .roadrow, .rtable .roadrow, .rtbgoal .roadrow"),a=e.selectAll(".rdbtn").data(function(t,e){var a;return[{order:8,row:a=z.reverseTable?we.length-2-e:e,name:"btndel"+a,evt:()=>Oa(a,!0),type:"button",txt:'<img class="ricon" src="../src/trash.svg" ></img>',auto:!1},{order:9,row:a,name:"btnadd"+a,evt:()=>(function(t){if(t<we.length-1){let e=(we[t].sta[0]+we[t+1].sta[0])/2;e-we[t].sta[0]>30*f&&(e=we[t].sta[0]+30*f),Ha(e)}else Ha(we[t].sta[0]+7*f)})(a+1),type:"button",txt:'<img class="ricon" src="../src/plus.svg"></img>',auto:!1}]});a.enter().append("button").attr("class",t=>"rdbtn "+t.txt).attr("id",t=>t.row).attr("name",t=>t.name).html(t=>t.txt).on("click",t=>t.evt()),a.exit().remove(),(a=e.selectAll(".rtbstart .rdbtn, .rtable .rdbtn, .rtbgoal .rdbtn")).attr("id",t=>t.row).attr("name",t=>t.name).style("display",(t,e)=>Number(t.row)>0&&Number(t.row)<we.length-2||4==e||e>0&&Number(t.row)>0?null:"none"),e.selectAll(".rdcell, .rdbtn").sort((e,a)=>t.ascending(e.order,a.order)),z.roadEditor||e.selectAll(".rdbtn").style("display","none").attr("value","")}}function An(t,e,n,l){var o=we.slice(e,n);l&&(o=o.reverse());var i=t.selectAll(".roadrow").data(o),s=t=>l?we.length-2-t:t;i.enter().append("div").attr("class","roadrow").attr("name",(t,a)=>"roadrow"+s(e+a)).attr("id",(t,a)=>s(e+a)).append("div").attr("class","rowid").text((t,a)=>s(e+a)+":"),i.exit().remove(),i.order(),(i=t.selectAll(".roadrow")).attr("name",(t,a)=>"roadrow"+s(e+a)).attr("id",(t,a)=>s(e+a)),i.select("div").text((t,a)=>s(e+a)+":");var d=i.selectAll(".rdcell").data((t,n)=>{var l=a.dayify(t.end[0],"-"),o=s(e+n);return[{order:2,value:l,name:"enddate"+o,auto:t.auto==r.RP.DATE,i:o},{order:4,value:a.shn(t.end[1]),name:"endvalue"+o,auto:t.auto==r.RP.VALUE,i:o},{order:6,value:isNaN(t.slope)?"duplicate":a.shn(t.slope*be.siru),name:"slope"+o,auto:t.auto==r.RP.SLOPE,i:o}]});d.enter().append("div").attr("class",(t,e)=>"rdcell "+ln[e]).attr("name",t=>t.name).attr("contenteditable",(t,e)=>t.auto||!z.roadEditor?"false":"true").on("click",xn).on("focusin",gn).on("focusout",mn).on("keydown",yn),d.exit().remove(),(d=i.selectAll(".rdcell")).text((t,e)=>t.value).attr("name",t=>t.name).style("color",t=>we[t.i].sta[0]==we[t.i].end[0]&&we[t.i].sta[1]==we[t.i].end[1]?z.roadLineCol.invalid:t.auto?z.roadTableCol.textDisabled:z.roadTableCol.text).style("background-color",function(t){return t.auto?z.roadTableCol.bgDisabled:z.roadTableCol.bg}).attr("contenteditable",function(t,e){return t.auto||!z.roadEditor?"false":"true"})}function Pn(){if(null!=z.divTable&&!ge)if(we.length>3){if(!jr.node().offsetParent)return;t.select(z.divTable).style("width",jr.node().offsetWidth+35+"px")}else{if(!dn.node().offsetParent)return;t.select(z.divTable).style("width",dn.node().offsetWidth+35+"px")}}function Bn(){if(null!=z.divTable){var e=z.reverseTable;An(Fr,0,1,!1),Fr.select("[name=slope0]").style("visibility","hidden").style("pointer-events","none").style("border","1px solid transparent"),An(jr,1,we.length-2,e),An(dn,we.length-2,we.length-1,!1),we.length<=3?(qr.style("visibility","collapse"),t.select(z.divTable).select(".rtbmain").style("display","none")):(qr.style("visibility",null),t.select(z.divTable).select(".rtbmain").style("display",null)),Pn()}}function Ln(){Bn(),Dn(),Pn()}function Sn(){null!=z.divGraph&&(z.showContext?(H.attr("visibility","visible"),function(){if(fe||null==z.divGraph||0==we.length)return;const t=Y.selectAll(".ctxoldroads");let e=xe;z.roadEditor||(e=we);let r="M"+De(at(e[0].sta[0]*v))+" "+De(lt(e[0].sta[1]));for(let t=0;t<e.length;t++)r+=" L"+De(at(e[t].end[0]*v))+" "+De(lt(e[t].end[1]));t.empty()?Y.append("svg:path").attr("class","ctxoldroads").attr("d",r).style("stroke-dasharray",z.roadEditor?z.oldRoadLine.ctxdash+","+c(z.oldRoadLine.ctxdash/2):null).style("fill","none").style("stroke-width",z.oldRoadLine.ctxwidth).style("stroke",z.roadEditor?a.BHUE.ORNG:a.BHUE.RAZR0):t.attr("d",r).style("stroke-dasharray",z.roadEditor?z.oldRoadLine.ctxdash+","+c(z.oldRoadLine.ctxdash/2):null).style("stroke",z.roadEditor?a.BHUE.ORNG:a.BHUE.RAZR0)}(),function(){if(!fe&&null!=z.divGraph&&0!=we.length){var t=Y.select(".ctxoldbullseye");if(z.roadEditor){null==Xt&&vr();var e=at(xe[xe.length-1].sta[0]*v),a=lt(xe[xe.length-1].sta[1]);t.empty()?Y.append("svg:use").attr("xlink:href","#beyepre").attr("class","ctxoldbullseye").attr("x",e).attr("y",a).attr("transform","scale(0.16) translate(-40,-60)").attr("transform-origin",e+" "+a):t.attr("x",e).attr("y",a).attr("transform-origin",e+" "+a)}else t.remove()}}(),wr(),function(){if(fe||null==z.divGraph||0==we.length)return;const t=Ma(we)?z.roadLineCol.valid:z.roadLineCol.invalid,e=Y.selectAll(".ctxroads").data(we);z.roadEditor?(e.exit().remove(),e.attr("x1",function(t){return at(t.sta[0]*v)}).attr("y1",function(t){return lt(t.sta[1])}).attr("x2",function(t){return at(t.end[0]*v)}).attr("y2",function(t){return lt(t.end[1])}).style("stroke",t),e.enter().append("svg:line").attr("class","ctxroads").attr("id",function(t,e){return e}).attr("name",function(t,e){return"ctxroad"+e}).attr("x1",function(t){return at(t.sta[0]*v)}).attr("y1",function(t){return lt(t.sta[1])}).attr("x2",function(t){return at(t.end[0]*v)}).attr("y2",function(t){return lt(t.end[1])}).style("stroke",t).style("stroke-width",z.roadLine.ctxwidth)):e.remove()}(),function(){if(fe||null==z.divGraph)return;const t=Y.selectAll(".ctxdots").data(we);z.roadEditor?(t.exit().remove(),t.attr("cx",function(t){return De(at(t.sta[0]*v))}).attr("cy",function(t){return De(lt(t.sta[1]))}),t.enter().append("svg:circle").attr("class","ctxdots").attr("r",Ae(z.roadDot.ctxsize)).attr("fill",z.roadDotCol.editable).style("stroke-width",z.roadDot.ctxborder).attr("cx",function(t){return De(at(t.sta[0]*v))}).attr("cy",function(t){return De(lt(t.sta[1]))})):t.remove()}(),function(){if(fe||null==z.divGraph||0==we.length)return;const t=Y.select(".ctxhorizon"),e=z.horizon;t.empty()?Y.append("svg:line").attr("class","ctxhorizon").attr("x1",at(be.horizon*v)).attr("y1",lt(be.yMin-5*(be.yMax-be.yMin))).attr("x2",at(be.horizon*v)).attr("y2",lt(be.yMax+5*(be.yMax-be.yMin))).style("stroke",a.BHUE.AKRA).style("stroke-dasharray",e.ctxdash+","+e.ctxdash).style("stroke-width",Ae(e.ctxwidth)):t.attr("x1",at(be.horizon*v)).attr("y1",lt(be.yMin-5*(be.yMax-be.yMin))).attr("x2",at(be.horizon*v)).attr("y2",lt(be.yMax+5*(be.yMax-be.yMin)));const r=at(be.horizon*v)+12,n=M.height/2,l=Y.select(".ctxhortext");l.empty()?Y.append("svg:text").attr("class","ctxhortext").attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")").attr("fill",a.BHUE.AKRA).style("font-size",e.ctxfont+"px").text("Horizon"):l.attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")")}(),function(){if(fe||null==z.divGraph||0==we.length)return;const t=Y.select(".ctxtoday"),e=Y.select(".ctxtodaytext");if(!z.roadEditor)return t.remove(),void e.remove();t.empty()?Y.append("svg:line").attr("class","ctxtoday").attr("x1",at(be.asof*v)).attr("y1",0).attr("x2",at(be.asof*v)).attr("y2",M.height).style("stroke","rgb(0,0,200)").style("stroke-width",Ae(z.horizon.ctxwidth)):t.attr("x1",at(be.asof*v)).attr("y1",0).attr("x2",at(be.asof*v)).attr("y2",M.height);const a=at(be.asof*v)-5,r=M.height/2;e.empty()?Y.append("svg:text").attr("class","ctxtodaytext").attr("x",a).attr("y",r).attr("transform","rotate(-90,"+a+","+r+")").attr("fill","rgb(0,0,200)").style("font-size",z.today.ctxfont+"px").text("Today"):e.attr("x",a).attr("y",r).attr("transform","rotate(-90,"+a+","+r+")")}(),z.showFocusRect?Ft.attr("visibility","visible"):Ft.attr("visibility","hidden")):(H.attr("visibility","hidden"),Ft.attr("visibility","hidden")))}function Un(n=!1){if(null==z.divGraph)return;or();const l=[V.invert(0).getTime()/v,V.invert(R.width).getTime()/v];var o;n&&(de=0),(se=z.roadEditor?a.clip(a.rescale(l[1],l[0],l[0]+73*f,1,.7),.7,1):a.clip(a.rescale(l[1],l[0],l[0]+73*f,1,.55),.55,1))!=de&&function(){let e="",r="#svg"+T+" ",n="pointer-events:"+(z.headless?"none;":"all;");e+=r+".rd {r:"+Ae(z.dataPoint.size*se)+"px} ",e+=r+".std {r:"+Ae((z.dataPoint.size+2)*se)+"px} ",e+=r+".ap {r:"+Ae(.7*z.dataPoint.size*se)+"px;"+n+"} ",e+=r+".hp {r:"+Ae(z.dataPoint.hsize*se)+"px;"+n+"} ",e+=r+".guides {stroke-width:"+Ae(z.guidelines.width*se)+"px} ",e+=r+".rosy {stroke-width:"+Ae(4*se)+"px} ",e+=r+".steppy {stroke-width:"+Ae(4*se)+"px} ",e+=r+".steppyppr {stroke-width:"+Ae(4*se)+"px} ",e+=r+".maxflux {fill:none;stroke:"+a.BHUE.BIGG+";stroke-width:"+Ae(z.maxfluxline*se)+"px} ",e+=r+".stdflux {fill:none;stroke:"+a.BHUE.BIGG+";stroke-width:"+Ae(z.stdfluxline*se)+"px} ",e+=r+".axis text {font-size:"+z.axis.font+"px;} ",e+=r+".axislabel {font-size:"+z.axis.font+"px;} ",z.roadEditor?(e+=r+".dp {r:"+Ae(z.dataPoint.size*se)+"px;stroke:"+z.dataPointCol.stroke+";stroke-width:"+Ae(z.dataPoint.border*se)+"px} ",e+=r+".razr {fill:none;pointer-events:none;stroke-width:"+Ae(z.razrline*se)+"px;stroke:"+a.BHUE.RAZR0+"} "):(e+=r+".dp {r:"+Ae(z.dataPoint.size*se)+"px;stroke:rgb(0,0,0);stroke-width:"+Ae(1*se)+"px} ",e+=r+".dp.fuda {stroke-width:"+Ae(.5*se)+"px} ",e+=r+".razr {fill:none;pointer-events:none;stroke-width:"+Ae(z.razrline*se)+"px;stroke:"+a.BHUE.REDDOT+"} "),t.select("style#dynstyle"+T).text(e)}(),Hr(),kr(),function(){if(fe||null==z.divGraph||0==we.length)return;const t=ot.select(".past");z.roadEditor?t.empty()?ot.insert("svg:rect",":first-child").attr("class","past").attr("x",V(be.xMin)).attr("y",X(be.yMax+3*(be.yMax-be.yMin))).attr("width",V(be.asof*v)-V(be.xMin)).attr("height",7*s(X(be.yMin)-X(be.yMax))).attr("fill",z.pastBoxCol.fill).attr("fill-opacity",z.pastBoxCol.opacity):t.attr("x",V(be.xMin)).attr("y",X(be.yMax+3*(be.yMax-be.yMin))).attr("width",V(be.asof*v)-V(be.xMin)).attr("height",7*s(X(be.yMin)-X(be.yMax))):t.remove()}(),zr(),Tr(),Lr(),fe||null==z.divGraph||0==we.length||(z.roadEditor?Rr(xe,ve,xt,"razr",0,!0):Rr(we,be,xt,"razr",0,!1)),Sr(),Ur(),function(){if(!fe&&null!=z.divGraph&&0!=we.length){var t=vt.select(".oldbullseye");if(z.roadEditor){null==Xt&&vr();var e=V(ve.tfin*v),a=X(r.rdf(xe,ve.tfin));t.empty()?vt.append("svg:use").attr("xlink:href","#beyepre").attr("class","oldbullseye").attr("x",e).attr("y",a).attr("transform","scale(0.33) translate(-40,-60)").attr("transform-origin",e+" "+a):t.attr("x",e).attr("y",a).attr("transform-origin",e+" "+a)}else t.remove()}}(),br(),Cr(),an(),en(),Qr(),tn(),fe||null==z.divGraph||((o=Nt.selectAll(".hashtag").data(ae.hashtags)).exit().remove(),o.attr("x",function(t){return V(t[0]*v)}).attr("transform",t=>"rotate(-90,"+V(t[0]*v)+","+R.height/2+")").text(t=>t[1]),o.enter().append("svg:text").attr("class","hashtag").attr("x",t=>V(t[0]*v)).attr("y",R.height/2).attr("transform",t=>"rotate(-90,"+V(t[0]*v)+","+R.height/2+")").attr("fill",a.BHUE.BLACK).style("font-size",z.horizon.font+"px").text(t=>t[1])),rn(),Nr(),Or(),function(){if(fe||null==z.divGraph||0==we.length)return;const t=Gt.select(".horizon"),e=z.horizon;t.empty()?Gt.append("svg:line").attr("class","horizon").attr("x1",V(be.horizon*v)).attr("y1",0).attr("x2",V(be.horizon*v)).attr("y2",R.height).style("stroke",a.BHUE.AKRA).style("stroke-dasharray",e.dash+","+e.dash).attr("stroke-width",Ae(e.width*se)):t.attr("x1",V(be.horizon*v)).attr("y1",0).attr("x2",V(be.horizon*v)).attr("y2",R.height).attr("stroke-width",Ae(e.width*se));const r=V(be.horizon*v)+14,n=R.height/2,l=Ht.select(".horizontext");l.empty()?Ht.append("svg:text").attr("class","horizontext").attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")").attr("fill",a.BHUE.AKRA).style("font-size",e.font+"px").text("Akrasia Horizon"):l.attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")")}(),function(){if(fe||null==z.divGraph||0==we.length||0==ae.oresets.length)return;const t=ft.selectAll(".oresets").data(ae.oresets);z.roadEditor?t.remove():(t.exit().remove(),t.attr("x1",function(t){return V(t*v)}).attr("y1",0).attr("x2",function(t){return V(t*v)}).attr("y2",R.height),t.enter().append("svg:line").attr("class","oresets").attr("id",function(t,e){return e}).attr("name",function(t,e){return"oreset"+e}).attr("x1",function(t){return V(t*v)}).attr("y1",0).attr("x2",function(t){return V(t*v)}).attr("y2",R.height).attr("stroke","rgb(200,200,200)").style("stroke-dasharray",z.odomReset.dash+","+z.odomReset.dash).attr("stroke-width",z.odomReset.width))}(),function(){if(fe||null==z.divGraph||0==we.length)return;const t=pt.select(".pastline"),r=ht.select(".pasttext");if(!z.roadEditor)return t.remove(),void r.remove();t.empty()?pt.append("svg:line").attr("class","pastline").attr("x1",V(be.asof*v)).attr("y1",0).attr("x2",V(be.asof*v)).attr("y2",R.height).style("stroke",a.BHUE.AKRA).style("stroke-width",Ae(z.today.width)):t.attr("x1",V(be.asof*v)).attr("y1",0).attr("x2",V(be.asof*v)).attr("y2",R.height);const n=V(be.asof*v)-8,l=R.height/2;r.empty()?ht.append("svg:text").attr("class","pasttext").attr("x",n).attr("y",l).attr("transform","rotate(-90,"+n+","+l+")").attr("fill",a.BHUE.AKRA).style("font-size",z.horizon.font+"px").text("Today ("+e.unix(be.asof).utc().format("ddd")+")"):r.attr("x",n).attr("y",l).attr("transform","rotate(-90,"+n+","+l+")").text("Today ("+e.unix(be.asof).utc().format("ddd")+")")}(),Er(),Yt.attr("color",r.dotcolor(we,be,be.tcur,be.vcur,Re)),de=se}!function(){const e=z.divGraph;if(null===e)return;for(;e.firstChild;)e.removeChild(e.firstChild);B=t.select(e).attr("class","bmndrgraph").append("svg:svg").attr("id","svg"+T).attr("xmlns","http://www.w3.org/2000/svg").attr("xmlns:xlink","http://www.w3.org/1999/xlink").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+ne+" "+le).attr("width","100%").attr("height","100%").attr("class","bmndrsvg"),(L=B.append("defs")).insert("style").attr("type","text/css").text(y),L.insert("style").attr("id","dynstyle"+T).attr("type","text/css").text(""),L.append("clipPath").attr("id","plotclip"+T).append("rect").attr("x",0).attr("y",0).attr("width",R.width).attr("height",R.height),L.append("clipPath").attr("id","brushclip"+T).append("rect").attr("x",0).attr("y",0).attr("width",M.width).attr("height",M.height),L.append("clipPath").attr("id","buttonareaclip"+T).append("rect").attr("x",R.x).attr("y",0).attr("width",R.width).attr("height",D.top),L.append("path").style("stroke","none").attr("id","rightarrow").attr("d","M 55,0 -35,45 -35,-45 z"),L.append("path").style("stroke","none").attr("id","downarrow").attr("d","M 0,40 45,-50 -45,-50 z"),L.append("path").style("stroke","none").attr("id","uparrow").attr("d","M 0,-40 45,50 -45,50 z"),(ct=L.append("pattern").attr("id","pinkzonepat"+T).attr("x",0).attr("y",0).attr("width",10).attr("height",10).attr("patternTransform","rotate(45)").attr("patternUnits","userSpaceOnUse")).append("rect").attr("x",0).attr("y",0).attr("width",10).attr("height",10).attr("fill",a.BHUE.PINK),ct.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",10).style("stroke","#aaaaaa").style("stroke-width",1),(ut=L.append("pattern").attr("id","tapepat"+T).attr("x",0).attr("y",0).attr("width",20).attr("height",20).attr("patternTransform","rotate(45)").attr("patternUnits","userSpaceOnUse")).append("rect").attr("x",0).attr("y",0).attr("width",20).attr("height",20).attr("fill","#ffffff"),ut.append("line").attr("x1",0).attr("y1",0).attr("x2",20).attr("y2",0).style("stroke","#ff5555").style("stroke-width",25);const r=L.append("g").attr("id","removebutton");r.append("circle").attr("cx",14).attr("cy",14).attr("r",16).attr("fill","white"),r.append("path").attr("d","M13.98,0C6.259,0,0,6.261,0,13.983c0,7.721,6.259,13.982,13.98,13.982c7.725,0,13.985-6.262,13.985-13.982C27.965,6.261,21.705,0,13.98,0z M19.992,17.769l-2.227,2.224c0,0-3.523-3.78-3.786-3.78c-0.259,0-3.783,3.78-3.783,3.78l-2.228-2.224c0,0,3.784-3.472,3.784-3.781c0-0.314-3.784-3.787-3.784-3.787l2.228-2.229c0,0,3.553,3.782,3.783,3.782c0.232,0,3.786-3.782,3.786-3.782l2.227,2.229c0,0-3.785,3.523-3.785,3.787C16.207,14.239,19.992,17.769,19.992,17.769z");const n=L.append("g").attr("id","zoominbtn");!z.headless&&z.buttonZoom&&(n.append("path").style("fill","white").attr("d","m 530.86356,264.94116 a 264.05649,261.30591 0 1 1 -528.1129802,0 264.05649,261.30591 0 1 1 528.1129802,0 z"),n.append("path").attr("d","m 308.21,155.10302 -76.553,0 0,76.552 -76.552,0 0,76.553 76.552,0 0,76.552 76.553,0 0,-76.552 76.552,0 0,-76.553 -76.552,0 z m 229.659,114.829 C 537.869,119.51007 420.50428,1.9980234 269.935,1.9980234 121.959,1.9980234 2.0000001,121.95602 2.0000001,269.93202 c 0,147.976 117.2473599,267.934 267.9339999,267.934 150.68664,0 267.935,-117.51205 267.935,-267.934 z m -267.935,191.381 c -105.681,0 -191.381,-85.7 -191.381,-191.381 0,-105.681 85.701,-191.380996 191.381,-191.380996 105.681,0 191.381,85.700996 191.381,191.380996 0,105.681 -85.7,191.381 -191.381,191.381 z"));const l=L.append("g").attr("id","zoomoutbtn");!z.headless&&z.buttonZoom&&(l.append("path").style("fill","white").attr("d","m 530.86356,264.94116 a 264.05649,261.30591 0 1 1 -528.1129802,0 264.05649,261.30591 0 1 1 528.1129802,0 z"),l.append("path").attr("d","m 155.105,231.65502 0,76.553 229.657,0 0,-76.553 c -76.55233,0 -153.10467,0 -229.657,0 z m 382.764,38.277 C 537.869,119.51007 420.50428,1.9980234 269.935,1.9980234 121.959,1.9980234 2.0000001,121.95602 2.0000001,269.93202 c 0,147.976 117.2473599,267.934 267.9339999,267.934 150.68664,0 267.935,-117.51205 267.935,-267.934 z m -267.935,191.381 c -105.681,0 -191.381,-85.7 -191.381,-191.381 0,-105.681 85.701,-191.380996 191.381,-191.380996 105.681,0 191.381,85.700996 191.381,191.380996 0,105.681 -85.7,191.381 -191.381,191.381 z")),(Yt=B.append("rect").attr("class","zoomarea").attr("x",R.x).attr("y",R.y).attr("color",a.BHUE.REDDOT).attr("width",R.width).attr("height",R.height)).on("wheel.scroll");const o={shown:!1,timeout:null};if(Yt.on("wheel.scroll",function(){if(null!=o.timeout&&(clearTimeout(o.timeout),o.timeout=null),t.event.ctrlKey)return Se("zoominfo",!0,G),void(o.shown=!1);o.shown||(Le(["Use ctrl+scroll to zoom"],-1,"normal",{x:0,y:0,w:R.width,h:R.height},"zoominfo",!1,!0,G),o.shown=!0),o.timeout=setTimeout(()=>{Se("zoominfo",!0),o.shown=!1},1e3)},{passive:!1}),Yt.on("mousedown.move",function(){null!=o.timeout&&(clearTimeout(o.timeout),o.timeout=null),Se("zoominfo",!0),o.shown=!1}),Kt=t.zoom().extent([[0,0],[R.width,R.height]]).scaleExtent([1,1/0]).translateExtent([[0,0],[R.width,R.height]]).filter(function(){return"wheel"!=t.event.type||t.event.ctrlKey}).on("zoom",wa),Yt.call(Kt),k()){let e,a=null;const r=Yt.on("touchstart.zoom"),n=Yt.on("touchmove.zoom"),l=Yt.on("touchend.zoom");Yt.on("touchstart.zoom",function(){const n=this.getBoundingClientRect();e=t.event.touches.item(0).pageX-n.left;const l=V.invert(e);null==a&&1==t.event.touches.length&&(a=window.setTimeout(()=>{null!=l&&Ha(l/v)},1e3)),r.apply(this,arguments)}).on("touchmove.zoom",function(){window.clearTimeout(a),a=null,n.apply(this,arguments)}).on("touchend.zoom",function(){clearTimeout(a),a=null,l.apply(this,arguments)})}function i(){const e=t.mouse(B.node());Ha(V.invert(e[0]-D.left)/v)}z.roadEditor?(Yt.on("click",function(){t.event.shiftKey?i():or()}),Yt.on("dblclick.zoom",i)):Yt.on("dblclick.zoom",null),C=B.append("g").attr("class","focus").attr("transform","translate("+z.focusRect.x+","+z.focusRect.y+")"),S=C.append("g").attr("clip-path","url(#buttonareaclip"+T+")").attr("class","buttonarea"),N=C.append("g").attr("class","focusclip").attr("clip-path","url(#plotclip"+T+")").attr("transform","translate("+D.left+","+D.top+")"),G=N.append("g").attr("class","plot"),U=C.append("svg:text").attr("x",ne/2).attr("y",15).attr("width",R.width).attr("class","svgtxt").style("font-size","80%").attr("text-anchor","middle"),ot=G.append("g").attr("id","pastboxgrp"),it=G.append("g").attr("id","ybhpgrp"),Ct=G.append("g").attr("id","wmarkgrp"),gt=G.append("g").attr("id","guidegrp"),mt=G.append("g").attr("id","maxfluxgrp"),yt=G.append("g").attr("id","stdfluxgrp"),st=G.append("g").attr("id","ybhplinesgrp"),xt=G.append("g").attr("id","razrgrp"),Rt=G.append("g").attr("id","auragrp"),dt=G.append("g").attr("id","pinkgrp"),vt=G.append("g").attr("id","oldbullseyegrp"),Lt=G.append("g").attr("id","bullseyegrp"),pt=G.append("g").attr("id","grid"),ft=G.append("g").attr("id","oresetgrp"),bt=G.append("g").attr("id","knotgrp"),wt=G.append("g").attr("id","steppygrp"),Et=G.append("g").attr("id","rosygrp"),zt=G.append("g").attr("id","rosyptsgrp"),Mt=G.append("g").attr("id","derailsgrp"),Dt=G.append("g").attr("id","allptsgrp"),Tt=G.append("g").attr("id","movingavgrp"),kt=G.append("g").attr("id","steppyptsgrp"),At=G.append("g").attr("id","datapointgrp"),Pt=G.append("g").attr("id","hollowgrp"),Bt=G.append("g").attr("id","flatlinegrp"),Nt=G.append("g").attr("id","hashtaggrp"),St=G.append("g").attr("id","roadgrp"),Ut=G.append("g").attr("id","dotgrp"),Gt=G.append("g").attr("id","horgrp"),Ht=G.append("g").attr("id","hortxtgrp"),ht=G.append("g").attr("id","pasttxtgrp"),(Ot=G.append("g").attr("visibility","hidden")).append("rect").attr("x",0).attr("y",0).attr("stroke-width",20).attr("stroke","url(#tapepat"+T+")").attr("fill","none"),Ot.append("text").attr("y",45).attr("paint-order","stroke").attr("stroke-width","2px").attr("stroke","#a00000").attr("font-size","35px").attr("text-anchor","middle").attr("fill","#ff0000").text("Error"),Vt=N.append("svg:use").attr("class","zoomin").attr("xlink:href","#zoominbtn").attr("opacity",z.zoomButton.opacity).attr("transform",P.botin).on("click",()=>{Yt.call(Kt.scaleBy,z.zoomButton.factor)}).on("mouseover",()=>{me||t.select(this).style("fill","red")}).on("mouseout",(e,a)=>{t.select(this).style("fill","black")}),It=N.append("svg:use").attr("class","zoomout").attr("xlink:href","#zoomoutbtn").attr("opacity",z.zoomButton.opacity).attr("transform",P.botout).on("click",()=>{Yt.call(Kt.scaleBy,1/z.zoomButton.factor)}).on("mouseover",()=>{me||t.select(this).style("fill","red")}).on("mouseout",(e,a)=>{t.select(this).style("fill","black")}),K=t.scaleUtc().range([0,R.width]),I=t.axisBottom(K).ticks(6),F=C.append("g").attr("class","axis").attr("transform","translate("+R.x+","+(D.top+R.height)+")").call(I),Z=t.axisTop(K).ticks(6).tickFormat(""),J=pt.append("g").attr("class","grid").attr("transform","translate(0,"+R.height+")").call(Z),j=t.axisTop(K).ticks(6),q=C.append("g").attr("class","axis").attr("transform","translate("+R.x+","+D.top+")").call(j),z.roadEditor&&(J.attr("display","none"),q.attr("display","none")),W=t.scaleLinear().range([R.height,0]),_=t.axisLeft(W).ticks(8).tickSize(6).tickSizeOuter(0),$=t.axisRight(W).ticks(8).tickSize(6).tickSizeOuter(0),Q=C.append("g").attr("class","axis").attr("transform","translate("+D.left+","+D.top+")").call(_),tt=C.append("g").attr("class","axis").attr("transform","translate("+(D.left+R.width)+","+D.top+")").call($),et=C.append("text").attr("class","axislabel").attr("transform","translate(15,"+(R.height/2+D.top)+") rotate(-90)").text(""),H=B.append("g").attr("class","brush").attr("transform","translate("+z.ctxRect.x+","+z.ctxRect.y+")"),O=H.append("g").attr("clip-path","url(#brushclip"+T+")").attr("transform","translate("+A.left+","+A.top+")"),Y=O.append("g").attr("class","context"),at=t.scaleUtc().range([0,M.width]),rt=t.axisBottom(at).ticks(6),nt=H.append("g").attr("class","axis").attr("transform","translate("+M.x+","+(A.top+M.height)+")").call(rt),lt=t.scaleLinear().range([M.height,0]),jt=t.brushX().extent([[0,0],[M.width,M.height]]).on("brush",ka),Zt=Y.append("g").attr("class","brush").call(jt),Ft=O.append("rect").attr("class","focusrect").attr("x",1).attr("y",1).attr("width",M.width-2).attr("height",M.height-2).attr("fill","none").style("stroke","black").style("stroke-width",1).style("stroke-dasharray","8,4,2,4"),V=K,X=W}(),function(){const e=z.divTable;if(null===e)return;for(;e.firstChild;)e.removeChild(e.firstChild);const a=t.select(e),r=(a.append("div").attr("class","rtbstart"),a.append("div").attr("class","rtbmain"));a.append("div").attr("class","rtbgoal"),0!=z.tableHeight&&r.style("max-height",z.tableHeight+"px").style("overflow-y","auto");const n=r.append("div").attr("class","rtable");n.append("div").attr("id","dpfloat").attr("class","floating"),qt=n.append("div").attr("id","topleft").style("position","absolute").style("left",0).style("top",0).style("width","1px").style("height","1px").attr("visibility","hidden"),z.reverseTable?(cn(),nn(),on()):(on(),nn(),cn())}(),function(){const e=z.divDueby;if(null===e)return;for(;e.firstChild;)e.removeChild(e.firstChild);const a=t.select(e);let r;r=["DAY","DELTA","TOTAL"],(la=a.append("div").attr("class","dbbody")).append("div").attr("class","dbhdrrow").selectAll("span.dbhdrcell").data(r).enter().append("span").attr("class","dbhdrcell").text(t=>t),la.selectAll(".dbrow").data([1,2,3,4,5,6,7]).join(t=>t.append("div").attr("class","dbrow"))}(),function(){const e=z.divData;if(null===e)return;for(;e.firstChild;)e.removeChild(e.firstChild);const a=t.select(e);let r;a.append("div").attr("id","dpfloat").attr("class","floating"),Jt=a.append("div").attr("id","datatopleft").style("position","absolute").style("left",0).style("top",0).style("width","1px").style("height","1px").attr("visibility","hidden"),a.attr("class","bmndrdata"),a.on("wheel.scroll",Ie,{passive:!1}),Ce=a.append("div").attr("class","dbody"),Ge=Array(Math.min(Ee.length,z.dataTableSize)).fill().map((t,e)=>e+Oe),r=["#","DATE","VALUE","COMMENT","",""],Ce.append("div").attr("class","dhdrrow").selectAll("span.dhdrcell").data(r).enter().append("span").attr("class",(t,e)=>"dhdrcell "+je[e]).style("text-align",(t,e)=>0==e?"right":null).text(t=>t),Ce.selectAll(".drow").data(Ge).join(t=>t.append("div").attr("class","drow")),Ne=a.append("input").attr("type","range").attr("class","dslider").attr("min",0).attr("max",15).attr("value",7).attr("step",1).on("input",function(){Ve(this.value)}).on("change",function(){Ve(this.value)})}(),this.id=1,this.showData=(t=>(arguments.length>0&&(z.showData=t),0!=ze.length&&(an(),en(),Qr(),tn(),rn(),Er()),z.showData)),this.showContext=(t=>(arguments.length>0&&(z.showContext=t),0!=we.length&&Sn(),z.showContext)),this.keepSlopes=(t=>(arguments.length>0&&(z.keepSlopes=t),z.keepSlopes)),this.keepIntervals=(t=>(arguments.length>0&&(z.keepIntervals=t),z.keepIntervals)),this.maxDataDays=(t=>(arguments.length>0&&(z.maxDataDays=t,z.maxDataDays<0?(ee=ze.slice(),te=ke.slice()):(ee=ze.filter(t=>t[0]>be.asof-z.maxDataDays*f),te=ke.filter(t=>t[0]>be.asof-z.maxDataDays*f)),0!=ze.length&&(an(),en(),Qr(),tn())),z.maxDataDays)),this.reverseTable=(e=>(arguments.length>0&&(z.reverseTable=e,z.reverseTable?(t.select(z.divTable).select(".rtbgoal").raise(),t.select(z.divTable).select(".rtbmain").raise(),t.select(z.divTable).select(".rtbstart").raise()):(t.select(z.divTable).select(".rtbstart").raise(),t.select(z.divTable).select(".rtbmain").raise(),t.select(z.divTable).select(".rtbgoal").raise()),Ln()),z.reverseTable)),this.tableUpdateOnDrag=(t=>(arguments.length>0&&(z.tableUpdateOnDrag=t,Ln()),z.tableUpdateOnDrag)),this.tableAutoScroll=(t=>(arguments.length>0&&(z.tableAutoScroll=t),z.tableAutoScroll)),this.undoBufferState=(()=>({undo:ue.length,redo:pe.length})),this.undo=(()=>{z.roadEditor&&(document.activeElement.blur(),0!=ue.length&&(0!=ue.length&&r.sameRoads(ue[ue.length-1],we)||pe.push(we),we=ue.pop(),ae.setRoadObj(we),ia()))}),this.undoAll=(()=>{z.roadEditor&&(we=ue.shift(),Ta(),ae.setRoadObj(we),ia())}),this.redo=(()=>{z.roadEditor&&(document.activeElement.blur(),0!=pe.length&&(Ra(!0),we=pe.pop(),ia()))}),this.clearUndo=Ta,this.zoomAll=(()=>{0!=we.length&&za()}),this.zoomDefault=(()=>{0!=we.length&&Ea()}),this.loadGoal=(async t=>{await async function(t,e=null){if(""==t||he)return;he=!0,z.headless||Le(["loading..."],le/10);const r=await a.loadJSON(t);if(null!=r){if(z.headless||Se(),"errstring"in r)throw new Error("loadGoalFromURL: BB file has errors: "+r.errstring);Ga(r)}else Le(null!=ce?[w[ce]]:["Could not load goal file."]),z.headless||setTimeout(Se,1500),"function"==typeof z.onError&&z.onError.call();he=!1}(t).catch(function(t){console.log(t.stack)})}),this.loadGoalJSON=((t,e=!0)=>{Se(),Ga(t,e)}),this.retroRatchet=(t=>{z.roadEditor&&function(t){if(0==we.length)return void console.log("bgraph("+T+"):setSafeDays(), road is empty!");let e=r.dtd(we,be,be.tcur,be.vcur);const a=be.asof;t<0&&(t=0);const n=e-(t-1)-1;if(n<=0)return;const l=be.asof+n*f,o=r.rdf(we,l);let i,s=-1;for(i=1;i<we.length;i++)if(we[i].sta[0]===a){s=i-1;break}let d,c=!1;s<0&&(Ha(a),c=!0),i+1<we.length&&we[i+1].sta[0]===a?d=i:(d=Ha(a,o),c&&(ue.pop(),c=!0)),ia()}(t)}),this.scheduleBreak=((t,e,n)=>{if(z.roadEditor&&!isNaN(e))if(0!=we.length){var l,o,i=a.dayparse(t,"-"),s=-1;for(l=1;l<we.length;l++)if(we[l].sta[0]===i){s=l;break}var d=!1;for(s<0&&(Ha(i),d=!0),d||Ra(),l=1;l<we.length;l++)if(we[l].sta[0]===i){s=l;break}if(n){for(we[s].end[0]=a.daysnap(we[s].end[0]+e*f),o=s+1;o<we.length;o++)we[o].sta[0]=a.daysnap(we[o].sta[0]+e*f),we[o].end[0]=a.daysnap(we[o].end[0]+e*f);if(we[s].sta[1]!=we[s].end[1]){var c={};c.sta=we[s].sta.slice(),c.sta[0]=a.daysnap(c.sta[0]+e*f),c.end=we[s].end.slice(),c.slope=r.segSlope(c),c.auto=r.RP.VALUE,we.splice(s+1,0,c),we[s].end=c.sta.slice(),we[s].slope=0,r.fixRoadArray(we,r.RP.VALUE,!1)}}else{var u=a.daysnap(we[s].sta[0]+e*f),p=r.findSeg(we,u);for(we[p].sta[0]!=u&&(Ha(u),d&&(ue.pop(),d=!0),p=r.findSeg(we,u)),o=s+1;o<p;o++)we.splice(s+1,1);we[s].end=we[s+1].sta.slice();var h=we[s+1].sta[1]-we[s].sta[1];for(o=s;o<we.length;o++)we[o].end[1]-=h,we[o].slope=r.segSlope(we[o]),o+1<we.length&&(we[o+1].sta[1]=we[o].end[1]);r.fixRoadArray(we,r.RP.SLOPE,!1)}ia()}else console.log("bgraph("+T+"):scheduleBreak(), road is empty!")}),this.commitTo=(t=>{if(z.roadEditor&&!isNaN(t))if(0!=we.length){if(we[we.length-2].slope!=t){var e=r.findSeg(we,be.horizon);we[e].sta[0]==be.horizon||e<we.length-2?Ra():Ha(be.horizon),we[we.length-2].slope=t,r.fixRoadArray(we,r.RP.VALUE,!1),ia()}}else console.log("bgraph("+T+"):commitTo(), road is empty!")}),this.getRoad=(()=>{var t,a,n={};if(0==we.length)return console.log("bgraph("+T+"):getRoad(), road is empty!"),null;n.valid=Ma(we),n.loser=r.redyest(we,be,be.tcur),n.asof=be.asof,n.horizon=be.horizon,n.siru=be.siru,n.road=[];for(let l=0;l<we.length-1;l++)(t=we[l]).sta[0]==t.end[0]&&t.sta[1]==t.end[1]||(a=[e.unix(t.end[0]).utc().format("YYYYMMDD"),t.end[1],t.slope*be.siru],t.auto==r.RP.DATE&&(a[2]=null),t.auto==r.RP.VALUE&&(a[1]=null),t.auto==r.RP.SLOPE&&(a[2]=null),n.road.push(a));return n}),this.saveGraph=((e=null)=>{const a=B.node();let r=(new XMLSerializer).serializeToString(a);if(z.headless||null==e){if(document.head.remove(),document.body.innerHTML=r,z.headless){var n=t.select(document.body);n.selectAll(".buttonarea").remove(),n.selectAll(".brush").remove(),n.selectAll(".zoomin").remove(),n.selectAll(".zoomout").remove()}}else{r.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)||(r=r.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')),r.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)||(r=r.replace(/^<svg/,'<svg xmlns:xlink="http://www.w3.org/1999/xlink"')),r='<?xml version="1.0" standalone="no"?>\n'+r;var l="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(r);e.href=l}}),this.hide=(()=>{ge=!0}),this.show=(()=>{ge=!1,0!=we.length?(ga(),ya(),ma(),va(),Ln(),Sn(),Un(!0)):console.log("bgraph("+T+"):show(), road is empty!")}),this.loading=(t=>{t?Le(["loading..."],le/10):Se()}),this.getRoadObj=(()=>r.copyRoad(we)),this.getGoalObj=(()=>be);var Cn=!1;this.setRoadObj=((t,e=!1)=>{Cn||(0!=t.length?(Cn=!0,Ra(),we=r.copyRoad(t),e&&(xe=r.copyRoad(t),Ta()),ae.setRoadObj(t),ia(),Cn=!1):console.log("bgraph("+T+"):setRoadObj(), new road is empty!"))}),this.isLoser=(()=>!(!be||0==we.length)&&r.redyest(we,be,be.tcur)),this.getProgress=(()=>[[a.dayify(be.tini,"-"),be.vini],[a.dayify(be.tcur,"-"),be.vcur],[a.dayify(be.tfin,"-"),be.vfin]]),this.curState=(()=>be?[be.tcur,be.vcur,be.rcur,r.rdf(we,be.tcur)]:null);const Nn=["plotall","steppy","rosy","movingav","aura","hidey","stathead","hashtags"];this.getVisualConfig=(()=>{var t={};return Nn.map(e=>{t[e]=be[e]}),t}),this.xlinkLoaded=(()=>!0);const Gn=["yaw","dir","kyoom","odom","monotone","aggday"];this.getGoalConfig=(()=>{let t={};return Gn.map(e=>{t[e]=be[e]}),t}),this.msg=(t=>{t?Le([t],20,null,{x:ne/20,y:10,w:18*ne/20,h:50},"message",!1,!0,B):Se("message")}),this.animHor=function(t){if(z.roadEditor)return;const e=z.horizon,a=Gt.select(".horizon"),r=Ht.select(".horizontext"),n=[["stroke-width",Ae(e.width*se*3)+"px",Ae(e.width*se)+"px"]],l=[["stroke-dasharray",1.3*e.dash+","+.7*e.dash,e.dash+","+e.dash]],o=[["font-size",1.2*e.font+"px",e.font+"px"]];t?(mr(a,500,n,l,"hor"),mr(r,500,[],o,"hort")):(yr(a,300,n,l,"hor"),yr(r,300,[],o,"hort"))},this.animYBR=function(t){if(z.roadEditor)return;let e=[["fill-opacity",1,.5],["fill","#ffff00",a.BHUE.DYEL]];const r=xt.select(".razr");e=[["stroke-width",Ae(z.oldRoadLine.width*se*2)+"px",Ae(z.oldRoadLine.width*se)+"px"]],t?mr(r,500,[],e,"ybrc"):yr(r,300,[],e,"ybrc")},this.animData=function(t){if(!z.roadEditor){var e=At.selectAll(".dp"),a=[["r",Ae(z.dataPoint.size*se*2)+"px",Ae(z.dataPoint.size*se)+"px"]];t?mr(e,500,[],a,"data"):yr(e,300,[],a,"data"),e=Dt.selectAll(".ap"),a=[["r",Ae(.7*z.dataPoint.size*se*2)+"px",Ae(.7*z.dataPoint.size*se)+"px"]],t?mr(e,500,[],a,"dataa"):yr(e,300,[],a,"dataa")}},this.animGuides=function(t){if(z.roadEditor)return;const e=gt.selectAll(".guides"),r=[["stroke-width",Ae(z.guidelines.width*se*2)+"px",t=>t<0?Ae(z.guidelines.weekwidth*se)+"px":Ae(z.guidelines.width*se)+"px"],["stroke",t=>t<0?a.BHUE.BIGG:"#ffff00",t=>t<0?a.BHUE.BIGG:a.BHUE.LYEL]];t?mr(e,500,[],r,"guides"):yr(e,300,[],r,"guides")},this.animRosy=function(t){if(z.roadEditor)return;const e=Et.selectAll(".rosy"),a=zt.selectAll(".rd"),r=[["stroke-width",Ae(6*se)+"px",Ae(4*se)+"px"]],n=[["r",Ae(z.dataPoint.size*se*2)+"px",Ae(z.dataPoint.size*se)+"px"]];t?(mr(e,500,[],r,"rosy"),mr(a,500,[],n,"rd")):(yr(e,300,[],r,"rosy"),yr(a,300,[],n,"rd"))},this.animMav=function(t){if(z.roadEditor)return;const e=Tt.selectAll(".movingav");let a=[["stroke-width",Ae(6*se)+"px",Ae(3*se)+"px"]];t?mr(e,500,a,[],"mav"):yr(e,300,a,[],"mav")},this.animYBHPlines=function(t){if(z.roadEditor)return;const e=st.selectAll("#r11, #r22, #r66"),a=[["stroke-width",Ae(4*se)+"px",Ae(1.5*se)+"px"]];t?mr(e,500,a,[],"ybl"):yr(e,300,a,[],"ybl")},this.animAura=function(t){if(z.roadEditor)return;const e=Rt.selectAll(".aura"),r=Rt.selectAll(".aurapast"),n=[["stroke","#9e559e",a.BHUE.LPURP],["fill","#9e559e",a.BHUE.LPURP]],l=[["stroke","#9e559e",a.BHUE.LPURP],["fill","#9e559e",a.BHUE.LPURP]],o=[["transform","translate(0,5)","translate(0,0)"]],i=[["transform","translate(0,5)","translate(0,0)"]];t?(mr(e,500,o,n,"aura"),mr(r,500,i,l,"aurap")):(yr(e,300,o,n,"aura"),yr(r,300,i,l,"aurap"))},this.animBuf=function(t){if(z.roadEditor)return;const e=Ct.selectAll(".waterbuf"),a=Number(e.attr("x")),r=Number(e.attr("y"));if("text"==e.node().tagName){let a=e.style("font-size"),n=[["font-size",1.3*(a=Number(a.substring(0,a.length-2)))+"px",a+"px"],["fill","#606060",z.watermark.color]],l=[["y",r+.1*a/3,r]];t?mr(e,500,l,n,"buf"):yr(e,300,l,n,"buf")}else{let n=z.watermark.height,l=[["width",1.3*n,n],["height",1.3*n,n],["x",a-.15*n,a],["y",r-.15*n,r]];t?mr(e,500,l,[],"buf"):yr(e,300,l,[],"buf")}},this.animBux=function(t){if(z.roadEditor)return;const e=Ct.selectAll(".waterbux");let a=e.style("font-size");a=Number(a.substring(0,a.length-2));const r=Number(e.attr("y")),n=[["font-size",1.3*a+"px",a+"px"],["fill","#606060",z.watermark.color]],l=[["y",r+.15*a,r]];t?mr(e,500,l,n,"bux"):yr(e,300,l,n,"bux")}}});