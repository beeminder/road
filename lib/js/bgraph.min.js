!function(t,e){"use strict";"function"==typeof define&&define.amd?define(["d3","moment","butil","broad","beebrain"],e):"object"==typeof module&&module.exports?module.exports=e(require("d3"),require("./moment"),require("./butil"),require("./broad"),require("./beebrain")):t.bgraph=e(t.d3,t.moment,t.butil,t.broad,t.beebrain)}(this,function(t,e,a,r,n){"use strict";const o=Math.max,l=Math.min,i=Math.abs,s=Math.floor,d=Math.ceil,c=Math.round,u=365.25,h=86400;let p=1,f={noGraph:!1,divGraph:null,divTable:null,divPoints:null,divDueby:null,divData:null,divJSON:null,svgSize:{width:700,height:450},focusRect:{x:0,y:0,width:700,height:370},focusPad:{left:25,right:5,top:25,bottom:30},ctxRect:{x:0,y:370,width:700,height:80},ctxPad:{left:25,right:5,top:0,bottom:30},tableHeight:387,zoomButton:{size:40,opacity:.6,factor:1.5},bullsEye:{size:40,ctxsize:20},roadDot:{size:5,ctxsize:3,border:1.5,ctxborder:1},roadKnot:{width:3,rmbtnscale:.6},roadLine:{width:3,ctxwidth:2},oldRoadLine:{width:3,ctxwidth:2,dash:32,ctxdash:16},dataPoint:{size:5,fsize:5,hsize:2.5,border:1},horizon:{width:2,ctxwidth:1,dash:8,ctxdash:6,font:10,ctxfont:9},today:{width:2,ctxwidth:1,font:12,ctxfont:9},watermark:{height:170,fntsize:150,color:"#000000"},guidelines:{width:2,weekwidth:4},maxfluxline:4,stdfluxline:2,razrline:2,textBox:{margin:3},odomReset:{width:.5,dash:8},roadLineCol:{valid:"black",invalid:"#ca1212",selected:"yellow"},roadDotCol:{fixed:"darkgray",editable:"#c2c2c2",selected:"yellow"},roadKnotCol:{dflt:"#c2c2c2",selected:"yellow",rmbtn:"black",rmbtnsel:"red"},textBoxCol:{bg:"#ffffff",stroke:"#d0d0d0"},roadTableCol:{bg:"#ffffff",bgHighlight:"#fffb55",text:"#000000",textDisabled:"#aaaaaa",bgDisabled:"#f2f2f2"},dataPointCol:{future:"#909090",stroke:"#eeeeee"},halfPlaneCol:{fill:"#ffffe8"},pastBoxCol:{fill:"#f8f8f8",opacity:.5},odomResetCol:{dflt:"#c2c2c2"},headless:!1,scrollZoom:!0,buttonZoom:!0,roadEditor:!1,showContext:!1,showFocusRect:!1,showData:!0,maxDataDays:-1,maxFutureDays:365,keepSlopes:!0,showGuidelines:!0,keepIntervals:!1,reverseTable:!1,tableAutoScroll:!0,tableUpdateOnDrag:!1,duebyUpdateOnDrag:!0,tableCheckboxes:!0,onRoadChange:null,dataTableSize:11,dataAutoScroll:!0,onError:null};const g={svgSize:{width:700,height:530},focusRect:{x:0,y:0,width:700,height:400},focusPad:{left:25,right:10,top:35,bottom:30},ctxRect:{x:0,y:400,width:700,height:80},ctxPad:{left:25,right:10,top:0,bottom:30},tableHeight:540,zoomButton:{size:50,opacity:.7,factor:1.5},bullsEye:{size:40,ctxsize:20},roadDot:{size:10,ctxsize:4,border:1.5,ctxborder:1},roadKnot:{width:7,rmbtnscale:.9},roadLine:{width:7,ctxwidth:2},oldRoadLine:{width:3,ctxwidth:1,dash:32,ctxdash:16},dataPoint:{size:4,fsize:6},horizon:{width:2,ctxwidth:1,dash:8,ctxdash:8,font:14,ctxfont:10},today:{width:2,ctxwidth:1,font:16,ctxfont:10},watermark:{height:150,fntsize:100,color:"#000000"},guidelines:{width:2,weekwidth:4},maxfluxline:4,stdfluxline:2,razrline:2,textBox:{margin:3}},v=".svg{shape-rendering:crispEdges}.axis path,.axis line{fill:none;stroke:black;shape-rendering:crispEdges}.axis .minor line{stroke:#777;stroke-dasharray:0,2,4,3}.grid line{fill:none;stroke:#dddddd;stroke-width:1px;shape-rendering:crispEdges}.aura{fill-opacity:0.3;stroke-opacity:0.3;}.aurapast{fill-opacity:0.15;stroke-opacity:0.3}.grid .minor line{stroke:none}.axis text{font-family:sans-serif;font-size:11px}.axislabel{font-family:sans-serif;font-size:11px;text-anchor:middle}circle.dots{stroke:black}line.roads{stroke:black}.pasttext,.ctxtodaytext,.ctxhortext,.horizontext,.hashtag{text-anchor:middle;font-family:sans-serif}.waterbuf,.waterbux{opacity:0.05882353;text-anchor:middle;font-family:Dejavu Sans,sans-serif}.loading{text-anchor:middle;font-family:Dejavu Sans,sans-serif}.zoomarea{fill:none}circle.ap{stroke:none}circle.rd{stroke:none;pointer-events:none;fill:"+a.Cols.ROSE+"}circle.std{stroke:none;pointer-events:none;fill:"+a.Cols.PURP+"}circle.hp{stroke:none;fill:"+a.Cols.WITE+"}.dp.gra,.ap.gra{fill:"+a.Cols.GRADOT+"}.dp.grn,.ap.grn{fill:"+a.Cols.GRNDOT+"}.dp.blu,.ap.blu{fill:"+a.Cols.BLUDOT+"}.dp.orn,.ap.orn{fill:"+a.Cols.ORNDOT+"}.dp.red,.ap.red{fill:"+a.Cols.REDDOT+"}.dp.blk,.ap.blk{fill:"+a.Cols.BLCK+"}.dp.fuda,.ap.fuda{fill-opacity:0.3}.guides{pointer-events:none;fill:none;stroke:"+a.Cols.LYEL+"}.ybhp{pointer-events:none}.rosy{fill:none;stroke:"+a.Cols.ROSE+";pointer-events:none}.steppy{fill:none;stroke:"+a.Cols.PURP+";pointer-events:none}.steppyppr{fill:none;stroke-opacity:0.8;stroke:"+a.Cols.LPURP+";pointer-events:none}.derails{fill:"+a.Cols.REDDOT+";pointer-events:none}.overlay .textbox{fill:#ffffcc;fill-opacity:0.5;stroke:black;stroke-width:1;pointer-events:none;rx:5;ry:5}",y=.015,m=1e3,x={beye:"https://s3.amazonaws.com/bmndr/road/bullseye.png",beyey:"https://s3.amazonaws.com/bmndr/road/bullseye_prev.png",infb:"https://bmndr.s3.amazonaws.com/road/infinity_blk.png",sklb:"https://bmndr.s3.amazonaws.com/road/jollyroger_blk.png",smlb:"https://bmndr.s3.amazonaws.com/road/smiley_blk.png"},b={NOBBFILE:0,BADBBFILE:1,BBERROR:2},w=["Could not find goal (.bb) file.","Bad .bb file.","Beeminder error"],k=()=>{if("undefined"==typeof navigator&&"undefined"==typeof window)return!1;var t=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0)}(navigator.userAgent||navigator.vendor||window.opera),t};return function(z){let R=((t,e)=>{t.opts||(t.opts=a.extend({},f,!0)),k()&&a.extend(t.opts,g);let r=a.extend(t.opts,e,!0);return r.divGraph=r.divGraph&&r.divGraph.nodeName?r.divGraph:null,r.headless?(r.divTable=null,r.divPoints=null,r.divDueby=null,r.divData=null,r.scrollZoom=!1,r.roadEditor=!1,r.showContext=!1,r.showFocusRect=!1):(r.divTable=r.divTable&&r.divTable.nodeName?r.divTable:null,r.divPoints=r.divPoints&&r.divPoints.nodeName?r.divPoints:null),r})(this,z),E=p;p++;let T,M,A,D,C,P,L,S,G,N,B,O,U,Y,K,V,H,I,j,Z,F,q,J,W,_,X,$,Q,tt,et,at,rt,nt,ot,lt,it,st,dt,ct,ut,ht,pt,ft,gt,vt,yt,mt,xt,bt,wt,kt,zt,Rt,Et,Tt,Mt,At,Dt,Ct,Pt,Lt,St,Gt,Nt,Bt,Ot,Ut,Yt,Kt,Vt,Ht,It,jt,Zt,Ft,qt,Jt,Wt,_t,Xt=50,$t=R.svgSize.width,Qt=R.svgSize.height,te=R.zoomButton.size,ee=te/540,ae=1,re=0,ne=!0,oe=null,le=[],ie=[],se=!1,de=!1,ce=!1,ue=k(),he=null,pe=[],fe={},ge={},ve=[],ye=[],me=[],xe=[],be=[],we=[];function ke(t){return void 0===we[t]&&(we[t]=r.isoline(ve,be,ge,t)),we[t]}function ze(t){return c(10*t)/10}function Re(t){return c(1e3*t)/1e3}function Ee(){(ge={}).yaw=1,ge.dir=1,ge.tcur=0,ge.vcur=0;const t=e.utc();t.hour(0),t.minute(0),t.second(0),t.millisecond(0),ge.asof=t.unix(),ge.horizon=ge.asof+a.AKH,ge.xMin=ge.asof,ge.xMax=ge.horizon,ge.tmin=ge.asof,ge.tmax=ge.horizon,ge.yMin=-1,ge.yMax=1,fe=a.deepcopy(ge),ve=[],pe=[],ye=[],xe=[]}function Te(){A=a.extend({},R.focusPad),D=a.extend({},R.ctxPad),ge.stathead&&!R.roadEditor&&(A.top+=15),A.left+=Xt,A.right+=Xt+(ge.hidey?8:0),D.left+=Xt,D.right+=Xt+(ge.hidey?8:0),T={x:R.focusRect.x+A.left,y:R.focusRect.y+A.top,width:R.focusRect.width-A.left-A.right,height:R.focusRect.height-A.top-A.bottom},M={x:R.ctxRect.x+D.left,y:R.ctxRect.y+D.top,width:R.ctxRect.width-D.left-D.right,height:R.ctxRect.height-D.top-D.bottom},C={botin:"translate("+(T.width-2*(te+5))+","+(T.height-(te+5))+") scale("+ee+","+ee+")",botout:"translate("+(T.width-(te+5))+","+(T.height-(te+5))+") scale("+ee+","+ee+")",topin:"translate("+(T.width-2*(te+5))+",5) scale("+ee+","+ee+")",topout:"translate("+(T.width-(te+5))+",5) scale("+ee+","+ee+")"}}function Me(t,e=-1,r="bold",n=null,o="overlay",l=!0,i=!1,s=null){if(null==R.divGraph)return;null==n&&(n={x:$t/20,y:Qt/5,w:$t-2*$t/20,h:Qt-2*Qt/5}),null==s&&(s=P);var d=s.select("g."+o);d.empty()&&(d=s.append("g").attr("class",o),l&&d.append("svg:rect").attr("x",0).attr("y",0).attr("width",$t).attr("height",Qt).style("fill",a.Cols.WITE).style("fill-opacity",.5),d.append("svg:rect").attr("class","textbox").attr("x",n.x).attr("y",n.y).attr("width",n.w).attr("height",n.h)),d.selectAll(".loading").remove();const c=t.length;e<0&&(e=Qt/15);var u=1.1*e;for(let a=0;a<c;a++)d.append("svg:text").attr("class","loading").attr("x",n.x+n.w/2).attr("y",n.y+n.h/2-(c-1)*u/2+a*u+e/2-3).attr("font-size",e).style("font-size",e).style("font-weight",r).text(t[a]);i&&d.style("opacity",0).transition().duration(200).style("opacity",1)}function Ae(t="overlay",e=!1,a=null){if(null!=R.divGraph){null==a&&(a=P);var r=a.selectAll("g."+t);e?r.style("opacity",1).transition().duration(200).style("opacity",0).remove():r.remove()}}function De(){if(null!==R.divGraph){var e=[H.invert(0),H.invert(T.width)];Te(),L.select("#plotclip"+E+" > rect").attr("width",T.width).attr("height",T.height),L.select("#brushclip"+E+" > rect").attr("width",M.width).attr("height",M.height),L.select("#buttonareaclip"+E+" > rect").attr("x",T.x).attr("y",0).attr("width",T.width).attr("height",T.height),Kt.attr("x",T.x).attr("y",T.y).attr("width",T.width).attr("height",T.height),Vt.extent([[0,0],[T.width,T.height]]).scaleExtent([1,1/0]).translateExtent([[0,0],[T.width,T.height]]),B.attr("transform","translate("+A.left+","+A.top+")"),Ht.attr("transform",C.botin),It.attr("transform",C.botout),V.range([0,T.width]),H.range([0,T.width]),F.attr("transform","translate("+T.x+","+(A.top+T.height)+")").call(I.scale(H)),R.roadEditor?(Yt.select("rect").attr("width",T.width).attr("height",T.height),Yt.select("text").attr("x",T.width/2)):(J.attr("transform","translate(0,"+T.height+")").call(Z),q.attr("transform","translate("+T.x+","+A.top+")").call(j.scale(H))),W.range([0,T.height]),_.range([0,T.height]),Q.attr("transform","translate("+A.left+","+A.top+")").call(X.scale(_)),tt.attr("transform","translate("+(A.left+T.width)+","+A.top+")").call($.scale(_)),et.attr("transform","translate(15,"+(T.height/2+A.top)+") rotate(-90)"),Y.attr("transform","translate("+D.left+","+D.top+")"),at.range([0,M.width]),nt.attr("transform","translate("+M.x+","+(D.top+M.height)+")").call(rt),ot.range([M.height,0]),jt.extent([[0,0],[M.width,M.height]]),Zt.call(jt);var a=e.map(V);Kt.call(Vt.transform,t.zoomIdentity.scale(T.width/(a[1]-a[0])).translate(-a[0],0)),Qe()}}Ee(),Te();var Ce,Pe,Le,Se=!1,Ge=0,Ne=-1;function Be(){Pe&&(Pe.node().value=Ge)}function Oe(t){Se=!0,Ge=parseInt(t),Ke(),Se=!1}function Ue(){if(t.event.deltaY<0){if(0==Ge)return;Ge-=1}else{if(Ge>=me.length-R.dataTableSize)return;Ge+=1}Be(),Ke()}let Ye=!1;function Ke(){if(Ye)return;if(Ye=!0,se)return;if(null===R.divData)return;Se||(me.length<=R.dataTableSize?Pe.style("visibility","hidden"):Pe.style("visibility","visible").attr("max",me.length-R.dataTableSize).attr("value",0)),Le=Array(Math.min(me.length,R.dataTableSize)).fill().map((t,e)=>e+Ge);let t=Ce.selectAll(".drow").data(Le);t.enter().append("div").attr("class","drow"),t.exit().remove(),t.style("box-shadow",t=>t==Ne?"0 0 0 4px yellow":null),Ce.selectAll(".drow").selectAll(".dcell").data((t,e)=>t>=me.length?[null,null,null]:[t,a.dayify(a.dayparse(me[t][0]),"-"),me[t][1],me[t][2]]).join(t=>t.append("span").attr("class",(t,e)=>3==e?"dcell cmt":"dcell").style("border",(t,e)=>0==e?"0":null).style("text-align",(t,e)=>0==e?"right":null),t=>t).text(t=>t),Ye=!1}var Ve;function He(){if(se)return;if(null===R.divDueby)return;const t=a.nowstamp(ge.timezone,ge.deadline,ge.asof),n=a.dayparse(t)/h;let o=r.dueby(ve,ge,7);Ve.selectAll(".dbrow").selectAll(".dbcell").data((t,r)=>{const l=function(t,r){const n=e.unix(ge.asof+t*h).utc(),o=a.dayparse(n.format("YYYYMMDD"))/h;if(o==r-1)return["Yesterday",a.Cols.REDDOT];if(o==r)return["Today",a.Cols.ORNG];if(o==r+1)return["Tomorrow",a.Cols.BLUDOT];const l=n.format("ddd (Do)");return o==r+2?[l,a.Cols.GRNDOT]:[l,a.Cols.BLCK]}(r,n),i=o[r][1];return[l,[i>0||ge.dir<0?a.shn(i):"&#10004;",l[1]],[a.shn(o[r][2]),l[1]]]}).join(t=>t.append("span").attr("class","dbcell"),t=>t).html(t=>t[0]).style("color",t=>t[1])}function Ie(){fe.tini==pe[0].end[0]&&(ge.tini=ve[0].end[0],ge.vini=ve[0].end[1]),hn||_t.setRoadObj(ve),ga(!0),he=r.findSeg(ve,ge.horizon),aa(),vr(),un(!0),cn(),dn(),He(),"function"==typeof R.onRoadChange&&R.onRoadChange.call()}function je(t,e,a,r,n=null){let o={};if(e<20-A.top&&(e=20-A.top),e>T.height-15&&(e=T.height-15),o.grp=N.append("g"),o.rect=o.grp.append("svg:rect").attr("pointer-events","none").attr("fill",R.textBoxCol.bg).style("stroke",r),o.text=o.grp.append("svg:text").attr("pointer-events","none").attr("text-anchor","middle"),null==n)o.text.text(a).attr("class","svgtxt");else{o.text.append("tspan").attr("x",0).attr("dy","0.6em").text(a).attr("class","svgtxt");for(var l=0;l<n.length;l++)o.text.append("tspan").attr("dy","1.2em").attr("x",0).text(n[l]).attr("font-size","0.7em")}var i=o.text.node().getBBox(),s=R.textBox.margin;return o.rect.attr("x",i.x-s).attr("y",i.y-s).attr("width",i.width+2*s).attr("height",i.height+2*s),t<i.width/2&&(t=i.width/2),t>T.width-i.width/2&&(t=T.width-i.width/2),o.grp.attr("transform","translate("+(t+A.left)+","+(e+A.top)+")"),o}function Ze(t,e,a,r){if(t){a<20-A.top&&(a=20-A.top),a>T.height-15&&(a=T.height-15),t.text.text(r);var n=t.text.node().getBBox(),o=R.textBox.margin;t.rect.attr("x",n.x-o).attr("y",n.y-o).attr("width",n.width+2*o).attr("height",n.height+2*o),e<n.width/2&&(e=n.width/2),e>T.width-n.width/2&&(e=T.width-n.width/2),t.grp.attr("transform","translate("+(e+A.left)+","+(a+A.top)+")")}else console.debug("updateTextBox: null input")}function Fe(t){t?t.grp.remove():console.debug("updateTextBox: null input")}var qe,Je=1,We=7;function _e(){let e=V.domain(),r=e.map(t=>t.getTime()/m),n=r.slice();n[0]=a.monthsnap(n[0]);let o=r.slice();o[0]=a.yearsnap(o[0]);let l=n.map(t=>new Date(t*m)),i=o.map(t=>new Date(t*m));(qe=[]).push([t.utcDay.range(e[0],e[1],1),"%b %d"]),qe.push([t.utcDay.range(e[0],e[1],2),"%b %d"]),qe.push([t.utcWeek.range(l[0],l[1],1),"%b %d"]),qe.push([t.utcWeek.range(l[0],l[1],2),"%b %d"]),qe.push([t.utcMonth.every(1).range(i[0],i[1]),"%b %Y"]),qe.push([t.utcMonth.every(2).range(i[0],i[1]),"%b %Y"]),qe.push([t.utcMonth.every(3).range(i[0],i[1]),"%Y"]),qe.push([t.utcYear.every(1).range(i[0],i[1]),"%Y"])}function Xe(){var e=[H.invert(0).getTime(),H.invert(T.width).getTime()],a=(e[1]-e[0])/(m*h);R.focusRect.width<500?a*=1.6:R.focusRect.width<550?a*=1.4:R.focusRect.width<600&&(a*=1.2),a<10?(Je=0,We=1):a<20?(Je=0,We=2):a<45?(Je=0,We=7):a<120?(Je=1,We=7):a<240?(Je=2,We=4):a<320?(Je=4,We=1):a<547.5?(Je=4,We=2):a<949?(Je=4,We=3):a<1825?(Je=5,We=3):a<3650?(Je=6,We=4):(Je=7,We=1);var r=qe[Je][0].filter(t=>t.getTime()<e[0]),n=(We-r.length%We)%We,o=qe[Je][0].filter(t=>t.getTime()>=e[0]&&t.getTime()<=e[1]);I.tickValues(o).tickSize(6).tickSizeOuter(0).tickFormat((e,a)=>t.utcFormat(a%We==n?qe[Je][1]:"")(e)),F.call(I.scale(H)),F.selectAll("g").classed("minor",!1),F.selectAll("g").filter((t,e)=>e%We!=n).classed("minor",!0),F.selectAll("g").selectAll(".tick line").attr("transform","translate(0,-5)"),R.roadEditor||(Z.tickValues(o).tickSize(T.width),J.call(Z.scale(H)),J.selectAll("g").classed("minor",!1),J.selectAll("g").filter((t,e)=>e%We!=n).classed("minor",!0),j.tickValues(o).tickSize(6).tickSizeOuter(0).tickFormat((e,a)=>t.utcFormat(a%We==n?qe[Je][1]:"")(e)),q.call(j.scale(H)),q.selectAll("g").classed("minor",!1),q.selectAll("g").filter((t,e)=>e%We!=n).classed("minor",!0),q.selectAll("g").selectAll(".tick line").attr("transform","translate(0,6)"))}function $e(){if(null!=R.divGraph&&!ce){et.text(ge.yaxis),ge.hidey&&!R.roadEditor&&(Q.selectAll("text").remove(),tt.selectAll("text").remove());var t=Q.node().getBBox();i(t.width-Xt)>5&&(Xt=s(t.width),De())}}function Qe(){var e=[H.invert(0),H.invert(T.width)];let a;if(R.headless){let t=ge.vmin-y*(ge.vmax-ge.vmin);a=[ge.vmax+y*(ge.vmax-ge.vmin),t]}else{var r=i(y*(ge.vmax-ge.vmin)),n=e.map(t=>s(t.getTime()/m)),l=pa(ve,n[0],n[1],!1);let t;if(l.yMin-=r,l.yMax+=r,R.roadEditor){var d=pa(pe,n[0],n[1],!1);d.yMin-=r,d.yMax+=r,t=ca(l,d)}else t=l;var c=ha(ge.plotall&&!R.roadEditor?xe:ye,n[0],n[1],!1);let o;null!=c&&(t=ca(t,c)),ua(t,o=R.roadEditor?{xmin:0,xmax:0,ymin:.05,ymax:.05}:{xmin:0,xmax:0,ymin:.02,ymax:.02}),t.yMax-t.yMin<2*r&&(t.yMax+=r,t.yMin-=r),a=[t.yMax,t.yMin]}var u=t.zoomIdentity.scale(T.height/(W(a[1])-W(a[0]))).translate(0,-W(a[0]));_=u.rescaleY(W),Q.call(X.scale(_)),tt.call($.scale(_)),a[0]>ge.yMax&&(ge.yMax=a[0]),a[1]<ge.yMin&&(ge.yMin=a[1]),ta();var h=e.map(t=>at(t)),p=a.map(t=>ot(t));Ft.attr("x",h[0]+1).attr("width",o(0,h[1]-h[0]-2)).attr("y",p[0]+1).attr("height",o(0,p[1]-p[0]-2))}function ta(){null!=R.divGraph&&(at.domain([new Date(l(ge.tmin,ge.xMin)*m),new Date(o(ge.tmax,ge.xMax)*m)]),nt.call(rt.scale(at)),ot.domain([ge.yMin,ge.yMax]))}function ea(){if(null!=R.divGraph){var t=[at(H.invert(0)),at(H.invert(T.width))];t[0]<0&&(t[0]=0),t[1]>M.width&&(t[1]=M.width),Zt.call(jt.move,t)}}function aa(){ta(),ea()}function ra(){if(!(0==ve.length||t.event&&t.event.sourceEvent&&"brush"===t.event.sourceEvent.type)){var e=t.zoomTransform(Kt.node());null!=e&&(H=e.rescaleX(V),Xe(),Qe(),Q.selectAll("g").selectAll(".tick line").attr("transform","translate(6,0)"),tt.selectAll("g").selectAll(".tick line").attr("transform","translate(-5,0)"),$e(),ea(),un())}}function na(){if(0!=ve.length&&(!t.event.sourceEvent||"zoom"!==t.event.sourceEvent.type)){var e=t.event.selection||at.range();H.domain(e.map(at.invert,at)),Xe(),Qe(),$e(),Kt.call(Vt.transform,t.zoomIdentity.scale(M.width/(e[1]-e[0])).translate(-e[0],0)),un()}}function oa(){if(null!=R.divGraph){var e=ge.tmin-y*(ge.tmax-ge.tmin),a=ge.tmax+y*(ge.tmax-ge.tmin),r=[new Date(e*m),new Date(a*m)];H.domain(r);var n=r.map(at);Xe(),Qe(),Kt.call(Vt.transform,t.zoomIdentity.scale(M.width/(n[1]-n[0])).translate(-n[0],0))}}function la(){null!=R.divGraph&&(ga(!1),V.domain([new Date(l(ge.tmin,ge.xMin)*m),new Date(o(ge.tmax,ge.xMax)*m)]),_e(),W.domain([ge.yMin,ge.yMax]),H=V,_=W,ta(),Kt.call(Vt.transform,t.zoomIdentity),ge.dir>0?(Ht.attr("transform",C.botin),It.attr("transform",C.botout)):(Ht.attr("transform",C.topin),It.attr("transform",C.topout)),aa())}function ia(){le=[],ie=[]}function sa(t=!1){0!=le.length&&r.sameRoads(le[le.length-1],ve)||(le.push(r.copyRoad(ve)),t||(ie=[]))}function da(t){var e=pe,a=ge.asof,n=ge.horizon;if(ge.yaw*r.rdf(t,a)<ge.yaw*r.rdf(e,a)-1e-6)return!1;if(ge.yaw*r.rdf(t,n)<ge.yaw*r.rdf(e,n)-1e-6)return!1;var o=r.findSeg(t,a),l=r.findSeg(t,n);for(let a=o;a<l;a++)if(ge.yaw*r.rdf(t,t[a].end[0])<ge.yaw*r.rdf(e,t[a].end[0])-1e-6)return!1;var i=r.findSeg(e,a),s=r.findSeg(e,n);for(let a=i;a<s;a++)if(ge.yaw*r.rdf(t,e[a].end[0])<ge.yaw*r.rdf(e,e[a].end[0])-1e-6)return!1;return!0}function ca(t,e){let a={};return a.xMin=l(t.xMin,e.xMin),a.xMax=o(t.xMax,e.xMax),a.yMin=l(t.yMin,e.yMin),a.yMax=o(t.yMax,e.yMax),a}function ua(t,e){var a=t.xMax-t.xMin;a<1e-7&&(a=1e-7);var r=t.yMax-t.yMin;r<1e-7&&(r=1e-7),t.xMin=t.xMin-e.xmin*a,t.xMax=t.xMax+e.xmax*a,t.yMin=t.yMin-e.ymin*r,t.yMax=t.yMax+e.ymax*r}function ha(t,e,n,i=!1){var s={},d=t.filter(t=>t[0]>e&&t[0]<n);if(0==d.length){var c=-1;for(let a=0;a<t.length-1;a++)if(t[a][0]<=e&&t[a+1][0]>=n){c=a;break}c>0&&(d=t.slice(c,c+1))}if(0==d.length)return null;if(s.xMin=a.arrMin(d.map(t=>t[0])),s.xMax=a.arrMax(d.map(t=>t[0])),s.yMin=a.arrMin(d.map(t=>t[1])),s.yMax=a.arrMax(d.map(t=>t[1])),null!=_t.flad&&_t.flad[0]<=n&&_t.flad[0]>=e){const t=_t.flad[1]+r.ppr(ve,ge,ge.asof);s.yMin=l(s.yMin,t),s.yMax=o(s.yMax,t)}return i&&ua(s,{xmin:.1,xmax:.1,ymin:.1,ymax:.1}),s}function pa(t,e,n,o=!1){var l={};return l.xMin=e,l.xMax=n,l.yMin=a.arrMin(t.map(function(t){return t.sta[0]<e||t.sta[0]>n?1/0:t.sta[1]})),l.yMax=a.arrMax(t.map(function(t){return t.sta[0]<e||t.sta[0]>n?-1/0:t.sta[1]})),l.yMin=a.arrMin([l.yMin,r.rdf(t,e),r.rdf(t,n)]),l.yMax=a.arrMax([l.yMax,r.rdf(t,e),r.rdf(t,n)]),o&&ua(l,{xmin:.1,xmax:.1,ymin:.1,ymax:.1}),l}function fa(){var t,n;null==ge.waterbuf0&&(ge.safebuf=r.dtd(ve,ge,ge.tcur,ge.vcur),ge.tluz=ge.tcur+ge.safebuf*h,ge.tfin<ge.tluz&&(ge.tluz=a.BDUSK),ge.loser=r.redyest(ve,ge,ge.tcur),ge.asof>=ge.tfin&&!ge.loser?ge.waterbuf=":)":ge.safebuf>999?ge.waterbuf="inf":ge.safebuf>=7?ge.waterbuf=ge.safebuf+"d":ge.safebuf<=0?ge.waterbuf=(n=ge.deadline,e.unix(n).utc().format("h:mma").replace(":00","")+"!"):ge.waterbuf=(t=ge.tluz,e.unix(t).utc().format("ddd")))}function ga(e=!0){if(0==ve.length)return;var r=ge.asof,n=a.daysnap(l(r+R.maxFutureDays*h,ve[ve.length-1].sta[0]));let i,s=pa(ve,ve[0].end[0],n,!1);i=R.roadEditor?ca(s,pa(pe,ve[0].end[0],n,!1)):s;var d=ha(ge.plotall&&!R.roadEditor?xe:ye,ve[0].end[0],ye[ye.length-1][0],!1);if(null!=d&&(i=ca(i,d)),0!=_t.fuda.length){var c=ha(_t.fuda,ve[0].end[0],n,!1);null!=c&&(i=ca(i,c))}var u={xmin:.1,xmax:.1,ymin:.1,ymax:.1};if(R.roadEditor||(u.xmin=.02,u.xmax=.02),ua(i,u),ge.xMin=a.daysnap(i.xMin),ge.xMax=a.daysnap(i.xMax),ge.yMin=i.yMin,ge.yMax=i.yMax,e&&null!=R.divGraph){var p=[H.invert(0),H.invert(T.width)];_.invert(0),_.invert(T.height),V.domain([new Date(l(ge.tmin,ge.xMin)*m),new Date(o(ge.tmax,ge.xMax)*m)]),_e(),W.domain([ge.yMin,ge.yMax]);var f=t.zoomIdentity.scale(T.width/(V(p[1])-V(p[0]))).translate(-V(p[0]),0);Kt.call(Vt.transform,f)}}function va(t,e,r=6e3){return a.linspace(t,e,s(a.clip((e-t)/(h+1),l(300,T.width/8),r)))}const ya=`bgraph(${E}): Goal stats`,ma=`bgraph(${E}): Goal graph`;function xa(t,e=!0){if(!("params"in t&&"data"in t))throw new Error("loadGoal: JSON input lacks params or data");ia(),se=!0;let o=t.params.yoog?" ("+t.params.yoog+")":"";if(e&&console.time(ya+o),_t=new n(t),ge=_t.gol,R.divJSON&&(R.headless?R.divJSON.innerText=JSON.stringify(_t.getStats()):R.divJSON.innerText=JSON.stringify(_t.getStats(),null,4)),e&&console.timeEnd(ya+o),""!=ge.error){console.log("Beebrain error: "+_t.gol.error),oe=b.BBERROR;var l=_t.gol.error.split("\\n");return Me(["The following errors prevented us from generating "+_t.gol.yoog,"(We've pinged Beeminder support to come help fix things up here!)",""].concat(l),Qt/30,null),Ee(),void(se=!1)}if(R.noGraph)return Me(["Beebrain was called with 'NOGRAPH_*' as the slug","so no graph or thumbnail was generated, just this","static placeholder!"],Qt/30,null),Ee(),void(se=!1);ve=_t.roads,pe=r.copyRoad(ve),ye=_t.data,me=a.deepcopy(t.data),fe=a.deepcopy(ge),xe=_t.alldata,R.maxDataDays<0?(Jt=ye.slice(),Wt=xe.slice()):(Jt=ye.filter(function(t){return t[0]>ge.asof-R.maxDataDays*h}),Wt=xe.filter(function(t){return t[0]>ge.asof-R.maxDataDays*h})),R.divGraph&&(!R.roadEditor&&ge.stathead?G.text(ge.graphsum):G.text("")),e&&console.time(ma+o),vr(),la(),oa(),se=!1,dn(),He(),null!==R.divData&&(Ge=0,Be(),Ke()),cn(),De(),function(){if(null!=R.divTable){var t,e,a="Daily Slope";"h"===ge.runits&&(a="Hourly Slope"),"d"===ge.runits&&(a="Daily Slope"),"w"===ge.runits&&(a="Weekly Slope"),"m"===ge.runits&&(a="Monthly Slope"),"y"===ge.runits&&(a="Yearly Slope"),R.roadEditor?(t=["","End Date","Value",a,"",""],e=["","Goal Date","Value",a,"",""]):(t=["","End Date","Value",a],e=["","Goal Date","Value",a]),Tr.selectAll("span.roadhdrcell").data(t).text(t=>t),kr.selectAll("span.roadhdrcell").data(t).text(t=>t),Mr.selectAll("span.roadhdrcell").data(e).text(t=>t),ln()}}(),"function"==typeof R.onRoadChange&&R.onRoadChange.call(),e&&console.timeEnd(ma+o)}function ba(t,e=null){var n=r.findSeg(ve,t);if(n>=0){var o={},l=a.daysnap(t+h/2),i=e;null==e&&(i=ve[n].sta[1]+ve[n].slope*(l-ve[n].sta[0])),sa(),o.sta=[l,i],0==n?(o.end=ve[n+1].sta.slice(),null!=e&&(o.end[1]=o.sta[1]+ve[n].slope*(o.end[0]-l)),ve[n].end=[l,i]):(n==ve.length-1?(o.end=ve[n].end.slice(),o.end[1]=i):(o.end=ve[n+1].sta.slice(),null!=e&&R.keepSlopes&&(o.end[1]=o.sta[1]+ve[n].slope*(o.end[0]-l))),ve[n].end=[l,i],ve[n].slope=r.segSlope(ve[n]),ve[n].sta[0]==ve[n].end[0]&&(ve[n].auto=r.RP.SLOPE)),o.slope=r.segSlope(o),o.auto=r.RP.VALUE,ve.splice(n+1,0,o),r.fixRoadArray(ve,R.keepSlopes?r.RP.VALUE:r.RP.SLOPE,!1),Ie()}return n}function wa(t,e){sa();var a=ve[t].slope;ve.splice(t,1),R.keepSlopes&&!isNaN(a)&&(ve[t].slope=a),r.fixRoadArray(ve,R.keepSlopes?r.RP.VALUE:r.RP.SLOPE,e),Ie()}var ka=null,za=null,Ra=null;function Ea(t,r){var n,o,l=H(a.daysnap(t[0])*m),i=t[1];if(Ca=e.unix(t[0]).utc(),ka=je(l,T.height-15,Ca.format("YYYY-MM-DD")+" ("+Ca.format("ddd")+")",R.textBoxCol.stroke),za=je(l,_(i)-15,a.shn(t[1]),R.textBoxCol.stroke),null!=r){var s=H(a.daysnap(r[0])*m),d=_(r[1]);Ra=je(s,d,"s:"+a.shn(r[2]),R.textBoxCol.stroke),l-s<50&&(o=!0,(n=Ra)?n.grp.attr("visibility",o?"hidden":"visible"):console.debug("updateTextBox: null input"))}}function Ta(t,r){var n=a.daysnap(t[0]),o=t[1];if(Ca=e.unix(n).utc(),Ze(ka,H(n*m),T.height-15,Ca.format("YYYY-MM-DD")+" ("+Ca.format("ddd")+")"),Ze(za,H(n*m),_(o)-15,a.shn(t[1])),null!=r){var l=a.daysnap(r[0]),i=r[1];Ze(Ra,H(l*m),_(i),"s:"+a.shn(r[2]))}}function Ma(){null!=ka&&Fe(ka),ka=null,null!=za&&Fe(za),za=null,null!=Ra&&Fe(Ra),Ra=null}function Aa(e,r){var n=ve,o=t.select(R.divGraph);for(let t=e;t<n.length;t++)o.select("[name=dot"+t+"]").attr("cx",ze(H(n[t].end[0]*m))).attr("cy",ze(_(n[t].end[1]))),o.select("[name=ctxdot"+t+"]").attr("cx",ze(at(n[t].end[0]*m))).attr("cy",ze(ot(n[t].end[1]))),o.select("[name=road"+t+"]").attr("x1",ze(H(n[t].sta[0]*m))).attr("y1",ze(_(n[t].sta[1]))).attr("x2",ze(H(n[t].end[0]*m))).attr("y2",ze(_(n[t].end[1]))),o.select("[name=ctxroad"+t+"]").attr("x1",ze(at(n[t].sta[0]*m))).attr("y1",ze(ot(n[t].sta[1]))).attr("x2",ze(at(n[t].end[0]*m))).attr("y2",ze(ot(n[t].end[1]))),r&&(o.select("[name=knot"+t+"]").attr("x1",ze(H(n[t].end[0]*m))).attr("x2",ze(H(n[t].end[0]*m))),o.select("[name=remove"+t+"]").attr("transform",t=>"translate("+(H(t.end[0]*m)+A.left-8)+","+(A.top-20)+") scale(0.6,0.6)")),o.select("[name=enddate"+t+"]").text(a.dayify(n[t].end[0],"-")),o.select("[name=endvalue"+t+"]").text(a.shn(n[t].end[1])),o.select("[name=slope"+t+"]").text(a.shn(n[t].slope*ge.siru));R.tableUpdateOnDrag&&sn(),R.duebyUpdateOnDrag&&He(),vr(),yr(),er(),Qa(),tr(),Or(),Ur(),rr(),ur(),nr(),hr(),pr()}var Da,Ca,Pa,La=null,Sa=null,Ga=null;function Na(e,a=!0){if(null!=R.divGraph){Qr(e,!0,a),La=e,Sa=r.RP.DATE,t.select("[name=knot"+e+"]").attr("stroke-width",Re(R.roadKnot.width));var n=H(ve[e].end[0]*m);Ga=bt.append("svg:line").attr("class","selectedknot").attr("pointer-events","none").attr("x1",n).attr("x2",n).attr("y1",0).attr("y2",T.height).attr("stroke",R.roadKnotCol.selected).attr("stroke-opacity",.9).attr("stroke-width",Re(R.roadKnot.width+4)).lower()}}function Ba(e){Qr(e,!1),t.select("[name=knot"+e+"]").attr("stroke",R.roadKnotCol.dflt).attr("stroke-width",Re(R.roadKnot.width))}function Oa(e,a=!0){null!=R.divGraph&&(tn(e,!0,a),La=e,Sa=r.RP.VALUE,t.select("[name=dot"+e+"]").attr("r",Re(R.roadDot.size)),Ga=Gt.append("svg:circle").attr("class","selecteddot").attr("pointer-events","none").attr("cx",ze(H(ve[e].end[0]*m))).attr("cy",ze(_(ve[e].end[1]))).attr("fill",R.roadDotCol.selected).attr("fill-opacity",.6).attr("r",Re(R.roadDot.size+4)).attr("stroke","none").lower())}function Ua(e){tn(e,!1),t.select("[name=dot"+e+"]").attr("fill",R.roadDotCol.editable).attr("r",Re(R.roadDot.size))}function Ya(e,a=!0){null!=R.divGraph&&(en(e,!0,a),La=e,Sa=r.RP.SLOPE,t.select("[name=road"+e+"]").attr("shape-rendering","geometricPrecision").attr("stroke-width",(R.roadLine.width,3)),Ga=St.append("svg:line").attr("class","selectedroad").attr("shape-rendering","geometricPrecision").attr("pointer-events","none").attr("x1",H(ve[e].sta[0]*m)).attr("x2",H(ve[e].end[0]*m)).attr("y1",_(ve[e].sta[1])).attr("y2",_(ve[e].end[1])).attr("stroke",R.roadKnotCol.selected).attr("stroke-opacity",.9).attr("stroke-width",Re(R.roadLine.width+4)).lower())}function Ka(e){en(e,!1);var a=da(ve)?R.roadLineCol.valid:R.roadLineCol.invalid;t.select("[name=road"+e+"]").style("stroke",a).attr("stroke-width",Re(R.roadLine.width))}function Va(){La=null,Sa=null,null!=Ga&&(Ga.remove(),Ga=null)}function Ha(){null!=La&&(Sa==r.RP.DATE?Ba(La):Sa==r.RP.VALUE?Ua(La):Sa==r.RP.SLOPE&&Ka(La),Ma(),Va())}var Ia=!1;function ja(e,a){t.event.sourceEvent.stopPropagation(),Ia=!0,sa();var n=Number(this.id);Da=r.copyRoad(ve),null==La?Na(n):null!=La&&La==n&&Sa==r.RP.DATE?Ha():(Ha(),Na(n)),Ea(e.end),ka.grp.raise(),(Pa=[])[0]=ve[n].slope,Pa[1]=ve[n+1].slope}function Za(e,n){Va();var o=a.daysnap(H.invert(t.event.x)/m),l=Number(this.id),i=ve;o<i[l].sta[0]&&(o=i[l].sta[0]),o>i[l+1].end[0]&&(o=i[l+1].end[0]);var s=l+1;R.keepIntervals&&(s=i.length);for(let t=l;t<s;t++)i[t].end[0]=o+Da[t].end[0]-Da[l].end[0];isFinite(Pa[0])&&ve[l].sta[0]!=ve[l].end[0]&&(ve[l].slope=Pa[0]),isFinite(Pa[1])&&ve[l+1].sta[0]!=ve[l+1].end[0]&&(ve[l+1].slope=Pa[1]),r.fixRoadArray(i,R.keepSlopes?r.RP.VALUE:r.RP.SLOPE,!1,r.RP.DATE),Aa(l,!0),Ta(e.end)}function Fa(t,e){Ia=!1,null==La&&(Ba(e),Ma(),Ie()),Da=null}function qa(t){wa(Number(this.id),!1)}var Ja=!1;var Wa=!1;var _a={buf:!1,bux:!1,aura:!1,aurap:!1,hor:!1,hort:!1,ybr:!1,ybrc:!1,guides:!1,rosy:!1,rosyd:!1,data:!1,dataa:!1,mav:!1};function Xa(t,e,a,r,n){var o,l=t.transition().duration(e);for(o=0;o<a.length;o++)l=l.attr(a[o][0],a[o][1]);for(o=0;o<r.length;o++)l=l.style(r[o][0],r[o][1]);for(l=l.transition().duration(e),o=0;o<a.length;o++)l=l.attr(a[o][0],a[o][2]);for(o=0;o<r.length;o++)l=l.style(r[o][0],r[o][2]);l.on("end",()=>{_a[n]&&Xa(t,e,a,r,n)}),_a[n]=!0}function $a(t,e,a,r,n){_a[n]=!1;var o=t.transition().duration(e);for(let t=0;t<a.length;t++)o=o.attr(a[t][0],a[t][2]);for(let t=0;t<r.length;t++)o=o.style(r[t][0],r[t][2]);o.on("end",()=>{_a[n]=!1})}function Qa(){if(!se&&null!=R.divGraph&&0!=ve.length){var t=Lt.select(".bullseye"),e=H(ge.tfin*m)-R.bullsEye.size/2,a=_(r.rdf(ve,ge.tfin))-R.bullsEye.size/2;t.empty()?Lt.append("svg:image").attr("class","bullseye").attr("xlink:href",x.beye).attr("externalResourcesRequired",!0).attr("x",e).attr("y",a).attr("width",R.bullsEye.size).attr("height",R.bullsEye.size):t.attr("x",e).attr("y",a)}}function tr(){if(!se&&null!=R.divGraph&&0!=ve.length){var t=K.select(".ctxbullseye");if(R.roadEditor){var e=at(ge.tfin*m)-R.bullsEye.ctxsize/2,a=ot(r.rdf(ve,ge.tfin))-R.bullsEye.ctxsize/2;t.empty()?K.append("svg:image").attr("class","ctxbullseye").attr("xlink:href",x.beyey).attr("externalResourcesRequired",!0).attr("x",e).attr("y",a).attr("width",R.bullsEye.ctxsize).attr("height",R.bullsEye.ctxsize):t.attr("x",e).attr("y",a)}else t.remove()}}function er(){if(!se&&null!=R.divGraph&&0!=ve.length&&!ce){var t,e,a,r,n,o,l,i=[0,0],s=[0,T.height/2],d=[T.width/2,0],c=[T.width/2,T.height/2],u=null;fa(),ge.loser&&(u=x.sklb),"inf"===ge.waterbuf?u=x.infb:":)"===ge.waterbuf&&(u=x.smlb),ge.dir>0&&ge.yaw<0?(t=c,e=i):ge.dir<0&&ge.yaw>0?(t=d,e=s):ge.dir<0&&ge.yaw<0?(t=s,e=d):(t=i,e=c),ne=!1;var h=Nt.select(".waterbuf"),p=R.watermark.fntsize,f=R.watermark.height;h.remove(),null!=u?(a=(T.width/2-f)/2,r=(T.height/2-f)/2,h=Nt.append("svg:image").attr("class","waterbuf").attr("xlink:href",u).attr("externalResourcesRequired",!0).attr("width",f).attr("height",f).on("load",()=>{ne=!0})):(a=T.width/4,r=T.height/4+p/3,(n=(h=Nt.append("svg:text").attr("class","waterbuf").style("font-size",p+"px").style("font-weight","bolder").style("fill",R.watermark.color).text(ge.waterbuf)).node().getBBox()).width>T.width/2.2&&(l=(o=p*(T.width/2.2)/n.width)/p*n.height,r=T.height/4+l/3,h.style("font-size",o+"px")),ne=!0),h.attr("x",a+t[0]).attr("y",r+t[1]);var g=Nt.select(".waterbux");g.remove(),R.roadEditor?g.remove():(a=T.width/4,r=T.height/4+p/3,(n=(g=Nt.append("svg:text").attr("class","waterbux").style("font-size",p+"px").style("font-weight","bolder").style("fill",R.watermark.color).text(ge.waterbux)).node().getBBox()).width>T.width/2.2&&(l=(o=p*(T.width/2.2)/n.width)/p*n.height,r=T.height/4+l/3,g.style("font-size",o+"px")),g.attr("x",a+e[0]).attr("y",r+e[1]))}}function ar(){if(!se&&null!=R.divGraph&&0!=ve.length&&!ce){var t=Tt.selectAll(".aura"),e=Tt.selectAll(".aurapast");if(ge.aura&&R.showData){var r,n,i=l(0,-ge.stdflux),s=o(0,ge.stdflux),d=y*(ge.tmax-ge.tmin),c=[H.invert(0).getTime()/m,H.invert(T.width).getTime()/m];r=va(o(c[0],ge.tmin),a.arrMin([c[1],ge.asof+a.AKH,ge.tmax+d]),T.width/8);var u="M"+ze(H(r[0]*m))+" "+ze(_(ge.auraf(r[0])+s));for(n=1;n<r.length;n++)u+=" L"+ze(H(r[n]*m))+" "+ze(_(ge.auraf(r[n])+s));for(n=r.length-1;n>=0;n--)u+=" L"+ze(H(r[n]*m))+" "+ze(_(ge.auraf(r[n])+i));if(u+=" Z",t.empty()?Tt.append("svg:path").attr("class","aura").attr("d",u).style("fill",a.Cols.LPURP).style("stroke-width",2).style("stroke",a.Cols.LPURP):t.attr("d",u),c[0]<ge.tmin){for(r=va(c[0],ge.tmin,T.width/8),u="M"+ze(H(r[0]*m))+" "+ze(_(ge.auraf(r[0])+s)),n=1;n<r.length;n++)u+=" L"+ze(H(r[n]*m))+" "+ze(_(ge.auraf(r[n])+s));for(n=r.length-1;n>=0;n--)u+=" L"+ze(H(r[n]*m))+" "+ze(_(ge.auraf(r[n])+i));u+=" Z",e.empty()?Tt.append("svg:path").attr("class","aurapast").attr("d",u).style("fill",a.Cols.LPURP).style("stroke-width",2).style("stroke-dasharray","4,4").style("stroke",a.Cols.LPURP):e.attr("d",u)}else e.remove()}else t.remove(),e.remove()}}function rr(){if(se||null==R.divGraph||0==ve.length)return;const e=t.selectAll("#svg"+E+" #ybhpgrp path"),n=t.selectAll("#svg"+E+" #ybhplinesgrp path"),l=e.size()+n.size(),i=[ge.tini,ge.tfin],s=(ge.asof,ge.asof,a.Cols.RAZR3),d=a.Cols.RAZR2,c=a.Cols.RAZR1,u=(ge.tfin-ge.tini)/h,p=[[0,2,"#ffff88","none",0,.72,i],[u,-1,"#ffffbd","none",0,.72,i]],f=[[6,6,"none",s,.99,1,i],[2,2,"none",d,.99,1,i],[1,1,"none",c,.99,1,i],[0,2,"#ffff88","none",0,.72,i],[u,-1,"#ffffbd","none",0,.72,i]];let g;g=ge.maxflux>0?p:f;for(var v=0;v<o(l,g.length);v++){const t="halfplane"+v,e=g[v];if(null==e||null==e[2]&&null==e[3]){it.select("."+t).remove(),st.select("."+t).remove();continue}let a,n;e[0]!=e[1]?(n=it,st.select("."+t).remove()):(n=st,it.select("."+t).remove()),a=n.select("."+t);const o="r"+e[0]+e[1],l=ge.yaw*e[4]/2;let i=e[6];null==i&&(i=[-1/0,1/0]);const s=e[0],d=e[1];if(s<0){console.log("updateYBHP(): Invalid region definition");continue}let c,u,h=ve[0].end[0],p=ve[ve.length-1].sta[0];h<i[0]&&(h=i[0]),p>i[1]&&(p=i[1]),ge.yaw<0?(c=ge.yMin-.1*(ge.yMax-ge.yMin),u=ge.yMax+.1*(ge.yMax-ge.yMin)):(c=ge.yMax+.1*(ge.yMax-ge.yMin),u=ge.yMin-.1*(ge.yMax-ge.yMin));const f=ke(s);let y=f[0][0],x=f[0][1];y<h&&(y=h,x=r.isoval(f,y));let b="M"+ze(H(y*m))+" "+ze(_(x)+l);for(let t=1;t<f.length&&(y=f[t][0],x=f[t][1],y<h||(y>p&&(y=p,x=r.isoval(f,y)),b+=" L"+ze(H(y*m))+" "+ze(_(x)+l),!(f[t][0]>p)));t++);if(-1==d)b+=" L"+ze(H(p*m))+" "+ze(_(r.isoval(f,p))+l),b+=" L"+ze(H(p*m))+" "+ze(_(c)),b+=" L"+ze(H(h*m))+" "+ze(_(c)),b+=" Z";else if(-2==d)b+=" L"+H(p*m)+" "+ze(_(r.isoval(f,p))+l),b+=" L"+ze(H(p*m))+" "+ze(_(u)),b+=" L"+ze(H(h*m))+" "+ze(_(u)),b+=" Z";else if(s!=d){const t=ke(d),e=t.length;let a=t[e-1][0],n=t[e-1][1];a>p&&(a=p,n=r.isoval(t,a)),b+=" L"+ze(H(a*m))+" "+ze(_(n)+l);for(let o=e-2;o>=0&&(a=t[o][0],n=t[o][1],a>p||(a<h&&(a=h,n=r.isoval(t,a)),b+=" L"+ze(H(a*m))+" "+ze(_(n)+l),!(t[o][0]<h)));o--);b+=" Z"}a.empty()?n.append("svg:path").attr("class","ybhp "+t).attr("id",o).attr("d",b).attr("fill",e[2]).attr("fill-opacity",e[5]).attr("stroke",e[3]).attr("stroke-width",e[4]):a.attr("d",b).attr("id",o).attr("fill",e[2]).attr("fill-opacity",e[5]).attr("stroke",e[3]).attr("stroke-width",e[4])}}function nr(){if(se||null==R.divGraph||0==ve.length)return;const e=dt.select(".pinkregion"),n=da(ve);let o=pe;R.roadEditor||(o=ve);const l=ge.asof,i=ge.horizon;let s;s=ge.yaw>0?ge.yMin-5*(ge.yMax-ge.yMin):ge.yMax+5*(ge.yMax-ge.yMin);const d="url(#pinkzonepat"+E+")",c=t.select(" #pinkzonepat"+E+" rect"),u=t.select(" #pinkzonepat"+E+" line");c.attr("fill",n||!R.roadEditor?a.Cols.PINK:"#ffbbbb"),u.style("stroke",n||!R.roadEditor?"#aaaaaa":"#666666");const h=r.findSeg(o,l),p=r.findSeg(o,i);let f="M"+H(l*m)+" "+_(r.rdf(o,l));for(let t=h;t<p;t++)f+=" L"+H(o[t].end[0]*m)+" "+_(o[t].end[1]);f+=" L"+H(i*m)+" "+_(r.rdf(o,i)),f+=" L"+H(i*m)+" "+_(s),f+=" L"+H(l*m)+" "+_(s),f+=" Z",ct.attr("patternTransform",ge.dir>0?"rotate(135)":"rotate(45)").attr("x",-ge.dir*H(l*m)),e.empty()?dt.append("svg:path").attr("class","pinkregion").attr("d",f).attr("fill-opacity",.4).attr("fill",d):e.attr("d",f).attr("fill",d)}function or(t,e,n,o,l,i){if(se||null==R.divGraph||0==ve.length)return;const s=n.select("."+o);if(null==l)return void s.remove();const c=R.oldRoadLine.dash+","+d(R.oldRoadLine.dash/2),u=i?c:null;let h=H(t[0].sta[0]*m),p=_(t[0].sta[1]+l),f=H(t[0].end[0]*m),g=_(t[0].end[1]+l);if(t[0].sta[0]<e.tini&&(h=H(e.tini*m),p=_(r.rdf(t,e.tini)+l)),i){const t=-H(e.tini*m)%d(1.5*R.oldRoadLine.dash);f!==h&&(p+=(-t-h)*(g-p)/(f-h)),(h<0||t>0)&&(h=-t)}let v="M"+ze(h)+" "+ze(p);for(const r of t){let t=a.daysnap(r.end[0]);if(f=H(r.end[0]*m),!(t<e.tini)){if(t>e.tfin)break;if(g=_(r.end[1]+l),v+=" L"+ze(f)+" "+ze(g),f>T.width)break}}s.empty()?n.append("svg:path").attr("class",o).attr("d",v).style("stroke-dasharray",u):s.attr("d",v).style("stroke-dasharray",u)}function lr(t,e){let a=[t[1][0]-t[0][0],t[1][1]-t[0][1]];const r=1/a[0],n=1/a[1],o=Math.sign(r),l=Math.sign(n),i=(e[0]-o*e[2]-t[0][0])*r,s=(e[1]-l*e[3]-t[0][1])*n,d=(e[0]+o*e[2]-t[0][0])*r,c=(e[1]+l*e[3]-t[0][1])*n;return!(i>c||s>d||(i>s?i:s)>1||(d<c?d:c)<0)}function ir(t,e){if(!t||!t.length)return!1;const r=e[0]-e[2],n=e[0]+e[2];let o=a.searchLow(t,t=>t[0]<r?-1:1),l=a.searchLow(t,t=>t[0]<n?-1:1);o<0&&(o=0),l>t.length-2&&(l=t.length-2);for(let a=o;a<=l;a++)if(lr([t[a],t[a+1]],e))return!0;return!1}let sr,dr=-1;function cr(t){const e=ke(t),n=[H.invert(0)/m,H.invert(T.width)/m],s=[_.invert(T.height),_.invert(0)],c=[(n[0]+n[1])/2,(s[0]+s[1])/2,(n[1]-n[0])/2,(s[1]-s[0])/2];if(t!=dr&&(dr=t,sr=Array(d(t)).fill().map((t,e)=>e)),ir(e,c)){const t=a.searchHigh(sr,t=>!function(t,e,n){if(!(t&&t.length&&e&&e.length))return!1;const o=n[0]-n[2],l=n[0]+n[2];if(i(r.isoval(t,o)-r.isoval(e,o))>1e-5||i(r.isoval(t,l)-r.isoval(e,l))>1e-5)return!1;let s=a.searchHigh(t,t=>t[0]<o?-1:1),d=a.searchLow(t,t=>t[0]<l?-1:1),c=a.searchHigh(e,t=>t[0]<o?-1:1),u=a.searchLow(e,t=>t[0]<l?-1:1);for(let a=s;a<d;a++)if(i(r.isoval(e,t[a][0])-t[a][1])>1e-5)return!1;for(let a=c;a<u;a++)if(i(r.isoval(t,e[a][0])-e[a][1])>1e-5)return!1;return!0}(e,ke(t),c)?-1:1);return l(t,sr.length-1)}const u=a.searchLow(sr,t=>ir(ke(t),c)?-1:1);return o(u,0)}function ur(){if(se||null==R.divGraph||0==ve.length)return;let t=gt.selectAll(".guides");if(R.roadEditor&&!R.showGuidelines)return void t.remove();let e=1;const n=[H.invert(0)/m,H.invert(T.width)/m],s=(t,e)=>(function(t,e){const n=ke(t);null==e&&(e=[-1/0,1/0]);let o=n[0][0],l=n[0][1];o<e[0]&&(o=e[0],l=r.isoval(n,o));let i="M"+ze(H(o*m))+" "+ze(_(l)),s=a.searchHigh(n,t=>t[0]<e[0]?-1:1),d=a.searchHigh(n,t=>t[0]<e[1]?-1:1);d>n.length-1&&(d=n.length-1);for(let t=s;t<=d;t++)i+=" L"+ze(H(n[t][0]*m))+" "+ze(_(n[t][1]));return i})(t,[o(ge.tini,n[0]),l(ge.tfin,n[1])]),c=function(t){let e=0;const a=l(R.maxFutureDays,d((ge.tfin-ge.tini)/h)),n=ke(0),o=ke(a);return e=ge.yaw*ge.dir>0?i(r.isoval(n,t[0])-r.isoval(o,t[0]))/a:i(r.isoval(n,t[1])-r.isoval(o,t[1]))/a}(n),u=i(_(0)-_(c));let p=cr((ge.tfin-ge.tini)/h);p=d(p/(e=u>8||p<42?1:7*u>8||p<168?7:28*u>12||p<672?28:112*u>12||p<2016?112:336));let f=sr.slice(0,p+1).map(t=>(t+1)*e-1);(t=t.data(f)).exit().remove(),t.enter().append("svg:path").attr("class","guides").attr("d",s).attr("id",t=>"g"+t).attr("transform",null),t.attr("d",s).attr("id",t=>"g"+t).attr("transform",null)}function hr(){se||null==R.divGraph||0==ve.length||or(ve,ge,vt,"maxflux",0!=ge.maxflux?ge.yaw*ge.maxflux:null,!1)}function pr(){se||null==R.divGraph||0==ve.length||or(ve,ge,yt,"stdflux",0!=ge.maxflux?ge.yaw*ge.stdflux:null,!0)}function fr(){if(!se&&null!=R.divGraph&&0!=ve.length){var e=bt.selectAll(".knots").data(ve),a=S.selectAll(".remove").data(ve);if(!R.roadEditor)return e.remove(),void a.remove();e.exit().remove(),e.attr("x1",function(t){return H(t.end[0]*m)}).attr("y1",0).attr("x2",function(t){return H(t.end[0]*m)}).attr("y2",T.height).attr("stroke","rgb(200,200,200)").attr("stroke-width",R.roadKnot.width),e.enter().append("svg:line").attr("class","knots").attr("id",function(t,e){return e}).attr("name",function(t,e){return"knot"+e}).attr("x1",function(t){return H(t.end[0]*m)}).attr("x2",function(t){return H(t.end[0]*m)}).attr("stroke","rgb(200,200,200)").attr("stroke-width",R.roadKnot.width).on("wheel",function(e){var a=new t.event.constructor(t.event.type,t.event);Kt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseover",function(e,a){Ia||Ja||Wa||Sa==r.RP.DATE&&a==La||(Qr(a,!0),t.select(this).attr("stroke-width",R.roadKnot.width+2))}).on("mouseout",function(e,a){Ia||Ja||Wa||Sa==r.RP.DATE&&a==La||(Qr(a,!1),t.select(this).attr("stroke-width",R.roadKnot.width))}).on("click",function(e,a){t.event.ctrlKey&&function(e,a){var n=Number(a),o=t.select(R.divTable);ve[n].auto==r.RP.DATE&&(R.keepSlopes?an(a):rn(a));var l,i,s=o.select("[name=enddate"+n+"]").node();s.focus(),document.body.createTextRange?((l=document.body.createTextRange()).moveToElementText(s),l.select()):window.getSelection&&(i=window.getSelection(),(l=document.createRange()).selectNodeContents(s),i.removeAllRanges(),i.addRange(l))}(0,this.id)}).call(t.drag().on("start",ja).on("drag",Za).on("end",Fa)),a.exit().remove(),a.attr("transform",function(t){return"translate("+(H(t.end[0]*m)+A.left-14*R.roadKnot.rmbtnscale)+","+(A.top-28*R.roadKnot.rmbtnscale-3)+") scale("+R.roadKnot.rmbtnscale+")"}).style("visibility",function(t,e){return e>0&&e<ve.length-2?"visible":"hidden"}),a.enter().append("use").attr("class","remove").attr("xlink:href","#removebutton").attr("id",function(t,e){return e}).attr("name",function(t,e){return"remove"+e}).attr("transform",function(t){return"translate("+(H(t.end[0]*m)+A.left-14*R.roadKnot.rmbtnscale)+","+(A.top-28*R.roadKnot.rmbtnscale-3)+") scale("+R.roadKnot.rmbtnscale+")"}).style("visibility",function(t,e){return e>0&&e<ve.length-2?"visible":"hidden"}).on("mouseenter",function(e,a){t.select(this).attr("fill",R.roadKnotCol.rmbtnsel),Qr(a,!0)}).on("mouseout",function(e,a){t.select(this).attr("fill",R.roadKnotCol.rmbtns),Qr(a,!1)}).on("click",qa)}}function gr(){if(!se&&null!=R.divGraph&&0!=ve.length){var e=St.selectAll(".roads").data(ve);R.roadEditor?(e.exit().remove(),e.attr("x1",function(t){return H(t.sta[0]*m)}).attr("y1",function(t){return _(t.sta[1])}).attr("x2",function(t){return H(t.end[0]*m)}).attr("y2",function(t){return _(t.end[1])}).attr("stroke-dasharray",function(t,e){return 0==e||e==ve.length-1?"3,3":"none"}).style("stroke",R.roadLineCol.invalid),e.enter().append("svg:line").attr("class","roads").attr("id",function(t,e){return e}).attr("name",function(t,e){return"road"+e}).attr("x1",function(t){return H(t.sta[0]*m)}).attr("y1",function(t){return _(t.sta[1])}).attr("x2",function(t){return H(t.end[0]*m)}).attr("y2",function(t){return _(t.end[1])}).style("stroke",R.roadLineCol.invalid).attr("stroke-dasharray",function(t,e){return 0==e||e==ve.length-1?"3,3":"none"}).attr("stroke-width",R.roadLine.width).on("wheel",function(e){var a=new t.event.constructor(t.event.type,t.event);Kt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseover",function(e,a){Ia||Ja||Wa||Sa==r.RP.SLOPE&&a==La||a>0&&a<ve.length-1&&(t.select(this).attr("stroke-width",R.roadLine.width+2),en(a,!0))}).on("mouseout",function(e,a){Ia||Ja||Wa||Sa==r.RP.SLOPE&&a==La||a>0&&a<ve.length-1&&(t.select(this).attr("stroke-width",R.roadLine.width),en(a,!1))}).on("click",function(e,a){t.event.ctrlKey&&function(e,a){var n=Number(a),o=t.select(R.divTable);e.auto==r.RP.SLOPE&&an(a);var l,i,s=o.select("[name=slope"+n+"]").node();s.focus(),document.body.createTextRange?((l=document.body.createTextRange()).moveToElementText(s),l.select()):window.getSelection&&(i=window.getSelection(),(l=document.createRange()).selectNodeContents(s),i.removeAllRanges(),i.addRange(l))}(e,this.id)}).call(t.drag().on("start",function(e,n){n>0&&n<ve.length-1&&function(e,n){t.event.sourceEvent.stopPropagation(),Wa=!0,a.daysnap(H.invert(t.event.x)/m),sa(),Da=r.copyRoad(ve),null==La?Ya(n):null!=La&&La==n&&Sa==r.RP.SLOPE?Ha():(Ha(),Ya(n));var o=(e.sta[0]+e.end[0])/2;o<H.invert(0)/m&&(o=H.invert(0)/m),o>H.invert(T.width)/m-10&&(o=H.invert(T.width)/m-10),Ea(e.end,[o,e.sta[1]+e.slope*(o-e.sta[0]),e.slope*ge.siru]),Ra.grp.raise()}(e,Number(this.id))}).on("drag",function(e,n){n>0&&n<ve.length-1&&function(e,n){Va(),ge.asof;var l=a.daysnap(H.invert(t.event.x)/m),i=_.invert(t.event.y),s=n,d=ve;ve[s].slope=(i-e.sta[1])/o(l-e.sta[0],h),ve[s].end[1]=ve[s].sta[1]+ve[s].slope*(ve[s].end[0]-ve[s].sta[0]),ve[s+1].sta[1]=ve[s].end[1],R.keepSlopes||(ve[s+1].slope=r.segSlope(ve[s+1])),r.fixRoadArray(d,r.RP.VALUE,!1,r.RP.SLOPE),Aa(s,!0);var c=(e.sta[0]+e.end[0])/2;c<H.invert(0)/m&&(c=H.invert(0)/m),c>H.invert(T.width)/m-10&&(c=H.invert(T.width)/m-10),Ta(e.end,[c,e.sta[1]+e.slope*(c-e.sta[0]),e.slope*ge.siru])}(e,Number(this.id))}).on("end",function(t,e){var a;e>0&&e<ve.length-1&&(a=Number(this.id),Wa=!1,null==La&&(Ka(a),Ma(),Ie()),Da=null)}))):e.remove()}}function vr(){be=se?ge.dtdarray:r.dtdarray(ve,ge),we=[];for(let t=0;t<7;t++)we[t]=r.isoline(ve,be,ge,t)}function yr(){se||null==R.divGraph||0==ve.length||R.roadEditor&&(da(ve)?Yt.attr("visibility","hidden"):Yt.attr("visibility","visible"))}function mr(){if(!se&&null!=R.divGraph){var e=Gt.selectAll(".dots").data(ve);R.roadEditor?(e.exit().remove(),e.attr("cx",function(t){return ze(H(t.sta[0]*m))}).attr("cy",function(t){return ze(_(t.sta[1]))}),e.enter().append("svg:circle").attr("class","dots").attr("id",function(t,e){return e-1}).attr("name",function(t,e){return"dot"+(e-1)}).attr("cx",function(t){return ze(H(t.sta[0]*m))}).attr("cy",function(t){return ze(_(t.sta[1]))}).attr("r",Re(R.roadDot.size)).attr("fill",R.roadDotCol.editable).style("stroke-width",R.roadDot.border).on("wheel",function(e){var a=new t.event.constructor(t.event.type,t.event);Kt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseover",function(e,a){Ia||Ja||Wa||Sa==r.RP.VALUE&&a-1==La||(tn(a-1,!0),t.select(this).attr("r",Re(R.roadDot.size+2)))}).on("mouseout",function(e,a){Ia||Ja||Wa||Sa==r.RP.VALUE&&a-1==La||(tn(a-1,!1),t.select(this).attr("r",Re(R.roadDot.size)))}).on("click",function(e,a){t.event.ctrlKey&&function(e,a){var n=Number(a),o=t.select(R.divTable);ve[n].auto==r.RP.VALUE&&rn(a);var l,i,s=o.select("[name=endvalue"+n+"]").node();s.focus(),document.body.createTextRange?((l=document.body.createTextRange()).moveToElementText(s),l.select()):window.getSelection&&(i=window.getSelection(),(l=document.createRange()).selectNodeContents(s),i.removeAllRanges(),i.addRange(l))}(0,this.id)}).call(t.drag().on("start",function(e,a){!function(e,a){t.event.sourceEvent.stopPropagation(),Ja=!0,sa(),Da=r.copyRoad(ve);var n=a;if(null==La?Oa(n):null!=La&&La==n&&Sa==r.RP.VALUE?Ha():(Ha(),Oa(n)),0!=n){var o=ve[n];Ea(e.sta,[(o.sta[0]+o.end[0])/2,(o.sta[1]+o.end[1])/2,o.slope*ge.siru])}else Ea(e.sta);za.grp.raise()}(e,Number(this.id))}).on("drag",function(e,a){!function(e,a){Va(),ge.asof;var n=_.invert(t.event.y),o=a,l=ve,i=ve[o];i.end[1]=n,i.slope=r.segSlope(i),r.fixRoadArray(l,R.keepSlopes?r.RP.VALUE:r.RP.SLOPE,!1,r.RP.VALUE),Aa(0==o?0:o-1,!1),0!=o?Ta(e.sta,[(i.sta[0]+i.end[0])/2,(i.sta[1]+i.end[1])/2,i.slope*ge.siru]):Ta(e.sta)}(e,Number(this.id))}).on("end",function(t,e){var a;a=Number(this.id),Ja=!1,null==La&&(Ua(a),Ma(),Ie()),Da=null}))):e.remove()}}let xr={};function br(t){let e="",a=r.dotcolor(ve,ge,t[0],t[1],we);return t[3]!=_t.DPTYPE.AGGPAST&&(e+=" fuda"),e+=xr[a]}xr[a.Cols.GRADOT]=" gra",xr[a.Cols.GRNDOT]=" grn",xr[a.Cols.BLUDOT]=" blu",xr[a.Cols.ORNDOT]=" orn",xr[a.Cols.REDDOT]=" red",xr[a.Cols.BLCK]=" blk";var wr,kr,zr,Rr,Er,Tr,Mr,Ar,Dr=null,Cr=null;function Pr(t){var n=H(a.daysnap(t[0])*m),o=_(t[1]),l=(null!=t[7]?"#"+t[7]+": ":"")+e.unix(t[0]).utc().format("YYYY-MM-DD")+", "+(null!=t[6]?a.shn(t[6]):a.shn(t[1]));null!=Cr&&Fe(Cr);var i=[];""!==t[2]&&i.push('"'+t[2]+'"'),null!==t[6]&&t[1]!==t[6]&&i.push("total:"+t[1]);var s=r.dotcolor(ve,ge,t[0],t[1],we);Cr=je(n,o-(15+18*i.length),l,s,i)}function Lr(){Fe(Cr)}function Sr(e,a,r,n=null,o=!0){let l;null==n&&(n=r),(l=e.selectAll("."+r).data(a)).exit().remove(),l.attr("cx",function(t){return ze(H(t[0]*m))}).attr("cy",function(t){return ze(_(t[1]))}).attr("class",n);var i=l.enter().append("svg:circle");i.attr("class",n).attr("cx",function(t){return ze(H(t[0]*m))}).attr("cy",function(t){return ze(_(t[1]))}),R.headless||i.on("wheel",function(e){var a=new t.event.constructor(t.event.type,t.event);Kt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseenter",function(t){null!=R.divData&&R.dataAutoScroll&&null!=t[7]&&function(t){if(!Ce.node().offsetParent)return;Ne=t;let e=Math.floor(R.dataTableSize/2),a=Math.max(0,Math.min(t-e,me.length-R.dataTableSize));Ge=a,Be(),Ke()}(t[7]),null!=Dr&&window.clearTimeout(Dr),Dr=window.setTimeout(function(){Pr(t),Dr=null},500)}).on("mouseout",function(){Ne=-1,Ke(),null!=Cr&&(Lr(),Cr=null),window.clearTimeout(Dr),Dr=null})}function Gr(){if(!se&&null!=R.divGraph&&!R.roadEditor){var t=[H.invert(0).getTime()/m,H.invert(T.width).getTime()/m],e=zt.selectAll(".rosy"),a=Rt.selectAll(".rd");if(R.showData||!R.roadEditor)if(ge.rosy){var r,n=(null!=_t.flad?_t.rosydata.slice(0,_t.rosydata.length-1):_t.rosydata).filter(function(e){return e[0]>=t[0]&&e[0]<=t[1]||e[4]>=t[0]&&e[4]<=t[1]});if(0==_t.rosydata.length){var o=-1;for(r=0;r<_t.rosydata.length-1;r++)if(_t.rosydata[r][0]<=t[0]&&_t.rosydata[r+1][0]>=t[1]){o=r;break}o>0&&(n=_t.rosydata.slice(o,o+2))}if(0!=n.length){let t="M"+ze(H(n[0][4]*m))+" "+ze(_(n[0][5]));for(r=0;r<n.length;r++)t+=" L"+ze(H(n[r][0]*m))+" "+ze(_(n[r][1]));e.empty()?zt.append("svg:path").attr("class","rosy").attr("d",t):e.attr("d",t)}else e.remove();Sr(Rt,n,"rd","rd",!0)}else e.remove(),a.remove();else e.remove(),a.remove()}}function Nr(){if(se||null==R.divGraph)return;const t=H.invert(0).getTime()/m,e=H.invert(T.width).getTime()/m,a=function(a){return a[0]>=t&&a[0]<=e||a[4]>=t&&a[4]<=e};let n=wt.selectAll(".steppy"),o=kt.selectAll(".std");if(R.showData||!R.roadEditor)if(!R.roadEditor&&ge.steppy&&0!==Jt.length){const o=Jt.filter(a);let l;if(0===o.length){let a=-1;for(l=0;l<Jt.length-1;l++)if(Jt[l][0]<=t&&Jt[l+1][0]>=e){a=l;break}a>0&&(o=Jt.slice(a,a+2))}if(0!==o.length){let a;if(Jt[0][0]>t&&Jt[0][0]<e&&Jt[0][0]in _t.allvals){const t=_t.allvals[Jt[0][0]][0][1];a="M"+ze(H(Jt[0][0]*m))+" "+ze(_(t)),a+="L"+ze(H(o[0][4]*m))+" "+ze(_(o[0][5]))}else a="M"+ze(H(o[0][4]*m))+" "+ze(_(o[0][5]));for(l=0;l<o.length;l++)a+=" L"+ze(H(o[l][0]*m))+" "+ze(_(o[l][5])),a+=" L"+ze(H(o[l][0]*m))+" "+ze(_(o[l][1]));n.empty()?wt.append("svg:path").attr("class","steppy").attr("d",a):n.attr("d",a);let i=wt.selectAll(".steppyppr");if(null!==_t.flad)if(ge.yaw*ge.dir<0&&ge.asof!==ge.tdat){const t=_t.flad[1]+r.ppr(ve,ge,ge.asof);a="M"+ze(H(o[o.length-1][0]*m))+" "+ze(_(o[o.length-1][1])),a+=" L"+ze(H(o[o.length-1][0]*m))+" "+ze(_(t)),i.empty()?wt.append("svg:path").attr("class","steppyppr").attr("d",a):i.attr("d",a)}else i.remove();else i.remove()}else n.remove();Sr(kt,_t.flad?o.slice(0,o.length-1):o,"std","std",!0)}else n.remove(),o.remove();else n.remove(),o.remove()}function Br(){if(!se&&null!=R.divGraph){var t,e=[H.invert(0).getTime()/m,H.invert(T.width).getTime()/m];if(R.showData||!R.roadEditor){var a=_t.derails.filter(function(t){return t[0]>=e[0]&&t[0]<=e[1]}),r=ge.yaw>0?"#downarrow":"#uparrow";(t=Mt.selectAll(".derails").data(a)).exit().remove(),t.attr("transform",function(t){return"translate("+H(t[0]*m)+","+_(t[1])+"),scale("+R.dataPoint.fsize*ae/24+")"}),t.enter().append("svg:use").attr("class","derails").attr("xlink:href",r).attr("transform",function(t){return"translate("+H(t[0]*m)+","+_(t[1])+"),scale("+R.dataPoint.fsize*ae/24+")"})}else(t=Mt.selectAll(".derails")).remove()}}function Or(){if(!se&&null!=R.divGraph&&0!=ve.length){var t=[H.invert(0).getTime()/m,H.invert(T.width).getTime()/m],e=function(e){return e[0]>=t[0]&&e[0]<=t[1]||e[4]>=t[0]&&e[4]<=t[1]};if(ge.asof,R.showData||!R.roadEditor){var a=null!=_t.flad?Jt.slice(0,Jt.length-1):Jt;a=a.filter(e),ge.plotall&&!R.roadEditor?Sr(At,Wt.filter(function(e){return e[0]>=t[0]&&e[0]<=t[1]}),"ap",t=>"ap"+br(t),!0):At.selectAll(".ap").remove(),R.roadEditor?Sr(Dt,a.concat(_t.fuda),"dp",t=>"dp"+br(t),!0):(Sr(Dt,a.concat(_t.fuda),"dp",t=>"dp"+br(t),!0),Sr(Ct,_t.hollow.filter(e),"hp",t=>"hp"+br(t),!0));var n=Pt.selectAll(".fladp");if(null!=_t.flad){const t=r.ppr(ve,ge,ge.asof),e=_t.flad[1]+t,a=0==t?1:.5;n.empty()?Pt.append("svg:use").attr("class","fladp").attr("xlink:href","#rightarrow").attr("fill",r.dotcolor(ve,ge,_t.flad[0],e,we)).attr("fill-opacity",a).attr("transform","translate("+H(_t.flad[0]*m)+","+_(e)+"),scale("+R.dataPoint.fsize*ae/24+")").style("pointer-events",function(){return R.roadEditor?"none":"all"}).on("mouseenter",function(){null!=Dr&&window.clearTimeout(Dr),Dr=window.setTimeout(function(){Pr(_t.flad),Dr=null},500)}).on("mouseout",function(){null!=Cr&&(Lr(),Cr=null),window.clearTimeout(Dr),Dr=null}):n.attr("fill",r.dotcolor(ve,ge,_t.flad[0],e,we)).attr("fill-opacity",a).attr("transform","translate("+H(_t.flad[0]*m)+","+_(e)+"),scale("+R.dataPoint.fsize*ae/24+")")}else n.empty()||n.remove()}else Dt.selectAll(".dp").remove(),(n=Dt.selectAll(".fladp")).remove()}}function Ur(){if(!se){var t=Et.selectAll(".movingav");if(!R.roadEditor&&ge.movingav&&R.showData){var e=[H.invert(0).getTime()/m,H.invert(T.width).getTime()/m],r=ge.filtpts.filter(function(t){return t[0]>e[0]-2*h&&t[0]<e[1]+2*h});if(r.length>0){var n="M"+ze(H(r[0][0]*m))+" "+ze(_(r[0][1]));for(let t=1;t<r.length;t++)n+=" L"+ze(H(r[t][0]*m))+" "+ze(_(r[t][1]));t.empty()?Et.append("svg:path").attr("class","movingav").attr("d",n).style("fill","none").attr("stroke-width",Re(3*ae)).style("stroke",a.Cols.PURP):t.attr("d",n).attr("stroke-width",Re(3*ae))}else t.remove()}else t.remove()}}function Yr(){t.select(R.divTable).attr("class","bmndrroad"),wr=t.select(R.divTable).select(".rtbmain"),kr=t.select(R.divTable).select(".rtable"),zr=kr.append("div").attr("class","roadbody")}function Kr(){var e,a;R.roadEditor?(e=["","Start Date","Value","",""],a=["","End Date","Value","Daily Slope",""]):(e=["","Start Date","Value",""],a=["","End Date","Value","Daily Slope"]),(Rr=t.select(R.divTable).select(".rtbstart")).append("div").attr("class","roadhdr").append("div").attr("class","roadhdrrow").selectAll("span.roadhdrcell").data(e).enter().append("span").attr("class","roadhdrcell").text(t=>t),Er=Rr.append("div").attr("class","roadbody"),(Tr=Rr.append("div").attr("class","roadhdr")).append("div").attr("class","roadhdrrow").selectAll("span.roadhdrcell").data(a).enter().append("span").attr("class","roadhdrcell").text(t=>t)}function Vr(){var e;e=R.roadEditor?["","Goal Date","Value","Daily Slope","",""]:["","Goal Date","Value","Daily Slope"],(Mr=t.select(R.divTable).select(".rtbgoal")).append("div").attr("class","roadhdr").append("div").attr("class","roadhdrrow").selectAll("span.roadhdrcell").data(e).enter().append("span").attr("class","roadhdrcell").text(t=>t),Ar=Mr.append("div").attr("class","roadbody")}var Hr=null,Ir=null,jr=null;function Zr(r,n){if(R.roadEditor){Hr=t.select(this),Ir=Hr.text(),0!=n&&null!=jr&&(jr.destroy(),jr=null),0==n&&k()&&(Hr.attr("contenteditable",!1),setTimeout(function(){Hr.attr("contenteditable",!0)},100));var o=Number(Hr.node().parentNode.id);if(null!=La&&Ha(),0==n){Na(o,!1),null!=jr&&(jr.destroy(),jr=null);var l=0==o?ge.xMin-10*h*u:ve[o].sta[0],i=o==ve.length-1?ve[o].end[0]:ve[o+1].end[0],s=e(Ir),d=e(e.unix(l).utc().format("YYYY-MM-DD")),c=e(e.unix(i).utc().format("YYYY-MM-DD"));(jr=new Pikaday({keyboardInput:!1,onSelect:function(t){var e=jr.toString(),r=a.dayparse(e,"-");e!==Ir&&(isNaN(r)||(Hr.text(e),Wr(Number(o),r),Ir=e,jr.destroy(),document.activeElement.blur()))},minDate:d.toDate(),maxDate:c.toDate()})).setMoment(s);var p=t.select(R.divTable).select(".floating"),f=this.getBoundingClientRect(),g=qt.node().getBoundingClientRect();p.style("left",f.right-g.left+"px").style("top",f.bottom+3-g.top+"px"),p.node().appendChild(jr.el,this)}else 1==n?Oa(o,!1):2==n&&Ya(o,!1)}}function Fr(e,r){if(R.roadEditor){var n=Number(this.parentNode.id),o=t.select(this).text();if(null!=jr&&(jr.destroy(),jr=null),Ha(),o!==Ir&&null!=Ir){var l=0==r?a.dayparse(o,"-"):o;if(isNaN(l))return t.select(this).text(Ir),Ir=null,void(Hr=null);0==r&&(Wr(n,l),Ha()),1==r&&(_r(n,l),Ha()),2==r&&(Xr(n,l),Ha()),Ir=null,Hr=null}}}function qr(e,r){if(13==t.event.keyCode){window.getSelection().removeAllRanges();var n=t.select(this).text(),o=0==r?a.dayparse(n,"-"):n;if(isNaN(o))return t.select(this).text(Ir),void(Ir=null);0==r&&Wr(Number(this.parentNode.id),o),1==r&&_r(Number(this.parentNode.id),o),2==r&&Xr(Number(this.parentNode.id),o),Ir=t.select(this).text()}}function Jr(e,a){var n=Number(this.parentNode.id);R.roadEditor&&a==ve[n].auto&&(0==a?an(n):1==a?rn(n):2==a&&function(e){ve[e].auto=r.RP.DATE;var a=t.select(R.divTable);a.select(".roadrow [name=enddate"+e+"]").style("color",R.roadTableCol.textDisabled).style("background-color",R.roadTableCol.bgDisabled).attr("contenteditable",!1),a.select(".roadrow [name=endvalue"+e+"]").style("color",R.roadTableCol.text).style("background-color",R.roadTableCol.bg).attr("contenteditable",R.roadEditor),a.select(".roadrow [name=slope"+e+"]").style("color",R.roadTableCol.text).style("background-color",R.roadTableCol.bg).attr("contenteditable",R.roadEditor),a.select(".roadrow [name=btndate"+e+"]").property("checked",!0),a.select(".roadrow [name=btnvalue"+e+"]").property("checked",!1),a.select(".roadrow [name=btnslope"+e+"]").property("checked",!1)}(n),this.focus())}function Wr(t,e){isNaN(e)?sn():function(t,e,n=!0){sa();var o=0==t?ge.xMin-10*h*u:ve[t].sta[0]+.01,l=t==ve.length-1?ve[t].end[0]+.01:ve[t+1].end[0]+.01;e<=o&&(e=a.daysnap(o)),e>=l&&(e=a.daysnap(o)),ve[t].end[0]=e,r.fixRoadArray(ve,null,n,r.RP.DATE),Ie()}(t,Number(e),!0)}function _r(t,e){isNaN(e)?sn():function(t,e,a=!1){sa(),ve[t].end[1]=e,a||(R.keepSlopes||(ve[t].slope=r.segSlope(ve[t])),1==t?ve[t-1].sta[1]=e:t==ve.length-1?(ve[t].end[1]=e,ve[t-1].slope=(ve[t].sta[1]-ve[t-1].sta[1])/(ve[t].sta[0]-ve[t-1].sta[0])):ve[t-1].slope=(ve[t].sta[1]-ve[t-1].sta[1])/(ve[t].sta[0]-ve[t-1].sta[0])),r.fixRoadArray(ve,R.keepSlopes?r.RP.VALUE:null,a,r.RP.VALUE),Ie()}(t,Number(e),!0)}function Xr(t,e){isNaN(e)?sn():function(t,e,a=!1){t!=ve.length-1&&(sa(),ve[t].slope=e/ge.siru,a||R.keepSlopes||(ve[t].end[1]=ve[t].sta[1]+ve[t].slope*(ve[t].end[0]-ve[t].sta[0]),ve[t+1].sta[1]=ve[t].end[1],ve[t+1].slope=r.segSlope(ve[t+1])),r.fixRoadArray(ve,null,a,r.RP.SLOPE),Ie())}(t,Number(e),!0)}function $r(t){if(R.tableAutoScroll&&null==La&&0!==R.tableHeight){let a=t.node().parentNode.getBoundingClientRect();if(0==a.height)return;var e=(t.data()[0].i-1)*(a.height+1);null!=R.divTable&&(wr.node().scrollTop=e-R.tableHeight/2)}}function Qr(e,a,r=!0){if(null==R.divTable)return;let n=a?R.roadTableCol.bgHighlight:0==ve[e].auto?R.roadTableCol.bgDisabled:R.roadTableCol.bg,o=t.select(R.divTable).select(".roadrow [name=enddate"+e+"]");o.empty()||(o.style("background-color",n),r&&a&&$r(o))}function tn(e,a,r=!0){if(null!=R.divTable){var n=a?R.roadTableCol.bgHighlight:1==ve[e].auto?R.roadTableCol.bgDisabled:R.roadTableCol.bg,o=t.select(R.divTable).select(".roadrow [name=endvalue"+e+"]");o.empty()||(o.style("background-color",n),r&&a&&$r(o))}}function en(e,a,r=!0){if(null!=R.divTable){var n=a?R.roadTableCol.bgHighlight:2==ve[e].auto?R.roadTableCol.bgDisabled:R.roadTableCol.bg,o=t.select(R.divTable).select(".roadrow [name=slope"+e+"]");o.empty()||(o.style("background-color",n),r&&a&&$r(o))}}function an(e){ve[e].auto=r.RP.VALUE;var a=t.select(R.divTable);a.select(".roadrow [name=enddate"+e+"]").style("color",R.roadTableCol.text).style("background-color",R.roadTableCol.bg).attr("contenteditable",R.roadEditor),a.select(".roadrow [name=endvalue"+e+"]").style("color",R.roadTableCol.textDisabled).style("background-color",R.roadTableCol.bgDisabled).attr("contenteditable",!1),a.select(".roadrow [name=slope"+e+"]").style("color",R.roadTableCol.text).style("background-color",R.roadTableCol.bg).attr("contenteditable",R.roadEditor),a.select(".roadrow [name=btndate"+e+"]").property("checked",!1),a.select(".roadrow [name=btnvalue"+e+"]").property("checked",!0),a.select(".roadrow [name=btnslope"+e+"]").property("checked",!1)}function rn(e){ve[e].auto=r.RP.SLOPE;var a=t.select(R.divTable);a.select(".roadrow [name=enddate"+e+"]").style("color",R.roadTableCol.text).style("background-color",R.roadTableCol.bg).attr("contenteditable",R.roadEditor),a.select(".roadrow [name=endvalue"+e+"]").style("color",R.roadTableCol.text).style("background-color",R.roadTableCol.bg).attr("contenteditable",R.roadEditor),a.select(".roadrow [name=slope"+e+"]").style("color",R.roadTableCol.textDisabled).style("background-color",R.roadTableCol.bgDisabled).attr("contenteditable",!1),a.select(".roadrow [name=btndate"+e+"]").property("checked",!1),a.select(".roadrow [name=btnvalue"+e+"]").property("checked",!1),a.select(".roadrow [name=btnslope"+e+"]").property("checked",!0)}function nn(){if(null!=R.divTable){var e=t.select(R.divTable).selectAll(".rtbstart .roadrow, .rtable .roadrow, .rtbgoal .roadrow"),a=e.selectAll(".roadbtn").data(function(t,e){var a;return[{order:8,row:a=R.reverseTable?ve.length-2-e:e,name:"btndel"+a,evt:()=>wa(a,!1),type:"button",txt:"del",auto:!1},{order:9,row:a,name:"btnadd"+a,evt:()=>(function(t){if(t<ve.length-1){var e=(ve[t].sta[0]+ve[t+1].sta[0])/2;e-ve[t].sta[0]>30*h&&(e=ve[t].sta[0]+30*h),ba(e)}else ba(ve[t].sta[0]+7*h)})(a+1),type:"button",txt:"ins",auto:!1}]});a.enter().append("input").attr("class","roadbtn").attr("id",t=>t.row).attr("name",t=>t.name).attr("type",t=>t.type).attr("value",t=>t.txt).on("click",t=>t.evt()),a.exit().remove(),(a=e.selectAll(".rtbstart .roadbtn, .rtable .roadbtn, .rtbgoal .roadbtn")).attr("id",t=>t.row).attr("name",t=>t.name).style("visibility",(t,e)=>Number(t.row)>0&&Number(t.row)<ve.length-2||4==e||e>0&&Number(t.row)>0?"visible":"hidden").property("checked",t=>!!t.auto),e.selectAll(".roadcell, .roadbtn").sort((e,a)=>t.ascending(e.order,a.order)),R.roadEditor||e.selectAll(".roadbtn").style("display","none").attr("value","")}}function on(t,e,n,o){var l=ve.slice(e,n);o&&(l=l.reverse());var i=t.selectAll(".roadrow").data(l),s=t=>o?ve.length-2-t:t;i.enter().append("div").attr("class","roadrow").attr("name",(t,a)=>"roadrow"+s(e+a)).attr("id",(t,a)=>s(e+a)).append("div").attr("class","rowid").text((t,a)=>s(e+a)+":"),i.exit().remove(),i.order(),(i=t.selectAll(".roadrow")).attr("name",(t,a)=>"roadrow"+s(e+a)).attr("id",(t,a)=>s(e+a)),i.select("div").text((t,a)=>s(e+a)+":");var d=i.selectAll(".roadcell").data((t,n)=>{var o=a.dayify(t.end[0],"-"),l=s(e+n);return[{order:2,value:o,name:"enddate"+l,auto:t.auto==r.RP.DATE,i:l},{order:4,value:a.shn(t.end[1]),name:"endvalue"+l,auto:t.auto==r.RP.VALUE,i:l},{order:6,value:isNaN(t.slope)?"duplicate":a.shn(t.slope*ge.siru),name:"slope"+l,auto:t.auto==r.RP.SLOPE,i:l}]});d.enter().append("div").attr("class","roadcell").attr("name",t=>t.name).attr("contenteditable",(t,e)=>t.auto||!R.roadEditor?"false":"true").on("click",Jr).on("focusin",Zr).on("focusout",Fr).on("keydown",qr),d.exit().remove(),(d=i.selectAll(".roadcell")).text((t,e)=>t.value).attr("name",t=>t.name).style("color",t=>ve[t.i].sta[0]==ve[t.i].end[0]&&ve[t.i].sta[1]==ve[t.i].end[1]?R.roadLineCol.invalid:t.auto?R.roadTableCol.textDisabled:R.roadTableCol.text).style("background-color",function(t){return t.auto?R.roadTableCol.bgDisabled:R.roadTableCol.bg}).attr("contenteditable",function(t,e){return t.auto||!R.roadEditor?"false":"true"})}function ln(){if(null!=R.divTable&&!ce)if(ve.length>3){if(!zr.node().offsetParent)return;t.select(R.divTable).style("width",zr.node().offsetWidth+35+"px")}else{if(!Ar.node().offsetParent)return;t.select(R.divTable).style("width",Ar.node().offsetWidth+35+"px")}}function sn(){if(null!=R.divTable){var e=R.reverseTable;on(Er,0,1,!1),Er.select("[name=slope0]").style("visibility","hidden").style("pointer-events","none").style("border","1px solid transparent"),on(zr,1,ve.length-2,e),on(Ar,ve.length-2,ve.length-1,!1),ve.length<=3?(Tr.style("visibility","collapse"),t.select(R.divTable).select(".rtbmain").style("display","none")):(Tr.style("visibility",null),t.select(R.divTable).select(".rtbmain").style("display",null)),ln()}}function dn(){sn(),nn(),ln()}function cn(){null!=R.divGraph&&(R.showContext?(U.attr("visibility","visible"),function(){if(!se&&null!=R.divGraph&&0!=ve.length){var t=K.selectAll(".ctxoldroads"),e=pe;R.roadEditor||(e=ve);var r="M"+ze(at(e[0].sta[0]*m))+" "+ze(ot(e[0].sta[1]));for(let t=0;t<e.length;t++)r+=" L"+ze(at(e[t].end[0]*m))+" "+ze(ot(e[t].end[1]));t.empty()?K.append("svg:path").attr("class","ctxoldroads").attr("d",r).style("stroke-dasharray",R.roadEditor?R.oldRoadLine.ctxdash+","+d(R.oldRoadLine.ctxdash/2):null).style("fill","none").style("stroke-width",R.oldRoadLine.ctxwidth).style("stroke",R.roadEditor?a.Cols.ORNG:a.Cols.RAZR0):t.attr("d",r).style("stroke-dasharray",R.roadEditor?R.oldRoadLine.ctxdash+","+d(R.oldRoadLine.ctxdash/2):null).style("stroke",R.roadEditor?a.Cols.ORNG:a.Cols.RAZR0)}}(),function(){if(!se&&null!=R.divGraph&&0!=ve.length){var t=R.roadEditor?x.beyey:x.beye,e=K.select(".ctxoldbullseye"),a=at(pe[pe.length-1].sta[0]*m)-R.bullsEye.ctxsize/2,r=ot(pe[pe.length-1].sta[1])-R.bullsEye.ctxsize/2;e.empty()?K.append("svg:image").attr("class","ctxoldbullseye").attr("xlink:href",t).attr("externalResourcesRequired",!0).attr("x",a).attr("y",r).attr("width",R.bullsEye.ctxsize).attr("height",R.bullsEye.ctxsize):e.attr("x",a).attr("y",r)}}(),tr(),function(){if(!se&&null!=R.divGraph&&0!=ve.length){var t=da(ve)?R.roadLineCol.valid:R.roadLineCol.invalid,e=K.selectAll(".ctxroads").data(ve);R.roadEditor?(e.exit().remove(),e.attr("x1",function(t){return at(t.sta[0]*m)}).attr("y1",function(t){return ot(t.sta[1])}).attr("x2",function(t){return at(t.end[0]*m)}).attr("y2",function(t){return ot(t.end[1])}).style("stroke",t),e.enter().append("svg:line").attr("class","ctxroads").attr("id",function(t,e){return e}).attr("name",function(t,e){return"ctxroad"+e}).attr("x1",function(t){return at(t.sta[0]*m)}).attr("y1",function(t){return ot(t.sta[1])}).attr("x2",function(t){return at(t.end[0]*m)}).attr("y2",function(t){return ot(t.end[1])}).style("stroke",t).style("stroke-width",R.roadLine.ctxwidth)):e.remove()}}(),function(){if(!se&&null!=R.divGraph){var t=K.selectAll(".ctxdots").data(ve);R.roadEditor?(t.exit().remove(),t.attr("cx",function(t){return ze(at(t.sta[0]*m))}).attr("cy",function(t){return ze(ot(t.sta[1]))}),t.enter().append("svg:circle").attr("class","ctxdots").attr("r",Re(R.roadDot.ctxsize)).attr("fill",R.roadDotCol.editable).style("stroke-width",R.roadDot.ctxborder).attr("cx",function(t){return ze(at(t.sta[0]*m))}).attr("cy",function(t){return ze(ot(t.sta[1]))})):t.remove()}}(),function(){if(se||null==R.divGraph||0==ve.length)return;const t=K.select(".ctxhorizon"),e=R.horizon;t.empty()?K.append("svg:line").attr("class","ctxhorizon").attr("x1",at(ge.horizon*m)).attr("y1",ot(ge.yMin-5*(ge.yMax-ge.yMin))).attr("x2",at(ge.horizon*m)).attr("y2",ot(ge.yMax+5*(ge.yMax-ge.yMin))).style("stroke",a.Cols.AKRA).style("stroke-dasharray",e.ctxdash+","+e.ctxdash).style("stroke-width",Re(e.ctxwidth)):t.attr("x1",at(ge.horizon*m)).attr("y1",ot(ge.yMin-5*(ge.yMax-ge.yMin))).attr("x2",at(ge.horizon*m)).attr("y2",ot(ge.yMax+5*(ge.yMax-ge.yMin)));var r=at(ge.horizon*m)+12,n=M.height/2,o=K.select(".ctxhortext");o.empty()?K.append("svg:text").attr("class","ctxhortext").attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")").attr("fill",a.Cols.AKRA).style("font-size",e.ctxfont+"px").text("Horizon"):o.attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")")}(),function(){if(!se&&null!=R.divGraph&&0!=ve.length){var t=K.select(".ctxtoday"),e=K.select(".ctxtodaytext");if(!R.roadEditor)return t.remove(),void e.remove();t.empty()?K.append("svg:line").attr("class","ctxtoday").attr("x1",at(ge.asof*m)).attr("y1",0).attr("x2",at(ge.asof*m)).attr("y2",M.height).style("stroke","rgb(0,0,200)").style("stroke-width",Re(R.horizon.ctxwidth)):t.attr("x1",at(ge.asof*m)).attr("y1",0).attr("x2",at(ge.asof*m)).attr("y2",M.height);var a=at(ge.asof*m)-5,r=M.height/2;e.empty()?K.append("svg:text").attr("class","ctxtodaytext").attr("x",a).attr("y",r).attr("transform","rotate(-90,"+a+","+r+")").attr("fill","rgb(0,0,200)").style("font-size",R.today.ctxfont+"px").text("Today"):e.attr("x",a).attr("y",r).attr("transform","rotate(-90,"+a+","+r+")")}}(),R.showFocusRect?Ft.attr("visibility","visible"):Ft.attr("visibility","hidden")):(U.attr("visibility","hidden"),Ft.attr("visibility","hidden")))}function un(n=!1){if(null==R.divGraph)return;Ha();const o=[H.invert(0).getTime()/m,H.invert(T.width).getTime()/m];var l;n&&(re=0),(ae=R.roadEditor?a.clip(a.rescale(o[1],o[0],o[0]+73*h,1,.7),.7,1):a.clip(a.rescale(o[1],o[0],o[0]+73*h,1,.55),.55,1))!=re&&function(){let e="",r="#svg"+E+" ",n="pointer-events:"+(R.headless?"none;":"all;");e+=r+".rd {r:"+Re(R.dataPoint.size*ae)+"px} ",e+=r+".std {r:"+Re((R.dataPoint.size+2)*ae)+"px} ",e+=r+".ap {r:"+Re(.7*R.dataPoint.size*ae)+"px;"+n+"} ",e+=r+".hp {r:"+Re(R.dataPoint.hsize*ae)+"px;"+n+"} ",e+=r+".guides {stroke-width:"+Re(R.guidelines.width*ae)+"px} ",e+=r+".rosy {stroke-width:"+Re(4*ae)+"px} ",e+=r+".steppy {stroke-width:"+Re(4*ae)+"px} ",e+=r+".steppyppr {stroke-width:"+Re(4*ae)+"px} ",e+=r+".maxflux {fill:none;stroke:"+a.Cols.BIGG+";stroke-width:"+Re(R.maxfluxline*ae)+"px} ",e+=r+".stdflux {fill:none;stroke:"+a.Cols.BIGG+";stroke-width:"+Re(R.stdfluxline*ae)+"px} ",R.roadEditor?(e+=r+".dp {r:"+Re(R.dataPoint.size*ae)+"px;stroke:"+R.dataPointCol.stroke+";stroke-width:"+Re(R.dataPoint.border*ae)+"px} ",e+=r+".razr {fill:none;pointer-events:none;stroke-width:"+Re(R.razrline*ae)+"px;stroke:"+a.Cols.RAZR0+"} "):(e+=r+".dp {r:"+Re(R.dataPoint.size*ae)+"px;stroke:rgb(0,0,0);stroke-width:"+Re(1*ae)+"px} ",e+=r+".dp.fuda {stroke-width:"+Re(.5*ae)+"px} ",e+=r+".razr {fill:none;pointer-events:none;stroke-width:"+Re(R.razrline*ae)+"px;stroke:"+a.Cols.REDDOT+"} "),t.select("style#dynstyle"+E).text(e)}(),yr(),er(),function(){if(!se&&null!=R.divGraph&&0!=ve.length){var t=lt.select(".past");R.roadEditor?t.empty()?lt.insert("svg:rect",":first-child").attr("class","past").attr("x",H(ge.xMin)).attr("y",_(ge.yMax+3*(ge.yMax-ge.yMin))).attr("width",H(ge.asof*m)-H(ge.xMin)).attr("height",7*i(_(ge.yMin)-_(ge.yMax))).attr("fill",R.pastBoxCol.fill).attr("fill-opacity",R.pastBoxCol.opacity):t.attr("x",H(ge.xMin)).attr("y",_(ge.yMax+3*(ge.yMax-ge.yMin))).attr("width",H(ge.asof*m)-H(ge.xMin)).attr("height",7*i(_(ge.yMin)-_(ge.yMax))):t.remove()}}(),rr(),nr(),ur(),se||null==R.divGraph||0==ve.length||(R.roadEditor?or(pe,fe,mt,"razr",0,!0):or(ve,ge,mt,"razr",0,!1)),hr(),pr(),function(){if(!se&&null!=R.divGraph&&0!=ve.length){var t=xt.select(".oldbullseye");if(R.roadEditor){var e=R.roadEditor?x.beyey:x.beye,a=H(fe.tfin*m)-R.bullsEye.size/2,n=_(r.rdf(pe,fe.tfin))-R.bullsEye.size/2;t.empty()?xt.append("svg:image").attr("class","oldbullseye").attr("xlink:href",e).attr("externalResourcesRequired",!0).attr("x",a).attr("y",n).attr("width",R.bullsEye.size).attr("height",R.bullsEye.size):t.attr("x",a).attr("y",n)}else t.remove()}}(),Qa(),fr(),Or(),Br(),Gr(),Nr(),se||null==R.divGraph||(R.roadEditor?(l=Bt.selectAll(".hashtag")).remove():((l=Bt.selectAll(".hashtag").data(_t.hashtags)).exit().remove(),l.attr("x",function(t){return H(t[0]*m)}).attr("transform",t=>"rotate(-90,"+H(t[0]*m)+","+T.height/2+")").text(t=>t[1]),l.enter().append("svg:text").attr("class","hashtag").attr("x",t=>H(t[0]*m)).attr("y",T.height/2).attr("transform",t=>"rotate(-90,"+H(t[0]*m)+","+T.height/2+")").attr("fill",a.Cols.BLACK).style("font-size",R.horizon.font+"px").text(t=>t[1]))),Ur(),gr(),mr(),function(){if(se||null==R.divGraph||0==ve.length)return;const t=Ot.select(".horizon"),e=R.horizon;t.empty()?Ot.append("svg:line").attr("class","horizon").attr("x1",H(ge.horizon*m)).attr("y1",0).attr("x2",H(ge.horizon*m)).attr("y2",T.height).style("stroke",a.Cols.AKRA).style("stroke-dasharray",e.dash+","+e.dash).attr("stroke-width",Re(e.width*ae)):t.attr("x1",H(ge.horizon*m)).attr("y1",0).attr("x2",H(ge.horizon*m)).attr("y2",T.height).attr("stroke-width",Re(e.width*ae));var r=H(ge.horizon*m)+14,n=T.height/2,o=Ut.select(".horizontext");o.empty()?Ut.append("svg:text").attr("class","horizontext").attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")").attr("fill",a.Cols.AKRA).style("font-size",e.font+"px").text("Akrasia Horizon"):o.attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")")}(),function(){if(!se&&null!=R.divGraph&&0!=ve.length&&0!=_t.oresets.length){var t=pt.selectAll(".oresets").data(_t.oresets);R.roadEditor?t.remove():(t.exit().remove(),t.attr("x1",function(t){return H(t*m)}).attr("y1",0).attr("x2",function(t){return H(t*m)}).attr("y2",T.height),t.enter().append("svg:line").attr("class","oresets").attr("id",function(t,e){return e}).attr("name",function(t,e){return"oreset"+e}).attr("x1",function(t){return H(t*m)}).attr("y1",0).attr("x2",function(t){return H(t*m)}).attr("y2",T.height).attr("stroke","rgb(200,200,200)").style("stroke-dasharray",R.odomReset.dash+","+R.odomReset.dash).attr("stroke-width",R.odomReset.width))}}(),function(){if(!se&&null!=R.divGraph&&0!=ve.length){var t=ht.select(".pastline"),r=ft.select(".pasttext");if(!R.roadEditor)return t.remove(),void r.remove();t.empty()?ht.append("svg:line").attr("class","pastline").attr("x1",H(ge.asof*m)).attr("y1",0).attr("x2",H(ge.asof*m)).attr("y2",T.height).style("stroke",a.Cols.AKRA).style("stroke-width",Re(R.today.width)):t.attr("x1",H(ge.asof*m)).attr("y1",0).attr("x2",H(ge.asof*m)).attr("y2",T.height);var n=H(ge.asof*m)-8,o=T.height/2;r.empty()?ft.append("svg:text").attr("class","pasttext").attr("x",n).attr("y",o).attr("transform","rotate(-90,"+n+","+o+")").attr("fill",a.Cols.AKRA).style("font-size",R.horizon.font+"px").text("Today ("+e.unix(ge.asof).utc().format("ddd")+")"):r.attr("x",n).attr("y",o).attr("transform","rotate(-90,"+n+","+o+")").text("Today ("+e.unix(ge.asof).utc().format("ddd")+")")}}(),ar(),Kt.attr("color",r.dotcolor(ve,ge,ge.tcur,ge.vcur,we)),re=ae}!function(){var e=R.divGraph;if(null!==e){for(;e.firstChild;)e.removeChild(e.firstChild);P=t.select(e).attr("class","bmndrgraph").append("svg:svg").attr("id","svg"+E).attr("xmlns","http://www.w3.org/2000/svg").attr("xmlns:xlink","http://www.w3.org/1999/xlink").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+$t+" "+Qt).attr("width","100%").attr("height","100%").attr("class","bmndrsvg"),(L=P.append("defs")).insert("style").attr("type","text/css").text(v),L.insert("style").attr("id","dynstyle"+E).attr("type","text/css").text(""),L.append("clipPath").attr("id","plotclip"+E).append("rect").attr("x",0).attr("y",0).attr("width",T.width).attr("height",T.height),L.append("clipPath").attr("id","brushclip"+E).append("rect").attr("x",0).attr("y",0).attr("width",M.width).attr("height",M.height),L.append("clipPath").attr("id","buttonareaclip"+E).append("rect").attr("x",T.x).attr("y",0).attr("width",T.width).attr("height",A.top),L.append("path").style("stroke","none").attr("id","rightarrow").attr("d","M 55,0 -35,45 -35,-45 z"),L.append("path").style("stroke","none").attr("id","downarrow").attr("d","M 0,40 45,-50 -45,-50 z"),L.append("path").style("stroke","none").attr("id","uparrow").attr("d","M 0,-40 45,50 -45,50 z"),(ct=L.append("pattern").attr("id","pinkzonepat"+E).attr("x",0).attr("y",0).attr("width",10).attr("height",10).attr("patternTransform","rotate(45)").attr("patternUnits","userSpaceOnUse")).append("rect").attr("x",0).attr("y",0).attr("width",10).attr("height",10).attr("fill",a.Cols.PINK),ct.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",10).style("stroke","#aaaaaa").style("stroke-width",1),(ut=L.append("pattern").attr("id","tapepat"+E).attr("x",0).attr("y",0).attr("width",20).attr("height",20).attr("patternTransform","rotate(45)").attr("patternUnits","userSpaceOnUse")).append("rect").attr("x",0).attr("y",0).attr("width",20).attr("height",20).attr("fill","#ffffff"),ut.append("line").attr("x1",0).attr("y1",0).attr("x2",20).attr("y2",0).style("stroke","#ff5555").style("stroke-width",25);var r=L.append("g").attr("id","removebutton");r.append("circle").attr("cx",14).attr("cy",14).attr("r",16).attr("fill","white"),r.append("path").attr("d","M13.98,0C6.259,0,0,6.261,0,13.983c0,7.721,6.259,13.982,13.98,13.982c7.725,0,13.985-6.262,13.985-13.982C27.965,6.261,21.705,0,13.98,0z M19.992,17.769l-2.227,2.224c0,0-3.523-3.78-3.786-3.78c-0.259,0-3.783,3.78-3.783,3.78l-2.228-2.224c0,0,3.784-3.472,3.784-3.781c0-0.314-3.784-3.787-3.784-3.787l2.228-2.229c0,0,3.553,3.782,3.783,3.782c0.232,0,3.786-3.782,3.786-3.782l2.227,2.229c0,0-3.785,3.523-3.785,3.787C16.207,14.239,19.992,17.769,19.992,17.769z");var n=L.append("g").attr("id","zoominbtn");!R.headless&&R.buttonZoom&&(n.append("path").style("fill","white").attr("d","m 530.86356,264.94116 a 264.05649,261.30591 0 1 1 -528.1129802,0 264.05649,261.30591 0 1 1 528.1129802,0 z"),n.append("path").attr("d","m 308.21,155.10302 -76.553,0 0,76.552 -76.552,0 0,76.553 76.552,0 0,76.552 76.553,0 0,-76.552 76.552,0 0,-76.553 -76.552,0 z m 229.659,114.829 C 537.869,119.51007 420.50428,1.9980234 269.935,1.9980234 121.959,1.9980234 2.0000001,121.95602 2.0000001,269.93202 c 0,147.976 117.2473599,267.934 267.9339999,267.934 150.68664,0 267.935,-117.51205 267.935,-267.934 z m -267.935,191.381 c -105.681,0 -191.381,-85.7 -191.381,-191.381 0,-105.681 85.701,-191.380996 191.381,-191.380996 105.681,0 191.381,85.700996 191.381,191.380996 0,105.681 -85.7,191.381 -191.381,191.381 z"));var o=L.append("g").attr("id","zoomoutbtn");!R.headless&&R.buttonZoom&&(o.append("path").style("fill","white").attr("d","m 530.86356,264.94116 a 264.05649,261.30591 0 1 1 -528.1129802,0 264.05649,261.30591 0 1 1 528.1129802,0 z"),o.append("path").attr("d","m 155.105,231.65502 0,76.553 229.657,0 0,-76.553 c -76.55233,0 -153.10467,0 -229.657,0 z m 382.764,38.277 C 537.869,119.51007 420.50428,1.9980234 269.935,1.9980234 121.959,1.9980234 2.0000001,121.95602 2.0000001,269.93202 c 0,147.976 117.2473599,267.934 267.9339999,267.934 150.68664,0 267.935,-117.51205 267.935,-267.934 z m -267.935,191.381 c -105.681,0 -191.381,-85.7 -191.381,-191.381 0,-105.681 85.701,-191.380996 191.381,-191.380996 105.681,0 191.381,85.700996 191.381,191.380996 0,105.681 -85.7,191.381 -191.381,191.381 z")),(Kt=P.append("rect").attr("class","zoomarea").attr("x",T.x).attr("y",T.y).attr("color",a.Cols.REDDOT).attr("width",T.width).attr("height",T.height)).on("wheel.scroll");var l={shown:!1,timeout:null};if(Kt.on("wheel.scroll",function(){if(null!=l.timeout&&(clearTimeout(l.timeout),l.timeout=null),t.event.ctrlKey)return Ae("zoominfo",!0,O),void(l.shown=!1);l.shown||(Me(["Use ctrl+scroll to zoom"],-1,"normal",{x:0,y:0,w:T.width,h:T.height},"zoominfo",!1,!0,O),l.shown=!0),l.timeout=setTimeout(()=>{Ae("zoominfo",!0),l.shown=!1},1e3)},{passive:!1}),Kt.on("mousedown.move",function(){null!=l.timeout&&(clearTimeout(l.timeout),l.timeout=null),Ae("zoominfo",!0),l.shown=!1}),Vt=t.zoom().extent([[0,0],[T.width,T.height]]).scaleExtent([1,1/0]).translateExtent([[0,0],[T.width,T.height]]).filter(function(){return"wheel"!=t.event.type||t.event.ctrlKey}).on("zoom",ra),Kt.call(Vt),k()){var i,s=null,d=Kt.on("touchstart.zoom"),c=Kt.on("touchmove.zoom"),u=Kt.on("touchend.zoom");Kt.on("touchstart.zoom",function(){var e=this.getBoundingClientRect();i=t.event.touches.item(0).pageX-e.left;var a=H.invert(i);null==s&&1==t.event.touches.length&&(s=window.setTimeout(()=>{null!=a&&ba(a/m)},1e3)),d.apply(this,arguments)}).on("touchmove.zoom",function(){window.clearTimeout(s),s=null,c.apply(this,arguments)}).on("touchend.zoom",function(){clearTimeout(s),s=null,u.apply(this,arguments)})}R.roadEditor?(Kt.on("click",function(){t.event.shiftKey?h():Ha()}),Kt.on("dblclick.zoom",h)):Kt.on("dblclick.zoom",null),N=P.append("g").attr("class","focus").attr("transform","translate("+R.focusRect.x+","+R.focusRect.y+")"),S=N.append("g").attr("clip-path","url(#buttonareaclip"+E+")").attr("class","buttonarea"),B=N.append("g").attr("class","focusclip").attr("clip-path","url(#plotclip"+E+")").attr("transform","translate("+A.left+","+A.top+")"),O=B.append("g").attr("class","plot"),G=N.append("svg:text").attr("x",$t/2).attr("y",15).attr("width",T.width).attr("class","svgtxt").style("font-size","80%").attr("text-anchor","middle"),lt=O.append("g").attr("id","pastboxgrp"),it=O.append("g").attr("id","ybhpgrp"),Nt=O.append("g").attr("id","wmarkgrp"),gt=O.append("g").attr("id","guidegrp"),vt=O.append("g").attr("id","maxfluxgrp"),yt=O.append("g").attr("id","stdfluxgrp"),st=O.append("g").attr("id","ybhplinesgrp"),mt=O.append("g").attr("id","razrgrp"),Tt=O.append("g").attr("id","auragrp"),dt=O.append("g").attr("id","pinkgrp"),xt=O.append("g").attr("id","oldbullseyegrp"),Lt=O.append("g").attr("id","bullseyegrp"),ht=O.append("g").attr("id","grid"),pt=O.append("g").attr("id","oresetgrp"),bt=O.append("g").attr("id","knotgrp"),wt=O.append("g").attr("id","steppygrp"),zt=O.append("g").attr("id","rosygrp"),Rt=O.append("g").attr("id","rosyptsgrp"),Mt=O.append("g").attr("id","derailsgrp"),At=O.append("g").attr("id","allptsgrp"),Et=O.append("g").attr("id","movingavgrp"),kt=O.append("g").attr("id","steppyptsgrp"),Dt=O.append("g").attr("id","datapointgrp"),Ct=O.append("g").attr("id","hollowgrp"),Pt=O.append("g").attr("id","flatlinegrp"),Bt=O.append("g").attr("id","hashtaggrp"),St=O.append("g").attr("id","roadgrp"),Gt=O.append("g").attr("id","dotgrp"),Ot=O.append("g").attr("id","horgrp"),Ut=O.append("g").attr("id","hortxtgrp"),ft=O.append("g").attr("id","pasttxtgrp"),(Yt=O.append("g").attr("visibility","hidden")).append("rect").attr("x",0).attr("y",0).attr("stroke-width",20).attr("stroke","url(#tapepat"+E+")").attr("fill","none"),Yt.append("text").attr("y",45).attr("paint-order","stroke").attr("stroke-width","2px").attr("stroke","#a00000").attr("font-size","35px").attr("text-anchor","middle").attr("fill","#ff0000").text("Error"),Ht=B.append("svg:use").attr("class","zoomin").attr("xlink:href","#zoominbtn").attr("opacity",R.zoomButton.opacity).attr("transform",C.botin).on("click",()=>{Kt.call(Vt.scaleBy,R.zoomButton.factor)}).on("mouseover",()=>{ue||t.select(this).style("fill","red")}).on("mouseout",(e,a)=>{t.select(this).style("fill","black")}),It=B.append("svg:use").attr("class","zoomout").attr("xlink:href","#zoomoutbtn").attr("opacity",R.zoomButton.opacity).attr("transform",C.botout).on("click",()=>{Kt.call(Vt.scaleBy,1/R.zoomButton.factor)}).on("mouseover",()=>{ue||t.select(this).style("fill","red")}).on("mouseout",(e,a)=>{t.select(this).style("fill","black")}),V=t.scaleUtc().range([0,T.width]),I=t.axisBottom(V).ticks(6),F=N.append("g").attr("class","axis").attr("transform","translate("+T.x+","+(A.top+T.height)+")").call(I),R.roadEditor||(Z=t.axisTop(V).ticks(6).tickFormat(""),J=ht.append("g").attr("class","grid").attr("transform","translate(0,"+T.height+")").call(Z),j=t.axisTop(V).ticks(6),q=N.append("g").attr("class","axis").attr("transform","translate("+T.x+","+A.top+")").call(j)),W=t.scaleLinear().range([T.height,0]),X=t.axisLeft(W).ticks(8).tickSize(6).tickSizeOuter(0),$=t.axisRight(W).ticks(8).tickSize(6).tickSizeOuter(0),Q=N.append("g").attr("class","axis").attr("transform","translate("+A.left+","+A.top+")").call(X),tt=N.append("g").attr("class","axis").attr("transform","translate("+(A.left+T.width)+","+A.top+")").call($),et=N.append("text").attr("class","axislabel").attr("transform","translate(15,"+(T.height/2+A.top)+") rotate(-90)").text(""),U=P.append("g").attr("class","brush").attr("transform","translate("+R.ctxRect.x+","+R.ctxRect.y+")"),Y=U.append("g").attr("clip-path","url(#brushclip"+E+")").attr("transform","translate("+D.left+","+D.top+")"),K=Y.append("g").attr("class","context"),at=t.scaleUtc().range([0,M.width]),rt=t.axisBottom(at).ticks(6),nt=U.append("g").attr("class","axis").attr("transform","translate("+M.x+","+(D.top+M.height)+")").call(rt),ot=t.scaleLinear().range([M.height,0]),jt=t.brushX().extent([[0,0],[M.width,M.height]]).on("brush",na),Zt=K.append("g").attr("class","brush").call(jt),Ft=Y.append("rect").attr("class","focusrect").attr("x",1).attr("y",1).attr("width",M.width-2).attr("height",M.height-2).attr("fill","none").style("stroke","black").style("stroke-width",1).style("stroke-dasharray","8,4,2,4"),H=V,_=W}function h(){var e=t.mouse(P.node());ba(H.invert(e[0]-A.left)/m)}}(),function(){var e=R.divTable;if(null!==e){for(;e.firstChild;)e.removeChild(e.firstChild);var a=t.select(e),r=(a.append("div").attr("class","rtbstart"),a.append("div").attr("class","rtbmain"));a.append("div").attr("class","rtbgoal"),0!=R.tableHeight&&r.style("max-height",R.tableHeight+"px").style("overflow-y","auto");var n=r.append("div").attr("class","rtable");n.append("div").attr("id","dpfloat").attr("class","floating"),qt=n.append("div").attr("id","topleft").style("position","absolute").style("left",0).style("top",0).style("width","1px").style("height","1px").attr("visibility","hidden"),R.reverseTable?(Vr(),Yr(),Kr()):(Kr(),Yr(),Vr())}}(),function(){var e=R.divDueby;if(null!==e){for(;e.firstChild;)e.removeChild(e.firstChild);var a,r=t.select(e);a=["DAY","DELTA","TOTAL"],(Ve=r.append("div").attr("class","dbbody")).append("div").attr("class","dbhdrrow").selectAll("span.dbhdrcell").data(a).enter().append("span").attr("class","dbhdrcell").text(t=>t),Ve.selectAll(".dbrow").data([1,2,3,4,5,6,7]).join(t=>t.append("div").attr("class","dbrow"))}}(),function(){var e=R.divData;if(null!==e){for(;e.firstChild;)e.removeChild(e.firstChild);var a,r=t.select(e);r.attr("class","bmndrdata"),r.on("wheel.scroll",Ue,{passive:!1}),Ce=r.append("div").attr("class","dbody"),Le=Array(Math.min(me.length,R.dataTableSize)).fill().map((t,e)=>e+Ge),a=["#","DATE","VALUE","COMMENT"],Ce.append("div").attr("class","dhdrrow").selectAll("span.dhdrcell").data(a).enter().append("span").attr("class",(t,e)=>3==e?"dhdrcell cmt":"dhdrcell").style("text-align",(t,e)=>0==e?"right":null).text(t=>t),Ce.selectAll(".drow").data(Le).join(t=>t.append("div").attr("class","drow")),Pe=r.append("input").attr("type","range").attr("class","dslider").attr("min",0).attr("max",15).attr("value",7).attr("step",1).on("input",function(){Oe(this.value)}).on("change",function(){Oe(this.value)})}}(),this.id=1,this.showData=(t=>(arguments.length>0&&(R.showData=t),0!=xe.length&&(Or(),Br(),Gr(),Nr(),Ur(),ar()),R.showData)),this.showContext=(t=>(arguments.length>0&&(R.showContext=t),0!=ve.length&&cn(),R.showContext)),this.keepSlopes=(t=>(arguments.length>0&&(R.keepSlopes=t),R.keepSlopes)),this.keepIntervals=(t=>(arguments.length>0&&(R.keepIntervals=t),R.keepIntervals)),this.maxDataDays=(t=>(arguments.length>0&&(R.maxDataDays=t,R.maxDataDays<0?(Wt=xe.slice(),Jt=ye.slice()):(Wt=xe.filter(t=>t[0]>ge.asof-R.maxDataDays*h),Jt=ye.filter(t=>t[0]>ge.asof-R.maxDataDays*h)),0!=xe.length&&(Or(),Br(),Gr(),Nr())),R.maxDataDays)),this.reverseTable=(e=>(arguments.length>0&&(R.reverseTable=e,R.reverseTable?(t.select(R.divTable).select(".rtbgoal").raise(),t.select(R.divTable).select(".rtbmain").raise(),t.select(R.divTable).select(".rtbstart").raise()):(t.select(R.divTable).select(".rtbstart").raise(),t.select(R.divTable).select(".rtbmain").raise(),t.select(R.divTable).select(".rtbgoal").raise()),dn()),R.reverseTable)),this.tableUpdateOnDrag=(t=>(arguments.length>0&&(R.tableUpdateOnDrag=t,dn()),R.tableUpdateOnDrag)),this.tableAutoScroll=(t=>(arguments.length>0&&(R.tableAutoScroll=t),R.tableAutoScroll)),this.undoBufferState=(()=>({undo:le.length,redo:ie.length})),this.undo=(()=>{R.roadEditor&&(document.activeElement.blur(),0!=le.length&&(0!=le.length&&r.sameRoads(le[le.length-1],ve)||ie.push(ve),ve=le.pop(),_t.setRoadObj(ve),Ie()))}),this.undoAll=(()=>{R.roadEditor&&(ve=le.shift(),ia(),_t.setRoadObj(ve),Ie())}),this.redo=(()=>{R.roadEditor&&(document.activeElement.blur(),0!=ie.length&&(sa(!0),ve=ie.pop(),Ie()))}),this.clearUndo=ia,this.zoomAll=(()=>{0!=ve.length&&la()}),this.zoomDefault=(()=>{0!=ve.length&&oa()}),this.loadGoal=(async t=>{await async function(t,e=null){if(""!=t&&!de){de=!0,R.headless||Me(["loading..."],Qt/10);var r=await a.loadJSON(t);if(null!=r){if(R.headless||Ae(),"errstring"in r)throw new Error("loadGoalFromURL: BB file has errors: "+r.errstring);xa(r)}else Me(null!=oe?[w[oe]]:["Could not load goal file."]),R.headless||setTimeout(Ae,1500),"function"==typeof R.onError&&R.onError.call();de=!1}}(t).catch(function(t){console.log(t.stack)})}),this.loadGoalJSON=((t,e=!0)=>{Ae(),xa(t,e)}),this.retroRatchet=(t=>{R.roadEditor&&function(t){if(0!=ve.length){var e=r.dtd(ve,ge,ge.tcur,ge.vcur),a=ge.asof;t<0&&(t=0);var n=e-(t-1)-1;if(!(n<=0)){var o,l=ge.asof+n*h,i=r.rdf(ve,l),s=-1;for(o=1;o<ve.length;o++)if(ve[o].sta[0]===a){s=o-1;break}var d=!1;s<0&&(ba(a),d=!0),o+1<ve.length&&ve[o+1].sta[0]===a||(ba(a,i),d&&(le.pop(),d=!0)),Ie()}}else console.log("bgraph("+E+"):setSafeDays(), road is empty!")}(t)}),this.scheduleBreak=((t,e,n)=>{if(R.roadEditor&&!isNaN(e))if(0!=ve.length){var o,l,i=a.dayparse(t,"-"),s=-1;for(o=1;o<ve.length;o++)if(ve[o].sta[0]===i){s=o;break}var d=!1;for(s<0&&(ba(i),d=!0),d||sa(),o=1;o<ve.length;o++)if(ve[o].sta[0]===i){s=o;break}if(n){for(ve[s].end[0]=a.daysnap(ve[s].end[0]+e*h),l=s+1;l<ve.length;l++)ve[l].sta[0]=a.daysnap(ve[l].sta[0]+e*h),ve[l].end[0]=a.daysnap(ve[l].end[0]+e*h);if(ve[s].sta[1]!=ve[s].end[1]){var c={};c.sta=ve[s].sta.slice(),c.sta[0]=a.daysnap(c.sta[0]+e*h),c.end=ve[s].end.slice(),c.slope=r.segSlope(c),c.auto=r.RP.VALUE,ve.splice(s+1,0,c),ve[s].end=c.sta.slice(),ve[s].slope=0,r.fixRoadArray(ve,r.RP.VALUE,!1)}}else{var u=a.daysnap(ve[s].sta[0]+e*h),p=r.findSeg(ve,u);for(ve[p].sta[0]!=u&&(ba(u),d&&(le.pop(),d=!0),p=r.findSeg(ve,u)),l=s+1;l<p;l++)ve.splice(s+1,1);ve[s].end=ve[s+1].sta.slice();var f=ve[s+1].sta[1]-ve[s].sta[1];for(l=s;l<ve.length;l++)ve[l].end[1]-=f,ve[l].slope=r.segSlope(ve[l]),l+1<ve.length&&(ve[l+1].sta[1]=ve[l].end[1]);r.fixRoadArray(ve,r.RP.SLOPE,!1)}Ie()}else console.log("bgraph("+E+"):scheduleBreak(), road is empty!")}),this.commitTo=(t=>{if(R.roadEditor&&!isNaN(t))if(0!=ve.length){if(ve[ve.length-2].slope!=t){var e=r.findSeg(ve,ge.horizon);ve[e].sta[0]==ge.horizon||e<ve.length-2?sa():ba(ge.horizon),ve[ve.length-2].slope=t,r.fixRoadArray(ve,r.RP.VALUE,!1),Ie()}}else console.log("bgraph("+E+"):commitTo(), road is empty!")}),this.getRoad=(()=>{var t,a,n={};if(0==ve.length)return console.log("bgraph("+E+"):getRoad(), road is empty!"),null;n.valid=da(ve),n.loser=r.redyest(ve,ge,ge.tcur),n.asof=ge.asof,n.horizon=ge.horizon,n.siru=ge.siru,n.road=[];for(let o=0;o<ve.length-1;o++)(t=ve[o]).sta[0]==t.end[0]&&t.sta[1]==t.end[1]||(a=[e.unix(t.end[0]).utc().format("YYYYMMDD"),t.end[1],t.slope*ge.siru],t.auto==r.RP.DATE&&(a[2]=null),t.auto==r.RP.VALUE&&(a[1]=null),t.auto==r.RP.SLOPE&&(a[2]=null),n.road.push(a));return n}),this.saveGraph=((e=null)=>{const a=P.node();let r=(new XMLSerializer).serializeToString(a);if(R.headless||null==e){if(document.head.remove(),document.body.innerHTML=r,R.headless){var n=t.select(document.body);n.selectAll(".buttonarea").remove(),n.selectAll(".brush").remove(),n.selectAll(".zoomin").remove(),n.selectAll(".zoomout").remove()}}else{r.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)||(r=r.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')),r.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)||(r=r.replace(/^<svg/,'<svg xmlns:xlink="http://www.w3.org/1999/xlink"')),r='<?xml version="1.0" standalone="no"?>\n'+r;var o="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(r);e.href=o}}),this.hide=(()=>{ce=!0}),this.show=(()=>{ce=!1,0!=ve.length?(Xe(),Qe(),$e(),ea(),dn(),cn(),un(!0)):console.log("bgraph("+E+"):show(), road is empty!")}),this.loading=(t=>{t?Me(["loading..."],Qt/10):Ae()}),this.getRoadObj=(()=>r.copyRoad(ve)),this.getGoalObj=(()=>ge);var hn=!1;this.setRoadObj=((t,e=!1)=>{hn||(0!=t.length?(hn=!0,sa(),ve=r.copyRoad(t),e&&(pe=r.copyRoad(t),ia()),_t.setRoadObj(t),Ie(),hn=!1):console.log("bgraph("+E+"):setRoadObj(), new road is empty!"))}),this.isLoser=(()=>!(!ge||0==ve.length)&&r.redyest(ve,ge,ge.tcur)),this.getProgress=(()=>[[a.dayify(ge.tini,"-"),ge.vini],[a.dayify(ge.tcur,"-"),ge.vcur],[a.dayify(ge.tfin,"-"),ge.vfin]]),this.curState=(()=>ge?[ge.tcur,ge.vcur,ge.rcur,r.rdf(ve,ge.tcur)]:null);const pn=["plotall","steppy","rosy","movingav","aura","hidey","stathead","hashtags"];this.getVisualConfig=(()=>{var t={};return pn.map(e=>{t[e]=ge[e]}),t}),this.xlinkLoaded=(()=>ne);const fn=["yaw","dir","kyoom","odom","monotone","aggday"];this.getGoalConfig=(()=>{let t={};return fn.map(e=>{t[e]=ge[e]}),t}),this.msg=(t=>{t?Me([t],20,null,{x:$t/20,y:10,w:18*$t/20,h:50},"message",!1,!0,P):Ae("message")}),this.animHor=function(t){if(R.roadEditor)return;const e=R.horizon;var a=Ot.select(".horizon"),r=Ut.select(".horizontext");const n=[["stroke-width",e.width*ae*3,e.width*ae]],o=[["stroke-dasharray",1.3*e.dash+","+.7*e.dash,e.dash+","+e.dash]],l=[["font-size",1.2*e.font+"px",e.font+"px"]];t?(Xa(a,500,n,o,"hor"),Xa(r,500,[],l,"hort")):($a(a,300,n,o,"hor"),$a(r,300,[],l,"hort"))},this.animYBR=function(t){if(!R.roadEditor){var e=a.Cols.DYEL,r=mt.select(".razr");e=[["stroke-width",R.oldRoadLine.width*ae*2,R.oldRoadLine.width*ae]],t?Xa(r,500,[],e,"ybrc"):$a(r,300,[],e,"ybrc")}},this.animData=function(t){if(!R.roadEditor){var e=Dt.selectAll(".dp"),a=[["r",R.dataPoint.size*ae*2,R.dataPoint.size*ae]];t?Xa(e,500,a,[],"data"):$a(e,300,a,[],"data"),e=At.selectAll(".ap"),a=[["r",.7*R.dataPoint.size*ae*2,.7*R.dataPoint.size*ae]],t?Xa(e,500,a,[],"dataa"):$a(e,300,a,[],"dataa")}},this.animGuides=function(t){if(R.roadEditor)return;const e=gt.selectAll(".guides"),r=[["stroke-width",R.guidelines.width*ae*2.5,t=>t<0?R.guidelines.weekwidth*ae:R.guidelines.width*ae],["stroke",t=>t<0?a.Cols.BIGG:"#ffff00",t=>t<0?a.Cols.BIGG:a.Cols.LYEL]];t?Xa(e,500,r,[],"guides"):$a(e,300,r,[],"guides")},this.animRosy=function(t){if(!R.roadEditor){var e=zt.selectAll(".rosy"),a=Rt.selectAll(".rd"),r=[["stroke-width",6*ae,4*ae]],n=[["r",R.dataPoint.size*ae*2,R.dataPoint.size*ae]];t?(Xa(e,500,r,[],"rosy"),Xa(a,500,[],n,"rd")):($a(e,300,r,[],"rosy"),$a(a,300,[],n,"rd"))}},this.animMav=function(t){if(!R.roadEditor){var e=Et.selectAll(".movingav"),a=[["stroke-width",6*ae,3*ae]];t?Xa(e,500,a,[],"mav"):$a(e,300,a,[],"mav")}},this.animYBHPlines=function(t){if(!R.roadEditor){var e=st.selectAll("#r11, #r22, #r66"),a=[["stroke-width",4*ae,1.5*ae]];t?Xa(e,500,a,[],"ybl"):$a(e,300,a,[],"ybl")}},this.animAura=function(t){if(!R.roadEditor){var e=Tt.selectAll(".aura"),r=Tt.selectAll(".aurapast"),n=[["stroke","#9e559e",a.Cols.LPURP],["fill","#9e559e",a.Cols.LPURP]],o=[["stroke","#9e559e",a.Cols.LPURP],["fill","#9e559e",a.Cols.LPURP]],l=[["transform","translate(0,5)","translate(0,0)"]],i=[["transform","translate(0,5)","translate(0,0)"]];t?(Xa(e,500,l,n,"aura"),Xa(r,500,i,o,"aurap")):($a(e,300,l,n,"aura"),$a(r,300,i,o,"aurap"))}},this.animBuf=function(t){if(!R.roadEditor){var e=Nt.selectAll(".waterbuf"),a=Number(e.attr("x")),r=Number(e.attr("y"));if("text"==e.node().tagName){let a=e.style("font-size"),n=[["font-size",1.3*(a=Number(a.substring(0,a.length-2)))+"px",a+"px"],["fill","#606060",R.watermark.color]],o=[["y",r+.1*a/3,r]];t?Xa(e,500,o,n,"buf"):$a(e,300,o,n,"buf")}else{let n=R.watermark.height,o=[["width",1.3*n,n],["height",1.3*n,n],["x",a-.15*n,a],["y",r-.15*n,r]];t?Xa(e,500,o,[],"buf"):$a(e,300,o,[],"buf")}}},this.animBux=function(t){if(!R.roadEditor){var e=Nt.selectAll(".waterbux"),a=e.style("font-size");a=Number(a.substring(0,a.length-2));var r=Number(e.attr("y")),n=[["font-size",1.3*a+"px",a+"px"],["fill","#606060",R.watermark.color]],o=[["y",r+.15*a,r]];t?Xa(e,500,o,n,"bux"):$a(e,300,o,n,"bux")}}}});