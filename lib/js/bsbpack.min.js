!function(t,r){"use strict";"function"==typeof define&&define.amd?define([],r):"object"==typeof module&&module.exports?module.exports=r():t.Polyfit=r()}(this,function(){"use strict";return function t(r,o){if(!(r instanceof Array&&o instanceof Array||r instanceof Float32Array&&o instanceof Float32Array||r instanceof Float64Array&&o instanceof Float64Array))throw new Error("x and y must be arrays");if(r instanceof Float32Array?this.FloatXArray=Float32Array:r instanceof Float64Array&&(this.FloatXArray=Float64Array),r.length!==o.length)throw new Error("x and y must have the same length");this.x=r,this.y=o;const e=function(t,r,o,e){for(var n=o+1;n<e;n++)t[r][n]/=t[r][o];t[r][o]=1},n=function(t,r,o,e,n){for(var a=0;a<e;a++)if(a!==r&&0!==t[a][o]){for(var i=o+1;i<n;i++)t[a][i]-=t[a][o]*t[r][i];t[a][o]=0}},a=function(t,r){for(var o=0,e=0,n=0,a=r.length;n<a;n++)o+=r[n]*Math.pow(t,e++);return o};t.prototype.correlationCoefficient=function(t){for(var r,o,e=0,n=this.x.length,i=0,f=0,s=0,h=0,u=0,c=0;c<n;c++)i+=r=a(this.x[c],t),s+=o=this.y[c],u+=r*o,f+=r*r,h+=o*o;var l=Math.sqrt((f-i*i/n)*(h-s*s/n));return 0!==l&&(e=Math.pow((u-i*s/n)/l,2)),e},t.prototype.standardError=function(t){var r=0,o=this.x.length;if(o>2){for(var e=0,n=0;n<o;n++)e+=Math.pow(a(this.x[n],t)-this.y[n],2);r=Math.sqrt(e/(o-2))}return r},t.prototype.computeCoefficients=function(t){var r,o,a,i=this.x.length,f=2*++t-1,s=[];if(this.FloatXArray){var h=(t+1)*this.FloatXArray.BYTES_PER_ELEMENT,u=new ArrayBuffer(t*h);for(a=0;a<t;a++)s[a]=new this.FloatXArray(u,a*h,t+1)}else{var c=[];for(a=0;a<=t;a++)c[a]=0;for(s[0]=c,a=1;a<t;a++)s[a]=c.slice()}var l=[i];for(a=1;a<f;a++)l[a]=0;for(a=0;a<i;a++){var y=this.x[a],p=this.y[a];for(r=1;r<f;r++)l[r]+=Math.pow(y,r);for(s[0][t]+=p,r=1;r<t;r++)s[r][t]+=Math.pow(y,r)*p}for(r=0;r<t;r++)for(o=0;o<t;o++)s[r][o]=l[r+o];!function(t){for(var r,o,a=t.length,i=t[0].length,f=0,s=0;f<a&&s<i;){for(r=f;r<a&&0===t[r][s];)r++;r<a&&(r!==f&&(o=t[f],t[f]=t[r],t[r]=o),1!==t[f][s]&&e(t,f,s,i),n(t,f,s,a,i),f++),s++}}(s);var v=this.FloatXArray&&new this.FloatXArray(s.length)||[];for(a=s.length-1;a>=0;a--)v[a]=s[a][t];return v},t.prototype.getPolynomial=function(t){if(isNaN(t)||t<0)throw new Error("Degree must be a positive integer");var r=this.computeCoefficients(t),o=[];o.push(r[0].toPrecision());for(var e=1,n=r.length;e<n;e++)o.push(r[e]+" * Math.pow(x, "+e+")");var a="return "+o.join(" + ")+";";return new Function("x",a)},t.prototype.toExpression=function(t){if(isNaN(t)||t<0)throw new Error("Degree must be a positive integer");var r=this.computeCoefficients(t),o=[],e=r.length;o.push(r[0].toPrecision());for(var n=1;n<e;n++)o.push(r[n]+"x^"+n);return o.join(" + ")}}});
!function(e,t){"use strict";var n;if("object"==typeof exports){try{n=require("moment")}catch(e){}module.exports=t(n)}else"function"==typeof define&&define.amd?define(function(e){try{n=e("moment")}catch(e){}return t(n)}):e.Pikaday=t(e.moment)}(this,function(e){"use strict";var t="function"==typeof e,n=!!window.addEventListener,a=window.document,i=window.setTimeout,s=function(e,t,a,i){n?e.addEventListener(t,a,!!i):e.attachEvent("on"+t,a)},o=function(e,t,a,i){n?e.removeEventListener(t,a,!!i):e.detachEvent("on"+t,a)},r=function(e,t){return-1!==(" "+e.className+" ").indexOf(" "+t+" ")},h=function(e){return/Array/.test(Object.prototype.toString.call(e))},l=function(e){return/Date/.test(Object.prototype.toString.call(e))&&!isNaN(e.getTime())},d=function(e){var t=e.getDay();return 0===t||6===t},u=function(e){return e%4==0&&e%100!=0||e%400==0},c=function(e,t){return[31,u(e)?29:28,31,30,31,30,31,31,30,31,30,31][t]},f=function(e){l(e)&&e.setHours(0,0,0,0)},g=function(e,t){return e.getTime()===t.getTime()},m=function(e,t,n){var a,i;for(a in t)(i=void 0!==e[a])&&"object"==typeof t[a]&&null!==t[a]&&void 0===t[a].nodeName?l(t[a])?n&&(e[a]=new Date(t[a].getTime())):h(t[a])?n&&(e[a]=t[a].slice(0)):e[a]=m({},t[a],n):!n&&i||(e[a]=t[a]);return e},p=function(e,t,n){var i;a.createEvent?((i=a.createEvent("HTMLEvents")).initEvent(t,!0,!1),i=m(i,n),e.dispatchEvent(i)):a.createEventObject&&(i=a.createEventObject(),i=m(i,n),e.fireEvent("on"+t,i))},y=function(e){return e.month<0&&(e.year-=Math.ceil(Math.abs(e.month)/12),e.month+=12),e.month>11&&(e.year+=Math.floor(Math.abs(e.month)/12),e.month-=12),e},D={field:null,bound:void 0,position:"bottom left",reposition:!0,format:"YYYY-MM-DD",toString:null,parse:null,defaultDate:null,setDefaultDate:!1,firstDay:0,formatStrict:!1,minDate:null,maxDate:null,yearRange:10,showWeekNumber:!1,pickWholeWeek:!1,minYear:0,maxYear:9999,minMonth:void 0,maxMonth:void 0,startRange:null,endRange:null,isRTL:!1,yearSuffix:"",showMonthAfterYear:!1,showDaysInNextAndPreviousMonths:!1,enableSelectionDaysInNextAndPreviousMonths:!1,numberOfMonths:1,mainCalendar:"left",container:void 0,blurFieldOnSelect:!0,i18n:{previousMonth:"Previous Month",nextMonth:"Next Month",months:["January","February","March","April","May","June","July","August","September","October","November","December"],weekdays:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],weekdaysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},theme:null,events:[],onSelect:null,onOpen:null,onClose:null,onDraw:null},v=function(e,t,n){for(t+=e.firstDay;t>=7;)t-=7;return n?e.i18n.weekdaysShort[t]:e.i18n.weekdays[t]},_=function(e){var t=[],n="false";if(e.isEmpty){if(!e.showDaysInNextAndPreviousMonths)return'<td class="is-empty"></td>';t.push("is-outside-current-month"),e.enableSelectionDaysInNextAndPreviousMonths||t.push("is-selection-disabled")}return e.isDisabled&&t.push("is-disabled"),e.isToday&&t.push("is-today"),e.isSelected&&(t.push("is-selected"),n="true"),e.hasEvent&&t.push("has-event"),e.isInRange&&t.push("is-inrange"),e.isStartRange&&t.push("is-startrange"),e.isEndRange&&t.push("is-endrange"),'<td data-day="'+e.day+'" class="'+t.join(" ")+'" aria-selected="'+n+'"><button class="pika-button pika-day" type="button" data-pika-year="'+e.year+'" data-pika-month="'+e.month+'" data-pika-day="'+e.day+'">'+e.day+"</button></td>"},b=function(e,t,n,a){return'<tr class="pika-row'+(n?" pick-whole-week":"")+(a?" is-selected":"")+'">'+(t?e.reverse():e).join("")+"</tr>"},w=function(e,t,n,a,i,s){var o,r,l,d,u,c=e._o,f=n===c.minYear,g=n===c.maxYear,m='<div id="'+s+'" class="pika-title" role="heading" aria-live="assertive">',p=!0,y=!0;for(l=[],o=0;o<12;o++)l.push('<option value="'+(n===i?o-t:12+o-t)+'"'+(o===a?' selected="selected"':"")+(f&&o<c.minMonth||g&&o>c.maxMonth?'disabled="disabled"':"")+">"+c.i18n.months[o]+"</option>");for(d='<div class="pika-label">'+c.i18n.months[a]+'<select class="pika-select pika-select-month" tabindex="-1">'+l.join("")+"</select></div>",h(c.yearRange)?(o=c.yearRange[0],r=c.yearRange[1]+1):(o=n-c.yearRange,r=1+n+c.yearRange),l=[];o<r&&o<=c.maxYear;o++)o>=c.minYear&&l.push('<option value="'+o+'"'+(o===n?' selected="selected"':"")+">"+o+"</option>");return u='<div class="pika-label">'+n+c.yearSuffix+'<select class="pika-select pika-select-year" tabindex="-1">'+l.join("")+"</select></div>",c.showMonthAfterYear?m+=u+d:m+=d+u,f&&(0===a||c.minMonth>=a)&&(p=!1),g&&(11===a||c.maxMonth<=a)&&(y=!1),0===t&&(m+='<button class="pika-prev'+(p?"":" is-disabled")+'" type="button">'+c.i18n.previousMonth+"</button>"),t===e._o.numberOfMonths-1&&(m+='<button class="pika-next'+(y?"":" is-disabled")+'" type="button">'+c.i18n.nextMonth+"</button>"),m+"</div>"},M=function(e,t,n){return'<table cellpadding="0" cellspacing="0" class="pika-table" role="grid" aria-labelledby="'+n+'">'+function(e){var t,n=[];for(e.showWeekNumber&&n.push("<th></th>"),t=0;t<7;t++)n.push('<th scope="col"><abbr title="'+v(e,t)+'">'+v(e,t,!0)+"</abbr></th>");return"<thead><tr>"+(e.isRTL?n.reverse():n).join("")+"</tr></thead>"}(e)+("<tbody>"+t.join("")+"</tbody>")+"</table>"},k=function(o){var h=this,d=h.config(o);h._onMouseDown=function(e){if(h._v){var t=(e=e||window.event).target||e.srcElement;if(t)if(r(t,"is-disabled")||(!r(t,"pika-button")||r(t,"is-empty")||r(t.parentNode,"is-disabled")?r(t,"pika-prev")?h.prevMonth():r(t,"pika-next")&&h.nextMonth():(h.setDate(new Date(t.getAttribute("data-pika-year"),t.getAttribute("data-pika-month"),t.getAttribute("data-pika-day"))),d.bound&&i(function(){h.hide(),d.blurFieldOnSelect&&d.field&&d.field.blur()},100))),r(t,"pika-select"))h._c=!0;else{if(!e.preventDefault)return e.returnValue=!1,!1;e.preventDefault()}}},h._onChange=function(e){var t=(e=e||window.event).target||e.srcElement;t&&(r(t,"pika-select-month")?h.gotoMonth(t.value):r(t,"pika-select-year")&&h.gotoYear(t.value))},h._onKeyChange=function(e){if(e=e||window.event,h.isVisible())switch(e.keyCode){case 13:case 27:d.field&&d.field.blur();break;case 37:e.preventDefault(),h.adjustDate("subtract",1);break;case 38:h.adjustDate("subtract",7);break;case 39:h.adjustDate("add",1);break;case 40:h.adjustDate("add",7)}},h._onInputChange=function(n){var a;n.firedBy!==h&&(a=d.parse?d.parse(d.field.value,d.format):t?(a=e(d.field.value,d.format,d.formatStrict))&&a.isValid()?a.toDate():null:new Date(Date.parse(d.field.value)),l(a)&&h.setDate(a),h._v||h.show())},h._onInputFocus=function(){h.show()},h._onInputClick=function(){h.show()},h._onInputBlur=function(){var e=a.activeElement;do{if(r(e,"pika-single"))return}while(e=e.parentNode);h._c||(h._b=i(function(){h.hide()},50)),h._c=!1},h._onClick=function(e){var t=(e=e||window.event).target||e.srcElement,a=t;if(t){!n&&r(t,"pika-select")&&(t.onchange||(t.setAttribute("onchange","return;"),s(t,"change",h._onChange)));do{if(r(a,"pika-single")||a===d.trigger)return}while(a=a.parentNode);h._v&&t!==d.trigger&&a!==d.trigger&&h.hide()}},h.el=a.createElement("div"),h.el.className="pika-single"+(d.isRTL?" is-rtl":"")+(d.theme?" "+d.theme:""),s(h.el,"mousedown",h._onMouseDown,!0),s(h.el,"touchend",h._onMouseDown,!0),s(h.el,"change",h._onChange),s(a,"keydown",h._onKeyChange),d.field&&(d.container?d.container.appendChild(h.el):d.bound?a.body.appendChild(h.el):d.field.parentNode.insertBefore(h.el,d.field.nextSibling),s(d.field,"change",h._onInputChange),d.defaultDate||(t&&d.field.value?d.defaultDate=e(d.field.value,d.format).toDate():d.defaultDate=new Date(Date.parse(d.field.value)),d.setDefaultDate=!0));var u=d.defaultDate;l(u)?d.setDefaultDate?h.setDate(u,!0):h.gotoDate(u):h.gotoDate(new Date),d.bound?(this.hide(),h.el.className+=" is-bound",s(d.trigger,"click",h._onInputClick),s(d.trigger,"focus",h._onInputFocus),s(d.trigger,"blur",h._onInputBlur)):this.show()};return k.prototype={config:function(e){this._o||(this._o=m({},D,!0));var t=m(this._o,e,!0);t.isRTL=!!t.isRTL,t.field=t.field&&t.field.nodeName?t.field:null,t.theme="string"==typeof t.theme&&t.theme?t.theme:null,t.bound=!!(void 0!==t.bound?t.field&&t.bound:t.field),t.trigger=t.trigger&&t.trigger.nodeName?t.trigger:t.field,t.disableWeekends=!!t.disableWeekends,t.disableDayFn="function"==typeof t.disableDayFn?t.disableDayFn:null;var n=parseInt(t.numberOfMonths,10)||1;if(t.numberOfMonths=n>4?4:n,l(t.minDate)||(t.minDate=!1),l(t.maxDate)||(t.maxDate=!1),t.minDate&&t.maxDate&&t.maxDate<t.minDate&&(t.maxDate=t.minDate=!1),t.minDate&&this.setMinDate(t.minDate),t.maxDate&&this.setMaxDate(t.maxDate),h(t.yearRange)){var a=(new Date).getFullYear()-10;t.yearRange[0]=parseInt(t.yearRange[0],10)||a,t.yearRange[1]=parseInt(t.yearRange[1],10)||a}else t.yearRange=Math.abs(parseInt(t.yearRange,10))||D.yearRange,t.yearRange>100&&(t.yearRange=100);return t},toString:function(n){return n=n||this._o.format,l(this._d)?this._o.toString?this._o.toString(this._d,n):t?e(this._d).format(n):this._d.toDateString():""},getMoment:function(){return t?e(this._d):null},setMoment:function(n,a){t&&e.isMoment(n)&&this.setDate(n.toDate(),a)},getDate:function(){return l(this._d)?new Date(this._d.getTime()):null},setDate:function(e,t){if(!e)return this._d=null,this._o.field&&(this._o.field.value="",p(this._o.field,"change",{firedBy:this})),this.draw();if("string"==typeof e&&(e=new Date(Date.parse(e))),l(e)){var n=this._o.minDate,a=this._o.maxDate;l(n)&&e<n?e=n:l(a)&&e>a&&(e=a),this._d=new Date(e.getTime()),f(this._d),this.gotoDate(this._d),this._o.field&&(this._o.field.value=this.toString(),p(this._o.field,"change",{firedBy:this})),t||"function"!=typeof this._o.onSelect||this._o.onSelect.call(this,this.getDate())}},gotoDate:function(e){var t=!0;if(l(e)){if(this.calendars){var n=new Date(this.calendars[0].year,this.calendars[0].month,1),a=new Date(this.calendars[this.calendars.length-1].year,this.calendars[this.calendars.length-1].month,1),i=e.getTime();a.setMonth(a.getMonth()+1),a.setDate(a.getDate()-1),t=i<n.getTime()||a.getTime()<i}t&&(this.calendars=[{month:e.getMonth(),year:e.getFullYear()}],"right"===this._o.mainCalendar&&(this.calendars[0].month+=1-this._o.numberOfMonths)),this.adjustCalendars()}},adjustDate:function(e,t){var n,a=this.getDate()||new Date,i=24*parseInt(t)*60*60*1e3;"add"===e?n=new Date(a.valueOf()+i):"subtract"===e&&(n=new Date(a.valueOf()-i)),this.setDate(n)},adjustCalendars:function(){this.calendars[0]=y(this.calendars[0]);for(var e=1;e<this._o.numberOfMonths;e++)this.calendars[e]=y({month:this.calendars[0].month+e,year:this.calendars[0].year});this.draw()},gotoToday:function(){this.gotoDate(new Date)},gotoMonth:function(e){isNaN(e)||(this.calendars[0].month=parseInt(e,10),this.adjustCalendars())},nextMonth:function(){this.calendars[0].month++,this.adjustCalendars()},prevMonth:function(){this.calendars[0].month--,this.adjustCalendars()},gotoYear:function(e){isNaN(e)||(this.calendars[0].year=parseInt(e,10),this.adjustCalendars())},setMinDate:function(e){e instanceof Date?(f(e),this._o.minDate=e,this._o.minYear=e.getFullYear(),this._o.minMonth=e.getMonth()):(this._o.minDate=D.minDate,this._o.minYear=D.minYear,this._o.minMonth=D.minMonth,this._o.startRange=D.startRange),this.draw()},setMaxDate:function(e){e instanceof Date?(f(e),this._o.maxDate=e,this._o.maxYear=e.getFullYear(),this._o.maxMonth=e.getMonth()):(this._o.maxDate=D.maxDate,this._o.maxYear=D.maxYear,this._o.maxMonth=D.maxMonth,this._o.endRange=D.endRange),this.draw()},setStartRange:function(e){this._o.startRange=e},setEndRange:function(e){this._o.endRange=e},draw:function(e){if(this._v||e){var t,n=this._o,a=n.minYear,s=n.maxYear,o=n.minMonth,r=n.maxMonth,h="";this._y<=a&&(this._y=a,!isNaN(o)&&this._m<o&&(this._m=o)),this._y>=s&&(this._y=s,!isNaN(r)&&this._m>r&&(this._m=r)),t="pika-title-"+Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,2);for(var l=0;l<n.numberOfMonths;l++)h+='<div class="pika-lendar">'+w(this,l,this.calendars[l].year,this.calendars[l].month,this.calendars[0].year,t)+this.render(this.calendars[l].year,this.calendars[l].month,t)+"</div>";this.el.innerHTML=h,n.bound&&"hidden"!==n.field.type&&i(function(){n.trigger.focus()},1),"function"==typeof this._o.onDraw&&this._o.onDraw(this),n.bound&&n.field.setAttribute("aria-label","Use the arrow keys to pick a date")}},adjustPosition:function(){var e,t,n,i,s,o,r,h,l,d;if(!this._o.container){if(this.el.style.position="absolute",t=e=this._o.trigger,n=this.el.offsetWidth,i=this.el.offsetHeight,s=window.innerWidth||a.documentElement.clientWidth,o=window.innerHeight||a.documentElement.clientHeight,r=window.pageYOffset||a.body.scrollTop||a.documentElement.scrollTop,"function"==typeof e.getBoundingClientRect)h=(d=e.getBoundingClientRect()).left+window.pageXOffset,l=d.bottom+window.pageYOffset;else for(h=t.offsetLeft,l=t.offsetTop+t.offsetHeight;t=t.offsetParent;)h+=t.offsetLeft,l+=t.offsetTop;(this._o.reposition&&h+n>s||this._o.position.indexOf("right")>-1&&h-n+e.offsetWidth>0)&&(h=h-n+e.offsetWidth),(this._o.reposition&&l+i>o+r||this._o.position.indexOf("top")>-1&&l-i-e.offsetHeight>0)&&(l=l-i-e.offsetHeight),this.el.style.left=h+"px",this.el.style.top=l+"px"}},render:function(e,t,n){var a=this._o,i=new Date,s=c(e,t),o=new Date(e,t,1).getDay(),r=[],h=[];f(i),a.firstDay>0&&(o-=a.firstDay)<0&&(o+=7);for(var u=0===t?11:t-1,m=11===t?0:t+1,p=0===t?e-1:e,y=11===t?e+1:e,D=c(p,u),v=s+o,w=v;w>7;)w-=7;v+=7-w;for(var k,x,R,N,S=!1,C=0,I=0;C<v;C++){var T=new Date(e,t,C-o+1),E=!!l(this._d)&&g(T,this._d),Y=g(T,i),O=-1!==a.events.indexOf(T.toDateString()),j=C<o||C>=s+o,W=C-o+1,A=t,F=e,L=a.startRange&&g(a.startRange,T),P=a.endRange&&g(a.endRange,T),B=a.startRange&&a.endRange&&a.startRange<T&&T<a.endRange;j&&(C<o?(W=D+W,A=u,F=p):(W-=s,A=m,F=y));var H={day:W,month:A,year:F,hasEvent:O,isSelected:E,isToday:Y,isDisabled:a.minDate&&T<a.minDate||a.maxDate&&T>a.maxDate||a.disableWeekends&&d(T)||a.disableDayFn&&a.disableDayFn(T),isEmpty:j,isStartRange:L,isEndRange:P,isInRange:B,showDaysInNextAndPreviousMonths:a.showDaysInNextAndPreviousMonths,enableSelectionDaysInNextAndPreviousMonths:a.enableSelectionDaysInNextAndPreviousMonths};a.pickWholeWeek&&E&&(S=!0),h.push(_(H)),7==++I&&(a.showWeekNumber&&h.unshift((k=C-o,x=t,R=e,N=void 0,N=new Date(R,0,1),'<td class="pika-week">'+Math.ceil(((new Date(R,x,k)-N)/864e5+N.getDay()+1)/7)+"</td>")),r.push(b(h,a.isRTL,a.pickWholeWeek,S)),h=[],I=0,S=!1)}return M(a,r,n)},isVisible:function(){return this._v},show:function(){var e,t,n;this.isVisible()||(this._v=!0,this.draw(),e=this.el,t="is-hidden",e.className=(n=(" "+e.className+" ").replace(" "+t+" "," ")).trim?n.trim():n.replace(/^\s+|\s+$/g,""),this._o.bound&&(s(a,"click",this._onClick),this.adjustPosition()),"function"==typeof this._o.onOpen&&this._o.onOpen.call(this))},hide:function(){var e,t,n=this._v;!1!==n&&(this._o.bound&&o(a,"click",this._onClick),this.el.style.position="static",this.el.style.left="auto",this.el.style.top="auto",e=this.el,r(e,t="is-hidden")||(e.className=""===e.className?t:e.className+" "+t),this._v=!1,void 0!==n&&"function"==typeof this._o.onClose&&this._o.onClose.call(this))},destroy:function(){this.hide(),o(this.el,"mousedown",this._onMouseDown,!0),o(this.el,"touchend",this._onMouseDown,!0),o(this.el,"change",this._onChange),o(a,"keydown",this._onKeyChange),this._o.field&&(o(this._o.field,"change",this._onInputChange),this._o.bound&&(o(this._o.trigger,"click",this._onInputClick),o(this._o.trigger,"focus",this._onInputFocus),o(this._o.trigger,"blur",this._onInputBlur))),this.el.parentNode&&this.el.parentNode.removeChild(this.el)}},k});
!function(t,n){"use strict";"function"==typeof define&&define.amd?define(["moment"],n):"object"==typeof module&&module.exports?module.exports=n(require("./moment")):t.butil=n(t.moment)}(this,function(t){"use strict";const n=Math.min,e=Math.max,r=Math.abs,u=Math.pow,o=Math.log10,i=Math.floor,l=Math.round,f=Math.sign,c=86400,s=7*c,a={y:365.25*c,m:365.25*c/12,w:7*c,d:c,h:3600};function d(t){return Array.isArray(t)}function h(t,n=1e-7){return r(t)<n?0:t}function m(t,n,e){return n>e&&([n,e]=[e,n]),t<n?n:t>e?e:t}function p(t,n=10,e=5,f=0){if(isNaN(t))return t.toString();t=h(t);let c,s,a=i(r(t));a=0===a?0:a.toString().length,r(t)>u(10,a)-.5&&(a+=1),c=0===a&&0!==t?i(e-o(r(t))):e;let d=t*u(10,c),g=d%10;g<0&&(g+=10),g>=4.5&&g<4.9999999&&(d=i(d));let y=l(d)/u(10,c)+1e-10;if(f<0&&y>t||f>0&&y<t){if(!(e>=10))return p(t,n,e+1,f);y=t}return n<a&&r(u(10,a-1)-y)<.5&&(y=u(10,a-1)),n=m(n,a,a+e),r(y)<1e-4||9===i(y)||99===i(y)||999===i(y)?s=parseFloat(t.toPrecision(c)).toString():(s=y.toPrecision(n)).includes("e")||(s=parseFloat(s)),s}function g(t){const n=(t="string"==typeof t?t.trim():t.toString()).charAt(0),e=t.substr(1);if("+"===n&&(t=e),"-"===n)return"-"+g(e);t=t.replace(/^0+([^eE])/,"$1");if(/^(?:\d+\.?\d*|\.\d+)$/.test(t))return t;const r=t.match(/^(\d+\.?\d*|\.\d+)e([+-]?\d+)$/i);if(!r||3!==r.length)return"NaN";let[,u,o]=r,i=u.indexOf(".");return-1===i&&(i=u.length),i+=+o,u=u.replace(/\./,""),i<0?"."+"0".repeat(-i)+u:(i>u.length?u+="0".repeat(i-u.length):u=u.substring(0,i)+"."+u.substring(i),u.replace(/\.$/,"").replace(/^0+(.)/,"$1"))}function y(t,n=1){if(n<0)return NaN;if(0===n)return+t;const e=l(t/n),r=g(n).match(/^0?\.(0*)10*$/);return r?+g(`${e}e${-r[1].length-1}`):e*n}function N(n){let e=t.unix(n).utc(),r=e.year(),u=e.month()+1;u=u<10?"0"+u.toString():u.toString();let o=e.date();return r+"."+u+"."+(o=o<10?"0"+o.toString():o.toString())}let R=RegExp("^(\\d{4})(\\d{2})(\\d{2})$"),E="YYYYMMDD";return{MAXTIME:6e4,BBURL:"http://brain.beeminder.com/",BHUE:{DYEL:"#ffff44",LYEL:"#ffff88",ROSE:"#ff8080",AKRA:"#4C4Cff",PURP:"#B56bb5",LPURP:"#E5BbE5",BLUE:"#EAEAFF",GRUE:"#b5ffDE",ORNG:"#ff8000",WITE:"#ffffff",BIGG:"#ffe54c",PINK:"#ffe5e5",PNKE:"#ffcccc",GRAY:"#f0f0f0",BLCK:"#000000",REDDOT:"#ff0000",ORNDOT:"#ffa500",BLUDOT:"#3f3fff",GRNDOT:"#00aa00",GRADOT:"#228B22",ERRDOT:"#00FFFF",RAZR0:"#ff0000",RAZR1:"#ffa500",RAZR2:"#3f3fff",RAZR3:"#6BC461"},AKH:s,BDUSK:2147317201,SECS:a,UNAM:{y:"year",m:"month",w:"week",d:"day",h:"hour"},nummy:function(t){return!isNaN(parseFloat(t))&&isFinite(t)},stringy:function(t){return"string"==typeof t},listy:d,arrMin:function(t){return n.apply(null,t)},arrMax:function(t){return e.apply(null,t)},extendo:function t(n,e,r){let u,o;for(u in e)(o=void 0!==n[u])&&"object"==typeof e[u]&&null!==e[u]&&void 0===e[u].nodeName?d(e[u])?r&&(n[u]=e[u].slice(0)):n[u]=t({},e[u],r):!r&&o||(d(e[u])?n[u]=e[u].slice(0):n[u]=e[u]);return n},deepcopy:function t(n){let e,r,u;if("object"!=typeof n||null===n)return n;for(u in e=d(n)?[]:{},n)r=n[u],e[u]=t(r);return e},partition:function(t,n,e){let r=t.length,u=[];for(let o=0;o<r;o+=e)o+n<=r&&u.push(t.slice(o,o+n));return u},quantile:function(t,n,e=1,r=!1){let u;if(u=r?t:t.slice().sort((t,n)=>t-n),e<1||e>9)return null;let o=[[0,0,1,0],[.5,0,1,0],[.5,0,0,0],[0,0,0,1],[.5,0,0,1],[0,1,0,1],[1,-1,0,1],[1/3,1/3,0,1],[3/8,.25,0,1]],l=o[e-1][0],c=o[e-1][1],s=o[e-1][2],a=o[e-1][3],d=t.length,h=function(t){const n=f(t),e=i(n*t);return[n*(n*t-e),n*e]}(l+(d+c)*n-1),m=h[0],p=h[1];return p<0?u[0]:p>=d?u[d-1]:(p=i(p),0==m?u[p]:u[p]+(u[p+1]-u[p])*(s+a*m))},sum:function(t){return t.reduce((t,n)=>t+n,0)},accumulate:function(t){let n=t.length;if(0===n)return t;let e=[t[0]];for(let r=1;r<n;r++)e.push(e[e.length-1]+t[r]);return e},monotonize:function(t,r=1){let u,o=t.slice();if(1===r)for(u=1;u<o.length;u++)o[u]=e(o[u-1],o[u]);else for(u=1;u<o.length;u++)o[u]=n(o[u-1],o[u]);return o},zip:function(t){return t[0].map((n,e)=>t.map(t=>t[e]))},chop:h,clip:m,searchLow:function(t,n){if(!t||!t.length)return-1;let e,r=-1,u=t.length;for(;u-r>1;)n(t[e=i((r+u)/2)])<0?r=e:u=e;return u===t.length||0!==n(t[u])?r:u},searchHigh:function(t,n){if(!t||!t.length)return 0;let e,r=-1,u=t.length;for(;u-r>1;)n(t[e=i((r+u)/2)])<=0?r=e:u=e;return-1===r||0!==n(t[r])?u:r},shn:p,shd:function(t){return null===t?"null":N(t)},splur:function(t,n,e=""){return""===e&&(e=n+"s"),p(t,10,5)+" "+(1===t?n:e)},conservaround:function(t,n=1,e=0){let r=y(t,n);return 0===e?r:(e<0&&r>t&&(r-=n),e>0&&r<t&&(r+=n),y(r,n))},linspace:function(t,n,r){if(void 0===r&&(r=e(l(n-t)+1,1)),r<2)return 1===r?[t]:[];let u,o=Array(r);for(u=--r;u>=0;u--)o[u]=(u*n+(r-u)*t)/r;return o},rescale:function(t,n,e,u,o){return r(n-e)<1e-7?t<=(n+e)/2?u:o:u+(t-n)/(e-n)*(o-u)},deldups:function(t,n=(t=>t)){let e={};return t.filter(t=>{const r=JSON.stringify(n(t));return!(r in e)&&(e[r]=!0)})},orderedq:function(t){for(let n=0;n<t.length-1;n++)if(t[n]>t[n+1])return!1;return!0},nonzero:function(t){let n,e=t.length;for(n=0;n<e;n++)if(0!==t[n])return!0;return!1},clocky:function(t){let n=0;for(let e=1;e<t.length;e+=2)n+=t[e]-t[e-1];return n},mean:function(t){let n,e=0,r=t.length;if(0==r)return 0;for(n=0;n<r;n++)e+=t[n];return e/t.length},median:function(t){let n=0,e=t.length;return t.sort((t,n)=>t-n),n=e%2==0?(t[e/2-1]+t[e/2])/2:t[(e-1)/2]},mode:function(t){if(!t||!t.length)return NaN;let n={},e=1,r=t[0];for(const u in t)n[t[u]]=(n[t[u]]||0)+1,n[t[u]]>e&&(e=n[t[u]],r=t[u]);return r},trimmean:function(t,n){const e=i(t.length*n),r=t.sort((t,n)=>t-n).slice(e,t.length-e);return r.reduce((t,n)=>t+n)/r.length},nearEq:function(t,n,e){return r(t-n)<e},daysnap:function(n){let e=t.unix(n).utc();return e.hours(0),e.minutes(0),e.seconds(0),e.milliseconds(0),e.unix()},monthsnap:function(n){let e=t.unix(n).utc();return e.date(1).hours(0).minutes(0).seconds(0).milliseconds(0),e.unix()},yearsnap:function(n){let e=t.unix(n).utc();return e.month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),e.unix()},formatDate:N,dayparse:function(t,n=""){let e,r,u;return null==t?null:(""==n?(e=R,r=E):(e=RegExp("^(\\d{4})"+n+"(\\d{2})"+n+"(\\d{2})$"),r="YYYY"+n+"MM"+n+"DD"),(u="string"!=typeof t?null:t.match(e))?Date.UTC(u[1],u[2]-1,u[3])/1e3:isNaN(t)?NaN:Number(t))},dayify:function(n,e=""){if(isNaN(n)||n<0)return"ERROR";if(null==n)return null;let r=t.unix(n).utc(),u=r.year(),o=r.month()+1,i=r.date();return""+u+e+(o<10?"0":"")+o+e+(i<10?"0":"")+i},nowstamp:function(n,e,r){let u;if(n?t.hasOwnProperty("tz")?u=t().tz(n):(console.log("butil.nowstamp: moment-timezone is not loaded, using local time"),u=t()):(console.log("butil.nowstamp: no timezone specified, using local time"),u=t()),r){const n=t.unix(r).utc(),e=(t(u).utc()-n)/1e3;(e<0||e>2*c)&&u.year(n.year()).month(n.month()).date(n.date())}return u.subtract(e,"s"),u.format("YYYYMMDD")},loadJSON:function(t){return new Promise(function(n,e){""===t&&n(null);let r=new XMLHttpRequest;r.overrideMimeType("application/json"),r.onreadystatechange=function(){if(4==r.readyState&&("200"==r.status||"0"==r.status&&""!=r.responseText))try{n(JSON.parse(r.responseText))}catch(e){console.log("butil.loadJSON: Could not parse JSON file in "+t),console.log(e.message),n(null)}else 4==r.readyState&&n(null)},r.open("GET",t,!0),r.send(null)})},toTitleCase:function(t){return t.replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})},arrayEquals:function t(n,e){if(!(n instanceof Array&&e instanceof Array))return!1;if(n.length!=e.length)return!1;for(let r=0,u=n.length;r<u;r++)if(n[r]instanceof Array&&e[r]instanceof Array){if(!t(n[r],e[r]))return!1}else if(n[r]!==e[r])return!1;return!0},lineintersect:function(t,n,e,r){const u=n[0]-t[0],o=n[1]-t[1],i=-(r[0]-e[0]),l=-(r[1]-e[1]),f=e[0]-t[0],c=e[1]-t[1],s=u*l-i*o;if(0==s)return null;const a=(l*f-i*c)/s,d=(-o*f+u*c)/s;return a<0||a>1||d<0||d>1?null:[t[0]+a*u,t[1]+a*o]},lineval:function(t,n,e){var r=(n[1]-t[1])/(n[0]-t[0]);return t[1]+r*(e-t[0])}}});
!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["moment","Polyfit","butil"],t):"object"==typeof module&&module.exports?module.exports=t(require("./moment"),require("./polyfit"),require("./butil")):e.broad=t(e.moment,e.Polyfit,e.butil)}(this,function(e,t,n){"use strict";const r=Math.max,l=Math.min,i=Math.abs,s=Math.pow,o=Math.floor,a=(Math.ceil,Math.sign,86400);var u={rsk8:0};u.AGGR={last:e=>e[e.length-1],first:e=>e[0],min:e=>n.arrMin(e),max:e=>n.arrMax(e),truemean:e=>n.mean(e),uniqmean:e=>n.mean(n.deldups(e)),average:e=>n.mean(e),mean:e=>n.mean(n.deldups(e)),median:e=>n.median(e),mode:e=>n.mode(e),trimmean:e=>n.trimmean(e,.1),sum:e=>n.sum(e),jolly:e=>e.length>0?1:0,binary:e=>e.length>0?1:0,nonzero:n.nonzero,triangle:e=>n.sum(e)*(n.sum(e)+1)/2,square:e=>s(n.sum(e),2),clocky:n.clocky,count:e=>e.length,kyshoc:e=>l(2600,n.sum(e)),skatesum:e=>l(u.rsk8,n.sum(e)),cap1:e=>l(1,n.sum(e))},u.RP={DATE:0,VALUE:1,SLOPE:2},u.printRoad=(e=>{for(let r=0;r<e.length;r++){var t=e[r];console.debug("[("+t.sta[0]+"("+n.formatDate(t.sta[0])+"),"+t.sta[1]+"),("+t.end[0]+"("+n.formatDate(t.end[0])+"),"+t.end[1]+"),"+t.slope+", auto="+t.auto+"]")}}),u.sameRoads=((e,t)=>{if(e.length!=t.length)return!1;for(let r=0;r<e.length;r++){if(!n.nearEq(e[r].end[0],t[r].end[0],10))return!1;if(!n.nearEq(e[r].end[1],t[r].end[1],10))return!1;if(!n.nearEq(e[r].slope,t[r].slope,1e-14))return!1}return!0}),u.copyRoad=(e=>{var t=[];for(let r=0;r<e.length;r++){var n={sta:e[r].sta.slice(),end:e[r].end.slice(),slope:e[r].slope,auto:e[r].auto};t.push(n)}return t}),u.findSeg=((e,t)=>n.searchHigh(e,e=>e.end[0]<t?-1:e.sta[0]>t?1:0)),u.segSlope=(e=>(e.end[1]-e.sta[1])/(e.end[0]-e.sta[0])),u.segValue=((e,t)=>e.sta[1]+e.slope*(t-e.sta[0])),u.rdf=((e,t)=>u.segValue(e[u.findSeg(e,t)],t)),u.fixRoadArray=((e,t=u.RP.VALUE,r=!1,l=u.RP.VALUE)=>{const i=e.length;e[0].sta[0]=e[0].end[0]-315576e4,e[0].sta[1]=e[0].end[1];for(let o=1;o<i-1;o++){r&&(t=e[o].auto);var s=e[o].end[1]-e[o].sta[1];e[o].sta[0]=e[o-1].end[0],e[o].sta[1]=e[o-1].end[1],t===u.RP.DATE?(isFinite(e[o].slope)&&0!=e[o].slope&&(e[o].end[0]=n.daysnap(e[o].sta[0]+(e[o].end[1]-e[o].sta[1])/e[o].slope)),e[o].end[0]<=e[o].sta[0]&&(e[o].end[0]=n.daysnap(e[o].sta[0]+a)),l===u.RP.SLOPE?e[o].end[1]=e[o].sta[1]+e[o].slope*(e[o].end[0]-e[o].sta[0]):e[o].slope=u.segSlope(e[o])):t===u.RP.VALUE?isFinite(e[o].slope)?e[o].end[1]=e[o].sta[1]+e[o].slope*(e[o].end[0]-e[o].sta[0]):e[o].end[1]=e[o].sta[1]+s:t===u.RP.SLOPE&&(e[o].slope=u.segSlope(e[o]))}i>1&&(e[i-1].sta[0]=e[i-2].end[0],e[i-1].sta[1]=e[i-2].end[1],e[i-1].end[0]=e[i-1].sta[0]+315576e4,e[i-1].end[1]=e[i-1].sta[1])}),u.gdelt=((e,t,r,l)=>n.chop(t.yaw*(l-u.rdf(e,r)))),u.aok=((e,t,n,r)=>t.yaw*(r-u.rdf(e,n))>=-1e-15*i(r)),u.pprtype=1,u.dailymin=0,u.ppr=((e,t,n,i=null,s=!1)=>{if(t.yaw*t.dir>=0)return 0;if(!s&&n<=t.asof&&(!t.ppr||t.tdat===t.asof))return 0;let o=null!==i?e[i].slope*a:u.rtf(e,n)*a,d=u.dailymin;switch(u.pprtype){case 0:return 0===o?2*-t.yaw:t.yaw*o>0?0:2*o;case 1:return 0===o&&0===d&&(d=2*-t.yaw),t.yaw<0&&o>0?r(d,2*o):t.yaw>0&&o<0?l(d,2*o):d;case 2:return t.yaw<0?r(0,d+o):l(0,d+o)}}),u.dtd=((e,t,n,l)=>{if(u.redyest(e,t,n))return 0;let i=0,s=l+u.ppr(e,t,n+i*a);for(;u.aok(e,t,n+i*a,s)&&n+i*a<=r(t.tfin,n);)i+=1,s+=u.ppr(e,t,n+i*a);return i}),u.dtdarray=((e,t)=>{let n,r,l,i,s=e.length,o=e[s-1].sta[0],d=e[s-1].sta[1],f=u.ppr(e,t,0,s-1),h=[];h=[[[o,d,0,d-f,1]]];for(let g=s-2;g>=0;g--){o=e[g].sta[0],d=e[g].sta[1],n=e[g].end[0],r=e[g].end[1],f=u.ppr(e,t,0,g,!0),l=(n-o)/a,i=isFinite(f)?[[o,d,0,r-f*l,l]]:(t.dir,[[o,d,0,r,l]]);for(var p=h[h.length-1],c=0;c<p.length;c++)isFinite(f)?i.push([o,p[c][1]-f*l,p[c][2]+l,p[c][3]-f*l,p[c][4]+l]):t.dir*(d-r)>0?i.push([o,p[c][1],p[c][2],p[c][3],p[c][4]]):i.push([o,p[c][1],p[c][2]+(n-o),p[c][3],p[c][4]+(n-o)]);h.push(i)}return h}),u.isoline_generate=((e,t,n,r)=>{var l,i,s,o,a,u,d,f,h=t[0],p=0;function c(e,t){var n=e[e.length-1];n[0]==t[0]&&n[1]==t[1]||e.push(t)}for(i=[[h[0][0]+864e3,h[0][1]+r*(h[0][3]-h[0][1])],[h[0][0],h[0][1]+r*(h[0][3]-h[0][1])]],o=1;o<t.length;o++){for(s=(l=t[o]).length-1,a=0;a<l.length;a++)if(r<=l[a][4]){s=a;break}for(a=p;a>=s;a--)u=[h[a][0],h[a][1],h[a][2]],(d=[l[a][0],l[a][3],l[a][4]])[2]-u[2]==0?c(i,[u[0],u[1]]):(f=(r-u[2])/(d[2]-u[2]),c(i,[u[0]+f*(d[0]-u[0]),u[1]+f*(d[1]-u[1])]));u=[l[s][0],l[s][1],l[s][2]],(d=[l[s][0],l[s][3],l[s][4]])[2]-u[2]==0?c(i,[u[0],u[1]]):(f=(r-u[2])/(d[2]-u[2]),c(i,[u[0]+f*(d[0]-u[0]),u[1]+f*(d[1]-u[1])])),p=s,h=l}return i.reverse()}),u.isoline_dolessclip=((e,t,r,l,i)=>{if(0==i)return e;const s=(e,n)=>{let r=t[n],i=u.ppr(t,l,r.sta[0],n,!0);return[[e[0],e[1]],[r.end[0],e[1]+i*(r.end[0]-e[0])/a]]};let o,d,f,h,p=[],c=!1,g=!1;const m=function(e,t){e.push([t[0],t[1]])};for(f=0;f<e.length-1;)if(g||m(p,e[f]),e[f+1][0]==e[f][0]&&(e[f+1][1]-e[f][1])*l.dir>0){for(h=e[f+1][0]+i*a,d=u.findSeg(t,e[f][0]),o=s(e[f],d);f<e.length-1&&e[f+1][0]==e[f][0];)f++;(e[f][1]-o[0][1])*l.dir>0&&(c=!0,g=!0)}else if(c){if(e[f][0]>=h||o[0][0]>=h){m(p,[h,u.isoval(e,h)]),c=!1,g=!1,e[f][0]==h&&f++;continue}if(g){let r=n.lineintersect(e[f],e[f+1],o[0],o[1]);if(null!=r)m(p,r),g=!1,f++;else if(o[1][0]<=e[f+1][0]){for(m(p,o[1]),d++;!isFinite(t[d].slope);)d++;o=s(o[1],d)}else f++}else{let r=n.lineintersect(e[f],e[f+1],o[0],o[1]);if(null!=r&&r[0]!=e[f][0]&&r[0]!=e[f+1][0]&&console.log("Found intersection while on the isoline!!!"),e[f][0]>=o[1][0]){for(d++;!isFinite(t[d].slope);)d++;o=s(o[1],d)}else f++}}else f++;return p}),u.isoline_monotonicity=((e,t,n,r,l)=>{if(r.yaw*r.dir<0)return u.isoline_dolessclip(e,t,n,r,l);let i,s,o,d,f=[],h=!1,p=!1;const c=function(e,t){e.push([t[0],t[1]])};for(d=-1,o=0;o<e.length-1;o++)if((e[o+1][1]-e[o][1])*r.dir>0&&(h=!1),c(f,e[o]),0!=l&&(e[o+1][1]-e[o][1])*r.dir<0&&!h)for(h=!0,d=o+1,p=!1;!p;)e[d][0]>=e[o][0]+l*a?(p=!0,c(f,[s=e[o][0]+l*a,e[o][1]])):(e[d+1][1]-e[d][1])*r.dir>=0&&(e[d+1][0]!=e[d][0]?0!=(i=(e[d+1][1]-e[d][1])/(e[d+1][0]-e[d][0]))&&(s=e[d][0]+(e[o][1]-e[d][1])/i)<=e[o][0]+l*a&&s<=e[d+1][0]&&(p=!0):(e[o][1]-e[d][1])*(e[o][1]-e[d+1][1])<0&&(s=e[d][0]+1,p=!0),p&&c(f,[s,e[o][1]])),d++;return f}),u.isoline_nobackward=((e,t,n,r,l)=>{var i,s,o,a=[e[0].slice()];for(o=1;o<e.length;o++)i=a[a.length-1],e[o][0]<i[0]||(e[o-1][0]<i[0]&&e[o][0]>i[0]&&e[o][0]-e[o-1][0]!=0&&(s=(e[o][1]-e[o-1][1])/(e[o][0]-e[o-1][0]),a.push([i[0],e[o-1][1]+s*(i[0]-e[o-1][0])])),a.push([e[o][0],e[o][1]]));return a}),u.isoline_clip=((e,t,i,s,o)=>{var a=[];function d(e,t,n,i=-1){for(var s=n.slice(),o=u.findSeg(e,n[0]),a=u.segValue(e[o],n[0]);--o>=0&&e[o].sta[0]==n[0];)a=-i*t.yaw>0?l(a,e[o].sta[1]):r(a,e[o].sta[1]);return(s[1]-a)*t.yaw<0&&(s[1]=a),s}var f,h=0,p=0;for(f=e[1][0]!=e[0][0]?1:-1,a.push(d(t,s,e[0],f));!(h>t.length-1||p>e.length-2);){var c=a.length-1,g=n.lineintersect(t[h].sta,t[h].end,e[p],e[p+1]);null==g||g[0]==a[c][0]&&g[1]==a[c][1]||a.push(g),t[h].end[0]<e[p+1][0]?((n.lineval(e[p],e[p+1],t[h].end[0])-t[h].end[1])*s.yaw<0&&a.push([t[h].end[0],t[h].end[1]]),h++):(f=++p<e.length-1&&e[p][0]!=e[p+1][0]?1:-1,a.push(d(t,s,e[p],f)))}return a}),u.isoline=((e,t,n,r,l=!1)=>{let i=u.isoline_generate(e,t,n,r),s=u.isoline_monotonicity(i,e,t,n,r),o=u.isoline_nobackward(s,e,t,n,r),a=u.isoline_clip(o,e,t,n,r);return l?[i,s,o,a]:a}),u.isoval=((e,t)=>{if(!e||!e.length)return null;if(t<=e[0][0])return e[0][1];if(t>=e[e.length-1][0])return e[e.length-1][1];const r=n.searchLow(e,e=>e[0]<=t?-1:1);return n.rescale(t,e[r][0],e[r+1][0],e[r][1],e[r+1][1])}),u.isoside=((e,t,n,r)=>{const l=u.isoval(t,n);return null===l?0:(r-l)*e.yaw>=-1e-15*i(r)?1:-1}),u.dtd_walk=((e,t,n,r)=>{let l=0;for(;u.gdelt(e,t,n+l*a,r)>=0&&n+l*a<=t.tfin;)l+=1;return l}),u.bufcap=((e,t,n=7)=>{const r=t.tcur,l=u.rdf(e,r),s=i(u.rtf(e,r));let o=0,d=0;for(;u.dtd_walk(e,t,r,l+o)<n&&d<=70;)o+=t.yaw*s*a,d+=1;return[o,d]}),u.tvr=((e,t,r,i,s)=>null===r?0===s?n.BDUSK:n.daysnap(l(n.BDUSK,e+(i-t)/s)):null===i?t+s*(r-e):null===s?r===e?0:(i-t)/(r-e):0);const d=(e,t)=>{const n=e[0],r=e[1],l=(e[2],e[3],t[0]),i=t[1],s=t[2],o=u.tvr(n,r,l,i,s);return null===l?[o,i,s,0]:null===i?[l,o,s,1]:null===s?[l,i,o,2]:[l,i,o,0]};return u.fillroad=((e,t)=>{e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]/t.siru),e[0]=d([t.tini,t.vini,0,0],e[0]);for(let t=1;t<e.length;t++)e[t]=d(e[t-1],e[t]);for(e.forEach(e=>e[2]=null==e[2]?e[2]:e[2]*t.siru);void 0!==e&&void 0!==e[0]&&e[0][0]<t.tini;)e.shift();return e}),u.fillroadall=((e,t)=>{const n=e[0][0],r=e[0][1];e.splice(0,1),e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]/t.siru),e[0]=d([n,r,0,0],e[0]);for(let t=1;t<e.length;t++)e[t]=d(e[t-1],e[t]);return e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]*t.siru),e.unshift([n,r,0,2]),e}),u.rtf=((e,t)=>e[u.findSeg(e,t)].slope),u.odomify=(e=>{if(!e||!e.length||0===e.length)return;let t=0,n=e[0][1];for(let r=1;r<e.length;r++)0===e[r][1]&&(t+=n),n=e[r][1],e[r][1]+=t}),u.stepFunc=((e,t)=>{return e[r(0,n.searchLow(e,e=>e[0]-t))][1]}),u.stepify=(e=>e&&e.length?t=>u.stepFunc(e,t):e=>0),u.dotcolor=((e,t,r,l,i=null)=>r<t.tini?n.BHUE.BLCK:null===i?u.aok(e,t,r,l)?n.BHUE.BLCK:n.BHUE.REDDOT:!i||!i.length||i.length<1?n.BHUE.ERRDOT:u.isoside(t,i[0],r,l)<0?n.BHUE.REDDOT:u.isoside(t,i[1],r,l)<0?n.BHUE.ORNDOT:u.isoside(t,i[2],r,l)<0?n.BHUE.BLUDOT:u.isoside(t,i[6],r,l)<0?n.BHUE.GRNDOT:n.BHUE.GRADOT),u.redyest=((e,t,r,l=null)=>u.dotcolor(e,t,r-a,t.dtf(r-a),l)===n.BHUE.REDDOT),u.stdflux=((e,t)=>{if(!t||!t.length||t.length<=1)return 0;const r=n.partition(t,2,1);let l,s,o,d,f=[];for(let t=0;t<r.length;t++)l=r[t][0][0],s=r[t][0][1],o=r[t][1][0],d=r[t][1][1],f.push(i(d-s-u.rdf(e,o)+u.rdf(e,l))/(o-l)*a);return n.chop(1===f.length?f[0]:n.quantile(f,.9))}),u.autowiden=((e,t,l,s)=>{let o=l;if(o<=1)return 0;let d=-1;if(u.gdelt(e,t,l[l.length-1][0],l[l.length-1][1])<0){for(;d>=-o&&u.gdelt(e,t,l[d][0],l[d][1])<0;)d-=1;(d+=1)>-o&&l[d][0]-l[d-1][0]<=a&&(s=r(s,i(l[d][1]-u.rdf(e,l[d][0]))))}return n.chop(s)}),u.vertseg=((e,t)=>e.filter(e=>e.sta[0]===t).length>1),u.gapFill=(e=>{if(!e||!e.length)return[];const t=(e,t,n)=>e+(t-e)*n;var n,r=e[0][0],l=e[e.length-1][0],i=o((l-r)/a),s=Array(i),u=0,d=r;for(n=0;n<e.length-1;n++)for(var f=e[n+1][0]-e[n][0];d<=e[n+1][0];)s[u]=[d,t(e[n][1],e[n+1][1],(d-e[n][0])/f)],u++,d+=a;return 0===s.length&&s.push(e[0]),s}),u.smooth=(e=>{if(!e||!e.length)return e=>e;const s=(e[0][0]+e[e.length-1][0])/2,o=n.zip(e),u=o[0].map(e=>(e-s)/a),d=new t(u,o[1]);let f=d.getPolynomial(3);const h=i(r(...o[1])-l(...o[1]));return d.standardError(d.computeCoefficients(3))>1e4*h&&(console.log("butil.smooth: Possible ill-conditioned polyfit. Reducing dimension."),f=d.getPolynomial(2)),e=>f((e-s)/a)}),u.smooth2=(e=>{if(!e||!e.length)return e=>e;const t=n.zip(e);n.splinefit(t[0],t[1]);return e=>e}),u.interpData=((e,t)=>{var n=(e,t,n)=>e+(t-e)*n,r=0,l=e.length,i=[];if(0===l)return null;if(1===l)return t.map(e=>[e,e[0][1]]);for(let o=0;o<t.length;o++){var s=t[o];if(s<=e[0][0])i.push([s,e[0][1]]);else if(s>=e[l-1][0])i.push([s,e[l-1][1]]);else if(s<e[r+1][0])i.push([s,n(e[r][1],e[r+1][1],(s-e[r][0])/(e[r+1][0]-e[r][0]))]);else{for(;s>e[r+1][0];)r++;i.push([s,n(e[r][1],e[r+1][1],(s-e[r][0])/(e[r+1][0]-e[r][0]))])}}return i}),u.lim=((e,t,n)=>u.rdf(e,t.tcur+n*a)),u.limd=((e,t,n)=>u.lim(e,t,n)-t.vcur),u.dueby=((e,t,r)=>{let l=[...Array(r).keys()].map(r=>[n.dayify(t.tcur+r*a),u.limd(e,t,r),u.lim(e,t,r)]);const i=n.zip(l);return n.zip([i[0],n.monotonize(i[1],t.dir),n.monotonize(i[2],t.dir)])}),u});
((n,t)=>{"use strict";"function"==typeof define&&define.amd?define(["fili","moment","butil","broad"],t):"object"==typeof module&&module.exports?module.exports=t(require("./fili"),require("./moment"),require("./butil"),require("./broad")):n.beebrain=t(n.Fili,n.moment,n.butil,n.broad)})(this,(n,t,i,a)=>{"use strict";const r=Math.max,e=Math.min,l=Math.abs,o=Math.exp,s=Math.floor,u=Math.ceil,f=Math.sign,m=365.25,d=86400;let c=1;const p={quantum:1e-5,timey:!1,ppr:!0,deadline:0,asof:null,tini:null,vini:null,road:[],tfin:null,vfin:null,rfin:null,runits:"w",gunits:"units",yaw:0,dir:0,pinkzone:[],tmin:null,tmax:null,vmin:null,vmax:null,kyoom:!1,odom:!1,maxflux:0,monotone:!1,aggday:null,plotall:!0,steppy:!1,rosy:!1,movingav:!1,aura:!1,hashtags:!0,yaxis:"",waterbuf:null,waterbux:"",hidey:!1,stathead:!0,yoog:"U/G",goal:null,rate:null},h={sadbrink:!1,safebump:null,dueby:[],fullroad:[],pinkzone:[],tluz:null,tcur:null,vcur:null,vprev:null,rcur:null,ravg:null,tdat:null,stdflux:0,delta:0,lane:666,cntdn:0,numpts:0,mean:0,meandelt:0,proctm:0,statsum:"",ratesum:"",deltasum:"",graphsum:"",progsum:"",safesum:"",rah:0,safebuf:null,error:"",limsum:"",headsum:"",titlesum:"",lnw:0,color:"black",loser:!1,gldt:null,goal:null,rate:null,road:[],tini:null,vini:null,tfin:null,vfin:null,rfin:null},g=["timezone","usr","graph","ybhp","integery","noisy","abslnw","tagtime","backroad","edgy","offred","sadlhole","imgsz"],y={AGGPAST:0,AGGFUTURE:1,RAWPAST:2,RAWFUTURE:3,FLATLINE:4,HOLLOW:5};return function(v){let b=this,x=c;c++,v=i.deepcopy(v);let w=[],A={},z=[],k=[],R=[],M=[],E=[],F=[],S=[],U={},G={},T={},P={},O=[];A.yaw=1,A.dir=1,A.tcur=0,A.vcur=0,A.vprev=0;const L=t.utc();function N(n){if(n.fullroad=n.fullroad.map(n=>(function(n){return Array.isArray(n)?n.length<=3?n:n.slice(0,3):n})(n)),n.road=n.fullroad,n.error)n.gldt=i.dayify(A.tfin),n.goal=A.vfin,n.rate=A.rfin*A.siru;else{const t=n.fullroad.length;t>0&&(n.gldt=n.fullroad[t-1][0],n.goal=n.fullroad[t-1][1],n.rate=n.fullroad[t-1][2])}n.tini=i.dayify(A.tini),n.vini=A.vini,n.tfin=i.dayify(A.tfin),n.vfin=A.vfin,n.rfin=A.rfin}function D(n){return Array.isArray(n)&&3===n.length?[i.dayparse(n[0]),n[1],n[2]]:n}function K(n){if(n.length<1)return n;let t=n.slice();return t[0]=i.dayify(n[0]),t}function q(n,t){let i=.25/d;"meta/derev"===A.yoog&&(i=.03/d),"meta/dpledge"===A.yoog&&(i=.03/d);let a,r,e,l,s,u=n[0][0],f=n[0][1],m=f;if(t<u)return m;for(e=1;e<n.length;e++){if(a=(r=n[e])[0]-u,l=(r[1]-f)/a,s=f,t<r[0])return s+l*(a=t-u)-l/i+(m-s+l/i)*o(-i*a);m=s+l*a-l/i+(m-s+l/i)*o(-i*a),u=r[0],f=r[1]}return s+l*(a=t-u)-l/i+(m-s+l/i)*o(-i*a)}function I(n,t,a){let r=i.zip(n);return r[1]=function(n,t,a){return function(n,t,i){let a=[t];for(let t=0;t<i.length;t++)a.push(n(a[t],i[t]));return a}((n,a)=>i.clip(n,a-t,a+t),n[0]+a*t,n.slice(1,n.length))}(r[1],t,a),i.zip(r)}function $(n,t,i){return I(n.slice().reverse(),t,i).reverse()}let B;L.hour(0),L.minute(0),L.second(0),L.millisecond(0),A.asof=L.unix(),A.horizon=A.asof+i.AKH,A.xMin=A.asof,A.xMax=A.horizon,A.yMin=-1,A.yMax=1;try{B=new RegExp("(?:^|\\s)(#\\p{L}[\\p{L}0-9_]*)(?=$|[\\s])","gu")}catch{B=/(?:^|\s)(#[a-zA-Z]\w*)(?=$|\s)/g}function H(n){let t,i=new Set;for(B.lastIndex=0;null!=(t=B.exec(n));)""!=t[1]&&i.add(t[1]);return i}function C(n){return n[1]}function j(n,t){const a=A.kyoom&&"sum"===A.aggday;if(1===n.length)return[n[0][2],n[0][3],n[0][4]];{let r;return(r=a?i.accumulate(n.map(C)).indexOf(t):n.map(C).indexOf(t))<0?[A.aggday,null,null]:[n[r][1]+" ("+A.aggday+")",n[r][3],n[r][4]]}}let W=null;function Y(n){return JSON.stringify(null===n[0]?n:[i.formatDate(n[0]),n[1],n[2]])}function J(n){return!(!i.listy(n)||3!=n.length)&&(null==n[0]&&i.nummy(n[1])&&i.nummy(n[2])||i.nummy(n[0])&&null==n[1]&&i.nummy(n[2])||i.nummy(n[0])&&i.nummy(n[1])&&null==n[2])}const V=n=>i.nummy(n)&&0<n&&n<i.BDUSK,Z=n=>"boolean"==typeof n,_=n=>i.nummy(n)||null===n,Q=n=>V(n)||null===n,X={quantum:[i.nummy,"isn't numeric"],timey:[Z,"isn't boolean"],ppr:[Z,"isn't boolean"],deadline:[n=>i.nummy(n)&&-64800<=n&&n<=21600,"outside 6am earlybird and 6am nightowl"],asof:[V,"isn't a valid timestamp"],tini:[V,"isn't a valid timestamp"],vini:[i.nummy,"isn't numeric"],road:[i.listy,"(graph matrix) isn't a list"],tfin:[Q,"isn't a valid timestamp or null"],vfin:[_,"isn't numeric or null"],rfin:[_,"isn't numeric or null"],runits:[n=>n in i.SECS,"isn't a valid rate unit"],gunits:[i.stringy,"isn't a string"],yaw:[n=>-1===n||0===n||1===n,"isn't -1 or 1 or 0"],dir:[n=>1==n||-1==n,"isn't -1 or 1"],pinkzone:[i.listy,"isn't a a list"],tmin:[Q,"isn't a valid timestamp or null"],tmax:[Q,"isn't a valid timestamp or null"],vmin:[_,"isn't numeric or null"],vmax:[_,"isn't numeric or null"],kyoom:[Z,"isn't boolean"],odom:[Z,"isn't boolean"],monotone:[Z,"isn't boolean"],aggday:[n=>n in a.AGGR,"isn't one of max, sum, last, mean, etc"],plotall:[Z,"isn't boolean"],steppy:[Z,"isn't boolean"],rosy:[Z,"isn't boolean"],movingav:[Z,"isn't boolean"],aura:[Z,"isn't boolean"],hashtags:[Z,"isn't boolean"],yaxis:[n=>i.stringy(n)&&n.length<80,"isn't a string of at most 79 chars"],waterbuf:[n=>i.stringy(n)||null===n,"isn't a string or null"],waterbux:[i.stringy,"isn't a string"],hidey:[Z,"isn't boolean"],stathead:[Z,"isn't boolean"],yoog:[i.stringy,"isn't a string"],goal:[_,"isn't numeric or null"],rate:[_,"isn't numeric or null"]};function nn(){A.dtf=a.stepify(k),A.road=a.fillroad(A.road,A);const t=A.road.length;A.tfin=A.road[t-1][0],A.vfin=A.road[t-1][1],A.rfin=A.road[t-1][2];const l=A.road.map(n=>n[0]);if(A.tini>l[0])return"Graph matrix error\\n(There are segments of your bright red line\\nthat are somehow dated before your goal's start date!)";if(!i.orderedq(l))return"Dial error\\n(Your goal date, goal "+(A.kyoom?"total":"value")+", and rate are inconsistent!\\nIs your rate positive when you meant negative?\\nOr is your goal "+(A.kyoom?"total":"value")+" such that the implied goal date is in the past?)";A.stdflux=a.stdflux(w,k.filter(n=>n[0]>=A.tini)),function(){const n=0===k.length?[A.tini,A.vini]:k[k.length-1],t=n[0],i=n[1];if(t>A.tfin)return;const r=n=>!a.aok(w,A,n,i);let l=e(A.asof,A.tfin);if(A.yaw*A.dir>0)for(;r(l-d)&&l-d>t&&r(l-2*d)&&l-d>A.tini;)l-=d;l in G||(W=[l,i,"PPR",y.FLATLINE,t,i,null],t==l&&"PPR"==n[2]?k[k.length-1]=W:k.push(W))}();const o=k.length;if(A.movingav)if(o<=1||k[o-1][0]-k[0][0]<=0)A.filtpts=[];else if(void 0!==n){let n=(new Fili.FirCoeffs).lowpass({order:20,Fs:1e3,Fc:50}),t=(new Fili.FirFilter(n),(new Fili.CalcCascades).lowpass({order:1,characteristic:"bessel",Fs:1e3,Fc:50,gain:0,preGain:!1})),a=new Fili.IirFilter(t),r=k[0][0],e=k[o-1][0],l=i.linspace(r,e,1+u((e-r)/d)),s=k[0][1],f=k[o-1][1],m=k[0][0],c=(f-s)/(k[o-1][0]-m),p=[0],h=0,g=(k[h+1][1]-k[h][1])/(k[h+1][0]-k[h][0]);for(let n=1;n<l.length;n++)if(l[n]==k[h+1][0]){if(p.push(k[h+1][1]-s-c*(l[n]-m)),++h==k.length-1)break;g=(k[h+1][1]-k[h][1])/(k[h+1][0]-k[h][0])}else{if(l[n]>k[h+1][0]){if(++h==k.length)break;g=(k[h+1][1]-k[h][1])/(k[h+1][0]-k[h][0])}p.push(k[h][1]+(l[n]-k[h][0])*g-s-c*(l[n]-m))}const y=50;for(let n=0;n<y;n++)p.push(0);let v=a.filtfilt(p);v.splice(1-y,y-1),A.filtpts=i.zip([l,v.map(n=>n+s)]).map(n=>[n[0],n[1]+c*(n[0]-m)]),console.log(i.shd(r)),console.log(i.shd(e)),console.log(A.filtpts)}else{const n=function(n,t,a=6e3){return i.linspace(n,t,s(i.clip((t-n)/(d+1),e(600,640),a)))}(k[0][0],k[o-1][0],4*(k[o-1][0]-k[0][0])/d);A.filtpts=n.map(n=>[n,q(k,n)])}else A.filtpts=[];return A.tcur=0===o?A.tini:k[o-1][0],A.vcur=0===o?A.vini:k[o-1][1],A.vprev=k[r(o-2,0)][1],A.safebuf=a.dtd(w,A,A.tcur,A.vcur),A.tluz=e(A.tcur+A.safebuf*d,A.tfin+d,i.BDUSK),A.tluz>A.tfin&&(A.tluz=i.BDUSK),A.delta=i.chop(A.vcur-a.rdf(w,A.tcur)),A.rah=a.rdf(w,A.tcur+i.AKH),A.dueby=a.dueby(w,A,7),A.safebump=a.lim(w,A,A.safebuf),A.rcur=a.rtf(w,A.tcur)*A.siru,A.ravg=a.tvr(A.tini,A.vini,A.tfin,A.vfin,null)*A.siru,A.cntdn=u((A.tfin-A.tcur)/d),A.lane=A.yaw*(A.safebuf-(A.safebuf<=1?2:1)),A.color=A.safebuf<1?"red":A.safebuf<2?"orange":A.safebuf<3?"blue":"green",A.loser=a.redyest(w,A,A.tcur),A.sadbrink=A.tcur-d>A.tini&&a.dotcolor(w,A,A.tcur-d,A.dtf(A.tcur-d,A.isolines))==i.BHUE.REDDOT,function(){if(null==A.tmin&&(A.tmin=e(A.tini,A.asof)),null==A.tmax){const n=s((A.tcur-A.tmin)/(m*d));A.tmax=i.daysnap(2*(1+n/2)*i.AKH+A.tcur)}if(null!=A.vmin&&null!=A.vmax)return void(A.vmin==A.vmax?(A.vmin-=1,A.vmax+=1):A.vmin>A.vmax&&([A.vmin,A.vmax]=[A.vmax,A.vmin]));const n=a.rdf(w,A.tmin),t=a.rdf(w,A.tmax),l=k.filter(n=>n[0]<=A.tmax&&n[0]>=A.tmin).map(n=>n[1]);let o=i.arrMin(l),u=i.arrMax(l);if(null!=W&&W[0]<=A.tmax&&W[0]>=A.tmin){const n=W[1]+a.ppr(w,A,A.asof);o=e(o,n),u=r(u,n)}const f=r(0,.015*(u-o)*2);let c=o-f,p=u+f;A.monotone&&A.dir>0?(c=i.arrMin([c,n,t]),p=i.arrMax([p,n,t])):(A.monotone&&A.dir,c=i.arrMin([c,n,t]),p=i.arrMax([p,n,t])),A.plotall&&A.tmin<=A.tini&&A.tini<=A.tmax&&A.tini in U&&(c=e(c,i.arrMin(U[A.tini].map(n=>n[1]))),p=r(p,i.arrMax(U[A.tini].map(n=>n[1])))),null==A.vmin&&null==A.vmax?(A.vmin=c,A.vmax=p,A.vmin==A.vmax?(A.vmin-=1,A.vmax+=1):A.vmin>A.vmax&&([A.vmin,A.vmax]=[A.vmax,A.vmin])):null==A.vmin?A.vmin=c<A.vmax?c:A.vmax-1:null==A.vmax&&(A.vmax=p>A.vmin?p:A.vmin+1)}(),""}function tn(n,t){const r=t.yaw,e=t.dir,o=t.lane,u=t.delta,m=t.quantum,c=r>0&&e>0,p=r<0&&e<0,h=r<0&&e>0,g=r>0&&e<0,y=(n,t=r,a=4,e=2)=>null===m?i.shn(n,a,e,t):i.conservaround(n,m,t),v=(n,t=r,i=4,a=2)=>(n>=0?"+":"")+y(n,t,i,a);if(""!=t.error)return void(t.statsum=" error:    "+t.error+"\\n");const b=i.zip(t.road)[2];let x=i.arrMin(b),A=i.arrMax(b);if(l(x)>l(A)){const n=x;x=A,A=n}const z=i.shn(x,4,2),R=i.shn(A,4,2),M=i.shn(t.ravg,4,2),E=i.shn(t.rcur,4,2);t.ratesum=(x===A?z:"between "+z+" and "+R)+" per "+i.UNAM[t.runits]+(x!==A?" (current: "+E+", average: "+M+")":"");const F=i.daysnap(t.tini),S=i.daysnap(t.tcur),U=i.daysnap(t.tfin),G=t.vini,T=t.vcur,P=t.vfin;let O,L,N,D;O=F===U?"??":i.shn(i.rescale(S,F,U,0,100),1,1),L=G===P?T<G&&t.yaw>0||T>G&&t.yaw<0?"00":"100":l(G-P)<1e-7?T<(G+P)/2&&t.yaw>0||T>(G+P)/2&&t.yaw<0?"~0":"~100":i.shn(i.rescale(t.vcur,t.vini,t.vfin,0,100),1,1),t.progsum=O==L?O+"% done":O+"% done by time -- "+L+"% by value",t.cntdn<7?(N=f(t.rfin)*(t.vfin-t.vcur),D="w/ "+y(N,0,2,1)+" to go to goal"):D="@ "+((N=a.rdf(w,t.tcur+t.siru)-a.rdf(w,t.tcur))>=0?"+":"")+i.shn(N,2,1,0)+" / "+i.UNAM[t.runits],t.graphsum=(t.asof!==t.tcur?"["+i.shd(t.asof)+"] ":"")+y(t.vcur,0,3,1)+" on "+i.shd(t.tcur)+" ("+i.splur(t.numpts,"datapoint")+" in "+i.splur(1+s((t.tcur-t.tini)/d),"day")+") targeting "+y(t.vfin,0,3,1)+" on "+i.shd(t.tfin)+" ("+i.splur(t.cntdn,"more day")+") "+D,t.deltasum=y(l(u),0)+" "+t.gunits+(u<0?" below":" above")+" the bright line";const K=t.safebuf,q=i.splur(K,"day"),I=a.lim(w,t,c||p?K:0),$=a.limd(w,t,c||p?K:0);t.kyoom?(c&&(t.limsum=v($)+" in "+q),p&&(t.limsum=v($)+" in "+q),h&&(t.limsum=v($)+" today"),g&&(t.limsum=v($)+" today")):(c&&(t.limsum=v($)+" in "+q+" ("+y(I)+")"),p&&(t.limsum=v($)+" in "+q+" ("+y(I)+")"),h&&(t.limsum=v($)+" today ("+y(I)+")"),g&&(t.limsum=v($)+" today ("+y(I)+")")),t.titlesum=i.toTitleCase(t.color)+": bmndr.com/"+t.yoog+" is safe for ~"+q+(0===K?" (beemergency!)":""),t.headsum=t.titlesum,t.statsum=" progress: "+i.shd(t.tini)+"  "+(null==k?"?":i.shn(t.vini,4,2,0))+"\\n           "+i.shd(t.tcur)+"  "+i.shn(t.vcur,4,2,0)+"   ["+t.progsum+"]\\n           "+i.shd(t.tfin)+"  "+i.shn(t.vfin,4,2,0)+"\\n rate:     "+t.ratesum+"\\n lane:     "+(666==l(o)?"n/a":o)+"\\n safebuf:  "+t.safebuf+"\\n delta:    "+t.deltasum+"\\n ",t.statsum+=0==r?"limit:    ":r<0?"hard cap: ":"bare min: ",t.statsum+=t.limsum+"\\n",function(n,t){const a=t.yaw,r=t.dir,e=(t.delta,t.quantum,t.safebuf),l=i.splur(e,"day");t.safesum=a*r<0?"unknown days of safety buffer":e>999?"more than 999 days of safety buffer":"~"+l+" of safety buffer"}(0,t)}this.reloadRoad=function(){const n=nn();if(""!=n)return n;if(tn(0,A),A.fullroad=A.road.slice(),A.fullroad.unshift([A.tini,A.vini,0,0]),""==A.error&&(A.pinkzone=[[A.asof,a.rdf(w,A.asof),0]],A.road.forEach(function(n){n[0]>A.asof&&n[0]<A.asof+i.AKH&&A.pinkzone.push([n[0],n[1],null])}),A.pinkzone.push([A.asof+i.AKH,a.rdf(w,A.asof+i.AKH),null]),A.pinkzone=a.fillroadall(A.pinkzone,A)),A.aura){const n=k.filter(n=>n[0]>=A.tmin),t=a.gapFill(n);A.auraf=a.smooth(t)}else A.auraf=(n=>0);A.dtdarray=a.dtdarray(w,A),A.isolines=[];for(let n=0;n<4;n++)A.isolines[n]=a.isoline(w,A.dtdarray,A,n);return""};let an={};this.getStats=function(){return i.deepcopy(an)},this.setRoadObj=function(n){if(0!=n.length){w=n,b.roads=w,A.road=[];for(let n=1;n<w.length;n++)A.road.push([w[n].sta[0],w[n].sta[1],w[n].slope]);b.gol=A,b.reloadRoad()}else console.log("id="+x+", setRoadObj(), null redline!")},function(n,l,o=null){try{null==o&&(o=t.utc().unix()),function(n){"goal"in n&&!("vfin"in n)&&(n.vfin=n.goal),"rate"in n&&!("rfin"in n)&&(n.rfin=n.rate)}(n),function(){k=[],W=null,M=[],U={},G={},T={},(A={}).siru=null,E=[],F=[],P={};for(const n in h)A[n]=h[n];for(const n in p)A[n]=p[n]}(),A.proctm=o,k=function(n,t){return["asof","tini","tfin","tmin","tmax"].map(t=>{t in n&&(n[t]=i.dayparse(n[t]))}),"road"in n&&i.listy(n.road)&&(n.road=n.road.map(D)),t.map((n,t)=>[i.dayparse(n[0]),n[1],n[2],t,n[1]]).sort((n,t)=>n[0]!==t[0]?n[0]-t[0]:n[3]-t[3])}(n,l);const s=[];for(const t in n)t in n&&(t in p||g.includes(t)?A[t]=n[t]:s.push(`${t}=${n[t]}`));s.length>0&&(A.error+=`Unknown param${1===s.length?"":"s"}: ${s.join(", ")}`),"aggday"in n||(n.aggday=A.kyoom?"sum":"last"),A.siru=i.SECS[A.runits],A.horizon=A.asof+i.AKH-d,A.waterbuf0=A.waterbuf,i.listy(A.road)&&A.road.push([A.tfin,A.vfin,A.rfin]),""==A.error&&(A.error=function(){for(const n in X){const t=X[n][0],i=X[n][1];if(!t(A[n]))return`${n} = ${JSON.stringify(A[n])}\\nERROR: ${i}`}for(const n of A.road)if(!J(n))return"Invalid graph matrix row: "+Y(n);for(const n of A.pinkzone)if(!J(n))return"Invalid pinkzone row: "+Y(n);const n=A.road.slice(1,A.road.length-1);if(n.length!==i.deldups(n).length){let t=n[0];for(const a of n){if(i.arrayEquals(a,t))return"Graph matrix has duplicate row: "+Y(a);t=a}}return A.kyoom&&A.odom?"The odometer setting doesn't make sense for an auto-summing goal!":A.tmin>A.asof?"You can't set the graph bounds to be solely in the future!":""}()),""==A.error&&(A.error=function(){if(!k||!k.length)return"No datapoints";const n=k.length;let t;for(t=0;t<n;t++){const n=k[t];if(!(i.nummy(n[0])&&n[0]>0&&i.nummy(n[1])&&i.stringy(n[2])))return"Invalid datapoint: "+n[0]+" "+n[1]+' "'+n[3];if(A.hashtags){const t=H(n[2]);if(0==t.size)continue;n[0]in P||(P[n[0]]=new Set);for(const i of t)P[n[0]].add(i)}}if(A.hashtags){O=[];for(const n in P)O.push([n,Array.from(P[n]).join(" ")])}for(F=(F=k.filter(n=>(function(n){return/(?:^|\s)#DERAIL(?=$|\s)/.test(n)||n.startsWith("RECOMMITTED ON")})(n[2]))).map(n=>n.slice()),t=0;t<F.length;t++)F[t][0]<1562299200&&(F[t][0]-=d);A.odom&&(E=k.filter(n=>0==n[1]).map(n=>n[0]),a.odomify(k));const r=k.filter(n=>n[0]<=A.asof);A.plotall&&(A.numpts=r.length),U={},G={};let e,l=[],o=k[0][0],s=[],u=0;for(a.rsk8=A.rfin*d/A.siru,t=0;t<=n;t++)if(t<n&&k[t][0]==o&&s.push(k[t].slice()),t>=k.length||k[t][0]!=o){let n=s.map(C),r=a.AGGR[A.aggday](n);e=l.length>0?l[l.length-1]:[o,r+u];let f=j(s,r);l.push([o,u+r,f[0],o<=A.asof?y.AGGPAST:y.AGGFUTURE,e[0],e[1],f[2],f[1]]),A.kyoom?("sum"===A.aggday?U[o]=i.accumulate(n).map((n,t)=>[o,n+u,s[t][2],s[t][3],s[t][4]]):U[o]=s.map(n=>[o,n[1]+u,n[2],n[3],n[4]]),G[o]=u+r,u+=r):(U[o]=s,G[o]=r);const m=U[o].map(n=>n[1]);T[o]=A.yaw<0?i.arrMax(m):i.arrMin(m),t<k.length&&(o=k[t][0],s=[k[t].slice()])}let f=[];for(let n in U)f=f.concat(U[n].map(t=>[Number(n),t[1],t[2],Number(n)<=A.asof?y.AGGPAST:y.AGGFUTURE,null,null,t[4],t[3]]));if(z=f,M=l.filter(n=>n[0]>A.asof),k=l.filter(n=>n[0]<=A.asof),A.plotall||(A.numpts=k.length),0==k.length)return A.tdat=A.tcur,A.mean=0,S=[],"";const m=a.gapFill(k).map(n=>n[1]);for(k.length>0&&(A.mean=i.mean(m)),k.length>1&&(A.meandelt=i.mean(i.partition(m,2,1).map(n=>n[1]-n[0]))),A.tdat=k[k.length-1][0],t=0;t<F.length;t++){const n=1562299200;(o=F[t][0]<n?F[t][0]+d:F[t][0])in T&&(F[t][1]=G[o])}return S=k.filter(n=>n[0]in U&&n[0]<A.asof&&!U[n[0]].map(n=>n[1]).includes(n[1])),""}()),""==A.error&&(A.error=function(n){const t=i.BDUSK;w=[];const r=n;if(!r)return"Road param missing";const l=r.length;let o,s=A.tini,u=A.vini;null!=r[0][0]&&r[0][0]<s&&(s=r[0][0],null!=r[0][1]&&(u=r[0][1])),(o={sta:[s,Number(u)],slope:0,auto:a.RP.SLOPE}).end=o.sta.slice(),o.sta[0]=i.daysnap(o.sta[0]-100*d*m),w.push(o);for(let n=0;n<l;n++){let i={};i.sta=w[w.length-1].end.slice();let l=null,o=null,s=null;l=r[n][0],o=r[n][1],s=r[n][2],null==l?(i.end=[0,Number(o)],i.slope=Number(s)/A.siru,0!=i.slope?i.end[0]=i.sta[0]+(i.end[1]-i.sta[1])/i.slope:(i.end[0]=t,i.end[1]=i.sta[1]),i.end[0]=e(t,i.end[0]),i.end[1]=i.sta[1]+i.slope*(i.end[0]-i.sta[0]),i.auto=a.RP.DATE):null==o?(i.end=[l,0],i.slope=Number(s)/A.siru,i.end[1]=i.sta[1]+i.slope*(i.end[0]-i.sta[0]),i.auto=a.RP.VALUE):null==s&&(i.end=[l,Number(o)],i.slope=a.segSlope(i),i.auto=a.RP.SLOPE),i.end[0]>=i.sta[0]&&w.push(i)}const f=w[w.length-1],c={sta:f.end.slice(),end:f.end.slice(),slope:0,auto:a.RP.VALUE};return c.end[0]=i.daysnap(c.end[0]+100*d*m),w.push(c),""}(n.road)),""==A.error&&(A.error=b.reloadRoad()),function(){if(!A.rosy||0==k.length)return;const n=r(0,A.stdflux);let t,a;A.dir>0?(t=I(k,n,-1),a=$(k,n,1)):(t=$(k,n,-1),a=I(k,n,1));const e=t.map(n=>n[1]),l=a.map(n=>n[1]),o=i.zip([e,l]).map(n=>(n[0]+n[1])/2),s=k.map(n=>n[0]);R=(R=i.zip([s,o])).map(n=>[n[0],n[1],"rosy data",y.RAWPAST,n[0],n[1],n[1]]);for(let n=1;n<R.length-1;n++)R[n][4]=R[n-1][0],R[n][5]=R[n-1][1]}()}finally{an=Object.assign({},h);for(const n in an)an[n]=A[n];!function(n){n.fullroad=n.fullroad.map(K),"razrmatr"in h&&(n.razrmatr=n.razrmatr.map(K)),n.pinkzone=n.pinkzone.map(K),n.tluz=i.dayify(n.tluz),n.tcur=i.dayify(n.tcur),n.tdat=i.dayify(n.tdat)}(an),N(an)}}(v.params,v.data),A.graphurl=i.BBURL,A.thumburl=i.BBURL,this.id=x,this.DPTYPE=y,this.roads=w,this.gol=A,this.data=k,this.rosydata=R,this.alldata=z,this.allvals=U,this.fuda=M,this.flad=W,this.oresets=E,this.derails=F,this.hollow=S,this.hashtags=O}});
!function(t,e){"use strict";"function"==typeof define&&define.amd?define(["d3","moment","butil","broad","beebrain"],e):"object"==typeof module&&module.exports?module.exports=e(require("d3"),require("./moment"),require("./butil"),require("./broad"),require("./beebrain")):t.bgraph=e(t.d3,t.moment,t.butil,t.broad,t.beebrain)}(this,function(t,e,a,r,n){"use strict";const l=Math.max,o=Math.min,i=Math.abs,s=Math.floor,d=Math.ceil,c=Math.round,u=365.25,h=86400;let p=1,f={noGraph:!1,divGraph:null,divTable:null,divPoints:null,divDueby:null,divData:null,divJSON:null,svgSize:{width:700,height:450},focusRect:{x:0,y:0,width:700,height:370},focusPad:{left:25,right:5,top:25,bottom:30},ctxRect:{x:0,y:370,width:700,height:80},ctxPad:{left:25,right:5,top:0,bottom:30},tableHeight:387,zoomButton:{size:40,opacity:.6,factor:1.5},bullsEye:{size:40,ctxsize:20},roadDot:{size:5,ctxsize:3,border:1.5,ctxborder:1},roadKnot:{width:3,rmbtnscale:.6},roadLine:{width:3,ctxwidth:2},oldRoadLine:{width:3,ctxwidth:2,dash:32,ctxdash:16},dataPoint:{size:5,fsize:5,hsize:2.5,border:1},horizon:{width:2,ctxwidth:1,dash:8,ctxdash:6,font:10,ctxfont:9},today:{width:2,ctxwidth:1,font:12,ctxfont:9},axis:{font:11},watermark:{height:170,fntsize:150,color:"#000000"},guidelines:{width:2,weekwidth:4},maxfluxline:4,stdfluxline:2,razrline:2,textBox:{margin:3},odomReset:{width:.5,dash:8},roadLineCol:{valid:"black",invalid:"#ca1212",selected:"yellow"},roadDotCol:{fixed:"darkgray",editable:"#c2c2c2",selected:"yellow"},roadKnotCol:{dflt:"#c2c2c2",selected:"yellow",rmbtn:"black",rmbtnsel:"red"},textBoxCol:{bg:"#ffffff",stroke:"#d0d0d0"},roadTableCol:{bg:"#ffffff",bgHighlight:"#fffb55",text:"#000000",textDisabled:"#aaaaaa",bgDisabled:"#f2f2f2"},dataPointCol:{future:"#909090",stroke:"#eeeeee"},halfPlaneCol:{fill:"#ffffe8"},pastBoxCol:{fill:"#f8f8f8",opacity:.5},odomResetCol:{dflt:"#c2c2c2"},headless:!1,scrollZoom:!0,buttonZoom:!0,roadEditor:!1,showContext:!1,showFocusRect:!1,showData:!0,maxDataDays:-1,maxFutureDays:365,keepSlopes:!0,showGuidelines:!0,keepIntervals:!1,reverseTable:!1,tableAutoScroll:!0,tableUpdateOnDrag:!1,duebyUpdateOnDrag:!0,tableCheckboxes:!0,onRoadChange:null,onDataEdit:null,dataTableSize:11,dataAutoScroll:!0,onError:null};const g={svgSize:{width:700,height:530},focusRect:{x:0,y:0,width:700,height:400},focusPad:{left:25,right:10,top:35,bottom:30},ctxRect:{x:0,y:400,width:700,height:80},ctxPad:{left:25,right:10,top:0,bottom:30},tableHeight:540,zoomButton:{size:50,opacity:.7,factor:1.5},bullsEye:{size:40,ctxsize:20},roadDot:{size:10,ctxsize:4,border:1.5,ctxborder:1},roadKnot:{width:7,rmbtnscale:.9},roadLine:{width:7,ctxwidth:2},oldRoadLine:{width:3,ctxwidth:1,dash:32,ctxdash:16},dataPoint:{size:4,fsize:6},horizon:{width:2,ctxwidth:1,dash:8,ctxdash:8,font:14,ctxfont:10},today:{width:2,ctxwidth:1,font:16,ctxfont:10},watermark:{height:150,fntsize:100,color:"#000000"},guidelines:{width:2,weekwidth:4},maxfluxline:4,stdfluxline:2,razrline:2,textBox:{margin:3}},y=".svg{shape-rendering:crispEdges}.axis path,.axis line{fill:none;stroke:black;shape-rendering:crispEdges}.axis .minor line{stroke:#777;stroke-dasharray:0,2,4,3}.grid line{fill:none;stroke:#dddddd;stroke-width:1px;shape-rendering:crispEdges}.aura{fill-opacity:0.3;stroke-opacity:0.3;}.aurapast{fill-opacity:0.15;stroke-opacity:0.3}.grid .minor line{stroke:none}.axis text{font-family:sans-serif;font-size:11px;}.axislabel{font-family:sans-serif;font-size:11px;text-anchor:middle}circle.dots{stroke:black}line.roads{stroke:black}.pasttext,.ctxtodaytext,.ctxhortext,.horizontext,.hashtag{text-anchor:middle;font-family:sans-serif}.waterbuf,.waterbux{opacity:0.05882353;text-anchor:middle;font-family:Dejavu Sans,sans-serif}.loading{text-anchor:middle;font-family:Dejavu Sans,sans-serif}.zoomarea{fill:none}circle.ap{stroke:none}circle.rd{stroke:none;pointer-events:none;fill:"+a.BHUE.ROSE+"}circle.std{stroke:none;pointer-events:none;fill:"+a.BHUE.PURP+"}circle.hp{stroke:none;fill:"+a.BHUE.WITE+"}.dp.gra,.ap.gra{fill:"+a.BHUE.GRADOT+"}.dp.grn,.ap.grn{fill:"+a.BHUE.GRNDOT+"}.dp.blu,.ap.blu{fill:"+a.BHUE.BLUDOT+"}.dp.orn,.ap.orn{fill:"+a.BHUE.ORNDOT+"}.dp.red,.ap.red{fill:"+a.BHUE.REDDOT+"}.dp.blk,.ap.blk{fill:"+a.BHUE.BLCK+"}.dp.fuda,.ap.fuda{fill-opacity:0.3}.guides{pointer-events:none;fill:none;stroke:"+a.BHUE.LYEL+"}.ybhp{pointer-events:none}.rosy{fill:none;stroke:"+a.BHUE.ROSE+";pointer-events:none}.steppy{fill:none;stroke:"+a.BHUE.PURP+";pointer-events:none}.steppyppr{fill:none;stroke-opacity:0.8;stroke:"+a.BHUE.LPURP+";pointer-events:none}.derails{fill:"+a.BHUE.REDDOT+";pointer-events:none}.overlay .textbox{fill:#ffffcc;fill-opacity:0.5;stroke:black;stroke-width:1;pointer-events:none;rx:5;ry:5}",m=.015,x=1e3,v={beye:"https://s3.amazonaws.com/bmndr/road/bullseye.png",beyey:"https://s3.amazonaws.com/bmndr/road/bullseye_prev.png",infb:"https://bmndr.s3.amazonaws.com/road/infinity_blk.png",sklb:"https://bmndr.s3.amazonaws.com/road/jollyroger_blk.png",smlb:"https://bmndr.s3.amazonaws.com/road/smiley_blk.png"},b={NOBBFILE:0,BADBBFILE:1,BBERROR:2},w=["Could not find goal (.bb) file.","Bad .bb file.","Beeminder error"],k=()=>{if("undefined"==typeof navigator&&"undefined"==typeof window)return!1;var t=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0)}(navigator.userAgent||navigator.vendor||window.opera),t};return function(E){let z=((t,e)=>{t.opts||(t.opts=a.extendo({},f,!0)),k()&&a.extendo(t.opts,g);let r=a.extendo(t.opts,e,!0);return r.divGraph=r.divGraph&&r.divGraph.nodeName?r.divGraph:null,r.headless?(r.divTable=null,r.divPoints=null,r.divDueby=null,r.divData=null,r.scrollZoom=!1,r.roadEditor=!1,r.showContext=!1,r.showFocusRect=!1):(r.divTable=r.divTable&&r.divTable.nodeName?r.divTable:null,r.divPoints=r.divPoints&&r.divPoints.nodeName?r.divPoints:null),r})(this,E);const T=p;p++;let R,M,D,A,P,B,L,S,U,C,N,G,H,O,Y,K,V,I,j,F,Z,q,J,W,_,X,$,Q,tt,et,at,rt,nt,lt,ot,it,st,dt,ct,ut,ht,pt,ft,gt,yt,mt,xt,vt,bt,wt,kt,Et,zt,Tt,Rt,Mt,Dt,At,Pt,Bt,Lt,St,Ut,Ct,Nt,Gt,Ht,Ot,Yt,Kt,Vt,It,jt,Ft,Zt,qt,Jt,Wt,_t,Xt,$t=50,Qt=z.svgSize.width,te=z.svgSize.height,ee=z.zoomButton.size,ae=ee/540,re=1,ne=0,le=!0,oe=null,ie=[],se=[],de=!1,ce=!1,ue=!1,he=k(),pe=null,fe=[],ge={},ye={},me=[],xe=[],ve=[],be=[],we=[],ke=[];function Ee(t){return void 0===ke[t]&&(ke[t]=r.isoline(me,we,ye,t)),ke[t]}function ze(t){return c(10*t)/10}function Te(t){return c(1e3*t)/1e3}function Re(){(ye={}).yaw=1,ye.dir=1,ye.tcur=0,ye.vcur=0;const t=e.utc();t.hour(0),t.minute(0),t.second(0),t.millisecond(0),ye.asof=t.unix(),ye.horizon=ye.asof+a.AKH-h,ye.xMin=ye.asof,ye.xMax=ye.horizon,ye.tmin=ye.asof,ye.tmax=ye.horizon,ye.yMin=-1,ye.yMax=1,ge=a.deepcopy(ye),me=[],fe=[],xe=[],be=[]}function Me(){D=a.extendo({},z.focusPad),A=a.extendo({},z.ctxPad),ye.stathead&&!z.roadEditor&&(D.top+=15),D.left+=$t,D.right+=$t+(ye.hidey?8:0),A.left+=$t,A.right+=$t+(ye.hidey?8:0),R={x:z.focusRect.x+D.left,y:z.focusRect.y+D.top,width:z.focusRect.width-D.left-D.right,height:z.focusRect.height-D.top-D.bottom},M={x:z.ctxRect.x+A.left,y:z.ctxRect.y+A.top,width:z.ctxRect.width-A.left-A.right,height:z.ctxRect.height-A.top-A.bottom},P={botin:"translate("+(R.width-2*(ee+5))+","+(R.height-(ee+5))+") scale("+ae+","+ae+")",botout:"translate("+(R.width-(ee+5))+","+(R.height-(ee+5))+") scale("+ae+","+ae+")",topin:"translate("+(R.width-2*(ee+5))+",5) scale("+ae+","+ae+")",topout:"translate("+(R.width-(ee+5))+",5) scale("+ae+","+ae+")"}}function De(t,e=-1,r="bold",n=null,l="overlay",o=!0,i=!1,s=null){if(null==z.divGraph)return;null==n&&(n={x:Qt/20,y:te/5,w:Qt-2*Qt/20,h:te-2*te/5}),null==s&&(s=B);let d=s.select("g."+l);d.empty()&&(d=s.append("g").attr("class",l),o&&d.append("svg:rect").attr("x",0).attr("y",0).attr("width",Qt).attr("height",te).style("fill",a.BHUE.WITE).style("fill-opacity",.5),d.append("svg:rect").attr("class","textbox").attr("x",n.x).attr("y",n.y).attr("width",n.w).attr("height",n.h)),d.selectAll(".loading").remove();const c=t.length;e<0&&(e=te/15);const u=1.1*e;for(let a=0;a<c;a++)d.append("svg:text").attr("class","loading").attr("x",n.x+n.w/2).attr("y",n.y+n.h/2-(c-1)*u/2+a*u+e/2-3).attr("font-size",e).style("font-size",e).style("font-weight",r).text(t[a]);i&&d.style("opacity",0).transition().duration(200).style("opacity",1)}function Ae(t="overlay",e=!1,a=null){if(null==z.divGraph)return;null==a&&(a=B);let r=a.selectAll("g."+t);e?r.style("opacity",1).transition().duration(200).style("opacity",0).remove():r.remove()}function Pe(){if(null===z.divGraph)return;const e=[V.invert(0),V.invert(R.width)];Me(),L.select("#plotclip"+T+" > rect").attr("width",R.width).attr("height",R.height),L.select("#brushclip"+T+" > rect").attr("width",M.width).attr("height",M.height),L.select("#buttonareaclip"+T+" > rect").attr("x",R.x).attr("y",0).attr("width",R.width).attr("height",R.height),Yt.attr("x",R.x).attr("y",R.y).attr("width",R.width).attr("height",R.height),Kt.extent([[0,0],[R.width,R.height]]).scaleExtent([1,1/0]).translateExtent([[0,0],[R.width,R.height]]),N.attr("transform","translate("+D.left+","+D.top+")"),Vt.attr("transform",P.botin),It.attr("transform",P.botout),K.range([0,R.width]),V.range([0,R.width]),Z.attr("transform","translate("+R.x+","+(D.top+R.height)+")").call(I.scale(V)),J.attr("transform","translate(0,"+R.height+")").call(F),q.attr("transform","translate("+R.x+","+D.top+")").call(j.scale(V)),Ot.select("rect").attr("width",R.width).attr("height",R.height),Ot.select("text").attr("x",R.width/2),W.range([0,R.height]),_.range([0,R.height]),Q.attr("transform","translate("+D.left+","+D.top+")").call(X.scale(_)),tt.attr("transform","translate("+(D.left+R.width)+","+D.top+")").call($.scale(_)),et.attr("transform","translate(15,"+(R.height/2+D.top)+") rotate(-90)"),O.attr("transform","translate("+A.left+","+A.top+")"),at.range([0,M.width]),nt.attr("transform","translate("+M.x+","+(A.top+M.height)+")").call(rt),lt.range([M.height,0]),jt.extent([[0,0],[M.width,M.height]]),Ft.call(jt);let a=e.map(K);Yt.call(Kt.transform,t.zoomIdentity.scale(R.width/(a[1]-a[0])).translate(-a[0],0)),pa()}Re(),Me();let Be,Le,Se,Ue=!1,Ce=0,Ne=-1;function Ge(){Le&&(Le.node().value=Ce)}function He(t){Ue=!0,Ce=parseInt(t),ta(),Ue=!1}function Oe(){if(!Ie){if(t.event.preventDefault(),t.event.deltaY<0){if(0==Ce)return;Ce-=1}else{if(Ce>=ve.length-z.dataTableSize)return;Ce+=1}Ge(),ta()}}const Ye=["id","dt","vl","cmt","mod","del"],Ke=["span","div","div","div","button","button"];let Ve=!1,Ie=null;function je(){return event.currentTarget.parentElement.getAttribute("id")}function Fe(){const t=je().match(/drow(\d+)/);return!t||t.length<2?null:t[1]}function Ze(){const t=Fe();if(!t)return null;const e=ve[t];return e[3]?e[3]:t}function qe(){const e=Fe();if(Ie){if(_e.changed){const r=Ze(),n=t.select(event.currentTarget.parentNode),l=a.dayparse(n.select(".dt").text(),"-"),o=n.select(".vl").text(),i=n.select(".cmt").text();isNaN(l)||isNaN(o)||e!=Ie||!z.onDataEdit||z.onDataEdit(r,[l,o,i])}Le.attr("disabled",null),Ie=null}else je(),Ie=e,Le.attr("disabled",!0),_e.field=null,_e.oldText=null,_e.changed=!1;ta()}function Je(){const t=Fe(),e=Ze();Ie&&Ie!=t||(z.onDataEdit&&z.onDataEdit(e,null),ta())}function We(){Le.attr("disabled",null),Ie=null,ta()}const _e={field:null,oldText:null,changed:!1};function Xe(e,a){if(z.onDataEdit&&0!=a&&!(a>3)){if(Ie){if(!e.edit)return}else qe();if(_e.field=t.select(this),_e.oldText=_e.field.text(),ln(),1==a){let e=t.select(z.divData).select(".floating");on(_e.field,null,null,e,Jt)}}}function $e(e,r){if(!z.onDataEdit||!e.edit||0==r||r>3)return;const n=t.select(this).text();if(ln(),ar(),n===_e.oldText)return;if(_e.changed=!0,null==_e.oldText)return;const l=1==r?a.dayparse(n,"-"):n;if(3!=r&&isNaN(l))return t.select(this).text(_e.oldText),_e.oldText=null,void(_e.field=null);_e.oldText=null,_e.field=null}function Qe(e,r){if(z.onDataEdit&&e.edit&&0!=r&&!(r>3)&&13==t.event.keyCode){this.blur();const e=t.select(this).text(),n=1==r?a.dayparse(e,"-"):e;if(3!=r&&isNaN(n))return t.select(this).text(_e.oldText),void(_e.oldText=null);_e.oldText=t.select(this).text(),t.event.ctrlKey&&qe()}}function ta(){if(Ve)return;if(Ve=!0,de)return;if(null===z.divData)return;Ue||(ve.length<=z.dataTableSize?Le.style("visibility","hidden"):Le.style("visibility","visible").attr("max",ve.length-z.dataTableSize).attr("value",0)),Se=Array(Math.min(ve.length,z.dataTableSize)).fill().map((t,e)=>e+Ce);const t=Be.selectAll(".drow").data(Se);t.enter().append("div").attr("class","drow").attr("id",t=>"drow"+(ve.length-t-1)),t.exit().remove(),t.style("box-shadow",t=>t==Ne?"0 0 0 4px yellow":null).attr("id",t=>"drow"+(ve.length-t-1)),Be.selectAll(".drow").selectAll(".dcell").data((t,e)=>{if(t>=ve.length)return[null,null,null,null,null,null];t=ve.length-t-1;let r=a.dayify(a.dayparse(ve[t][0]),"-"),n=!!Ie&&t==Ie;return[{txt:t,clk:null,edit:n},{txt:r,clk:null,edit:n},{txt:ve[t][1],clk:null,edit:n},{txt:ve[t][2],clk:null,edit:n},{txt:n?'<img class="dicon" src="../src/check.svg"></img>':'<img class="dicon" src="../src/edit.svg" ></img>',clk:qe,edit:n},{txt:n?'<img class="dicon" src="../src/cancel.svg" ></img>':'<img class="dicon" src="../src/trash.svg"></img>',clk:n?We:Je,edit:n}]}).join(t=>t.append((t,e)=>(function(t){return document.createElementNS("http://www.w3.org/1999/xhtml",t)})(Ke[e])).attr("class",(t,e)=>"dcell "+Ye[e]).style("border",(t,e)=>0==e?"0":null).style("text-align",(t,e)=>0==e?"right":null).on("click",t=>t.clk?t.clk():null),t=>t).html(t=>t.txt).style("visibility",function(t){return"BUTTON"===this.tagName&&Ie&&!t.edit?"hidden":null}).attr("contenteditable",(t,e)=>!!z.onDataEdit&&e>0&&e<4).on("focusin",Xe).on("focusout",$e).on("keydown",Qe).style("opacity",t=>!Ie||t.edit?null:.2);const e=Be.selectAll("button.dcell");z.onDataEdit?e.style("display",null):e.style("display","none"),Ve=!1}let ea;function aa(){if(de)return;if(null===z.divDueby)return;const t=a.nowstamp(ye.timezone,ye.deadline,ye.asof),n=a.dayparse(t)/h;let l=r.dueby(me,ye,7);ea.selectAll(".dbrow").selectAll(".dbcell").data((t,r)=>{const o=function(t,r){const n=e.unix(ye.asof+t*h).utc(),l=a.dayparse(n.format("YYYYMMDD"))/h;if(l==r-1)return["Yesterday",a.BHUE.REDDOT];if(l==r)return["Today",a.BHUE.ORNG];if(l==r+1)return["Tomorrow",a.BHUE.BLUDOT];const o=n.format("ddd (Do)");return l==r+2?[o,a.BHUE.GRNDOT]:[o,a.BHUE.BLCK]}(r,n),i=l[r][1];return[o,[i>0||ye.dir<0?a.shn(i):"&#10004;",o[1]],[a.shn(l[r][2]),o[1]]]}).join(t=>t.append("span").attr("class","dbcell"),t=>t).html(t=>t[0]).style("color",t=>t[1])}function ra(){ge.tini==fe[0].end[0]&&(ye.tini=me[0].end[0],ye.vini=me[0].end[1]),An||Xt.setRoadObj(me),Aa(!0),pe=r.findSeg(me,ye.horizon),ya(),Br(),Dn(!0),Mn(),Rn(),aa(),"function"==typeof z.onRoadChange&&z.onRoadChange.call()}function na(t,e,a,r,n=null){let l={};if(e<20-D.top&&(e=20-D.top),e>R.height-15&&(e=R.height-15),l.grp=C.append("g"),l.rect=l.grp.append("svg:rect").attr("pointer-events","none").attr("fill",z.textBoxCol.bg).style("stroke",r),l.text=l.grp.append("svg:text").attr("pointer-events","none").attr("text-anchor","middle"),null==n)l.text.text(a).attr("class","svgtxt");else{l.text.append("tspan").attr("x",0).attr("dy","0.6em").text(a).attr("class","svgtxt");for(let t=0;t<n.length;t++)l.text.append("tspan").attr("dy","1.2em").attr("x",0).text(n[t]).attr("font-size","0.7em")}const o=l.text.node().getBBox(),i=z.textBox.margin;return l.rect.attr("x",o.x-i).attr("y",o.y-i).attr("width",o.width+2*i).attr("height",o.height+2*i),t<o.width/2&&(t=o.width/2),t>R.width-o.width/2&&(t=R.width-o.width/2),l.grp.attr("transform","translate("+(t+D.left)+","+(e+D.top)+")"),l}function la(t,e,a,r){if(!t)return void console.debug("updateTextBox: null input");a<20-D.top&&(a=20-D.top),a>R.height-15&&(a=R.height-15),t.text.text(r);const n=t.text.node().getBBox(),l=z.textBox.margin;t.rect.attr("x",n.x-l).attr("y",n.y-l).attr("width",n.width+2*l).attr("height",n.height+2*l),e<n.width/2&&(e=n.width/2),e>R.width-n.width/2&&(e=R.width-n.width/2),t.grp.attr("transform","translate("+(e+D.left)+","+(a+D.top)+")")}function oa(t){t?t.grp.remove():console.debug("updateTextBox: null input")}let ia,sa=1,da=7;function ca(){const e=K.domain(),r=e.map(t=>t.getTime()/x),n=r.slice();n[0]=a.monthsnap(n[0]);const l=r.slice();l[0]=a.yearsnap(l[0]);const o=n.map(t=>new Date(t*x)),i=l.map(t=>new Date(t*x));(ia=[]).push([t.utcDay.range(e[0],e[1],1),"%b %d"]),ia.push([t.utcDay.range(e[0],e[1],2),"%b %d"]),ia.push([t.utcWeek.range(o[0],o[1],1),"%b %d"]),ia.push([t.utcWeek.range(o[0],o[1],2),"%b %d"]),ia.push([t.utcMonth.every(1).range(i[0],i[1]),"%b %Y"]),ia.push([t.utcMonth.every(2).range(i[0],i[1]),"%b %Y"]),ia.push([t.utcMonth.every(3).range(i[0],i[1]),"%Y"]),ia.push([t.utcYear.every(1).range(i[0],i[1]),"%Y"])}function ua(){const e=[V.invert(0).getTime(),V.invert(R.width).getTime()],a=(e[1]-e[0])/(x*h);z.focusRect.width<500?a*=1.6:z.focusRect.width<550?a*=1.4:z.focusRect.width<600&&(a*=1.2),a<10?(sa=0,da=1):a<20?(sa=0,da=2):a<45?(sa=0,da=7):a<120?(sa=1,da=7):a<240?(sa=2,da=4):a<320?(sa=4,da=1):a<547.5?(sa=4,da=2):a<949?(sa=4,da=3):a<1825?(sa=5,da=3):a<3650?(sa=6,da=4):(sa=7,da=1);const r=ia[sa][0].filter(t=>t.getTime()<e[0]),n=(da-r.length%da)%da,l=ia[sa][0].filter(t=>t.getTime()>=e[0]&&t.getTime()<=e[1]);I.tickValues(l).tickSize(6).tickSizeOuter(0).tickFormat((e,a)=>t.utcFormat(a%da==n?ia[sa][1]:"")(e)),Z.call(I.scale(V)),Z.selectAll("g").classed("minor",!1),Z.selectAll("g").filter((t,e)=>e%da!=n).classed("minor",!0),Z.selectAll("g").selectAll(".tick line").attr("transform","translate(0,-5)"),F.tickValues(l).tickSize(R.width),J.call(F.scale(V)),J.selectAll("g").classed("minor",!1),J.selectAll("g").filter((t,e)=>e%da!=n).classed("minor",!0),j.tickValues(l).tickSize(6).tickSizeOuter(0).tickFormat((e,a)=>t.utcFormat(a%da==n?ia[sa][1]:"")(e)),q.call(j.scale(V)),q.selectAll("g").classed("minor",!1),q.selectAll("g").filter((t,e)=>e%da!=n).classed("minor",!0),q.selectAll("g").selectAll(".tick line").attr("transform","translate(0,6)")}function ha(){if(null!=z.divGraph&&!ue){et.text(ye.yaxis),ye.hidey&&!z.roadEditor?(Q.selectAll("text").attr("display","none"),tt.selectAll("text").attr("display","none")):(Q.selectAll("text").attr("display",null),tt.selectAll("text").attr("display",null));const t=Q.node().getBBox();i(t.width-$t)>5&&($t=s(t.width),Pe())}}function pa(){const e=[V.invert(0),V.invert(R.width)];let a;if(z.headless){const t=ye.vmin-m*(ye.vmax-ye.vmin);a=[ye.vmax+m*(ye.vmax-ye.vmin),t]}else{const t=i(m*(ye.vmax-ye.vmin)),r=e.map(t=>s(t.getTime()/x)),n=Ma(me,r[0],r[1],!1);let l;if(n.yMin-=t,n.yMax+=t,z.roadEditor){const e=Ma(fe,r[0],r[1],!1);e.yMin-=t,e.yMax+=t,l=za(n,e)}else l=n;const o=Ra(ye.plotall&&!z.roadEditor?be:xe,r[0],r[1],!1);null!=o&&(l=za(l,o)),Ta(l,z.roadEditor?{xmin:0,xmax:0,ymin:.05,ymax:.05}:{xmin:0,xmax:0,ymin:.02,ymax:.02}),l.yMax-l.yMin<2*t&&(l.yMax+=t,l.yMin-=t),a=[l.yMax,l.yMin]}const r=l(1e-5,o(1,.001*a[0]));a[0]-a[1]<r&&(a[0]=a[0]+r,a[1]=a[1]-r);const n=t.zoomIdentity.scale(R.height/(W(a[1])-W(a[0]))).translate(0,-W(a[0]));_=n.rescaleY(W),Q.call(X.scale(_)),tt.call($.scale(_)),a[0]>ye.yMax&&(ye.yMax=a[0]),a[1]<ye.yMin&&(ye.yMin=a[1]),fa();const d=e.map(t=>at(t)),c=a.map(t=>lt(t));Zt.attr("x",d[0]+1).attr("width",l(0,d[1]-d[0]-2)).attr("y",c[0]+1).attr("height",l(0,c[1]-c[0]-2))}function fa(){null!=z.divGraph&&(at.domain([new Date(o(ye.tmin,ye.xMin)*x),new Date(l(ye.tmax,ye.xMax)*x)]),nt.call(rt.scale(at)),lt.domain([ye.yMin,ye.yMax]))}function ga(){if(null==z.divGraph)return;const t=[at(V.invert(0)),at(V.invert(R.width))];t[0]<0&&(t[0]=0),t[1]>M.width&&(t[1]=M.width),Ft.call(jt.move,t)}function ya(){fa(),ga()}function ma(){if(0==me.length)return;if(t.event&&t.event.sourceEvent&&"brush"===t.event.sourceEvent.type)return;const e=t.zoomTransform(Yt.node());null!=e&&(V=e.rescaleX(K),ua(),pa(),Q.selectAll("g").selectAll(".tick line").attr("transform","translate(6,0)"),tt.selectAll("g").selectAll(".tick line").attr("transform","translate(-5,0)"),ha(),ga(),Dn())}function xa(){if(0==me.length)return;if(t.event.sourceEvent&&"zoom"===t.event.sourceEvent.type)return;const e=t.event.selection||at.range();V.domain(e.map(at.invert,at)),ua(),pa(),ha(),Yt.call(Kt.transform,t.zoomIdentity.scale(M.width/(e[1]-e[0])).translate(-e[0],0)),Dn()}function va(){if(null==z.divGraph)return;const e=ye.tmin-m*(ye.tmax-ye.tmin),a=ye.tmax+m*(ye.tmax-ye.tmin),r=[new Date(e*x),new Date(a*x)];V.domain(r);const n=r.map(at);ua(),pa(),Yt.call(Kt.transform,t.zoomIdentity.scale(M.width/(n[1]-n[0])).translate(-n[0],0))}function ba(){null!=z.divGraph&&(Aa(!1),K.domain([new Date(o(ye.tmin,ye.xMin)*x),new Date(l(ye.tmax,ye.xMax)*x)]),ca(),W.domain([ye.yMin,ye.yMax]),V=K,_=W,fa(),Yt.call(Kt.transform,t.zoomIdentity),ye.dir>0?(Vt.attr("transform",P.botin),It.attr("transform",P.botout)):(Vt.attr("transform",P.topin),It.attr("transform",P.topout)),ya())}function wa(){ie=[],se=[]}function ka(t=!1){0!=ie.length&&r.sameRoads(ie[ie.length-1],me)||(ie.push(r.copyRoad(me)),t||(se=[]))}function Ea(t){const e=fe,a=ye.asof,n=ye.horizon;if(ye.yaw*r.rdf(t,a)<ye.yaw*r.rdf(e,a)-1e-6)return!1;if(ye.yaw*r.rdf(t,n)<ye.yaw*r.rdf(e,n)-1e-6)return!1;const l=r.findSeg(t,a),o=r.findSeg(t,n);for(let a=l;a<o;a++)if(ye.yaw*r.rdf(t,t[a].end[0])<ye.yaw*r.rdf(e,t[a].end[0])-1e-6)return!1;const i=r.findSeg(e,a),s=r.findSeg(e,n);for(let a=i;a<s;a++)if(ye.yaw*r.rdf(t,e[a].end[0])<ye.yaw*r.rdf(e,e[a].end[0])-1e-6)return!1;return!0}function za(t,e){let a={};return a.xMin=o(t.xMin,e.xMin),a.xMax=l(t.xMax,e.xMax),a.yMin=o(t.yMin,e.yMin),a.yMax=l(t.yMax,e.yMax),a}function Ta(t,e){let a=t.xMax-t.xMin;a<1e-7&&(a=1e-7);let r=t.yMax-t.yMin;r<1e-7&&(r=1e-7),t.xMin=t.xMin-e.xmin*a,t.xMax=t.xMax+e.xmax*a,t.yMin=t.yMin-e.ymin*r,t.yMax=t.yMax+e.ymax*r}function Ra(t,e,n,i=!1){let s={},d=t.filter(t=>t[0]>e&&t[0]<n);if(0==d.length){let a=-1;for(let r=0;r<t.length-1;r++)if(t[r][0]<=e&&t[r+1][0]>=n){a=r;break}a>0&&(d=t.slice(a,a+1))}if(0==d.length)return null;if(s.xMin=a.arrMin(d.map(t=>t[0])),s.xMax=a.arrMax(d.map(t=>t[0])),s.yMin=a.arrMin(d.map(t=>t[1])),s.yMax=a.arrMax(d.map(t=>t[1])),null!=Xt.flad&&Xt.flad[0]<=n&&Xt.flad[0]>=e){const t=Xt.flad[1]+r.ppr(me,ye,ye.asof);s.yMin=o(s.yMin,t),s.yMax=l(s.yMax,t)}return i&&Ta(s,{xmin:.1,xmax:.1,ymin:.1,ymax:.1}),s}function Ma(t,e,n,l=!1){let o={};return o.xMin=e,o.xMax=n,o.yMin=a.arrMin(t.map(function(t){return t.sta[0]<e||t.sta[0]>n?1/0:t.sta[1]})),o.yMax=a.arrMax(t.map(function(t){return t.sta[0]<e||t.sta[0]>n?-1/0:t.sta[1]})),o.yMin=a.arrMin([o.yMin,r.rdf(t,e),r.rdf(t,n)]),o.yMax=a.arrMax([o.yMax,r.rdf(t,e),r.rdf(t,n)]),l&&Ta(o,{xmin:.1,xmax:.1,ymin:.1,ymax:.1}),o}function Da(){if(null!==ye.waterbuf0)return;ye.safebuf=r.dtd(me,ye,ye.tcur,ye.vcur),ye.tluz=o(ye.tcur+ye.safebuf*h,ye.tfin+h,a.BDUSK),ye.tluz>ye.tfin&&(ye.tluz=a.BDUSK),ye.loser=r.redyest(me,ye,ye.tcur);const t=a.chop(ye.yaw*(ye.vcur-ye.vfin)),n=ye.asof===ye.tfin&&t>=0,l=ye.asof===ye.tfin&&t<0;var i,s;ye.waterbuf=ye.loser?":(":ye.asof>ye.tfin?"fin":n?":)":l?"eke":ye.tluz>ye.tfin?"inf":ye.safebuf<=0?(s=ye.deadline,e.unix(s).utc().format("h:mma").replace(":00","")+"!"):ye.safebuf<7?(i=ye.tluz,e.unix(i).utc().format("ddd")):ye.safebuf<365?ye.safebuf+"d":ye.safebuf<=999?ye.safebuf+"d":ye.safebuf>999?">999d":"???"}function Aa(e=!0){if(0==me.length)return;const r=ye.asof,n=a.daysnap(o(r+z.maxFutureDays*h,me[me.length-1].sta[0])),i=Ma(me,me[0].end[0],n,!1);let s;s=z.roadEditor?za(i,Ma(fe,me[0].end[0],n,!1)):i;const d=Ra(ye.plotall&&!z.roadEditor?be:xe,me[0].end[0],xe[xe.length-1][0],!1);if(null!=d&&(s=za(s,d)),0!=Xt.fuda.length){const t=Ra(Xt.fuda,me[0].end[0],n,!1);null!=t&&(s=za(s,t))}const c={xmin:.1,xmax:.1,ymin:.1,ymax:.1};if(z.roadEditor||(c.xmin=.02,c.xmax=.02),Ta(s,c),ye.xMin=a.daysnap(s.xMin),ye.xMax=a.daysnap(s.xMax),ye.yMin=s.yMin,ye.yMax=s.yMax,e&&null!=z.divGraph){const e=[V.invert(0),V.invert(R.width)];_.invert(0),_.invert(R.height),K.domain([new Date(o(ye.tmin,ye.xMin)*x),new Date(l(ye.tmax,ye.xMax)*x)]),ca(),W.domain([ye.yMin,ye.yMax]);const a=t.zoomIdentity.scale(R.width/(K(e[1])-K(e[0]))).translate(-K(e[0]),0);Yt.call(Kt.transform,a)}}function Pa(t,e,r=6e3){return a.linspace(t,e,s(a.clip((e-t)/(h+1),o(300,R.width/8),r)))}const Ba=`bgraph(${T}): Goal stats`,La=`bgraph(${T}): Goal graph`;function Sa(t,e=!0){if(!("params"in t&&"data"in t))throw new Error("loadGoal: JSON input lacks params or data");wa(),de=!0;let l=t.params.yoog?" ("+t.params.yoog+")":"";if(e&&console.time(Ba+l),Xt=new n(t),ye=Xt.gol,z.divJSON&&(z.headless?z.divJSON.innerText=JSON.stringify(Xt.getStats()):z.divJSON.innerText=JSON.stringify(Xt.getStats(),null,4)),e&&console.timeEnd(Ba+l),""!=ye.error){console.log("Beebrain error: "+Xt.gol.error),oe=b.BBERROR;const t=Xt.gol.error.split("\\n");return De(["The following errors prevented us from generating "+Xt.gol.yoog,"(We've pinged Beeminder support to come help fix things up here!)",""].concat(t),te/30,null),Re(),void(de=!1)}if(z.noGraph)return De(["Beebrain was called with 'NOGRAPH_*' as the slug","so no graph or thumbnail was generated, just this","static placeholder!"],te/30,null),Re(),void(de=!1);me=Xt.roads,fe=r.copyRoad(me),xe=Xt.data,ve=a.deepcopy(t.data),ge=a.deepcopy(ye),be=Xt.alldata,z.maxDataDays<0?(Wt=xe.slice(),_t=be.slice()):(Wt=xe.filter(function(t){return t[0]>ye.asof-z.maxDataDays*h}),_t=be.filter(function(t){return t[0]>ye.asof-z.maxDataDays*h})),z.divGraph&&(!z.roadEditor&&ye.stathead?U.text(ye.graphsum):U.text("")),e&&console.time(La+l),Br(),ba(),va(),de=!1,Rn(),aa(),null!==z.divData&&(Ce=0,Ie=null,Le.attr("disabled",null),Ge(),ta()),Mn(),Pe(),function(){if(null!=z.divTable){var t,e,a="Daily Slope";"h"===ye.runits&&(a="Hourly Slope"),"d"===ye.runits&&(a="Daily Slope"),"w"===ye.runits&&(a="Weekly Slope"),"m"===ye.runits&&(a="Monthly Slope"),"y"===ye.runits&&(a="Yearly Slope"),z.roadEditor?(t=["","End Date","Value",a,"",""],e=["","Goal Date","Value",a,"",""]):(t=["","End Date","Value",a],e=["","Goal Date","Value",a]),Kr.selectAll("span.rdhdrcell").data(t).text(t=>t),Gr.selectAll("span.rdhdrcell").data(t).text(t=>t),en.selectAll("span.rdhdrcell").data(e).text(t=>t),zn()}}(),"function"==typeof z.onRoadChange&&z.onRoadChange.call(),e&&console.timeEnd(La+l)}function Ua(e,n=null){let l=r.findSeg(me,e);if(l>=0){let o={},i=a.daysnap(e+h/2),s=n;null==n&&(s=me[l].sta[1]+me[l].slope*(i-me[l].sta[0])),ka(),o.sta=[i,s],0==l?(o.end=me[l+1].sta.slice(),null!=n&&(o.end[1]=o.sta[1]+me[l].slope*(o.end[0]-i)),me[l].end=[i,s]):(l==me.length-1?(o.end=me[l].end.slice(),o.end[1]=s):(o.end=me[l+1].sta.slice(),null!=n&&z.keepSlopes&&(o.end[1]=o.sta[1]+me[l].slope*(o.end[0]-i))),me[l].end=[i,s],me[l].slope=r.segSlope(me[l]),me[l].sta[0]==me[l].end[0]&&(me[l].auto=r.RP.SLOPE)),o.slope=r.segSlope(o),o.auto=r.RP.VALUE,me.splice(l+1,0,o),r.fixRoadArray(me,z.keepSlopes?r.RP.VALUE:r.RP.SLOPE,!1),ra();let d=t.select(z.divTable).select(".roadrow [name=endvalue"+(l+1)+"]");d.empty()||yn(d,!1)}return l}function Ca(t,e){ka();const a=me[t].slope;me.splice(t,1),e||!z.keepSlopes||isNaN(a)||(me[t].slope=a),r.fixRoadArray(me,z.keepSlopes&&!e?r.RP.VALUE:r.RP.SLOPE,e),ra()}let Na=null,Ga=null,Ha=null;function Oa(t,r){let n=V(a.daysnap(t[0])*x),l=t[1];if(ja=e.unix(t[0]).utc(),Na=na(n,R.height-15,ja.format("YYYY-MM-DD")+" ("+ja.format("ddd")+")",z.textBoxCol.stroke),Ga=na(n,_(l)-15,a.shn(t[1]),z.textBoxCol.stroke),null!=r){const t=V(a.daysnap(r[0])*x),e=_(r[1]);Ha=na(t,e,"s:"+a.shn(r[2]),z.textBoxCol.stroke),n-t<50&&(i=!0,(o=Ha)?o.grp.attr("visibility",i?"hidden":"visible"):console.debug("updateTextBox: null input"))}var o,i}function Ya(t,r){const n=a.daysnap(t[0]),l=t[1];if(ja=e.unix(n).utc(),la(Na,V(n*x),R.height-15,ja.format("YYYY-MM-DD")+" ("+ja.format("ddd")+")"),la(Ga,V(n*x),_(l)-15,a.shn(t[1])),null!=r){const t=a.daysnap(r[0]),e=r[1];la(Ha,V(t*x),_(e),"s:"+a.shn(r[2]))}}function Ka(){null!=Na&&oa(Na),Na=null,null!=Ga&&oa(Ga),Ga=null,null!=Ha&&oa(Ha),Ha=null}function Va(e,r){const n=me,l=t.select(z.divGraph);for(let t=e;t<n.length;t++)l.select("[name=dot"+t+"]").attr("cx",ze(V(n[t].end[0]*x))).attr("cy",ze(_(n[t].end[1]))),l.select("[name=ctxdot"+t+"]").attr("cx",ze(at(n[t].end[0]*x))).attr("cy",ze(lt(n[t].end[1]))),l.select("[name=road"+t+"]").attr("x1",ze(V(n[t].sta[0]*x))).attr("y1",ze(_(n[t].sta[1]))).attr("x2",ze(V(n[t].end[0]*x))).attr("y2",ze(_(n[t].end[1]))),l.select("[name=ctxroad"+t+"]").attr("x1",ze(at(n[t].sta[0]*x))).attr("y1",ze(lt(n[t].sta[1]))).attr("x2",ze(at(n[t].end[0]*x))).attr("y2",ze(lt(n[t].end[1]))),r&&(l.select("[name=knot"+t+"]").attr("x1",ze(V(n[t].end[0]*x))).attr("x2",ze(V(n[t].end[0]*x))),l.select("[name=remove"+t+"]").attr("transform",t=>"translate("+(V(t.end[0]*x)+D.left-8)+","+(D.top-20)+") scale(0.6,0.6)")),l.select("[name=enddate"+t+"]").text(a.dayify(n[t].end[0],"-")),l.select("[name=endvalue"+t+"]").text(a.shn(n[t].end[1])),l.select("[name=slope"+t+"]").text(a.shn(n[t].slope*ye.siru));z.tableUpdateOnDrag&&Tn(),z.duebyUpdateOnDrag&&aa(),Br(),Lr(),yr(),fr(),gr(),_r(),Xr(),xr(),Rr(),vr(),Mr(),Dr()}let Ia,ja,Fa,Za=null,qa=null,Ja=null;function Wa(e,a=!0){if(null==z.divGraph)return;mn(e,!0,a),Za=e,qa=r.RP.DATE,t.select("[name=knot"+e+"]").attr("stroke-width",Te(z.roadKnot.width));const n=V(me[e].end[0]*x);Ja=bt.append("svg:line").attr("class","selectedknot").attr("pointer-events","none").attr("x1",n).attr("x2",n).attr("y1",0).attr("y2",R.height).attr("stroke",z.roadKnotCol.selected).attr("stroke-opacity",.9).attr("stroke-width",Te(z.roadKnot.width+4)).lower()}function _a(e){mn(e,!1),t.select("[name=knot"+e+"]").attr("stroke",z.roadKnotCol.dflt).attr("stroke-width",Te(z.roadKnot.width))}function Xa(e,a=!0){null!=z.divGraph&&(xn(e,!0,a),Za=e,qa=r.RP.VALUE,t.select("[name=dot"+e+"]").attr("r",Te(z.roadDot.size)),Ja=Ut.append("svg:circle").attr("class","selecteddot").attr("pointer-events","none").attr("cx",ze(V(me[e].end[0]*x))).attr("cy",ze(_(me[e].end[1]))).attr("fill",z.roadDotCol.selected).attr("fill-opacity",.6).attr("r",Te(z.roadDot.size+4)).attr("stroke","none").lower())}function $a(e){xn(e,!1),t.select("[name=dot"+e+"]").attr("fill",z.roadDotCol.editable).attr("r",Te(z.roadDot.size))}function Qa(e,a=!0){null!=z.divGraph&&(vn(e,!0,a),Za=e,qa=r.RP.SLOPE,t.select("[name=road"+e+"]").attr("shape-rendering","geometricPrecision").attr("stroke-width",(z.roadLine.width,3)),Ja=St.append("svg:line").attr("class","selectedroad").attr("shape-rendering","geometricPrecision").attr("pointer-events","none").attr("x1",V(me[e].sta[0]*x)).attr("x2",V(me[e].end[0]*x)).attr("y1",_(me[e].sta[1])).attr("y2",_(me[e].end[1])).attr("stroke",z.roadKnotCol.selected).attr("stroke-opacity",.9).attr("stroke-width",Te(z.roadLine.width+4)).lower())}function tr(e){vn(e,!1);const a=Ea(me)?z.roadLineCol.valid:z.roadLineCol.invalid;t.select("[name=road"+e+"]").style("stroke",a).attr("stroke-width",Te(z.roadLine.width))}function er(){Za=null,qa=null,null!=Ja&&(Ja.remove(),Ja=null)}function ar(){null!=Za&&(qa==r.RP.DATE?_a(Za):qa==r.RP.VALUE?$a(Za):qa==r.RP.SLOPE&&tr(Za),Ka(),er())}let rr=!1;function nr(e,a){t.event.sourceEvent.stopPropagation(),rr=!0,ka();var n=Number(this.id);Ia=r.copyRoad(me),null==Za?Wa(n):null!=Za&&Za==n&&qa==r.RP.DATE?ar():(ar(),Wa(n)),Oa(e.end),Na.grp.raise(),(Fa=[])[0]=me[n].slope,Fa[1]=me[n+1].slope}function lr(e,n){er();let l=a.daysnap(V.invert(t.event.x)/x);const o=Number(this.id),i=me;l<i[o].sta[0]&&(l=i[o].sta[0]),l>i[o+1].end[0]&&(l=i[o+1].end[0]);const s=o+1;z.keepIntervals&&(s=i.length);for(let t=o;t<s;t++)i[t].end[0]=l+Ia[t].end[0]-Ia[o].end[0];isFinite(Fa[0])&&me[o].sta[0]!=me[o].end[0]&&(me[o].slope=Fa[0]),isFinite(Fa[1])&&me[o+1].sta[0]!=me[o+1].end[0]&&(me[o+1].slope=Fa[1]),r.fixRoadArray(i,z.keepSlopes?r.RP.VALUE:r.RP.SLOPE,!1,r.RP.DATE),Va(o,!0),Ya(e.end)}function or(t,e){rr=!1,null==Za&&(_a(e),Ka(),ra()),Ia=null}function ir(t){Ca(Number(this.id),!1)}let sr=!1;let dr,cr=!1;const ur={buf:!1,bux:!1,aura:!1,aurap:!1,hor:!1,hort:!1,ybr:!1,ybrc:!1,guides:!1,rosy:!1,rosyd:!1,data:!1,dataa:!1,mav:!1};function hr(t,e,a,r,n){var l,o=t.transition().duration(e);for(l=0;l<a.length;l++)o=o.attr(a[l][0],a[l][1]);for(l=0;l<r.length;l++)o=o.style(r[l][0],r[l][1]);for(o=o.transition().duration(e),l=0;l<a.length;l++)o=o.attr(a[l][0],a[l][2]);for(l=0;l<r.length;l++)o=o.style(r[l][0],r[l][2]);o.on("end",()=>{ur[n]&&hr(t,e,a,r,n)}),ur[n]=!0}function pr(t,e,a,r,n){ur[n]=!1;let l=t.transition().duration(e);for(let t=0;t<a.length;t++)l=l.attr(a[t][0],a[t][2]);for(let t=0;t<r.length;t++)l=l.style(r[t][0],r[t][2]);l.on("end",()=>{ur[n]=!1})}function fr(){if(!de&&null!=z.divGraph&&0!=me.length){var t=Lt.select(".bullseye"),e=V(ye.tfin*x)-z.bullsEye.size/2,a=_(r.rdf(me,ye.tfin))-z.bullsEye.size/2;t.empty()?Lt.append("svg:image").attr("class","bullseye").attr("xlink:href",v.beye).attr("externalResourcesRequired",!0).attr("x",e).attr("y",a).attr("width",z.bullsEye.size).attr("height",z.bullsEye.size):t.attr("x",e).attr("y",a)}}function gr(){if(!de&&null!=z.divGraph&&0!=me.length){var t=Y.select(".ctxbullseye");if(z.roadEditor){var e=at(ye.tfin*x)-z.bullsEye.ctxsize/2,a=lt(r.rdf(me,ye.tfin))-z.bullsEye.ctxsize/2;t.empty()?Y.append("svg:image").attr("class","ctxbullseye").attr("xlink:href",v.beyey).attr("externalResourcesRequired",!0).attr("x",e).attr("y",a).attr("width",z.bullsEye.ctxsize).attr("height",z.bullsEye.ctxsize):t.attr("x",e).attr("y",a)}else t.remove()}}function yr(){if(de||null==z.divGraph||0==me.length||ue)return;const t=[0,0],e=[0,R.height/2],a=[R.width/2,0],r=[R.width/2,R.height/2];let n,l,o,i,s,d,c,u=null;Da(),":("===ye.waterbuf&&(u=v.sklb),"inf"===ye.waterbuf?u=v.infb:":)"===ye.waterbuf&&(u=v.smlb),ye.dir>0&&ye.yaw<0?(n=r,l=t):ye.dir<0&&ye.yaw>0?(n=a,l=e):ye.dir<0&&ye.yaw<0?(n=e,l=a):(n=t,l=r),le=!1;let h=Ct.select(".waterbuf");const p=z.watermark.fntsize,f=z.watermark.height;h.remove(),null!=u?(o=(R.width/2-f)/2,i=(R.height/2-f)/2,h=Ct.append("svg:image").attr("class","waterbuf").attr("xlink:href",u).attr("externalResourcesRequired",!0).attr("width",f).attr("height",f).on("load",()=>{le=!0})):(o=R.width/4,i=R.height/4+p/3,(s=(h=Ct.append("svg:text").attr("class","waterbuf").style("font-size",p+"px").style("font-weight","bolder").style("fill",z.watermark.color).text(ye.waterbuf)).node().getBBox()).width>R.width/2.2&&(c=(d=p*(R.width/2.2)/s.width)/p*s.height,i=R.height/4+c/3,h.style("font-size",d+"px")),le=!0),h.attr("x",o+n[0]).attr("y",i+n[1]);let g=Ct.select(".waterbux");g.remove(),z.roadEditor?g.remove():(o=R.width/4,i=R.height/4+p/3,(s=(g=Ct.append("svg:text").attr("class","waterbux").style("font-size",p+"px").style("font-weight","bolder").style("fill",z.watermark.color).text(ye.waterbux)).node().getBBox()).width>R.width/2.2&&(c=(d=p*(R.width/2.2)/s.width)/p*s.height,i=R.height/4+c/3,g.style("font-size",d+"px")),g.attr("x",o+l[0]).attr("y",i+l[1]))}function mr(){if(de||null==z.divGraph||0==me.length||ue)return;const t=Rt.selectAll(".aura"),e=Rt.selectAll(".aurapast");if(ye.aura&&z.showData){const r=o(0,-ye.stdflux),n=l(0,ye.stdflux),i=m*(ye.tmax-ye.tmin),s=[V.invert(0).getTime()/x,V.invert(R.width).getTime()/x];let d,c;d=Pa(l(s[0],ye.tmin),a.arrMin([s[1],ye.horizon,ye.tmax+i]),R.width/8);let u="M"+ze(V(d[0]*x))+" "+ze(_(ye.auraf(d[0])+n));for(c=1;c<d.length;c++)u+=" L"+ze(V(d[c]*x))+" "+ze(_(ye.auraf(d[c])+n));for(c=d.length-1;c>=0;c--)u+=" L"+ze(V(d[c]*x))+" "+ze(_(ye.auraf(d[c])+r));if(u+=" Z",t.empty()?Rt.append("svg:path").attr("class","aura").attr("d",u).style("fill",a.BHUE.LPURP).style("stroke-width",2).style("stroke",a.BHUE.LPURP):t.attr("d",u),s[0]<ye.tmin){for(d=Pa(s[0],ye.tmin,R.width/8),u="M"+ze(V(d[0]*x))+" "+ze(_(ye.auraf(d[0])+n)),c=1;c<d.length;c++)u+=" L"+ze(V(d[c]*x))+" "+ze(_(ye.auraf(d[c])+n));for(c=d.length-1;c>=0;c--)u+=" L"+ze(V(d[c]*x))+" "+ze(_(ye.auraf(d[c])+r));u+=" Z",e.empty()?Rt.append("svg:path").attr("class","aurapast").attr("d",u).style("fill",a.BHUE.LPURP).style("stroke-width",2).style("stroke-dasharray","4,4").style("stroke",a.BHUE.LPURP):e.attr("d",u)}else e.remove()}else t.remove(),e.remove()}function xr(){if(de||null==z.divGraph||0==me.length)return;const e=t.selectAll("#svg"+T+" #ybhpgrp path"),n=t.selectAll("#svg"+T+" #ybhplinesgrp path"),o=e.size()+n.size(),i=[ye.tini,ye.tfin],s=(ye.asof,ye.asof,a.BHUE.RAZR3),d=a.BHUE.RAZR2,c=a.BHUE.RAZR1,u=(ye.tfin-ye.tini)/h,p=[[0,2,"#ffff88","none",0,.72,i],[u,-1,"#ffffbd","none",0,.72,i]],f=[[6,6,"none",s,.99,1,i],[2,2,"none",d,.99,1,i],[1,1,"none",c,.99,1,i],[0,2,"#ffff88","none",0,.72,i],[u,-1,"#ffffbd","none",0,.72,i]];let g;g=ye.maxflux>0?p:f;for(let t=0;t<l(o,g.length);t++){const e="halfplane"+t,a=g[t];if(null==a||null==a[2]&&null==a[3]){it.select("."+e).remove(),st.select("."+e).remove();continue}let n,l;a[0]!=a[1]?(l=it,st.select("."+e).remove()):(l=st,it.select("."+e).remove()),n=l.select("."+e);const o="r"+a[0]+a[1],i=ye.yaw*a[4]/2;let s=a[6];null==s&&(s=[-1/0,1/0]);const d=a[0],c=a[1];if(d<0){console.log("updateYBHP(): Invalid region definition");continue}let u,h,p=me[0].end[0],f=me[me.length-1].sta[0];p<s[0]&&(p=s[0]),f>s[1]&&(f=s[1]),ye.yaw<0?(u=ye.yMin-.1*(ye.yMax-ye.yMin),h=ye.yMax+.1*(ye.yMax-ye.yMin)):(u=ye.yMax+.1*(ye.yMax-ye.yMin),h=ye.yMin-.1*(ye.yMax-ye.yMin));const y=Ee(d);let m=y[0][0],v=y[0][1];m<p&&(m=p,v=r.isoval(y,m));let b="M"+ze(V(m*x))+" "+ze(_(v)+i);for(let t=1;t<y.length&&(m=y[t][0],v=y[t][1],m<p||(m>f&&(m=f,v=r.isoval(y,m)),b+=" L"+ze(V(m*x))+" "+ze(_(v)+i),!(y[t][0]>f)));t++);if(-1==c)b+=" L"+ze(V(f*x))+" "+ze(_(r.isoval(y,f))+i),b+=" L"+ze(V(f*x))+" "+ze(_(u)),b+=" L"+ze(V(p*x))+" "+ze(_(u)),b+=" Z";else if(-2==c)b+=" L"+V(f*x)+" "+ze(_(r.isoval(y,f))+i),b+=" L"+ze(V(f*x))+" "+ze(_(h)),b+=" L"+ze(V(p*x))+" "+ze(_(h)),b+=" Z";else if(d!=c){const t=Ee(c),e=t.length;let a=t[e-1][0],n=t[e-1][1];a>f&&(a=f,n=r.isoval(t,a)),b+=" L"+ze(V(a*x))+" "+ze(_(n)+i);for(let l=e-2;l>=0&&(a=t[l][0],n=t[l][1],a>f||(a<p&&(a=p,n=r.isoval(t,a)),b+=" L"+ze(V(a*x))+" "+ze(_(n)+i),!(t[l][0]<p)));l--);b+=" Z"}n.empty()?l.append("svg:path").attr("class","ybhp "+e).attr("id",o).attr("d",b).attr("fill",a[2]).attr("fill-opacity",a[5]).attr("stroke",a[3]).attr("stroke-width",a[4]):n.attr("d",b).attr("id",o).attr("fill",a[2]).attr("fill-opacity",a[5]).attr("stroke",a[3]).attr("stroke-width",a[4])}}function vr(){if(de||null==z.divGraph||0==me.length)return;const e=dt.select(".pinkregion"),n=Ea(me);let l=fe;z.roadEditor||(l=me);const o=ye.asof,i=ye.horizon;let s;s=ye.yaw>0?ye.yMin-5*(ye.yMax-ye.yMin):ye.yMax+5*(ye.yMax-ye.yMin);const d="url(#pinkzonepat"+T+")",c=t.select(" #pinkzonepat"+T+" rect"),u=t.select(" #pinkzonepat"+T+" line");c.attr("fill",n||!z.roadEditor?a.BHUE.PINK:"#ffbbbb"),u.style("stroke",n||!z.roadEditor?"#aaaaaa":"#666666");const h=r.findSeg(l,o),p=r.findSeg(l,i);let f="M"+V(o*x)+" "+_(r.rdf(l,o));for(let t=h;t<p;t++)f+=" L"+V(l[t].end[0]*x)+" "+_(l[t].end[1]);f+=" L"+V(i*x)+" "+_(r.rdf(l,i)),f+=" L"+V(i*x)+" "+_(s),f+=" L"+V(o*x)+" "+_(s),f+=" Z",ct.attr("patternTransform",ye.dir>0?"rotate(135)":"rotate(45)").attr("x",-ye.dir*V(o*x)),e.empty()?dt.append("svg:path").attr("class","pinkregion").attr("d",f).attr("fill-opacity",.4).attr("fill",d):e.attr("d",f).attr("fill",d)}function br(t,e,n,l,o,i){if(de||null==z.divGraph||0==me.length)return;const s=n.select("."+l);if(null==o)return void s.remove();const c=z.oldRoadLine.dash+","+d(z.oldRoadLine.dash/2),u=i?c:null;let h=V(t[0].sta[0]*x),p=_(t[0].sta[1]+o),f=V(t[0].end[0]*x),g=_(t[0].end[1]+o);if(t[0].sta[0]<e.tini&&(h=V(e.tini*x),p=_(r.rdf(t,e.tini)+o)),i){const t=-V(e.tini*x)%d(1.5*z.oldRoadLine.dash);f!==h&&(p+=(-t-h)*(g-p)/(f-h)),(h<0||t>0)&&(h=-t)}let y="M"+ze(h)+" "+ze(p);for(const r of t){let t=a.daysnap(r.end[0]);if(f=V(r.end[0]*x),!(t<e.tini)){if(t>e.tfin)break;if(g=_(r.end[1]+o),y+=" L"+ze(f)+" "+ze(g),f>R.width)break}}s.empty()?n.append("svg:path").attr("class",l).attr("d",y).style("stroke-dasharray",u):s.attr("d",y).style("stroke-dasharray",u)}function wr(t,e){let a=[t[1][0]-t[0][0],t[1][1]-t[0][1]];const r=1/a[0],n=1/a[1],l=Math.sign(r),o=Math.sign(n),i=(e[0]-l*e[2]-t[0][0])*r,s=(e[1]-o*e[3]-t[0][1])*n,d=(e[0]+l*e[2]-t[0][0])*r,c=(e[1]+o*e[3]-t[0][1])*n;return!(i>c||s>d||(i>s?i:s)>1||(d<c?d:c)<0)}function kr(t,e){if(!t||!t.length)return!1;const r=e[0]-e[2],n=e[0]+e[2];let l=a.searchLow(t,t=>t[0]<r?-1:1),o=a.searchLow(t,t=>t[0]<n?-1:1);l<0&&(l=0),o>t.length-2&&(o=t.length-2);for(let a=l;a<=o;a++)if(wr([t[a],t[a+1]],e))return!0;return!1}let Er,zr=-1;function Tr(t){const e=Ee(t),n=[V.invert(0)/x,V.invert(R.width)/x],s=[_.invert(R.height),_.invert(0)],d=[(n[0]+n[1])/2,(s[0]+s[1])/2,(n[1]-n[0])/2,(s[1]-s[0])/2];if(t!=zr&&(zr=t,Er=Array(t).fill().map((t,e)=>e)),kr(e,d)){const t=a.searchHigh(Er,t=>!function(t,e,n){if(!(t&&t.length&&e&&e.length))return!1;const l=n[0]-n[2],o=n[0]+n[2];if(i(r.isoval(t,l)-r.isoval(e,l))>1e-5||i(r.isoval(t,o)-r.isoval(e,o))>1e-5)return!1;let s=a.searchHigh(t,t=>t[0]<l?-1:1),d=a.searchLow(t,t=>t[0]<o?-1:1),c=a.searchHigh(e,t=>t[0]<l?-1:1),u=a.searchLow(e,t=>t[0]<o?-1:1);for(let a=s;a<d;a++)if(i(r.isoval(e,t[a][0])-t[a][1])>1e-5)return!1;for(let a=c;a<u;a++)if(i(r.isoval(t,e[a][0])-e[a][1])>1e-5)return!1;return!0}(e,Ee(t),d)?-1:1);return o(t,Er.length-1)}const c=a.searchLow(Er,t=>kr(Ee(t),d)?-1:1);return l(c,0)}function Rr(){if(de||null==z.divGraph||0==me.length)return;let t=gt.selectAll(".guides");if(z.roadEditor&&!z.showGuidelines)return void t.remove();let e=1;const n=[V.invert(0)/x,V.invert(R.width)/x],s=(t,e)=>(function(t,e){const n=Ee(t);null==e&&(e=[-1/0,1/0]);let l=n[0][0],o=n[0][1];l<e[0]&&(l=e[0],o=r.isoval(n,l));let i="M"+ze(V(l*x))+" "+ze(_(o)),s=a.searchHigh(n,t=>t[0]<e[0]?-1:1),d=a.searchHigh(n,t=>t[0]<e[1]?-1:1);d>n.length-1&&(d=n.length-1);for(let t=s;t<=d;t++)i+=" L"+ze(V(n[t][0]*x))+" "+ze(_(n[t][1]));return i})(t,[l(ye.tini,n[0]),o(ye.tfin,n[1])]),c=function(t){let e=0;const a=o(z.maxFutureDays,d((ye.tfin-ye.tini)/h)),n=Ee(0),l=Ee(a);return e=ye.yaw*ye.dir>0?i(r.isoval(n,t[0])-r.isoval(l,t[0]))/a:i(r.isoval(n,t[1])-r.isoval(l,t[1]))/a}(n),u=i(_(0)-_(c));let p=Tr(d((ye.tfin-ye.tini)/h));p=d(p/(e=u>8||p<42?1:7*u>8||p<168?7:28*u>12||p<672?28:112*u>12||p<2016?112:336));let f=Er.slice(0,p+1).map(t=>(t+1)*e-1);(t=t.data(f)).exit().remove(),t.enter().append("svg:path").attr("class","guides").attr("d",s).attr("id",t=>"g"+t).attr("transform",null),t.attr("d",s).attr("id",t=>"g"+t).attr("transform",null)}function Mr(){de||null==z.divGraph||0==me.length||br(me,ye,yt,"maxflux",0!=ye.maxflux?ye.yaw*ye.maxflux:null,!1)}function Dr(){de||null==z.divGraph||0==me.length||br(me,ye,mt,"stdflux",0!=ye.maxflux?ye.yaw*ye.stdflux:null,!0)}function Ar(){if(de||null==z.divGraph||0==me.length)return;const e=bt.selectAll(".knots").data(me),a=S.selectAll(".remove").data(me);if(!z.roadEditor)return e.remove(),void a.remove();e.exit().remove(),e.attr("x1",function(t){return V(t.end[0]*x)}).attr("y1",0).attr("x2",function(t){return V(t.end[0]*x)}).attr("y2",R.height).attr("stroke","rgb(200,200,200)").attr("stroke-width",z.roadKnot.width),e.enter().append("svg:line").attr("class","knots").attr("id",function(t,e){return e}).attr("name",function(t,e){return"knot"+e}).attr("x1",function(t){return V(t.end[0]*x)}).attr("x2",function(t){return V(t.end[0]*x)}).attr("stroke","rgb(200,200,200)").attr("stroke-width",z.roadKnot.width).on("wheel",function(e){const a=new t.event.constructor(t.event.type,t.event);Yt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseover",function(e,a){rr||sr||cr||qa==r.RP.DATE&&a==Za||(mn(a,!0),t.select(this).attr("stroke-width",z.roadKnot.width+2))}).on("mouseout",function(e,a){rr||sr||cr||qa==r.RP.DATE&&a==Za||(mn(a,!1),t.select(this).attr("stroke-width",z.roadKnot.width))}).on("click",function(e,a){t.event.ctrlKey&&function(e,a){const n=Number(a),l=t.select(z.divTable);me[n].auto==r.RP.DATE&&(z.keepSlopes?bn(a):wn(a));const o=l.select("[name=enddate"+n+"]").node();let i,s;o.focus(),document.body.createTextRange?((i=document.body.createTextRange()).moveToElementText(o),i.select()):window.getSelection&&(s=window.getSelection(),(i=document.createRange()).selectNodeContents(o),s.removeAllRanges(),s.addRange(i))}(0,this.id)}).call(t.drag().on("start",nr).on("drag",lr).on("end",or)),a.exit().remove(),a.attr("transform",function(t){return"translate("+(V(t.end[0]*x)+D.left-14*z.roadKnot.rmbtnscale)+","+(D.top-28*z.roadKnot.rmbtnscale-3)+") scale("+z.roadKnot.rmbtnscale+")"}).style("visibility",function(t,e){return e>0&&e<me.length-2?"visible":"hidden"}),a.enter().append("use").attr("class","remove").attr("xlink:href","#removebutton").attr("id",function(t,e){return e}).attr("name",function(t,e){return"remove"+e}).attr("transform",function(t){return"translate("+(V(t.end[0]*x)+D.left-14*z.roadKnot.rmbtnscale)+","+(D.top-28*z.roadKnot.rmbtnscale-3)+") scale("+z.roadKnot.rmbtnscale+")"}).style("visibility",function(t,e){return e>0&&e<me.length-2?"visible":"hidden"}).on("mouseenter",function(e,a){t.select(this).attr("fill",z.roadKnotCol.rmbtnsel),mn(a,!0)}).on("mouseout",function(e,a){t.select(this).attr("fill",z.roadKnotCol.rmbtns),mn(a,!1)}).on("click",ir)}function Pr(){if(de||null==z.divGraph||0==me.length)return;const e=St.selectAll(".roads").data(me);z.roadEditor?(e.exit().remove(),e.attr("x1",function(t){return V(t.sta[0]*x)}).attr("y1",function(t){return _(t.sta[1])}).attr("x2",function(t){return V(t.end[0]*x)}).attr("y2",function(t){return _(t.end[1])}).attr("stroke-dasharray",function(t,e){return 0==e||e==me.length-1?"3,3":"none"}).style("stroke",z.roadLineCol.invalid),e.enter().append("svg:line").attr("class","roads").attr("id",function(t,e){return e}).attr("name",function(t,e){return"road"+e}).attr("x1",function(t){return V(t.sta[0]*x)}).attr("y1",function(t){return _(t.sta[1])}).attr("x2",function(t){return V(t.end[0]*x)}).attr("y2",function(t){return _(t.end[1])}).style("stroke",z.roadLineCol.invalid).attr("stroke-dasharray",function(t,e){return 0==e||e==me.length-1?"3,3":"none"}).attr("stroke-width",z.roadLine.width).on("wheel",function(e){const a=new t.event.constructor(t.event.type,t.event);Yt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseover",function(e,a){rr||sr||cr||qa==r.RP.SLOPE&&a==Za||a>0&&a<me.length-1&&(t.select(this).attr("stroke-width",z.roadLine.width+2),vn(a,!0))}).on("mouseout",function(e,a){rr||sr||cr||qa==r.RP.SLOPE&&a==Za||a>0&&a<me.length-1&&(t.select(this).attr("stroke-width",z.roadLine.width),vn(a,!1))}).on("click",function(e,a){t.event.ctrlKey&&function(e,a){const n=Number(a),l=t.select(z.divTable);e.auto==r.RP.SLOPE&&bn(a);const o=l.select("[name=slope"+n+"]").node();let i,s;o.focus(),document.body.createTextRange?((i=document.body.createTextRange()).moveToElementText(o),i.select()):window.getSelection&&(s=window.getSelection(),(i=document.createRange()).selectNodeContents(o),s.removeAllRanges(),s.addRange(i))}(e,this.id)}).call(t.drag().on("start",function(e,n){n>0&&n<me.length-1&&function(e,n){t.event.sourceEvent.stopPropagation(),cr=!0,dr=a.daysnap(V.invert(t.event.x)/x),ka(),Ia=r.copyRoad(me),null==Za?Qa(n):null!=Za&&Za==n&&qa==r.RP.SLOPE?ar():(ar(),Qa(n));let l=(e.sta[0]+e.end[0])/2;l<V.invert(0)/x&&(l=V.invert(0)/x),l>V.invert(R.width)/x-10&&(l=V.invert(R.width)/x-10),Oa(e.end,[l,e.sta[1]+e.slope*(l-e.sta[0]),e.slope*ye.siru]),Ha.grp.raise()}(e,Number(this.id))}).on("drag",function(e,n){n>0&&n<me.length-1&&function(e,n){er(),ye.asof;const o=a.daysnap(V.invert(t.event.x)/x),i=_.invert(t.event.y),s=n,d=me;me[s].slope=(i-e.sta[1])/l(o-e.sta[0],h),me[s].end[1]=me[s].sta[1]+me[s].slope*(me[s].end[0]-me[s].sta[0]),me[s+1].sta[1]=me[s].end[1],z.keepSlopes||(me[s+1].slope=r.segSlope(me[s+1])),r.fixRoadArray(d,r.RP.VALUE,!1,r.RP.SLOPE),Va(s,!0);let c=(e.sta[0]+e.end[0])/2;c<V.invert(0)/x&&(c=V.invert(0)/x),c>V.invert(R.width)/x-10&&(c=V.invert(R.width)/x-10),Ya(e.end,[c,e.sta[1]+e.slope*(c-e.sta[0]),e.slope*ye.siru])}(e,Number(this.id))}).on("end",function(t,e){var a;e>0&&e<me.length-1&&(a=Number(this.id),cr=!1,null==Za&&(tr(a),Ka(),ra()),Ia=null)}))):e.remove()}function Br(){we=de?ye.dtdarray:r.dtdarray(me,ye),ke=[];for(let t=0;t<7;t++)ke[t]=r.isoline(me,we,ye,t)}function Lr(){de||null==z.divGraph||0==me.length||z.roadEditor&&(Ea(me)?Ot.attr("visibility","hidden"):Ot.attr("visibility","visible"))}function Sr(){if(de||null==z.divGraph)return;const e=Ut.selectAll(".dots").data(me);z.roadEditor?(e.exit().remove(),e.attr("cx",function(t){return ze(V(t.sta[0]*x))}).attr("cy",function(t){return ze(_(t.sta[1]))}),e.enter().append("svg:circle").attr("class","dots").attr("id",function(t,e){return e-1}).attr("name",function(t,e){return"dot"+(e-1)}).attr("cx",function(t){return ze(V(t.sta[0]*x))}).attr("cy",function(t){return ze(_(t.sta[1]))}).attr("r",Te(z.roadDot.size)).attr("fill",z.roadDotCol.editable).style("stroke-width",z.roadDot.border).on("wheel",function(e){const a=new t.event.constructor(t.event.type,t.event);Yt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseover",function(e,a){rr||sr||cr||qa==r.RP.VALUE&&a-1==Za||(xn(a-1,!0),t.select(this).attr("r",Te(z.roadDot.size+2)))}).on("mouseout",function(e,a){rr||sr||cr||qa==r.RP.VALUE&&a-1==Za||(xn(a-1,!1),t.select(this).attr("r",Te(z.roadDot.size)))}).on("click",function(e,a){t.event.ctrlKey&&function(e,a){const n=Number(a),l=t.select(z.divTable);me[n].auto==r.RP.VALUE&&wn(a);const o=l.select("[name=endvalue"+n+"]").node();let i,s;o.focus(),document.body.createTextRange?((i=document.body.createTextRange()).moveToElementText(o),i.select()):window.getSelection&&(s=window.getSelection(),(i=document.createRange()).selectNodeContents(o),s.removeAllRanges(),s.addRange(i))}(0,this.id)}).call(t.drag().on("start",function(e,a){!function(e,a){t.event.sourceEvent.stopPropagation(),sr=!0,ka(),Ia=r.copyRoad(me);const n=a;if(null==Za?Xa(n):null!=Za&&Za==n&&qa==r.RP.VALUE?ar():(ar(),Xa(n)),0!=n){const t=me[n];Oa(e.sta,[(t.sta[0]+t.end[0])/2,(t.sta[1]+t.end[1])/2,t.slope*ye.siru])}else Oa(e.sta);Ga.grp.raise()}(e,Number(this.id))}).on("drag",function(e,a){!function(e,a){er(),ye.asof;const n=_.invert(t.event.y),l=a,o=me,i=me[l];i.end[1]=n,i.slope=r.segSlope(i),r.fixRoadArray(o,z.keepSlopes?r.RP.VALUE:r.RP.SLOPE,!1,r.RP.VALUE),Va(0==l?0:l-1,!1),0!=l?Ya(e.sta,[(i.sta[0]+i.end[0])/2,(i.sta[1]+i.end[1])/2,i.slope*ye.siru]):Ya(e.sta)}(e,Number(this.id))}).on("end",function(t,e){var a;a=Number(this.id),sr=!1,null==Za&&($a(a),Ka(),ra()),Ia=null}))):e.remove()}let Ur={};function Cr(t){let e="";const a=r.dotcolor(me,ye,t[0],t[1],ke);return t[3]!=Xt.DPTYPE.AGGPAST&&(e+=" fuda"),e+=Ur[a]}Ur[a.BHUE.GRADOT]=" gra",Ur[a.BHUE.GRNDOT]=" grn",Ur[a.BHUE.BLUDOT]=" blu",Ur[a.BHUE.ORNDOT]=" orn",Ur[a.BHUE.REDDOT]=" red",Ur[a.BHUE.BLCK]=" blk";var Nr,Gr,Hr,Or,Yr,Kr,Vr=null,Ir=null;function jr(t){const n=V(a.daysnap(t[0])*x),l=_(t[1]),o=(null!=t[7]?"#"+t[7]+": ":"")+e.unix(t[0]).utc().format("YYYY-MM-DD")+", "+(null!=t[6]?a.shn(t[6]):a.shn(t[1]));null!=Ir&&oa(Ir);const i=[];""!==t[2]&&i.push('"'+t[2]+'"'),null!==t[6]&&t[1]!==t[6]&&i.push("total:"+t[1]);var s=r.dotcolor(me,ye,t[0],t[1],ke);Ir=na(n,l-(15+18*i.length),o,s,i)}function Fr(){oa(Ir)}function Zr(e,a,r,n=null,l=!0){let o;null==n&&(n=r),(o=e.selectAll("."+r).data(a)).exit().remove(),o.attr("cx",function(t){return ze(V(t[0]*x))}).attr("cy",function(t){return ze(_(t[1]))}).attr("class",n);var i=o.enter().append("svg:circle");i.attr("class",n).attr("cx",function(t){return ze(V(t[0]*x))}).attr("cy",function(t){return ze(_(t[1]))}),z.headless||i.on("wheel",function(e){var a=new t.event.constructor(t.event.type,t.event);Yt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseenter",function(t){null!=z.divData&&z.dataAutoScroll&&null!=t[7]&&function(t){if(t=ve.length-t-1,!Be.node().offsetParent)return;Ne=t;const e=Math.floor(z.dataTableSize/2),a=Math.max(0,Math.min(t-e,ve.length-z.dataTableSize));Ce=a,Ge(),ta()}(t[7]),null!=Vr&&window.clearTimeout(Vr),Vr=window.setTimeout(function(){jr(t),Vr=null},500)}).on("mouseout",function(){Ne=-1,ta(),null!=Ir&&(Fr(),Ir=null),window.clearTimeout(Vr),Vr=null})}function qr(){if(!de&&null!=z.divGraph&&!z.roadEditor){var t=[V.invert(0).getTime()/x,V.invert(R.width).getTime()/x],e=Et.selectAll(".rosy"),a=zt.selectAll(".rd");if(z.showData||!z.roadEditor)if(ye.rosy){var r,n=(null!=Xt.flad?Xt.rosydata.slice(0,Xt.rosydata.length-1):Xt.rosydata).filter(function(e){return e[0]>=t[0]&&e[0]<=t[1]||e[4]>=t[0]&&e[4]<=t[1]});if(0==Xt.rosydata.length){var l=-1;for(r=0;r<Xt.rosydata.length-1;r++)if(Xt.rosydata[r][0]<=t[0]&&Xt.rosydata[r+1][0]>=t[1]){l=r;break}l>0&&(n=Xt.rosydata.slice(l,l+2))}if(0!=n.length){let t="M"+ze(V(n[0][4]*x))+" "+ze(_(n[0][5]));for(r=0;r<n.length;r++)t+=" L"+ze(V(n[r][0]*x))+" "+ze(_(n[r][1]));e.empty()?Et.append("svg:path").attr("class","rosy").attr("d",t):e.attr("d",t)}else e.remove();Zr(zt,n,"rd","rd",!0)}else e.remove(),a.remove();else e.remove(),a.remove()}}function Jr(){if(de||null==z.divGraph)return;const t=V.invert(0).getTime()/x,e=V.invert(R.width).getTime()/x,a=function(a){return a[0]>=t&&a[0]<=e||a[4]>=t&&a[4]<=e};let n=wt.selectAll(".steppy"),l=kt.selectAll(".std");if(z.showData||!z.roadEditor)if(!z.roadEditor&&ye.steppy&&0!==Wt.length){const l=Wt.filter(a);let o;if(0===l.length){let a=-1;for(o=0;o<Wt.length-1;o++)if(Wt[o][0]<=t&&Wt[o+1][0]>=e){a=o;break}a>0&&(l=Wt.slice(a,a+2))}if(0!==l.length){let a;if(Wt[0][0]>t&&Wt[0][0]<e&&Wt[0][0]in Xt.allvals){const t=Xt.allvals[Wt[0][0]][0][1];a="M"+ze(V(Wt[0][0]*x))+" "+ze(_(t)),a+="L"+ze(V(l[0][4]*x))+" "+ze(_(l[0][5]))}else a="M"+ze(V(l[0][4]*x))+" "+ze(_(l[0][5]));for(o=0;o<l.length;o++)a+=" L"+ze(V(l[o][0]*x))+" "+ze(_(l[o][5])),a+=" L"+ze(V(l[o][0]*x))+" "+ze(_(l[o][1]));n.empty()?wt.append("svg:path").attr("class","steppy").attr("d",a):n.attr("d",a);let i=wt.selectAll(".steppyppr");if(null!==Xt.flad)if(ye.yaw*ye.dir<0&&ye.asof!==ye.tdat){const t=Xt.flad[1]+r.ppr(me,ye,ye.asof);a="M"+ze(V(l[l.length-1][0]*x))+" "+ze(_(l[l.length-1][1])),a+=" L"+ze(V(l[l.length-1][0]*x))+" "+ze(_(t)),i.empty()?wt.append("svg:path").attr("class","steppyppr").attr("d",a):i.attr("d",a)}else i.remove();else i.remove()}else n.remove();Zr(kt,Xt.flad?l.slice(0,l.length-1):l,"std","std",!0)}else n.remove(),l.remove();else n.remove(),l.remove()}function Wr(){if(!de&&null!=z.divGraph){var t,e=[V.invert(0).getTime()/x,V.invert(R.width).getTime()/x];if(z.showData||!z.roadEditor){var a=Xt.derails.filter(function(t){return t[0]>=e[0]&&t[0]<=e[1]}),r=ye.yaw>0?"#downarrow":"#uparrow";(t=Mt.selectAll(".derails").data(a)).exit().remove(),t.attr("transform",function(t){return"translate("+V(t[0]*x)+","+_(t[1])+"),scale("+z.dataPoint.fsize*re/24+")"}),t.enter().append("svg:use").attr("class","derails").attr("xlink:href",r).attr("transform",function(t){return"translate("+V(t[0]*x)+","+_(t[1])+"),scale("+z.dataPoint.fsize*re/24+")"})}else(t=Mt.selectAll(".derails")).remove()}}function _r(){if(!de&&null!=z.divGraph&&0!=me.length){var t=[V.invert(0).getTime()/x,V.invert(R.width).getTime()/x],e=function(e){return e[0]>=t[0]&&e[0]<=t[1]||e[4]>=t[0]&&e[4]<=t[1]};if(ye.asof,z.showData||!z.roadEditor){var a=null!=Xt.flad?Wt.slice(0,Wt.length-1):Wt;a=a.filter(e),ye.plotall&&!z.roadEditor?Zr(Dt,_t.filter(function(e){return e[0]>=t[0]&&e[0]<=t[1]}),"ap",t=>"ap"+Cr(t),!0):Dt.selectAll(".ap").remove(),z.roadEditor?Zr(At,a.concat(Xt.fuda),"dp",t=>"dp"+Cr(t),!0):(Zr(At,a.concat(Xt.fuda),"dp",t=>"dp"+Cr(t),!0),Zr(Pt,Xt.hollow.filter(e),"hp",t=>"hp"+Cr(t),!0));var n=Bt.selectAll(".fladp");if(null!=Xt.flad){const t=r.ppr(me,ye,ye.asof),e=Xt.flad[1]+t,a=0==t?1:.5;n.empty()?Bt.append("svg:use").attr("class","fladp").attr("xlink:href","#rightarrow").attr("fill",r.dotcolor(me,ye,Xt.flad[0],e,ke)).attr("fill-opacity",a).attr("transform","translate("+V(Xt.flad[0]*x)+","+_(e)+"),scale("+z.dataPoint.fsize*re/24+")").style("pointer-events",function(){return z.roadEditor?"none":"all"}).on("mouseenter",function(){null!=Vr&&window.clearTimeout(Vr),Vr=window.setTimeout(function(){jr(Xt.flad),Vr=null},500)}).on("mouseout",function(){null!=Ir&&(Fr(),Ir=null),window.clearTimeout(Vr),Vr=null}):n.attr("fill",r.dotcolor(me,ye,Xt.flad[0],e,ke)).attr("fill-opacity",a).attr("transform","translate("+V(Xt.flad[0]*x)+","+_(e)+"),scale("+z.dataPoint.fsize*re/24+")")}else n.empty()||n.remove()}else At.selectAll(".dp").remove(),(n=At.selectAll(".fladp")).remove()}}function Xr(){if(!de){var t=Tt.selectAll(".movingav");if(!z.roadEditor&&ye.movingav&&z.showData){var e=[V.invert(0).getTime()/x,V.invert(R.width).getTime()/x],r=ye.filtpts.filter(function(t){return t[0]>e[0]-2*h&&t[0]<e[1]+2*h});if(r.length>0){var n="M"+ze(V(r[0][0]*x))+" "+ze(_(r[0][1]));for(let t=1;t<r.length;t++)n+=" L"+ze(V(r[t][0]*x))+" "+ze(_(r[t][1]));t.empty()?Tt.append("svg:path").attr("class","movingav").attr("d",n).style("fill","none").attr("stroke-width",Te(3*re)).style("stroke",a.BHUE.PURP):t.attr("d",n).attr("stroke-width",Te(3*re))}else t.remove()}else t.remove()}}function $r(){t.select(z.divTable).attr("class","bmndrroad"),Nr=t.select(z.divTable).select(".rtbmain"),Gr=t.select(z.divTable).select(".rtable"),Hr=Gr.append("div").attr("class","roadbody")}const Qr=["dt","vl","sl"];function tn(){var e,a;z.roadEditor?(e=["","Start Date","Value","",""],a=["","End Date","Value","Daily Slope",""]):(e=["","Start Date","Value",""],a=["","End Date","Value","Daily Slope"]),(Or=t.select(z.divTable).select(".rtbstart")).append("div").attr("class","roadhdr").append("div").attr("class","roadhdrrow").selectAll("span.rdhdrcell").data(e).enter().append("span").attr("class",(t,e)=>"rdhdrcell "+Qr[e]).text(t=>t),Yr=Or.append("div").attr("class","roadbody"),(Kr=Or.append("div").attr("class","roadhdr")).append("div").attr("class","roadhdrrow").selectAll("span.rdhdrcell").data(a).enter().append("span").attr("class",(t,e)=>"rdhdrcell "+Qr[e]).text(t=>t)}var en,an;function rn(){var e;e=z.roadEditor?["","Goal Date","Value","Daily Slope","",""]:["","Goal Date","Value","Daily Slope"],(en=t.select(z.divTable).select(".rtbgoal")).append("div").attr("class","roadhdr").append("div").attr("class","roadhdrrow").selectAll("span.rdhdrcell").data(e).enter().append("span").attr("class",(t,e)=>"rdhdrcell "+Qr[e]).text(t=>t),an=en.append("div").attr("class","roadbody")}let nn=null;function ln(){null!=nn&&(nn.picker&&nn.picker.destroy(),nn=null)}function on(t,r,n,l,o){console.log("createDatePicker()"+r),ln(),nn={min:r,max:n,flt:l,tl:o,fld:t,oldText:t.text()},k()&&(t.attr("contenteditable",!1),setTimeout(function(){t.attr("contenteditable",!0)},100));let i=e(nn.oldText);nn.picker=new Pikaday({keyboardInput:!1,onSelect:function(t){var e=nn.picker.toString(),r=a.dayparse(e,"-");e!==nn.oldText&&(isNaN(r)||(nn.fld.text(e),nn.oldText=e,ln(),document.activeElement.blur()))},minDate:r,maxDate:n}),nn.picker.setMoment(i);var s=t.node().getBoundingClientRect(),d=o.node().getBoundingClientRect();l.style("left",s.right-d.left+"px").style("top",s.bottom+3-d.top+"px"),l.node().appendChild(nn.picker.el,t.node())}let sn={field:null,oldText:null};function dn(a,r){if(z.roadEditor){console.debug("tableFocusIn("+r+") for "+this.parentNode.id),sn.field=t.select(this),sn.oldText=sn.field.text(),ln();var n=Number(sn.field.node().parentNode.id);if(null!=Za&&ar(),0==r){Wa(n,!1);var l=0==n?ye.xMin-10*h*u:me[n].sta[0],o=n==me.length-1?me[n].end[0]:me[n+1].end[0],i=e(e.unix(l).utc().format("YYYY-MM-DD")),s=e(e.unix(o).utc().format("YYYY-MM-DD")),d=t.select(z.divTable).select(".floating");on(sn.field,i.toDate(),s.toDate(),d,qt)}else 1==r?Xa(n,!1):2==r&&Qa(n,!1)}}function cn(e,r){if(!z.roadEditor)return;let n=Number(this.parentNode.id),l=t.select(this).text();if(ln(),ar(),l===sn.oldText)return;if(null==sn.oldText)return;let o=0==r?a.dayparse(l,"-"):l;if(isNaN(o))return t.select(this).text(sn.oldText),sn.oldText=null,void(sn.field=null);0==r&&(pn(n,o),ar()),1==r&&(fn(n,o),ar()),2==r&&(gn(n,o),ar()),sn.oldText=null,sn.field=null}function un(e,r){if(13==t.event.keyCode){window.getSelection().removeAllRanges();var n=t.select(this).text(),l=0==r?a.dayparse(n,"-"):n;if(isNaN(l))return t.select(this).text(sn.oldText),void(sn.oldText=null);0==r&&pn(Number(this.parentNode.id),l),1==r&&fn(Number(this.parentNode.id),l),2==r&&gn(Number(this.parentNode.id),l),sn.oldText=t.select(this).text()}}function hn(e,a){var n=Number(this.parentNode.id);z.roadEditor&&a==me[n].auto&&(0==a?bn(n):1==a?wn(n):2==a&&function(e){me[e].auto=r.RP.DATE;var a=t.select(z.divTable);a.select(".roadrow [name=enddate"+e+"]").style("color",z.roadTableCol.textDisabled).style("background-color",z.roadTableCol.bgDisabled).attr("contenteditable",!1),a.select(".roadrow [name=endvalue"+e+"]").style("color",z.roadTableCol.text).style("background-color",z.roadTableCol.bg).attr("contenteditable",z.roadEditor),a.select(".roadrow [name=slope"+e+"]").style("color",z.roadTableCol.text).style("background-color",z.roadTableCol.bg).attr("contenteditable",z.roadEditor),a.select(".roadrow [name=btndate"+e+"]").property("checked",!0),a.select(".roadrow [name=btnvalue"+e+"]").property("checked",!1),a.select(".roadrow [name=btnslope"+e+"]").property("checked",!1)}(n),this.focus())}function pn(t,e){isNaN(e)?Tn():function(t,e,n=!0){ka();const l=0==t?ye.xMin-10*h*u:me[t].sta[0]+.01,o=t==me.length-1?me[t].end[0]+.01:me[t+1].end[0]+.01;e<=l&&(e=a.daysnap(l)),e>=o&&(e=a.daysnap(l)),me[t].end[0]=e,r.fixRoadArray(me,null,n,r.RP.DATE),ra()}(t,Number(e),!0)}function fn(t,e){isNaN(e)?Tn():function(t,e,a=!1){ka(),me[t].end[1]=e,a||(z.keepSlopes||(me[t].slope=r.segSlope(me[t])),1==t?me[t-1].sta[1]=e:t==me.length-1?(me[t].end[1]=e,me[t-1].slope=(me[t].sta[1]-me[t-1].sta[1])/(me[t].sta[0]-me[t-1].sta[0])):me[t-1].slope=(me[t].sta[1]-me[t-1].sta[1])/(me[t].sta[0]-me[t-1].sta[0])),r.fixRoadArray(me,z.keepSlopes?r.RP.VALUE:null,a,r.RP.VALUE),ra()}(t,Number(e),!0)}function gn(t,e){isNaN(e)?Tn():function(t,e,a=!1){t!=me.length-1&&(ka(),me[t].slope=e/ye.siru,a||z.keepSlopes||(me[t].end[1]=me[t].sta[1]+me[t].slope*(me[t].end[0]-me[t].sta[0]),me[t+1].sta[1]=me[t].end[1],me[t+1].slope=r.segSlope(me[t+1])),r.fixRoadArray(me,null,a,r.RP.SLOPE),ra())}(t,Number(e),!0)}function yn(t,e=!0){if(z.tableAutoScroll&&null==Za&&0!==z.tableHeight){let a=t.node().parentNode.getBoundingClientRect();if(0==a.height)return;let r=t.data(),n=a.height+1,l=r[0].i-1,o=l*n;if(null!=z.divTable){let t=Nr.node(),a=(l-Math.floor(t.scrollTop/n))*n;(e||a<0||a-n>z.tableHeight)&&(t.scrollTop=o-z.tableHeight/2)}}}function mn(e,a,r=!0){if(null==z.divTable)return;let n=a?z.roadTableCol.bgHighlight:0==me[e].auto?z.roadTableCol.bgDisabled:z.roadTableCol.bg,l=t.select(z.divTable).select(".roadrow [name=enddate"+e+"]");l.empty()||(l.style("background-color",n),r&&a&&yn(l))}function xn(e,a,r=!0){if(null!=z.divTable){var n=a?z.roadTableCol.bgHighlight:1==me[e].auto?z.roadTableCol.bgDisabled:z.roadTableCol.bg,l=t.select(z.divTable).select(".roadrow [name=endvalue"+e+"]");l.empty()||(l.style("background-color",n),r&&a&&yn(l))}}function vn(e,a,r=!0){if(null!=z.divTable){var n=a?z.roadTableCol.bgHighlight:2==me[e].auto?z.roadTableCol.bgDisabled:z.roadTableCol.bg,l=t.select(z.divTable).select(".roadrow [name=slope"+e+"]");l.empty()||(l.style("background-color",n),r&&a&&yn(l))}}function bn(e){me[e].auto=r.RP.VALUE;var a=t.select(z.divTable);a.select(".roadrow [name=enddate"+e+"]").style("color",z.roadTableCol.text).style("background-color",z.roadTableCol.bg).attr("contenteditable",z.roadEditor),a.select(".roadrow [name=endvalue"+e+"]").style("color",z.roadTableCol.textDisabled).style("background-color",z.roadTableCol.bgDisabled).attr("contenteditable",!1),a.select(".roadrow [name=slope"+e+"]").style("color",z.roadTableCol.text).style("background-color",z.roadTableCol.bg).attr("contenteditable",z.roadEditor),a.select(".roadrow [name=btndate"+e+"]").property("checked",!1),a.select(".roadrow [name=btnvalue"+e+"]").property("checked",!0),a.select(".roadrow [name=btnslope"+e+"]").property("checked",!1)}function wn(e){me[e].auto=r.RP.SLOPE;var a=t.select(z.divTable);a.select(".roadrow [name=enddate"+e+"]").style("color",z.roadTableCol.text).style("background-color",z.roadTableCol.bg).attr("contenteditable",z.roadEditor),a.select(".roadrow [name=endvalue"+e+"]").style("color",z.roadTableCol.text).style("background-color",z.roadTableCol.bg).attr("contenteditable",z.roadEditor),a.select(".roadrow [name=slope"+e+"]").style("color",z.roadTableCol.textDisabled).style("background-color",z.roadTableCol.bgDisabled).attr("contenteditable",!1),a.select(".roadrow [name=btndate"+e+"]").property("checked",!1),a.select(".roadrow [name=btnvalue"+e+"]").property("checked",!1),a.select(".roadrow [name=btnslope"+e+"]").property("checked",!0)}function kn(){if(null!=z.divTable){var e=t.select(z.divTable).selectAll(".rtbstart .roadrow, .rtable .roadrow, .rtbgoal .roadrow"),a=e.selectAll(".rdbtn").data(function(t,e){var a;return[{order:8,row:a=z.reverseTable?me.length-2-e:e,name:"btndel"+a,evt:()=>Ca(a,!0),type:"button",txt:'<img class="ricon" src="../src/trash.svg" ></img>',auto:!1},{order:9,row:a,name:"btnadd"+a,evt:()=>(function(t){if(t<me.length-1){let e=(me[t].sta[0]+me[t+1].sta[0])/2;e-me[t].sta[0]>30*h&&(e=me[t].sta[0]+30*h),Ua(e)}else Ua(me[t].sta[0]+7*h)})(a+1),type:"button",txt:'<img class="ricon" src="../src/plus.svg"></img>',auto:!1}]});a.enter().append("button").attr("class",t=>"rdbtn "+t.txt).attr("id",t=>t.row).attr("name",t=>t.name).html(t=>t.txt).on("click",t=>t.evt()),a.exit().remove(),(a=e.selectAll(".rtbstart .rdbtn, .rtable .rdbtn, .rtbgoal .rdbtn")).attr("id",t=>t.row).attr("name",t=>t.name).style("display",(t,e)=>Number(t.row)>0&&Number(t.row)<me.length-2||4==e||e>0&&Number(t.row)>0?null:"none"),e.selectAll(".rdcell, .rdbtn").sort((e,a)=>t.ascending(e.order,a.order)),z.roadEditor||e.selectAll(".rdbtn").style("display","none").attr("value","")}}function En(t,e,n,l){var o=me.slice(e,n);l&&(o=o.reverse());var i=t.selectAll(".roadrow").data(o),s=t=>l?me.length-2-t:t;i.enter().append("div").attr("class","roadrow").attr("name",(t,a)=>"roadrow"+s(e+a)).attr("id",(t,a)=>s(e+a)).append("div").attr("class","rowid").text((t,a)=>s(e+a)+":"),i.exit().remove(),i.order(),(i=t.selectAll(".roadrow")).attr("name",(t,a)=>"roadrow"+s(e+a)).attr("id",(t,a)=>s(e+a)),i.select("div").text((t,a)=>s(e+a)+":");var d=i.selectAll(".rdcell").data((t,n)=>{var l=a.dayify(t.end[0],"-"),o=s(e+n);return[{order:2,value:l,name:"enddate"+o,auto:t.auto==r.RP.DATE,i:o},{order:4,value:a.shn(t.end[1]),name:"endvalue"+o,auto:t.auto==r.RP.VALUE,i:o},{order:6,value:isNaN(t.slope)?"duplicate":a.shn(t.slope*ye.siru),name:"slope"+o,auto:t.auto==r.RP.SLOPE,i:o}]});d.enter().append("div").attr("class",(t,e)=>"rdcell "+Qr[e]).attr("name",t=>t.name).attr("contenteditable",(t,e)=>t.auto||!z.roadEditor?"false":"true").on("click",hn).on("focusin",dn).on("focusout",cn).on("keydown",un),d.exit().remove(),(d=i.selectAll(".rdcell")).text((t,e)=>t.value).attr("name",t=>t.name).style("color",t=>me[t.i].sta[0]==me[t.i].end[0]&&me[t.i].sta[1]==me[t.i].end[1]?z.roadLineCol.invalid:t.auto?z.roadTableCol.textDisabled:z.roadTableCol.text).style("background-color",function(t){return t.auto?z.roadTableCol.bgDisabled:z.roadTableCol.bg}).attr("contenteditable",function(t,e){return t.auto||!z.roadEditor?"false":"true"})}function zn(){if(null!=z.divTable&&!ue)if(me.length>3){if(!Hr.node().offsetParent)return;t.select(z.divTable).style("width",Hr.node().offsetWidth+35+"px")}else{if(!an.node().offsetParent)return;t.select(z.divTable).style("width",an.node().offsetWidth+35+"px")}}function Tn(){if(null!=z.divTable){var e=z.reverseTable;En(Yr,0,1,!1),Yr.select("[name=slope0]").style("visibility","hidden").style("pointer-events","none").style("border","1px solid transparent"),En(Hr,1,me.length-2,e),En(an,me.length-2,me.length-1,!1),me.length<=3?(Kr.style("visibility","collapse"),t.select(z.divTable).select(".rtbmain").style("display","none")):(Kr.style("visibility",null),t.select(z.divTable).select(".rtbmain").style("display",null)),zn()}}function Rn(){Tn(),kn(),zn()}function Mn(){null!=z.divGraph&&(z.showContext?(H.attr("visibility","visible"),function(){if(de||null==z.divGraph||0==me.length)return;const t=Y.selectAll(".ctxoldroads");let e=fe;z.roadEditor||(e=me);let r="M"+ze(at(e[0].sta[0]*x))+" "+ze(lt(e[0].sta[1]));for(let t=0;t<e.length;t++)r+=" L"+ze(at(e[t].end[0]*x))+" "+ze(lt(e[t].end[1]));t.empty()?Y.append("svg:path").attr("class","ctxoldroads").attr("d",r).style("stroke-dasharray",z.roadEditor?z.oldRoadLine.ctxdash+","+d(z.oldRoadLine.ctxdash/2):null).style("fill","none").style("stroke-width",z.oldRoadLine.ctxwidth).style("stroke",z.roadEditor?a.BHUE.ORNG:a.BHUE.RAZR0):t.attr("d",r).style("stroke-dasharray",z.roadEditor?z.oldRoadLine.ctxdash+","+d(z.oldRoadLine.ctxdash/2):null).style("stroke",z.roadEditor?a.BHUE.ORNG:a.BHUE.RAZR0)}(),function(){if(!de&&null!=z.divGraph&&0!=me.length){var t=z.roadEditor?v.beyey:v.beye,e=Y.select(".ctxoldbullseye"),a=at(fe[fe.length-1].sta[0]*x)-z.bullsEye.ctxsize/2,r=lt(fe[fe.length-1].sta[1])-z.bullsEye.ctxsize/2;e.empty()?Y.append("svg:image").attr("class","ctxoldbullseye").attr("xlink:href",t).attr("externalResourcesRequired",!0).attr("x",a).attr("y",r).attr("width",z.bullsEye.ctxsize).attr("height",z.bullsEye.ctxsize):e.attr("x",a).attr("y",r)}}(),gr(),function(){if(de||null==z.divGraph||0==me.length)return;const t=Ea(me)?z.roadLineCol.valid:z.roadLineCol.invalid,e=Y.selectAll(".ctxroads").data(me);z.roadEditor?(e.exit().remove(),e.attr("x1",function(t){return at(t.sta[0]*x)}).attr("y1",function(t){return lt(t.sta[1])}).attr("x2",function(t){return at(t.end[0]*x)}).attr("y2",function(t){return lt(t.end[1])}).style("stroke",t),e.enter().append("svg:line").attr("class","ctxroads").attr("id",function(t,e){return e}).attr("name",function(t,e){return"ctxroad"+e}).attr("x1",function(t){return at(t.sta[0]*x)}).attr("y1",function(t){return lt(t.sta[1])}).attr("x2",function(t){return at(t.end[0]*x)}).attr("y2",function(t){return lt(t.end[1])}).style("stroke",t).style("stroke-width",z.roadLine.ctxwidth)):e.remove()}(),function(){if(de||null==z.divGraph)return;const t=Y.selectAll(".ctxdots").data(me);z.roadEditor?(t.exit().remove(),t.attr("cx",function(t){return ze(at(t.sta[0]*x))}).attr("cy",function(t){return ze(lt(t.sta[1]))}),t.enter().append("svg:circle").attr("class","ctxdots").attr("r",Te(z.roadDot.ctxsize)).attr("fill",z.roadDotCol.editable).style("stroke-width",z.roadDot.ctxborder).attr("cx",function(t){return ze(at(t.sta[0]*x))}).attr("cy",function(t){return ze(lt(t.sta[1]))})):t.remove()}(),function(){if(de||null==z.divGraph||0==me.length)return;const t=Y.select(".ctxhorizon"),e=z.horizon;t.empty()?Y.append("svg:line").attr("class","ctxhorizon").attr("x1",at(ye.horizon*x)).attr("y1",lt(ye.yMin-5*(ye.yMax-ye.yMin))).attr("x2",at(ye.horizon*x)).attr("y2",lt(ye.yMax+5*(ye.yMax-ye.yMin))).style("stroke",a.BHUE.AKRA).style("stroke-dasharray",e.ctxdash+","+e.ctxdash).style("stroke-width",Te(e.ctxwidth)):t.attr("x1",at(ye.horizon*x)).attr("y1",lt(ye.yMin-5*(ye.yMax-ye.yMin))).attr("x2",at(ye.horizon*x)).attr("y2",lt(ye.yMax+5*(ye.yMax-ye.yMin)));const r=at(ye.horizon*x)+12,n=M.height/2,l=Y.select(".ctxhortext");l.empty()?Y.append("svg:text").attr("class","ctxhortext").attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")").attr("fill",a.BHUE.AKRA).style("font-size",e.ctxfont+"px").text("Horizon"):l.attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")")}(),function(){if(de||null==z.divGraph||0==me.length)return;const t=Y.select(".ctxtoday"),e=Y.select(".ctxtodaytext");if(!z.roadEditor)return t.remove(),void e.remove();t.empty()?Y.append("svg:line").attr("class","ctxtoday").attr("x1",at(ye.asof*x)).attr("y1",0).attr("x2",at(ye.asof*x)).attr("y2",M.height).style("stroke","rgb(0,0,200)").style("stroke-width",Te(z.horizon.ctxwidth)):t.attr("x1",at(ye.asof*x)).attr("y1",0).attr("x2",at(ye.asof*x)).attr("y2",M.height);const a=at(ye.asof*x)-5,r=M.height/2;e.empty()?Y.append("svg:text").attr("class","ctxtodaytext").attr("x",a).attr("y",r).attr("transform","rotate(-90,"+a+","+r+")").attr("fill","rgb(0,0,200)").style("font-size",z.today.ctxfont+"px").text("Today"):e.attr("x",a).attr("y",r).attr("transform","rotate(-90,"+a+","+r+")")}(),z.showFocusRect?Zt.attr("visibility","visible"):Zt.attr("visibility","hidden")):(H.attr("visibility","hidden"),Zt.attr("visibility","hidden")))}function Dn(n=!1){if(null==z.divGraph)return;ar();const l=[V.invert(0).getTime()/x,V.invert(R.width).getTime()/x];var o;n&&(ne=0),(re=z.roadEditor?a.clip(a.rescale(l[1],l[0],l[0]+73*h,1,.7),.7,1):a.clip(a.rescale(l[1],l[0],l[0]+73*h,1,.55),.55,1))!=ne&&function(){let e="",r="#svg"+T+" ",n="pointer-events:"+(z.headless?"none;":"all;");e+=r+".rd {r:"+Te(z.dataPoint.size*re)+"px} ",e+=r+".std {r:"+Te((z.dataPoint.size+2)*re)+"px} ",e+=r+".ap {r:"+Te(.7*z.dataPoint.size*re)+"px;"+n+"} ",e+=r+".hp {r:"+Te(z.dataPoint.hsize*re)+"px;"+n+"} ",e+=r+".guides {stroke-width:"+Te(z.guidelines.width*re)+"px} ",e+=r+".rosy {stroke-width:"+Te(4*re)+"px} ",e+=r+".steppy {stroke-width:"+Te(4*re)+"px} ",e+=r+".steppyppr {stroke-width:"+Te(4*re)+"px} ",e+=r+".maxflux {fill:none;stroke:"+a.BHUE.BIGG+";stroke-width:"+Te(z.maxfluxline*re)+"px} ",e+=r+".stdflux {fill:none;stroke:"+a.BHUE.BIGG+";stroke-width:"+Te(z.stdfluxline*re)+"px} ",e+=r+".axis text {font-size:"+z.axis.font+"px;} ",e+=r+".axislabel {font-size:"+z.axis.font+"px;} ",z.roadEditor?(e+=r+".dp {r:"+Te(z.dataPoint.size*re)+"px;stroke:"+z.dataPointCol.stroke+";stroke-width:"+Te(z.dataPoint.border*re)+"px} ",e+=r+".razr {fill:none;pointer-events:none;stroke-width:"+Te(z.razrline*re)+"px;stroke:"+a.BHUE.RAZR0+"} "):(e+=r+".dp {r:"+Te(z.dataPoint.size*re)+"px;stroke:rgb(0,0,0);stroke-width:"+Te(1*re)+"px} ",e+=r+".dp.fuda {stroke-width:"+Te(.5*re)+"px} ",e+=r+".razr {fill:none;pointer-events:none;stroke-width:"+Te(z.razrline*re)+"px;stroke:"+a.BHUE.REDDOT+"} "),t.select("style#dynstyle"+T).text(e)}(),Lr(),yr(),function(){if(de||null==z.divGraph||0==me.length)return;const t=ot.select(".past");z.roadEditor?t.empty()?ot.insert("svg:rect",":first-child").attr("class","past").attr("x",V(ye.xMin)).attr("y",_(ye.yMax+3*(ye.yMax-ye.yMin))).attr("width",V(ye.asof*x)-V(ye.xMin)).attr("height",7*i(_(ye.yMin)-_(ye.yMax))).attr("fill",z.pastBoxCol.fill).attr("fill-opacity",z.pastBoxCol.opacity):t.attr("x",V(ye.xMin)).attr("y",_(ye.yMax+3*(ye.yMax-ye.yMin))).attr("width",V(ye.asof*x)-V(ye.xMin)).attr("height",7*i(_(ye.yMin)-_(ye.yMax))):t.remove()}(),xr(),vr(),Rr(),de||null==z.divGraph||0==me.length||(z.roadEditor?br(fe,ge,xt,"razr",0,!0):br(me,ye,xt,"razr",0,!1)),Mr(),Dr(),function(){if(!de&&null!=z.divGraph&&0!=me.length){var t=vt.select(".oldbullseye");if(z.roadEditor){var e=z.roadEditor?v.beyey:v.beye,a=V(ge.tfin*x)-z.bullsEye.size/2,n=_(r.rdf(fe,ge.tfin))-z.bullsEye.size/2;t.empty()?vt.append("svg:image").attr("class","oldbullseye").attr("xlink:href",e).attr("externalResourcesRequired",!0).attr("x",a).attr("y",n).attr("width",z.bullsEye.size).attr("height",z.bullsEye.size):t.attr("x",a).attr("y",n)}else t.remove()}}(),fr(),Ar(),_r(),Wr(),qr(),Jr(),de||null==z.divGraph||((o=Nt.selectAll(".hashtag").data(Xt.hashtags)).exit().remove(),o.attr("x",function(t){return V(t[0]*x)}).attr("transform",t=>"rotate(-90,"+V(t[0]*x)+","+R.height/2+")").text(t=>t[1]),o.enter().append("svg:text").attr("class","hashtag").attr("x",t=>V(t[0]*x)).attr("y",R.height/2).attr("transform",t=>"rotate(-90,"+V(t[0]*x)+","+R.height/2+")").attr("fill",a.BHUE.BLACK).style("font-size",z.horizon.font+"px").text(t=>t[1])),Xr(),Pr(),Sr(),function(){if(de||null==z.divGraph||0==me.length)return;const t=Gt.select(".horizon"),e=z.horizon;t.empty()?Gt.append("svg:line").attr("class","horizon").attr("x1",V(ye.horizon*x)).attr("y1",0).attr("x2",V(ye.horizon*x)).attr("y2",R.height).style("stroke",a.BHUE.AKRA).style("stroke-dasharray",e.dash+","+e.dash).attr("stroke-width",Te(e.width*re)):t.attr("x1",V(ye.horizon*x)).attr("y1",0).attr("x2",V(ye.horizon*x)).attr("y2",R.height).attr("stroke-width",Te(e.width*re));const r=V(ye.horizon*x)+14,n=R.height/2,l=Ht.select(".horizontext");l.empty()?Ht.append("svg:text").attr("class","horizontext").attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")").attr("fill",a.BHUE.AKRA).style("font-size",e.font+"px").text("Akrasia Horizon"):l.attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")")}(),function(){if(de||null==z.divGraph||0==me.length||0==Xt.oresets.length)return;const t=pt.selectAll(".oresets").data(Xt.oresets);z.roadEditor?t.remove():(t.exit().remove(),t.attr("x1",function(t){return V(t*x)}).attr("y1",0).attr("x2",function(t){return V(t*x)}).attr("y2",R.height),t.enter().append("svg:line").attr("class","oresets").attr("id",function(t,e){return e}).attr("name",function(t,e){return"oreset"+e}).attr("x1",function(t){return V(t*x)}).attr("y1",0).attr("x2",function(t){return V(t*x)}).attr("y2",R.height).attr("stroke","rgb(200,200,200)").style("stroke-dasharray",z.odomReset.dash+","+z.odomReset.dash).attr("stroke-width",z.odomReset.width))}(),function(){if(de||null==z.divGraph||0==me.length)return;const t=ht.select(".pastline"),r=ft.select(".pasttext");if(!z.roadEditor)return t.remove(),void r.remove();t.empty()?ht.append("svg:line").attr("class","pastline").attr("x1",V(ye.asof*x)).attr("y1",0).attr("x2",V(ye.asof*x)).attr("y2",R.height).style("stroke",a.BHUE.AKRA).style("stroke-width",Te(z.today.width)):t.attr("x1",V(ye.asof*x)).attr("y1",0).attr("x2",V(ye.asof*x)).attr("y2",R.height);const n=V(ye.asof*x)-8,l=R.height/2;r.empty()?ft.append("svg:text").attr("class","pasttext").attr("x",n).attr("y",l).attr("transform","rotate(-90,"+n+","+l+")").attr("fill",a.BHUE.AKRA).style("font-size",z.horizon.font+"px").text("Today ("+e.unix(ye.asof).utc().format("ddd")+")"):r.attr("x",n).attr("y",l).attr("transform","rotate(-90,"+n+","+l+")").text("Today ("+e.unix(ye.asof).utc().format("ddd")+")")}(),mr(),Yt.attr("color",r.dotcolor(me,ye,ye.tcur,ye.vcur,ke)),ne=re}!function(){const e=z.divGraph;if(null===e)return;for(;e.firstChild;)e.removeChild(e.firstChild);B=t.select(e).attr("class","bmndrgraph").append("svg:svg").attr("id","svg"+T).attr("xmlns","http://www.w3.org/2000/svg").attr("xmlns:xlink","http://www.w3.org/1999/xlink").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+Qt+" "+te).attr("width","100%").attr("height","100%").attr("class","bmndrsvg"),(L=B.append("defs")).insert("style").attr("type","text/css").text(y),L.insert("style").attr("id","dynstyle"+T).attr("type","text/css").text(""),L.append("clipPath").attr("id","plotclip"+T).append("rect").attr("x",0).attr("y",0).attr("width",R.width).attr("height",R.height),L.append("clipPath").attr("id","brushclip"+T).append("rect").attr("x",0).attr("y",0).attr("width",M.width).attr("height",M.height),L.append("clipPath").attr("id","buttonareaclip"+T).append("rect").attr("x",R.x).attr("y",0).attr("width",R.width).attr("height",D.top),L.append("path").style("stroke","none").attr("id","rightarrow").attr("d","M 55,0 -35,45 -35,-45 z"),L.append("path").style("stroke","none").attr("id","downarrow").attr("d","M 0,40 45,-50 -45,-50 z"),L.append("path").style("stroke","none").attr("id","uparrow").attr("d","M 0,-40 45,50 -45,50 z"),(ct=L.append("pattern").attr("id","pinkzonepat"+T).attr("x",0).attr("y",0).attr("width",10).attr("height",10).attr("patternTransform","rotate(45)").attr("patternUnits","userSpaceOnUse")).append("rect").attr("x",0).attr("y",0).attr("width",10).attr("height",10).attr("fill",a.BHUE.PINK),ct.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",10).style("stroke","#aaaaaa").style("stroke-width",1),(ut=L.append("pattern").attr("id","tapepat"+T).attr("x",0).attr("y",0).attr("width",20).attr("height",20).attr("patternTransform","rotate(45)").attr("patternUnits","userSpaceOnUse")).append("rect").attr("x",0).attr("y",0).attr("width",20).attr("height",20).attr("fill","#ffffff"),ut.append("line").attr("x1",0).attr("y1",0).attr("x2",20).attr("y2",0).style("stroke","#ff5555").style("stroke-width",25);const r=L.append("g").attr("id","removebutton");r.append("circle").attr("cx",14).attr("cy",14).attr("r",16).attr("fill","white"),r.append("path").attr("d","M13.98,0C6.259,0,0,6.261,0,13.983c0,7.721,6.259,13.982,13.98,13.982c7.725,0,13.985-6.262,13.985-13.982C27.965,6.261,21.705,0,13.98,0z M19.992,17.769l-2.227,2.224c0,0-3.523-3.78-3.786-3.78c-0.259,0-3.783,3.78-3.783,3.78l-2.228-2.224c0,0,3.784-3.472,3.784-3.781c0-0.314-3.784-3.787-3.784-3.787l2.228-2.229c0,0,3.553,3.782,3.783,3.782c0.232,0,3.786-3.782,3.786-3.782l2.227,2.229c0,0-3.785,3.523-3.785,3.787C16.207,14.239,19.992,17.769,19.992,17.769z");const n=L.append("g").attr("id","zoominbtn");!z.headless&&z.buttonZoom&&(n.append("path").style("fill","white").attr("d","m 530.86356,264.94116 a 264.05649,261.30591 0 1 1 -528.1129802,0 264.05649,261.30591 0 1 1 528.1129802,0 z"),n.append("path").attr("d","m 308.21,155.10302 -76.553,0 0,76.552 -76.552,0 0,76.553 76.552,0 0,76.552 76.553,0 0,-76.552 76.552,0 0,-76.553 -76.552,0 z m 229.659,114.829 C 537.869,119.51007 420.50428,1.9980234 269.935,1.9980234 121.959,1.9980234 2.0000001,121.95602 2.0000001,269.93202 c 0,147.976 117.2473599,267.934 267.9339999,267.934 150.68664,0 267.935,-117.51205 267.935,-267.934 z m -267.935,191.381 c -105.681,0 -191.381,-85.7 -191.381,-191.381 0,-105.681 85.701,-191.380996 191.381,-191.380996 105.681,0 191.381,85.700996 191.381,191.380996 0,105.681 -85.7,191.381 -191.381,191.381 z"));const l=L.append("g").attr("id","zoomoutbtn");!z.headless&&z.buttonZoom&&(l.append("path").style("fill","white").attr("d","m 530.86356,264.94116 a 264.05649,261.30591 0 1 1 -528.1129802,0 264.05649,261.30591 0 1 1 528.1129802,0 z"),l.append("path").attr("d","m 155.105,231.65502 0,76.553 229.657,0 0,-76.553 c -76.55233,0 -153.10467,0 -229.657,0 z m 382.764,38.277 C 537.869,119.51007 420.50428,1.9980234 269.935,1.9980234 121.959,1.9980234 2.0000001,121.95602 2.0000001,269.93202 c 0,147.976 117.2473599,267.934 267.9339999,267.934 150.68664,0 267.935,-117.51205 267.935,-267.934 z m -267.935,191.381 c -105.681,0 -191.381,-85.7 -191.381,-191.381 0,-105.681 85.701,-191.380996 191.381,-191.380996 105.681,0 191.381,85.700996 191.381,191.380996 0,105.681 -85.7,191.381 -191.381,191.381 z")),(Yt=B.append("rect").attr("class","zoomarea").attr("x",R.x).attr("y",R.y).attr("color",a.BHUE.REDDOT).attr("width",R.width).attr("height",R.height)).on("wheel.scroll");const o={shown:!1,timeout:null};if(Yt.on("wheel.scroll",function(){if(null!=o.timeout&&(clearTimeout(o.timeout),o.timeout=null),t.event.ctrlKey)return Ae("zoominfo",!0,G),void(o.shown=!1);o.shown||(De(["Use ctrl+scroll to zoom"],-1,"normal",{x:0,y:0,w:R.width,h:R.height},"zoominfo",!1,!0,G),o.shown=!0),o.timeout=setTimeout(()=>{Ae("zoominfo",!0),o.shown=!1},1e3)},{passive:!1}),Yt.on("mousedown.move",function(){null!=o.timeout&&(clearTimeout(o.timeout),o.timeout=null),Ae("zoominfo",!0),o.shown=!1}),Kt=t.zoom().extent([[0,0],[R.width,R.height]]).scaleExtent([1,1/0]).translateExtent([[0,0],[R.width,R.height]]).filter(function(){return"wheel"!=t.event.type||t.event.ctrlKey}).on("zoom",ma),Yt.call(Kt),k()){let e,a=null;const r=Yt.on("touchstart.zoom"),n=Yt.on("touchmove.zoom"),l=Yt.on("touchend.zoom");Yt.on("touchstart.zoom",function(){const n=this.getBoundingClientRect();e=t.event.touches.item(0).pageX-n.left;const l=V.invert(e);null==a&&1==t.event.touches.length&&(a=window.setTimeout(()=>{null!=l&&Ua(l/x)},1e3)),r.apply(this,arguments)}).on("touchmove.zoom",function(){window.clearTimeout(a),a=null,n.apply(this,arguments)}).on("touchend.zoom",function(){clearTimeout(a),a=null,l.apply(this,arguments)})}function i(){const e=t.mouse(B.node());Ua(V.invert(e[0]-D.left)/x)}z.roadEditor?(Yt.on("click",function(){t.event.shiftKey?i():ar()}),Yt.on("dblclick.zoom",i)):Yt.on("dblclick.zoom",null),C=B.append("g").attr("class","focus").attr("transform","translate("+z.focusRect.x+","+z.focusRect.y+")"),S=C.append("g").attr("clip-path","url(#buttonareaclip"+T+")").attr("class","buttonarea"),N=C.append("g").attr("class","focusclip").attr("clip-path","url(#plotclip"+T+")").attr("transform","translate("+D.left+","+D.top+")"),G=N.append("g").attr("class","plot"),U=C.append("svg:text").attr("x",Qt/2).attr("y",15).attr("width",R.width).attr("class","svgtxt").style("font-size","80%").attr("text-anchor","middle"),ot=G.append("g").attr("id","pastboxgrp"),it=G.append("g").attr("id","ybhpgrp"),Ct=G.append("g").attr("id","wmarkgrp"),gt=G.append("g").attr("id","guidegrp"),yt=G.append("g").attr("id","maxfluxgrp"),mt=G.append("g").attr("id","stdfluxgrp"),st=G.append("g").attr("id","ybhplinesgrp"),xt=G.append("g").attr("id","razrgrp"),Rt=G.append("g").attr("id","auragrp"),dt=G.append("g").attr("id","pinkgrp"),vt=G.append("g").attr("id","oldbullseyegrp"),Lt=G.append("g").attr("id","bullseyegrp"),ht=G.append("g").attr("id","grid"),pt=G.append("g").attr("id","oresetgrp"),bt=G.append("g").attr("id","knotgrp"),wt=G.append("g").attr("id","steppygrp"),Et=G.append("g").attr("id","rosygrp"),zt=G.append("g").attr("id","rosyptsgrp"),Mt=G.append("g").attr("id","derailsgrp"),Dt=G.append("g").attr("id","allptsgrp"),Tt=G.append("g").attr("id","movingavgrp"),kt=G.append("g").attr("id","steppyptsgrp"),At=G.append("g").attr("id","datapointgrp"),Pt=G.append("g").attr("id","hollowgrp"),Bt=G.append("g").attr("id","flatlinegrp"),Nt=G.append("g").attr("id","hashtaggrp"),St=G.append("g").attr("id","roadgrp"),Ut=G.append("g").attr("id","dotgrp"),Gt=G.append("g").attr("id","horgrp"),Ht=G.append("g").attr("id","hortxtgrp"),ft=G.append("g").attr("id","pasttxtgrp"),(Ot=G.append("g").attr("visibility","hidden")).append("rect").attr("x",0).attr("y",0).attr("stroke-width",20).attr("stroke","url(#tapepat"+T+")").attr("fill","none"),Ot.append("text").attr("y",45).attr("paint-order","stroke").attr("stroke-width","2px").attr("stroke","#a00000").attr("font-size","35px").attr("text-anchor","middle").attr("fill","#ff0000").text("Error"),Vt=N.append("svg:use").attr("class","zoomin").attr("xlink:href","#zoominbtn").attr("opacity",z.zoomButton.opacity).attr("transform",P.botin).on("click",()=>{Yt.call(Kt.scaleBy,z.zoomButton.factor)}).on("mouseover",()=>{he||t.select(this).style("fill","red")}).on("mouseout",(e,a)=>{t.select(this).style("fill","black")}),It=N.append("svg:use").attr("class","zoomout").attr("xlink:href","#zoomoutbtn").attr("opacity",z.zoomButton.opacity).attr("transform",P.botout).on("click",()=>{Yt.call(Kt.scaleBy,1/z.zoomButton.factor)}).on("mouseover",()=>{he||t.select(this).style("fill","red")}).on("mouseout",(e,a)=>{t.select(this).style("fill","black")}),K=t.scaleUtc().range([0,R.width]),I=t.axisBottom(K).ticks(6),Z=C.append("g").attr("class","axis").attr("transform","translate("+R.x+","+(D.top+R.height)+")").call(I),F=t.axisTop(K).ticks(6).tickFormat(""),J=ht.append("g").attr("class","grid").attr("transform","translate(0,"+R.height+")").call(F),j=t.axisTop(K).ticks(6),q=C.append("g").attr("class","axis").attr("transform","translate("+R.x+","+D.top+")").call(j),z.roadEditor&&(J.attr("display","none"),q.attr("display","none")),W=t.scaleLinear().range([R.height,0]),X=t.axisLeft(W).ticks(8).tickSize(6).tickSizeOuter(0),$=t.axisRight(W).ticks(8).tickSize(6).tickSizeOuter(0),Q=C.append("g").attr("class","axis").attr("transform","translate("+D.left+","+D.top+")").call(X),tt=C.append("g").attr("class","axis").attr("transform","translate("+(D.left+R.width)+","+D.top+")").call($),et=C.append("text").attr("class","axislabel").attr("transform","translate(15,"+(R.height/2+D.top)+") rotate(-90)").text(""),H=B.append("g").attr("class","brush").attr("transform","translate("+z.ctxRect.x+","+z.ctxRect.y+")"),O=H.append("g").attr("clip-path","url(#brushclip"+T+")").attr("transform","translate("+A.left+","+A.top+")"),Y=O.append("g").attr("class","context"),at=t.scaleUtc().range([0,M.width]),rt=t.axisBottom(at).ticks(6),nt=H.append("g").attr("class","axis").attr("transform","translate("+M.x+","+(A.top+M.height)+")").call(rt),lt=t.scaleLinear().range([M.height,0]),jt=t.brushX().extent([[0,0],[M.width,M.height]]).on("brush",xa),Ft=Y.append("g").attr("class","brush").call(jt),Zt=O.append("rect").attr("class","focusrect").attr("x",1).attr("y",1).attr("width",M.width-2).attr("height",M.height-2).attr("fill","none").style("stroke","black").style("stroke-width",1).style("stroke-dasharray","8,4,2,4"),V=K,_=W}(),function(){const e=z.divTable;if(null===e)return;for(;e.firstChild;)e.removeChild(e.firstChild);const a=t.select(e),r=(a.append("div").attr("class","rtbstart"),a.append("div").attr("class","rtbmain"));a.append("div").attr("class","rtbgoal"),0!=z.tableHeight&&r.style("max-height",z.tableHeight+"px").style("overflow-y","auto");const n=r.append("div").attr("class","rtable");n.append("div").attr("id","dpfloat").attr("class","floating"),qt=n.append("div").attr("id","topleft").style("position","absolute").style("left",0).style("top",0).style("width","1px").style("height","1px").attr("visibility","hidden"),z.reverseTable?(rn(),$r(),tn()):(tn(),$r(),rn())}(),function(){const e=z.divDueby;if(null===e)return;for(;e.firstChild;)e.removeChild(e.firstChild);const a=t.select(e);let r;r=["DAY","DELTA","TOTAL"],(ea=a.append("div").attr("class","dbbody")).append("div").attr("class","dbhdrrow").selectAll("span.dbhdrcell").data(r).enter().append("span").attr("class","dbhdrcell").text(t=>t),ea.selectAll(".dbrow").data([1,2,3,4,5,6,7]).join(t=>t.append("div").attr("class","dbrow"))}(),function(){const e=z.divData;if(null===e)return;for(;e.firstChild;)e.removeChild(e.firstChild);const a=t.select(e);let r;a.append("div").attr("id","dpfloat").attr("class","floating"),Jt=a.append("div").attr("id","datatopleft").style("position","absolute").style("left",0).style("top",0).style("width","1px").style("height","1px").attr("visibility","hidden"),a.attr("class","bmndrdata"),a.on("wheel.scroll",Oe,{passive:!1}),Be=a.append("div").attr("class","dbody"),Se=Array(Math.min(ve.length,z.dataTableSize)).fill().map((t,e)=>e+Ce),r=["#","DATE","VALUE","COMMENT","",""],Be.append("div").attr("class","dhdrrow").selectAll("span.dhdrcell").data(r).enter().append("span").attr("class",(t,e)=>"dhdrcell "+Ye[e]).style("text-align",(t,e)=>0==e?"right":null).text(t=>t),Be.selectAll(".drow").data(Se).join(t=>t.append("div").attr("class","drow")),Le=a.append("input").attr("type","range").attr("class","dslider").attr("min",0).attr("max",15).attr("value",7).attr("step",1).on("input",function(){He(this.value)}).on("change",function(){He(this.value)})}(),this.id=1,this.showData=(t=>(arguments.length>0&&(z.showData=t),0!=be.length&&(_r(),Wr(),qr(),Jr(),Xr(),mr()),z.showData)),this.showContext=(t=>(arguments.length>0&&(z.showContext=t),0!=me.length&&Mn(),z.showContext)),this.keepSlopes=(t=>(arguments.length>0&&(z.keepSlopes=t),z.keepSlopes)),this.keepIntervals=(t=>(arguments.length>0&&(z.keepIntervals=t),z.keepIntervals)),this.maxDataDays=(t=>(arguments.length>0&&(z.maxDataDays=t,z.maxDataDays<0?(_t=be.slice(),Wt=xe.slice()):(_t=be.filter(t=>t[0]>ye.asof-z.maxDataDays*h),Wt=xe.filter(t=>t[0]>ye.asof-z.maxDataDays*h)),0!=be.length&&(_r(),Wr(),qr(),Jr())),z.maxDataDays)),this.reverseTable=(e=>(arguments.length>0&&(z.reverseTable=e,z.reverseTable?(t.select(z.divTable).select(".rtbgoal").raise(),t.select(z.divTable).select(".rtbmain").raise(),t.select(z.divTable).select(".rtbstart").raise()):(t.select(z.divTable).select(".rtbstart").raise(),t.select(z.divTable).select(".rtbmain").raise(),t.select(z.divTable).select(".rtbgoal").raise()),Rn()),z.reverseTable)),this.tableUpdateOnDrag=(t=>(arguments.length>0&&(z.tableUpdateOnDrag=t,Rn()),z.tableUpdateOnDrag)),this.tableAutoScroll=(t=>(arguments.length>0&&(z.tableAutoScroll=t),z.tableAutoScroll)),this.undoBufferState=(()=>({undo:ie.length,redo:se.length})),this.undo=(()=>{z.roadEditor&&(document.activeElement.blur(),0!=ie.length&&(0!=ie.length&&r.sameRoads(ie[ie.length-1],me)||se.push(me),me=ie.pop(),Xt.setRoadObj(me),ra()))}),this.undoAll=(()=>{z.roadEditor&&(me=ie.shift(),wa(),Xt.setRoadObj(me),ra())}),this.redo=(()=>{z.roadEditor&&(document.activeElement.blur(),0!=se.length&&(ka(!0),me=se.pop(),ra()))}),this.clearUndo=wa,this.zoomAll=(()=>{0!=me.length&&ba()}),this.zoomDefault=(()=>{0!=me.length&&va()}),this.loadGoal=(async t=>{await async function(t,e=null){if(""==t||ce)return;ce=!0,z.headless||De(["loading..."],te/10);const r=await a.loadJSON(t);if(null!=r){if(z.headless||Ae(),"errstring"in r)throw new Error("loadGoalFromURL: BB file has errors: "+r.errstring);Sa(r)}else De(null!=oe?[w[oe]]:["Could not load goal file."]),z.headless||setTimeout(Ae,1500),"function"==typeof z.onError&&z.onError.call();ce=!1}(t).catch(function(t){console.log(t.stack)})}),this.loadGoalJSON=((t,e=!0)=>{Ae(),Sa(t,e)}),this.retroRatchet=(t=>{z.roadEditor&&function(t){if(0==me.length)return void console.log("bgraph("+T+"):setSafeDays(), road is empty!");let e=r.dtd(me,ye,ye.tcur,ye.vcur);const a=ye.asof;t<0&&(t=0);const n=e-(t-1)-1;if(n<=0)return;const l=ye.asof+n*h,o=r.rdf(me,l);let i,s=-1;for(i=1;i<me.length;i++)if(me[i].sta[0]===a){s=i-1;break}let d,c=!1;s<0&&(Ua(a),c=!0),i+1<me.length&&me[i+1].sta[0]===a?d=i:(d=Ua(a,o),c&&(ie.pop(),c=!0)),ra()}(t)}),this.scheduleBreak=((t,e,n)=>{if(z.roadEditor&&!isNaN(e))if(0!=me.length){var l,o,i=a.dayparse(t,"-"),s=-1;for(l=1;l<me.length;l++)if(me[l].sta[0]===i){s=l;break}var d=!1;for(s<0&&(Ua(i),d=!0),d||ka(),l=1;l<me.length;l++)if(me[l].sta[0]===i){s=l;break}if(n){for(me[s].end[0]=a.daysnap(me[s].end[0]+e*h),o=s+1;o<me.length;o++)me[o].sta[0]=a.daysnap(me[o].sta[0]+e*h),me[o].end[0]=a.daysnap(me[o].end[0]+e*h);if(me[s].sta[1]!=me[s].end[1]){var c={};c.sta=me[s].sta.slice(),c.sta[0]=a.daysnap(c.sta[0]+e*h),c.end=me[s].end.slice(),c.slope=r.segSlope(c),c.auto=r.RP.VALUE,me.splice(s+1,0,c),me[s].end=c.sta.slice(),me[s].slope=0,r.fixRoadArray(me,r.RP.VALUE,!1)}}else{var u=a.daysnap(me[s].sta[0]+e*h),p=r.findSeg(me,u);for(me[p].sta[0]!=u&&(Ua(u),d&&(ie.pop(),d=!0),p=r.findSeg(me,u)),o=s+1;o<p;o++)me.splice(s+1,1);me[s].end=me[s+1].sta.slice();var f=me[s+1].sta[1]-me[s].sta[1];for(o=s;o<me.length;o++)me[o].end[1]-=f,me[o].slope=r.segSlope(me[o]),o+1<me.length&&(me[o+1].sta[1]=me[o].end[1]);r.fixRoadArray(me,r.RP.SLOPE,!1)}ra()}else console.log("bgraph("+T+"):scheduleBreak(), road is empty!")}),this.commitTo=(t=>{if(z.roadEditor&&!isNaN(t))if(0!=me.length){if(me[me.length-2].slope!=t){var e=r.findSeg(me,ye.horizon);me[e].sta[0]==ye.horizon||e<me.length-2?ka():Ua(ye.horizon),me[me.length-2].slope=t,r.fixRoadArray(me,r.RP.VALUE,!1),ra()}}else console.log("bgraph("+T+"):commitTo(), road is empty!")}),this.getRoad=(()=>{var t,a,n={};if(0==me.length)return console.log("bgraph("+T+"):getRoad(), road is empty!"),null;n.valid=Ea(me),n.loser=r.redyest(me,ye,ye.tcur),n.asof=ye.asof,n.horizon=ye.horizon,n.siru=ye.siru,n.road=[];for(let l=0;l<me.length-1;l++)(t=me[l]).sta[0]==t.end[0]&&t.sta[1]==t.end[1]||(a=[e.unix(t.end[0]).utc().format("YYYYMMDD"),t.end[1],t.slope*ye.siru],t.auto==r.RP.DATE&&(a[2]=null),t.auto==r.RP.VALUE&&(a[1]=null),t.auto==r.RP.SLOPE&&(a[2]=null),n.road.push(a));return n}),this.saveGraph=((e=null)=>{const a=B.node();let r=(new XMLSerializer).serializeToString(a);if(z.headless||null==e){if(document.head.remove(),document.body.innerHTML=r,z.headless){var n=t.select(document.body);n.selectAll(".buttonarea").remove(),n.selectAll(".brush").remove(),n.selectAll(".zoomin").remove(),n.selectAll(".zoomout").remove()}}else{r.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)||(r=r.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')),r.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)||(r=r.replace(/^<svg/,'<svg xmlns:xlink="http://www.w3.org/1999/xlink"')),r='<?xml version="1.0" standalone="no"?>\n'+r;var l="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(r);e.href=l}}),this.hide=(()=>{ue=!0}),this.show=(()=>{ue=!1,0!=me.length?(ua(),pa(),ha(),ga(),Rn(),Mn(),Dn(!0)):console.log("bgraph("+T+"):show(), road is empty!")}),this.loading=(t=>{t?De(["loading..."],te/10):Ae()}),this.getRoadObj=(()=>r.copyRoad(me)),this.getGoalObj=(()=>ye);var An=!1;this.setRoadObj=((t,e=!1)=>{An||(0!=t.length?(An=!0,ka(),me=r.copyRoad(t),e&&(fe=r.copyRoad(t),wa()),Xt.setRoadObj(t),ra(),An=!1):console.log("bgraph("+T+"):setRoadObj(), new road is empty!"))}),this.isLoser=(()=>!(!ye||0==me.length)&&r.redyest(me,ye,ye.tcur)),this.getProgress=(()=>[[a.dayify(ye.tini,"-"),ye.vini],[a.dayify(ye.tcur,"-"),ye.vcur],[a.dayify(ye.tfin,"-"),ye.vfin]]),this.curState=(()=>ye?[ye.tcur,ye.vcur,ye.rcur,r.rdf(me,ye.tcur)]:null);const Pn=["plotall","steppy","rosy","movingav","aura","hidey","stathead","hashtags"];this.getVisualConfig=(()=>{var t={};return Pn.map(e=>{t[e]=ye[e]}),t}),this.xlinkLoaded=(()=>le);const Bn=["yaw","dir","kyoom","odom","monotone","aggday"];this.getGoalConfig=(()=>{let t={};return Bn.map(e=>{t[e]=ye[e]}),t}),this.msg=(t=>{t?De([t],20,null,{x:Qt/20,y:10,w:18*Qt/20,h:50},"message",!1,!0,B):Ae("message")}),this.animHor=function(t){if(z.roadEditor)return;const e=z.horizon,a=Gt.select(".horizon"),r=Ht.select(".horizontext"),n=[["stroke-width",Te(e.width*re*3)+"px",Te(e.width*re)+"px"]],l=[["stroke-dasharray",1.3*e.dash+","+.7*e.dash,e.dash+","+e.dash]],o=[["font-size",1.2*e.font+"px",e.font+"px"]];t?(hr(a,500,n,l,"hor"),hr(r,500,[],o,"hort")):(pr(a,300,n,l,"hor"),pr(r,300,[],o,"hort"))},this.animYBR=function(t){if(z.roadEditor)return;let e=[["fill-opacity",1,.5],["fill","#ffff00",a.BHUE.DYEL]];const r=xt.select(".razr");e=[["stroke-width",Te(z.oldRoadLine.width*re*2)+"px",Te(z.oldRoadLine.width*re)+"px"]],t?hr(r,500,[],e,"ybrc"):pr(r,300,[],e,"ybrc")},this.animData=function(t){if(!z.roadEditor){var e=At.selectAll(".dp"),a=[["r",Te(z.dataPoint.size*re*2)+"px",Te(z.dataPoint.size*re)+"px"]];t?hr(e,500,[],a,"data"):pr(e,300,[],a,"data"),e=Dt.selectAll(".ap"),a=[["r",Te(.7*z.dataPoint.size*re*2)+"px",Te(.7*z.dataPoint.size*re)+"px"]],t?hr(e,500,[],a,"dataa"):pr(e,300,[],a,"dataa")}},this.animGuides=function(t){if(z.roadEditor)return;const e=gt.selectAll(".guides"),r=[["stroke-width",Te(z.guidelines.width*re*2)+"px",t=>t<0?Te(z.guidelines.weekwidth*re)+"px":Te(z.guidelines.width*re)+"px"],["stroke",t=>t<0?a.BHUE.BIGG:"#ffff00",t=>t<0?a.BHUE.BIGG:a.BHUE.LYEL]];t?hr(e,500,[],r,"guides"):pr(e,300,[],r,"guides")},this.animRosy=function(t){if(z.roadEditor)return;const e=Et.selectAll(".rosy"),a=zt.selectAll(".rd"),r=[["stroke-width",Te(6*re)+"px",Te(4*re)+"px"]],n=[["r",Te(z.dataPoint.size*re*2)+"px",Te(z.dataPoint.size*re)+"px"]];t?(hr(e,500,[],r,"rosy"),hr(a,500,[],n,"rd")):(pr(e,300,[],r,"rosy"),pr(a,300,[],n,"rd"))},this.animMav=function(t){if(z.roadEditor)return;const e=Tt.selectAll(".movingav");let a=[["stroke-width",Te(6*re)+"px",Te(3*re)+"px"]];t?hr(e,500,a,[],"mav"):pr(e,300,a,[],"mav")},this.animYBHPlines=function(t){if(z.roadEditor)return;const e=st.selectAll("#r11, #r22, #r66"),a=[["stroke-width",Te(4*re)+"px",Te(1.5*re)+"px"]];t?hr(e,500,a,[],"ybl"):pr(e,300,a,[],"ybl")},this.animAura=function(t){if(z.roadEditor)return;const e=Rt.selectAll(".aura"),r=Rt.selectAll(".aurapast"),n=[["stroke","#9e559e",a.BHUE.LPURP],["fill","#9e559e",a.BHUE.LPURP]],l=[["stroke","#9e559e",a.BHUE.LPURP],["fill","#9e559e",a.BHUE.LPURP]],o=[["transform","translate(0,5)","translate(0,0)"]],i=[["transform","translate(0,5)","translate(0,0)"]];t?(hr(e,500,o,n,"aura"),hr(r,500,i,l,"aurap")):(pr(e,300,o,n,"aura"),pr(r,300,i,l,"aurap"))},this.animBuf=function(t){if(z.roadEditor)return;const e=Ct.selectAll(".waterbuf"),a=Number(e.attr("x")),r=Number(e.attr("y"));if("text"==e.node().tagName){let a=e.style("font-size"),n=[["font-size",1.3*(a=Number(a.substring(0,a.length-2)))+"px",a+"px"],["fill","#606060",z.watermark.color]],l=[["y",r+.1*a/3,r]];t?hr(e,500,l,n,"buf"):pr(e,300,l,n,"buf")}else{let n=z.watermark.height,l=[["width",1.3*n,n],["height",1.3*n,n],["x",a-.15*n,a],["y",r-.15*n,r]];t?hr(e,500,l,[],"buf"):pr(e,300,l,[],"buf")}},this.animBux=function(t){if(z.roadEditor)return;const e=Ct.selectAll(".waterbux");let a=e.style("font-size");a=Number(a.substring(0,a.length-2));const r=Number(e.attr("y")),n=[["font-size",1.3*a+"px",a+"px"],["fill","#606060",z.watermark.color]],l=[["y",r+.15*a,r]];t?hr(e,500,l,n,"bux"):pr(e,300,l,n,"bux")}}});
!function(a,n){"use strict";"function"==typeof define&&define.amd?define(["moment","butil","broad","beebrain","bgraph"],n):"object"==typeof module&&module.exports?module.exports=n(require("./moment"),require("./butil"),require("./broad"),require("./beebrain"),require("./bgraph")):a.bsandbox=n(a.moment,a.butil,a.broad,a.beebrain,a.bgraph)}(this,function(a,n,o,i,e){"use strict";const r=365.25,t=86400;var s=1;return function(o,i=!0){var e=i&&"undefined"!=typeof console?console:{info:function(){},warn:function(){},debug:function(){},error:function(){},log:function(){}};e.debug("beebrain constructor ("+s+"): ");var d=n.extendo({},o),l=s;s++,n.extendo(d,{roadEditor:!1,maxFutureDays:365,showFocusRect:!1,showContext:!1});var u={div:d.divGraph},b=[5,10,30,90,270,810,2430];function f(){return{yaw:1,dir:1,kyoom:!0,odom:!1,movingav:!1,steppy:!0,rosy:!1,aura:!1,aggday:"sum",monotone:!0}}function m(){return{dir:-1,yaw:-1,kyoom:!1,odom:!1,movingav:!1,steppy:!0,rosy:!1,aura:!1,aggday:"min",plotall:!1,monotone:!1}}u.graph=new bgraph(d);const p={hustler:f,fatloser:function(){return{yaw:-1,dir:-1,kyoom:!1,odom:!1,movingav:!0,steppy:!1,rosy:!0,aura:!1,aggday:"min",plotall:!1,monotone:!1}},biker:function(){return{yaw:1,dir:1,kyoom:!1,odom:!0,movingav:!1,steppy:!0,rosy:!1,aura:!1,aggday:"last",monotone:!0}},drinker:function(){return{yaw:-1,dir:1,kyoom:!0,odom:!1,movingav:!1,steppy:!0,rosy:!1,aura:!1,aggday:"sum",monotone:!0}},gainer:function(){return{yaw:1,dir:1,kyoom:!1,odom:!1,movingav:!0,steppy:!1,rosy:!0,aura:!1,aggday:"max",plotall:!1,monotone:!1}},inboxer:m,netcalorie:m,custom:f};var y=[],g=[];function h(a=!0){if(0!=y.length){g.push(JSON.parse(JSON.stringify({bb:u.bb,derails:u.derails})));var n=y.pop();u.bb=n.bb,u.derails=n.derails,a&&x()}}function v(){y.push(JSON.parse(JSON.stringify({bb:u.bb,derails:u.derails})))}function c(){y=[]}function w(){let a=JSON.parse(JSON.stringify(u.bb));"magic_sandbox_username/magic_sandbox_goalname"===a.params.yoog&&(a.params.waterbux="$"+b[Math.min(b.length-1,u.derails.length)]),u.graph.loadGoalJSON(a,!1)}function x(a=!0){if(e.log("bsandbox.reloadGoal(): Regenerating graph ********"),w(),u.graph.isLoser()){a&&(e.log("bsandbox.reloadGoal(): Derailed! Rolling back..."),h(!1),w(),v()),e.log("bsandbox.reloadGoal(): Derailed! Rerailing...");let r=u.graph.curState();u.bb.params.road=u.bb.params.road.filter(a=>n.dayparse(a[0])<r[0]);let s=u.bb.params.road;var o=n.daysnap(r[0]+7*t),i=n.dayify(r[0]);s.push([i,null,r[2]]),s.push([i,Number(r[1]),null]),s.push([n.dayify(o),null,0]),u.bb.data.push([i,u.bb.params.kyoom?0:Number(r[1]),"RECOMMITTED at "+i]),u.derails.push(i),w()}e.log("bsandbox.reloadGoal(): Done **********************")}const G=["plotall","steppy","rosy","movingav","aura","hidey","stathead","hashtags"];const O=["yaw","dir","kyoom","odom","monotone","aggday"];this.id=l,this.newGoal=function(o,i,s,l,f,m=[]){if(e.log(`newGoal(${o}, ${i}, ${s}, ${l}, ${f})`),!p.hasOwnProperty(o))return void e.error("bsandbox.newGoal: Invalid goal type!");if(["d","w","m","y"].indexOf(i)<0)return void e.error("bsandbox.newGoal: Invalid rate units!");if(!n.nummy(s)||!n.nummy(l)||"boolean"!=typeof f)return void e.error("bsandbox.newGoal: Invalid goal parameters!");u.gtype=o,u.rfin=s,u.vini=l,u.runits=i,u.buffer=f;let y=p[o]();y.timezone=Intl.DateTimeFormat().resolvedOptions().timeZone,y.deadline=0,y.asof=n.dayify(a.tz(y.timezone)/1e3),n.nowstamp(y.timezone,y.deadline,n.dayparse(y.asof));const g=n.daysnap(a.now()/1e3+7*t),h=n.daysnap(a.now()/1e3+r*t);var v;for(y.stathead=!1,y.quantum=1,y.tfin=n.dayify(h),y.rfin=Number(s),y.runits=i,y.tini=y.asof,y.vini=Number(l),y.road=[[f?n.dayify(g):y.asof,null,0]],y.waterbux="$"+b[0],y.yoog="magic_sandbox_username/magic_sandbox_goalname",y.imgsz=696,y.yaxis=y.kyoom?"current cumulative total":"current value",Object.keys(m).forEach(a=>{y[a]=m[a]}),v=[[y.tini,Number(y.vini),"initial datapoint of "+y.vini]],u.bb={params:y,data:v},u.derails=[];u.div.firstChild;)u.div.removeChild(u.div.firstChild);u.gdiv=d3.select(u.div),u.graph=new bgraph(d),c(),x()},this.newGoal2=function(o,i,s={}){if(e.log(`newGoal2(${o}, ${i})`),!p.hasOwnProperty(o))return void e.error("bsandbox.newGoal2: Invalid goal type!");if(["d","w","m","y"].indexOf(s.runits)<0)return void e.error("bsandbox.newGoal2: Invalid rate units!");if(!n.nummy(i))return void e.error("bsandbox.newGoal2: Invalid initval!");if(!n.norn(s.rfin)||!n.norn(s.vfin)||null===s.rfin&&null===s.vfin)return void e.error("bsandbox.newGoal2: Invalid rfin or vfin!");if(!n.nummy(s.vini))return void e.error("bsandbox.newGoal2: Invalid vini!");u.gtype=o,u.rfin=s.rfin=null===s.rfin?null:Number(s.rfin),u.vfin=s.vfin=null===s.vfin?null:Number(s.vfin),u.vini=s.vini,u.runits=s.runits,u.initval=i,u.derails=[];let l=p[o]();l.timezone=Intl.DateTimeFormat().resolvedOptions().timeZone,l.deadline=0,l.asof=n.dayify(a.tz(l.timezone)/1e3),l.waterbux="$"+b[0],l.yaxis=l.kyoom?"current cumulative total":"current value",l.stathead=!1,l.quantum=1,n.nowstamp(l.timezone,l.deadline,n.dayparse(l.asof)),n.daysnap(a.now()/1e3+7*t);const f=n.daysnap(a.now()/1e3+r*t*1.5);l.tfin=n.dayify(f),l.tini=l.asof,l.vini=0;let m={...l,...s};var y;for(y=[[m.tini,Number(u.initval),"initial datapoint of "+u.initval]],u.bb={params:m,data:y};u.div.firstChild;)u.div.removeChild(u.div.firstChild);u.gdiv=d3.select(u.div),u.graph=new bgraph(d),c(),x()},this.loadGoalJSON=function(a,o=[]){for(e.log(`loadGoalJSON(${a})`),u.bb=n.deepcopy(a),u.derails=[];u.div.firstChild;)u.div.removeChild(u.div.firstChild);u.gdiv=d3.select(u.div),u.graph=new bgraph(d),c(),w()},this.nextDay=function(){v();var a=n.dayify(n.daysnap(n.dayparse(u.bb.params.asof)+t));u.bb.params.asof=a,x()},this.refresh=x,this.newData=function(a,o){n.nummy(a)&&n.stringy(o)&&(v(),u.bb.data.push([u.bb.params.asof,Number(a),""==o?`Added in sandbox (#${u.bb.data.length})`:o]),x())},this.newRate=function(a){if(n.nummy(a)){v();var o=n.dayparse(u.bb.params.asof),i=n.daysnap(o+6*t),e=u.bb.params.road;n.dayparse(e[e.length-1][0])<i&&e.push([n.dayify(i),null,u.bb.params.rfin]),u.bb.params.rfin=Number(a)*n.SECS[u.bb.params.runits],x()}},this.setVisualConfig=function(a){G.map(n=>{a.hasOwnProperty(n)&&"boolean"==typeof a[n]&&(u.bb.params[n]=a[n])}),x()},this.getVisualConfig=function(){return u.graph.getVisualConfig()},this.setGoalConfig=function(a){v(),O.map(n=>{a.hasOwnProperty(n)&&(u.bb.params[n]=a[n])}),x(!1)},this.getGoalConfig=function(){return u.graph.getGoalConfig()},this.getTypeFn=function(a){return p[a]()},this.undo=h,this.redo=function(a=!0){if(0!=g.length){v();var n=g.pop();u.bb=n.bb,u.derails=n.derails,a&&x()}},this.undoAll=((a=!0)=>{for(;0!=y.length;)h(a);g=[]}),this.saveBB=function(a){var n=JSON.stringify(u.bb),o="data:application/json;charset=utf-8,"+encodeURIComponent(n);a.href=o},this.show=(()=>u.graph.show()),this.hide=(()=>u.graph.hide()),this.getGraphObj=(()=>u.graph),this.undoBufferState=(()=>({undo:y.length,redo:g.length}))}});