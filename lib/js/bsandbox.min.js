!function(a,n){"use strict";"function"==typeof define&&define.amd?define(["moment","butil","broad","beebrain","bgraph"],n):"object"==typeof module&&module.exports?module.exports=n(require("./moment"),require("./butil"),require("./broad"),require("./beebrain"),require("./bgraph")):a.bsandbox=n(a.moment,a.butil,a.broad,a.beebrain,a.bgraph)}(this,function(a,n,o,i,e){"use strict";const r=365.25,t=86400;var s=1;return function(o,i=!0){var e=i&&"undefined"!=typeof console?console:{info:function(){},warn:function(){},debug:function(){},error:function(){},log:function(){}};e.debug("beebrain constructor ("+s+"): ");var d=n.extend({},o),l=s;s++,n.extend(d,{roadEditor:!1,maxFutureDays:365,showFocusRect:!1,showContext:!1});var u={div:d.divGraph},b=[5,10,30,90,270,810,2430];function f(){return{yaw:1,dir:1,kyoom:!0,odom:!1,movingav:!1,steppy:!0,rosy:!1,aura:!1,aggday:"sum",monotone:!0}}function m(){return{dir:-1,yaw:-1,kyoom:!1,odom:!1,movingav:!1,steppy:!0,rosy:!1,aura:!1,aggday:"min",plotall:!1,monotone:!1}}u.graph=new bgraph(d);const p={hustler:f,fatloser:function(){return{yaw:-1,dir:-1,kyoom:!1,odom:!1,movingav:!0,steppy:!1,rosy:!0,aura:!1,aggday:"min",plotall:!1,monotone:!1}},biker:function(){return{yaw:1,dir:1,kyoom:!1,odom:!0,movingav:!1,steppy:!0,rosy:!1,aura:!1,aggday:"last",monotone:!0}},drinker:function(){return{yaw:-1,dir:1,kyoom:!0,odom:!1,movingav:!1,steppy:!0,rosy:!1,aura:!1,aggday:"sum",monotone:!0}},gainer:function(){return{yaw:1,dir:1,kyoom:!1,odom:!1,movingav:!0,steppy:!1,rosy:!0,aura:!1,aggday:"max",plotall:!1,monotone:!1}},inboxer:m,netcalorie:m,custom:f};var y=[],g=[];function h(a=!0){if(0!=y.length){g.push(JSON.parse(JSON.stringify({bb:u.bb,derails:u.derails})));var n=y.pop();u.bb=n.bb,u.derails=n.derails,a&&x()}}function v(){y.push(JSON.parse(JSON.stringify({bb:u.bb,derails:u.derails})))}function c(){y=[]}function w(){let a=JSON.parse(JSON.stringify(u.bb));"magic_sandbox_username/magic_sandbox_goalname"===a.params.yoog&&(a.params.waterbux="$"+b[Math.min(b.length-1,u.derails.length)]),u.graph.loadGoalJSON(a,!1)}function x(a=!0){if(e.log("bsandbox.reloadGoal(): Regenerating graph ********"),w(),u.graph.isLoser()){a&&(e.log("bsandbox.reloadGoal(): Derailed! Rolling back..."),h(!1),w()),e.log("bsandbox.reloadGoal(): Derailed! Rerailing...");let r=u.graph.curState();u.bb.params.road=u.bb.params.road.filter(a=>n.dayparse(a[0])<r[0]);let s=u.bb.params.road;var o=n.daysnap(r[0]+7*t),i=n.dayify(r[0]);s.push([i,null,r[2]]),s.push([i,Number(r[1]),null]),s.push([n.dayify(o),null,0]),u.bb.data.push([i,u.bb.params.kyoom?0:Number(r[1]),"RECOMMITTED at "+i]),u.derails.push(i),w()}e.log("bsandbox.reloadGoal(): Done **********************")}const G=["plotall","steppy","rosy","movingav","aura","hidey","stathead","hashtags"];const O=["yaw","dir","kyoom","odom","monotone","aggday"];this.id=l,this.newGoal=function(o,i,s,l,f,m=[]){if(e.log(`newGoal(${o}, ${i}, ${s}, ${l}, ${f})`),!p.hasOwnProperty(o))return void e.error("bsandbox.newGoal: Invalid goal type!");if(["d","w","m","y"].indexOf(i)<0)return void e.error("bsandbox.newGoal: Invalid rate units!");if(!n.nummy(s)||!n.nummy(l)||!n.torf(f))return void e.error("bsandbox.newGoal: Invalid goal parameters!");u.gtype=o,u.rfin=s,u.vini=l,u.runits=i,u.buffer=f;let y=p[o]();y.timezone=Intl.DateTimeFormat().resolvedOptions().timeZone,y.deadline=0,y.asof=n.dayify(a.tz(y.timezone)/1e3),n.nowstamp(y.timezone,y.deadline,n.dayparse(y.asof));const g=n.daysnap(a.now()/1e3+7*t),h=n.daysnap(a.now()/1e3+r*t);var v;for(y.stathead=!1,y.quantum=1,y.tfin=n.dayify(h),y.rfin=Number(s),y.runits=i,y.tini=y.asof,y.vini=Number(l),y.road=[[f?n.dayify(g):y.asof,null,0]],y.waterbux="$"+b[0],y.yoog="magic_sandbox_username/magic_sandbox_goalname",y.imgsz=696,y.yaxis=y.kyoom?"current cumulative total":"current value",Object.keys(m).forEach(a=>{y[a]=m[a]}),v=[[y.tini,Number(y.vini),"initial datapoint of "+y.vini]],u.bb={params:y,data:v},u.derails=[];u.div.firstChild;)u.div.removeChild(u.div.firstChild);u.gdiv=d3.select(u.div),u.graph=new bgraph(d),c(),x()},this.newGoal2=function(o,i,s={}){if(e.log(`newGoal2(${o}, ${i})`),!p.hasOwnProperty(o))return void e.error("bsandbox.newGoal2: Invalid goal type!");if(["d","w","m","y"].indexOf(s.runits)<0)return void e.error("bsandbox.newGoal2: Invalid rate units!");if(!n.nummy(i))return void e.error("bsandbox.newGoal2: Invalid initval!");if(!n.norn(s.rfin)||!n.norn(s.vfin)||null===s.rfin&&null===s.vfin)return void e.error("bsandbox.newGoal2: Invalid rfin or vfin!");if(!n.nummy(s.vini))return void e.error("bsandbox.newGoal2: Invalid vini!");u.gtype=o,u.rfin=s.rfin=null===s.rfin?null:Number(s.rfin),u.vfin=s.vfin=null===s.vfin?null:Number(s.vfin),u.vini=s.vini,u.runits=s.runits,u.initval=i,u.derails=[];let l=p[o]();l.timezone=Intl.DateTimeFormat().resolvedOptions().timeZone,l.deadline=0,l.asof=n.dayify(a.tz(l.timezone)/1e3),l.waterbux="$"+b[0],l.yaxis=l.kyoom?"current cumulative total":"current value",l.stathead=!1,l.quantum=1,n.nowstamp(l.timezone,l.deadline,n.dayparse(l.asof)),n.daysnap(a.now()/1e3+7*t);const f=n.daysnap(a.now()/1e3+r*t*1.5);l.tfin=n.dayify(f),l.tini=l.asof,l.vini=0;let m={...l,...s};var y;for(y=[[m.tini,Number(u.initval),"initial datapoint of "+u.initval]],u.bb={params:m,data:y};u.div.firstChild;)u.div.removeChild(u.div.firstChild);u.gdiv=d3.select(u.div),u.graph=new bgraph(d),c(),x()},this.loadGoalJSON=function(a,o=[]){for(e.log(`loadGoalJSON(${a})`),u.bb=n.deepcopy(a),u.derails=[];u.div.firstChild;)u.div.removeChild(u.div.firstChild);u.gdiv=d3.select(u.div),u.graph=new bgraph(d),c(),w()},this.nextDay=function(){v();var a=n.dayify(n.daysnap(n.dayparse(u.bb.params.asof)+t));u.bb.params.asof=a,x()},this.refresh=x,this.newData=function(a,o){n.nummy(a)&&n.stringy(o)&&(v(),u.bb.data.push([u.bb.params.asof,Number(a),""==o?`Added in sandbox (#${u.bb.data.length})`:o]),x())},this.newRate=function(a){if(n.nummy(a)){v();var o=n.dayparse(u.bb.params.asof),i=n.daysnap(o+6*t),e=u.bb.params.road;n.dayparse(e[e.length-1][0])<i&&e.push([n.dayify(i),null,u.bb.params.rfin]),u.bb.params.rfin=Number(a),x()}},this.setVisualConfig=function(a){G.map(o=>{a.hasOwnProperty(o)&&n.torf(a[o])&&(u.bb.params[o]=a[o])}),x()},this.getVisualConfig=function(){return u.graph.getVisualConfig()},this.setGoalConfig=function(a){v(),O.map(n=>{a.hasOwnProperty(n)&&(u.bb.params[n]=a[n])}),x(!1)},this.getGoalConfig=function(){return u.graph.getGoalConfig()},this.getTypeFn=function(a){return p[a]()},this.undo=h,this.redo=function(a=!0){if(0!=g.length){v();var n=g.pop();u.bb=n.bb,u.derails=n.derails,a&&x()}},this.undoAll=((a=!0)=>{for(;0!=y.length;)h(a);g=[]}),this.saveBB=function(a){var n=JSON.stringify(u.bb),o="data:application/json;charset=utf-8,"+encodeURIComponent(n);a.href=o},this.show=(()=>u.graph.show()),this.hide=(()=>u.graph.hide()),this.getGraphObj=(()=>u.graph),this.undoBufferState=(()=>({undo:y.length,redo:g.length}))}});