!function(a,o){"use strict";"function"==typeof define&&define.amd?define(["moment","butil","broad","beebrain","bgraph"],o):"object"==typeof module&&module.exports?module.exports=o(require("./moment"),require("./butil"),require("./broad"),require("./beebrain"),require("./bgraph")):a.bsandbox=o(a.moment,a.butil,a.broad,a.beebrain,a.bgraph)}(this,function(a,o,n,r,e){"use strict";const i=365.25,t=86400;var s=1;return function(n,r=!0){var e=r&&"undefined"!=typeof console?console:{info:function(){},warn:function(){},debug:function(){},error:function(){},log:function(){}};e.debug("beebrain constructor ("+s+"): ");var d=o.extend({},n),u=s;s++,o.extend(d,{roadEditor:!1,maxFutureDays:365,showFocusRect:!1,showContext:!1});var l={div:d.divGraph},b=[0,5,10,30,90,270,810,2430];l.graph=new bgraph(d);const p={hustler:function(){return{yaw:1,dir:1,kyoom:!0,odom:!1,movingav:!1,steppy:!0,rosy:!1,aura:!1,aggday:"sum",monotone:!0}},fatloser:function(){return{yaw:-1,dir:-1,kyoom:!1,odom:!1,movingav:!0,steppy:!1,rosy:!0,aura:!0,aggday:"min",plotall:!1,monotone:!1}},biker:function(){return{yaw:1,dir:1,kyoom:!1,odom:!0,movingav:!1,steppy:!0,rosy:!1,aura:!1,aggday:"last",monotone:!0}},drinker:function(){return{yaw:-1,dir:1,kyoom:!0,odom:!1,movingav:!1,steppy:!0,rosy:!1,aura:!1,aggday:"sum",monotone:!0}},gainer:function(){return{yaw:1,dir:1,kyoom:!1,odom:!1,movingav:!0,steppy:!1,rosy:!0,aura:!0,aggday:"max",plotall:!1,monotone:!1}},inboxer:function(){return{dir:-1,yaw:-1,kyoom:!1,odom:!1,movingav:!1,steppy:!0,rosy:!1,aura:!1,aggday:"min",plotall:!1,monotone:!1}}};var f=[],m=[];function g(a=!0){if(0!=f.length){m.push(JSON.parse(JSON.stringify({bb:l.bb,derails:l.derails})));var o=f.pop();l.bb=o.bb,l.derails=o.derails,a&&v()}}function y(){f.push(JSON.parse(JSON.stringify({bb:l.bb,derails:l.derails})))}function h(){f=[]}function c(){let a=JSON.parse(JSON.stringify(l.bb));a.params.waterbux="$"+b[Math.min(b.length-1,l.derails.length)],l.graph.loadGoalJSON(a,!1)}function v(a=!0){if(e.log("bsandbox.reloadGoal(): Regenerating graph ********"),c(),l.graph.isLoser()){a&&(e.log("bsandbox.reloadGoal(): Derailed! Rolling back..."),g(!1),c()),e.log("bsandbox.reloadGoal(): Derailed! Rerailing...");let i=l.graph.curState();l.bb.params.road=l.bb.params.road.filter(a=>o.dayparse(a[0])<i[0]);let s=l.bb.params.road;var n=o.daysnap(i[0]+7*t),r=o.dayify(i[0]);s.push([r,null,i[2]]),s.push([r,Number(i[1]),null]),s.push([o.dayify(n),null,0]),l.bb.data.push([r,l.bb.params.kyoom?0:Number(i[1]),"RECOMMITTED at "+r]),l.derails.push(r),c()}e.log("bsandbox.reloadGoal(): Done **********************")}const w=["plotall","steppy","rosy","movingav","aura","hidey","stathead","hashtags"];const x=["yaw","dir","kyoom","odom","monotone","aggday"];this.id=u,this.newGoal=function(n,r,s,u,f,m=[]){if(e.log(`newGoal(${n}, ${r}, ${s}, ${u}, ${f})`),!p.hasOwnProperty(n))return void e.error("bsandbox.newGoal: Invalid goal type!");if(["d","w","m","y"].indexOf(r)<0)return void e.error("bsandbox.newGoal: Invalid rate units!");if(!o.nummy(s)||!o.nummy(u)||!o.torf(f))return void e.error("bsandbox.newGoal: Invalid goal parameters!");l.gtype=n,l.rfin=s,l.vini=u,l.runits=r,l.buffer=f;let g=p[n]();g.timezone=Intl.DateTimeFormat().resolvedOptions().timeZone,g.deadline=0,g.asof=o.dayify(a.tz(g.timezone)/1e3),o.nowstamp(g.timezone,g.deadline,o.dayparse(g.asof));const y=o.daysnap(a.now()/1e3+7*t),c=o.daysnap(a.now()/1e3+i*t);var w;for(g.stathead=!1,g.quantum=1,g.tfin=o.dayify(c),g.rfin=Number(s),g.runits=r,g.tini=g.asof,g.vini=Number(u),g.road=[[f?o.dayify(y):g.asof,null,0]],g.waterbux="$"+b[0],g.yoog="test/sandbox",g.imgsz=696,g.yaxis=g.kyoom?"current cumulative total":"current value",Object.keys(m).forEach(a=>{g[a]=m[a]}),w=[[g.tini,Number(g.vini),"initial datapoint of "+g.vini]],l.bb={params:g,data:w},l.derails=[];l.div.firstChild;)l.div.removeChild(l.div.firstChild);l.gdiv=d3.select(l.div),l.graph=new bgraph(d),h(),v()},this.loadGoalJSON=function(a,n=[]){for(e.log(`loadGoalJSON(${a})`),l.bb=o.deepcopy(a),l.derails=[];l.div.firstChild;)l.div.removeChild(l.div.firstChild);l.gdiv=d3.select(l.div),l.graph=new bgraph(d),h(),c()},this.nextDay=function(){y();var a=o.dayify(o.daysnap(o.dayparse(l.bb.params.asof)+t));l.bb.params.asof=a,v()},this.refresh=v,this.newData=function(a,n){o.nummy(a)&&o.stringy(n)&&(y(),l.bb.data.push([l.bb.params.asof,Number(a),""==n?`Added in sandbox (#${l.bb.data.length})`:n]),v())},this.newRate=function(a){if(o.nummy(a)){y();var n=o.dayparse(l.bb.params.asof),r=o.daysnap(n+7*t),e=l.bb.params.road;o.dayparse(e[e.length-1][0])<r&&e.push([o.dayify(r),null,l.bb.params.rfin]),l.bb.params.rfin=Number(a)*o.SECS[l.bb.params.runits],v()}},this.setVisualConfig=function(a){w.map(n=>{a.hasOwnProperty(n)&&o.torf(a[n])&&(l.bb.params[n]=a[n])}),v()},this.getVisualConfig=function(){return l.graph.getVisualConfig()},this.setGoalConfig=function(a){y(),x.map(o=>{a.hasOwnProperty(o)&&(l.bb.params[o]=a[o])}),v(!1)},this.getGoalConfig=function(){return l.graph.getGoalConfig()},this.undo=g,this.redo=function(a=!0){if(0!=m.length){y();var o=m.pop();l.bb=o.bb,l.derails=o.derails,a&&v()}},this.undoAll=((a=!0)=>{for(;0!=f.length;)g(a);m=[]}),this.saveBB=function(a){var o=JSON.stringify(l.bb),n="data:application/json;charset=utf-8,"+encodeURIComponent(o);a.href=n},this.show=function(){l.graph.show()},this.hide=function(){l.graph.hide()},this.getGraphObj=function(){return l.graph},this.undoBufferState=(()=>({undo:f.length,redo:m.length}))}});