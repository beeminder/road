!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["moment"],t):"object"==typeof module&&module.exports?module.exports=t(require("./moment")):e.butil=t(e.moment)}(this,function(e){"use strict";const t=Math.min,r=Math.max,n=Math.abs,l=Math.pow,o=Math.log10,i=Math.floor,u=Math.round,a=86400;var s={MAXTIME:6e4,BBURL:"http://brain.beeminder.com/",Cols:{DYEL:"#ffff44",LYEL:"#ffff88",ROSE:"#ff8080",AKRA:"#4C4Cff",PURP:"#B56bb5",LPURP:"#E5BbE5",BLUE:"#EAEAFF",GRUE:"#b5ffDE",ORNG:"#ff8000",WITE:"#ffffff",BIGG:"#ffe54c",PINK:"#ffe5e5",PNKE:"#ffcccc",GRAY:"#f0f0f0",BLCK:"#000000",REDDOT:"#ff0000",ORNDOT:"#ffa500",BLUDOT:"#3f3fff",GRNDOT:"#00aa00",GRADOT:"#228B22",ERRDOT:"#00FFFF",RAZR0:"#ff0000",RAZR1:"#ffa500",RAZR2:"#3f3fff",RAZR3:"#6BC461"}};s.AKH=7*a,s.BDUSK=2147317201,s.SECS={y:31557600,m:2629800,w:7*a,d:a,h:3600},s.UNAM={y:"year",m:"month",w:"week",d:"day",h:"hour"},s.arrMin=(e=>t.apply(null,e)),s.arrMax=(e=>r.apply(null,e)),s.isArray=Array.isArray,s.extend=((e,t,r)=>{let n,l;for(n in t)(l=void 0!==e[n])&&"object"==typeof t[n]&&null!==t[n]&&void 0===t[n].nodeName?s.isArray(t[n])?r&&(e[n]=t[n].slice(0)):e[n]=s.extend({},t[n],r):!r&&l||(s.isArray(t[n])?e[n]=t[n].slice(0):e[n]=t[n]);return e}),s.deepcopy=(e=>{let t,r,n;if("object"!=typeof e||null===e)return e;for(n in t=Array.isArray(e)?[]:{},e)r=e[n],t[n]=s.deepcopy(r);return t}),s.argmax=((e,t)=>{if(null===t)return null;let r=t.map(e),n=s.arrMax(r);return t[r.findIndex(e=>e===n)]}),s.partition=((e,t,r)=>{let n=e.length,l=[];for(let o=0;o<n;o+=r)o+t<=n&&l.push(e.slice(o,o+t));return l}),s.modf=(e=>{let t=e<0?-e:e,r=i(t);return e<0?[-(t-r),-r]:[t-r,r]}),s.quantile=((e,t,r=1,n=!1)=>{let l;if(l=n?e:e.slice().sort((e,t)=>e-t),r<1||r>9)return null;let o=[[0,0,1,0],[.5,0,1,0],[.5,0,0,0],[0,0,0,1],[.5,0,0,1],[0,1,0,1],[1,-1,0,1],[1/3,1/3,0,1],[3/8,.25,0,1]],u=o[r-1][0],a=o[r-1][1],f=o[r-1][2],c=o[r-1][3],d=e.length,m=s.modf(u+(d+a)*t-1),h=m[0],p=m[1];return p<0?l[0]:p>=d?l[d-1]:(p=i(p),0==h?l[p]:l[p]+(l[p+1]-l[p])*(f+c*h))}),s.sum=(e=>e.reduce((e,t)=>e+t,0)),s.foldlist=((e,t,r)=>{let n=[t];for(let t=0;t<r.length;t++)n.push(e(n[t],r[t]));return n}),s.accumulate=(e=>{let t=e.length;if(0===t)return e;let r=[e[0]];for(let n=1;n<t;n++)r.push(r[r.length-1]+e[n]);return r}),s.monotonize=((e,n=1)=>{let l,o=e.slice();if(1===n)for(l=1;l<o.length;l++)o[l]=r(o[l-1],o[l]);else for(l=1;l<o.length;l++)o[l]=t(o[l-1],o[l]);return o}),s.zip=(e=>e[0].map((t,r)=>e.map(e=>e[r]))),s.chop=((e,t=1e-7)=>n(e)<t?0:e),s.ichop=((e,t=1e-7)=>{let r=e%1,n=e-r;return r<0&&(r+=1,n-=1),r>.5&&(r=1-s.chop(1-r)),i(n)+s.chop(r,t)}),s.clip=((e,t,r)=>(t>r&&([t,r]=[r,t]),e<t?t:e>r?r:e)),s.searchLow=((e,t)=>{if(!e||!e.length)return-1;let r,n=-1,l=e.length;for(;l-n>1;)t(e[r=i((n+l)/2)])<0?n=r:l=r;return l===e.length||0!==t(e[l])?n:l}),s.searchHigh=((e,t)=>{if(!e||!e.length)return 0;let r,n=-1,l=e.length;for(;l-n>1;)t(e[r=i((n+l)/2)])<=0?n=r:l=r;return-1===n||0!==t(e[n])?l:n}),s.shn=((e,t=10,r=5,a=0)=>{if(isNaN(e))return e.toString();e=s.chop(e);let f,c,d=i(n(e));d=0===d?0:d.toString().length,n(e)>l(10,d)-.5&&(d+=1),f=0===d&&0!==e?i(r-o(n(e))):r;let m=e*l(10,f),h=m%10;h<0&&(h+=10),h>=4.5&&h<4.9999999&&(m=i(m));let p=u(m)/l(10,f)+1e-10;if(a<0&&p>e||a>0&&p<e){if(!(r>=10))return s.shn(e,t,r+1,a);p=e}return t<d&&n(l(10,d-1)-p)<.5&&(p=l(10,d-1)),t=s.clip(t,d,d+r),n(p)<1e-4||9===i(p)||99===i(p)||999===i(p)?c=parseFloat(e.toPrecision(f)).toString():(c=p.toPrecision(t)).includes("e")||(c=parseFloat(c)),c}),s.shd=(e=>null===e?"null":s.formatDate(e)),s.shdt=(e=>null===e?"null":s.formatDateTime(e)),s.splur=((e,t,r="")=>(""===r&&(r=t+"s"),s.shn(e,10,5)+" "+(1===e?t:r))),s.normberlize=(e=>{const t=(e="string"==typeof e?e.trim():e.toString()).charAt(0),r=e.substr(1);if("+"===t&&(e=r),"-"===t)return"-"+s.normberlize(r);e=e.replace(/^0+([^eE])/,"$1");if(/^(?:\d+\.?\d*|\.\d+)$/.test(e))return e;const n=e.match(/^(\d+\.?\d*|\.\d+)e([+-]?\d+)$/i);if(!n||3!==n.length)return"NaN";let[,l,o]=n,i=l.indexOf(".");return-1===i&&(i=l.length),i+=+o,l=l.replace(/\./,""),i<0?"."+"0".repeat(-i)+l:(i>l.length?l+="0".repeat(i-l.length):l=l.substring(0,i)+"."+l.substring(i),l.replace(/\.$/,"").replace(/^0+(.)/,"$1"))}),s.quantize=(e=>{let t=s.normberlize(e);return/^-?\d+\.?$/.test(t)?1:+(t=(t=(t=t.replace(/^-?\d*\./,".")).replace(/\d/g,"0")).replace(/0$/,"1"))}),s.round=((e,t=1)=>{if(t<0)return NaN;if(0===t)return+e;const r=u(e/t),n=t.toString().match(/^0?\.(0*)1$/);if(!n)return r*t;const l=-n[1].length-1;return+s.normberlize(`${r}e${l}`)}),s.conservaround=((e,t=1,r=0)=>{let n=s.round(e,t);return 0===r?n:(r<0&&n>e&&(n-=t),r>0&&n<e&&(n+=t),s.round(n,t))}),s.linspace=((e,t,n)=>{if(void 0===n&&(n=r(u(t-e)+1,1)),n<2)return 1===n?[e]:[];let l,o=Array(n);for(l=--n;l>=0;l--)o[l]=(l*t+(n-l)*e)/n;return o}),s.rescale=((e,t,r,l,o)=>n(t-r)<1e-7?e<=(t+r)/2?l:o:l+(e-t)/(r-t)*(o-l)),s.deldups=((e,t=(e=>e))=>{let r={};return e.filter(e=>{const n=JSON.stringify(t(e));return!(n in r)&&(r[n]=!0)})}),s.orderedq=(e=>{for(let t=0;t<e.length-1;t++)if(e[t]>e[t+1])return!1;return!0}),s.nonzero=(e=>{let t,r=e.length;for(t=0;t<r;t++)if(0!==e[t])return!0;return!1}),s.clocky=(e=>{let t=0;for(let r=1;r<e.length;r+=2)t+=e[r]-e[r-1];return t}),s.mean=(e=>{let t,r=0,n=e.length;if(0==n)return 0;for(t=0;t<n;t++)r+=e[t];return r/e.length}),s.median=(e=>{let t=0,r=e.length;return e.sort((e,t)=>e-t),t=r%2==0?(e[r/2-1]+e[r/2])/2:e[(r-1)/2]}),s.mode=(e=>{if(!e||!e.length)return NaN;let t={},r=1,n=e[0];for(const l in e)t[e[l]]=(t[e[l]]||0)+1,t[e[l]]>r&&(r=t[e[l]],n=e[l]);return n}),s.trimmean=((e,t)=>{const r=Math.floor(e.length*t),n=e.sort((e,t)=>e-t).slice(r,e.length-r);return n.reduce((e,t)=>e+t)/n.length}),s.inrange=((e,t,r)=>e>=t&&e<=r),s.nearEq=((e,t,r)=>n(e-t)<r),s.addDays=((t,r)=>{let n=e(t);return n.add(r,"days"),n}),s.daysnap=(t=>{let r=e.unix(t).utc();return r.hours(0),r.minutes(0),r.seconds(0),r.milliseconds(0),r.unix()}),s.monthsnap=(t=>{let r=e.unix(t).utc();return r.date(1).hours(0).minutes(0).seconds(0).milliseconds(0),r.unix()}),s.yearsnap=(t=>{let r=e.unix(t).utc();return r.month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),r.unix()}),s.formatDate=(t=>{let r=e.unix(t).utc(),n=r.year(),l=r.month()+1;l=l<10?"0"+l.toString():l.toString();let o=r.date();return n+"."+l+"."+(o=o<10?"0"+o.toString():o.toString())}),s.formatDateTime=(t=>{let r=e.unix(t).utc(),n=r.hour();n=n<10?"0"+n.toString():n.toString();let l=r.minute();l=l<10?"0"+l.toString():l.toString();let o=r.second();return o=o<10?"0"+o.toString():o.toString(),s.formatDate(t)+" "+n+":"+l+":"+o});let f=RegExp("^(\\d{4})(\\d{2})(\\d{2})$");return s.dayparse=((e,t="")=>{let r,n,l;return null==e?null:(""==t?(r=f,n="YYYYMMDD"):(r=RegExp("^(\\d{4})"+t+"(\\d{2})"+t+"(\\d{2})$"),n="YYYY"+t+"MM"+t+"DD"),(l="string"!=typeof e?null:e.match(r))?Date.UTC(l[1],l[2]-1,l[3])/1e3:isNaN(e)?NaN:Number(e))}),s.dayify=((t,r="")=>{if(isNaN(t)||t<0)return"ERROR";if(null==t)return null;let n=e.unix(t).utc(),l=n.year(),o=n.month()+1,i=n.date();return""+l+r+(o<10?"0":"")+o+r+(i<10?"0":"")+i}),s.nowstamp=((t,r,n)=>{let l;if(t?e.hasOwnProperty("tz")?l=e().tz(t):(console.log("butil.nowstamp: moment-timezone is not loaded, using local time"),l=e()):(console.log("butil.nowstamp: no timezone specified, using local time"),l=e()),n){const t=e.unix(n).utc(),r=(e(l).utc()-t)/1e3;(r<0||r>2*a)&&l.year(t.year()).month(t.month()).date(t.date())}return l.subtract(r,"s"),l.format("YYYYMMDD")}),s.sint=(e=>u(e).toString()),s.loadJSON=(e=>new Promise(function(t,r){""===e&&t(null);let n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.onreadystatechange=function(){if(4==n.readyState&&("200"==n.status||"0"==n.status&&""!=n.responseText))try{t(JSON.parse(n.responseText))}catch(r){console.log("butil.loadJSON: Could not parse JSON file in "+e),console.log(r.message),t(null)}else 4==n.readyState&&t(null)},n.open("GET",e,!0),n.send(null)})),s.toTitleCase=(e=>e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})),s.arrayEquals=((e,t)=>{if(!(e instanceof Array&&t instanceof Array))return!1;if(e.length!=t.length)return!1;for(let r=0,n=e.length;r<n;r++)if(e[r]instanceof Array&&t[r]instanceof Array){if(!s.arrayEquals(e[r],t[r]))return!1}else if(e[r]!==t[r])return!1;return!0}),s.nummy=(e=>!isNaN(parseFloat(e))&&isFinite(e)),s.stringy=(e=>"string"==typeof e),s.listy=(e=>Array.isArray(e)),s.torf=(e=>"boolean"==typeof e),s.born=(e=>s.torf(e)||null===e),s.norn=(e=>s.nummy(e)||null===e),s.timy=(e=>s.nummy(e)&&0<e&&e<s.BDUSK),s.torn=(e=>s.timy(e)||null===e),s.sorn=(e=>"string"==typeof e||null===e),s});
!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["moment","Polyfit","butil"],t):"object"==typeof module&&module.exports?module.exports=t(require("./moment"),require("./polyfit"),require("./butil")):e.broad=t(e.moment,e.Polyfit,e.butil)}(this,function(e,t,n){"use strict";Math.round;const r=Math.max,l=Math.min,o=Math.abs,s=Math.pow,i=Math.floor,a=(Math.ceil,Math.sign,86400);var u={rsk8:0};u.AGGR={last:e=>e[e.length-1],first:e=>e[0],min:e=>n.arrMin(e),max:e=>n.arrMax(e),truemean:e=>n.mean(e),uniqmean:e=>n.mean(n.deldups(e)),mean:e=>n.mean(n.deldups(e)),median:e=>n.median(e),mode:e=>n.mode(e),trimmean:e=>n.trimmean(e,.1),sum:e=>n.sum(e),jolly:e=>e.length>0?1:0,binary:e=>e.length>0?1:0,nonzero:n.nonzero,triangle:e=>n.sum(e)*(n.sum(e)+1)/2,square:e=>s(n.sum(e),2),clocky:n.clocky,count:e=>e.length,kyshoc:e=>l(2600,n.sum(e)),skatesum:e=>l(u.rsk8,n.sum(e)),cap1:e=>l(1,n.sum(e))},u.RP={DATE:0,VALUE:1,SLOPE:2},u.printRoad=(e=>{for(let r=0;r<e.length;r++){var t=e[r];console.debug("[("+t.sta[0]+"("+n.formatDate(t.sta[0])+"),"+t.sta[1]+"),("+t.end[0]+"("+n.formatDate(t.end[0])+"),"+t.end[1]+"),"+t.slope+", auto="+t.auto+"]")}}),u.sameRoads=((e,t)=>{if(e.length!=t.length)return!1;for(let r=0;r<e.length;r++){if(!n.nearEq(e[r].end[0],t[r].end[0],10))return!1;if(!n.nearEq(e[r].end[1],t[r].end[1],10))return!1;if(!n.nearEq(e[r].slope,t[r].slope,1e-14))return!1}return!0}),u.copyRoad=(e=>{var t=[];for(let r=0;r<e.length;r++){var n={sta:e[r].sta.slice(),end:e[r].end.slice(),slope:e[r].slope,auto:e[r].auto};t.push(n)}return t}),u.findSeg=((e,t)=>n.searchHigh(e,e=>e.end[0]<t?-1:e.sta[0]>t?1:0)),u.segSlope=(e=>(e.end[1]-e.sta[1])/(e.end[0]-e.sta[0])),u.segValue=((e,t)=>e.sta[1]+e.slope*(t-e.sta[0])),u.rdf=((e,t)=>u.segValue(e[u.findSeg(e,t)],t)),u.fixRoadArray=((e,t=u.RP.VALUE,r=!1,l=u.RP.VALUE)=>{const o=e.length;e[0].sta[0]=e[0].end[0]-315576e4,e[0].sta[1]=e[0].end[1];for(let i=1;i<o-1;i++){r&&(t=e[i].auto);var s=e[i].end[1]-e[i].sta[1];e[i].sta[0]=e[i-1].end[0],e[i].sta[1]=e[i-1].end[1],t===u.RP.DATE?(isFinite(e[i].slope)&&0!=e[i].slope&&(e[i].end[0]=n.daysnap(e[i].sta[0]+(e[i].end[1]-e[i].sta[1])/e[i].slope)),e[i].end[0]<=e[i].sta[0]&&(e[i].end[0]=n.daysnap(e[i].sta[0]+a)),l===u.RP.SLOPE?e[i].end[1]=e[i].sta[1]+e[i].slope*(e[i].end[0]-e[i].sta[0]):e[i].slope=u.segSlope(e[i])):t===u.RP.VALUE?isFinite(e[i].slope)?e[i].end[1]=e[i].sta[1]+e[i].slope*(e[i].end[0]-e[i].sta[0]):e[i].end[1]=e[i].sta[1]+s:t===u.RP.SLOPE&&(e[i].slope=u.segSlope(e[i]))}o>1&&(e[o-1].sta[0]=e[o-2].end[0],e[o-1].sta[1]=e[o-2].end[1],e[o-1].end[0]=e[o-1].sta[0]+315576e4,e[o-1].end[1]=e[o-1].sta[1])}),u.gdelt=((e,t,r,l)=>n.chop(t.yaw*(l-u.rdf(e,r)))),u.aok=((e,t,n,r)=>t.yaw*(r-u.rdf(e,n))>=-1e-15*o(r)),u.ppr=((e,t,n,r=null,l=!1)=>{return t.yaw*t.dir>=0?0:l||!(n<=t.asof)||t.ppr&&t.tdat!==t.asof?0===(o=null!=r?e[r].slope*a:u.rtf(e,n)*a)?2*-t.yaw:t.yaw*o>0?0:2*o:0;var o}),u.dtd=((e,t,n,l)=>{if(u.redyest(e,t,n))return 0;let o=0,s=l+u.ppr(e,t,n+o*a);for(;u.aok(e,t,n+o*a,s)&&n+o*a<=r(t.tfin,n);)o+=1,s+=u.ppr(e,t,n+o*a);return o}),u.dtdarray=((e,t)=>{var n,r,l,o,s=e.length,i=e[s-1].sta[0],d=e[s-1].sta[1],f=u.ppr(e,t,0,s-1),h=[];h=[[[i,d,0,d-f,1]]];for(var p=s-2;p>=0;p--){i=e[p].sta[0],d=e[p].sta[1],n=e[p].end[0],r=e[p].end[1],f=u.ppr(e,t,0,p,!0),l=(n-i)/a,o=isFinite(f)?[[i,d,0,r-f*l,l]]:t.dir*(d-r)>0?[[i,d,0,r,l]]:[[i,d,0,r-2*(r-d),l]];for(var g=h[h.length-1],c=0;c<g.length;c++)isFinite(f)?o.push([i,g[c][1]-f*l,g[c][2]+l,g[c][3]-f*l,g[c][4]+l]):t.dir*(d-r)>0?o.push([i,g[c][1],g[c][2],g[c][3],g[c][4]]):o.push([i,g[c][1]-2*(r-d),g[c][2]+(n-i),g[c][3]-2*(r-d),g[c][4]+(n-i)]);h.push(o)}return h}),u.isoline_generate=((e,t,n,r)=>{var l,o,s,i,a,u,d,f,h=t[0],p=0;function g(e,t){var n=e[e.length-1];n[0]==t[0]&&n[1]==t[1]||e.push(t)}for(o=[[h[0][0]+864e3,h[0][1]+r*(h[0][3]-h[0][1])],[h[0][0],h[0][1]+r*(h[0][3]-h[0][1])]],i=1;i<t.length;i++){for(s=(l=t[i]).length-1,a=0;a<l.length;a++)if(r<=l[a][4]){s=a;break}for(a=p;a>=s;a--)u=[h[a][0],h[a][1],h[a][2]],(d=[l[a][0],l[a][3],l[a][4]])[2]-u[2]==0?g(o,[u[0],u[1]]):(f=(r-u[2])/(d[2]-u[2]),g(o,[u[0]+f*(d[0]-u[0]),u[1]+f*(d[1]-u[1])]));u=[l[s][0],l[s][1],l[s][2]],(d=[l[s][0],l[s][3],l[s][4]])[2]-u[2]==0?g(o,[u[0],u[1]]):(f=(r-u[2])/(d[2]-u[2]),g(o,[u[0]+f*(d[0]-u[0]),u[1]+f*(d[1]-u[1])])),p=s,h=l}return o.reverse()}),u.isoline_monotonicity=((e,t,n,r,l)=>{if(r.yaw*r.dir<0)return e;let o,s,i,u,d=[],f=!1,h=!1;const p=function(e,t){e.push([t[0],t[1]])};for(u=-1,i=0;i<e.length-1;i++)if((e[i+1][1]-e[i][1])*r.dir>0&&(f=!1),p(d,e[i]),0!=l&&(e[i+1][1]-e[i][1])*r.dir<0&&!f)for(f=!0,u=i+1,h=!1;!h;)e[u][0]>=e[i][0]+l*a?(h=!0,p(d,[s=e[i][0]+l*a,e[i][1]])):(e[u+1][1]-e[u][1])*r.dir>=0&&(e[u+1][0]!=e[u][0]?0!=(o=(e[u+1][1]-e[u][1])/(e[u+1][0]-e[u][0]))&&(s=e[u][0]+(e[i][1]-e[u][1])/o)<=e[i][0]+l*a&&s<=e[u+1][0]&&(h=!0):(e[i][1]-e[u][1])*(e[i][1]-e[u+1][1])<0&&(s=e[u][0]+1,h=!0),h&&p(d,[s,e[i][1]])),u++;return d}),u.isoline_nobackward=((e,t,n,r,l)=>{var o,s,i,a=[e[0].slice()];for(i=1;i<e.length;i++)o=a[a.length-1],e[i][0]<o[0]||(e[i-1][0]<o[0]&&e[i][0]>o[0]&&e[i][0]-e[i-1][0]!=0&&(s=(e[i][1]-e[i-1][1])/(e[i][0]-e[i-1][0]),a.push([o[0],e[i-1][1]+s*(o[0]-e[i-1][0])])),a.push([e[i][0],e[i][1]]));return a}),u.isoline_clip=((e,t,n,o,s)=>{var i=[];function a(e,t,n){var r=(t[1]-e[1])/(t[0]-e[0]);return e[1]+r*(n-e[0])}function d(e,t,n,r){const l=t[0]-e[0],o=t[1]-e[1],s=-(r[0]-n[0]),i=-(r[1]-n[1]),a=n[0]-e[0],u=n[1]-e[1],d=l*i-s*o;if(0==d)return null;const f=(i*a-s*u)/d,h=(-o*a+l*u)/d;return f<0||f>1||h<0||h>1?null:[e[0]+f*l,e[1]+f*o]}function f(e,t,n,o=-1){for(var s=n.slice(),i=u.findSeg(e,n[0]),a=u.segValue(e[i],n[0]);--i>=0&&e[i].sta[0]==n[0];)a=-o*t.yaw>0?l(a,e[i].sta[1]):r(a,e[i].sta[1]);return(s[1]-a)*t.yaw<0&&(s[1]=a),s}var h,p=0,g=0;for(h=e[1][0]!=e[0][0]?1:-1,i.push(f(t,o,e[0],h));!(p>t.length-1||g>e.length-2);){var c=i.length-1,m=d(t[p].sta,t[p].end,e[g],e[g+1]);null==m||m[0]==i[c][0]&&m[1]==i[c][1]||i.push(m),t[p].end[0]<e[g+1][0]?((a(e[g],e[g+1],t[p].end[0])-t[p].end[1])*o.yaw<0&&i.push([t[p].end[0],t[p].end[1]]),p++):(h=++g<e.length-1&&e[g][0]!=e[g+1][0]?1:-1,i.push(f(t,o,e[g],h)))}return i}),u.isoline=((e,t,n,r,l=!1)=>{let o=u.isoline_generate(e,t,n,r),s=u.isoline_monotonicity(o,e,t,n,r),i=u.isoline_nobackward(s,e,t,n,r),a=u.isoline_clip(i,e,t,n,r);return l?[o,s,i,a]:a}),u.isoval=((e,t)=>{if(!e||!e.length)return null;if(t<=e[0][0])return e[0][1];if(t>=e[e.length-1][0])return e[e.length-1][1];const r=n.searchLow(e,e=>e[0]<=t?-1:1);return n.rescale(t,e[r][0],e[r+1][0],e[r][1],e[r+1][1])}),u.isoside=((e,t,n,r)=>{const l=u.isoval(t,n);return null===l?0:(r-l)*e.yaw>=-1e-15*o(r)?1:-1}),u.dtd_walk=((e,t,n,r)=>{let l=0;for(;u.gdelt(e,t,n+l*a,r)>=0&&n+l*a<=t.tfin;)l+=1;return l}),u.bufcap=((e,t,n=7)=>{const r=t.tcur,l=u.rdf(e,r),s=o(u.rtf(e,r));let i=0,d=0;for(;u.dtd_walk(e,t,r,l+i)<n&&d<=70;)i+=t.yaw*s*a,d+=1;return[i,d]}),u.tvr=((e,t,r,o,s)=>null===r?0===s?n.BDUSK:n.daysnap(l(n.BDUSK,e+(o-t)/s)):null===o?t+s*(r-e):null===s?r===e?0:(o-t)/(r-e):0);var d=(e,t)=>{var n=e[0],r=e[1],l=(e[2],e[3],t[0]),o=t[1],s=t[2],i=u.tvr(n,r,l,o,s);return null===l?[i,o,s,0]:null===o?[l,i,s,1]:null===s?[l,o,i,2]:[l,o,i,0]};return u.fillroad=((e,t)=>{e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]/t.siru),e[0]=d([t.tini,t.vini,0,0],e[0]);for(let t=1;t<e.length;t++)e[t]=d(e[t-1],e[t]);for(e.forEach(e=>e[2]=null==e[2]?e[2]:e[2]*t.siru);void 0!==e&&void 0!==e[0]&&e[0][0]<t.tini;)e.shift();return e}),u.fillroadall=((e,t)=>{const n=e[0][0],r=e[0][1];e.splice(0,1),e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]/t.siru),e[0]=d([n,r,0,0],e[0]);for(let t=1;t<e.length;t++)e[t]=d(e[t-1],e[t]);return e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]*t.siru),e.unshift([n,r,0,2]),e}),u.rtf=((e,t)=>e[u.findSeg(e,t)].slope),u.odomify=(e=>{if(!e||!e.length||0===e.length)return;let t=0,n=e[0][1];for(let r=1;r<e.length;r++)0===e[r][1]&&(t+=n),n=e[r][1],e[r][1]+=t}),u.stepFunc=((e,t,r=0)=>{const l=n.searchLow(e,e=>e[0]-t);return l<0?r:e[l][1]}),u.stepify=((e,t=0)=>null===e?e=>t:n=>u.stepFunc(e,n,t)),u.dotcolor=((e,t,r,l,o=null)=>r<t.tini?n.Cols.BLCK:null===o?u.aok(e,t,r,l)?n.Cols.BLCK:n.Cols.REDDOT:!o||!o.length||o.length<1?n.Cols.ERRDOT:u.isoside(t,o[0],r,l)<0?n.Cols.REDDOT:u.isoside(t,o[1],r,l)<0?n.Cols.ORNDOT:u.isoside(t,o[2],r,l)<0?n.Cols.BLUDOT:u.isoside(t,o[6],r,l)<0?n.Cols.GRNDOT:n.Cols.GRADOT),u.redyest=((e,t,r,l=null)=>u.dotcolor(e,t,r-a,t.dtf(r-a),l)===n.Cols.REDDOT),u.stdflux=((e,t)=>{if(!t||!t.length||t.length<=1)return 0;const r=n.partition(t,2,1);let l,s,i,d,f=[];for(let t=0;t<r.length;t++)l=r[t][0][0],s=r[t][0][1],i=r[t][1][0],d=r[t][1][1],f.push(o(d-s-u.rdf(e,i)+u.rdf(e,l))/(i-l)*a);return n.chop(1===f.length?f[0]:n.quantile(f,.9))}),u.autowiden=((e,t,l,s)=>{let i=l;if(i<=1)return 0;let d=-1;if(u.gdelt(e,t,l[l.length-1][0],l[l.length-1][1])<0){for(;d>=-i&&u.gdelt(e,t,l[d][0],l[d][1])<0;)d-=1;(d+=1)>-i&&l[d][0]-l[d-1][0]<=a&&(s=r(s,o(l[d][1]-u.rdf(e,l[d][0]))))}return n.chop(s)}),u.vertseg=((e,t)=>e.filter(e=>e.sta[0]===t).length>1),u.gapFill=(e=>{var t,n=(e,t,n)=>e+(t-e)*n,r=e[0][0],l=e[e.length-1][0],o=i((l-r)/a),s=Array(o),u=0,d=r;for(t=0;t<e.length-1;t++)for(var f=e[t+1][0]-e[t][0];d<=e[t+1][0];)s[u]=[d,n(e[t][1],e[t+1][1],(d-e[t][0])/f)],u++,d+=a;return 0===s.length&&s.push(e[0]),s}),u.smooth=(e=>{var s=(e[0][0]+e[e.length-1][0])/2,i=n.zip(e),u=i[0].map(e=>(e-s)/a),d=new t(u,i[1]),f=d.getPolynomial(3),h=o(r(...i[1])-l(...i[1]));return d.standardError(d.computeCoefficients(3))>1e4*h&&(console.log("butil.smooth: Possible ill-conditioned polyfit. Reducing dimension."),f=d.getPolynomial(2)),e=>f((e-s)/a)}),u.interpData=((e,t)=>{var n=(e,t,n)=>e+(t-e)*n,r=0,l=e.length,o=[];if(0===l)return null;if(1===l)return t.map(e=>[e,e[0][1]]);for(let i=0;i<t.length;i++){var s=t[i];if(s<=e[0][0])o.push([s,e[0][1]]);else if(s>=e[l-1][0])o.push([s,e[l-1][1]]);else if(s<e[r+1][0])o.push([s,n(e[r][1],e[r+1][1],(s-e[r][0])/(e[r+1][0]-e[r][0]))]);else{for(;s>e[r+1][0];)r++;o.push([s,n(e[r][1],e[r+1][1],(s-e[r][0])/(e[r+1][0]-e[r][0]))])}}return o}),u.lim=((e,t,n)=>u.rdf(e,t.tcur+n*a)),u.limd=((e,t,n)=>u.lim(e,t,n)-t.vcur),u.dueby=((e,t,r)=>{let l=[...Array(r).keys()].map(r=>[n.dayify(t.tcur+r*a),u.limd(e,t,r),u.lim(e,t,r)]);const o=n.zip(l);return n.zip([o[0],n.monotonize(o[1],t.dir),n.monotonize(o[2],t.dir)])}),u});
((n,t)=>{"use strict";"function"==typeof define&&define.amd?define(["moment","butil","broad"],t):"object"==typeof module&&module.exports?module.exports=t(require("./moment"),require("./butil"),require("./broad")):n.beebrain=t(n.moment,n.butil,n.broad)})(this,(n,t,r)=>{"use strict";const a=Math.max,i=Math.min,e=Math.abs,l=Math.exp,o=Math.floor,s=Math.ceil,u=Math.sign,f=365.25,m=86400;let d=1;const c={quantum:1e-5,timey:!1,ppr:!0,deadline:0,sadlhole:!0,asof:null,tini:null,vini:null,road:[],tfin:null,vfin:null,rfin:null,runits:"w",gunits:"units",yaw:0,dir:0,pinkzone:[],tmin:null,tmax:null,vmin:null,vmax:null,kyoom:!1,odom:!1,maxflux:0,monotone:!1,aggday:null,plotall:!0,steppy:!1,rosy:!1,movingav:!1,aura:!1,hashtags:!0,yaxis:"",waterbuf:null,waterbux:"",hidey:!1,stathead:!0,imgsz:760,yoog:"U/G",usr:null,graph:null,goal:null,rate:null},p={sadbrink:!1,safebump:null,dueby:[],fullroad:[],pinkzone:[],tluz:null,tcur:null,vcur:null,vprev:null,rcur:null,ravg:null,tdat:null,stdflux:0,delta:0,lane:666,cntdn:0,numpts:0,mean:0,meandelt:0,proctm:0,statsum:"",ratesum:"",deltasum:"",graphsum:"",progsum:"",rah:0,safebuf:null,error:"",limsum:"",headsum:"",titlesum:"",lnw:0,color:"black",loser:!1,gldt:null,goal:null,rate:null,road:[],tini:null,vini:null,tfin:null,vfin:null,rfin:null},g=["ybhp","integery","noisy","abslnw","tagtime","timezone","backroad","edgy","offred"],h={AGGPAST:0,AGGFUTURE:1,RAWPAST:2,RAWFUTURE:3,FLATLINE:4,HOLLOW:5};return function(y){let v=this,b=d;d++,y=t.deepcopy(y);let x=[],w={},A=[],z=[],R=[],k=[],M=[],T=[],E=[],S={},U={},G={},O={},P=[];w.yaw=1,w.dir=1,w.tcur=0,w.vcur=0,w.vprev=0;const N=n.utc();function L(n){if(n.fullroad=n.fullroad.map(n=>(function(n){return Array.isArray(n)?n.length<=3?n:n.slice(0,3):n})(n)),n.road=n.fullroad,n.error)n.gldt=t.dayify(w.tfin),n.goal=w.vfin,n.rate=w.rfin*w.siru;else{const t=n.fullroad.length;t>0&&(n.gldt=n.fullroad[t-1][0],n.goal=n.fullroad[t-1][1],n.rate=n.fullroad[t-1][2])}n.tini=t.dayify(w.tini),n.vini=w.vini,n.tfin=t.dayify(w.tfin),n.vfin=w.vfin,n.rfin=w.rfin}function D(n){return Array.isArray(n)&&3===n.length?[t.dayparse(n[0]),n[1],n[2]]:n}function K(n){if(n.length<1)return n;let r=n.slice();return r[0]=t.dayify(n[0]),r}function $(n,t){let r=.25/m;"meta/derev"===w.yoog&&(r=.03/m),"meta/dpledge"===w.yoog&&(r=.03/m);let a,i,e,o,s,u=n[0][0],f=n[0][1],d=f;if(t<u)return d;for(e=1;e<n.length;e++){if(a=(i=n[e])[0]-u,o=(i[1]-f)/a,s=f,t<i[0])return s+o*(a=t-u)-o/r+(d-s+o/r)*l(-r*a);d=s+o*a-o/r+(d-s+o/r)*l(-r*a),u=i[0],f=i[1]}return s+o*(a=t-u)-o/r+(d-s+o/r)*l(-r*a)}function F(n,r,a){let i=t.zip(n);return i[1]=function(n,r,a){return t.foldlist((n,a)=>t.clip(n,a-r,a+r),n[0]+a*r,n.slice(1,n.length))}(i[1],r,a),t.zip(i)}function H(n,t,r){return F(n.slice().reverse(),t,r).reverse()}let j;N.hour(0),N.minute(0),N.second(0),N.millisecond(0),w.asof=N.unix(),w.horizon=w.asof+t.AKH,w.xMin=w.asof,w.xMax=w.horizon,w.yMin=-1,w.yMax=1;try{j=new RegExp("(?:^|\\s)(#\\p{L}[\\p{L}0-9_]*)(?=$|\\s)","gu")}catch{j=/(?:^|\s)(#[a-zA-Z]\w*)(?=$|\s)/g}function q(n){let t,r=new Set;for(j.lastIndex=0;null!=(t=j.exec(n));)""!=t[1]&&r.add(t[1]);return r}function B(n){return n[1]}function I(n,r){const a=w.kyoom&&"sum"===w.aggday;if(1===n.length)return[n[0][2],n[0][3],n[0][4]];{let i;return(i=a?t.accumulate(n.map(B)).indexOf(r):n.map(B).indexOf(r))<0?[w.aggday,null,null]:[n[i][1]+" ("+w.aggday+")",n[i][3],n[i][4]]}}let C=null;function W(n){return JSON.stringify(null==n[0]?n:[t.formatDate(n[0]),n[1],n[2]])}const J=[["deadline",n=>-64800<=n&&n<=21600,"outside 6am earlybird to 6am nightowl"],["asof",n=>null!=n,"can't be null! Tell support!"],["asof",t.torn,"isn't a valid timestamp"],["tini",t.timy,"isn't a valid timestamp"],["vini",t.nummy,"isn't numeric"],["road",t.listy,"(road matrix) isn't a list"],["tfin",t.torn,"isn't a valid timestamp"],["vfin",t.norn,"isn't numeric or null"],["rfin",t.norn,"isn't numeric or null"],["runits",n=>n in t.SECS,"isn't a valid rate unit"],["yaw",n=>0==n||1==n||-1==n,"isn't in [0,-1,1]"],["dir",n=>1==n||-1==n,"isn't in -1,1]"],["tmin",t.torn,"isn't a number/timestamp"],["tmax",t.torn,"isn't a valid timestamp"],["vmin",t.norn,"isn't numeric or null"],["vmax",t.norn,"isn't numeric or null"],["kyoom",t.torf,"isn't boolean"],["odom",t.torf,"isn't boolean"],["monotone",t.torf,"isn't boolean"],["aggday",n=>n in r.AGGR,"isn't one of max, sum, last, mean, etc"],["plotall",t.torf,"isn't boolean"],["steppy",t.torf,"isn't boolean"],["rosy",t.torf,"isn't boolean"],["movingav",t.torf,"isn't boolean"],["aura",t.torf,"isn't boolean"],["yaxis",t.stringy,"isn't a string"],["yaxis",n=>n.length<80,"string is too long\\n"],["waterbuf",t.sorn,"isn't a string or null"],["waterbux",t.stringy,"isn't a string"],["hidey",t.torf,"isn't boolean"],["stathead",t.torf,"isn't boolean"],["imgsz",t.nummy,"isn't numeric"],["yoog",t.stringy,"isn't a string"]];function Y(){w.dtf=r.stepify(z),w.road=r.fillroad(w.road,w);const n=w.road.length;w.tfin=w.road[n-1][0],w.vfin=w.road[n-1][1],w.rfin=w.road[n-1][2];const e=w.road.map(n=>n[0]);if(w.tini>e[0])return"Road dial error\\n(There are segments of your yellow brick road\\nthat are somehow dated before your road start date!)";if(!t.orderedq(e))return"Road dial error\\n(Your goal date, goal "+(w.kyoom?"total":"value")+", and rate are inconsistent!\\nIs your rate positive when you meant negative?\\nOr is your goal "+(w.kyoom?"total":"value")+" such that the implied goal date is in the past?)";w.stdflux=r.stdflux(x,z.filter(n=>n[0]>=w.tini)),function(){const n=w.asof,a=z.length,e=z[a-1][0],l=z[a-1][1];if(e>w.tfin)return;let o=e;if(w.yaw*w.dir<0)o=i(n,w.tfin);else{let e,s=null;for(;o<=i(n,w.tfin)&&(s!==(e=r.dotcolor(x,w,o,l,w.isolines))||s!==t.Cols.REDDOT);)s=e,o+=m;o=i(o,n,w.tfin);for(let n=0;n<a;n++)if(o==z[n][0])return}if(!(o in U)){const n=z[a-1];C=[o,l,"PPR",h.FLATLINE,n[0],n[1],null],z.push(C)}}();const l=z.length;if(w.movingav)if(l<=1||z[l-1][0]-z[0][0]<=0)w.filtpts=[];else{const n=function(n,r,a=6e3){return t.linspace(n,r,o(t.clip((r-n)/(m+1),i(600,640),a)))}(z[0][0],z[l-1][0],4*(z[l-1][0]-z[0][0])/m);JSON.stringify(n),w.filtpts=n.map(n=>[n,$(z,n)])}else w.filtpts=[];return w.tcur=z[l-1][0],w.vcur=z[l-1][1],w.vprev=z[a(l-2,0)][1],w.safebuf=r.dtd(x,w,w.tcur,w.vcur),w.tluz=w.tcur+w.safebuf*m,w.delta=t.chop(w.vcur-r.rdf(x,w.tcur)),w.rah=r.rdf(x,w.tcur+t.AKH),w.dueby=r.dueby(x,w,7),w.safebump=r.lim(x,w,w.safebuf),w.rcur=r.rtf(x,w.tcur)*w.siru,w.ravg=r.tvr(w.tini,w.vini,w.tfin,w.vfin,null)*w.siru,w.cntdn=s((w.tfin-w.tcur)/m),w.lane=w.yaw*(w.safebuf-(w.safebuf<=1?2:1)),w.color=w.safebuf<1?"red":w.safebuf<2?"orange":w.safebuf<3?"blue":"green",w.loser=r.redyest(x,w,w.tcur),w.sadbrink=w.tcur-m>w.tini&&r.dotcolor(x,w,w.tcur-m,w.dtf(w.tcur-m,w.isolines))==t.Cols.REDDOT,w.safebuf<=0&&(w.tluz=w.tcur),w.tfin<w.tluz&&(w.tluz=t.BDUSK),function(){if(null==w.tmin&&(w.tmin=i(w.tini,w.asof)),null==w.tmax){const n=o((w.tcur-w.tmin)/(f*m));w.tmax=t.daysnap(2*(1+n/2)*t.AKH+w.tcur)}if(null!=w.vmin&&null!=w.vmax)return void(w.vmin==w.vmax?(w.vmin-=1,w.vmax+=1):w.vmin>w.vmax&&([w.vmin,w.vmax]=[w.vmax,w.vmin]));const n=r.rdf(x,w.tmin),e=r.rdf(x,w.tmax),l=z.filter(n=>n[0]<=w.tmax&&n[0]>=w.tmin).map(n=>n[1]);let s=t.arrMin(l),u=t.arrMax(l);if(null!=C&&C[0]<=w.tmax&&C[0]>=w.tmin){const n=C[1]+r.ppr(x,w,w.asof);s=i(s,n),u=a(u,n)}const d=a(0,.015*(u-s)*2);let c=s-d,p=u+d;w.monotone&&w.dir>0?(c=t.arrMin([c,n,e]),p=t.arrMax([p,n,e])):(w.monotone&&w.dir,c=t.arrMin([c,n,e]),p=t.arrMax([p,n,e])),w.plotall&&w.tmin<=w.tini&&w.tini<=w.tmax&&w.tini in S&&(c=i(c,t.arrMin(S[w.tini].map(n=>n[1]))),p=a(p,t.arrMax(S[w.tini].map(n=>n[1])))),null==w.vmin&&null==w.vmax?(w.vmin=c,w.vmax=p,w.vmin==w.vmax?(w.vmin-=1,w.vmax+=1):w.vmin>w.vmax&&([w.vmin,w.vmax]=[w.vmax,w.vmin])):null==w.vmin?w.vmin=c<w.vmax?c:w.vmax-1:null==w.vmax&&(w.vmax=p>w.vmin?p:w.vmin+1)}(),""}this.reloadRoad=function(){const n=Y();if(""!=n)return n;if(function(n,a){const i=a.yaw,l=a.dir,s=a.lane,f=a.delta,d=a.quantum,c=i>0&&l>0,p=i<0&&l<0,g=i<0&&l>0,h=i>0&&l<0,y=(n,r=i,a=4,e=2)=>null===d?t.shn(n,a,e,r):t.conservaround(n,d,r),v=(n,t=i,r=4,a=2)=>(n>=0?"+":"")+y(n,t,r,a);if(""!=a.error)return void(a.statsum=" error:    "+a.error+"\\n");const b=t.zip(a.road)[2];let w=t.arrMin(b),A=t.arrMax(b);if(e(w)>e(A)){const n=w;w=A,A=n}const R=t.shn(w,4,2),k=t.shn(A,4,2),M=t.shn(a.ravg,4,2),T=t.shn(a.rcur,4,2);a.ratesum=(w===A?R:"between "+R+" and "+k)+" per "+t.UNAM[a.runits]+(w!==A?" (current: "+T+", average: "+M+")":"");const E=t.daysnap(a.tini),S=t.daysnap(a.tcur),U=t.daysnap(a.tfin),G=a.vini,O=a.vcur,P=a.vfin;let N,L,D,K;N=E===U?"??":t.shn(t.rescale(S,E,U,0,100),1,1),L=G===P?O<G&&a.yaw>0||O>G&&a.yaw<0?"00":"100":e(G-P)<1e-7?O<(G+P)/2&&a.yaw>0||O>(G+P)/2&&a.yaw<0?"~0":"~100":t.shn(t.rescale(a.vcur,a.vini,a.vfin,0,100),1,1),a.progsum=N==L?N+"% done":N+"% done by time -- "+L+"% by value",a.cntdn<7?(D=u(a.rfin)*(a.vfin-a.vcur),K="To go to goal: "+y(D,0,2,1)+"."):K="Yellow Brick Rd = "+((D=r.rdf(x,a.tcur+a.siru)-r.rdf(x,a.tcur))>=0?"+":"")+t.shn(D,2,1,0)+" / "+t.UNAM[a.runits]+".",a.graphsum=y(a.vcur,0,3,1)+" on "+t.shd(a.tcur)+" ("+t.splur(a.numpts,"datapoint")+" in "+t.splur(1+o((a.tcur-a.tini)/m),"day")+") targeting "+y(a.vfin,0,3,1)+" on "+t.shd(a.tfin)+" ("+t.splur(a.cntdn,"more day")+"). "+K,a.deltasum=y(e(f),0)+" "+a.gunits+(f<0?" below":" above")+" the bright line";const $=a.safebuf,F=t.splur($,"day"),H=r.lim(x,a,c||p?$:0),j=r.limd(x,a,c||p?$:0);a.kyoom?(c&&(a.limsum=v(j)+" in "+F),p&&(a.limsum=v(j)+" in "+F),g&&(a.limsum=v(j)+" today"),h&&(a.limsum=v(j)+" today")):(c&&(a.limsum=v(j)+" in "+F+" ("+y(H)+")"),p&&(a.limsum=v(j)+" in "+F+" ("+y(H)+")"),g&&(a.limsum=v(j)+" today ("+y(H)+")"),h&&(a.limsum=v(j)+" today ("+y(H)+")")),a.safeblurb=i*l<0?"unknown days of safety buffer":$>999?"more than 999 days of safety buffer":"~"+F+" of safety buffer",a.titlesum=t.toTitleCase(a.color)+": bmndr.com/"+a.yoog+" is safe for ~"+F+(0===$?" (beemergency!)":""),a.headsum=a.titlesum,a.statsum=" progress: "+t.shd(a.tini)+"  "+(null==z?"?":t.shn(a.vini,4,2,0))+"\\n           "+t.shd(a.tcur)+"  "+t.shn(a.vcur,4,2,0)+"   ["+a.progsum+"]\\n           "+t.shd(a.tfin)+"  "+t.shn(a.vfin,4,2,0)+"\\n rate:     "+a.ratesum+"\\n lane:     "+(666==e(s)?"n/a":s)+"\\n safebuf:  "+a.safebuf+"\\n delta:    "+a.deltasum+"\\n ",a.statsum+=0==i?"limit:    ":i<0?"hard cap: ":"bare min: ",a.statsum+=a.limsum+"\\n"}(0,w),w.fullroad=w.road.slice(),w.fullroad.unshift([w.tini,w.vini,0,0]),""==w.error&&(w.pinkzone=[[w.asof,r.rdf(x,w.asof),0]],w.road.forEach(function(n){n[0]>w.asof&&n[0]<w.asof+t.AKH&&w.pinkzone.push([n[0],n[1],null])}),w.pinkzone.push([w.asof+t.AKH,r.rdf(x,w.asof+t.AKH),null]),w.pinkzone=r.fillroadall(w.pinkzone,w)),w.aura){const n=z.filter(n=>n[0]>=w.tmin),t=r.gapFill(n);w.auraf=r.smooth(t)}else w.auraf=(n=>0);w.dtdarray=r.dtdarray(x,w),w.isolines=[];for(let n=0;n<4;n++)w.isolines[n]=r.isoline(x,w.dtdarray,w,n);return""};let V={};this.getStats=function(){return t.deepcopy(V)},this.setRoadObj=function(n){if(0!=n.length){x=n,v.roads=x,w.road=[];for(let n=1;n<x.length;n++)w.road.push([x[n].sta[0],x[n].sta[1],x[n].slope]);v.gol=w,v.reloadRoad()}else console.log("id="+b+", setRoadObj(), null road!")},function(e,l,o=null){try{null==o&&(o=n.utc().unix()),function(n){"goal"in n&&!("vfin"in n)&&(n.vfin=n.goal),"rate"in n&&!("rfin"in n)&&(n.rfin=n.rate),"usr"in n&&"graph"in n&&!("yoog"in n)&&(n.yoog=n.usr+"/"+n.graph)}(e),function(){z=[],C=null,k=[],S={},U={},G={},(w={}).siru=null,M=[],T=[],O={};for(const n in p)w[n]=p[n];for(const n in c)w[n]=c[n]}(),w.proctm=o,z=function(n,r){return["asof","tini","tfin","tmin","tmax"].map(r=>{r in n&&(n[r]=t.dayparse(n[r]))}),"road"in n&&t.listy(n.road)&&(n.road=n.road.map(D)),r.map((n,r)=>[t.dayparse(n[0]),n[1],n[2],r,n[1]]).sort((n,t)=>n[0]!==t[0]?n[0]-t[0]:n[3]-t[3])}(e,l);const s=[];for(const n in e)n in e&&(n in c||g.includes(n)?w[n]=e[n]:s.push(`${n}=${e[n]}`));s.length>0&&(w.error+=`Unknown param${1===s.length?"":"s"}: ${s.join(", ")}`),"aggday"in e||(e.aggday=w.kyoom?"sum":"last"),w.siru=t.SECS[w.runits],w.horizon=w.asof+t.AKH,w.waterbuf0=w.waterbuf,t.listy(w.road)&&w.road.push([w.tfin,w.vfin,w.rfin]),""==w.error&&(w.error=function(){const n=n=>JSON.stringify(n);let r;for(r=0;r<J.length;r++){const t=J[r];if(!t[1](w[t[0]]))return`'${t[0]}' ${t[2]}: ${n(w[t[0]])}`}const a=w.road;for(r=0;r<a.length;r++)if(i=a[r],!t.listy(i)||3!=i.length||!(null==i[0]&&t.nummy(i[1])&&t.nummy(i[2])||t.nummy(i[0])&&null==i[1]&&t.nummy(i[2])||t.nummy(i[0])&&t.nummy(i[1])&&null==i[2]))return"Invalid road matrix row: "+W(a[r]);var i;const e=a.slice(1,a.length-1);if(e.length!=t.deldups(e).length){let n=e[0];for(r=1;r<e.length;r++){if(t.arrayEquals(e[r],n))return"Road matrix has duplicate row: "+W(e[r]);n=e[r]}return"Road matrix duplicate row error! Tell support!"}return w.kyoom&&w.odom?"The odometer setting doesn't make sense for an auto-summing goal!":""}()),""==w.error&&(w.error=function(){if(null==z||0==z.length)return"No datapoints";const n=z.length;let a,i;for(a=0;a<n;a++){if(i=z[a],!(t.nummy(i[0])&&i[0]>0&&t.nummy(i[1])&&t.stringy(i[2])))return"Invalid datapoint: "+i[0]+" "+i[1]+' "'+i[3];if(w.hashtags){const n=q(i[2]);if(0==n.size)continue;i[0]in O||(O[i[0]]=new Set);for(const t of n)O[i[0]].add(t)}}if(w.hashtags){P=[],Object.keys(O);for(const n in O)P.push([n,Array.from(O[n]).join(" ")])}for(T=(T=z.filter(n=>(function(n){return n.startsWith("RECOMMITTED")})(n[2]))).map(n=>n.slice()),a=0;a<T.length;a++){const n=1562299200;T[a][0]<n&&(T[a][0]=T[a][0]-m)}w.odom&&(M=z.filter(n=>0==n[1]).map(n=>n[0]),r.odomify(z));const e=z.filter(n=>n[0]<=w.asof);w.plotall&&(w.numpts=e.length),S={},U={};let l,o=[],s=z[0][0],u=[],f=0;for(r.rsk8=w.rfin*m/w.siru,a=0;a<=z.length;a++)if(a<z.length&&z[a][0]==s&&u.push(z[a].slice()),a>=z.length||z[a][0]!=s){let n=u.map(B),i=r.AGGR[w.aggday](n);l=o.length>0?o[o.length-1]:[s,i+f];let e=I(u,i);o.push([s,f+i,e[0],s<=w.asof?h.AGGPAST:h.AGGFUTURE,l[0],l[1],e[2],e[1]]),w.kyoom?("sum"===w.aggday?S[s]=t.accumulate(n).map((n,t)=>[s,n+f,u[t][2],u[t][3],u[t][4]]):S[s]=u.map(n=>[s,n[1]+f,n[2],n[3],n[4]]),U[s]=f+i,f+=i):(S[s]=u,U[s]=i);const m=S[s].map(n=>n[1]);G[s]=w.yaw<0?t.arrMax(m):t.arrMin(m),a<z.length&&(s=z[a][0],u=[z[a].slice()])}let d=[];for(let n in S)d=d.concat(S[n].map(t=>[Number(n),t[1],t[2],Number(n)<=w.asof?h.AGGPAST:h.AGGFUTURE,null,null,t[4],t[3]]));if(A=d,k=o.filter(n=>n[0]>w.asof),0==(z=o.filter(n=>n[0]<=w.asof)).length)return"All datapoints are in the future!";w.plotall||(w.numpts=z.length);const c=r.gapFill(z).map(n=>n[1]);for(z.length>0&&(w.mean=t.mean(c)),z.length>1&&(w.meandelt=t.mean(t.partition(c,2,1).map(n=>n[1]-n[0]))),w.tdat=z[z.length-1][0],a=0;a<T.length;a++){const n=1562299200;(s=T[a][0]<n?T[a][0]+m:T[a][0])in G&&(T[a][1]=U[s])}return E=z.filter(n=>n[0]in S&&n[0]<w.asof&&!S[n[0]].map(n=>n[1]).includes(n[1])),""}()),""==w.error&&(w.error=function(n){const a=t.BDUSK;x=[];const e=n,l=e.length;let o,s=w.tini,u=w.vini;null!=e[0][0]&&e[0][0]<s&&(s=e[0][0],null!=e[0][1]&&(u=e[0][1])),(o={sta:[s,Number(u)],slope:0,auto:r.RP.SLOPE}).end=o.sta.slice(),o.sta[0]=t.daysnap(o.sta[0]-100*m*f),x.push(o);for(let n=0;n<l;n++){let t={};t.sta=x[x.length-1].end.slice();let l=null,o=null,s=null;l=e[n][0],o=e[n][1],s=e[n][2],null==l?(t.end=[0,Number(o)],t.slope=Number(s)/w.siru,0!=t.slope?t.end[0]=t.sta[0]+(t.end[1]-t.sta[1])/t.slope:(t.end[0]=a,t.end[1]=t.sta[1]),t.end[0]=i(a,t.end[0]),t.end[1]=t.sta[1]+t.slope*(t.end[0]-t.sta[0]),t.auto=r.RP.DATE):null==o?(t.end=[l,0],t.slope=Number(s)/w.siru,t.end[1]=t.sta[1]+t.slope*(t.end[0]-t.sta[0]),t.auto=r.RP.VALUE):null==s&&(t.end=[l,Number(o)],t.slope=r.segSlope(t),t.auto=r.RP.SLOPE),t.end[0]>=t.sta[0]&&x.push(t)}const d=x[x.length-1],c={sta:d.end.slice(),end:d.end.slice(),slope:0,auto:r.RP.VALUE};return c.end[0]=t.daysnap(c.end[0]+100*m*f),x.push(c),""}(e.road)),""==w.error&&(w.error=v.reloadRoad()),function(){if(!w.rosy||0==z.length)return;const n=a(0,w.stdflux);let r,i;w.dir>0?(r=F(z,n,-1),i=H(z,n,1)):(r=H(z,n,-1),i=F(z,n,1));const e=r.map(n=>n[1]),l=i.map(n=>n[1]),o=t.zip([e,l]).map(n=>(n[0]+n[1])/2),s=z.map(n=>n[0]);R=(R=t.zip([s,o])).map(n=>[n[0],n[1],"rosy data",h.RAWPAST,n[0],n[1],n[1]]);for(let n=1;n<R.length-1;n++)R[n][4]=R[n-1][0],R[n][5]=R[n-1][1]}()}finally{V=Object.assign({},p);for(const n in V)V[n]=w[n];!function(n){n.fullroad=n.fullroad.map(K),"razrmatr"in p&&(n.razrmatr=n.razrmatr.map(K)),n.pinkzone=n.pinkzone.map(K),n.tluz=t.dayify(n.tluz),n.tcur=t.dayify(n.tcur),n.tdat=t.dayify(n.tdat)}(V),L(V)}}(y.params,y.data),w.graphurl=t.BBURL,w.thumburl=t.BBURL,this.id=b,this.DPTYPE=h,this.roads=x,this.gol=w,this.data=z,this.rosydata=R,this.alldata=A,this.allvals=S,this.fuda=k,this.flad=C,this.oresets=M,this.derails=T,this.hollow=E,this.hashtags=P}});
!function(t,e){"use strict";"function"==typeof define&&define.amd?define(["d3","moment","butil","broad","beebrain"],e):"object"==typeof module&&module.exports?module.exports=e(require("d3"),require("./moment"),require("./butil"),require("./broad"),require("./beebrain")):t.bgraph=e(t.d3,t.moment,t.butil,t.broad,t.beebrain)}(this,function(t,e,a,r,n){"use strict";const l=Math.max,o=Math.min,i=Math.abs,s=Math.floor,d=Math.ceil,c=Math.round,u=365.25,h=86400;let p=1,f={noGraph:!1,divGraph:null,divTable:null,divPoints:null,divDueby:null,divData:null,divJSON:null,svgSize:{width:700,height:450},focusRect:{x:0,y:0,width:700,height:370},focusPad:{left:25,right:5,top:25,bottom:30},ctxRect:{x:0,y:370,width:700,height:80},ctxPad:{left:25,right:5,top:0,bottom:30},tableHeight:387,zoomButton:{size:40,opacity:.6,factor:1.5},bullsEye:{size:40,ctxsize:20},roadDot:{size:5,ctxsize:3,border:1.5,ctxborder:1},roadKnot:{width:3,rmbtnscale:.6},roadLine:{width:3,ctxwidth:2},oldRoadLine:{width:3,ctxwidth:2,dash:32,ctxdash:16},dataPoint:{size:5,fsize:5,hsize:2.5,border:1},horizon:{width:2,ctxwidth:1,dash:8,ctxdash:6,font:10,ctxfont:9},today:{width:2,ctxwidth:1,font:12,ctxfont:9},watermark:{height:170,fntsize:150,color:"#000000"},guidelines:{width:2,weekwidth:4},maxfluxline:4,stdfluxline:2,razrline:2,textBox:{margin:3},odomReset:{width:.5,dash:8},roadLineCol:{valid:"black",invalid:"#ca1212",selected:"yellow"},roadDotCol:{fixed:"darkgray",editable:"#c2c2c2",selected:"yellow"},roadKnotCol:{dflt:"#c2c2c2",selected:"yellow",rmbtn:"black",rmbtnsel:"red"},textBoxCol:{bg:"#ffffff",stroke:"#d0d0d0"},roadTableCol:{bg:"#ffffff",bgHighlight:"#fffb55",text:"#000000",textDisabled:"#aaaaaa",bgDisabled:"#f2f2f2"},dataPointCol:{future:"#909090",stroke:"#eeeeee"},halfPlaneCol:{fill:"#ffffe8"},pastBoxCol:{fill:"#f8f8f8",opacity:.5},odomResetCol:{dflt:"#c2c2c2"},headless:!1,scrollZoom:!0,buttonZoom:!0,roadEditor:!1,showContext:!1,showFocusRect:!1,showData:!0,maxDataDays:-1,maxFutureDays:365,keepSlopes:!0,showGuidelines:!0,keepIntervals:!1,reverseTable:!1,tableAutoScroll:!0,tableUpdateOnDrag:!1,duebyUpdateOnDrag:!0,tableCheckboxes:!0,onRoadChange:null,onDataEdit:null,dataTableSize:11,dataAutoScroll:!0,onError:null};const g={svgSize:{width:700,height:530},focusRect:{x:0,y:0,width:700,height:400},focusPad:{left:25,right:10,top:35,bottom:30},ctxRect:{x:0,y:400,width:700,height:80},ctxPad:{left:25,right:10,top:0,bottom:30},tableHeight:540,zoomButton:{size:50,opacity:.7,factor:1.5},bullsEye:{size:40,ctxsize:20},roadDot:{size:10,ctxsize:4,border:1.5,ctxborder:1},roadKnot:{width:7,rmbtnscale:.9},roadLine:{width:7,ctxwidth:2},oldRoadLine:{width:3,ctxwidth:1,dash:32,ctxdash:16},dataPoint:{size:4,fsize:6},horizon:{width:2,ctxwidth:1,dash:8,ctxdash:8,font:14,ctxfont:10},today:{width:2,ctxwidth:1,font:16,ctxfont:10},watermark:{height:150,fntsize:100,color:"#000000"},guidelines:{width:2,weekwidth:4},maxfluxline:4,stdfluxline:2,razrline:2,textBox:{margin:3}},v=".svg{shape-rendering:crispEdges}.axis path,.axis line{fill:none;stroke:black;shape-rendering:crispEdges}.axis .minor line{stroke:#777;stroke-dasharray:0,2,4,3}.grid line{fill:none;stroke:#dddddd;stroke-width:1px;shape-rendering:crispEdges}.aura{fill-opacity:0.3;stroke-opacity:0.3;}.aurapast{fill-opacity:0.15;stroke-opacity:0.3}.grid .minor line{stroke:none}.axis text{font-family:sans-serif;font-size:11px}.axislabel{font-family:sans-serif;font-size:11px;text-anchor:middle}circle.dots{stroke:black}line.roads{stroke:black}.pasttext,.ctxtodaytext,.ctxhortext,.horizontext,.hashtag{text-anchor:middle;font-family:sans-serif}.waterbuf,.waterbux{opacity:0.05882353;text-anchor:middle;font-family:Dejavu Sans,sans-serif}.loading{text-anchor:middle;font-family:Dejavu Sans,sans-serif}.zoomarea{fill:none}circle.ap{stroke:none}circle.rd{stroke:none;pointer-events:none;fill:"+a.Cols.ROSE+"}circle.std{stroke:none;pointer-events:none;fill:"+a.Cols.PURP+"}circle.hp{stroke:none;fill:"+a.Cols.WITE+"}.dp.gra,.ap.gra{fill:"+a.Cols.GRADOT+"}.dp.grn,.ap.grn{fill:"+a.Cols.GRNDOT+"}.dp.blu,.ap.blu{fill:"+a.Cols.BLUDOT+"}.dp.orn,.ap.orn{fill:"+a.Cols.ORNDOT+"}.dp.red,.ap.red{fill:"+a.Cols.REDDOT+"}.dp.blk,.ap.blk{fill:"+a.Cols.BLCK+"}.dp.fuda,.ap.fuda{fill-opacity:0.3}.guides{pointer-events:none;fill:none;stroke:"+a.Cols.LYEL+"}.ybhp{pointer-events:none}.rosy{fill:none;stroke:"+a.Cols.ROSE+";pointer-events:none}.steppy{fill:none;stroke:"+a.Cols.PURP+";pointer-events:none}.steppyppr{fill:none;stroke-opacity:0.8;stroke:"+a.Cols.LPURP+";pointer-events:none}.derails{fill:"+a.Cols.REDDOT+";pointer-events:none}.overlay .textbox{fill:#ffffcc;fill-opacity:0.5;stroke:black;stroke-width:1;pointer-events:none;rx:5;ry:5}",y=.015,m=1e3,x={beye:"https://s3.amazonaws.com/bmndr/road/bullseye.png",beyey:"https://s3.amazonaws.com/bmndr/road/bullseye_prev.png",infb:"https://bmndr.s3.amazonaws.com/road/infinity_blk.png",sklb:"https://bmndr.s3.amazonaws.com/road/jollyroger_blk.png",smlb:"https://bmndr.s3.amazonaws.com/road/smiley_blk.png"},b={NOBBFILE:0,BADBBFILE:1,BBERROR:2},w=["Could not find goal (.bb) file.","Bad .bb file.","Beeminder error"],k=()=>{if("undefined"==typeof navigator&&"undefined"==typeof window)return!1;var t=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0)}(navigator.userAgent||navigator.vendor||window.opera),t};return function(z){let T=((t,e)=>{t.opts||(t.opts=a.extend({},f,!0)),k()&&a.extend(t.opts,g);let r=a.extend(t.opts,e,!0);return r.divGraph=r.divGraph&&r.divGraph.nodeName?r.divGraph:null,r.headless?(r.divTable=null,r.divPoints=null,r.divDueby=null,r.divData=null,r.scrollZoom=!1,r.roadEditor=!1,r.showContext=!1,r.showFocusRect=!1):(r.divTable=r.divTable&&r.divTable.nodeName?r.divTable:null,r.divPoints=r.divPoints&&r.divPoints.nodeName?r.divPoints:null),r})(this,z),E=p;p++;let R,M,D,A,C,P,L,S,N,G,B,O,U,Y,K,V,H,I,j,F,Z,q,J,W,_,X,$,Q,tt,et,at,rt,nt,lt,ot,it,st,dt,ct,ut,ht,pt,ft,gt,vt,yt,mt,xt,bt,wt,kt,zt,Tt,Et,Rt,Mt,Dt,At,Ct,Pt,Lt,St,Nt,Gt,Bt,Ot,Ut,Yt,Kt,Vt,Ht,It,jt,Ft,Zt,qt,Jt,Wt,_t,Xt,$t=50,Qt=T.svgSize.width,te=T.svgSize.height,ee=T.zoomButton.size,ae=ee/540,re=1,ne=0,le=!0,oe=null,ie=[],se=[],de=!1,ce=!1,ue=!1,he=k(),pe=null,fe=[],ge={},ve={},ye=[],me=[],xe=[],be=[],we=[],ke=[];function ze(t){return void 0===ke[t]&&(ke[t]=r.isoline(ye,we,ve,t)),ke[t]}function Te(t){return c(10*t)/10}function Ee(t){return c(1e3*t)/1e3}function Re(){(ve={}).yaw=1,ve.dir=1,ve.tcur=0,ve.vcur=0;const t=e.utc();t.hour(0),t.minute(0),t.second(0),t.millisecond(0),ve.asof=t.unix(),ve.horizon=ve.asof+a.AKH,ve.xMin=ve.asof,ve.xMax=ve.horizon,ve.tmin=ve.asof,ve.tmax=ve.horizon,ve.yMin=-1,ve.yMax=1,ge=a.deepcopy(ve),ye=[],fe=[],me=[],be=[]}function Me(){D=a.extend({},T.focusPad),A=a.extend({},T.ctxPad),ve.stathead&&!T.roadEditor&&(D.top+=15),D.left+=$t,D.right+=$t+(ve.hidey?8:0),A.left+=$t,A.right+=$t+(ve.hidey?8:0),R={x:T.focusRect.x+D.left,y:T.focusRect.y+D.top,width:T.focusRect.width-D.left-D.right,height:T.focusRect.height-D.top-D.bottom},M={x:T.ctxRect.x+A.left,y:T.ctxRect.y+A.top,width:T.ctxRect.width-A.left-A.right,height:T.ctxRect.height-A.top-A.bottom},C={botin:"translate("+(R.width-2*(ee+5))+","+(R.height-(ee+5))+") scale("+ae+","+ae+")",botout:"translate("+(R.width-(ee+5))+","+(R.height-(ee+5))+") scale("+ae+","+ae+")",topin:"translate("+(R.width-2*(ee+5))+",5) scale("+ae+","+ae+")",topout:"translate("+(R.width-(ee+5))+",5) scale("+ae+","+ae+")"}}function De(t,e=-1,r="bold",n=null,l="overlay",o=!0,i=!1,s=null){if(null==T.divGraph)return;null==n&&(n={x:Qt/20,y:te/5,w:Qt-2*Qt/20,h:te-2*te/5}),null==s&&(s=P);var d=s.select("g."+l);d.empty()&&(d=s.append("g").attr("class",l),o&&d.append("svg:rect").attr("x",0).attr("y",0).attr("width",Qt).attr("height",te).style("fill",a.Cols.WITE).style("fill-opacity",.5),d.append("svg:rect").attr("class","textbox").attr("x",n.x).attr("y",n.y).attr("width",n.w).attr("height",n.h)),d.selectAll(".loading").remove();const c=t.length;e<0&&(e=te/15);var u=1.1*e;for(let a=0;a<c;a++)d.append("svg:text").attr("class","loading").attr("x",n.x+n.w/2).attr("y",n.y+n.h/2-(c-1)*u/2+a*u+e/2-3).attr("font-size",e).style("font-size",e).style("font-weight",r).text(t[a]);i&&d.style("opacity",0).transition().duration(200).style("opacity",1)}function Ae(t="overlay",e=!1,a=null){if(null!=T.divGraph){null==a&&(a=P);var r=a.selectAll("g."+t);e?r.style("opacity",1).transition().duration(200).style("opacity",0).remove():r.remove()}}function Ce(){if(null!==T.divGraph){var e=[H.invert(0),H.invert(R.width)];Me(),L.select("#plotclip"+E+" > rect").attr("width",R.width).attr("height",R.height),L.select("#brushclip"+E+" > rect").attr("width",M.width).attr("height",M.height),L.select("#buttonareaclip"+E+" > rect").attr("x",R.x).attr("y",0).attr("width",R.width).attr("height",R.height),Kt.attr("x",R.x).attr("y",R.y).attr("width",R.width).attr("height",R.height),Vt.extent([[0,0],[R.width,R.height]]).scaleExtent([1,1/0]).translateExtent([[0,0],[R.width,R.height]]),B.attr("transform","translate("+D.left+","+D.top+")"),Ht.attr("transform",C.botin),It.attr("transform",C.botout),V.range([0,R.width]),H.range([0,R.width]),Z.attr("transform","translate("+R.x+","+(D.top+R.height)+")").call(I.scale(H)),J.attr("transform","translate(0,"+R.height+")").call(F),q.attr("transform","translate("+R.x+","+D.top+")").call(j.scale(H)),Yt.select("rect").attr("width",R.width).attr("height",R.height),Yt.select("text").attr("x",R.width/2),W.range([0,R.height]),_.range([0,R.height]),Q.attr("transform","translate("+D.left+","+D.top+")").call(X.scale(_)),tt.attr("transform","translate("+(D.left+R.width)+","+D.top+")").call($.scale(_)),et.attr("transform","translate(15,"+(R.height/2+D.top)+") rotate(-90)"),Y.attr("transform","translate("+A.left+","+A.top+")"),at.range([0,M.width]),nt.attr("transform","translate("+M.x+","+(A.top+M.height)+")").call(rt),lt.range([M.height,0]),jt.extent([[0,0],[M.width,M.height]]),Ft.call(jt);var a=e.map(V);Kt.call(Vt.transform,t.zoomIdentity.scale(R.width/(a[1]-a[0])).translate(-a[0],0)),pa()}}Re(),Me();var Pe,Le,Se,Ne=!1,Ge=0,Be=-1;function Oe(){Le&&(Le.node().value=Ge)}function Ue(t){Ne=!0,Ge=parseInt(t),ta(),Ne=!1}function Ye(){if(!Ie){if(t.event.preventDefault(),t.event.deltaY<0){if(0==Ge)return;Ge-=1}else{if(Ge>=xe.length-T.dataTableSize)return;Ge+=1}Oe(),ta()}}let Ke=["id","dt","vl","cmt","mod","del"],Ve=["span","div","div","div","button","button"];let He=!1,Ie=null;function je(){return event.currentTarget.parentElement.getAttribute("id")}function Fe(){let t=je().match(/drow(\d+)/);return!t||t.length<2?null:t[1]}function Ze(){let t=Fe();if(!t)return null;let e=xe[t];return e[3]?e[3]:t}function qe(){let e=Fe();if(Ie){if(_e.changed){let r=Ze(),n=t.select(event.currentTarget.parentNode),l=a.dayparse(n.select(".dt").text(),"-"),o=n.select(".vl").text(),i=n.select(".cmt").text();isNaN(l)||isNaN(o)||e!=Ie||!T.onDataEdit||T.onDataEdit(r,[l,o,i])}Le.attr("disabled",null),Ie=null}else je(),Ie=e,Le.attr("disabled",!0),_e.field=null,_e.oldText=null,_e.changed=!1;ta()}function Je(){let t=Fe(),e=Ze();Ie&&Ie!=t||(T.onDataEdit&&T.onDataEdit(e,null),ta())}function We(){Le.attr("disabled",null),Ie=null,ta()}let _e={field:null,oldText:null,changed:!1};function Xe(e,a){if(T.onDataEdit&&0!=a&&!(a>3)){if(Ie){if(!e.edit)return}else qe();if(_e.field=t.select(this),_e.oldText=_e.field.text(),nn(),Number(_e.field.node().parentNode.id),1==a){var r=t.select(T.divData).select(".floating");ln(_e.field,null,null,r,Jt)}}}function $e(e,r){if(T.onDataEdit&&e.edit&&0!=r&&!(r>3)){Number(this.parentNode.id);var n=t.select(this).text();if(nn(),ar(),n!==_e.oldText&&(_e.changed=!0,null!=_e.oldText)){var l=1==r?a.dayparse(n,"-"):n;if(3!=r&&isNaN(l))return t.select(this).text(_e.oldText),_e.oldText=null,void(_e.field=null);_e.oldText=null,_e.field=null}}}function Qe(e,r){if(T.onDataEdit&&e.edit&&0!=r&&!(r>3)&&13==t.event.keyCode){this.blur();var n=t.select(this).text(),l=1==r?a.dayparse(n,"-"):n;if(3!=r&&isNaN(l))return t.select(this).text(_e.oldText),void(_e.oldText=null);_e.oldText=t.select(this).text(),t.event.ctrlKey&&qe()}}function ta(){if(He)return;if(He=!0,de)return;if(null===T.divData)return;Ne||(xe.length<=T.dataTableSize?Le.style("visibility","hidden"):Le.style("visibility","visible").attr("max",xe.length-T.dataTableSize).attr("value",0)),Se=Array(Math.min(xe.length,T.dataTableSize)).fill().map((t,e)=>e+Ge);let t=Pe.selectAll(".drow").data(Se);t.enter().append("div").attr("class","drow").attr("id",t=>"drow"+(xe.length-t-1)),t.exit().remove(),t.style("box-shadow",t=>t==Be?"0 0 0 4px yellow":null).attr("id",t=>"drow"+(xe.length-t-1)),Pe.selectAll(".drow").selectAll(".dcell").data((t,e)=>{if(t>=xe.length)return[null,null,null,null,null,null];t=xe.length-t-1;let r=a.dayify(a.dayparse(xe[t][0]),"-"),n=!!Ie&&t==Ie;return[{txt:t,clk:null,edit:n},{txt:r,clk:null,edit:n},{txt:xe[t][1],clk:null,edit:n},{txt:xe[t][2],clk:null,edit:n},{txt:n?'<img class="dicon" src="../src/check.svg"></img>':'<img class="dicon" src="../src/edit.svg" ></img>',clk:qe,edit:n},{txt:n?'<img class="dicon" src="../src/cancel.svg" ></img>':'<img class="dicon" src="../src/trash.svg"></img>',clk:n?We:Je,edit:n}]}).join(t=>t.append((t,e)=>(function(t){return document.createElementNS("http://www.w3.org/1999/xhtml",t)})(Ve[e])).attr("class",(t,e)=>"dcell "+Ke[e]).style("border",(t,e)=>0==e?"0":null).style("text-align",(t,e)=>0==e?"right":null).on("click",t=>t.clk?t.clk():null),t=>t).html(t=>t.txt).style("visibility",function(t){return"BUTTON"===this.tagName&&Ie&&!t.edit?"hidden":null}).attr("contenteditable",(t,e)=>!!T.onDataEdit&&e>0&&e<4).on("focusin",Xe).on("focusout",$e).on("keydown",Qe).style("opacity",t=>!Ie||t.edit?null:.2);let e=Pe.selectAll("button.dcell");T.onDataEdit?e.style("display",null):e.style("display","none"),He=!1}var ea;function aa(){if(de)return;if(null===T.divDueby)return;const t=a.nowstamp(ve.timezone,ve.deadline,ve.asof),n=a.dayparse(t)/h;let l=r.dueby(ye,ve,7);ea.selectAll(".dbrow").selectAll(".dbcell").data((t,r)=>{const o=function(t,r){const n=e.unix(ve.asof+t*h).utc(),l=a.dayparse(n.format("YYYYMMDD"))/h;if(l==r-1)return["Yesterday",a.Cols.REDDOT];if(l==r)return["Today",a.Cols.ORNG];if(l==r+1)return["Tomorrow",a.Cols.BLUDOT];const o=n.format("ddd (Do)");return l==r+2?[o,a.Cols.GRNDOT]:[o,a.Cols.BLCK]}(r,n),i=l[r][1];return[o,[i>0||ve.dir<0?a.shn(i):"&#10004;",o[1]],[a.shn(l[r][2]),o[1]]]}).join(t=>t.append("span").attr("class","dbcell"),t=>t).html(t=>t[0]).style("color",t=>t[1])}function ra(){ge.tini==fe[0].end[0]&&(ve.tini=ye[0].end[0],ve.vini=ye[0].end[1]),Dn||Xt.setRoadObj(ye),Aa(!0),pe=r.findSeg(ye,ve.horizon),va(),Cr(),Mn(!0),Rn(),En(),aa(),"function"==typeof T.onRoadChange&&T.onRoadChange.call()}function na(t,e,a,r,n=null){let l={};if(e<20-D.top&&(e=20-D.top),e>R.height-15&&(e=R.height-15),l.grp=G.append("g"),l.rect=l.grp.append("svg:rect").attr("pointer-events","none").attr("fill",T.textBoxCol.bg).style("stroke",r),l.text=l.grp.append("svg:text").attr("pointer-events","none").attr("text-anchor","middle"),null==n)l.text.text(a).attr("class","svgtxt");else{l.text.append("tspan").attr("x",0).attr("dy","0.6em").text(a).attr("class","svgtxt");for(var o=0;o<n.length;o++)l.text.append("tspan").attr("dy","1.2em").attr("x",0).text(n[o]).attr("font-size","0.7em")}var i=l.text.node().getBBox(),s=T.textBox.margin;return l.rect.attr("x",i.x-s).attr("y",i.y-s).attr("width",i.width+2*s).attr("height",i.height+2*s),t<i.width/2&&(t=i.width/2),t>R.width-i.width/2&&(t=R.width-i.width/2),l.grp.attr("transform","translate("+(t+D.left)+","+(e+D.top)+")"),l}function la(t,e,a,r){if(t){a<20-D.top&&(a=20-D.top),a>R.height-15&&(a=R.height-15),t.text.text(r);var n=t.text.node().getBBox(),l=T.textBox.margin;t.rect.attr("x",n.x-l).attr("y",n.y-l).attr("width",n.width+2*l).attr("height",n.height+2*l),e<n.width/2&&(e=n.width/2),e>R.width-n.width/2&&(e=R.width-n.width/2),t.grp.attr("transform","translate("+(e+D.left)+","+(a+D.top)+")")}else console.debug("updateTextBox: null input")}function oa(t){t?t.grp.remove():console.debug("updateTextBox: null input")}var ia,sa=1,da=7;function ca(){let e=V.domain(),r=e.map(t=>t.getTime()/m),n=r.slice();n[0]=a.monthsnap(n[0]);let l=r.slice();l[0]=a.yearsnap(l[0]);let o=n.map(t=>new Date(t*m)),i=l.map(t=>new Date(t*m));(ia=[]).push([t.utcDay.range(e[0],e[1],1),"%b %d"]),ia.push([t.utcDay.range(e[0],e[1],2),"%b %d"]),ia.push([t.utcWeek.range(o[0],o[1],1),"%b %d"]),ia.push([t.utcWeek.range(o[0],o[1],2),"%b %d"]),ia.push([t.utcMonth.every(1).range(i[0],i[1]),"%b %Y"]),ia.push([t.utcMonth.every(2).range(i[0],i[1]),"%b %Y"]),ia.push([t.utcMonth.every(3).range(i[0],i[1]),"%Y"]),ia.push([t.utcYear.every(1).range(i[0],i[1]),"%Y"])}function ua(){var e=[H.invert(0).getTime(),H.invert(R.width).getTime()],a=(e[1]-e[0])/(m*h);T.focusRect.width<500?a*=1.6:T.focusRect.width<550?a*=1.4:T.focusRect.width<600&&(a*=1.2),a<10?(sa=0,da=1):a<20?(sa=0,da=2):a<45?(sa=0,da=7):a<120?(sa=1,da=7):a<240?(sa=2,da=4):a<320?(sa=4,da=1):a<547.5?(sa=4,da=2):a<949?(sa=4,da=3):a<1825?(sa=5,da=3):a<3650?(sa=6,da=4):(sa=7,da=1);var r=ia[sa][0].filter(t=>t.getTime()<e[0]),n=(da-r.length%da)%da,l=ia[sa][0].filter(t=>t.getTime()>=e[0]&&t.getTime()<=e[1]);I.tickValues(l).tickSize(6).tickSizeOuter(0).tickFormat((e,a)=>t.utcFormat(a%da==n?ia[sa][1]:"")(e)),Z.call(I.scale(H)),Z.selectAll("g").classed("minor",!1),Z.selectAll("g").filter((t,e)=>e%da!=n).classed("minor",!0),Z.selectAll("g").selectAll(".tick line").attr("transform","translate(0,-5)"),F.tickValues(l).tickSize(R.width),J.call(F.scale(H)),J.selectAll("g").classed("minor",!1),J.selectAll("g").filter((t,e)=>e%da!=n).classed("minor",!0),j.tickValues(l).tickSize(6).tickSizeOuter(0).tickFormat((e,a)=>t.utcFormat(a%da==n?ia[sa][1]:"")(e)),q.call(j.scale(H)),q.selectAll("g").classed("minor",!1),q.selectAll("g").filter((t,e)=>e%da!=n).classed("minor",!0),q.selectAll("g").selectAll(".tick line").attr("transform","translate(0,6)")}function ha(){if(null!=T.divGraph&&!ue){et.text(ve.yaxis),ve.hidey&&!T.roadEditor?(Q.selectAll("text").attr("display","none"),tt.selectAll("text").attr("display","none")):(Q.selectAll("text").attr("display",null),tt.selectAll("text").attr("display",null));var t=Q.node().getBBox();i(t.width-$t)>5&&($t=s(t.width),Ce())}}function pa(){var e=[H.invert(0),H.invert(R.width)];let a;if(T.headless){let t=ve.vmin-y*(ve.vmax-ve.vmin);a=[ve.vmax+y*(ve.vmax-ve.vmin),t]}else{var r=i(y*(ve.vmax-ve.vmin)),n=e.map(t=>s(t.getTime()/m)),o=Ma(ye,n[0],n[1],!1);let t;if(o.yMin-=r,o.yMax+=r,T.roadEditor){var d=Ma(fe,n[0],n[1],!1);d.yMin-=r,d.yMax+=r,t=Ta(o,d)}else t=o;var c=Ra(ve.plotall&&!T.roadEditor?be:me,n[0],n[1],!1);let l;null!=c&&(t=Ta(t,c)),Ea(t,l=T.roadEditor?{xmin:0,xmax:0,ymin:.05,ymax:.05}:{xmin:0,xmax:0,ymin:.02,ymax:.02}),t.yMax-t.yMin<2*r&&(t.yMax+=r,t.yMin-=r),a=[t.yMax,t.yMin]}var u=t.zoomIdentity.scale(R.height/(W(a[1])-W(a[0]))).translate(0,-W(a[0]));_=u.rescaleY(W),Q.call(X.scale(_)),tt.call($.scale(_)),a[0]>ve.yMax&&(ve.yMax=a[0]),a[1]<ve.yMin&&(ve.yMin=a[1]),fa();var h=e.map(t=>at(t)),p=a.map(t=>lt(t));Zt.attr("x",h[0]+1).attr("width",l(0,h[1]-h[0]-2)).attr("y",p[0]+1).attr("height",l(0,p[1]-p[0]-2))}function fa(){null!=T.divGraph&&(at.domain([new Date(o(ve.tmin,ve.xMin)*m),new Date(l(ve.tmax,ve.xMax)*m)]),nt.call(rt.scale(at)),lt.domain([ve.yMin,ve.yMax]))}function ga(){if(null!=T.divGraph){var t=[at(H.invert(0)),at(H.invert(R.width))];t[0]<0&&(t[0]=0),t[1]>M.width&&(t[1]=M.width),Ft.call(jt.move,t)}}function va(){fa(),ga()}function ya(){if(!(0==ye.length||t.event&&t.event.sourceEvent&&"brush"===t.event.sourceEvent.type)){var e=t.zoomTransform(Kt.node());null!=e&&(H=e.rescaleX(V),ua(),pa(),Q.selectAll("g").selectAll(".tick line").attr("transform","translate(6,0)"),tt.selectAll("g").selectAll(".tick line").attr("transform","translate(-5,0)"),ha(),ga(),Mn())}}function ma(){if(0!=ye.length&&(!t.event.sourceEvent||"zoom"!==t.event.sourceEvent.type)){var e=t.event.selection||at.range();H.domain(e.map(at.invert,at)),ua(),pa(),ha(),Kt.call(Vt.transform,t.zoomIdentity.scale(M.width/(e[1]-e[0])).translate(-e[0],0)),Mn()}}function xa(){if(null!=T.divGraph){var e=ve.tmin-y*(ve.tmax-ve.tmin),a=ve.tmax+y*(ve.tmax-ve.tmin),r=[new Date(e*m),new Date(a*m)];H.domain(r);var n=r.map(at);ua(),pa(),Kt.call(Vt.transform,t.zoomIdentity.scale(M.width/(n[1]-n[0])).translate(-n[0],0))}}function ba(){null!=T.divGraph&&(Aa(!1),V.domain([new Date(o(ve.tmin,ve.xMin)*m),new Date(l(ve.tmax,ve.xMax)*m)]),ca(),W.domain([ve.yMin,ve.yMax]),H=V,_=W,fa(),Kt.call(Vt.transform,t.zoomIdentity),ve.dir>0?(Ht.attr("transform",C.botin),It.attr("transform",C.botout)):(Ht.attr("transform",C.topin),It.attr("transform",C.topout)),va())}function wa(){ie=[],se=[]}function ka(t=!1){0!=ie.length&&r.sameRoads(ie[ie.length-1],ye)||(ie.push(r.copyRoad(ye)),t||(se=[]))}function za(t){var e=fe,a=ve.asof,n=ve.horizon;if(ve.yaw*r.rdf(t,a)<ve.yaw*r.rdf(e,a)-1e-6)return!1;if(ve.yaw*r.rdf(t,n)<ve.yaw*r.rdf(e,n)-1e-6)return!1;var l=r.findSeg(t,a),o=r.findSeg(t,n);for(let a=l;a<o;a++)if(ve.yaw*r.rdf(t,t[a].end[0])<ve.yaw*r.rdf(e,t[a].end[0])-1e-6)return!1;var i=r.findSeg(e,a),s=r.findSeg(e,n);for(let a=i;a<s;a++)if(ve.yaw*r.rdf(t,e[a].end[0])<ve.yaw*r.rdf(e,e[a].end[0])-1e-6)return!1;return!0}function Ta(t,e){let a={};return a.xMin=o(t.xMin,e.xMin),a.xMax=l(t.xMax,e.xMax),a.yMin=o(t.yMin,e.yMin),a.yMax=l(t.yMax,e.yMax),a}function Ea(t,e){var a=t.xMax-t.xMin;a<1e-7&&(a=1e-7);var r=t.yMax-t.yMin;r<1e-7&&(r=1e-7),t.xMin=t.xMin-e.xmin*a,t.xMax=t.xMax+e.xmax*a,t.yMin=t.yMin-e.ymin*r,t.yMax=t.yMax+e.ymax*r}function Ra(t,e,n,i=!1){var s={},d=t.filter(t=>t[0]>e&&t[0]<n);if(0==d.length){var c=-1;for(let a=0;a<t.length-1;a++)if(t[a][0]<=e&&t[a+1][0]>=n){c=a;break}c>0&&(d=t.slice(c,c+1))}if(0==d.length)return null;if(s.xMin=a.arrMin(d.map(t=>t[0])),s.xMax=a.arrMax(d.map(t=>t[0])),s.yMin=a.arrMin(d.map(t=>t[1])),s.yMax=a.arrMax(d.map(t=>t[1])),null!=Xt.flad&&Xt.flad[0]<=n&&Xt.flad[0]>=e){const t=Xt.flad[1]+r.ppr(ye,ve,ve.asof);s.yMin=o(s.yMin,t),s.yMax=l(s.yMax,t)}return i&&Ea(s,{xmin:.1,xmax:.1,ymin:.1,ymax:.1}),s}function Ma(t,e,n,l=!1){var o={};return o.xMin=e,o.xMax=n,o.yMin=a.arrMin(t.map(function(t){return t.sta[0]<e||t.sta[0]>n?1/0:t.sta[1]})),o.yMax=a.arrMax(t.map(function(t){return t.sta[0]<e||t.sta[0]>n?-1/0:t.sta[1]})),o.yMin=a.arrMin([o.yMin,r.rdf(t,e),r.rdf(t,n)]),o.yMax=a.arrMax([o.yMax,r.rdf(t,e),r.rdf(t,n)]),l&&Ea(o,{xmin:.1,xmax:.1,ymin:.1,ymax:.1}),o}function Da(){var t,n;null==ve.waterbuf0&&(ve.safebuf=r.dtd(ye,ve,ve.tcur,ve.vcur),ve.tluz=ve.tcur+ve.safebuf*h,ve.tfin<ve.tluz&&(ve.tluz=a.BDUSK),ve.loser=r.redyest(ye,ve,ve.tcur),ve.asof>=ve.tfin&&!ve.loser?ve.waterbuf=":)":ve.safebuf>999?ve.waterbuf="inf":ve.safebuf>=7?ve.waterbuf=ve.safebuf+"d":ve.safebuf<=0?ve.waterbuf=(n=ve.deadline,e.unix(n).utc().format("h:mma").replace(":00","")+"!"):ve.waterbuf=(t=ve.tluz,e.unix(t).utc().format("ddd")))}function Aa(e=!0){if(0==ye.length)return;var r=ve.asof,n=a.daysnap(o(r+T.maxFutureDays*h,ye[ye.length-1].sta[0]));let i,s=Ma(ye,ye[0].end[0],n,!1);i=T.roadEditor?Ta(s,Ma(fe,ye[0].end[0],n,!1)):s;var d=Ra(ve.plotall&&!T.roadEditor?be:me,ye[0].end[0],me[me.length-1][0],!1);if(null!=d&&(i=Ta(i,d)),0!=Xt.fuda.length){var c=Ra(Xt.fuda,ye[0].end[0],n,!1);null!=c&&(i=Ta(i,c))}var u={xmin:.1,xmax:.1,ymin:.1,ymax:.1};if(T.roadEditor||(u.xmin=.02,u.xmax=.02),Ea(i,u),ve.xMin=a.daysnap(i.xMin),ve.xMax=a.daysnap(i.xMax),ve.yMin=i.yMin,ve.yMax=i.yMax,e&&null!=T.divGraph){var p=[H.invert(0),H.invert(R.width)];_.invert(0),_.invert(R.height),V.domain([new Date(o(ve.tmin,ve.xMin)*m),new Date(l(ve.tmax,ve.xMax)*m)]),ca(),W.domain([ve.yMin,ve.yMax]);var f=t.zoomIdentity.scale(R.width/(V(p[1])-V(p[0]))).translate(-V(p[0]),0);Kt.call(Vt.transform,f)}}function Ca(t,e,r=6e3){return a.linspace(t,e,s(a.clip((e-t)/(h+1),o(300,R.width/8),r)))}const Pa=`bgraph(${E}): Goal stats`,La=`bgraph(${E}): Goal graph`;function Sa(t,e=!0){if(!("params"in t&&"data"in t))throw new Error("loadGoal: JSON input lacks params or data");wa(),de=!0;let l=t.params.yoog?" ("+t.params.yoog+")":"";if(e&&console.time(Pa+l),Xt=new n(t),ve=Xt.gol,T.divJSON&&(T.headless?T.divJSON.innerText=JSON.stringify(Xt.getStats()):T.divJSON.innerText=JSON.stringify(Xt.getStats(),null,4)),e&&console.timeEnd(Pa+l),""!=ve.error){console.log("Beebrain error: "+Xt.gol.error),oe=b.BBERROR;var o=Xt.gol.error.split("\\n");return De(["The following errors prevented us from generating "+Xt.gol.yoog,"(We've pinged Beeminder support to come help fix things up here!)",""].concat(o),te/30,null),Re(),void(de=!1)}if(T.noGraph)return De(["Beebrain was called with 'NOGRAPH_*' as the slug","so no graph or thumbnail was generated, just this","static placeholder!"],te/30,null),Re(),void(de=!1);ye=Xt.roads,fe=r.copyRoad(ye),me=Xt.data,xe=a.deepcopy(t.data),ge=a.deepcopy(ve),be=Xt.alldata,T.maxDataDays<0?(Wt=me.slice(),_t=be.slice()):(Wt=me.filter(function(t){return t[0]>ve.asof-T.maxDataDays*h}),_t=be.filter(function(t){return t[0]>ve.asof-T.maxDataDays*h})),T.divGraph&&(!T.roadEditor&&ve.stathead?N.text(ve.graphsum):N.text("")),e&&console.time(La+l),Cr(),ba(),xa(),de=!1,En(),aa(),null!==T.divData&&(Ge=0,Ie=null,Le.attr("disabled",null),Oe(),ta()),Rn(),Ce(),function(){if(null!=T.divTable){var t,e,a="Daily Slope";"h"===ve.runits&&(a="Hourly Slope"),"d"===ve.runits&&(a="Daily Slope"),"w"===ve.runits&&(a="Weekly Slope"),"m"===ve.runits&&(a="Monthly Slope"),"y"===ve.runits&&(a="Yearly Slope"),T.roadEditor?(t=["","End Date","Value",a,"",""],e=["","Goal Date","Value",a,"",""]):(t=["","End Date","Value",a],e=["","Goal Date","Value",a]),Kr.selectAll("span.rdhdrcell").data(t).text(t=>t),Br.selectAll("span.rdhdrcell").data(t).text(t=>t),tn.selectAll("span.rdhdrcell").data(e).text(t=>t),zn()}}(),"function"==typeof T.onRoadChange&&T.onRoadChange.call(),e&&console.timeEnd(La+l)}function Na(e,n=null){var l=r.findSeg(ye,e);if(l>=0){var o={},i=a.daysnap(e+h/2),s=n;null==n&&(s=ye[l].sta[1]+ye[l].slope*(i-ye[l].sta[0])),ka(),o.sta=[i,s],0==l?(o.end=ye[l+1].sta.slice(),null!=n&&(o.end[1]=o.sta[1]+ye[l].slope*(o.end[0]-i)),ye[l].end=[i,s]):(l==ye.length-1?(o.end=ye[l].end.slice(),o.end[1]=s):(o.end=ye[l+1].sta.slice(),null!=n&&T.keepSlopes&&(o.end[1]=o.sta[1]+ye[l].slope*(o.end[0]-i))),ye[l].end=[i,s],ye[l].slope=r.segSlope(ye[l]),ye[l].sta[0]==ye[l].end[0]&&(ye[l].auto=r.RP.SLOPE)),o.slope=r.segSlope(o),o.auto=r.RP.VALUE,ye.splice(l+1,0,o),r.fixRoadArray(ye,T.keepSlopes?r.RP.VALUE:r.RP.SLOPE,!1),ra();let d=t.select(T.divTable).select(".roadrow [name=endvalue"+(l+1)+"]");d.empty()||gn(d,!1)}return l}function Ga(t,e){ka();var a=ye[t].slope;ye.splice(t,1),T.keepSlopes&&!isNaN(a)&&(ye[t].slope=a),r.fixRoadArray(ye,T.keepSlopes?r.RP.VALUE:r.RP.SLOPE,e),ra()}var Ba=null,Oa=null,Ua=null;function Ya(t,r){var n,l,o=H(a.daysnap(t[0])*m),i=t[1];if(ja=e.unix(t[0]).utc(),Ba=na(o,R.height-15,ja.format("YYYY-MM-DD")+" ("+ja.format("ddd")+")",T.textBoxCol.stroke),Oa=na(o,_(i)-15,a.shn(t[1]),T.textBoxCol.stroke),null!=r){var s=H(a.daysnap(r[0])*m),d=_(r[1]);Ua=na(s,d,"s:"+a.shn(r[2]),T.textBoxCol.stroke),o-s<50&&(l=!0,(n=Ua)?n.grp.attr("visibility",l?"hidden":"visible"):console.debug("updateTextBox: null input"))}}function Ka(t,r){var n=a.daysnap(t[0]),l=t[1];if(ja=e.unix(n).utc(),la(Ba,H(n*m),R.height-15,ja.format("YYYY-MM-DD")+" ("+ja.format("ddd")+")"),la(Oa,H(n*m),_(l)-15,a.shn(t[1])),null!=r){var o=a.daysnap(r[0]),i=r[1];la(Ua,H(o*m),_(i),"s:"+a.shn(r[2]))}}function Va(){null!=Ba&&oa(Ba),Ba=null,null!=Oa&&oa(Oa),Oa=null,null!=Ua&&oa(Ua),Ua=null}function Ha(e,r){var n=ye,l=t.select(T.divGraph);for(let t=e;t<n.length;t++)l.select("[name=dot"+t+"]").attr("cx",Te(H(n[t].end[0]*m))).attr("cy",Te(_(n[t].end[1]))),l.select("[name=ctxdot"+t+"]").attr("cx",Te(at(n[t].end[0]*m))).attr("cy",Te(lt(n[t].end[1]))),l.select("[name=road"+t+"]").attr("x1",Te(H(n[t].sta[0]*m))).attr("y1",Te(_(n[t].sta[1]))).attr("x2",Te(H(n[t].end[0]*m))).attr("y2",Te(_(n[t].end[1]))),l.select("[name=ctxroad"+t+"]").attr("x1",Te(at(n[t].sta[0]*m))).attr("y1",Te(lt(n[t].sta[1]))).attr("x2",Te(at(n[t].end[0]*m))).attr("y2",Te(lt(n[t].end[1]))),r&&(l.select("[name=knot"+t+"]").attr("x1",Te(H(n[t].end[0]*m))).attr("x2",Te(H(n[t].end[0]*m))),l.select("[name=remove"+t+"]").attr("transform",t=>"translate("+(H(t.end[0]*m)+D.left-8)+","+(D.top-20)+") scale(0.6,0.6)")),l.select("[name=enddate"+t+"]").text(a.dayify(n[t].end[0],"-")),l.select("[name=endvalue"+t+"]").text(a.shn(n[t].end[1])),l.select("[name=slope"+t+"]").text(a.shn(n[t].slope*ve.siru));T.tableUpdateOnDrag&&Tn(),T.duebyUpdateOnDrag&&aa(),Cr(),Pr(),gr(),pr(),fr(),Wr(),_r(),yr(),Er(),mr(),Rr(),Mr()}var Ia,ja,Fa,Za=null,qa=null,Ja=null;function Wa(e,a=!0){if(null!=T.divGraph){vn(e,!0,a),Za=e,qa=r.RP.DATE,t.select("[name=knot"+e+"]").attr("stroke-width",Ee(T.roadKnot.width));var n=H(ye[e].end[0]*m);Ja=bt.append("svg:line").attr("class","selectedknot").attr("pointer-events","none").attr("x1",n).attr("x2",n).attr("y1",0).attr("y2",R.height).attr("stroke",T.roadKnotCol.selected).attr("stroke-opacity",.9).attr("stroke-width",Ee(T.roadKnot.width+4)).lower()}}function _a(e){vn(e,!1),t.select("[name=knot"+e+"]").attr("stroke",T.roadKnotCol.dflt).attr("stroke-width",Ee(T.roadKnot.width))}function Xa(e,a=!0){null!=T.divGraph&&(yn(e,!0,a),Za=e,qa=r.RP.VALUE,t.select("[name=dot"+e+"]").attr("r",Ee(T.roadDot.size)),Ja=Nt.append("svg:circle").attr("class","selecteddot").attr("pointer-events","none").attr("cx",Te(H(ye[e].end[0]*m))).attr("cy",Te(_(ye[e].end[1]))).attr("fill",T.roadDotCol.selected).attr("fill-opacity",.6).attr("r",Ee(T.roadDot.size+4)).attr("stroke","none").lower())}function $a(e){yn(e,!1),t.select("[name=dot"+e+"]").attr("fill",T.roadDotCol.editable).attr("r",Ee(T.roadDot.size))}function Qa(e,a=!0){null!=T.divGraph&&(mn(e,!0,a),Za=e,qa=r.RP.SLOPE,t.select("[name=road"+e+"]").attr("shape-rendering","geometricPrecision").attr("stroke-width",(T.roadLine.width,3)),Ja=St.append("svg:line").attr("class","selectedroad").attr("shape-rendering","geometricPrecision").attr("pointer-events","none").attr("x1",H(ye[e].sta[0]*m)).attr("x2",H(ye[e].end[0]*m)).attr("y1",_(ye[e].sta[1])).attr("y2",_(ye[e].end[1])).attr("stroke",T.roadKnotCol.selected).attr("stroke-opacity",.9).attr("stroke-width",Ee(T.roadLine.width+4)).lower())}function tr(e){mn(e,!1);var a=za(ye)?T.roadLineCol.valid:T.roadLineCol.invalid;t.select("[name=road"+e+"]").style("stroke",a).attr("stroke-width",Ee(T.roadLine.width))}function er(){Za=null,qa=null,null!=Ja&&(Ja.remove(),Ja=null)}function ar(){null!=Za&&(qa==r.RP.DATE?_a(Za):qa==r.RP.VALUE?$a(Za):qa==r.RP.SLOPE&&tr(Za),Va(),er())}var rr=!1;function nr(e,a){t.event.sourceEvent.stopPropagation(),rr=!0,ka();var n=Number(this.id);Ia=r.copyRoad(ye),null==Za?Wa(n):null!=Za&&Za==n&&qa==r.RP.DATE?ar():(ar(),Wa(n)),Ya(e.end),Ba.grp.raise(),(Fa=[])[0]=ye[n].slope,Fa[1]=ye[n+1].slope}function lr(e,n){er();var l=a.daysnap(H.invert(t.event.x)/m),o=Number(this.id),i=ye;l<i[o].sta[0]&&(l=i[o].sta[0]),l>i[o+1].end[0]&&(l=i[o+1].end[0]);var s=o+1;T.keepIntervals&&(s=i.length);for(let t=o;t<s;t++)i[t].end[0]=l+Ia[t].end[0]-Ia[o].end[0];isFinite(Fa[0])&&ye[o].sta[0]!=ye[o].end[0]&&(ye[o].slope=Fa[0]),isFinite(Fa[1])&&ye[o+1].sta[0]!=ye[o+1].end[0]&&(ye[o+1].slope=Fa[1]),r.fixRoadArray(i,T.keepSlopes?r.RP.VALUE:r.RP.SLOPE,!1,r.RP.DATE),Ha(o,!0),Ka(e.end)}function or(t,e){rr=!1,null==Za&&(_a(e),Va(),ra()),Ia=null}function ir(t){Ga(Number(this.id),!1)}var sr=!1;var dr=!1;var cr={buf:!1,bux:!1,aura:!1,aurap:!1,hor:!1,hort:!1,ybr:!1,ybrc:!1,guides:!1,rosy:!1,rosyd:!1,data:!1,dataa:!1,mav:!1};function ur(t,e,a,r,n){var l,o=t.transition().duration(e);for(l=0;l<a.length;l++)o=o.attr(a[l][0],a[l][1]);for(l=0;l<r.length;l++)o=o.style(r[l][0],r[l][1]);for(o=o.transition().duration(e),l=0;l<a.length;l++)o=o.attr(a[l][0],a[l][2]);for(l=0;l<r.length;l++)o=o.style(r[l][0],r[l][2]);o.on("end",()=>{cr[n]&&ur(t,e,a,r,n)}),cr[n]=!0}function hr(t,e,a,r,n){cr[n]=!1;var l=t.transition().duration(e);for(let t=0;t<a.length;t++)l=l.attr(a[t][0],a[t][2]);for(let t=0;t<r.length;t++)l=l.style(r[t][0],r[t][2]);l.on("end",()=>{cr[n]=!1})}function pr(){if(!de&&null!=T.divGraph&&0!=ye.length){var t=Lt.select(".bullseye"),e=H(ve.tfin*m)-T.bullsEye.size/2,a=_(r.rdf(ye,ve.tfin))-T.bullsEye.size/2;t.empty()?Lt.append("svg:image").attr("class","bullseye").attr("xlink:href",x.beye).attr("externalResourcesRequired",!0).attr("x",e).attr("y",a).attr("width",T.bullsEye.size).attr("height",T.bullsEye.size):t.attr("x",e).attr("y",a)}}function fr(){if(!de&&null!=T.divGraph&&0!=ye.length){var t=K.select(".ctxbullseye");if(T.roadEditor){var e=at(ve.tfin*m)-T.bullsEye.ctxsize/2,a=lt(r.rdf(ye,ve.tfin))-T.bullsEye.ctxsize/2;t.empty()?K.append("svg:image").attr("class","ctxbullseye").attr("xlink:href",x.beyey).attr("externalResourcesRequired",!0).attr("x",e).attr("y",a).attr("width",T.bullsEye.ctxsize).attr("height",T.bullsEye.ctxsize):t.attr("x",e).attr("y",a)}else t.remove()}}function gr(){if(!de&&null!=T.divGraph&&0!=ye.length&&!ue){var t,e,a,r,n,l,o,i=[0,0],s=[0,R.height/2],d=[R.width/2,0],c=[R.width/2,R.height/2],u=null;Da(),ve.loser&&(u=x.sklb),"inf"===ve.waterbuf?u=x.infb:":)"===ve.waterbuf&&(u=x.smlb),ve.dir>0&&ve.yaw<0?(t=c,e=i):ve.dir<0&&ve.yaw>0?(t=d,e=s):ve.dir<0&&ve.yaw<0?(t=s,e=d):(t=i,e=c),le=!1;var h=Gt.select(".waterbuf"),p=T.watermark.fntsize,f=T.watermark.height;h.remove(),null!=u?(a=(R.width/2-f)/2,r=(R.height/2-f)/2,h=Gt.append("svg:image").attr("class","waterbuf").attr("xlink:href",u).attr("externalResourcesRequired",!0).attr("width",f).attr("height",f).on("load",()=>{le=!0})):(a=R.width/4,r=R.height/4+p/3,(n=(h=Gt.append("svg:text").attr("class","waterbuf").style("font-size",p+"px").style("font-weight","bolder").style("fill",T.watermark.color).text(ve.waterbuf)).node().getBBox()).width>R.width/2.2&&(o=(l=p*(R.width/2.2)/n.width)/p*n.height,r=R.height/4+o/3,h.style("font-size",l+"px")),le=!0),h.attr("x",a+t[0]).attr("y",r+t[1]);var g=Gt.select(".waterbux");g.remove(),T.roadEditor?g.remove():(a=R.width/4,r=R.height/4+p/3,(n=(g=Gt.append("svg:text").attr("class","waterbux").style("font-size",p+"px").style("font-weight","bolder").style("fill",T.watermark.color).text(ve.waterbux)).node().getBBox()).width>R.width/2.2&&(o=(l=p*(R.width/2.2)/n.width)/p*n.height,r=R.height/4+o/3,g.style("font-size",l+"px")),g.attr("x",a+e[0]).attr("y",r+e[1]))}}function vr(){if(!de&&null!=T.divGraph&&0!=ye.length&&!ue){var t=Rt.selectAll(".aura"),e=Rt.selectAll(".aurapast");if(ve.aura&&T.showData){var r,n,i=o(0,-ve.stdflux),s=l(0,ve.stdflux),d=y*(ve.tmax-ve.tmin),c=[H.invert(0).getTime()/m,H.invert(R.width).getTime()/m];r=Ca(l(c[0],ve.tmin),a.arrMin([c[1],ve.asof+a.AKH,ve.tmax+d]),R.width/8);var u="M"+Te(H(r[0]*m))+" "+Te(_(ve.auraf(r[0])+s));for(n=1;n<r.length;n++)u+=" L"+Te(H(r[n]*m))+" "+Te(_(ve.auraf(r[n])+s));for(n=r.length-1;n>=0;n--)u+=" L"+Te(H(r[n]*m))+" "+Te(_(ve.auraf(r[n])+i));if(u+=" Z",t.empty()?Rt.append("svg:path").attr("class","aura").attr("d",u).style("fill",a.Cols.LPURP).style("stroke-width",2).style("stroke",a.Cols.LPURP):t.attr("d",u),c[0]<ve.tmin){for(r=Ca(c[0],ve.tmin,R.width/8),u="M"+Te(H(r[0]*m))+" "+Te(_(ve.auraf(r[0])+s)),n=1;n<r.length;n++)u+=" L"+Te(H(r[n]*m))+" "+Te(_(ve.auraf(r[n])+s));for(n=r.length-1;n>=0;n--)u+=" L"+Te(H(r[n]*m))+" "+Te(_(ve.auraf(r[n])+i));u+=" Z",e.empty()?Rt.append("svg:path").attr("class","aurapast").attr("d",u).style("fill",a.Cols.LPURP).style("stroke-width",2).style("stroke-dasharray","4,4").style("stroke",a.Cols.LPURP):e.attr("d",u)}else e.remove()}else t.remove(),e.remove()}}function yr(){if(de||null==T.divGraph||0==ye.length)return;const e=t.selectAll("#svg"+E+" #ybhpgrp path"),n=t.selectAll("#svg"+E+" #ybhplinesgrp path"),o=e.size()+n.size(),i=[ve.tini,ve.tfin],s=(ve.asof,ve.asof,a.Cols.RAZR3),d=a.Cols.RAZR2,c=a.Cols.RAZR1,u=(ve.tfin-ve.tini)/h,p=[[0,2,"#ffff88","none",0,.72,i],[u,-1,"#ffffbd","none",0,.72,i]],f=[[6,6,"none",s,.99,1,i],[2,2,"none",d,.99,1,i],[1,1,"none",c,.99,1,i],[0,2,"#ffff88","none",0,.72,i],[u,-1,"#ffffbd","none",0,.72,i]];let g;g=ve.maxflux>0?p:f;for(var v=0;v<l(o,g.length);v++){const t="halfplane"+v,e=g[v];if(null==e||null==e[2]&&null==e[3]){it.select("."+t).remove(),st.select("."+t).remove();continue}let a,n;e[0]!=e[1]?(n=it,st.select("."+t).remove()):(n=st,it.select("."+t).remove()),a=n.select("."+t);const l="r"+e[0]+e[1],o=ve.yaw*e[4]/2;let i=e[6];null==i&&(i=[-1/0,1/0]);const s=e[0],d=e[1];if(s<0){console.log("updateYBHP(): Invalid region definition");continue}let c,u,h=ye[0].end[0],p=ye[ye.length-1].sta[0];h<i[0]&&(h=i[0]),p>i[1]&&(p=i[1]),ve.yaw<0?(c=ve.yMin-.1*(ve.yMax-ve.yMin),u=ve.yMax+.1*(ve.yMax-ve.yMin)):(c=ve.yMax+.1*(ve.yMax-ve.yMin),u=ve.yMin-.1*(ve.yMax-ve.yMin));const f=ze(s);let y=f[0][0],x=f[0][1];y<h&&(y=h,x=r.isoval(f,y));let b="M"+Te(H(y*m))+" "+Te(_(x)+o);for(let t=1;t<f.length&&(y=f[t][0],x=f[t][1],y<h||(y>p&&(y=p,x=r.isoval(f,y)),b+=" L"+Te(H(y*m))+" "+Te(_(x)+o),!(f[t][0]>p)));t++);if(-1==d)b+=" L"+Te(H(p*m))+" "+Te(_(r.isoval(f,p))+o),b+=" L"+Te(H(p*m))+" "+Te(_(c)),b+=" L"+Te(H(h*m))+" "+Te(_(c)),b+=" Z";else if(-2==d)b+=" L"+H(p*m)+" "+Te(_(r.isoval(f,p))+o),b+=" L"+Te(H(p*m))+" "+Te(_(u)),b+=" L"+Te(H(h*m))+" "+Te(_(u)),b+=" Z";else if(s!=d){const t=ze(d),e=t.length;let a=t[e-1][0],n=t[e-1][1];a>p&&(a=p,n=r.isoval(t,a)),b+=" L"+Te(H(a*m))+" "+Te(_(n)+o);for(let l=e-2;l>=0&&(a=t[l][0],n=t[l][1],a>p||(a<h&&(a=h,n=r.isoval(t,a)),b+=" L"+Te(H(a*m))+" "+Te(_(n)+o),!(t[l][0]<h)));l--);b+=" Z"}a.empty()?n.append("svg:path").attr("class","ybhp "+t).attr("id",l).attr("d",b).attr("fill",e[2]).attr("fill-opacity",e[5]).attr("stroke",e[3]).attr("stroke-width",e[4]):a.attr("d",b).attr("id",l).attr("fill",e[2]).attr("fill-opacity",e[5]).attr("stroke",e[3]).attr("stroke-width",e[4])}}function mr(){if(de||null==T.divGraph||0==ye.length)return;const e=dt.select(".pinkregion"),n=za(ye);let l=fe;T.roadEditor||(l=ye);const o=ve.asof,i=ve.horizon;let s;s=ve.yaw>0?ve.yMin-5*(ve.yMax-ve.yMin):ve.yMax+5*(ve.yMax-ve.yMin);const d="url(#pinkzonepat"+E+")",c=t.select(" #pinkzonepat"+E+" rect"),u=t.select(" #pinkzonepat"+E+" line");c.attr("fill",n||!T.roadEditor?a.Cols.PINK:"#ffbbbb"),u.style("stroke",n||!T.roadEditor?"#aaaaaa":"#666666");const h=r.findSeg(l,o),p=r.findSeg(l,i);let f="M"+H(o*m)+" "+_(r.rdf(l,o));for(let t=h;t<p;t++)f+=" L"+H(l[t].end[0]*m)+" "+_(l[t].end[1]);f+=" L"+H(i*m)+" "+_(r.rdf(l,i)),f+=" L"+H(i*m)+" "+_(s),f+=" L"+H(o*m)+" "+_(s),f+=" Z",ct.attr("patternTransform",ve.dir>0?"rotate(135)":"rotate(45)").attr("x",-ve.dir*H(o*m)),e.empty()?dt.append("svg:path").attr("class","pinkregion").attr("d",f).attr("fill-opacity",.4).attr("fill",d):e.attr("d",f).attr("fill",d)}function xr(t,e,n,l,o,i){if(de||null==T.divGraph||0==ye.length)return;const s=n.select("."+l);if(null==o)return void s.remove();const c=T.oldRoadLine.dash+","+d(T.oldRoadLine.dash/2),u=i?c:null;let h=H(t[0].sta[0]*m),p=_(t[0].sta[1]+o),f=H(t[0].end[0]*m),g=_(t[0].end[1]+o);if(t[0].sta[0]<e.tini&&(h=H(e.tini*m),p=_(r.rdf(t,e.tini)+o)),i){const t=-H(e.tini*m)%d(1.5*T.oldRoadLine.dash);f!==h&&(p+=(-t-h)*(g-p)/(f-h)),(h<0||t>0)&&(h=-t)}let v="M"+Te(h)+" "+Te(p);for(const r of t){let t=a.daysnap(r.end[0]);if(f=H(r.end[0]*m),!(t<e.tini)){if(t>e.tfin)break;if(g=_(r.end[1]+o),v+=" L"+Te(f)+" "+Te(g),f>R.width)break}}s.empty()?n.append("svg:path").attr("class",l).attr("d",v).style("stroke-dasharray",u):s.attr("d",v).style("stroke-dasharray",u)}function br(t,e){let a=[t[1][0]-t[0][0],t[1][1]-t[0][1]];const r=1/a[0],n=1/a[1],l=Math.sign(r),o=Math.sign(n),i=(e[0]-l*e[2]-t[0][0])*r,s=(e[1]-o*e[3]-t[0][1])*n,d=(e[0]+l*e[2]-t[0][0])*r,c=(e[1]+o*e[3]-t[0][1])*n;return!(i>c||s>d||(i>s?i:s)>1||(d<c?d:c)<0)}function wr(t,e){if(!t||!t.length)return!1;const r=e[0]-e[2],n=e[0]+e[2];let l=a.searchLow(t,t=>t[0]<r?-1:1),o=a.searchLow(t,t=>t[0]<n?-1:1);l<0&&(l=0),o>t.length-2&&(o=t.length-2);for(let a=l;a<=o;a++)if(br([t[a],t[a+1]],e))return!0;return!1}let kr,zr=-1;function Tr(t){const e=ze(t),n=[H.invert(0)/m,H.invert(R.width)/m],s=[_.invert(R.height),_.invert(0)],c=[(n[0]+n[1])/2,(s[0]+s[1])/2,(n[1]-n[0])/2,(s[1]-s[0])/2];if(t!=zr&&(zr=t,kr=Array(d(t)).fill().map((t,e)=>e)),wr(e,c)){const t=a.searchHigh(kr,t=>!function(t,e,n){if(!(t&&t.length&&e&&e.length))return!1;const l=n[0]-n[2],o=n[0]+n[2];if(i(r.isoval(t,l)-r.isoval(e,l))>1e-5||i(r.isoval(t,o)-r.isoval(e,o))>1e-5)return!1;let s=a.searchHigh(t,t=>t[0]<l?-1:1),d=a.searchLow(t,t=>t[0]<o?-1:1),c=a.searchHigh(e,t=>t[0]<l?-1:1),u=a.searchLow(e,t=>t[0]<o?-1:1);for(let a=s;a<d;a++)if(i(r.isoval(e,t[a][0])-t[a][1])>1e-5)return!1;for(let a=c;a<u;a++)if(i(r.isoval(t,e[a][0])-e[a][1])>1e-5)return!1;return!0}(e,ze(t),c)?-1:1);return o(t,kr.length-1)}const u=a.searchLow(kr,t=>wr(ze(t),c)?-1:1);return l(u,0)}function Er(){if(de||null==T.divGraph||0==ye.length)return;let t=gt.selectAll(".guides");if(T.roadEditor&&!T.showGuidelines)return void t.remove();let e=1;const n=[H.invert(0)/m,H.invert(R.width)/m],s=(t,e)=>(function(t,e){const n=ze(t);null==e&&(e=[-1/0,1/0]);let l=n[0][0],o=n[0][1];l<e[0]&&(l=e[0],o=r.isoval(n,l));let i="M"+Te(H(l*m))+" "+Te(_(o)),s=a.searchHigh(n,t=>t[0]<e[0]?-1:1),d=a.searchHigh(n,t=>t[0]<e[1]?-1:1);d>n.length-1&&(d=n.length-1);for(let t=s;t<=d;t++)i+=" L"+Te(H(n[t][0]*m))+" "+Te(_(n[t][1]));return i})(t,[l(ve.tini,n[0]),o(ve.tfin,n[1])]),c=function(t){let e=0;const a=o(T.maxFutureDays,d((ve.tfin-ve.tini)/h)),n=ze(0),l=ze(a);return e=ve.yaw*ve.dir>0?i(r.isoval(n,t[0])-r.isoval(l,t[0]))/a:i(r.isoval(n,t[1])-r.isoval(l,t[1]))/a}(n),u=i(_(0)-_(c));let p=Tr((ve.tfin-ve.tini)/h);p=d(p/(e=u>8||p<42?1:7*u>8||p<168?7:28*u>12||p<672?28:112*u>12||p<2016?112:336));let f=kr.slice(0,p+1).map(t=>(t+1)*e-1);(t=t.data(f)).exit().remove(),t.enter().append("svg:path").attr("class","guides").attr("d",s).attr("id",t=>"g"+t).attr("transform",null),t.attr("d",s).attr("id",t=>"g"+t).attr("transform",null)}function Rr(){de||null==T.divGraph||0==ye.length||xr(ye,ve,vt,"maxflux",0!=ve.maxflux?ve.yaw*ve.maxflux:null,!1)}function Mr(){de||null==T.divGraph||0==ye.length||xr(ye,ve,yt,"stdflux",0!=ve.maxflux?ve.yaw*ve.stdflux:null,!0)}function Dr(){if(!de&&null!=T.divGraph&&0!=ye.length){var e=bt.selectAll(".knots").data(ye),a=S.selectAll(".remove").data(ye);if(!T.roadEditor)return e.remove(),void a.remove();e.exit().remove(),e.attr("x1",function(t){return H(t.end[0]*m)}).attr("y1",0).attr("x2",function(t){return H(t.end[0]*m)}).attr("y2",R.height).attr("stroke","rgb(200,200,200)").attr("stroke-width",T.roadKnot.width),e.enter().append("svg:line").attr("class","knots").attr("id",function(t,e){return e}).attr("name",function(t,e){return"knot"+e}).attr("x1",function(t){return H(t.end[0]*m)}).attr("x2",function(t){return H(t.end[0]*m)}).attr("stroke","rgb(200,200,200)").attr("stroke-width",T.roadKnot.width).on("wheel",function(e){var a=new t.event.constructor(t.event.type,t.event);Kt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseover",function(e,a){rr||sr||dr||qa==r.RP.DATE&&a==Za||(vn(a,!0),t.select(this).attr("stroke-width",T.roadKnot.width+2))}).on("mouseout",function(e,a){rr||sr||dr||qa==r.RP.DATE&&a==Za||(vn(a,!1),t.select(this).attr("stroke-width",T.roadKnot.width))}).on("click",function(e,a){t.event.ctrlKey&&function(e,a){var n=Number(a),l=t.select(T.divTable);ye[n].auto==r.RP.DATE&&(T.keepSlopes?xn(a):bn(a));var o,i,s=l.select("[name=enddate"+n+"]").node();s.focus(),document.body.createTextRange?((o=document.body.createTextRange()).moveToElementText(s),o.select()):window.getSelection&&(i=window.getSelection(),(o=document.createRange()).selectNodeContents(s),i.removeAllRanges(),i.addRange(o))}(0,this.id)}).call(t.drag().on("start",nr).on("drag",lr).on("end",or)),a.exit().remove(),a.attr("transform",function(t){return"translate("+(H(t.end[0]*m)+D.left-14*T.roadKnot.rmbtnscale)+","+(D.top-28*T.roadKnot.rmbtnscale-3)+") scale("+T.roadKnot.rmbtnscale+")"}).style("visibility",function(t,e){return e>0&&e<ye.length-2?"visible":"hidden"}),a.enter().append("use").attr("class","remove").attr("xlink:href","#removebutton").attr("id",function(t,e){return e}).attr("name",function(t,e){return"remove"+e}).attr("transform",function(t){return"translate("+(H(t.end[0]*m)+D.left-14*T.roadKnot.rmbtnscale)+","+(D.top-28*T.roadKnot.rmbtnscale-3)+") scale("+T.roadKnot.rmbtnscale+")"}).style("visibility",function(t,e){return e>0&&e<ye.length-2?"visible":"hidden"}).on("mouseenter",function(e,a){t.select(this).attr("fill",T.roadKnotCol.rmbtnsel),vn(a,!0)}).on("mouseout",function(e,a){t.select(this).attr("fill",T.roadKnotCol.rmbtns),vn(a,!1)}).on("click",ir)}}function Ar(){if(!de&&null!=T.divGraph&&0!=ye.length){var e=St.selectAll(".roads").data(ye);T.roadEditor?(e.exit().remove(),e.attr("x1",function(t){return H(t.sta[0]*m)}).attr("y1",function(t){return _(t.sta[1])}).attr("x2",function(t){return H(t.end[0]*m)}).attr("y2",function(t){return _(t.end[1])}).attr("stroke-dasharray",function(t,e){return 0==e||e==ye.length-1?"3,3":"none"}).style("stroke",T.roadLineCol.invalid),e.enter().append("svg:line").attr("class","roads").attr("id",function(t,e){return e}).attr("name",function(t,e){return"road"+e}).attr("x1",function(t){return H(t.sta[0]*m)}).attr("y1",function(t){return _(t.sta[1])}).attr("x2",function(t){return H(t.end[0]*m)}).attr("y2",function(t){return _(t.end[1])}).style("stroke",T.roadLineCol.invalid).attr("stroke-dasharray",function(t,e){return 0==e||e==ye.length-1?"3,3":"none"}).attr("stroke-width",T.roadLine.width).on("wheel",function(e){var a=new t.event.constructor(t.event.type,t.event);Kt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseover",function(e,a){rr||sr||dr||qa==r.RP.SLOPE&&a==Za||a>0&&a<ye.length-1&&(t.select(this).attr("stroke-width",T.roadLine.width+2),mn(a,!0))}).on("mouseout",function(e,a){rr||sr||dr||qa==r.RP.SLOPE&&a==Za||a>0&&a<ye.length-1&&(t.select(this).attr("stroke-width",T.roadLine.width),mn(a,!1))}).on("click",function(e,a){t.event.ctrlKey&&function(e,a){var n=Number(a),l=t.select(T.divTable);e.auto==r.RP.SLOPE&&xn(a);var o,i,s=l.select("[name=slope"+n+"]").node();s.focus(),document.body.createTextRange?((o=document.body.createTextRange()).moveToElementText(s),o.select()):window.getSelection&&(i=window.getSelection(),(o=document.createRange()).selectNodeContents(s),i.removeAllRanges(),i.addRange(o))}(e,this.id)}).call(t.drag().on("start",function(e,n){n>0&&n<ye.length-1&&function(e,n){t.event.sourceEvent.stopPropagation(),dr=!0,a.daysnap(H.invert(t.event.x)/m),ka(),Ia=r.copyRoad(ye),null==Za?Qa(n):null!=Za&&Za==n&&qa==r.RP.SLOPE?ar():(ar(),Qa(n));var l=(e.sta[0]+e.end[0])/2;l<H.invert(0)/m&&(l=H.invert(0)/m),l>H.invert(R.width)/m-10&&(l=H.invert(R.width)/m-10),Ya(e.end,[l,e.sta[1]+e.slope*(l-e.sta[0]),e.slope*ve.siru]),Ua.grp.raise()}(e,Number(this.id))}).on("drag",function(e,n){n>0&&n<ye.length-1&&function(e,n){er(),ve.asof;var o=a.daysnap(H.invert(t.event.x)/m),i=_.invert(t.event.y),s=n,d=ye;ye[s].slope=(i-e.sta[1])/l(o-e.sta[0],h),ye[s].end[1]=ye[s].sta[1]+ye[s].slope*(ye[s].end[0]-ye[s].sta[0]),ye[s+1].sta[1]=ye[s].end[1],T.keepSlopes||(ye[s+1].slope=r.segSlope(ye[s+1])),r.fixRoadArray(d,r.RP.VALUE,!1,r.RP.SLOPE),Ha(s,!0);var c=(e.sta[0]+e.end[0])/2;c<H.invert(0)/m&&(c=H.invert(0)/m),c>H.invert(R.width)/m-10&&(c=H.invert(R.width)/m-10),Ka(e.end,[c,e.sta[1]+e.slope*(c-e.sta[0]),e.slope*ve.siru])}(e,Number(this.id))}).on("end",function(t,e){var a;e>0&&e<ye.length-1&&(a=Number(this.id),dr=!1,null==Za&&(tr(a),Va(),ra()),Ia=null)}))):e.remove()}}function Cr(){we=de?ve.dtdarray:r.dtdarray(ye,ve),ke=[];for(let t=0;t<7;t++)ke[t]=r.isoline(ye,we,ve,t)}function Pr(){de||null==T.divGraph||0==ye.length||T.roadEditor&&(za(ye)?Yt.attr("visibility","hidden"):Yt.attr("visibility","visible"))}function Lr(){if(!de&&null!=T.divGraph){var e=Nt.selectAll(".dots").data(ye);T.roadEditor?(e.exit().remove(),e.attr("cx",function(t){return Te(H(t.sta[0]*m))}).attr("cy",function(t){return Te(_(t.sta[1]))}),e.enter().append("svg:circle").attr("class","dots").attr("id",function(t,e){return e-1}).attr("name",function(t,e){return"dot"+(e-1)}).attr("cx",function(t){return Te(H(t.sta[0]*m))}).attr("cy",function(t){return Te(_(t.sta[1]))}).attr("r",Ee(T.roadDot.size)).attr("fill",T.roadDotCol.editable).style("stroke-width",T.roadDot.border).on("wheel",function(e){var a=new t.event.constructor(t.event.type,t.event);Kt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseover",function(e,a){rr||sr||dr||qa==r.RP.VALUE&&a-1==Za||(yn(a-1,!0),t.select(this).attr("r",Ee(T.roadDot.size+2)))}).on("mouseout",function(e,a){rr||sr||dr||qa==r.RP.VALUE&&a-1==Za||(yn(a-1,!1),t.select(this).attr("r",Ee(T.roadDot.size)))}).on("click",function(e,a){t.event.ctrlKey&&function(e,a){var n=Number(a),l=t.select(T.divTable);ye[n].auto==r.RP.VALUE&&bn(a);var o,i,s=l.select("[name=endvalue"+n+"]").node();s.focus(),document.body.createTextRange?((o=document.body.createTextRange()).moveToElementText(s),o.select()):window.getSelection&&(i=window.getSelection(),(o=document.createRange()).selectNodeContents(s),i.removeAllRanges(),i.addRange(o))}(0,this.id)}).call(t.drag().on("start",function(e,a){!function(e,a){t.event.sourceEvent.stopPropagation(),sr=!0,ka(),Ia=r.copyRoad(ye);var n=a;if(null==Za?Xa(n):null!=Za&&Za==n&&qa==r.RP.VALUE?ar():(ar(),Xa(n)),0!=n){var l=ye[n];Ya(e.sta,[(l.sta[0]+l.end[0])/2,(l.sta[1]+l.end[1])/2,l.slope*ve.siru])}else Ya(e.sta);Oa.grp.raise()}(e,Number(this.id))}).on("drag",function(e,a){!function(e,a){er(),ve.asof;var n=_.invert(t.event.y),l=a,o=ye,i=ye[l];i.end[1]=n,i.slope=r.segSlope(i),r.fixRoadArray(o,T.keepSlopes?r.RP.VALUE:r.RP.SLOPE,!1,r.RP.VALUE),Ha(0==l?0:l-1,!1),0!=l?Ka(e.sta,[(i.sta[0]+i.end[0])/2,(i.sta[1]+i.end[1])/2,i.slope*ve.siru]):Ka(e.sta)}(e,Number(this.id))}).on("end",function(t,e){var a;a=Number(this.id),sr=!1,null==Za&&($a(a),Va(),ra()),Ia=null}))):e.remove()}}let Sr={};function Nr(t){let e="",a=r.dotcolor(ye,ve,t[0],t[1],ke);return t[3]!=Xt.DPTYPE.AGGPAST&&(e+=" fuda"),e+=Sr[a]}Sr[a.Cols.GRADOT]=" gra",Sr[a.Cols.GRNDOT]=" grn",Sr[a.Cols.BLUDOT]=" blu",Sr[a.Cols.ORNDOT]=" orn",Sr[a.Cols.REDDOT]=" red",Sr[a.Cols.BLCK]=" blk";var Gr,Br,Or,Ur,Yr,Kr,Vr=null,Hr=null;function Ir(t){var n=H(a.daysnap(t[0])*m),l=_(t[1]),o=(null!=t[7]?"#"+t[7]+": ":"")+e.unix(t[0]).utc().format("YYYY-MM-DD")+", "+(null!=t[6]?a.shn(t[6]):a.shn(t[1]));null!=Hr&&oa(Hr);var i=[];""!==t[2]&&i.push('"'+t[2]+'"'),null!==t[6]&&t[1]!==t[6]&&i.push("total:"+t[1]);var s=r.dotcolor(ye,ve,t[0],t[1],ke);Hr=na(n,l-(15+18*i.length),o,s,i)}function jr(){oa(Hr)}function Fr(e,a,r,n=null,l=!0){let o;null==n&&(n=r),(o=e.selectAll("."+r).data(a)).exit().remove(),o.attr("cx",function(t){return Te(H(t[0]*m))}).attr("cy",function(t){return Te(_(t[1]))}).attr("class",n);var i=o.enter().append("svg:circle");i.attr("class",n).attr("cx",function(t){return Te(H(t[0]*m))}).attr("cy",function(t){return Te(_(t[1]))}),T.headless||i.on("wheel",function(e){var a=new t.event.constructor(t.event.type,t.event);Kt.node().dispatchEvent(a),t.event.preventDefault()},{passive:!1}).on("mouseenter",function(t){null!=T.divData&&T.dataAutoScroll&&null!=t[7]&&function(t){if(t=xe.length-t-1,!Pe.node().offsetParent)return;Be=t;let e=Math.floor(T.dataTableSize/2),a=Math.max(0,Math.min(t-e,xe.length-T.dataTableSize));Ge=a,Oe(),ta()}(t[7]),null!=Vr&&window.clearTimeout(Vr),Vr=window.setTimeout(function(){Ir(t),Vr=null},500)}).on("mouseout",function(){Be=-1,ta(),null!=Hr&&(jr(),Hr=null),window.clearTimeout(Vr),Vr=null})}function Zr(){if(!de&&null!=T.divGraph&&!T.roadEditor){var t=[H.invert(0).getTime()/m,H.invert(R.width).getTime()/m],e=zt.selectAll(".rosy"),a=Tt.selectAll(".rd");if(T.showData||!T.roadEditor)if(ve.rosy){var r,n=(null!=Xt.flad?Xt.rosydata.slice(0,Xt.rosydata.length-1):Xt.rosydata).filter(function(e){return e[0]>=t[0]&&e[0]<=t[1]||e[4]>=t[0]&&e[4]<=t[1]});if(0==Xt.rosydata.length){var l=-1;for(r=0;r<Xt.rosydata.length-1;r++)if(Xt.rosydata[r][0]<=t[0]&&Xt.rosydata[r+1][0]>=t[1]){l=r;break}l>0&&(n=Xt.rosydata.slice(l,l+2))}if(0!=n.length){let t="M"+Te(H(n[0][4]*m))+" "+Te(_(n[0][5]));for(r=0;r<n.length;r++)t+=" L"+Te(H(n[r][0]*m))+" "+Te(_(n[r][1]));e.empty()?zt.append("svg:path").attr("class","rosy").attr("d",t):e.attr("d",t)}else e.remove();Fr(Tt,n,"rd","rd",!0)}else e.remove(),a.remove();else e.remove(),a.remove()}}function qr(){if(de||null==T.divGraph)return;const t=H.invert(0).getTime()/m,e=H.invert(R.width).getTime()/m,a=function(a){return a[0]>=t&&a[0]<=e||a[4]>=t&&a[4]<=e};let n=wt.selectAll(".steppy"),l=kt.selectAll(".std");if(T.showData||!T.roadEditor)if(!T.roadEditor&&ve.steppy&&0!==Wt.length){const l=Wt.filter(a);let o;if(0===l.length){let a=-1;for(o=0;o<Wt.length-1;o++)if(Wt[o][0]<=t&&Wt[o+1][0]>=e){a=o;break}a>0&&(l=Wt.slice(a,a+2))}if(0!==l.length){let a;if(Wt[0][0]>t&&Wt[0][0]<e&&Wt[0][0]in Xt.allvals){const t=Xt.allvals[Wt[0][0]][0][1];a="M"+Te(H(Wt[0][0]*m))+" "+Te(_(t)),a+="L"+Te(H(l[0][4]*m))+" "+Te(_(l[0][5]))}else a="M"+Te(H(l[0][4]*m))+" "+Te(_(l[0][5]));for(o=0;o<l.length;o++)a+=" L"+Te(H(l[o][0]*m))+" "+Te(_(l[o][5])),a+=" L"+Te(H(l[o][0]*m))+" "+Te(_(l[o][1]));n.empty()?wt.append("svg:path").attr("class","steppy").attr("d",a):n.attr("d",a);let i=wt.selectAll(".steppyppr");if(null!==Xt.flad)if(ve.yaw*ve.dir<0&&ve.asof!==ve.tdat){const t=Xt.flad[1]+r.ppr(ye,ve,ve.asof);a="M"+Te(H(l[l.length-1][0]*m))+" "+Te(_(l[l.length-1][1])),a+=" L"+Te(H(l[l.length-1][0]*m))+" "+Te(_(t)),i.empty()?wt.append("svg:path").attr("class","steppyppr").attr("d",a):i.attr("d",a)}else i.remove();else i.remove()}else n.remove();Fr(kt,Xt.flad?l.slice(0,l.length-1):l,"std","std",!0)}else n.remove(),l.remove();else n.remove(),l.remove()}function Jr(){if(!de&&null!=T.divGraph){var t,e=[H.invert(0).getTime()/m,H.invert(R.width).getTime()/m];if(T.showData||!T.roadEditor){var a=Xt.derails.filter(function(t){return t[0]>=e[0]&&t[0]<=e[1]}),r=ve.yaw>0?"#downarrow":"#uparrow";(t=Mt.selectAll(".derails").data(a)).exit().remove(),t.attr("transform",function(t){return"translate("+H(t[0]*m)+","+_(t[1])+"),scale("+T.dataPoint.fsize*re/24+")"}),t.enter().append("svg:use").attr("class","derails").attr("xlink:href",r).attr("transform",function(t){return"translate("+H(t[0]*m)+","+_(t[1])+"),scale("+T.dataPoint.fsize*re/24+")"})}else(t=Mt.selectAll(".derails")).remove()}}function Wr(){if(!de&&null!=T.divGraph&&0!=ye.length){var t=[H.invert(0).getTime()/m,H.invert(R.width).getTime()/m],e=function(e){return e[0]>=t[0]&&e[0]<=t[1]||e[4]>=t[0]&&e[4]<=t[1]};if(ve.asof,T.showData||!T.roadEditor){var a=null!=Xt.flad?Wt.slice(0,Wt.length-1):Wt;a=a.filter(e),ve.plotall&&!T.roadEditor?Fr(Dt,_t.filter(function(e){return e[0]>=t[0]&&e[0]<=t[1]}),"ap",t=>"ap"+Nr(t),!0):Dt.selectAll(".ap").remove(),T.roadEditor?Fr(At,a.concat(Xt.fuda),"dp",t=>"dp"+Nr(t),!0):(Fr(At,a.concat(Xt.fuda),"dp",t=>"dp"+Nr(t),!0),Fr(Ct,Xt.hollow.filter(e),"hp",t=>"hp"+Nr(t),!0));var n=Pt.selectAll(".fladp");if(null!=Xt.flad){const t=r.ppr(ye,ve,ve.asof),e=Xt.flad[1]+t,a=0==t?1:.5;n.empty()?Pt.append("svg:use").attr("class","fladp").attr("xlink:href","#rightarrow").attr("fill",r.dotcolor(ye,ve,Xt.flad[0],e,ke)).attr("fill-opacity",a).attr("transform","translate("+H(Xt.flad[0]*m)+","+_(e)+"),scale("+T.dataPoint.fsize*re/24+")").style("pointer-events",function(){return T.roadEditor?"none":"all"}).on("mouseenter",function(){null!=Vr&&window.clearTimeout(Vr),Vr=window.setTimeout(function(){Ir(Xt.flad),Vr=null},500)}).on("mouseout",function(){null!=Hr&&(jr(),Hr=null),window.clearTimeout(Vr),Vr=null}):n.attr("fill",r.dotcolor(ye,ve,Xt.flad[0],e,ke)).attr("fill-opacity",a).attr("transform","translate("+H(Xt.flad[0]*m)+","+_(e)+"),scale("+T.dataPoint.fsize*re/24+")")}else n.empty()||n.remove()}else At.selectAll(".dp").remove(),(n=At.selectAll(".fladp")).remove()}}function _r(){if(!de){var t=Et.selectAll(".movingav");if(!T.roadEditor&&ve.movingav&&T.showData){var e=[H.invert(0).getTime()/m,H.invert(R.width).getTime()/m],r=ve.filtpts.filter(function(t){return t[0]>e[0]-2*h&&t[0]<e[1]+2*h});if(r.length>0){var n="M"+Te(H(r[0][0]*m))+" "+Te(_(r[0][1]));for(let t=1;t<r.length;t++)n+=" L"+Te(H(r[t][0]*m))+" "+Te(_(r[t][1]));t.empty()?Et.append("svg:path").attr("class","movingav").attr("d",n).style("fill","none").attr("stroke-width",Ee(3*re)).style("stroke",a.Cols.PURP):t.attr("d",n).attr("stroke-width",Ee(3*re))}else t.remove()}else t.remove()}}function Xr(){t.select(T.divTable).attr("class","bmndrroad"),Gr=t.select(T.divTable).select(".rtbmain"),Br=t.select(T.divTable).select(".rtable"),Or=Br.append("div").attr("class","roadbody")}const $r=["dt","vl","sl"];function Qr(){var e,a;T.roadEditor?(e=["","Start Date","Value","",""],a=["","End Date","Value","Daily Slope",""]):(e=["","Start Date","Value",""],a=["","End Date","Value","Daily Slope"]),(Ur=t.select(T.divTable).select(".rtbstart")).append("div").attr("class","roadhdr").append("div").attr("class","roadhdrrow").selectAll("span.rdhdrcell").data(e).enter().append("span").attr("class",(t,e)=>"rdhdrcell "+$r[e]).text(t=>t),Yr=Ur.append("div").attr("class","roadbody"),(Kr=Ur.append("div").attr("class","roadhdr")).append("div").attr("class","roadhdrrow").selectAll("span.rdhdrcell").data(a).enter().append("span").attr("class",(t,e)=>"rdhdrcell "+$r[e]).text(t=>t)}var tn,en;function an(){var e;e=T.roadEditor?["","Goal Date","Value","Daily Slope","",""]:["","Goal Date","Value","Daily Slope"],(tn=t.select(T.divTable).select(".rtbgoal")).append("div").attr("class","roadhdr").append("div").attr("class","roadhdrrow").selectAll("span.rdhdrcell").data(e).enter().append("span").attr("class",(t,e)=>"rdhdrcell "+$r[e]).text(t=>t),en=tn.append("div").attr("class","roadbody")}let rn=null;function nn(){null!=rn&&(rn.picker&&rn.picker.destroy(),rn=null)}function ln(t,r,n,l,o){console.log("createDatePicker()"+r),nn(),rn={min:r,max:n,flt:l,tl:o,fld:t,oldText:t.text()},k()&&(t.attr("contenteditable",!1),setTimeout(function(){t.attr("contenteditable",!0)},100));let i=e(rn.oldText);rn.picker=new Pikaday({keyboardInput:!1,onSelect:function(t){var e=rn.picker.toString(),r=a.dayparse(e,"-");e!==rn.oldText&&(isNaN(r)||(rn.fld.text(e),rn.oldText=e,nn(),document.activeElement.blur()))},minDate:r,maxDate:n}),rn.picker.setMoment(i);var s=t.node().getBoundingClientRect(),d=o.node().getBoundingClientRect();l.style("left",s.right-d.left+"px").style("top",s.bottom+3-d.top+"px"),l.node().appendChild(rn.picker.el,t.node())}let on={field:null,oldText:null};function sn(a,r){if(T.roadEditor){console.debug("tableFocusIn("+r+") for "+this.parentNode.id),on.field=t.select(this),on.oldText=on.field.text(),nn();var n=Number(on.field.node().parentNode.id);if(null!=Za&&ar(),0==r){Wa(n,!1);var l=0==n?ve.xMin-10*h*u:ye[n].sta[0],o=n==ye.length-1?ye[n].end[0]:ye[n+1].end[0],i=e(e.unix(l).utc().format("YYYY-MM-DD")),s=e(e.unix(o).utc().format("YYYY-MM-DD")),d=t.select(T.divTable).select(".floating");ln(on.field,i.toDate(),s.toDate(),d,qt)}else 1==r?Xa(n,!1):2==r&&Qa(n,!1)}}function dn(e,r){if(!T.roadEditor)return;let n=Number(this.parentNode.id),l=t.select(this).text();if(nn(),ar(),l===on.oldText)return;if(null==on.oldText)return;let o=0==r?a.dayparse(l,"-"):l;if(isNaN(o))return t.select(this).text(on.oldText),on.oldText=null,void(on.field=null);0==r&&(hn(n,o),ar()),1==r&&(pn(n,o),ar()),2==r&&(fn(n,o),ar()),on.oldText=null,on.field=null}function cn(e,r){if(13==t.event.keyCode){window.getSelection().removeAllRanges();var n=t.select(this).text(),l=0==r?a.dayparse(n,"-"):n;if(isNaN(l))return t.select(this).text(on.oldText),void(on.oldText=null);0==r&&hn(Number(this.parentNode.id),l),1==r&&pn(Number(this.parentNode.id),l),2==r&&fn(Number(this.parentNode.id),l),on.oldText=t.select(this).text()}}function un(e,a){var n=Number(this.parentNode.id);T.roadEditor&&a==ye[n].auto&&(0==a?xn(n):1==a?bn(n):2==a&&function(e){ye[e].auto=r.RP.DATE;var a=t.select(T.divTable);a.select(".roadrow [name=enddate"+e+"]").style("color",T.roadTableCol.textDisabled).style("background-color",T.roadTableCol.bgDisabled).attr("contenteditable",!1),a.select(".roadrow [name=endvalue"+e+"]").style("color",T.roadTableCol.text).style("background-color",T.roadTableCol.bg).attr("contenteditable",T.roadEditor),a.select(".roadrow [name=slope"+e+"]").style("color",T.roadTableCol.text).style("background-color",T.roadTableCol.bg).attr("contenteditable",T.roadEditor),a.select(".roadrow [name=btndate"+e+"]").property("checked",!0),a.select(".roadrow [name=btnvalue"+e+"]").property("checked",!1),a.select(".roadrow [name=btnslope"+e+"]").property("checked",!1)}(n),this.focus())}function hn(t,e){isNaN(e)?Tn():function(t,e,n=!0){ka();var l=0==t?ve.xMin-10*h*u:ye[t].sta[0]+.01,o=t==ye.length-1?ye[t].end[0]+.01:ye[t+1].end[0]+.01;e<=l&&(e=a.daysnap(l)),e>=o&&(e=a.daysnap(l)),ye[t].end[0]=e,r.fixRoadArray(ye,null,n,r.RP.DATE),ra()}(t,Number(e),!0)}function pn(t,e){isNaN(e)?Tn():function(t,e,a=!1){ka(),ye[t].end[1]=e,a||(T.keepSlopes||(ye[t].slope=r.segSlope(ye[t])),1==t?ye[t-1].sta[1]=e:t==ye.length-1?(ye[t].end[1]=e,ye[t-1].slope=(ye[t].sta[1]-ye[t-1].sta[1])/(ye[t].sta[0]-ye[t-1].sta[0])):ye[t-1].slope=(ye[t].sta[1]-ye[t-1].sta[1])/(ye[t].sta[0]-ye[t-1].sta[0])),r.fixRoadArray(ye,T.keepSlopes?r.RP.VALUE:null,a,r.RP.VALUE),ra()}(t,Number(e),!0)}function fn(t,e){isNaN(e)?Tn():function(t,e,a=!1){t!=ye.length-1&&(ka(),ye[t].slope=e/ve.siru,a||T.keepSlopes||(ye[t].end[1]=ye[t].sta[1]+ye[t].slope*(ye[t].end[0]-ye[t].sta[0]),ye[t+1].sta[1]=ye[t].end[1],ye[t+1].slope=r.segSlope(ye[t+1])),r.fixRoadArray(ye,null,a,r.RP.SLOPE),ra())}(t,Number(e),!0)}function gn(t,e=!0){if(T.tableAutoScroll&&null==Za&&0!==T.tableHeight){let a=t.node().parentNode.getBoundingClientRect();if(0==a.height)return;let r=t.data(),n=a.height+1,l=r[0].i-1,o=l*n;if(null!=T.divTable){let t=Gr.node(),a=(l-Math.floor(t.scrollTop/n))*n;(e||a<0||a-n>T.tableHeight)&&(t.scrollTop=o-T.tableHeight/2)}}}function vn(e,a,r=!0){if(null==T.divTable)return;let n=a?T.roadTableCol.bgHighlight:0==ye[e].auto?T.roadTableCol.bgDisabled:T.roadTableCol.bg,l=t.select(T.divTable).select(".roadrow [name=enddate"+e+"]");l.empty()||(l.style("background-color",n),r&&a&&gn(l))}function yn(e,a,r=!0){if(null!=T.divTable){var n=a?T.roadTableCol.bgHighlight:1==ye[e].auto?T.roadTableCol.bgDisabled:T.roadTableCol.bg,l=t.select(T.divTable).select(".roadrow [name=endvalue"+e+"]");l.empty()||(l.style("background-color",n),r&&a&&gn(l))}}function mn(e,a,r=!0){if(null!=T.divTable){var n=a?T.roadTableCol.bgHighlight:2==ye[e].auto?T.roadTableCol.bgDisabled:T.roadTableCol.bg,l=t.select(T.divTable).select(".roadrow [name=slope"+e+"]");l.empty()||(l.style("background-color",n),r&&a&&gn(l))}}function xn(e){ye[e].auto=r.RP.VALUE;var a=t.select(T.divTable);a.select(".roadrow [name=enddate"+e+"]").style("color",T.roadTableCol.text).style("background-color",T.roadTableCol.bg).attr("contenteditable",T.roadEditor),a.select(".roadrow [name=endvalue"+e+"]").style("color",T.roadTableCol.textDisabled).style("background-color",T.roadTableCol.bgDisabled).attr("contenteditable",!1),a.select(".roadrow [name=slope"+e+"]").style("color",T.roadTableCol.text).style("background-color",T.roadTableCol.bg).attr("contenteditable",T.roadEditor),a.select(".roadrow [name=btndate"+e+"]").property("checked",!1),a.select(".roadrow [name=btnvalue"+e+"]").property("checked",!0),a.select(".roadrow [name=btnslope"+e+"]").property("checked",!1)}function bn(e){ye[e].auto=r.RP.SLOPE;var a=t.select(T.divTable);a.select(".roadrow [name=enddate"+e+"]").style("color",T.roadTableCol.text).style("background-color",T.roadTableCol.bg).attr("contenteditable",T.roadEditor),a.select(".roadrow [name=endvalue"+e+"]").style("color",T.roadTableCol.text).style("background-color",T.roadTableCol.bg).attr("contenteditable",T.roadEditor),a.select(".roadrow [name=slope"+e+"]").style("color",T.roadTableCol.textDisabled).style("background-color",T.roadTableCol.bgDisabled).attr("contenteditable",!1),a.select(".roadrow [name=btndate"+e+"]").property("checked",!1),a.select(".roadrow [name=btnvalue"+e+"]").property("checked",!1),a.select(".roadrow [name=btnslope"+e+"]").property("checked",!0)}function wn(){if(null!=T.divTable){var e=t.select(T.divTable).selectAll(".rtbstart .roadrow, .rtable .roadrow, .rtbgoal .roadrow"),a=e.selectAll(".rdbtn").data(function(t,e){var a;return[{order:8,row:a=T.reverseTable?ye.length-2-e:e,name:"btndel"+a,evt:()=>Ga(a,!1),type:"button",txt:'<img class="ricon" src="../src/trash.svg" ></img>',auto:!1},{order:9,row:a,name:"btnadd"+a,evt:()=>(function(t){if(t<ye.length-1){var e=(ye[t].sta[0]+ye[t+1].sta[0])/2;e-ye[t].sta[0]>30*h&&(e=ye[t].sta[0]+30*h),Na(e)}else Na(ye[t].sta[0]+7*h)})(a+1),type:"button",txt:'<img class="ricon" src="../src/plus.svg"></img>',auto:!1}]});a.enter().append("button").attr("class",t=>"rdbtn "+t.txt).attr("id",t=>t.row).attr("name",t=>t.name).html(t=>t.txt).on("click",t=>t.evt()),a.exit().remove(),(a=e.selectAll(".rtbstart .rdbtn, .rtable .rdbtn, .rtbgoal .rdbtn")).attr("id",t=>t.row).attr("name",t=>t.name).style("display",(t,e)=>Number(t.row)>0&&Number(t.row)<ye.length-2||4==e||e>0&&Number(t.row)>0?null:"none"),e.selectAll(".rdcell, .rdbtn").sort((e,a)=>t.ascending(e.order,a.order)),T.roadEditor||e.selectAll(".rdbtn").style("display","none").attr("value","")}}function kn(t,e,n,l){var o=ye.slice(e,n);l&&(o=o.reverse());var i=t.selectAll(".roadrow").data(o),s=t=>l?ye.length-2-t:t;i.enter().append("div").attr("class","roadrow").attr("name",(t,a)=>"roadrow"+s(e+a)).attr("id",(t,a)=>s(e+a)).append("div").attr("class","rowid").text((t,a)=>s(e+a)+":"),i.exit().remove(),i.order(),(i=t.selectAll(".roadrow")).attr("name",(t,a)=>"roadrow"+s(e+a)).attr("id",(t,a)=>s(e+a)),i.select("div").text((t,a)=>s(e+a)+":");var d=i.selectAll(".rdcell").data((t,n)=>{var l=a.dayify(t.end[0],"-"),o=s(e+n);return[{order:2,value:l,name:"enddate"+o,auto:t.auto==r.RP.DATE,i:o},{order:4,value:a.shn(t.end[1]),name:"endvalue"+o,auto:t.auto==r.RP.VALUE,i:o},{order:6,value:isNaN(t.slope)?"duplicate":a.shn(t.slope*ve.siru),name:"slope"+o,auto:t.auto==r.RP.SLOPE,i:o}]});d.enter().append("div").attr("class",(t,e)=>"rdcell "+$r[e]).attr("name",t=>t.name).attr("contenteditable",(t,e)=>t.auto||!T.roadEditor?"false":"true").on("click",un).on("focusin",sn).on("focusout",dn).on("keydown",cn),d.exit().remove(),(d=i.selectAll(".rdcell")).text((t,e)=>t.value).attr("name",t=>t.name).style("color",t=>ye[t.i].sta[0]==ye[t.i].end[0]&&ye[t.i].sta[1]==ye[t.i].end[1]?T.roadLineCol.invalid:t.auto?T.roadTableCol.textDisabled:T.roadTableCol.text).style("background-color",function(t){return t.auto?T.roadTableCol.bgDisabled:T.roadTableCol.bg}).attr("contenteditable",function(t,e){return t.auto||!T.roadEditor?"false":"true"})}function zn(){if(null!=T.divTable&&!ue)if(ye.length>3){if(!Or.node().offsetParent)return;t.select(T.divTable).style("width",Or.node().offsetWidth+35+"px")}else{if(!en.node().offsetParent)return;t.select(T.divTable).style("width",en.node().offsetWidth+35+"px")}}function Tn(){if(null!=T.divTable){var e=T.reverseTable;kn(Yr,0,1,!1),Yr.select("[name=slope0]").style("visibility","hidden").style("pointer-events","none").style("border","1px solid transparent"),kn(Or,1,ye.length-2,e),kn(en,ye.length-2,ye.length-1,!1),ye.length<=3?(Kr.style("visibility","collapse"),t.select(T.divTable).select(".rtbmain").style("display","none")):(Kr.style("visibility",null),t.select(T.divTable).select(".rtbmain").style("display",null)),zn()}}function En(){Tn(),wn(),zn()}function Rn(){null!=T.divGraph&&(T.showContext?(U.attr("visibility","visible"),function(){if(!de&&null!=T.divGraph&&0!=ye.length){var t=K.selectAll(".ctxoldroads"),e=fe;T.roadEditor||(e=ye);var r="M"+Te(at(e[0].sta[0]*m))+" "+Te(lt(e[0].sta[1]));for(let t=0;t<e.length;t++)r+=" L"+Te(at(e[t].end[0]*m))+" "+Te(lt(e[t].end[1]));t.empty()?K.append("svg:path").attr("class","ctxoldroads").attr("d",r).style("stroke-dasharray",T.roadEditor?T.oldRoadLine.ctxdash+","+d(T.oldRoadLine.ctxdash/2):null).style("fill","none").style("stroke-width",T.oldRoadLine.ctxwidth).style("stroke",T.roadEditor?a.Cols.ORNG:a.Cols.RAZR0):t.attr("d",r).style("stroke-dasharray",T.roadEditor?T.oldRoadLine.ctxdash+","+d(T.oldRoadLine.ctxdash/2):null).style("stroke",T.roadEditor?a.Cols.ORNG:a.Cols.RAZR0)}}(),function(){if(!de&&null!=T.divGraph&&0!=ye.length){var t=T.roadEditor?x.beyey:x.beye,e=K.select(".ctxoldbullseye"),a=at(fe[fe.length-1].sta[0]*m)-T.bullsEye.ctxsize/2,r=lt(fe[fe.length-1].sta[1])-T.bullsEye.ctxsize/2;e.empty()?K.append("svg:image").attr("class","ctxoldbullseye").attr("xlink:href",t).attr("externalResourcesRequired",!0).attr("x",a).attr("y",r).attr("width",T.bullsEye.ctxsize).attr("height",T.bullsEye.ctxsize):e.attr("x",a).attr("y",r)}}(),fr(),function(){if(!de&&null!=T.divGraph&&0!=ye.length){var t=za(ye)?T.roadLineCol.valid:T.roadLineCol.invalid,e=K.selectAll(".ctxroads").data(ye);T.roadEditor?(e.exit().remove(),e.attr("x1",function(t){return at(t.sta[0]*m)}).attr("y1",function(t){return lt(t.sta[1])}).attr("x2",function(t){return at(t.end[0]*m)}).attr("y2",function(t){return lt(t.end[1])}).style("stroke",t),e.enter().append("svg:line").attr("class","ctxroads").attr("id",function(t,e){return e}).attr("name",function(t,e){return"ctxroad"+e}).attr("x1",function(t){return at(t.sta[0]*m)}).attr("y1",function(t){return lt(t.sta[1])}).attr("x2",function(t){return at(t.end[0]*m)}).attr("y2",function(t){return lt(t.end[1])}).style("stroke",t).style("stroke-width",T.roadLine.ctxwidth)):e.remove()}}(),function(){if(!de&&null!=T.divGraph){var t=K.selectAll(".ctxdots").data(ye);T.roadEditor?(t.exit().remove(),t.attr("cx",function(t){return Te(at(t.sta[0]*m))}).attr("cy",function(t){return Te(lt(t.sta[1]))}),t.enter().append("svg:circle").attr("class","ctxdots").attr("r",Ee(T.roadDot.ctxsize)).attr("fill",T.roadDotCol.editable).style("stroke-width",T.roadDot.ctxborder).attr("cx",function(t){return Te(at(t.sta[0]*m))}).attr("cy",function(t){return Te(lt(t.sta[1]))})):t.remove()}}(),function(){if(de||null==T.divGraph||0==ye.length)return;const t=K.select(".ctxhorizon"),e=T.horizon;t.empty()?K.append("svg:line").attr("class","ctxhorizon").attr("x1",at(ve.horizon*m)).attr("y1",lt(ve.yMin-5*(ve.yMax-ve.yMin))).attr("x2",at(ve.horizon*m)).attr("y2",lt(ve.yMax+5*(ve.yMax-ve.yMin))).style("stroke",a.Cols.AKRA).style("stroke-dasharray",e.ctxdash+","+e.ctxdash).style("stroke-width",Ee(e.ctxwidth)):t.attr("x1",at(ve.horizon*m)).attr("y1",lt(ve.yMin-5*(ve.yMax-ve.yMin))).attr("x2",at(ve.horizon*m)).attr("y2",lt(ve.yMax+5*(ve.yMax-ve.yMin)));var r=at(ve.horizon*m)+12,n=M.height/2,l=K.select(".ctxhortext");l.empty()?K.append("svg:text").attr("class","ctxhortext").attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")").attr("fill",a.Cols.AKRA).style("font-size",e.ctxfont+"px").text("Horizon"):l.attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")")}(),function(){if(!de&&null!=T.divGraph&&0!=ye.length){var t=K.select(".ctxtoday"),e=K.select(".ctxtodaytext");if(!T.roadEditor)return t.remove(),void e.remove();t.empty()?K.append("svg:line").attr("class","ctxtoday").attr("x1",at(ve.asof*m)).attr("y1",0).attr("x2",at(ve.asof*m)).attr("y2",M.height).style("stroke","rgb(0,0,200)").style("stroke-width",Ee(T.horizon.ctxwidth)):t.attr("x1",at(ve.asof*m)).attr("y1",0).attr("x2",at(ve.asof*m)).attr("y2",M.height);var a=at(ve.asof*m)-5,r=M.height/2;e.empty()?K.append("svg:text").attr("class","ctxtodaytext").attr("x",a).attr("y",r).attr("transform","rotate(-90,"+a+","+r+")").attr("fill","rgb(0,0,200)").style("font-size",T.today.ctxfont+"px").text("Today"):e.attr("x",a).attr("y",r).attr("transform","rotate(-90,"+a+","+r+")")}}(),T.showFocusRect?Zt.attr("visibility","visible"):Zt.attr("visibility","hidden")):(U.attr("visibility","hidden"),Zt.attr("visibility","hidden")))}function Mn(n=!1){if(null==T.divGraph)return;ar();const l=[H.invert(0).getTime()/m,H.invert(R.width).getTime()/m];var o;n&&(ne=0),(re=T.roadEditor?a.clip(a.rescale(l[1],l[0],l[0]+73*h,1,.7),.7,1):a.clip(a.rescale(l[1],l[0],l[0]+73*h,1,.55),.55,1))!=ne&&function(){let e="",r="#svg"+E+" ",n="pointer-events:"+(T.headless?"none;":"all;");e+=r+".rd {r:"+Ee(T.dataPoint.size*re)+"px} ",e+=r+".std {r:"+Ee((T.dataPoint.size+2)*re)+"px} ",e+=r+".ap {r:"+Ee(.7*T.dataPoint.size*re)+"px;"+n+"} ",e+=r+".hp {r:"+Ee(T.dataPoint.hsize*re)+"px;"+n+"} ",e+=r+".guides {stroke-width:"+Ee(T.guidelines.width*re)+"px} ",e+=r+".rosy {stroke-width:"+Ee(4*re)+"px} ",e+=r+".steppy {stroke-width:"+Ee(4*re)+"px} ",e+=r+".steppyppr {stroke-width:"+Ee(4*re)+"px} ",e+=r+".maxflux {fill:none;stroke:"+a.Cols.BIGG+";stroke-width:"+Ee(T.maxfluxline*re)+"px} ",e+=r+".stdflux {fill:none;stroke:"+a.Cols.BIGG+";stroke-width:"+Ee(T.stdfluxline*re)+"px} ",T.roadEditor?(e+=r+".dp {r:"+Ee(T.dataPoint.size*re)+"px;stroke:"+T.dataPointCol.stroke+";stroke-width:"+Ee(T.dataPoint.border*re)+"px} ",e+=r+".razr {fill:none;pointer-events:none;stroke-width:"+Ee(T.razrline*re)+"px;stroke:"+a.Cols.RAZR0+"} "):(e+=r+".dp {r:"+Ee(T.dataPoint.size*re)+"px;stroke:rgb(0,0,0);stroke-width:"+Ee(1*re)+"px} ",e+=r+".dp.fuda {stroke-width:"+Ee(.5*re)+"px} ",e+=r+".razr {fill:none;pointer-events:none;stroke-width:"+Ee(T.razrline*re)+"px;stroke:"+a.Cols.REDDOT+"} "),t.select("style#dynstyle"+E).text(e)}(),Pr(),gr(),function(){if(!de&&null!=T.divGraph&&0!=ye.length){var t=ot.select(".past");T.roadEditor?t.empty()?ot.insert("svg:rect",":first-child").attr("class","past").attr("x",H(ve.xMin)).attr("y",_(ve.yMax+3*(ve.yMax-ve.yMin))).attr("width",H(ve.asof*m)-H(ve.xMin)).attr("height",7*i(_(ve.yMin)-_(ve.yMax))).attr("fill",T.pastBoxCol.fill).attr("fill-opacity",T.pastBoxCol.opacity):t.attr("x",H(ve.xMin)).attr("y",_(ve.yMax+3*(ve.yMax-ve.yMin))).attr("width",H(ve.asof*m)-H(ve.xMin)).attr("height",7*i(_(ve.yMin)-_(ve.yMax))):t.remove()}}(),yr(),mr(),Er(),de||null==T.divGraph||0==ye.length||(T.roadEditor?xr(fe,ge,mt,"razr",0,!0):xr(ye,ve,mt,"razr",0,!1)),Rr(),Mr(),function(){if(!de&&null!=T.divGraph&&0!=ye.length){var t=xt.select(".oldbullseye");if(T.roadEditor){var e=T.roadEditor?x.beyey:x.beye,a=H(ge.tfin*m)-T.bullsEye.size/2,n=_(r.rdf(fe,ge.tfin))-T.bullsEye.size/2;t.empty()?xt.append("svg:image").attr("class","oldbullseye").attr("xlink:href",e).attr("externalResourcesRequired",!0).attr("x",a).attr("y",n).attr("width",T.bullsEye.size).attr("height",T.bullsEye.size):t.attr("x",a).attr("y",n)}else t.remove()}}(),pr(),Dr(),Wr(),Jr(),Zr(),qr(),de||null==T.divGraph||((o=Bt.selectAll(".hashtag").data(Xt.hashtags)).exit().remove(),o.attr("x",function(t){return H(t[0]*m)}).attr("transform",t=>"rotate(-90,"+H(t[0]*m)+","+R.height/2+")").text(t=>t[1]),o.enter().append("svg:text").attr("class","hashtag").attr("x",t=>H(t[0]*m)).attr("y",R.height/2).attr("transform",t=>"rotate(-90,"+H(t[0]*m)+","+R.height/2+")").attr("fill",a.Cols.BLACK).style("font-size",T.horizon.font+"px").text(t=>t[1])),_r(),Ar(),Lr(),function(){if(de||null==T.divGraph||0==ye.length)return;const t=Ot.select(".horizon"),e=T.horizon;t.empty()?Ot.append("svg:line").attr("class","horizon").attr("x1",H(ve.horizon*m)).attr("y1",0).attr("x2",H(ve.horizon*m)).attr("y2",R.height).style("stroke",a.Cols.AKRA).style("stroke-dasharray",e.dash+","+e.dash).attr("stroke-width",Ee(e.width*re)):t.attr("x1",H(ve.horizon*m)).attr("y1",0).attr("x2",H(ve.horizon*m)).attr("y2",R.height).attr("stroke-width",Ee(e.width*re));var r=H(ve.horizon*m)+14,n=R.height/2,l=Ut.select(".horizontext");l.empty()?Ut.append("svg:text").attr("class","horizontext").attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")").attr("fill",a.Cols.AKRA).style("font-size",e.font+"px").text("Akrasia Horizon"):l.attr("x",r).attr("y",n).attr("transform","rotate(-90,"+r+","+n+")")}(),function(){if(!de&&null!=T.divGraph&&0!=ye.length&&0!=Xt.oresets.length){var t=pt.selectAll(".oresets").data(Xt.oresets);T.roadEditor?t.remove():(t.exit().remove(),t.attr("x1",function(t){return H(t*m)}).attr("y1",0).attr("x2",function(t){return H(t*m)}).attr("y2",R.height),t.enter().append("svg:line").attr("class","oresets").attr("id",function(t,e){return e}).attr("name",function(t,e){return"oreset"+e}).attr("x1",function(t){return H(t*m)}).attr("y1",0).attr("x2",function(t){return H(t*m)}).attr("y2",R.height).attr("stroke","rgb(200,200,200)").style("stroke-dasharray",T.odomReset.dash+","+T.odomReset.dash).attr("stroke-width",T.odomReset.width))}}(),function(){if(!de&&null!=T.divGraph&&0!=ye.length){var t=ht.select(".pastline"),r=ft.select(".pasttext");if(!T.roadEditor)return t.remove(),void r.remove();t.empty()?ht.append("svg:line").attr("class","pastline").attr("x1",H(ve.asof*m)).attr("y1",0).attr("x2",H(ve.asof*m)).attr("y2",R.height).style("stroke",a.Cols.AKRA).style("stroke-width",Ee(T.today.width)):t.attr("x1",H(ve.asof*m)).attr("y1",0).attr("x2",H(ve.asof*m)).attr("y2",R.height);var n=H(ve.asof*m)-8,l=R.height/2;r.empty()?ft.append("svg:text").attr("class","pasttext").attr("x",n).attr("y",l).attr("transform","rotate(-90,"+n+","+l+")").attr("fill",a.Cols.AKRA).style("font-size",T.horizon.font+"px").text("Today ("+e.unix(ve.asof).utc().format("ddd")+")"):r.attr("x",n).attr("y",l).attr("transform","rotate(-90,"+n+","+l+")").text("Today ("+e.unix(ve.asof).utc().format("ddd")+")")}}(),vr(),Kt.attr("color",r.dotcolor(ye,ve,ve.tcur,ve.vcur,ke)),ne=re}!function(){var e=T.divGraph;if(null!==e){for(;e.firstChild;)e.removeChild(e.firstChild);P=t.select(e).attr("class","bmndrgraph").append("svg:svg").attr("id","svg"+E).attr("xmlns","http://www.w3.org/2000/svg").attr("xmlns:xlink","http://www.w3.org/1999/xlink").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+Qt+" "+te).attr("width","100%").attr("height","100%").attr("class","bmndrsvg"),(L=P.append("defs")).insert("style").attr("type","text/css").text(v),L.insert("style").attr("id","dynstyle"+E).attr("type","text/css").text(""),L.append("clipPath").attr("id","plotclip"+E).append("rect").attr("x",0).attr("y",0).attr("width",R.width).attr("height",R.height),L.append("clipPath").attr("id","brushclip"+E).append("rect").attr("x",0).attr("y",0).attr("width",M.width).attr("height",M.height),L.append("clipPath").attr("id","buttonareaclip"+E).append("rect").attr("x",R.x).attr("y",0).attr("width",R.width).attr("height",D.top),L.append("path").style("stroke","none").attr("id","rightarrow").attr("d","M 55,0 -35,45 -35,-45 z"),L.append("path").style("stroke","none").attr("id","downarrow").attr("d","M 0,40 45,-50 -45,-50 z"),L.append("path").style("stroke","none").attr("id","uparrow").attr("d","M 0,-40 45,50 -45,50 z"),(ct=L.append("pattern").attr("id","pinkzonepat"+E).attr("x",0).attr("y",0).attr("width",10).attr("height",10).attr("patternTransform","rotate(45)").attr("patternUnits","userSpaceOnUse")).append("rect").attr("x",0).attr("y",0).attr("width",10).attr("height",10).attr("fill",a.Cols.PINK),ct.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",10).style("stroke","#aaaaaa").style("stroke-width",1),(ut=L.append("pattern").attr("id","tapepat"+E).attr("x",0).attr("y",0).attr("width",20).attr("height",20).attr("patternTransform","rotate(45)").attr("patternUnits","userSpaceOnUse")).append("rect").attr("x",0).attr("y",0).attr("width",20).attr("height",20).attr("fill","#ffffff"),ut.append("line").attr("x1",0).attr("y1",0).attr("x2",20).attr("y2",0).style("stroke","#ff5555").style("stroke-width",25);var r=L.append("g").attr("id","removebutton");r.append("circle").attr("cx",14).attr("cy",14).attr("r",16).attr("fill","white"),r.append("path").attr("d","M13.98,0C6.259,0,0,6.261,0,13.983c0,7.721,6.259,13.982,13.98,13.982c7.725,0,13.985-6.262,13.985-13.982C27.965,6.261,21.705,0,13.98,0z M19.992,17.769l-2.227,2.224c0,0-3.523-3.78-3.786-3.78c-0.259,0-3.783,3.78-3.783,3.78l-2.228-2.224c0,0,3.784-3.472,3.784-3.781c0-0.314-3.784-3.787-3.784-3.787l2.228-2.229c0,0,3.553,3.782,3.783,3.782c0.232,0,3.786-3.782,3.786-3.782l2.227,2.229c0,0-3.785,3.523-3.785,3.787C16.207,14.239,19.992,17.769,19.992,17.769z");var n=L.append("g").attr("id","zoominbtn");!T.headless&&T.buttonZoom&&(n.append("path").style("fill","white").attr("d","m 530.86356,264.94116 a 264.05649,261.30591 0 1 1 -528.1129802,0 264.05649,261.30591 0 1 1 528.1129802,0 z"),n.append("path").attr("d","m 308.21,155.10302 -76.553,0 0,76.552 -76.552,0 0,76.553 76.552,0 0,76.552 76.553,0 0,-76.552 76.552,0 0,-76.553 -76.552,0 z m 229.659,114.829 C 537.869,119.51007 420.50428,1.9980234 269.935,1.9980234 121.959,1.9980234 2.0000001,121.95602 2.0000001,269.93202 c 0,147.976 117.2473599,267.934 267.9339999,267.934 150.68664,0 267.935,-117.51205 267.935,-267.934 z m -267.935,191.381 c -105.681,0 -191.381,-85.7 -191.381,-191.381 0,-105.681 85.701,-191.380996 191.381,-191.380996 105.681,0 191.381,85.700996 191.381,191.380996 0,105.681 -85.7,191.381 -191.381,191.381 z"));var l=L.append("g").attr("id","zoomoutbtn");!T.headless&&T.buttonZoom&&(l.append("path").style("fill","white").attr("d","m 530.86356,264.94116 a 264.05649,261.30591 0 1 1 -528.1129802,0 264.05649,261.30591 0 1 1 528.1129802,0 z"),l.append("path").attr("d","m 155.105,231.65502 0,76.553 229.657,0 0,-76.553 c -76.55233,0 -153.10467,0 -229.657,0 z m 382.764,38.277 C 537.869,119.51007 420.50428,1.9980234 269.935,1.9980234 121.959,1.9980234 2.0000001,121.95602 2.0000001,269.93202 c 0,147.976 117.2473599,267.934 267.9339999,267.934 150.68664,0 267.935,-117.51205 267.935,-267.934 z m -267.935,191.381 c -105.681,0 -191.381,-85.7 -191.381,-191.381 0,-105.681 85.701,-191.380996 191.381,-191.380996 105.681,0 191.381,85.700996 191.381,191.380996 0,105.681 -85.7,191.381 -191.381,191.381 z")),(Kt=P.append("rect").attr("class","zoomarea").attr("x",R.x).attr("y",R.y).attr("color",a.Cols.REDDOT).attr("width",R.width).attr("height",R.height)).on("wheel.scroll");var o={shown:!1,timeout:null};if(Kt.on("wheel.scroll",function(){if(null!=o.timeout&&(clearTimeout(o.timeout),o.timeout=null),t.event.ctrlKey)return Ae("zoominfo",!0,O),void(o.shown=!1);o.shown||(De(["Use ctrl+scroll to zoom"],-1,"normal",{x:0,y:0,w:R.width,h:R.height},"zoominfo",!1,!0,O),o.shown=!0),o.timeout=setTimeout(()=>{Ae("zoominfo",!0),o.shown=!1},1e3)},{passive:!1}),Kt.on("mousedown.move",function(){null!=o.timeout&&(clearTimeout(o.timeout),o.timeout=null),Ae("zoominfo",!0),o.shown=!1}),Vt=t.zoom().extent([[0,0],[R.width,R.height]]).scaleExtent([1,1/0]).translateExtent([[0,0],[R.width,R.height]]).filter(function(){return"wheel"!=t.event.type||t.event.ctrlKey}).on("zoom",ya),Kt.call(Vt),k()){var i,s=null,d=Kt.on("touchstart.zoom"),c=Kt.on("touchmove.zoom"),u=Kt.on("touchend.zoom");Kt.on("touchstart.zoom",function(){var e=this.getBoundingClientRect();i=t.event.touches.item(0).pageX-e.left;var a=H.invert(i);null==s&&1==t.event.touches.length&&(s=window.setTimeout(()=>{null!=a&&Na(a/m)},1e3)),d.apply(this,arguments)}).on("touchmove.zoom",function(){window.clearTimeout(s),s=null,c.apply(this,arguments)}).on("touchend.zoom",function(){clearTimeout(s),s=null,u.apply(this,arguments)})}T.roadEditor?(Kt.on("click",function(){t.event.shiftKey?h():ar()}),Kt.on("dblclick.zoom",h)):Kt.on("dblclick.zoom",null),G=P.append("g").attr("class","focus").attr("transform","translate("+T.focusRect.x+","+T.focusRect.y+")"),S=G.append("g").attr("clip-path","url(#buttonareaclip"+E+")").attr("class","buttonarea"),B=G.append("g").attr("class","focusclip").attr("clip-path","url(#plotclip"+E+")").attr("transform","translate("+D.left+","+D.top+")"),O=B.append("g").attr("class","plot"),N=G.append("svg:text").attr("x",Qt/2).attr("y",15).attr("width",R.width).attr("class","svgtxt").style("font-size","80%").attr("text-anchor","middle"),ot=O.append("g").attr("id","pastboxgrp"),it=O.append("g").attr("id","ybhpgrp"),Gt=O.append("g").attr("id","wmarkgrp"),gt=O.append("g").attr("id","guidegrp"),vt=O.append("g").attr("id","maxfluxgrp"),yt=O.append("g").attr("id","stdfluxgrp"),st=O.append("g").attr("id","ybhplinesgrp"),mt=O.append("g").attr("id","razrgrp"),Rt=O.append("g").attr("id","auragrp"),dt=O.append("g").attr("id","pinkgrp"),xt=O.append("g").attr("id","oldbullseyegrp"),Lt=O.append("g").attr("id","bullseyegrp"),ht=O.append("g").attr("id","grid"),pt=O.append("g").attr("id","oresetgrp"),bt=O.append("g").attr("id","knotgrp"),wt=O.append("g").attr("id","steppygrp"),zt=O.append("g").attr("id","rosygrp"),Tt=O.append("g").attr("id","rosyptsgrp"),Mt=O.append("g").attr("id","derailsgrp"),Dt=O.append("g").attr("id","allptsgrp"),Et=O.append("g").attr("id","movingavgrp"),kt=O.append("g").attr("id","steppyptsgrp"),At=O.append("g").attr("id","datapointgrp"),Ct=O.append("g").attr("id","hollowgrp"),Pt=O.append("g").attr("id","flatlinegrp"),Bt=O.append("g").attr("id","hashtaggrp"),St=O.append("g").attr("id","roadgrp"),Nt=O.append("g").attr("id","dotgrp"),Ot=O.append("g").attr("id","horgrp"),Ut=O.append("g").attr("id","hortxtgrp"),ft=O.append("g").attr("id","pasttxtgrp"),(Yt=O.append("g").attr("visibility","hidden")).append("rect").attr("x",0).attr("y",0).attr("stroke-width",20).attr("stroke","url(#tapepat"+E+")").attr("fill","none"),Yt.append("text").attr("y",45).attr("paint-order","stroke").attr("stroke-width","2px").attr("stroke","#a00000").attr("font-size","35px").attr("text-anchor","middle").attr("fill","#ff0000").text("Error"),Ht=B.append("svg:use").attr("class","zoomin").attr("xlink:href","#zoominbtn").attr("opacity",T.zoomButton.opacity).attr("transform",C.botin).on("click",()=>{Kt.call(Vt.scaleBy,T.zoomButton.factor)}).on("mouseover",()=>{he||t.select(this).style("fill","red")}).on("mouseout",(e,a)=>{t.select(this).style("fill","black")}),It=B.append("svg:use").attr("class","zoomout").attr("xlink:href","#zoomoutbtn").attr("opacity",T.zoomButton.opacity).attr("transform",C.botout).on("click",()=>{Kt.call(Vt.scaleBy,1/T.zoomButton.factor)}).on("mouseover",()=>{he||t.select(this).style("fill","red")}).on("mouseout",(e,a)=>{t.select(this).style("fill","black")}),V=t.scaleUtc().range([0,R.width]),I=t.axisBottom(V).ticks(6),Z=G.append("g").attr("class","axis").attr("transform","translate("+R.x+","+(D.top+R.height)+")").call(I),F=t.axisTop(V).ticks(6).tickFormat(""),J=ht.append("g").attr("class","grid").attr("transform","translate(0,"+R.height+")").call(F),j=t.axisTop(V).ticks(6),q=G.append("g").attr("class","axis").attr("transform","translate("+R.x+","+D.top+")").call(j),T.roadEditor&&(J.attr("display","none"),q.attr("display","none")),W=t.scaleLinear().range([R.height,0]),X=t.axisLeft(W).ticks(8).tickSize(6).tickSizeOuter(0),$=t.axisRight(W).ticks(8).tickSize(6).tickSizeOuter(0),Q=G.append("g").attr("class","axis").attr("transform","translate("+D.left+","+D.top+")").call(X),tt=G.append("g").attr("class","axis").attr("transform","translate("+(D.left+R.width)+","+D.top+")").call($),et=G.append("text").attr("class","axislabel").attr("transform","translate(15,"+(R.height/2+D.top)+") rotate(-90)").text(""),U=P.append("g").attr("class","brush").attr("transform","translate("+T.ctxRect.x+","+T.ctxRect.y+")"),Y=U.append("g").attr("clip-path","url(#brushclip"+E+")").attr("transform","translate("+A.left+","+A.top+")"),K=Y.append("g").attr("class","context"),at=t.scaleUtc().range([0,M.width]),rt=t.axisBottom(at).ticks(6),nt=U.append("g").attr("class","axis").attr("transform","translate("+M.x+","+(A.top+M.height)+")").call(rt),lt=t.scaleLinear().range([M.height,0]),jt=t.brushX().extent([[0,0],[M.width,M.height]]).on("brush",ma),Ft=K.append("g").attr("class","brush").call(jt),Zt=Y.append("rect").attr("class","focusrect").attr("x",1).attr("y",1).attr("width",M.width-2).attr("height",M.height-2).attr("fill","none").style("stroke","black").style("stroke-width",1).style("stroke-dasharray","8,4,2,4"),H=V,_=W}function h(){var e=t.mouse(P.node());Na(H.invert(e[0]-D.left)/m)}}(),function(){var e=T.divTable;if(null!==e){for(;e.firstChild;)e.removeChild(e.firstChild);var a=t.select(e),r=(a.append("div").attr("class","rtbstart"),a.append("div").attr("class","rtbmain"));a.append("div").attr("class","rtbgoal"),0!=T.tableHeight&&r.style("max-height",T.tableHeight+"px").style("overflow-y","auto");var n=r.append("div").attr("class","rtable");n.append("div").attr("id","dpfloat").attr("class","floating"),qt=n.append("div").attr("id","topleft").style("position","absolute").style("left",0).style("top",0).style("width","1px").style("height","1px").attr("visibility","hidden"),T.reverseTable?(an(),Xr(),Qr()):(Qr(),Xr(),an())}}(),function(){var e=T.divDueby;if(null!==e){for(;e.firstChild;)e.removeChild(e.firstChild);var a,r=t.select(e);a=["DAY","DELTA","TOTAL"],(ea=r.append("div").attr("class","dbbody")).append("div").attr("class","dbhdrrow").selectAll("span.dbhdrcell").data(a).enter().append("span").attr("class","dbhdrcell").text(t=>t),ea.selectAll(".dbrow").data([1,2,3,4,5,6,7]).join(t=>t.append("div").attr("class","dbrow"))}}(),function(){var e=T.divData;if(null!==e){for(;e.firstChild;)e.removeChild(e.firstChild);var a,r=t.select(e);r.append("div").attr("id","dpfloat").attr("class","floating"),Jt=r.append("div").attr("id","datatopleft").style("position","absolute").style("left",0).style("top",0).style("width","1px").style("height","1px").attr("visibility","hidden"),r.attr("class","bmndrdata"),r.on("wheel.scroll",Ye,{passive:!1}),Pe=r.append("div").attr("class","dbody"),Se=Array(Math.min(xe.length,T.dataTableSize)).fill().map((t,e)=>e+Ge),a=["#","DATE","VALUE","COMMENT","",""],Pe.append("div").attr("class","dhdrrow").selectAll("span.dhdrcell").data(a).enter().append("span").attr("class",(t,e)=>"dhdrcell "+Ke[e]).style("text-align",(t,e)=>0==e?"right":null).text(t=>t),Pe.selectAll(".drow").data(Se).join(t=>t.append("div").attr("class","drow")),Le=r.append("input").attr("type","range").attr("class","dslider").attr("min",0).attr("max",15).attr("value",7).attr("step",1).on("input",function(){Ue(this.value)}).on("change",function(){Ue(this.value)})}}(),this.id=1,this.showData=(t=>(arguments.length>0&&(T.showData=t),0!=be.length&&(Wr(),Jr(),Zr(),qr(),_r(),vr()),T.showData)),this.showContext=(t=>(arguments.length>0&&(T.showContext=t),0!=ye.length&&Rn(),T.showContext)),this.keepSlopes=(t=>(arguments.length>0&&(T.keepSlopes=t),T.keepSlopes)),this.keepIntervals=(t=>(arguments.length>0&&(T.keepIntervals=t),T.keepIntervals)),this.maxDataDays=(t=>(arguments.length>0&&(T.maxDataDays=t,T.maxDataDays<0?(_t=be.slice(),Wt=me.slice()):(_t=be.filter(t=>t[0]>ve.asof-T.maxDataDays*h),Wt=me.filter(t=>t[0]>ve.asof-T.maxDataDays*h)),0!=be.length&&(Wr(),Jr(),Zr(),qr())),T.maxDataDays)),this.reverseTable=(e=>(arguments.length>0&&(T.reverseTable=e,T.reverseTable?(t.select(T.divTable).select(".rtbgoal").raise(),t.select(T.divTable).select(".rtbmain").raise(),t.select(T.divTable).select(".rtbstart").raise()):(t.select(T.divTable).select(".rtbstart").raise(),t.select(T.divTable).select(".rtbmain").raise(),t.select(T.divTable).select(".rtbgoal").raise()),En()),T.reverseTable)),this.tableUpdateOnDrag=(t=>(arguments.length>0&&(T.tableUpdateOnDrag=t,En()),T.tableUpdateOnDrag)),this.tableAutoScroll=(t=>(arguments.length>0&&(T.tableAutoScroll=t),T.tableAutoScroll)),this.undoBufferState=(()=>({undo:ie.length,redo:se.length})),this.undo=(()=>{T.roadEditor&&(document.activeElement.blur(),0!=ie.length&&(0!=ie.length&&r.sameRoads(ie[ie.length-1],ye)||se.push(ye),ye=ie.pop(),Xt.setRoadObj(ye),ra()))}),this.undoAll=(()=>{T.roadEditor&&(ye=ie.shift(),wa(),Xt.setRoadObj(ye),ra())}),this.redo=(()=>{T.roadEditor&&(document.activeElement.blur(),0!=se.length&&(ka(!0),ye=se.pop(),ra()))}),this.clearUndo=wa,this.zoomAll=(()=>{0!=ye.length&&ba()}),this.zoomDefault=(()=>{0!=ye.length&&xa()}),this.loadGoal=(async t=>{await async function(t,e=null){if(""!=t&&!ce){ce=!0,T.headless||De(["loading..."],te/10);var r=await a.loadJSON(t);if(null!=r){if(T.headless||Ae(),"errstring"in r)throw new Error("loadGoalFromURL: BB file has errors: "+r.errstring);Sa(r)}else De(null!=oe?[w[oe]]:["Could not load goal file."]),T.headless||setTimeout(Ae,1500),"function"==typeof T.onError&&T.onError.call();ce=!1}}(t).catch(function(t){console.log(t.stack)})}),this.loadGoalJSON=((t,e=!0)=>{Ae(),Sa(t,e)}),this.retroRatchet=(t=>{T.roadEditor&&function(t){if(0!=ye.length){var e=r.dtd(ye,ve,ve.tcur,ve.vcur),a=ve.asof;t<0&&(t=0);var n=e-(t-1)-1;if(!(n<=0)){var l,o=ve.asof+n*h,i=r.rdf(ye,o),s=-1;for(l=1;l<ye.length;l++)if(ye[l].sta[0]===a){s=l-1;break}var d=!1;s<0&&(Na(a),d=!0),l+1<ye.length&&ye[l+1].sta[0]===a||(Na(a,i),d&&(ie.pop(),d=!0)),ra()}}else console.log("bgraph("+E+"):setSafeDays(), road is empty!")}(t)}),this.scheduleBreak=((t,e,n)=>{if(T.roadEditor&&!isNaN(e))if(0!=ye.length){var l,o,i=a.dayparse(t,"-"),s=-1;for(l=1;l<ye.length;l++)if(ye[l].sta[0]===i){s=l;break}var d=!1;for(s<0&&(Na(i),d=!0),d||ka(),l=1;l<ye.length;l++)if(ye[l].sta[0]===i){s=l;break}if(n){for(ye[s].end[0]=a.daysnap(ye[s].end[0]+e*h),o=s+1;o<ye.length;o++)ye[o].sta[0]=a.daysnap(ye[o].sta[0]+e*h),ye[o].end[0]=a.daysnap(ye[o].end[0]+e*h);if(ye[s].sta[1]!=ye[s].end[1]){var c={};c.sta=ye[s].sta.slice(),c.sta[0]=a.daysnap(c.sta[0]+e*h),c.end=ye[s].end.slice(),c.slope=r.segSlope(c),c.auto=r.RP.VALUE,ye.splice(s+1,0,c),ye[s].end=c.sta.slice(),ye[s].slope=0,r.fixRoadArray(ye,r.RP.VALUE,!1)}}else{var u=a.daysnap(ye[s].sta[0]+e*h),p=r.findSeg(ye,u);for(ye[p].sta[0]!=u&&(Na(u),d&&(ie.pop(),d=!0),p=r.findSeg(ye,u)),o=s+1;o<p;o++)ye.splice(s+1,1);ye[s].end=ye[s+1].sta.slice();var f=ye[s+1].sta[1]-ye[s].sta[1];for(o=s;o<ye.length;o++)ye[o].end[1]-=f,ye[o].slope=r.segSlope(ye[o]),o+1<ye.length&&(ye[o+1].sta[1]=ye[o].end[1]);r.fixRoadArray(ye,r.RP.SLOPE,!1)}ra()}else console.log("bgraph("+E+"):scheduleBreak(), road is empty!")}),this.commitTo=(t=>{if(T.roadEditor&&!isNaN(t))if(0!=ye.length){if(ye[ye.length-2].slope!=t){var e=r.findSeg(ye,ve.horizon);ye[e].sta[0]==ve.horizon||e<ye.length-2?ka():Na(ve.horizon),ye[ye.length-2].slope=t,r.fixRoadArray(ye,r.RP.VALUE,!1),ra()}}else console.log("bgraph("+E+"):commitTo(), road is empty!")}),this.getRoad=(()=>{var t,a,n={};if(0==ye.length)return console.log("bgraph("+E+"):getRoad(), road is empty!"),null;n.valid=za(ye),n.loser=r.redyest(ye,ve,ve.tcur),n.asof=ve.asof,n.horizon=ve.horizon,n.siru=ve.siru,n.road=[];for(let l=0;l<ye.length-1;l++)(t=ye[l]).sta[0]==t.end[0]&&t.sta[1]==t.end[1]||(a=[e.unix(t.end[0]).utc().format("YYYYMMDD"),t.end[1],t.slope*ve.siru],t.auto==r.RP.DATE&&(a[2]=null),t.auto==r.RP.VALUE&&(a[1]=null),t.auto==r.RP.SLOPE&&(a[2]=null),n.road.push(a));return n}),this.saveGraph=((e=null)=>{const a=P.node();let r=(new XMLSerializer).serializeToString(a);if(T.headless||null==e){if(document.head.remove(),document.body.innerHTML=r,T.headless){var n=t.select(document.body);n.selectAll(".buttonarea").remove(),n.selectAll(".brush").remove(),n.selectAll(".zoomin").remove(),n.selectAll(".zoomout").remove()}}else{r.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)||(r=r.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')),r.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)||(r=r.replace(/^<svg/,'<svg xmlns:xlink="http://www.w3.org/1999/xlink"')),r='<?xml version="1.0" standalone="no"?>\n'+r;var l="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(r);e.href=l}}),this.hide=(()=>{ue=!0}),this.show=(()=>{ue=!1,0!=ye.length?(ua(),pa(),ha(),ga(),En(),Rn(),Mn(!0)):console.log("bgraph("+E+"):show(), road is empty!")}),this.loading=(t=>{t?De(["loading..."],te/10):Ae()}),this.getRoadObj=(()=>r.copyRoad(ye)),this.getGoalObj=(()=>ve);var Dn=!1;this.setRoadObj=((t,e=!1)=>{Dn||(0!=t.length?(Dn=!0,ka(),ye=r.copyRoad(t),e&&(fe=r.copyRoad(t),wa()),Xt.setRoadObj(t),ra(),Dn=!1):console.log("bgraph("+E+"):setRoadObj(), new road is empty!"))}),this.isLoser=(()=>!(!ve||0==ye.length)&&r.redyest(ye,ve,ve.tcur)),this.getProgress=(()=>[[a.dayify(ve.tini,"-"),ve.vini],[a.dayify(ve.tcur,"-"),ve.vcur],[a.dayify(ve.tfin,"-"),ve.vfin]]),this.curState=(()=>ve?[ve.tcur,ve.vcur,ve.rcur,r.rdf(ye,ve.tcur)]:null);const An=["plotall","steppy","rosy","movingav","aura","hidey","stathead","hashtags"];this.getVisualConfig=(()=>{var t={};return An.map(e=>{t[e]=ve[e]}),t}),this.xlinkLoaded=(()=>le);const Cn=["yaw","dir","kyoom","odom","monotone","aggday"];this.getGoalConfig=(()=>{let t={};return Cn.map(e=>{t[e]=ve[e]}),t}),this.msg=(t=>{t?De([t],20,null,{x:Qt/20,y:10,w:18*Qt/20,h:50},"message",!1,!0,P):Ae("message")}),this.animHor=function(t){if(T.roadEditor)return;const e=T.horizon;var a=Ot.select(".horizon"),r=Ut.select(".horizontext");const n=[["stroke-width",e.width*re*3,e.width*re]],l=[["stroke-dasharray",1.3*e.dash+","+.7*e.dash,e.dash+","+e.dash]],o=[["font-size",1.2*e.font+"px",e.font+"px"]];t?(ur(a,500,n,l,"hor"),ur(r,500,[],o,"hort")):(hr(a,300,n,l,"hor"),hr(r,300,[],o,"hort"))},this.animYBR=function(t){if(!T.roadEditor){var e=a.Cols.DYEL,r=mt.select(".razr");e=[["stroke-width",T.oldRoadLine.width*re*2,T.oldRoadLine.width*re]],t?ur(r,500,[],e,"ybrc"):hr(r,300,[],e,"ybrc")}},this.animData=function(t){if(!T.roadEditor){var e=At.selectAll(".dp"),a=[["r",T.dataPoint.size*re*2,T.dataPoint.size*re]];t?ur(e,500,a,[],"data"):hr(e,300,a,[],"data"),e=Dt.selectAll(".ap"),a=[["r",.7*T.dataPoint.size*re*2,.7*T.dataPoint.size*re]],t?ur(e,500,a,[],"dataa"):hr(e,300,a,[],"dataa")}},this.animGuides=function(t){if(T.roadEditor)return;const e=gt.selectAll(".guides"),r=[["stroke-width",T.guidelines.width*re*2.5,t=>t<0?T.guidelines.weekwidth*re:T.guidelines.width*re],["stroke",t=>t<0?a.Cols.BIGG:"#ffff00",t=>t<0?a.Cols.BIGG:a.Cols.LYEL]];t?ur(e,500,r,[],"guides"):hr(e,300,r,[],"guides")},this.animRosy=function(t){if(!T.roadEditor){var e=zt.selectAll(".rosy"),a=Tt.selectAll(".rd"),r=[["stroke-width",6*re,4*re]],n=[["r",T.dataPoint.size*re*2,T.dataPoint.size*re]];t?(ur(e,500,r,[],"rosy"),ur(a,500,[],n,"rd")):(hr(e,300,r,[],"rosy"),hr(a,300,[],n,"rd"))}},this.animMav=function(t){if(!T.roadEditor){var e=Et.selectAll(".movingav"),a=[["stroke-width",6*re,3*re]];t?ur(e,500,a,[],"mav"):hr(e,300,a,[],"mav")}},this.animYBHPlines=function(t){if(!T.roadEditor){var e=st.selectAll("#r11, #r22, #r66"),a=[["stroke-width",4*re,1.5*re]];t?ur(e,500,a,[],"ybl"):hr(e,300,a,[],"ybl")}},this.animAura=function(t){if(!T.roadEditor){var e=Rt.selectAll(".aura"),r=Rt.selectAll(".aurapast"),n=[["stroke","#9e559e",a.Cols.LPURP],["fill","#9e559e",a.Cols.LPURP]],l=[["stroke","#9e559e",a.Cols.LPURP],["fill","#9e559e",a.Cols.LPURP]],o=[["transform","translate(0,5)","translate(0,0)"]],i=[["transform","translate(0,5)","translate(0,0)"]];t?(ur(e,500,o,n,"aura"),ur(r,500,i,l,"aurap")):(hr(e,300,o,n,"aura"),hr(r,300,i,l,"aurap"))}},this.animBuf=function(t){if(!T.roadEditor){var e=Gt.selectAll(".waterbuf"),a=Number(e.attr("x")),r=Number(e.attr("y"));if("text"==e.node().tagName){let a=e.style("font-size"),n=[["font-size",1.3*(a=Number(a.substring(0,a.length-2)))+"px",a+"px"],["fill","#606060",T.watermark.color]],l=[["y",r+.1*a/3,r]];t?ur(e,500,l,n,"buf"):hr(e,300,l,n,"buf")}else{let n=T.watermark.height,l=[["width",1.3*n,n],["height",1.3*n,n],["x",a-.15*n,a],["y",r-.15*n,r]];t?ur(e,500,l,[],"buf"):hr(e,300,l,[],"buf")}}},this.animBux=function(t){if(!T.roadEditor){var e=Gt.selectAll(".waterbux"),a=e.style("font-size");a=Number(a.substring(0,a.length-2));var r=Number(e.attr("y")),n=[["font-size",1.3*a+"px",a+"px"],["fill","#606060",T.watermark.color]],l=[["y",r+.15*a,r]];t?ur(e,500,l,n,"bux"):hr(e,300,l,n,"bux")}}}});