!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["moment","Polyfit","butil"],t):"object"==typeof module&&module.exports?module.exports=t(require("./moment"),require("./polyfit"),require("./butil")):e.broad=t(e.moment,e.Polyfit,e.butil)}(this,function(e,t,n){"use strict";const r=Math.max,l=Math.min,i=Math.abs,s=Math.pow,o=Math.floor,a=(Math.ceil,Math.sign,Math.sqrt),u=86400;var d={rsk8:0};d.AGGR={last:e=>e[e.length-1],first:e=>e[0],min:e=>n.arrMin(e),max:e=>n.arrMax(e),truemean:e=>n.mean(e),uniqmean:e=>n.mean(n.deldups(e)),average:e=>n.mean(e),mean:e=>n.mean(n.deldups(e)),median:e=>n.median(e),mode:e=>n.mode(e),trimmean:e=>n.trimmean(e,.1),sum:e=>n.sum(e),jolly:e=>e.length>0?1:0,binary:e=>e.length>0?1:0,nonzero:n.nonzero,triangle:e=>n.sum(e)*(n.sum(e)+1)/2,square:e=>s(n.sum(e),2),clocky:n.clocky,count:e=>e.length,kyshoc:e=>l(2600,n.sum(e)),skatesum:e=>l(d.rsk8,n.sum(e)),cap1:e=>l(1,n.sum(e)),sqrt:e=>a(n.sum(e))},d.RP={DATE:0,VALUE:1,SLOPE:2},d.printRoad=(e=>{for(let r=0;r<e.length;r++){var t=e[r];console.debug("[("+t.sta[0]+"("+n.formatDate(t.sta[0])+"),"+t.sta[1]+"),("+t.end[0]+"("+n.formatDate(t.end[0])+"),"+t.end[1]+"),"+t.slope+", auto="+t.auto+"]")}}),d.sameRoads=((e,t)=>{if(e.length!=t.length)return!1;for(let r=0;r<e.length;r++){if(!n.nearEq(e[r].end[0],t[r].end[0],10))return!1;if(!n.nearEq(e[r].end[1],t[r].end[1],10))return!1;if(!n.nearEq(e[r].slope,t[r].slope,1e-14))return!1}return!0}),d.copyRoad=(e=>{var t=[];for(let r=0;r<e.length;r++){var n={sta:e[r].sta.slice(),end:e[r].end.slice(),slope:e[r].slope,auto:e[r].auto};t.push(n)}return t}),d.findSeg=((e,t)=>n.searchHigh(e,e=>e.end[0]<t?-1:e.sta[0]>t?1:0)),d.segSlope=(e=>(e.end[1]-e.sta[1])/(e.end[0]-e.sta[0])),d.segValue=((e,t)=>e.sta[1]+e.slope*(t-e.sta[0])),d.rdf=((e,t)=>d.segValue(e[d.findSeg(e,t)],t)),d.fixRoadArray=((e,t=d.RP.VALUE,r=!1,l=d.RP.VALUE)=>{const i=e.length;e[0].sta[0]=e[0].end[0]-315576e4,e[0].sta[1]=e[0].end[1];for(let o=1;o<i-1;o++){r&&(t=e[o].auto);var s=e[o].end[1]-e[o].sta[1];e[o].sta[0]=e[o-1].end[0],e[o].sta[1]=e[o-1].end[1],t===d.RP.DATE?(isFinite(e[o].slope)&&0!=e[o].slope&&(e[o].end[0]=n.daysnap(e[o].sta[0]+(e[o].end[1]-e[o].sta[1])/e[o].slope)),e[o].end[0]<=e[o].sta[0]&&(e[o].end[0]=n.daysnap(e[o].sta[0]+u)),l===d.RP.SLOPE?e[o].end[1]=e[o].sta[1]+e[o].slope*(e[o].end[0]-e[o].sta[0]):e[o].slope=d.segSlope(e[o])):t===d.RP.VALUE?isFinite(e[o].slope)?e[o].end[1]=e[o].sta[1]+e[o].slope*(e[o].end[0]-e[o].sta[0]):e[o].end[1]=e[o].sta[1]+s:t===d.RP.SLOPE&&(e[o].slope=d.segSlope(e[o]))}i>1&&(e[i-1].sta[0]=e[i-2].end[0],e[i-1].sta[1]=e[i-2].end[1],e[i-1].end[0]=e[i-1].sta[0]+315576e4,e[i-1].end[1]=e[i-1].sta[1])}),d.gdelt=((e,t,r,l)=>n.chop(t.yaw*(l-d.rdf(e,r)))),d.aok=((e,t,n,r)=>t.yaw*(r-d.rdf(e,n))>=-1e-15*i(r)),d.pprtype=1,d.dailymin=0,d.ppr=((e,t,n,i=null,s=!1)=>{if(!s&&n<=t.asof&&(!t.ppr||t.tdat===t.asof))return 0;if(t.yaw*t.dir>=0)return 0;const o=null!==i?e[i].slope*u:d.rtf(e,n)*u,a=t.yaw;let f=-a*d.dailymin;switch(d.pprtype){case 0:return 0===o?2*-a:a*o>0?0:2*o;case 1:return 0===o&&0===f&&(f=2*-a),a*l(a*f,2*a*o);case 2:return a<0?r(0,f+o):l(0,f+o)}}),d.dtd=((e,t,n,l)=>{if(d.redyest(e,t,n))return 0;let i=0,s=l+d.ppr(e,t,n+i*u);for(;d.aok(e,t,n+i*u,s)&&n+i*u<=r(t.tfin,n);)i+=1,s+=d.ppr(e,t,n+i*u);return i}),d.dtdarray=((e,t)=>{let n,r,l,i,s=e.length,o=e[s-1].sta[0],a=e[s-1].sta[1],f=d.ppr(e,t,0,s-1),h=[];h=[[[o,a,0,a-f,1]]];for(let g=s-2;g>=0;g--){o=e[g].sta[0],a=e[g].sta[1],n=e[g].end[0],r=e[g].end[1],f=d.ppr(e,t,0,g,!0),l=(n-o)/u,i=isFinite(f)?[[o,a,0,r-f*l,l]]:(t.dir,[[o,a,0,r,l]]);for(var p=h[h.length-1],c=0;c<p.length;c++)isFinite(f)?i.push([o,p[c][1]-f*l,p[c][2]+l,p[c][3]-f*l,p[c][4]+l]):t.dir*(a-r)>0?i.push([o,p[c][1],p[c][2],p[c][3],p[c][4]]):i.push([o,p[c][1],p[c][2]+(n-o),p[c][3],p[c][4]+(n-o)]);h.push(i)}return h}),d.isoline_generate=((e,t,n,r)=>{var l,i,s,o,a,u,d,f,h=t[0],p=0;function c(e,t){var n=e[e.length-1];n[0]==t[0]&&n[1]==t[1]||e.push(t)}for(i=[[h[0][0]+864e3,h[0][1]+r*(h[0][3]-h[0][1])],[h[0][0],h[0][1]+r*(h[0][3]-h[0][1])]],o=1;o<t.length;o++){for(s=(l=t[o]).length-1,a=0;a<l.length;a++)if(r<=l[a][4]){s=a;break}for(a=p;a>=s;a--)u=[h[a][0],h[a][1],h[a][2]],(d=[l[a][0],l[a][3],l[a][4]])[2]-u[2]==0?c(i,[u[0],u[1]]):(f=(r-u[2])/(d[2]-u[2]),c(i,[u[0]+f*(d[0]-u[0]),u[1]+f*(d[1]-u[1])]));u=[l[s][0],l[s][1],l[s][2]],(d=[l[s][0],l[s][3],l[s][4]])[2]-u[2]==0?c(i,[u[0],u[1]]):(f=(r-u[2])/(d[2]-u[2]),c(i,[u[0]+f*(d[0]-u[0]),u[1]+f*(d[1]-u[1])])),p=s,h=l}return i.reverse()}),d.isoline_dolessclip=((e,t,r,l,i)=>{if(0==i)return e;const s=(e,n)=>{let r=t[n],i=d.ppr(t,l,r.sta[0],n,!0);return[[e[0],e[1]],[r.end[0],e[1]+i*(r.end[0]-e[0])/u]]};let o,a,f,h,p=[],c=!1,g=!1;const m=function(e,t){e.push([t[0],t[1]])};for(f=0;f<e.length-1;)if(g||m(p,e[f]),e[f+1][0]==e[f][0]&&(e[f+1][1]-e[f][1])*l.dir>0){for(h=e[f+1][0]+i*u,a=d.findSeg(t,e[f][0]),o=s(e[f],a);f<e.length-1&&e[f+1][0]==e[f][0];)f++;(e[f][1]-o[0][1])*l.dir>0&&(c=!0,g=!0)}else if(c){if(e[f][0]>=h||o[0][0]>=h){m(p,[h,d.isoval(e,h)]),c=!1,g=!1,e[f][0]==h&&f++;continue}if(g){let r=n.lineintersect(e[f],e[f+1],o[0],o[1]);if(null!=r)m(p,r),g=!1,f++;else if(o[1][0]<=e[f+1][0]){for(m(p,o[1]),a++;!isFinite(t[a].slope);)a++;o=s(o[1],a)}else f++}else{let r=n.lineintersect(e[f],e[f+1],o[0],o[1]);if(null!=r&&r[0]!=e[f][0]&&r[0]!=e[f+1][0]&&console.log("Found intersection while on the isoline!!!"),e[f][0]>=o[1][0]){for(a++;!isFinite(t[a].slope);)a++;o=s(o[1],a)}else f++}}else f++;return p}),d.isoline_monotonicity=((e,t,n,r,l)=>{if(r.yaw*r.dir<0)return d.isoline_dolessclip(e,t,n,r,l);let i,s,o,a,f=[],h=!1,p=!1;const c=function(e,t){e.push([t[0],t[1]])};for(a=-1,o=0;o<e.length-1;o++)if((e[o+1][1]-e[o][1])*r.dir>0&&(h=!1),c(f,e[o]),0!=l&&(e[o+1][1]-e[o][1])*r.dir<0&&!h)for(h=!0,a=o+1,p=!1;!p;)e[a][0]>=e[o][0]+l*u?(p=!0,c(f,[s=e[o][0]+l*u,e[o][1]])):(e[a+1][1]-e[a][1])*r.dir>=0&&(e[a+1][0]!=e[a][0]?0!=(i=(e[a+1][1]-e[a][1])/(e[a+1][0]-e[a][0]))&&(s=e[a][0]+(e[o][1]-e[a][1])/i)<=e[o][0]+l*u&&s<=e[a+1][0]&&(p=!0):(e[o][1]-e[a][1])*(e[o][1]-e[a+1][1])<0&&(s=e[a][0]+1,p=!0),p&&c(f,[s,e[o][1]])),a++;return f}),d.isoline_nobackward=((e,t,n,r,l)=>{var i,s,o,a=[e[0].slice()];for(o=1;o<e.length;o++)i=a[a.length-1],e[o][0]<i[0]||(e[o-1][0]<i[0]&&e[o][0]>i[0]&&e[o][0]-e[o-1][0]!=0&&(s=(e[o][1]-e[o-1][1])/(e[o][0]-e[o-1][0]),a.push([i[0],e[o-1][1]+s*(i[0]-e[o-1][0])])),a.push([e[o][0],e[o][1]]));return a}),d.isoline_clip=((e,t,i,s,o)=>{var a=[];function u(e,t,n,i=-1){for(var s=n.slice(),o=d.findSeg(e,n[0]),a=d.segValue(e[o],n[0]);--o>=0&&e[o].sta[0]==n[0];)a=-i*t.yaw>0?l(a,e[o].sta[1]):r(a,e[o].sta[1]);return(s[1]-a)*t.yaw<0&&(s[1]=a),s}var f,h=0,p=0;for(f=e[1][0]!=e[0][0]?1:-1,a.push(u(t,s,e[0],f));!(h>t.length-1||p>e.length-2);){var c=a.length-1,g=n.lineintersect(t[h].sta,t[h].end,e[p],e[p+1]);null==g||g[0]==a[c][0]&&g[1]==a[c][1]||a.push(g),t[h].end[0]<e[p+1][0]?((n.lineval(e[p],e[p+1],t[h].end[0])-t[h].end[1])*s.yaw<0&&a.push([t[h].end[0],t[h].end[1]]),h++):(f=++p<e.length-1&&e[p][0]!=e[p+1][0]?1:-1,a.push(u(t,s,e[p],f)))}return a}),d.isoline=((e,t,n,r,l=!1)=>{let i=d.isoline_generate(e,t,n,r),s=d.isoline_monotonicity(i,e,t,n,r),o=d.isoline_nobackward(s,e,t,n,r),a=d.isoline_clip(o,e,t,n,r);return l?[i,s,o,a]:a}),d.isoval=((e,t)=>{if(!e||!e.length)return null;if(t<=e[0][0])return e[0][1];if(t>=e[e.length-1][0])return e[e.length-1][1];const r=n.searchLow(e,e=>e[0]<=t?-1:1);return n.rescale(t,e[r][0],e[r+1][0],e[r][1],e[r+1][1])}),d.isoside=((e,t,n,r)=>{const l=d.isoval(t,n);return null===l?0:(r-l)*e.yaw>=-1e-15*i(r)?1:-1}),d.dtd_walk=((e,t,n,r)=>{let l=0;for(;d.gdelt(e,t,n+l*u,r)>=0&&n+l*u<=t.tfin;)l+=1;return l}),d.bufcap=((e,t,n=7)=>{const r=t.tcur,l=d.rdf(e,r),s=i(d.rtf(e,r));let o=0,a=0;for(;d.dtd_walk(e,t,r,l+o)<n&&a<=70;)o+=t.yaw*s*u,a+=1;return[o,a]}),d.tvr=((e,t,r,i,s)=>null===r?0===s?n.BDUSK:n.daysnap(l(n.BDUSK,e+(i-t)/s)):null===i?t+s*(r-e):null===s?r===e?0:(i-t)/(r-e):0);const f=(e,t)=>{const n=e[0],r=e[1],l=(e[2],e[3],t[0]),i=t[1],s=t[2],o=d.tvr(n,r,l,i,s);return null===l?[o,i,s,0]:null===i?[l,o,s,1]:null===s?[l,i,o,2]:[l,i,o,0]};return d.fillroad=((e,t)=>{e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]/t.siru),e[0]=f([t.tini,t.vini,0,0],e[0]);for(let t=1;t<e.length;t++)e[t]=f(e[t-1],e[t]);for(e.forEach(e=>e[2]=null==e[2]?e[2]:e[2]*t.siru);void 0!==e&&void 0!==e[0]&&e[0][0]<t.tini;)e.shift();return e}),d.fillroadall=((e,t)=>{const n=e[0][0],r=e[0][1];e.splice(0,1),e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]/t.siru),e[0]=f([n,r,0,0],e[0]);for(let t=1;t<e.length;t++)e[t]=f(e[t-1],e[t]);return e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]*t.siru),e.unshift([n,r,0,2]),e}),d.rtf=((e,t)=>e[d.findSeg(e,t)].slope),d.odomify=(e=>{if(!e||!e.length||0===e.length)return;let t=0,n=e[0][1];for(let r=1;r<e.length;r++)0===e[r][1]&&(t+=n),n=e[r][1],e[r][1]+=t}),d.stepFunc=((e,t)=>{return e[r(0,n.searchLow(e,e=>e[0]-t))][1]}),d.stepify=(e=>e&&e.length?t=>d.stepFunc(e,t):e=>0),d.dotcolor=((e,t,r,l,i=null)=>r<t.tini?n.BHUE.BLCK:null===i?d.aok(e,t,r,l)?n.BHUE.BLCK:n.BHUE.REDDOT:!i||!i.length||i.length<1?n.BHUE.ERRDOT:d.isoside(t,i[0],r,l)<0?n.BHUE.REDDOT:d.isoside(t,i[1],r,l)<0?n.BHUE.ORNDOT:d.isoside(t,i[2],r,l)<0?n.BHUE.BLUDOT:d.isoside(t,i[6],r,l)<0?n.BHUE.GRNDOT:n.BHUE.GRADOT),d.redyest=((e,t,r,l=null)=>d.dotcolor(e,t,r-u,t.dtf(r-u),l)===n.BHUE.REDDOT),d.stdflux=((e,t)=>{if(!t||!t.length||t.length<=1)return 0;const r=n.partition(t,2,1);let l,s,o,a,f=[];for(let t=0;t<r.length;t++)l=r[t][0][0],s=r[t][0][1],o=r[t][1][0],a=r[t][1][1],f.push(i(a-s-d.rdf(e,o)+d.rdf(e,l))/(o-l)*u);return n.chop(1===f.length?f[0]:n.quantile(f,.9))}),d.autowiden=((e,t,l,s)=>{let o=l;if(o<=1)return 0;let a=-1;if(d.gdelt(e,t,l[l.length-1][0],l[l.length-1][1])<0){for(;a>=-o&&d.gdelt(e,t,l[a][0],l[a][1])<0;)a-=1;(a+=1)>-o&&l[a][0]-l[a-1][0]<=u&&(s=r(s,i(l[a][1]-d.rdf(e,l[a][0]))))}return n.chop(s)}),d.vertseg=((e,t)=>e.filter(e=>e.sta[0]===t).length>1),d.gapFill=(e=>{if(!e||!e.length)return[];const t=(e,t,n)=>e+(t-e)*n;var n,r=e[0][0],l=e[e.length-1][0],i=o((l-r)/u),s=Array(i),a=0,d=r;for(n=0;n<e.length-1;n++)for(var f=e[n+1][0]-e[n][0];d<=e[n+1][0];)s[a]=[d,t(e[n][1],e[n+1][1],(d-e[n][0])/f)],a++,d+=u;return 0===s.length&&s.push(e[0]),s}),d.smooth=(e=>{if(!e||!e.length)return e=>e;const s=(e[0][0]+e[e.length-1][0])/2,o=n.zip(e),a=o[0].map(e=>(e-s)/u),d=new t(a,o[1]);let f=d.getPolynomial(3);const h=i(r(...o[1])-l(...o[1]));return d.standardError(d.computeCoefficients(3))>1e4*h&&(console.log("butil.smooth: Possible ill-conditioned polyfit. Reducing dimension."),f=d.getPolynomial(2)),e=>f((e-s)/u)}),d.smooth2=(e=>{if(!e||!e.length)return e=>e;const t=n.zip(e);n.splinefit(t[0],t[1]);return e=>e}),d.interpData=((e,t)=>{var n=(e,t,n)=>e+(t-e)*n,r=0,l=e.length,i=[];if(0===l)return null;if(1===l)return t.map(e=>[e,e[0][1]]);for(let o=0;o<t.length;o++){var s=t[o];if(s<=e[0][0])i.push([s,e[0][1]]);else if(s>=e[l-1][0])i.push([s,e[l-1][1]]);else if(s<e[r+1][0])i.push([s,n(e[r][1],e[r+1][1],(s-e[r][0])/(e[r+1][0]-e[r][0]))]);else{for(;s>e[r+1][0];)r++;i.push([s,n(e[r][1],e[r+1][1],(s-e[r][0])/(e[r+1][0]-e[r][0]))])}}return i}),d.lim=((e,t,n)=>d.rdf(e,t.tcur+n*u)),d.limd=((e,t,n)=>d.lim(e,t,n)-t.vcur),d.dueby=((e,t,r)=>{let l=[...Array(r).keys()].map(r=>[n.dayify(t.tcur+r*u),d.limd(e,t,r),d.lim(e,t,r)]);const i=n.zip(l);return n.zip([i[0],n.monotonize(i[1],t.dir),n.monotonize(i[2],t.dir)])}),d});