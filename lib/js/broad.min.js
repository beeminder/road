!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["moment","Polyfit","butil"],t):"object"==typeof module&&module.exports?module.exports=t(require("./moment"),require("./polyfit"),require("./butil")):e.broad=t(e.moment,e.Polyfit,e.butil)}(this,function(e,t,n){"use strict";const r=Math.max,l=Math.min,o=Math.abs,s=Math.pow,i=Math.floor,a=(Math.ceil,Math.sign,86400);var u={rsk8:0};u.AGGR={last:e=>e[e.length-1],first:e=>e[0],min:e=>n.arrMin(e),max:e=>n.arrMax(e),truemean:e=>n.mean(e),uniqmean:e=>n.mean(n.deldups(e)),average:e=>n.mean(e),mean:e=>n.mean(n.deldups(e)),median:e=>n.median(e),mode:e=>n.mode(e),trimmean:e=>n.trimmean(e,.1),sum:e=>n.sum(e),jolly:e=>e.length>0?1:0,binary:e=>e.length>0?1:0,nonzero:n.nonzero,triangle:e=>n.sum(e)*(n.sum(e)+1)/2,square:e=>s(n.sum(e),2),clocky:n.clocky,count:e=>e.length,kyshoc:e=>l(2600,n.sum(e)),skatesum:e=>l(u.rsk8,n.sum(e)),cap1:e=>l(1,n.sum(e))},u.RP={DATE:0,VALUE:1,SLOPE:2},u.printRoad=(e=>{for(let r=0;r<e.length;r++){var t=e[r];console.debug("[("+t.sta[0]+"("+n.formatDate(t.sta[0])+"),"+t.sta[1]+"),("+t.end[0]+"("+n.formatDate(t.end[0])+"),"+t.end[1]+"),"+t.slope+", auto="+t.auto+"]")}}),u.sameRoads=((e,t)=>{if(e.length!=t.length)return!1;for(let r=0;r<e.length;r++){if(!n.nearEq(e[r].end[0],t[r].end[0],10))return!1;if(!n.nearEq(e[r].end[1],t[r].end[1],10))return!1;if(!n.nearEq(e[r].slope,t[r].slope,1e-14))return!1}return!0}),u.copyRoad=(e=>{var t=[];for(let r=0;r<e.length;r++){var n={sta:e[r].sta.slice(),end:e[r].end.slice(),slope:e[r].slope,auto:e[r].auto};t.push(n)}return t}),u.findSeg=((e,t)=>n.searchHigh(e,e=>e.end[0]<t?-1:e.sta[0]>t?1:0)),u.segSlope=(e=>(e.end[1]-e.sta[1])/(e.end[0]-e.sta[0])),u.segValue=((e,t)=>e.sta[1]+e.slope*(t-e.sta[0])),u.rdf=((e,t)=>u.segValue(e[u.findSeg(e,t)],t)),u.fixRoadArray=((e,t=u.RP.VALUE,r=!1,l=u.RP.VALUE)=>{const o=e.length;e[0].sta[0]=e[0].end[0]-315576e4,e[0].sta[1]=e[0].end[1];for(let i=1;i<o-1;i++){r&&(t=e[i].auto);var s=e[i].end[1]-e[i].sta[1];e[i].sta[0]=e[i-1].end[0],e[i].sta[1]=e[i-1].end[1],t===u.RP.DATE?(isFinite(e[i].slope)&&0!=e[i].slope&&(e[i].end[0]=n.daysnap(e[i].sta[0]+(e[i].end[1]-e[i].sta[1])/e[i].slope)),e[i].end[0]<=e[i].sta[0]&&(e[i].end[0]=n.daysnap(e[i].sta[0]+a)),l===u.RP.SLOPE?e[i].end[1]=e[i].sta[1]+e[i].slope*(e[i].end[0]-e[i].sta[0]):e[i].slope=u.segSlope(e[i])):t===u.RP.VALUE?isFinite(e[i].slope)?e[i].end[1]=e[i].sta[1]+e[i].slope*(e[i].end[0]-e[i].sta[0]):e[i].end[1]=e[i].sta[1]+s:t===u.RP.SLOPE&&(e[i].slope=u.segSlope(e[i]))}o>1&&(e[o-1].sta[0]=e[o-2].end[0],e[o-1].sta[1]=e[o-2].end[1],e[o-1].end[0]=e[o-1].sta[0]+315576e4,e[o-1].end[1]=e[o-1].sta[1])}),u.gdelt=((e,t,r,l)=>n.chop(t.yaw*(l-u.rdf(e,r)))),u.aok=((e,t,n,r)=>t.yaw*(r-u.rdf(e,n))>=-1e-15*o(r)),u.ppr=((e,t,n,r=null,l=!1)=>{return t.yaw*t.dir>=0?0:l||!(n<=t.asof)||t.ppr&&t.tdat!==t.asof?0===(o=null!=r?e[r].slope*a:u.rtf(e,n)*a)?2*-t.yaw:t.yaw*o>0?0:2*o:0;var o}),u.dtd=((e,t,n,l)=>{if(u.redyest(e,t,n))return 0;let o=0,s=l+u.ppr(e,t,n+o*a);for(;u.aok(e,t,n+o*a,s)&&n+o*a<=r(t.tfin,n);)o+=1,s+=u.ppr(e,t,n+o*a);return o}),u.dtdarray=((e,t)=>{var n,r,l,o,s=e.length,i=e[s-1].sta[0],d=e[s-1].sta[1],f=u.ppr(e,t,0,s-1),h=[];h=[[[i,d,0,d-f,1]]];for(var p=s-2;p>=0;p--){i=e[p].sta[0],d=e[p].sta[1],n=e[p].end[0],r=e[p].end[1],f=u.ppr(e,t,0,p,!0),l=(n-i)/a,o=isFinite(f)?[[i,d,0,r-f*l,l]]:t.dir*(d-r)>0?[[i,d,0,r,l]]:[[i,d,0,r-2*(r-d),l]];for(var g=h[h.length-1],c=0;c<g.length;c++)isFinite(f)?o.push([i,g[c][1]-f*l,g[c][2]+l,g[c][3]-f*l,g[c][4]+l]):t.dir*(d-r)>0?o.push([i,g[c][1],g[c][2],g[c][3],g[c][4]]):o.push([i,g[c][1]-2*(r-d),g[c][2]+(n-i),g[c][3]-2*(r-d),g[c][4]+(n-i)]);h.push(o)}return h}),u.isoline_generate=((e,t,n,r)=>{var l,o,s,i,a,u,d,f,h=t[0],p=0;function g(e,t){var n=e[e.length-1];n[0]==t[0]&&n[1]==t[1]||e.push(t)}for(o=[[h[0][0]+864e3,h[0][1]+r*(h[0][3]-h[0][1])],[h[0][0],h[0][1]+r*(h[0][3]-h[0][1])]],i=1;i<t.length;i++){for(s=(l=t[i]).length-1,a=0;a<l.length;a++)if(r<=l[a][4]){s=a;break}for(a=p;a>=s;a--)u=[h[a][0],h[a][1],h[a][2]],(d=[l[a][0],l[a][3],l[a][4]])[2]-u[2]==0?g(o,[u[0],u[1]]):(f=(r-u[2])/(d[2]-u[2]),g(o,[u[0]+f*(d[0]-u[0]),u[1]+f*(d[1]-u[1])]));u=[l[s][0],l[s][1],l[s][2]],(d=[l[s][0],l[s][3],l[s][4]])[2]-u[2]==0?g(o,[u[0],u[1]]):(f=(r-u[2])/(d[2]-u[2]),g(o,[u[0]+f*(d[0]-u[0]),u[1]+f*(d[1]-u[1])])),p=s,h=l}return o.reverse()}),u.isoline_monotonicity=((e,t,n,r,l)=>{if(r.yaw*r.dir<0)return e;let o,s,i,u,d=[],f=!1,h=!1;const p=function(e,t){e.push([t[0],t[1]])};for(u=-1,i=0;i<e.length-1;i++)if((e[i+1][1]-e[i][1])*r.dir>0&&(f=!1),p(d,e[i]),0!=l&&(e[i+1][1]-e[i][1])*r.dir<0&&!f)for(f=!0,u=i+1,h=!1;!h;)e[u][0]>=e[i][0]+l*a?(h=!0,p(d,[s=e[i][0]+l*a,e[i][1]])):(e[u+1][1]-e[u][1])*r.dir>=0&&(e[u+1][0]!=e[u][0]?0!=(o=(e[u+1][1]-e[u][1])/(e[u+1][0]-e[u][0]))&&(s=e[u][0]+(e[i][1]-e[u][1])/o)<=e[i][0]+l*a&&s<=e[u+1][0]&&(h=!0):(e[i][1]-e[u][1])*(e[i][1]-e[u+1][1])<0&&(s=e[u][0]+1,h=!0),h&&p(d,[s,e[i][1]])),u++;return d}),u.isoline_nobackward=((e,t,n,r,l)=>{var o,s,i,a=[e[0].slice()];for(i=1;i<e.length;i++)o=a[a.length-1],e[i][0]<o[0]||(e[i-1][0]<o[0]&&e[i][0]>o[0]&&e[i][0]-e[i-1][0]!=0&&(s=(e[i][1]-e[i-1][1])/(e[i][0]-e[i-1][0]),a.push([o[0],e[i-1][1]+s*(o[0]-e[i-1][0])])),a.push([e[i][0],e[i][1]]));return a}),u.isoline_clip=((e,t,n,o,s)=>{var i=[];function a(e,t,n){var r=(t[1]-e[1])/(t[0]-e[0]);return e[1]+r*(n-e[0])}function d(e,t,n,r){const l=t[0]-e[0],o=t[1]-e[1],s=-(r[0]-n[0]),i=-(r[1]-n[1]),a=n[0]-e[0],u=n[1]-e[1],d=l*i-s*o;if(0==d)return null;const f=(i*a-s*u)/d,h=(-o*a+l*u)/d;return f<0||f>1||h<0||h>1?null:[e[0]+f*l,e[1]+f*o]}function f(e,t,n,o=-1){for(var s=n.slice(),i=u.findSeg(e,n[0]),a=u.segValue(e[i],n[0]);--i>=0&&e[i].sta[0]==n[0];)a=-o*t.yaw>0?l(a,e[i].sta[1]):r(a,e[i].sta[1]);return(s[1]-a)*t.yaw<0&&(s[1]=a),s}var h,p=0,g=0;for(h=e[1][0]!=e[0][0]?1:-1,i.push(f(t,o,e[0],h));!(p>t.length-1||g>e.length-2);){var c=i.length-1,m=d(t[p].sta,t[p].end,e[g],e[g+1]);null==m||m[0]==i[c][0]&&m[1]==i[c][1]||i.push(m),t[p].end[0]<e[g+1][0]?((a(e[g],e[g+1],t[p].end[0])-t[p].end[1])*o.yaw<0&&i.push([t[p].end[0],t[p].end[1]]),p++):(h=++g<e.length-1&&e[g][0]!=e[g+1][0]?1:-1,i.push(f(t,o,e[g],h)))}return i}),u.isoline=((e,t,n,r,l=!1)=>{let o=u.isoline_generate(e,t,n,r),s=u.isoline_monotonicity(o,e,t,n,r),i=u.isoline_nobackward(s,e,t,n,r),a=u.isoline_clip(i,e,t,n,r);return l?[o,s,i,a]:a}),u.isoval=((e,t)=>{if(!e||!e.length)return null;if(t<=e[0][0])return e[0][1];if(t>=e[e.length-1][0])return e[e.length-1][1];const r=n.searchLow(e,e=>e[0]<=t?-1:1);return n.rescale(t,e[r][0],e[r+1][0],e[r][1],e[r+1][1])}),u.isoside=((e,t,n,r)=>{const l=u.isoval(t,n);return null===l?0:(r-l)*e.yaw>=-1e-15*o(r)?1:-1}),u.dtd_walk=((e,t,n,r)=>{let l=0;for(;u.gdelt(e,t,n+l*a,r)>=0&&n+l*a<=t.tfin;)l+=1;return l}),u.bufcap=((e,t,n=7)=>{const r=t.tcur,l=u.rdf(e,r),s=o(u.rtf(e,r));let i=0,d=0;for(;u.dtd_walk(e,t,r,l+i)<n&&d<=70;)i+=t.yaw*s*a,d+=1;return[i,d]}),u.tvr=((e,t,r,o,s)=>null===r?0===s?n.BDUSK:n.daysnap(l(n.BDUSK,e+(o-t)/s)):null===o?t+s*(r-e):null===s?r===e?0:(o-t)/(r-e):0);const d=(e,t)=>{const n=e[0],r=e[1],l=(e[2],e[3],t[0]),o=t[1],s=t[2],i=u.tvr(n,r,l,o,s);return null===l?[i,o,s,0]:null===o?[l,i,s,1]:null===s?[l,o,i,2]:[l,o,i,0]};return u.fillroad=((e,t)=>{e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]/t.siru),e[0]=d([t.tini,t.vini,0,0],e[0]);for(let t=1;t<e.length;t++)e[t]=d(e[t-1],e[t]);for(e.forEach(e=>e[2]=null==e[2]?e[2]:e[2]*t.siru);void 0!==e&&void 0!==e[0]&&e[0][0]<t.tini;)e.shift();return e}),u.fillroadall=((e,t)=>{const n=e[0][0],r=e[0][1];e.splice(0,1),e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]/t.siru),e[0]=d([n,r,0,0],e[0]);for(let t=1;t<e.length;t++)e[t]=d(e[t-1],e[t]);return e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]*t.siru),e.unshift([n,r,0,2]),e}),u.rtf=((e,t)=>e[u.findSeg(e,t)].slope),u.odomify=(e=>{if(!e||!e.length||0===e.length)return;let t=0,n=e[0][1];for(let r=1;r<e.length;r++)0===e[r][1]&&(t+=n),n=e[r][1],e[r][1]+=t}),u.stepFunc=((e,t)=>{return e[r(0,n.searchLow(e,e=>e[0]-t))][1]}),u.stepify=(e=>e&&e.length?t=>u.stepFunc(e,t):e=>0),u.dotcolor=((e,t,r,l,o=null)=>r<t.tini?n.Cols.BLCK:null===o?u.aok(e,t,r,l)?n.Cols.BLCK:n.Cols.REDDOT:!o||!o.length||o.length<1?n.Cols.ERRDOT:u.isoside(t,o[0],r,l)<0?n.Cols.REDDOT:u.isoside(t,o[1],r,l)<0?n.Cols.ORNDOT:u.isoside(t,o[2],r,l)<0?n.Cols.BLUDOT:u.isoside(t,o[6],r,l)<0?n.Cols.GRNDOT:n.Cols.GRADOT),u.redyest=((e,t,r,l=null)=>u.dotcolor(e,t,r-a,t.dtf(r-a),l)===n.Cols.REDDOT),u.stdflux=((e,t)=>{if(!t||!t.length||t.length<=1)return 0;const r=n.partition(t,2,1);let l,s,i,d,f=[];for(let t=0;t<r.length;t++)l=r[t][0][0],s=r[t][0][1],i=r[t][1][0],d=r[t][1][1],f.push(o(d-s-u.rdf(e,i)+u.rdf(e,l))/(i-l)*a);return n.chop(1===f.length?f[0]:n.quantile(f,.9))}),u.autowiden=((e,t,l,s)=>{let i=l;if(i<=1)return 0;let d=-1;if(u.gdelt(e,t,l[l.length-1][0],l[l.length-1][1])<0){for(;d>=-i&&u.gdelt(e,t,l[d][0],l[d][1])<0;)d-=1;(d+=1)>-i&&l[d][0]-l[d-1][0]<=a&&(s=r(s,o(l[d][1]-u.rdf(e,l[d][0]))))}return n.chop(s)}),u.vertseg=((e,t)=>e.filter(e=>e.sta[0]===t).length>1),u.gapFill=(e=>{if(!e||!e.length)return[];const t=(e,t,n)=>e+(t-e)*n;var n,r=e[0][0],l=e[e.length-1][0],o=i((l-r)/a),s=Array(o),u=0,d=r;for(n=0;n<e.length-1;n++)for(var f=e[n+1][0]-e[n][0];d<=e[n+1][0];)s[u]=[d,t(e[n][1],e[n+1][1],(d-e[n][0])/f)],u++,d+=a;return 0===s.length&&s.push(e[0]),s}),u.smooth=(e=>{if(!e||!e.length)return e=>e;const s=(e[0][0]+e[e.length-1][0])/2,i=n.zip(e),u=i[0].map(e=>(e-s)/a),d=new t(u,i[1]);let f=d.getPolynomial(3);const h=o(r(...i[1])-l(...i[1]));return d.standardError(d.computeCoefficients(3))>1e4*h&&(console.log("butil.smooth: Possible ill-conditioned polyfit. Reducing dimension."),f=d.getPolynomial(2)),e=>f((e-s)/a)}),u.interpData=((e,t)=>{var n=(e,t,n)=>e+(t-e)*n,r=0,l=e.length,o=[];if(0===l)return null;if(1===l)return t.map(e=>[e,e[0][1]]);for(let i=0;i<t.length;i++){var s=t[i];if(s<=e[0][0])o.push([s,e[0][1]]);else if(s>=e[l-1][0])o.push([s,e[l-1][1]]);else if(s<e[r+1][0])o.push([s,n(e[r][1],e[r+1][1],(s-e[r][0])/(e[r+1][0]-e[r][0]))]);else{for(;s>e[r+1][0];)r++;o.push([s,n(e[r][1],e[r+1][1],(s-e[r][0])/(e[r+1][0]-e[r][0]))])}}return o}),u.lim=((e,t,n)=>u.rdf(e,t.tcur+n*a)),u.limd=((e,t,n)=>u.lim(e,t,n)-t.vcur),u.dueby=((e,t,r)=>{let l=[...Array(r).keys()].map(r=>[n.dayify(t.tcur+r*a),u.limd(e,t,r),u.lim(e,t,r)]);const o=n.zip(l);return n.zip([o[0],n.monotonize(o[1],t.dir),n.monotonize(o[2],t.dir)])}),u});