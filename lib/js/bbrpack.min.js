!function(t,n){"use strict";"function"==typeof define&&define.amd?define(["moment"],n):"object"==typeof module&&module.exports?module.exports=n(require("./moment")):t.butil=n(t.moment)}(this,function(t){"use strict";const n=Math.min,e=Math.max,r=Math.abs,u=Math.pow,o=Math.log10,i=Math.floor,l=Math.round,f=Math.sign,c=86400,s=7*c,a={y:365.25*c,m:365.25*c/12,w:7*c,d:c,h:3600};function d(t){return Array.isArray(t)}function h(t,n=1e-7){return r(t)<n?0:t}function m(t,n,e){return n>e&&([n,e]=[e,n]),t<n?n:t>e?e:t}function p(t,n=10,e=5,f=0){if(isNaN(t))return t.toString();t=h(t);let c,s,a=i(r(t));a=0===a?0:a.toString().length,r(t)>u(10,a)-.5&&(a+=1),c=0===a&&0!==t?i(e-o(r(t))):e;let d=t*u(10,c),g=d%10;g<0&&(g+=10),g>=4.5&&g<4.9999999&&(d=i(d));let y=l(d)/u(10,c)+1e-10;if(f<0&&y>t||f>0&&y<t){if(!(e>=10))return p(t,n,e+1,f);y=t}return n<a&&r(u(10,a-1)-y)<.5&&(y=u(10,a-1)),n=m(n,a,a+e),r(y)<1e-4||9===i(y)||99===i(y)||999===i(y)?s=parseFloat(t.toPrecision(c)).toString():(s=y.toPrecision(n)).includes("e")||(s=parseFloat(s)),s}function g(t){const n=(t="string"==typeof t?t.trim():t.toString()).charAt(0),e=t.substr(1);if("+"===n&&(t=e),"-"===n)return"-"+g(e);t=t.replace(/^0+([^eE])/,"$1");if(/^(?:\d+\.?\d*|\.\d+)$/.test(t))return t;const r=t.match(/^(\d+\.?\d*|\.\d+)e([+-]?\d+)$/i);if(!r||3!==r.length)return"NaN";let[,u,o]=r,i=u.indexOf(".");return-1===i&&(i=u.length),i+=+o,u=u.replace(/\./,""),i<0?"."+"0".repeat(-i)+u:(i>u.length?u+="0".repeat(i-u.length):u=u.substring(0,i)+"."+u.substring(i),u.replace(/\.$/,"").replace(/^0+(.)/,"$1"))}function y(t,n=1){if(n<0)return NaN;if(0===n)return+t;const e=l(t/n),r=g(n).match(/^0?\.(0*)10*$/);return r?+g(`${e}e${-r[1].length-1}`):e*n}function N(n){let e=t.unix(n).utc(),r=e.year(),u=e.month()+1;u=u<10?"0"+u.toString():u.toString();let o=e.date();return r+"."+u+"."+(o=o<10?"0"+o.toString():o.toString())}let R=RegExp("^(\\d{4})(\\d{2})(\\d{2})$"),E="YYYYMMDD";return{MAXTIME:6e4,BBURL:"http://brain.beeminder.com/",BHUE:{DYEL:"#ffff44",LYEL:"#ffff88",ROSE:"#ff8080",AKRA:"#4C4Cff",PURP:"#B56bb5",LPURP:"#E5BbE5",BLUE:"#EAEAFF",GRUE:"#b5ffDE",ORNG:"#ff8000",WITE:"#ffffff",BIGG:"#ffe54c",PINK:"#ffe5e5",PNKE:"#ffcccc",GRAY:"#f0f0f0",BLCK:"#000000",REDDOT:"#ff0000",ORNDOT:"#ffa500",BLUDOT:"#3f3fff",GRNDOT:"#00aa00",GRADOT:"#228B22",ERRDOT:"#00FFFF",RAZR0:"#ff0000",RAZR1:"#ffa500",RAZR2:"#3f3fff",RAZR3:"#6BC461"},AKH:s,BDUSK:4102444799,SECS:a,UNAM:{y:"year",m:"month",w:"week",d:"day",h:"hour"},nummy:function(t){return!isNaN(parseFloat(t))&&isFinite(t)},stringy:function(t){return"string"==typeof t},listy:d,arrMin:function(t){return n.apply(null,t)},arrMax:function(t){return e.apply(null,t)},extendo:function t(n,e,r){let u,o;for(u in e)(o=void 0!==n[u])&&"object"==typeof e[u]&&null!==e[u]&&void 0===e[u].nodeName?d(e[u])?r&&(n[u]=e[u].slice(0)):n[u]=t({},e[u],r):!r&&o||(d(e[u])?n[u]=e[u].slice(0):n[u]=e[u]);return n},deepcopy:function t(n){let e,r,u;if("object"!=typeof n||null===n)return n;for(u in e=d(n)?[]:{},n)r=n[u],e[u]=t(r);return e},partition:function(t,n,e){let r=t.length,u=[];for(let o=0;o<r;o+=e)o+n<=r&&u.push(t.slice(o,o+n));return u},quantile:function(t,n,e=1,r=!1){let u;if(u=r?t:t.slice().sort((t,n)=>t-n),e<1||e>9)return null;let o=[[0,0,1,0],[.5,0,1,0],[.5,0,0,0],[0,0,0,1],[.5,0,0,1],[0,1,0,1],[1,-1,0,1],[1/3,1/3,0,1],[3/8,.25,0,1]],l=o[e-1][0],c=o[e-1][1],s=o[e-1][2],a=o[e-1][3],d=t.length,h=function(t){const n=f(t),e=i(n*t);return[n*(n*t-e),n*e]}(l+(d+c)*n-1),m=h[0],p=h[1];return p<0?u[0]:p>=d?u[d-1]:(p=i(p),0==m?u[p]:u[p]+(u[p+1]-u[p])*(s+a*m))},sum:function(t){return t.reduce((t,n)=>t+n,0)},accumulate:function(t){let n=t.length;if(0===n)return t;let e=[t[0]];for(let r=1;r<n;r++)e.push(e[e.length-1]+t[r]);return e},monotonize:function(t,r=1){let u,o=t.slice();if(1===r)for(u=1;u<o.length;u++)o[u]=e(o[u-1],o[u]);else for(u=1;u<o.length;u++)o[u]=n(o[u-1],o[u]);return o},zip:function(t){return t[0].map((n,e)=>t.map(t=>t[e]))},chop:h,clip:m,searchLow:function(t,n){if(!t||!t.length)return-1;let e,r=-1,u=t.length;for(;u-r>1;)n(t[e=i((r+u)/2)])<0?r=e:u=e;return u===t.length||0!==n(t[u])?r:u},searchHigh:function(t,n){if(!t||!t.length)return 0;let e,r=-1,u=t.length;for(;u-r>1;)n(t[e=i((r+u)/2)])<=0?r=e:u=e;return-1===r||0!==n(t[r])?u:r},shn:p,shd:function(t){return null===t?"null":N(t)},splur:function(t,n,e=""){return""===e&&(e=n+"s"),p(t,10,5)+" "+(1===t?n:e)},conservaround:function(t,n=1,e=0){let r=y(t,n);return 0===e?r:(e<0&&r>t&&(r-=n),e>0&&r<t&&(r+=n),y(r,n))},linspace:function(t,n,r){if(void 0===r&&(r=e(l(n-t)+1,1)),r<2)return 1===r?[t]:[];let u,o=Array(r);for(u=--r;u>=0;u--)o[u]=(u*n+(r-u)*t)/r;return o},rescale:function(t,n,e,u,o){return r(n-e)<1e-7?t<=(n+e)/2?u:o:u+(t-n)/(e-n)*(o-u)},deldups:function(t,n=(t=>t)){let e={};return t.filter(t=>{const r=JSON.stringify(n(t));return!(r in e)&&(e[r]=!0)})},orderedq:function(t){for(let n=0;n<t.length-1;n++)if(t[n]>t[n+1])return!1;return!0},nonzero:function(t){let n,e=t.length;for(n=0;n<e;n++)if(0!==t[n])return!0;return!1},clocky:function(t){let n=0;for(let e=1;e<t.length;e+=2)n+=t[e]-t[e-1];return n},mean:function(t){let n,e=0,r=t.length;if(0==r)return 0;for(n=0;n<r;n++)e+=t[n];return e/t.length},median:function(t){let n=0,e=t.length;return t.sort((t,n)=>t-n),n=e%2==0?(t[e/2-1]+t[e/2])/2:t[(e-1)/2]},mode:function(t){if(!t||!t.length)return NaN;let n={},e=1,r=t[0];for(const u in t)n[t[u]]=(n[t[u]]||0)+1,n[t[u]]>e&&(e=n[t[u]],r=t[u]);return r},trimmean:function(t,n){const e=i(t.length*n),r=t.sort((t,n)=>t-n).slice(e,t.length-e);return r.reduce((t,n)=>t+n)/r.length},nearEq:function(t,n,e){return r(t-n)<e},daysnap:function(n){let e=t.unix(n).utc();return e.hours(0),e.minutes(0),e.seconds(0),e.milliseconds(0),e.unix()},monthsnap:function(n){let e=t.unix(n).utc();return e.date(1).hours(0).minutes(0).seconds(0).milliseconds(0),e.unix()},yearsnap:function(n){let e=t.unix(n).utc();return e.month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),e.unix()},formatDate:N,dayparse:function(t,n=""){let e,r,u;return null==t?null:(""==n?(e=R,r=E):(e=RegExp("^(\\d{4})"+n+"(\\d{2})"+n+"(\\d{2})$"),r="YYYY"+n+"MM"+n+"DD"),(u="string"!=typeof t?null:t.match(e))?Date.UTC(u[1],u[2]-1,u[3])/1e3:isNaN(t)?NaN:Number(t))},dayify:function(n,e=""){if(isNaN(n)||n<0)return"ERROR";if(null==n)return null;let r=t.unix(n).utc(),u=r.year(),o=r.month()+1,i=r.date();return""+u+e+(o<10?"0":"")+o+e+(i<10?"0":"")+i},nowstamp:function(n,e,r){let u;if(n?t.hasOwnProperty("tz")?u=t().tz(n):(console.log("butil.nowstamp: moment-timezone is not loaded, using local time"),u=t()):(console.log("butil.nowstamp: no timezone specified, using local time"),u=t()),r){const n=t.unix(r).utc(),e=(t(u).utc()-n)/1e3;(e<0||e>2*c)&&u.year(n.year()).month(n.month()).date(n.date())}return u.subtract(e,"s"),u.format("YYYYMMDD")},loadJSON:function(t){return new Promise(function(n,e){""===t&&n(null);let r=new XMLHttpRequest;r.overrideMimeType("application/json"),r.onreadystatechange=function(){if(4==r.readyState&&("200"==r.status||"0"==r.status&&""!=r.responseText))try{n(JSON.parse(r.responseText))}catch(e){console.log("butil.loadJSON: Could not parse JSON file in "+t),console.log(e.message),n(null)}else 4==r.readyState&&n(null)},r.open("GET",t,!0),r.send(null)})},toTitleCase:function(t){return t.replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})},arrayEquals:function t(n,e){if(!(n instanceof Array&&e instanceof Array))return!1;if(n.length!=e.length)return!1;for(let r=0,u=n.length;r<u;r++)if(n[r]instanceof Array&&e[r]instanceof Array){if(!t(n[r],e[r]))return!1}else if(n[r]!==e[r])return!1;return!0},lineintersect:function(t,n,e,r){const u=n[0]-t[0],o=n[1]-t[1],i=-(r[0]-e[0]),l=-(r[1]-e[1]),f=e[0]-t[0],c=e[1]-t[1],s=u*l-i*o;if(0==s)return null;const a=(l*f-i*c)/s,d=(-o*f+u*c)/s;return a<0||a>1||d<0||d>1?null:[t[0]+a*u,t[1]+a*o]},lineval:function(t,n,e){var r=(n[1]-t[1])/(n[0]-t[0]);return t[1]+r*(e-t[0])}}});
!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["moment","Polyfit","butil"],t):"object"==typeof module&&module.exports?module.exports=t(require("./moment"),require("./polyfit"),require("./butil")):e.broad=t(e.moment,e.Polyfit,e.butil)}(this,function(e,t,n){"use strict";const r=Math.max,l=Math.min,i=Math.abs,s=Math.pow,o=Math.floor,a=(Math.ceil,Math.sign,86400);var u={rsk8:0};u.AGGR={last:e=>e[e.length-1],first:e=>e[0],min:e=>n.arrMin(e),max:e=>n.arrMax(e),truemean:e=>n.mean(e),uniqmean:e=>n.mean(n.deldups(e)),average:e=>n.mean(e),mean:e=>n.mean(n.deldups(e)),median:e=>n.median(e),mode:e=>n.mode(e),trimmean:e=>n.trimmean(e,.1),sum:e=>n.sum(e),jolly:e=>e.length>0?1:0,binary:e=>e.length>0?1:0,nonzero:n.nonzero,triangle:e=>n.sum(e)*(n.sum(e)+1)/2,square:e=>s(n.sum(e),2),clocky:n.clocky,count:e=>e.length,kyshoc:e=>l(2600,n.sum(e)),skatesum:e=>l(u.rsk8,n.sum(e)),cap1:e=>l(1,n.sum(e))},u.RP={DATE:0,VALUE:1,SLOPE:2},u.printRoad=(e=>{for(let r=0;r<e.length;r++){var t=e[r];console.debug("[("+t.sta[0]+"("+n.formatDate(t.sta[0])+"),"+t.sta[1]+"),("+t.end[0]+"("+n.formatDate(t.end[0])+"),"+t.end[1]+"),"+t.slope+", auto="+t.auto+"]")}}),u.sameRoads=((e,t)=>{if(e.length!=t.length)return!1;for(let r=0;r<e.length;r++){if(!n.nearEq(e[r].end[0],t[r].end[0],10))return!1;if(!n.nearEq(e[r].end[1],t[r].end[1],10))return!1;if(!n.nearEq(e[r].slope,t[r].slope,1e-14))return!1}return!0}),u.copyRoad=(e=>{var t=[];for(let r=0;r<e.length;r++){var n={sta:e[r].sta.slice(),end:e[r].end.slice(),slope:e[r].slope,auto:e[r].auto};t.push(n)}return t}),u.findSeg=((e,t)=>n.searchHigh(e,e=>e.end[0]<t?-1:e.sta[0]>t?1:0)),u.segSlope=(e=>(e.end[1]-e.sta[1])/(e.end[0]-e.sta[0])),u.segValue=((e,t)=>e.sta[1]+e.slope*(t-e.sta[0])),u.rdf=((e,t)=>u.segValue(e[u.findSeg(e,t)],t)),u.fixRoadArray=((e,t=u.RP.VALUE,r=!1,l=u.RP.VALUE)=>{const i=e.length;e[0].sta[0]=e[0].end[0]-315576e4,e[0].sta[1]=e[0].end[1];for(let o=1;o<i-1;o++){r&&(t=e[o].auto);var s=e[o].end[1]-e[o].sta[1];e[o].sta[0]=e[o-1].end[0],e[o].sta[1]=e[o-1].end[1],t===u.RP.DATE?(isFinite(e[o].slope)&&0!=e[o].slope&&(e[o].end[0]=n.daysnap(e[o].sta[0]+(e[o].end[1]-e[o].sta[1])/e[o].slope)),e[o].end[0]<=e[o].sta[0]&&(e[o].end[0]=n.daysnap(e[o].sta[0]+a)),l===u.RP.SLOPE?e[o].end[1]=e[o].sta[1]+e[o].slope*(e[o].end[0]-e[o].sta[0]):e[o].slope=u.segSlope(e[o])):t===u.RP.VALUE?isFinite(e[o].slope)?e[o].end[1]=e[o].sta[1]+e[o].slope*(e[o].end[0]-e[o].sta[0]):e[o].end[1]=e[o].sta[1]+s:t===u.RP.SLOPE&&(e[o].slope=u.segSlope(e[o]))}i>1&&(e[i-1].sta[0]=e[i-2].end[0],e[i-1].sta[1]=e[i-2].end[1],e[i-1].end[0]=e[i-1].sta[0]+315576e4,e[i-1].end[1]=e[i-1].sta[1])}),u.gdelt=((e,t,r,l)=>n.chop(t.yaw*(l-u.rdf(e,r)))),u.aok=((e,t,n,r)=>t.yaw*(r-u.rdf(e,n))>=-1e-15*i(r)),u.pprtype=1,u.dailymin=0,u.ppr=((e,t,n,i=null,s=!1)=>{if(!s&&n<=t.asof&&(!t.ppr||t.tdat===t.asof))return 0;if(t.yaw*t.dir>=0)return 0;const o=null!==i?e[i].slope*a:u.rtf(e,n)*a,d=t.yaw;let f=-d*u.dailymin;switch(u.pprtype){case 0:return 0===o?2*-d:d*o>0?0:2*o;case 1:return 0===o&&0===f&&(f=2*-d),d*l(d*f,2*d*o);case 2:return d<0?r(0,f+o):l(0,f+o)}}),u.dtd=((e,t,n,l)=>{if(u.redyest(e,t,n))return 0;let i=0,s=l+u.ppr(e,t,n+i*a);for(;u.aok(e,t,n+i*a,s)&&n+i*a<=r(t.tfin,n);)i+=1,s+=u.ppr(e,t,n+i*a);return i}),u.dtdarray=((e,t)=>{let n,r,l,i,s=e.length,o=e[s-1].sta[0],d=e[s-1].sta[1],f=u.ppr(e,t,0,s-1),h=[];h=[[[o,d,0,d-f,1]]];for(let g=s-2;g>=0;g--){o=e[g].sta[0],d=e[g].sta[1],n=e[g].end[0],r=e[g].end[1],f=u.ppr(e,t,0,g,!0),l=(n-o)/a,i=isFinite(f)?[[o,d,0,r-f*l,l]]:(t.dir,[[o,d,0,r,l]]);for(var p=h[h.length-1],c=0;c<p.length;c++)isFinite(f)?i.push([o,p[c][1]-f*l,p[c][2]+l,p[c][3]-f*l,p[c][4]+l]):t.dir*(d-r)>0?i.push([o,p[c][1],p[c][2],p[c][3],p[c][4]]):i.push([o,p[c][1],p[c][2]+(n-o),p[c][3],p[c][4]+(n-o)]);h.push(i)}return h}),u.isoline_generate=((e,t,n,r)=>{var l,i,s,o,a,u,d,f,h=t[0],p=0;function c(e,t){var n=e[e.length-1];n[0]==t[0]&&n[1]==t[1]||e.push(t)}for(i=[[h[0][0]+864e3,h[0][1]+r*(h[0][3]-h[0][1])],[h[0][0],h[0][1]+r*(h[0][3]-h[0][1])]],o=1;o<t.length;o++){for(s=(l=t[o]).length-1,a=0;a<l.length;a++)if(r<=l[a][4]){s=a;break}for(a=p;a>=s;a--)u=[h[a][0],h[a][1],h[a][2]],(d=[l[a][0],l[a][3],l[a][4]])[2]-u[2]==0?c(i,[u[0],u[1]]):(f=(r-u[2])/(d[2]-u[2]),c(i,[u[0]+f*(d[0]-u[0]),u[1]+f*(d[1]-u[1])]));u=[l[s][0],l[s][1],l[s][2]],(d=[l[s][0],l[s][3],l[s][4]])[2]-u[2]==0?c(i,[u[0],u[1]]):(f=(r-u[2])/(d[2]-u[2]),c(i,[u[0]+f*(d[0]-u[0]),u[1]+f*(d[1]-u[1])])),p=s,h=l}return i.reverse()}),u.isoline_dolessclip=((e,t,r,l,i)=>{if(0==i)return e;const s=(e,n)=>{let r=t[n],i=u.ppr(t,l,r.sta[0],n,!0);return[[e[0],e[1]],[r.end[0],e[1]+i*(r.end[0]-e[0])/a]]};let o,d,f,h,p=[],c=!1,g=!1;const m=function(e,t){e.push([t[0],t[1]])};for(f=0;f<e.length-1;)if(g||m(p,e[f]),e[f+1][0]==e[f][0]&&(e[f+1][1]-e[f][1])*l.dir>0){for(h=e[f+1][0]+i*a,d=u.findSeg(t,e[f][0]),o=s(e[f],d);f<e.length-1&&e[f+1][0]==e[f][0];)f++;(e[f][1]-o[0][1])*l.dir>0&&(c=!0,g=!0)}else if(c){if(e[f][0]>=h||o[0][0]>=h){m(p,[h,u.isoval(e,h)]),c=!1,g=!1,e[f][0]==h&&f++;continue}if(g){let r=n.lineintersect(e[f],e[f+1],o[0],o[1]);if(null!=r)m(p,r),g=!1,f++;else if(o[1][0]<=e[f+1][0]){for(m(p,o[1]),d++;!isFinite(t[d].slope);)d++;o=s(o[1],d)}else f++}else{let r=n.lineintersect(e[f],e[f+1],o[0],o[1]);if(null!=r&&r[0]!=e[f][0]&&r[0]!=e[f+1][0]&&console.log("Found intersection while on the isoline!!!"),e[f][0]>=o[1][0]){for(d++;!isFinite(t[d].slope);)d++;o=s(o[1],d)}else f++}}else f++;return p}),u.isoline_monotonicity=((e,t,n,r,l)=>{if(r.yaw*r.dir<0)return u.isoline_dolessclip(e,t,n,r,l);let i,s,o,d,f=[],h=!1,p=!1;const c=function(e,t){e.push([t[0],t[1]])};for(d=-1,o=0;o<e.length-1;o++)if((e[o+1][1]-e[o][1])*r.dir>0&&(h=!1),c(f,e[o]),0!=l&&(e[o+1][1]-e[o][1])*r.dir<0&&!h)for(h=!0,d=o+1,p=!1;!p;)e[d][0]>=e[o][0]+l*a?(p=!0,c(f,[s=e[o][0]+l*a,e[o][1]])):(e[d+1][1]-e[d][1])*r.dir>=0&&(e[d+1][0]!=e[d][0]?0!=(i=(e[d+1][1]-e[d][1])/(e[d+1][0]-e[d][0]))&&(s=e[d][0]+(e[o][1]-e[d][1])/i)<=e[o][0]+l*a&&s<=e[d+1][0]&&(p=!0):(e[o][1]-e[d][1])*(e[o][1]-e[d+1][1])<0&&(s=e[d][0]+1,p=!0),p&&c(f,[s,e[o][1]])),d++;return f}),u.isoline_nobackward=((e,t,n,r,l)=>{var i,s,o,a=[e[0].slice()];for(o=1;o<e.length;o++)i=a[a.length-1],e[o][0]<i[0]||(e[o-1][0]<i[0]&&e[o][0]>i[0]&&e[o][0]-e[o-1][0]!=0&&(s=(e[o][1]-e[o-1][1])/(e[o][0]-e[o-1][0]),a.push([i[0],e[o-1][1]+s*(i[0]-e[o-1][0])])),a.push([e[o][0],e[o][1]]));return a}),u.isoline_clip=((e,t,i,s,o)=>{var a=[];function d(e,t,n,i=-1){for(var s=n.slice(),o=u.findSeg(e,n[0]),a=u.segValue(e[o],n[0]);--o>=0&&e[o].sta[0]==n[0];)a=-i*t.yaw>0?l(a,e[o].sta[1]):r(a,e[o].sta[1]);return(s[1]-a)*t.yaw<0&&(s[1]=a),s}var f,h=0,p=0;for(f=e[1][0]!=e[0][0]?1:-1,a.push(d(t,s,e[0],f));!(h>t.length-1||p>e.length-2);){var c=a.length-1,g=n.lineintersect(t[h].sta,t[h].end,e[p],e[p+1]);null==g||g[0]==a[c][0]&&g[1]==a[c][1]||a.push(g),t[h].end[0]<e[p+1][0]?((n.lineval(e[p],e[p+1],t[h].end[0])-t[h].end[1])*s.yaw<0&&a.push([t[h].end[0],t[h].end[1]]),h++):(f=++p<e.length-1&&e[p][0]!=e[p+1][0]?1:-1,a.push(d(t,s,e[p],f)))}return a}),u.isoline=((e,t,n,r,l=!1)=>{let i=u.isoline_generate(e,t,n,r),s=u.isoline_monotonicity(i,e,t,n,r),o=u.isoline_nobackward(s,e,t,n,r),a=u.isoline_clip(o,e,t,n,r);return l?[i,s,o,a]:a}),u.isoval=((e,t)=>{if(!e||!e.length)return null;if(t<=e[0][0])return e[0][1];if(t>=e[e.length-1][0])return e[e.length-1][1];const r=n.searchLow(e,e=>e[0]<=t?-1:1);return n.rescale(t,e[r][0],e[r+1][0],e[r][1],e[r+1][1])}),u.isoside=((e,t,n,r)=>{const l=u.isoval(t,n);return null===l?0:(r-l)*e.yaw>=-1e-15*i(r)?1:-1}),u.dtd_walk=((e,t,n,r)=>{let l=0;for(;u.gdelt(e,t,n+l*a,r)>=0&&n+l*a<=t.tfin;)l+=1;return l}),u.bufcap=((e,t,n=7)=>{const r=t.tcur,l=u.rdf(e,r),s=i(u.rtf(e,r));let o=0,d=0;for(;u.dtd_walk(e,t,r,l+o)<n&&d<=70;)o+=t.yaw*s*a,d+=1;return[o,d]}),u.tvr=((e,t,r,i,s)=>null===r?0===s?n.BDUSK:n.daysnap(l(n.BDUSK,e+(i-t)/s)):null===i?t+s*(r-e):null===s?r===e?0:(i-t)/(r-e):0);const d=(e,t)=>{const n=e[0],r=e[1],l=(e[2],e[3],t[0]),i=t[1],s=t[2],o=u.tvr(n,r,l,i,s);return null===l?[o,i,s,0]:null===i?[l,o,s,1]:null===s?[l,i,o,2]:[l,i,o,0]};return u.fillroad=((e,t)=>{e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]/t.siru),e[0]=d([t.tini,t.vini,0,0],e[0]);for(let t=1;t<e.length;t++)e[t]=d(e[t-1],e[t]);for(e.forEach(e=>e[2]=null==e[2]?e[2]:e[2]*t.siru);void 0!==e&&void 0!==e[0]&&e[0][0]<t.tini;)e.shift();return e}),u.fillroadall=((e,t)=>{const n=e[0][0],r=e[0][1];e.splice(0,1),e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]/t.siru),e[0]=d([n,r,0,0],e[0]);for(let t=1;t<e.length;t++)e[t]=d(e[t-1],e[t]);return e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]*t.siru),e.unshift([n,r,0,2]),e}),u.rtf=((e,t)=>e[u.findSeg(e,t)].slope),u.odomify=(e=>{if(!e||!e.length||0===e.length)return;let t=0,n=e[0][1];for(let r=1;r<e.length;r++)0===e[r][1]&&(t+=n),n=e[r][1],e[r][1]+=t}),u.stepFunc=((e,t)=>{return e[r(0,n.searchLow(e,e=>e[0]-t))][1]}),u.stepify=(e=>e&&e.length?t=>u.stepFunc(e,t):e=>0),u.dotcolor=((e,t,r,l,i=null)=>r<t.tini?n.BHUE.BLCK:null===i?u.aok(e,t,r,l)?n.BHUE.BLCK:n.BHUE.REDDOT:!i||!i.length||i.length<1?n.BHUE.ERRDOT:u.isoside(t,i[0],r,l)<0?n.BHUE.REDDOT:u.isoside(t,i[1],r,l)<0?n.BHUE.ORNDOT:u.isoside(t,i[2],r,l)<0?n.BHUE.BLUDOT:u.isoside(t,i[6],r,l)<0?n.BHUE.GRNDOT:n.BHUE.GRADOT),u.redyest=((e,t,r,l=null)=>u.dotcolor(e,t,r-a,t.dtf(r-a),l)===n.BHUE.REDDOT),u.stdflux=((e,t)=>{if(!t||!t.length||t.length<=1)return 0;const r=n.partition(t,2,1);let l,s,o,d,f=[];for(let t=0;t<r.length;t++)l=r[t][0][0],s=r[t][0][1],o=r[t][1][0],d=r[t][1][1],f.push(i(d-s-u.rdf(e,o)+u.rdf(e,l))/(o-l)*a);return n.chop(1===f.length?f[0]:n.quantile(f,.9))}),u.autowiden=((e,t,l,s)=>{let o=l;if(o<=1)return 0;let d=-1;if(u.gdelt(e,t,l[l.length-1][0],l[l.length-1][1])<0){for(;d>=-o&&u.gdelt(e,t,l[d][0],l[d][1])<0;)d-=1;(d+=1)>-o&&l[d][0]-l[d-1][0]<=a&&(s=r(s,i(l[d][1]-u.rdf(e,l[d][0]))))}return n.chop(s)}),u.vertseg=((e,t)=>e.filter(e=>e.sta[0]===t).length>1),u.gapFill=(e=>{if(!e||!e.length)return[];const t=(e,t,n)=>e+(t-e)*n;var n,r=e[0][0],l=e[e.length-1][0],i=o((l-r)/a),s=Array(i),u=0,d=r;for(n=0;n<e.length-1;n++)for(var f=e[n+1][0]-e[n][0];d<=e[n+1][0];)s[u]=[d,t(e[n][1],e[n+1][1],(d-e[n][0])/f)],u++,d+=a;return 0===s.length&&s.push(e[0]),s}),u.smooth=(e=>{if(!e||!e.length)return e=>e;const s=(e[0][0]+e[e.length-1][0])/2,o=n.zip(e),u=o[0].map(e=>(e-s)/a),d=new t(u,o[1]);let f=d.getPolynomial(3);const h=i(r(...o[1])-l(...o[1]));return d.standardError(d.computeCoefficients(3))>1e4*h&&(console.log("butil.smooth: Possible ill-conditioned polyfit. Reducing dimension."),f=d.getPolynomial(2)),e=>f((e-s)/a)}),u.smooth2=(e=>{if(!e||!e.length)return e=>e;const t=n.zip(e);n.splinefit(t[0],t[1]);return e=>e}),u.interpData=((e,t)=>{var n=(e,t,n)=>e+(t-e)*n,r=0,l=e.length,i=[];if(0===l)return null;if(1===l)return t.map(e=>[e,e[0][1]]);for(let o=0;o<t.length;o++){var s=t[o];if(s<=e[0][0])i.push([s,e[0][1]]);else if(s>=e[l-1][0])i.push([s,e[l-1][1]]);else if(s<e[r+1][0])i.push([s,n(e[r][1],e[r+1][1],(s-e[r][0])/(e[r+1][0]-e[r][0]))]);else{for(;s>e[r+1][0];)r++;i.push([s,n(e[r][1],e[r+1][1],(s-e[r][0])/(e[r+1][0]-e[r][0]))])}}return i}),u.lim=((e,t,n)=>u.rdf(e,t.tcur+n*a)),u.limd=((e,t,n)=>u.lim(e,t,n)-t.vcur),u.dueby=((e,t,r)=>{let l=[...Array(r).keys()].map(r=>[n.dayify(t.tcur+r*a),u.limd(e,t,r),u.lim(e,t,r)]);const i=n.zip(l);return n.zip([i[0],n.monotonize(i[1],t.dir),n.monotonize(i[2],t.dir)])}),u});
((n,t)=>{"use strict";"function"==typeof define&&define.amd?define(["fili","moment","butil","broad"],t):"object"==typeof module&&module.exports?module.exports=t(require("./fili"),require("./moment"),require("./butil"),require("./broad")):n.beebrain=t(n.Fili,n.moment,n.butil,n.broad)})(this,(n,t,i,a)=>{"use strict";const r=Math.max,e=Math.min,l=Math.abs,o=Math.exp,s=Math.floor,u=Math.ceil,f=Math.sign,m=365.25,d=86400;let c=1;const p={quantum:1e-5,timey:!1,ppr:!0,deadline:0,asof:null,tini:null,vini:null,road:[],tfin:null,vfin:null,rfin:null,runits:"w",gunits:"units",yaw:0,dir:0,pinkzone:[],tmin:null,tmax:null,vmin:null,vmax:null,kyoom:!1,odom:!1,maxflux:0,monotone:!1,aggday:null,plotall:!0,steppy:!1,rosy:!1,movingav:!1,aura:!1,hashtags:!0,yaxis:"",waterbuf:null,waterbux:"",hidey:!1,stathead:!0,yoog:"U/G",goal:null,rate:null},h={sadbrink:!1,safebump:null,dueby:[],fullroad:[],pinkzone:[],tluz:null,tcur:null,vcur:null,vprev:null,rcur:null,ravg:null,tdat:null,stdflux:0,delta:0,lane:666,cntdn:0,numpts:0,mean:0,meandelt:0,proctm:0,statsum:"",ratesum:"",deltasum:"",graphsum:"",progsum:"",safesum:"",rah:0,safebuf:null,error:"",limsum:"",headsum:"",titlesum:"",lnw:0,color:"black",loser:!1,gldt:null,goal:null,rate:null,road:[],tini:null,vini:null,tfin:null,vfin:null,rfin:null},g=["timezone","usr","graph","ybhp","integery","noisy","abslnw","tagtime","backroad","edgy","offred","sadlhole","imgsz"],y={AGGPAST:0,AGGFUTURE:1,RAWPAST:2,RAWFUTURE:3,FLATLINE:4,HOLLOW:5};return function(v){let b=this,x=c;c++,v=i.deepcopy(v);let w=[],A={},z=[],k=[],R=[],M=[],E=[],G=[],S=[],U={},T={},F={},P={},L=[];A.yaw=1,A.dir=1,A.tcur=0,A.vcur=0,A.vprev=0;const O=t.utc();function N(n){if(n.fullroad=n.fullroad.map(n=>(function(n){return Array.isArray(n)?n.length<=3?n:n.slice(0,3):n})(n)),n.road=n.fullroad,n.error)n.gldt=i.dayify(A.tfin),n.goal=A.vfin,n.rate=A.rfin*A.siru;else{const t=n.fullroad.length;t>0&&(n.gldt=n.fullroad[t-1][0],n.goal=n.fullroad[t-1][1],n.rate=n.fullroad[t-1][2])}n.tini=i.dayify(A.tini),n.vini=A.vini,n.tfin=i.dayify(A.tfin),n.vfin=A.vfin,n.rfin=A.rfin}function D(n){return Array.isArray(n)&&3===n.length?[i.dayparse(n[0]),n[1],n[2]]:n}function I(n){if(n.length<1)return n;let t=n.slice();return t[0]=i.dayify(n[0]),t}function K(n,t){let i=.25/d;"meta/derev"===A.yoog&&(i=.03/d),"meta/dpledge"===A.yoog&&(i=.03/d);let a,r,e,l,s,u=n[0][0],f=n[0][1],m=f;if(t<u)return m;for(e=1;e<n.length;e++){if(a=(r=n[e])[0]-u,l=(r[1]-f)/a,s=f,t<r[0])return s+l*(a=t-u)-l/i+(m-s+l/i)*o(-i*a);m=s+l*a-l/i+(m-s+l/i)*o(-i*a),u=r[0],f=r[1]}return s+l*(a=t-u)-l/i+(m-s+l/i)*o(-i*a)}function q(n,t,a){let r=i.zip(n);return r[1]=function(n,t,a){return function(n,t,i){let a=[t];for(let t=0;t<i.length;t++)a.push(n(a[t],i[t]));return a}((n,a)=>i.clip(n,a-t,a+t),n[0]+a*t,n.slice(1,n.length))}(r[1],t,a),i.zip(r)}function $(n,t,i){return q(n.slice().reverse(),t,i).reverse()}let B;O.hour(0),O.minute(0),O.second(0),O.millisecond(0),A.asof=O.unix(),A.horizon=A.asof+i.AKH,A.xMin=A.asof,A.xMax=A.horizon,A.yMin=-1,A.yMax=1;try{B=new RegExp("(?:^|\\s)(#\\p{L}[\\p{L}0-9_]*)(?=$|[\\s])","gu")}catch{B=/(?:^|\s)(#[a-zA-Z]\w*)(?=$|\s)/g}function H(n){let t,i=new Set;for(B.lastIndex=0;null!=(t=B.exec(n));)""!=t[1]&&i.add(t[1]);return i}function j(n){return n[1]}function C(n,t){const a=A.kyoom&&"sum"===A.aggday;if(1===n.length)return[n[0][2],n[0][3],n[0][4]];{let r;return(r=a?i.accumulate(n.map(j)).indexOf(t):n.map(j).indexOf(t))<0?[A.aggday,null,null]:[n[r][1]+" ("+A.aggday+")",n[r][3],n[r][4]]}}let W=null;function Y(n){return JSON.stringify(null===n[0]?n:[i.formatDate(n[0]),n[1],n[2]])}function J(n){return!(!i.listy(n)||3!=n.length)&&(null==n[0]&&i.nummy(n[1])&&i.nummy(n[2])||i.nummy(n[0])&&null==n[1]&&i.nummy(n[2])||i.nummy(n[0])&&i.nummy(n[1])&&null==n[2])}const V=n=>i.nummy(n)&&0<n&&n<i.BDUSK,Z=n=>"boolean"==typeof n,_=n=>i.nummy(n)||null===n,Q=n=>V(n)||null===n,X={quantum:[i.nummy,"isn't numeric"],timey:[Z,"isn't boolean"],ppr:[Z,"isn't boolean"],deadline:[n=>i.nummy(n)&&-64800<=n&&n<=21600,"outside 6am earlybird and 6am nightowl"],asof:[V,"isn't a valid timestamp"],tini:[V,"isn't a valid timestamp"],vini:[i.nummy,"isn't numeric"],road:[i.listy,"(graph matrix) isn't a list"],tfin:[Q,"isn't a valid timestamp or null"],vfin:[_,"isn't numeric or null"],rfin:[_,"isn't numeric or null"],runits:[n=>n in i.SECS,"isn't a valid rate unit"],gunits:[i.stringy,"isn't a string"],yaw:[n=>-1===n||0===n||1===n,"isn't -1 or 1 or 0"],dir:[n=>1==n||-1==n,"isn't -1 or 1"],pinkzone:[i.listy,"isn't a a list"],tmin:[Q,"isn't a valid timestamp or null"],tmax:[Q,"isn't a valid timestamp or null"],vmin:[_,"isn't numeric or null"],vmax:[_,"isn't numeric or null"],kyoom:[Z,"isn't boolean"],odom:[Z,"isn't boolean"],monotone:[Z,"isn't boolean"],aggday:[n=>n in a.AGGR,"isn't one of max, sum, last, mean, etc"],plotall:[Z,"isn't boolean"],steppy:[Z,"isn't boolean"],rosy:[Z,"isn't boolean"],movingav:[Z,"isn't boolean"],aura:[Z,"isn't boolean"],hashtags:[Z,"isn't boolean"],yaxis:[n=>i.stringy(n)&&n.length<80,"isn't a string of at most 79 chars"],waterbuf:[n=>i.stringy(n)||null===n,"isn't a string or null"],waterbux:[i.stringy,"isn't a string"],hidey:[Z,"isn't boolean"],stathead:[Z,"isn't boolean"],yoog:[i.stringy,"isn't a string"],goal:[_,"isn't numeric or null"],rate:[_,"isn't numeric or null"]};function nn(){A.dtf=a.stepify(k),A.road=a.fillroad(A.road,A);const t=A.road.length;A.tfin=A.road[t-1][0],A.vfin=A.road[t-1][1],A.rfin=A.road[t-1][2];const l=A.road.map(n=>n[0]);if(A.tini>l[0])return"Graph matrix error\\n(There are segments of your bright red line\\nthat are somehow dated before your goal's start date!)";if(!i.orderedq(l))return"Dial error\\n(Your goal date, goal "+(A.kyoom?"total":"value")+", and rate are inconsistent!\\nIs your rate positive when you meant negative?\\nOr is your goal "+(A.kyoom?"total":"value")+" such that the implied goal date is in the past?)";A.stdflux=a.stdflux(w,k.filter(n=>n[0]>=A.tini)),function(){const n=0===k.length?[A.tini,A.vini]:k[k.length-1],t=n[0],i=n[1];if(t>A.tfin)return;const r=n=>!a.aok(w,A,n,i);let l=e(A.asof,A.tfin);if(A.yaw*A.dir>0)for(;r(l-d)&&l-d>t&&r(l-2*d)&&l-d>A.tini;)l-=d;l in T||(W=[l,i,"PPR",y.FLATLINE,t,i,null],t==l&&"PPR"==n[2]?k[k.length-1]=W:k.push(W))}();const o=k.length;if(A.movingav||A.aura)if(o<=1||k[o-1][0]-k[0][0]<=0)A.filtpts=[];else if(void 0!==n){let n=new Fili.CalcCascades,t=n.lowpass({order:1,characteristic:"bessel",Fs:1e3,Fc:50,gain:0,preGain:!1}),a=new Fili.IirFilter(t),r=k[0][0],l=k[o-1][0],s=i.linspace(r,l,1+u((l-r)/d)),f=k[0][1],m=k[o-1][1],c=k[0][0],p=(m-f)/(k[o-1][0]-c),h=[0],g=0,y=(k[g+1][1]-k[g][1])/(k[g+1][0]-k[g][0]);for(let n=1;n<s.length;n++)if(s[n]==k[g+1][0]){if(h.push(k[g+1][1]-f-p*(s[n]-c)),++g==k.length-1)break;y=(k[g+1][1]-k[g][1])/(k[g+1][0]-k[g][0])}else{if(s[n]>k[g+1][0]){if(++g==k.length)break;y=(k[g+1][1]-k[g][1])/(k[g+1][0]-k[g][0])}h.push(k[g][1]+(s[n]-k[g][0])*y-f-p*(s[n]-c))}const v=50;for(let n=0;n<v;n++)h.push(0);let b=a.filtfilt(h);b.splice(-v,v),A.filtpts=i.zip([s,b.map(n=>n+f)]).map(n=>[n[0],n[1]+p*(n[0]-c)]);{let t=k.filter(n=>n[0]>=A.tmin),a=50-e(45,t.length/30*10),r=n.lowpass({order:1,characteristic:"bessel",Fs:1e3,Fc:a,gain:0,preGain:!1}),l=new Fili.IirFilter(r).filtfilt(h);l.splice(7-v,v-7);let o=s[s.length-1];for(let n=1;n<8;n++)s.push(o+d*n);A.aurapts=i.zip([s,l.map(n=>n+f)]).map(n=>[n[0],n[1]+p*(n[0]-c)])}}else{const n=function(n,t,a=6e3){return i.linspace(n,t,s(i.clip((t-n)/(d+1),e(600,640),a)))}(k[0][0],k[o-1][0],4*(k[o-1][0]-k[0][0])/d);A.filtpts=n.map(n=>[n,K(k,n)])}else A.filtpts=[];return A.tcur=0===o?A.tini:k[o-1][0],A.vcur=0===o?A.vini:k[o-1][1],A.vprev=k[r(o-2,0)][1],A.safebuf=a.dtd(w,A,A.tcur,A.vcur),A.tluz=e(A.tcur+A.safebuf*d,A.tfin+d,i.BDUSK),A.tluz>A.tfin&&(A.tluz=i.BDUSK),A.delta=i.chop(A.vcur-a.rdf(w,A.tcur)),A.rah=a.rdf(w,A.tcur+i.AKH),A.dueby=a.dueby(w,A,7),A.safebump=a.lim(w,A,A.safebuf),A.rcur=a.rtf(w,A.tcur)*A.siru,A.ravg=a.tvr(A.tini,A.vini,A.tfin,A.vfin,null)*A.siru,A.cntdn=u((A.tfin-A.tcur)/d),A.lane=A.yaw*(A.safebuf-(A.safebuf<=1?2:1)),A.color=A.safebuf<1?"red":A.safebuf<2?"orange":A.safebuf<3?"blue":"green",A.loser=a.redyest(w,A,A.tcur),A.sadbrink=A.tcur-d>A.tini&&a.dotcolor(w,A,A.tcur-d,A.dtf(A.tcur-d,A.isolines))==i.BHUE.REDDOT,function(){if(null==A.tmin&&(A.tmin=e(A.tini,A.asof)),null==A.tmax){const n=s((A.tcur-A.tmin)/(m*d));A.tmax=i.daysnap(2*(1+n/2)*i.AKH+A.tcur)}if(null!=A.vmin&&null!=A.vmax)return void(A.vmin==A.vmax?(A.vmin-=1,A.vmax+=1):A.vmin>A.vmax&&([A.vmin,A.vmax]=[A.vmax,A.vmin]));const n=a.rdf(w,A.tmin),t=a.rdf(w,A.tmax),l=k.filter(n=>n[0]<=A.tmax&&n[0]>=A.tmin).map(n=>n[1]);let o=i.arrMin(l),u=i.arrMax(l);if(null!=W&&W[0]<=A.tmax&&W[0]>=A.tmin){const n=W[1]+a.ppr(w,A,A.asof);o=e(o,n),u=r(u,n)}const f=r(0,.015*(u-o)*2);let c=o-f,p=u+f;A.monotone&&A.dir>0?(c=i.arrMin([c,n,t]),p=i.arrMax([p,n,t])):(A.monotone&&A.dir,c=i.arrMin([c,n,t]),p=i.arrMax([p,n,t])),A.plotall&&A.tmin<=A.tini&&A.tini<=A.tmax&&A.tini in U&&(c=e(c,i.arrMin(U[A.tini].map(n=>n[1]))),p=r(p,i.arrMax(U[A.tini].map(n=>n[1])))),null==A.vmin&&null==A.vmax?(A.vmin=c,A.vmax=p,A.vmin==A.vmax?(A.vmin-=1,A.vmax+=1):A.vmin>A.vmax&&([A.vmin,A.vmax]=[A.vmax,A.vmin])):null==A.vmin?A.vmin=c<A.vmax?c:A.vmax-1:null==A.vmax&&(A.vmax=p>A.vmin?p:A.vmin+1)}(),""}function tn(n,t){const r=t.yaw,e=t.dir,o=t.lane,u=t.delta,m=t.quantum,c=r>0&&e>0,p=r<0&&e<0,h=r<0&&e>0,g=r>0&&e<0,y=(n,t=r,a=4,e=2)=>null===m?i.shn(n,a,e,t):i.conservaround(n,m,t),v=(n,t=r,i=4,a=2)=>(n>=0?"+":"")+y(n,t,i,a);if(""!=t.error)return void(t.statsum=" error:    "+t.error+"\\n");const b=i.zip(t.road)[2];let x=i.arrMin(b),A=i.arrMax(b);if(l(x)>l(A)){const n=x;x=A,A=n}const z=i.shn(x,4,2),R=i.shn(A,4,2),M=i.shn(t.ravg,4,2),E=i.shn(t.rcur,4,2);t.ratesum=(x===A?z:"between "+z+" and "+R)+" per "+i.UNAM[t.runits]+(x!==A?" (current: "+E+", average: "+M+")":"");const G=i.daysnap(t.tini),S=i.daysnap(t.tcur),U=i.daysnap(t.tfin),T=t.vini,F=t.vcur,P=t.vfin;let L,O,N,D;L=G===U?"??":i.shn(i.rescale(S,G,U,0,100),1,1),O=T===P?F<T&&t.yaw>0||F>T&&t.yaw<0?"00":"100":l(T-P)<1e-7?F<(T+P)/2&&t.yaw>0||F>(T+P)/2&&t.yaw<0?"~0":"~100":i.shn(i.rescale(t.vcur,t.vini,t.vfin,0,100),1,1),t.progsum=L==O?L+"% done":L+"% done by time -- "+O+"% by value",t.cntdn<7?(N=f(t.rfin)*(t.vfin-t.vcur),D="w/ "+y(N,0,2,1)+" to go to goal"):D="@ "+((N=a.rdf(w,t.tcur+t.siru)-a.rdf(w,t.tcur))>=0?"+":"")+i.shn(N,2,1,0)+" / "+i.UNAM[t.runits],t.graphsum=(t.asof!==t.tcur?"["+i.shd(t.asof)+"] ":"")+y(t.vcur,0,3,1)+" on "+i.shd(t.tcur)+" ("+i.splur(t.numpts,"datapoint")+" in "+i.splur(1+s((t.tcur-t.tini)/d),"day")+") targeting "+y(t.vfin,0,3,1)+" on "+i.shd(t.tfin)+" ("+i.splur(t.cntdn,"more day")+") "+D,t.deltasum=y(l(u),0)+" "+t.gunits+(u<0?" below":" above")+" the bright line";const I=t.safebuf,K=i.splur(I,"day"),q=a.lim(w,t,c||p?I:0),$=a.limd(w,t,c||p?I:0);t.kyoom?(c&&(t.limsum=v($)+" in "+K),p&&(t.limsum=v($)+" in "+K),h&&(t.limsum=v($)+" today"),g&&(t.limsum=v($)+" today")):(c&&(t.limsum=v($)+" in "+K+" ("+y(q)+")"),p&&(t.limsum=v($)+" in "+K+" ("+y(q)+")"),h&&(t.limsum=v($)+" today ("+y(q)+")"),g&&(t.limsum=v($)+" today ("+y(q)+")")),t.titlesum=i.toTitleCase(t.color)+": bmndr.com/"+t.yoog+" is safe for ~"+K+(0===I?" (beemergency!)":""),t.headsum=t.titlesum,t.statsum=" progress: "+i.shd(t.tini)+"  "+(null==k?"?":i.shn(t.vini,4,2,0))+"\\n           "+i.shd(t.tcur)+"  "+i.shn(t.vcur,4,2,0)+"   ["+t.progsum+"]\\n           "+i.shd(t.tfin)+"  "+i.shn(t.vfin,4,2,0)+"\\n rate:     "+t.ratesum+"\\n lane:     "+(666==l(o)?"n/a":o)+"\\n safebuf:  "+t.safebuf+"\\n delta:    "+t.deltasum+"\\n ",t.statsum+=0==r?"limit:    ":r<0?"hard cap: ":"bare min: ",t.statsum+=t.limsum+"\\n",function(n,t){const a=t.yaw,r=t.dir,e=(t.delta,t.quantum,t.safebuf),l=i.splur(e,"day");t.safesum=a*r<0?"unknown days of safety buffer":e>999?"more than 999 days of safety buffer":"~"+l+" of safety buffer"}(0,t)}this.reloadRoad=function(){const n=nn();if(""!=n)return n;if(tn(0,A),A.fullroad=A.road.slice(),A.fullroad.unshift([A.tini,A.vini,0,0]),""==A.error&&(A.pinkzone=[[A.asof,a.rdf(w,A.asof),0]],A.road.forEach(function(n){n[0]>A.asof&&n[0]<A.asof+i.AKH&&A.pinkzone.push([n[0],n[1],null])}),A.pinkzone.push([A.asof+i.AKH,a.rdf(w,A.asof+i.AKH),null]),A.pinkzone=a.fillroadall(A.pinkzone,A)),A.aura)if(void 0===A.aurapts){const n=k.filter(n=>n[0]>=A.tmin),t=a.gapFill(n);A.auraf=a.smooth(t)}else A.auraf=function(n){let t=i.searchLow(A.aurapts,t=>t[0]-n);if(-1==t)return A.aurapts[0][1];if(t==A.aurapts.length-1)return A.aurapts[A.aurapts.length-1][1];{let i=A.aurapts[t],a=A.aurapts[t+1];return i[1]+(n-i[0])*(a[1]-i[1])/(a[0]-i[0])}};else A.auraf=(n=>0);A.dtdarray=a.dtdarray(w,A),A.isolines=[];for(let n=0;n<4;n++)A.isolines[n]=a.isoline(w,A.dtdarray,A,n);return""};let an={};this.getStats=function(){return i.deepcopy(an)},this.setRoadObj=function(n){if(0!=n.length){w=n,b.roads=w,A.road=[];for(let n=1;n<w.length;n++)A.road.push([w[n].sta[0],w[n].sta[1],w[n].slope]);b.gol=A,b.reloadRoad()}else console.log("id="+x+", setRoadObj(), null redline!")},function(n,l,o=null){try{null==o&&(o=t.utc().unix()),function(n){"goal"in n&&!("vfin"in n)&&(n.vfin=n.goal),"rate"in n&&!("rfin"in n)&&(n.rfin=n.rate)}(n),function(){k=[],W=null,M=[],U={},T={},F={},(A={}).siru=null,E=[],G=[],P={};for(const n in h)A[n]=h[n];for(const n in p)A[n]=p[n]}(),A.proctm=o,k=function(n,t){return["asof","tini","tfin","tmin","tmax"].map(t=>{t in n&&(n[t]=i.dayparse(n[t]))}),"road"in n&&i.listy(n.road)&&(n.road=n.road.map(D)),t.map((n,t)=>[i.dayparse(n[0]),n[1],n[2],t,n[1]]).sort((n,t)=>n[0]!==t[0]?n[0]-t[0]:n[3]-t[3])}(n,l);const s=[];for(const t in n)t in n&&(t in p||g.includes(t)?A[t]=n[t]:s.push(`${t}=${n[t]}`));s.length>0&&(A.error+=`Unknown param${1===s.length?"":"s"}: ${s.join(", ")}`),"aggday"in n||(n.aggday=A.kyoom?"sum":"last"),A.siru=i.SECS[A.runits],A.horizon=A.asof+i.AKH-d,A.waterbuf0=A.waterbuf,i.listy(A.road)&&A.road.push([A.tfin,A.vfin,A.rfin]),""==A.error&&(A.error=function(){for(const n in X){const t=X[n][0],i=X[n][1];if(!t(A[n]))return`${n} = ${JSON.stringify(A[n])}\\nERROR: ${i}`}for(const n of A.road)if(!J(n))return"Invalid graph matrix row: "+Y(n);for(const n of A.pinkzone)if(!J(n))return"Invalid pinkzone row: "+Y(n);const n=A.road.slice(1,A.road.length-1);if(n.length!==i.deldups(n).length){let t=n[0];for(const a of n){if(i.arrayEquals(a,t))return"Graph matrix has duplicate row: "+Y(a);t=a}}return A.kyoom&&A.odom?"The odometer setting doesn't make sense for an auto-summing goal!":A.tmin>A.asof?"You can't set the graph bounds to be solely in the future!":""}()),""==A.error&&(A.error=function(){if(!k||!k.length)return"No datapoints";const n=k.length;let t;for(t=0;t<n;t++){const n=k[t];if(!(i.nummy(n[0])&&n[0]>0&&i.nummy(n[1])&&i.stringy(n[2])))return"Invalid datapoint: "+n[0]+" "+n[1]+' "'+n[3];if(A.hashtags){const t=H(n[2]);if(0==t.size)continue;n[0]in P||(P[n[0]]=new Set);for(const i of t)P[n[0]].add(i)}}if(A.hashtags){L=[];for(const n in P)L.push([n,Array.from(P[n]).join(" ")])}for(G=(G=k.filter(n=>(function(n){return/(?:^|\s)#DERAIL(?=$|\s)/.test(n)||n.startsWith("RECOMMITTED ON")})(n[2]))).map(n=>n.slice()),t=0;t<G.length;t++)G[t][0]<1562299200&&(G[t][0]-=d);A.odom&&(E=k.filter(n=>0==n[1]).map(n=>n[0]),a.odomify(k));const r=k.filter(n=>n[0]<=A.asof);A.plotall&&(A.numpts=r.length),U={},T={};let e,l=[],o=k[0][0],s=[],u=0;for(a.rsk8=A.rfin*d/A.siru,t=0;t<=n;t++)if(t<n&&k[t][0]==o&&s.push(k[t].slice()),t>=k.length||k[t][0]!=o){let n=s.map(j),r=a.AGGR[A.aggday](n);e=l.length>0?l[l.length-1]:[o,r+u];let f=C(s,r);l.push([o,u+r,f[0],o<=A.asof?y.AGGPAST:y.AGGFUTURE,e[0],e[1],f[2],f[1]]),A.kyoom?("sum"===A.aggday?U[o]=i.accumulate(n).map((n,t)=>[o,n+u,s[t][2],s[t][3],s[t][4]]):U[o]=s.map(n=>[o,n[1]+u,n[2],n[3],n[4]]),T[o]=u+r,u+=r):(U[o]=s,T[o]=r);const m=U[o].map(n=>n[1]);F[o]=A.yaw<0?i.arrMax(m):i.arrMin(m),t<k.length&&(o=k[t][0],s=[k[t].slice()])}let f=[];for(let n in U)f=f.concat(U[n].map(t=>[Number(n),t[1],t[2],Number(n)<=A.asof?y.AGGPAST:y.AGGFUTURE,null,null,t[4],t[3]]));if(z=f,M=l.filter(n=>n[0]>A.asof),k=l.filter(n=>n[0]<=A.asof),A.plotall||(A.numpts=k.length),0==k.length)return A.tdat=A.tcur,A.mean=0,S=[],"";const m=a.gapFill(k).map(n=>n[1]);for(k.length>0&&(A.mean=i.mean(m)),k.length>1&&(A.meandelt=i.mean(i.partition(m,2,1).map(n=>n[1]-n[0]))),A.tdat=k[k.length-1][0],t=0;t<G.length;t++){const n=1562299200;(o=G[t][0]<n?G[t][0]+d:G[t][0])in F&&(G[t][1]=T[o])}return S=k.filter(n=>n[0]in U&&n[0]<A.asof&&!U[n[0]].map(n=>n[1]).includes(n[1])),""}()),""==A.error&&(A.error=function(n){const t=i.BDUSK;w=[];const r=n;if(!r)return"Road param missing";const l=r.length;let o,s=A.tini,u=A.vini;null!=r[0][0]&&r[0][0]<s&&(s=r[0][0],null!=r[0][1]&&(u=r[0][1])),(o={sta:[s,Number(u)],slope:0,auto:a.RP.SLOPE}).end=o.sta.slice(),o.sta[0]=i.daysnap(o.sta[0]-100*d*m),w.push(o);for(let n=0;n<l;n++){let i={};i.sta=w[w.length-1].end.slice();let l=null,o=null,s=null;l=r[n][0],o=r[n][1],s=r[n][2],null==l?(i.end=[0,Number(o)],i.slope=Number(s)/A.siru,0!=i.slope?i.end[0]=i.sta[0]+(i.end[1]-i.sta[1])/i.slope:(i.end[0]=t,i.end[1]=i.sta[1]),i.end[0]=e(t,i.end[0]),i.end[1]=i.sta[1]+i.slope*(i.end[0]-i.sta[0]),i.auto=a.RP.DATE):null==o?(i.end=[l,0],i.slope=Number(s)/A.siru,i.end[1]=i.sta[1]+i.slope*(i.end[0]-i.sta[0]),i.auto=a.RP.VALUE):null==s&&(i.end=[l,Number(o)],i.slope=a.segSlope(i),i.auto=a.RP.SLOPE),i.end[0]>=i.sta[0]&&w.push(i)}const f=w[w.length-1],c={sta:f.end.slice(),end:f.end.slice(),slope:0,auto:a.RP.VALUE};return c.end[0]=i.daysnap(c.end[0]+100*d*m),w.push(c),""}(n.road)),""==A.error&&(A.error=b.reloadRoad()),function(){if(!A.rosy||0==k.length)return;const n=r(0,A.stdflux);let t,a;A.dir>0?(t=q(k,n,-1),a=$(k,n,1)):(t=$(k,n,-1),a=q(k,n,1));const e=t.map(n=>n[1]),l=a.map(n=>n[1]),o=i.zip([e,l]).map(n=>(n[0]+n[1])/2),s=k.map(n=>n[0]);R=(R=i.zip([s,o])).map(n=>[n[0],n[1],"rosy data",y.RAWPAST,n[0],n[1],n[1]]);for(let n=1;n<R.length-1;n++)R[n][4]=R[n-1][0],R[n][5]=R[n-1][1]}()}finally{an=Object.assign({},h);for(const n in an)an[n]=A[n];!function(n){n.fullroad=n.fullroad.map(I),"razrmatr"in h&&(n.razrmatr=n.razrmatr.map(I)),n.pinkzone=n.pinkzone.map(I),n.tluz=i.dayify(n.tluz),n.tcur=i.dayify(n.tcur),n.tdat=i.dayify(n.tdat)}(an),N(an)}}(v.params,v.data),A.graphurl=i.BBURL,A.thumburl=i.BBURL,this.id=x,this.DPTYPE=y,this.roads=w,this.gol=A,this.data=k,this.rosydata=R,this.alldata=z,this.allvals=U,this.fuda=M,this.flad=W,this.oresets=E,this.derails=G,this.hollow=S,this.hashtags=L}});