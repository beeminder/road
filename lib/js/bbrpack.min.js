!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["moment"],t):"object"==typeof module&&module.exports?module.exports=t(require("./moment")):e.butil=t(e.moment)}(this,function(e){"use strict";const t=Math.min,r=Math.max,n=Math.abs,l=Math.pow,o=Math.log10,i=Math.floor,u=Math.round,a=86400;var s={MAXTIME:6e4,BBURL:"http://brain.beeminder.com/",Cols:{DYEL:"#ffff44",LYEL:"#ffff88",ROSE:"#ff8080",AKRA:"#4C4Cff",PURP:"#B56bb5",LPURP:"#E5BbE5",BLUE:"#EAEAFF",GRUE:"#b5ffDE",ORNG:"#ff8000",WITE:"#ffffff",BIGG:"#ffe54c",PINK:"#ffe5e5",PNKE:"#ffcccc",GRAY:"#f0f0f0",BLCK:"#000000",REDDOT:"#ff0000",ORNDOT:"#ffa500",BLUDOT:"#3f3fff",GRNDOT:"#00aa00",GRADOT:"#228B22",ERRDOT:"#00FFFF",RAZR0:"#ff0000",RAZR1:"#ffa500",RAZR2:"#3f3fff",RAZR3:"#6BC461"}};s.AKH=7*a,s.BDUSK=2147317201,s.SECS={y:31557600,m:2629800,w:7*a,d:a,h:3600},s.UNAM={y:"year",m:"month",w:"week",d:"day",h:"hour"},s.arrMin=(e=>t.apply(null,e)),s.arrMax=(e=>r.apply(null,e)),s.isArray=Array.isArray,s.extend=((e,t,r)=>{let n,l;for(n in t)(l=void 0!==e[n])&&"object"==typeof t[n]&&null!==t[n]&&void 0===t[n].nodeName?s.isArray(t[n])?r&&(e[n]=t[n].slice(0)):e[n]=s.extend({},t[n],r):!r&&l||(s.isArray(t[n])?e[n]=t[n].slice(0):e[n]=t[n]);return e}),s.deepcopy=(e=>{let t,r,n;if("object"!=typeof e||null===e)return e;for(n in t=Array.isArray(e)?[]:{},e)r=e[n],t[n]=s.deepcopy(r);return t}),s.argmax=((e,t)=>{if(null===t)return null;let r=t.map(e),n=s.arrMax(r);return t[r.findIndex(e=>e===n)]}),s.partition=((e,t,r)=>{let n=e.length,l=[];for(let o=0;o<n;o+=r)o+t<=n&&l.push(e.slice(o,o+t));return l}),s.modf=(e=>{let t=e<0?-e:e,r=i(t);return e<0?[-(t-r),-r]:[t-r,r]}),s.quantile=((e,t,r=1,n=!1)=>{let l;if(l=n?e:e.slice().sort((e,t)=>e-t),r<1||r>9)return null;let o=[[0,0,1,0],[.5,0,1,0],[.5,0,0,0],[0,0,0,1],[.5,0,0,1],[0,1,0,1],[1,-1,0,1],[1/3,1/3,0,1],[3/8,.25,0,1]],u=o[r-1][0],a=o[r-1][1],f=o[r-1][2],c=o[r-1][3],d=e.length,m=s.modf(u+(d+a)*t-1),h=m[0],p=m[1];return p<0?l[0]:p>=d?l[d-1]:(p=i(p),0==h?l[p]:l[p]+(l[p+1]-l[p])*(f+c*h))}),s.sum=(e=>e.reduce((e,t)=>e+t,0)),s.foldlist=((e,t,r)=>{let n=[t];for(let t=0;t<r.length;t++)n.push(e(n[t],r[t]));return n}),s.accumulate=(e=>{let t=e.length;if(0===t)return e;let r=[e[0]];for(let n=1;n<t;n++)r.push(r[r.length-1]+e[n]);return r}),s.monotonize=((e,n=1)=>{let l,o=e.slice();if(1===n)for(l=1;l<o.length;l++)o[l]=r(o[l-1],o[l]);else for(l=1;l<o.length;l++)o[l]=t(o[l-1],o[l]);return o}),s.zip=(e=>e[0].map((t,r)=>e.map(e=>e[r]))),s.chop=((e,t=1e-7)=>n(e)<t?0:e),s.ichop=((e,t=1e-7)=>{let r=e%1,n=e-r;return r<0&&(r+=1,n-=1),r>.5&&(r=1-s.chop(1-r)),i(n)+s.chop(r,t)}),s.clip=((e,t,r)=>(t>r&&([t,r]=[r,t]),e<t?t:e>r?r:e)),s.searchLow=((e,t)=>{if(!e||!e.length)return-1;let r,n=-1,l=e.length;for(;l-n>1;)t(e[r=i((n+l)/2)])<0?n=r:l=r;return l===e.length||0!==t(e[l])?n:l}),s.searchHigh=((e,t)=>{if(!e||!e.length)return 0;let r,n=-1,l=e.length;for(;l-n>1;)t(e[r=i((n+l)/2)])<=0?n=r:l=r;return-1===n||0!==t(e[n])?l:n}),s.shn=((e,t=10,r=5,a=0)=>{if(isNaN(e))return e.toString();e=s.chop(e);let f,c,d=i(n(e));d=0===d?0:d.toString().length,n(e)>l(10,d)-.5&&(d+=1),f=0===d&&0!==e?i(r-o(n(e))):r;let m=e*l(10,f),h=m%10;h<0&&(h+=10),h>=4.5&&h<4.9999999&&(m=i(m));let p=u(m)/l(10,f)+1e-10;if(a<0&&p>e||a>0&&p<e){if(!(r>=10))return s.shn(e,t,r+1,a);p=e}return t<d&&n(l(10,d-1)-p)<.5&&(p=l(10,d-1)),t=s.clip(t,d,d+r),n(p)<1e-4||9===i(p)||99===i(p)||999===i(p)?c=parseFloat(e.toPrecision(f)).toString():(c=p.toPrecision(t)).includes("e")||(c=parseFloat(c)),c}),s.shd=(e=>null===e?"null":s.formatDate(e)),s.shdt=(e=>null===e?"null":s.formatDateTime(e)),s.splur=((e,t,r="")=>(""===r&&(r=t+"s"),s.shn(e,10,5)+" "+(1===e?t:r))),s.normberlize=(e=>{const t=(e="string"==typeof e?e.trim():e.toString()).charAt(0),r=e.substr(1);if("+"===t&&(e=r),"-"===t)return"-"+s.normberlize(r);e=e.replace(/^0+([^eE])/,"$1");if(/^(?:\d+\.?\d*|\.\d+)$/.test(e))return e;const n=e.match(/^(\d+\.?\d*|\.\d+)e([+-]?\d+)$/i);if(!n||3!==n.length)return"NaN";let[,l,o]=n,i=l.indexOf(".");return-1===i&&(i=l.length),i+=+o,l=l.replace(/\./,""),i<0?"."+"0".repeat(-i)+l:(i>l.length?l+="0".repeat(i-l.length):l=l.substring(0,i)+"."+l.substring(i),l.replace(/\.$/,"").replace(/^0+(.)/,"$1"))}),s.quantize=(e=>{let t=s.normberlize(e);return/^-?\d+\.?$/.test(t)?1:+(t=(t=(t=t.replace(/^-?\d*\./,".")).replace(/\d/g,"0")).replace(/0$/,"1"))}),s.round=((e,t=1)=>{if(t<0)return NaN;if(0===t)return+e;const r=u(e/t),n=t.toString().match(/^0?\.(0*)1$/);if(!n)return r*t;const l=-n[1].length-1;return+s.normberlize(`${r}e${l}`)}),s.conservaround=((e,t=1,r=0)=>{let n=s.round(e,t);return 0===r?n:(r<0&&n>e&&(n-=t),r>0&&n<e&&(n+=t),s.round(n,t))}),s.linspace=((e,t,n)=>{if(void 0===n&&(n=r(u(t-e)+1,1)),n<2)return 1===n?[e]:[];let l,o=Array(n);for(l=--n;l>=0;l--)o[l]=(l*t+(n-l)*e)/n;return o}),s.rescale=((e,t,r,l,o)=>n(t-r)<1e-7?e<=(t+r)/2?l:o:l+(e-t)/(r-t)*(o-l)),s.deldups=((e,t=(e=>e))=>{let r={};return e.filter(e=>{const n=JSON.stringify(t(e));return!(n in r)&&(r[n]=!0)})}),s.orderedq=(e=>{for(let t=0;t<e.length-1;t++)if(e[t]>e[t+1])return!1;return!0}),s.nonzero=(e=>{let t,r=e.length;for(t=0;t<r;t++)if(0!==e[t])return!0;return!1}),s.clocky=(e=>{let t=0;for(let r=1;r<e.length;r+=2)t+=e[r]-e[r-1];return t}),s.mean=(e=>{let t,r=0,n=e.length;if(0==n)return 0;for(t=0;t<n;t++)r+=e[t];return r/e.length}),s.median=(e=>{let t=0,r=e.length;return e.sort((e,t)=>e-t),t=r%2==0?(e[r/2-1]+e[r/2])/2:e[(r-1)/2]}),s.mode=(e=>{if(!e||!e.length)return NaN;let t={},r=1,n=e[0];for(const l in e)t[e[l]]=(t[e[l]]||0)+1,t[e[l]]>r&&(r=t[e[l]],n=e[l]);return n}),s.trimmean=((e,t)=>{const r=Math.floor(e.length*t),n=e.sort((e,t)=>e-t).slice(r,e.length-r);return n.reduce((e,t)=>e+t)/n.length}),s.inrange=((e,t,r)=>e>=t&&e<=r),s.nearEq=((e,t,r)=>n(e-t)<r),s.addDays=((t,r)=>{let n=e(t);return n.add(r,"days"),n}),s.daysnap=(t=>{let r=e.unix(t).utc();return r.hours(0),r.minutes(0),r.seconds(0),r.milliseconds(0),r.unix()}),s.monthsnap=(t=>{let r=e.unix(t).utc();return r.date(1).hours(0).minutes(0).seconds(0).milliseconds(0),r.unix()}),s.yearsnap=(t=>{let r=e.unix(t).utc();return r.month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),r.unix()}),s.formatDate=(t=>{let r=e.unix(t).utc(),n=r.year(),l=r.month()+1;l=l<10?"0"+l.toString():l.toString();let o=r.date();return n+"."+l+"."+(o=o<10?"0"+o.toString():o.toString())}),s.formatDateTime=(t=>{let r=e.unix(t).utc(),n=r.hour();n=n<10?"0"+n.toString():n.toString();let l=r.minute();l=l<10?"0"+l.toString():l.toString();let o=r.second();return o=o<10?"0"+o.toString():o.toString(),s.formatDate(t)+" "+n+":"+l+":"+o});let f=RegExp("^(\\d{4})(\\d{2})(\\d{2})$");return s.dayparse=((e,t="")=>{let r,n,l;return null==e?null:(""==t?(r=f,n="YYYYMMDD"):(r=RegExp("^(\\d{4})"+t+"(\\d{2})"+t+"(\\d{2})$"),n="YYYY"+t+"MM"+t+"DD"),(l="string"!=typeof e?null:e.match(r))?Date.UTC(l[1],l[2]-1,l[3])/1e3:isNaN(e)?NaN:Number(e))}),s.dayify=((t,r="")=>{if(isNaN(t)||t<0)return"ERROR";if(null==t)return null;let n=e.unix(t).utc(),l=n.year(),o=n.month()+1,i=n.date();return""+l+r+(o<10?"0":"")+o+r+(i<10?"0":"")+i}),s.nowstamp=((t,r,n)=>{let l;if(t?e.hasOwnProperty("tz")?l=e().tz(t):(console.log("butil.nowstamp: moment-timezone is not loaded, using local time"),l=e()):(console.log("butil.nowstamp: no timezone specified, using local time"),l=e()),n){const t=e.unix(n).utc(),r=(e(l).utc()-t)/1e3;(r<0||r>2*a)&&l.year(t.year()).month(t.month()).date(t.date())}return l.subtract(r,"s"),l.format("YYYYMMDD")}),s.sint=(e=>u(e).toString()),s.loadJSON=(e=>new Promise(function(t,r){""===e&&t(null);let n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.onreadystatechange=function(){if(4==n.readyState&&("200"==n.status||"0"==n.status&&""!=n.responseText))try{t(JSON.parse(n.responseText))}catch(r){console.log("butil.loadJSON: Could not parse JSON file in "+e),console.log(r.message),t(null)}else 4==n.readyState&&t(null)},n.open("GET",e,!0),n.send(null)})),s.toTitleCase=(e=>e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})),s.arrayEquals=((e,t)=>{if(!(e instanceof Array&&t instanceof Array))return!1;if(e.length!=t.length)return!1;for(let r=0,n=e.length;r<n;r++)if(e[r]instanceof Array&&t[r]instanceof Array){if(!s.arrayEquals(e[r],t[r]))return!1}else if(e[r]!==t[r])return!1;return!0}),s.nummy=(e=>!isNaN(parseFloat(e))&&isFinite(e)),s.stringy=(e=>"string"==typeof e),s.listy=(e=>Array.isArray(e)),s.torf=(e=>"boolean"==typeof e),s.born=(e=>s.torf(e)||null===e),s.norn=(e=>s.nummy(e)||null===e),s.timy=(e=>s.nummy(e)&&0<e&&e<s.BDUSK),s.torn=(e=>s.timy(e)||null===e),s.sorn=(e=>"string"==typeof e||null===e),s});
!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["moment","Polyfit","butil"],t):"object"==typeof module&&module.exports?module.exports=t(require("./moment"),require("./polyfit"),require("./butil")):e.broad=t(e.moment,e.Polyfit,e.butil)}(this,function(e,t,n){"use strict";const r=Math.max,l=Math.min,o=Math.abs,s=Math.pow,i=Math.floor,a=(Math.ceil,Math.sign,86400);var u={rsk8:0};u.AGGR={last:e=>e[e.length-1],first:e=>e[0],min:e=>n.arrMin(e),max:e=>n.arrMax(e),truemean:e=>n.mean(e),uniqmean:e=>n.mean(n.deldups(e)),average:e=>n.mean(e),mean:e=>n.mean(n.deldups(e)),median:e=>n.median(e),mode:e=>n.mode(e),trimmean:e=>n.trimmean(e,.1),sum:e=>n.sum(e),jolly:e=>e.length>0?1:0,binary:e=>e.length>0?1:0,nonzero:n.nonzero,triangle:e=>n.sum(e)*(n.sum(e)+1)/2,square:e=>s(n.sum(e),2),clocky:n.clocky,count:e=>e.length,kyshoc:e=>l(2600,n.sum(e)),skatesum:e=>l(u.rsk8,n.sum(e)),cap1:e=>l(1,n.sum(e))},u.RP={DATE:0,VALUE:1,SLOPE:2},u.printRoad=(e=>{for(let r=0;r<e.length;r++){var t=e[r];console.debug("[("+t.sta[0]+"("+n.formatDate(t.sta[0])+"),"+t.sta[1]+"),("+t.end[0]+"("+n.formatDate(t.end[0])+"),"+t.end[1]+"),"+t.slope+", auto="+t.auto+"]")}}),u.sameRoads=((e,t)=>{if(e.length!=t.length)return!1;for(let r=0;r<e.length;r++){if(!n.nearEq(e[r].end[0],t[r].end[0],10))return!1;if(!n.nearEq(e[r].end[1],t[r].end[1],10))return!1;if(!n.nearEq(e[r].slope,t[r].slope,1e-14))return!1}return!0}),u.copyRoad=(e=>{var t=[];for(let r=0;r<e.length;r++){var n={sta:e[r].sta.slice(),end:e[r].end.slice(),slope:e[r].slope,auto:e[r].auto};t.push(n)}return t}),u.findSeg=((e,t)=>n.searchHigh(e,e=>e.end[0]<t?-1:e.sta[0]>t?1:0)),u.segSlope=(e=>(e.end[1]-e.sta[1])/(e.end[0]-e.sta[0])),u.segValue=((e,t)=>e.sta[1]+e.slope*(t-e.sta[0])),u.rdf=((e,t)=>u.segValue(e[u.findSeg(e,t)],t)),u.fixRoadArray=((e,t=u.RP.VALUE,r=!1,l=u.RP.VALUE)=>{const o=e.length;e[0].sta[0]=e[0].end[0]-315576e4,e[0].sta[1]=e[0].end[1];for(let i=1;i<o-1;i++){r&&(t=e[i].auto);var s=e[i].end[1]-e[i].sta[1];e[i].sta[0]=e[i-1].end[0],e[i].sta[1]=e[i-1].end[1],t===u.RP.DATE?(isFinite(e[i].slope)&&0!=e[i].slope&&(e[i].end[0]=n.daysnap(e[i].sta[0]+(e[i].end[1]-e[i].sta[1])/e[i].slope)),e[i].end[0]<=e[i].sta[0]&&(e[i].end[0]=n.daysnap(e[i].sta[0]+a)),l===u.RP.SLOPE?e[i].end[1]=e[i].sta[1]+e[i].slope*(e[i].end[0]-e[i].sta[0]):e[i].slope=u.segSlope(e[i])):t===u.RP.VALUE?isFinite(e[i].slope)?e[i].end[1]=e[i].sta[1]+e[i].slope*(e[i].end[0]-e[i].sta[0]):e[i].end[1]=e[i].sta[1]+s:t===u.RP.SLOPE&&(e[i].slope=u.segSlope(e[i]))}o>1&&(e[o-1].sta[0]=e[o-2].end[0],e[o-1].sta[1]=e[o-2].end[1],e[o-1].end[0]=e[o-1].sta[0]+315576e4,e[o-1].end[1]=e[o-1].sta[1])}),u.gdelt=((e,t,r,l)=>n.chop(t.yaw*(l-u.rdf(e,r)))),u.aok=((e,t,n,r)=>t.yaw*(r-u.rdf(e,n))>=-1e-15*o(r)),u.ppr=((e,t,n,r=null,l=!1)=>{return t.yaw*t.dir>=0?0:l||!(n<=t.asof)||t.ppr&&t.tdat!==t.asof?0===(o=null!=r?e[r].slope*a:u.rtf(e,n)*a)?2*-t.yaw:t.yaw*o>0?0:2*o:0;var o}),u.dtd=((e,t,n,l)=>{if(u.redyest(e,t,n))return 0;let o=0,s=l+u.ppr(e,t,n+o*a);for(;u.aok(e,t,n+o*a,s)&&n+o*a<=r(t.tfin,n);)o+=1,s+=u.ppr(e,t,n+o*a);return o}),u.dtdarray=((e,t)=>{var n,r,l,o,s=e.length,i=e[s-1].sta[0],d=e[s-1].sta[1],f=u.ppr(e,t,0,s-1),h=[];h=[[[i,d,0,d-f,1]]];for(var p=s-2;p>=0;p--){i=e[p].sta[0],d=e[p].sta[1],n=e[p].end[0],r=e[p].end[1],f=u.ppr(e,t,0,p,!0),l=(n-i)/a,o=isFinite(f)?[[i,d,0,r-f*l,l]]:t.dir*(d-r)>0?[[i,d,0,r,l]]:[[i,d,0,r-2*(r-d),l]];for(var g=h[h.length-1],c=0;c<g.length;c++)isFinite(f)?o.push([i,g[c][1]-f*l,g[c][2]+l,g[c][3]-f*l,g[c][4]+l]):t.dir*(d-r)>0?o.push([i,g[c][1],g[c][2],g[c][3],g[c][4]]):o.push([i,g[c][1]-2*(r-d),g[c][2]+(n-i),g[c][3]-2*(r-d),g[c][4]+(n-i)]);h.push(o)}return h}),u.isoline_generate=((e,t,n,r)=>{var l,o,s,i,a,u,d,f,h=t[0],p=0;function g(e,t){var n=e[e.length-1];n[0]==t[0]&&n[1]==t[1]||e.push(t)}for(o=[[h[0][0]+864e3,h[0][1]+r*(h[0][3]-h[0][1])],[h[0][0],h[0][1]+r*(h[0][3]-h[0][1])]],i=1;i<t.length;i++){for(s=(l=t[i]).length-1,a=0;a<l.length;a++)if(r<=l[a][4]){s=a;break}for(a=p;a>=s;a--)u=[h[a][0],h[a][1],h[a][2]],(d=[l[a][0],l[a][3],l[a][4]])[2]-u[2]==0?g(o,[u[0],u[1]]):(f=(r-u[2])/(d[2]-u[2]),g(o,[u[0]+f*(d[0]-u[0]),u[1]+f*(d[1]-u[1])]));u=[l[s][0],l[s][1],l[s][2]],(d=[l[s][0],l[s][3],l[s][4]])[2]-u[2]==0?g(o,[u[0],u[1]]):(f=(r-u[2])/(d[2]-u[2]),g(o,[u[0]+f*(d[0]-u[0]),u[1]+f*(d[1]-u[1])])),p=s,h=l}return o.reverse()}),u.isoline_monotonicity=((e,t,n,r,l)=>{if(r.yaw*r.dir<0)return e;let o,s,i,u,d=[],f=!1,h=!1;const p=function(e,t){e.push([t[0],t[1]])};for(u=-1,i=0;i<e.length-1;i++)if((e[i+1][1]-e[i][1])*r.dir>0&&(f=!1),p(d,e[i]),0!=l&&(e[i+1][1]-e[i][1])*r.dir<0&&!f)for(f=!0,u=i+1,h=!1;!h;)e[u][0]>=e[i][0]+l*a?(h=!0,p(d,[s=e[i][0]+l*a,e[i][1]])):(e[u+1][1]-e[u][1])*r.dir>=0&&(e[u+1][0]!=e[u][0]?0!=(o=(e[u+1][1]-e[u][1])/(e[u+1][0]-e[u][0]))&&(s=e[u][0]+(e[i][1]-e[u][1])/o)<=e[i][0]+l*a&&s<=e[u+1][0]&&(h=!0):(e[i][1]-e[u][1])*(e[i][1]-e[u+1][1])<0&&(s=e[u][0]+1,h=!0),h&&p(d,[s,e[i][1]])),u++;return d}),u.isoline_nobackward=((e,t,n,r,l)=>{var o,s,i,a=[e[0].slice()];for(i=1;i<e.length;i++)o=a[a.length-1],e[i][0]<o[0]||(e[i-1][0]<o[0]&&e[i][0]>o[0]&&e[i][0]-e[i-1][0]!=0&&(s=(e[i][1]-e[i-1][1])/(e[i][0]-e[i-1][0]),a.push([o[0],e[i-1][1]+s*(o[0]-e[i-1][0])])),a.push([e[i][0],e[i][1]]));return a}),u.isoline_clip=((e,t,n,o,s)=>{var i=[];function a(e,t,n){var r=(t[1]-e[1])/(t[0]-e[0]);return e[1]+r*(n-e[0])}function d(e,t,n,r){const l=t[0]-e[0],o=t[1]-e[1],s=-(r[0]-n[0]),i=-(r[1]-n[1]),a=n[0]-e[0],u=n[1]-e[1],d=l*i-s*o;if(0==d)return null;const f=(i*a-s*u)/d,h=(-o*a+l*u)/d;return f<0||f>1||h<0||h>1?null:[e[0]+f*l,e[1]+f*o]}function f(e,t,n,o=-1){for(var s=n.slice(),i=u.findSeg(e,n[0]),a=u.segValue(e[i],n[0]);--i>=0&&e[i].sta[0]==n[0];)a=-o*t.yaw>0?l(a,e[i].sta[1]):r(a,e[i].sta[1]);return(s[1]-a)*t.yaw<0&&(s[1]=a),s}var h,p=0,g=0;for(h=e[1][0]!=e[0][0]?1:-1,i.push(f(t,o,e[0],h));!(p>t.length-1||g>e.length-2);){var c=i.length-1,m=d(t[p].sta,t[p].end,e[g],e[g+1]);null==m||m[0]==i[c][0]&&m[1]==i[c][1]||i.push(m),t[p].end[0]<e[g+1][0]?((a(e[g],e[g+1],t[p].end[0])-t[p].end[1])*o.yaw<0&&i.push([t[p].end[0],t[p].end[1]]),p++):(h=++g<e.length-1&&e[g][0]!=e[g+1][0]?1:-1,i.push(f(t,o,e[g],h)))}return i}),u.isoline=((e,t,n,r,l=!1)=>{let o=u.isoline_generate(e,t,n,r),s=u.isoline_monotonicity(o,e,t,n,r),i=u.isoline_nobackward(s,e,t,n,r),a=u.isoline_clip(i,e,t,n,r);return l?[o,s,i,a]:a}),u.isoval=((e,t)=>{if(!e||!e.length)return null;if(t<=e[0][0])return e[0][1];if(t>=e[e.length-1][0])return e[e.length-1][1];const r=n.searchLow(e,e=>e[0]<=t?-1:1);return n.rescale(t,e[r][0],e[r+1][0],e[r][1],e[r+1][1])}),u.isoside=((e,t,n,r)=>{const l=u.isoval(t,n);return null===l?0:(r-l)*e.yaw>=-1e-15*o(r)?1:-1}),u.dtd_walk=((e,t,n,r)=>{let l=0;for(;u.gdelt(e,t,n+l*a,r)>=0&&n+l*a<=t.tfin;)l+=1;return l}),u.bufcap=((e,t,n=7)=>{const r=t.tcur,l=u.rdf(e,r),s=o(u.rtf(e,r));let i=0,d=0;for(;u.dtd_walk(e,t,r,l+i)<n&&d<=70;)i+=t.yaw*s*a,d+=1;return[i,d]}),u.tvr=((e,t,r,o,s)=>null===r?0===s?n.BDUSK:n.daysnap(l(n.BDUSK,e+(o-t)/s)):null===o?t+s*(r-e):null===s?r===e?0:(o-t)/(r-e):0);const d=(e,t)=>{const n=e[0],r=e[1],l=(e[2],e[3],t[0]),o=t[1],s=t[2],i=u.tvr(n,r,l,o,s);return null===l?[i,o,s,0]:null===o?[l,i,s,1]:null===s?[l,o,i,2]:[l,o,i,0]};return u.fillroad=((e,t)=>{e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]/t.siru),e[0]=d([t.tini,t.vini,0,0],e[0]);for(let t=1;t<e.length;t++)e[t]=d(e[t-1],e[t]);for(e.forEach(e=>e[2]=null==e[2]?e[2]:e[2]*t.siru);void 0!==e&&void 0!==e[0]&&e[0][0]<t.tini;)e.shift();return e}),u.fillroadall=((e,t)=>{const n=e[0][0],r=e[0][1];e.splice(0,1),e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]/t.siru),e[0]=d([n,r,0,0],e[0]);for(let t=1;t<e.length;t++)e[t]=d(e[t-1],e[t]);return e.forEach(e=>e[2]=null===e[2]?e[2]:e[2]*t.siru),e.unshift([n,r,0,2]),e}),u.rtf=((e,t)=>e[u.findSeg(e,t)].slope),u.odomify=(e=>{if(!e||!e.length||0===e.length)return;let t=0,n=e[0][1];for(let r=1;r<e.length;r++)0===e[r][1]&&(t+=n),n=e[r][1],e[r][1]+=t}),u.stepFunc=((e,t)=>{return e[r(0,n.searchLow(e,e=>e[0]-t))][1]}),u.stepify=(e=>e&&e.length?t=>u.stepFunc(e,t):e=>0),u.dotcolor=((e,t,r,l,o=null)=>r<t.tini?n.Cols.BLCK:null===o?u.aok(e,t,r,l)?n.Cols.BLCK:n.Cols.REDDOT:!o||!o.length||o.length<1?n.Cols.ERRDOT:u.isoside(t,o[0],r,l)<0?n.Cols.REDDOT:u.isoside(t,o[1],r,l)<0?n.Cols.ORNDOT:u.isoside(t,o[2],r,l)<0?n.Cols.BLUDOT:u.isoside(t,o[6],r,l)<0?n.Cols.GRNDOT:n.Cols.GRADOT),u.redyest=((e,t,r,l=null)=>u.dotcolor(e,t,r-a,t.dtf(r-a),l)===n.Cols.REDDOT),u.stdflux=((e,t)=>{if(!t||!t.length||t.length<=1)return 0;const r=n.partition(t,2,1);let l,s,i,d,f=[];for(let t=0;t<r.length;t++)l=r[t][0][0],s=r[t][0][1],i=r[t][1][0],d=r[t][1][1],f.push(o(d-s-u.rdf(e,i)+u.rdf(e,l))/(i-l)*a);return n.chop(1===f.length?f[0]:n.quantile(f,.9))}),u.autowiden=((e,t,l,s)=>{let i=l;if(i<=1)return 0;let d=-1;if(u.gdelt(e,t,l[l.length-1][0],l[l.length-1][1])<0){for(;d>=-i&&u.gdelt(e,t,l[d][0],l[d][1])<0;)d-=1;(d+=1)>-i&&l[d][0]-l[d-1][0]<=a&&(s=r(s,o(l[d][1]-u.rdf(e,l[d][0]))))}return n.chop(s)}),u.vertseg=((e,t)=>e.filter(e=>e.sta[0]===t).length>1),u.gapFill=(e=>{var t,n=(e,t,n)=>e+(t-e)*n,r=e[0][0],l=e[e.length-1][0],o=i((l-r)/a),s=Array(o),u=0,d=r;for(t=0;t<e.length-1;t++)for(var f=e[t+1][0]-e[t][0];d<=e[t+1][0];)s[u]=[d,n(e[t][1],e[t+1][1],(d-e[t][0])/f)],u++,d+=a;return 0===s.length&&s.push(e[0]),s}),u.smooth=(e=>{var s=(e[0][0]+e[e.length-1][0])/2,i=n.zip(e),u=i[0].map(e=>(e-s)/a),d=new t(u,i[1]),f=d.getPolynomial(3),h=o(r(...i[1])-l(...i[1]));return d.standardError(d.computeCoefficients(3))>1e4*h&&(console.log("butil.smooth: Possible ill-conditioned polyfit. Reducing dimension."),f=d.getPolynomial(2)),e=>f((e-s)/a)}),u.interpData=((e,t)=>{var n=(e,t,n)=>e+(t-e)*n,r=0,l=e.length,o=[];if(0===l)return null;if(1===l)return t.map(e=>[e,e[0][1]]);for(let i=0;i<t.length;i++){var s=t[i];if(s<=e[0][0])o.push([s,e[0][1]]);else if(s>=e[l-1][0])o.push([s,e[l-1][1]]);else if(s<e[r+1][0])o.push([s,n(e[r][1],e[r+1][1],(s-e[r][0])/(e[r+1][0]-e[r][0]))]);else{for(;s>e[r+1][0];)r++;o.push([s,n(e[r][1],e[r+1][1],(s-e[r][0])/(e[r+1][0]-e[r][0]))])}}return o}),u.lim=((e,t,n)=>u.rdf(e,t.tcur+n*a)),u.limd=((e,t,n)=>u.lim(e,t,n)-t.vcur),u.dueby=((e,t,r)=>{let l=[...Array(r).keys()].map(r=>[n.dayify(t.tcur+r*a),u.limd(e,t,r),u.lim(e,t,r)]);const o=n.zip(l);return n.zip([o[0],n.monotonize(o[1],t.dir),n.monotonize(o[2],t.dir)])}),u});
((n,t)=>{"use strict";"function"==typeof define&&define.amd?define(["moment","butil","broad"],t):"object"==typeof module&&module.exports?module.exports=t(require("./moment"),require("./butil"),require("./broad")):n.beebrain=t(n.moment,n.butil,n.broad)})(this,(n,t,r)=>{"use strict";const i=Math.max,a=Math.min,e=Math.abs,l=Math.exp,o=Math.floor,s=Math.ceil,u=Math.sign,f=365.25,m=86400;let d=1;const c={quantum:1e-5,timey:!1,ppr:!0,deadline:0,sadlhole:!0,asof:null,tini:null,vini:null,road:[],tfin:null,vfin:null,rfin:null,runits:"w",gunits:"units",yaw:0,dir:0,pinkzone:[],tmin:null,tmax:null,vmin:null,vmax:null,kyoom:!1,odom:!1,maxflux:0,monotone:!1,aggday:null,plotall:!0,steppy:!1,rosy:!1,movingav:!1,aura:!1,hashtags:!0,yaxis:"",waterbuf:null,waterbux:"",hidey:!1,stathead:!0,imgsz:760,yoog:"U/G",usr:null,graph:null,goal:null,rate:null},p={sadbrink:!1,safebump:null,dueby:[],fullroad:[],pinkzone:[],tluz:null,tcur:null,vcur:null,vprev:null,rcur:null,ravg:null,tdat:null,stdflux:0,delta:0,lane:666,cntdn:0,numpts:0,mean:0,meandelt:0,proctm:0,statsum:"",ratesum:"",deltasum:"",graphsum:"",progsum:"",rah:0,safebuf:null,error:"",limsum:"",headsum:"",titlesum:"",lnw:0,color:"black",loser:!1,gldt:null,goal:null,rate:null,road:[],tini:null,vini:null,tfin:null,vfin:null,rfin:null},h=["ybhp","integery","noisy","abslnw","tagtime","timezone","backroad","edgy","offred"],g={AGGPAST:0,AGGFUTURE:1,RAWPAST:2,RAWFUTURE:3,FLATLINE:4,HOLLOW:5};return function(y){let v=this,b=d;d++,y=t.deepcopy(y);let x=[],w={},A=[],z=[],R=[],k=[],M=[],T=[],E=[],S={},G={},U={},O={},P=[];w.yaw=1,w.dir=1,w.tcur=0,w.vcur=0,w.vprev=0;const N=n.utc();function L(n){if(n.fullroad=n.fullroad.map(n=>(function(n){return Array.isArray(n)?n.length<=3?n:n.slice(0,3):n})(n)),n.road=n.fullroad,n.error)n.gldt=t.dayify(w.tfin),n.goal=w.vfin,n.rate=w.rfin*w.siru;else{const t=n.fullroad.length;t>0&&(n.gldt=n.fullroad[t-1][0],n.goal=n.fullroad[t-1][1],n.rate=n.fullroad[t-1][2])}n.tini=t.dayify(w.tini),n.vini=w.vini,n.tfin=t.dayify(w.tfin),n.vfin=w.vfin,n.rfin=w.rfin}function D(n){return Array.isArray(n)&&3===n.length?[t.dayparse(n[0]),n[1],n[2]]:n}function K(n){if(n.length<1)return n;let r=n.slice();return r[0]=t.dayify(n[0]),r}function $(n,t){let r=.25/m;"meta/derev"===w.yoog&&(r=.03/m),"meta/dpledge"===w.yoog&&(r=.03/m);let i,a,e,o,s,u=n[0][0],f=n[0][1],d=f;if(t<u)return d;for(e=1;e<n.length;e++){if(i=(a=n[e])[0]-u,o=(a[1]-f)/i,s=f,t<a[0])return s+o*(i=t-u)-o/r+(d-s+o/r)*l(-r*i);d=s+o*i-o/r+(d-s+o/r)*l(-r*i),u=a[0],f=a[1]}return s+o*(i=t-u)-o/r+(d-s+o/r)*l(-r*i)}function B(n,r,i){let a=t.zip(n);return a[1]=function(n,r,i){return t.foldlist((n,i)=>t.clip(n,i-r,i+r),n[0]+i*r,n.slice(1,n.length))}(a[1],r,i),t.zip(a)}function F(n,t,r){return B(n.slice().reverse(),t,r).reverse()}let H;N.hour(0),N.minute(0),N.second(0),N.millisecond(0),w.asof=N.unix(),w.horizon=w.asof+t.AKH,w.xMin=w.asof,w.xMax=w.horizon,w.yMin=-1,w.yMax=1;try{H=new RegExp("(?:^|\\s)(#\\p{L}[\\p{L}0-9_]*)(?=$|[\\s])","gu")}catch{H=/(?:^|\s)(#[a-zA-Z]\w*)(?=$|\s)/g}function q(n){let t,r=new Set;for(H.lastIndex=0;null!=(t=H.exec(n));)""!=t[1]&&r.add(t[1]);return r}function I(n){return n[1]}function j(n,r){const i=w.kyoom&&"sum"===w.aggday;if(1===n.length)return[n[0][2],n[0][3],n[0][4]];{let a;return(a=i?t.accumulate(n.map(I)).indexOf(r):n.map(I).indexOf(r))<0?[w.aggday,null,null]:[n[a][1]+" ("+w.aggday+")",n[a][3],n[a][4]]}}let C=null;function W(n){return JSON.stringify(null==n[0]?n:[t.formatDate(n[0]),n[1],n[2]])}const Y=[["deadline",n=>-64800<=n&&n<=21600,"outside 6am earlybird to 6am nightowl"],["asof",n=>null!=n,"can't be null! Tell support!"],["asof",t.torn,"isn't a valid timestamp"],["tini",t.timy,"isn't a valid timestamp"],["vini",t.nummy,"isn't numeric"],["road",t.listy,"(graph matrix) isn't a list"],["tfin",t.torn,"isn't a valid timestamp"],["vfin",t.norn,"isn't numeric or null"],["rfin",t.norn,"isn't numeric or null"],["runits",n=>n in t.SECS,"isn't a valid rate unit"],["yaw",n=>0==n||1==n||-1==n,"isn't in [0,-1,1]"],["dir",n=>1==n||-1==n,"isn't in -1,1]"],["tmin",t.torn,"isn't a number/timestamp"],["tmax",t.torn,"isn't a valid timestamp"],["vmin",t.norn,"isn't numeric or null"],["vmax",t.norn,"isn't numeric or null"],["kyoom",t.torf,"isn't boolean"],["odom",t.torf,"isn't boolean"],["monotone",t.torf,"isn't boolean"],["aggday",n=>n in r.AGGR,"isn't one of max, sum, last, mean, etc"],["plotall",t.torf,"isn't boolean"],["steppy",t.torf,"isn't boolean"],["rosy",t.torf,"isn't boolean"],["movingav",t.torf,"isn't boolean"],["aura",t.torf,"isn't boolean"],["yaxis",t.stringy,"isn't a string"],["yaxis",n=>n.length<80,"string is too long\\n"],["waterbuf",t.sorn,"isn't a string or null"],["waterbux",t.stringy,"isn't a string"],["hidey",t.torf,"isn't boolean"],["stathead",t.torf,"isn't boolean"],["imgsz",t.nummy,"isn't numeric"],["yoog",t.stringy,"isn't a string"]];function J(){w.dtf=r.stepify(z),w.road=r.fillroad(w.road,w);const n=w.road.length;w.tfin=w.road[n-1][0],w.vfin=w.road[n-1][1],w.rfin=w.road[n-1][2];const e=w.road.map(n=>n[0]);if(w.tini>e[0])return"Graph matrix error\\n(There are segments of your bright red line\\nthat are somehow dated before your goal's start date!)";if(!t.orderedq(e))return"Dial error\\n(Your goal date, goal "+(w.kyoom?"total":"value")+", and rate are inconsistent!\\nIs your rate positive when you meant negative?\\nOr is your goal "+(w.kyoom?"total":"value")+" such that the implied goal date is in the past?)";w.stdflux=r.stdflux(x,z.filter(n=>n[0]>=w.tini)),function(){const n=w.asof,i=z.length,e=0===z.length?w.tini:z[i-1][0],l=0===z.length?w.vini:z[i-1][1];if(e>w.tfin)return;let o=e;if(w.yaw*w.dir<0)o=a(n,w.tfin);else{let e,s=null;for(;o<=a(n,w.tfin)&&(s!==(e=r.dotcolor(x,w,o,l,w.isolines))||s!==t.Cols.REDDOT);)s=e,o+=m;o=a(o,n,w.tfin);for(let n=0;n<i;n++)if(o==z[n][0])return}if(!(o in G)){const n=0===z.length?[w.tini,w.vini]:z[i-1];C=[o,l,"PPR",g.FLATLINE,n[0],n[1],null],z.push(C)}}();const l=z.length;if(w.movingav)if(l<=1||z[l-1][0]-z[0][0]<=0)w.filtpts=[];else{const n=function(n,r,i=6e3){return t.linspace(n,r,o(t.clip((r-n)/(m+1),a(600,640),i)))}(z[0][0],z[l-1][0],4*(z[l-1][0]-z[0][0])/m);JSON.stringify(n),w.filtpts=n.map(n=>[n,$(z,n)])}else w.filtpts=[];return w.tcur=z[l-1][0],w.vcur=z[l-1][1],w.vprev=z[i(l-2,0)][1],w.safebuf=r.dtd(x,w,w.tcur,w.vcur),w.tluz=a(w.tcur+w.safebuf*m,w.tfin+m,t.BDUSK),w.tluz>w.tfin&&(w.tluz=t.BDUSK),w.delta=t.chop(w.vcur-r.rdf(x,w.tcur)),w.rah=r.rdf(x,w.tcur+t.AKH),w.dueby=r.dueby(x,w,7),w.safebump=r.lim(x,w,w.safebuf),w.rcur=r.rtf(x,w.tcur)*w.siru,w.ravg=r.tvr(w.tini,w.vini,w.tfin,w.vfin,null)*w.siru,w.cntdn=s((w.tfin-w.tcur)/m),w.lane=w.yaw*(w.safebuf-(w.safebuf<=1?2:1)),w.color=w.safebuf<1?"red":w.safebuf<2?"orange":w.safebuf<3?"blue":"green",w.loser=r.redyest(x,w,w.tcur),w.sadbrink=w.tcur-m>w.tini&&r.dotcolor(x,w,w.tcur-m,w.dtf(w.tcur-m,w.isolines))==t.Cols.REDDOT,function(){if(null==w.tmin&&(w.tmin=a(w.tini,w.asof)),null==w.tmax){const n=o((w.tcur-w.tmin)/(f*m));w.tmax=t.daysnap(2*(1+n/2)*t.AKH+w.tcur)}if(null!=w.vmin&&null!=w.vmax)return void(w.vmin==w.vmax?(w.vmin-=1,w.vmax+=1):w.vmin>w.vmax&&([w.vmin,w.vmax]=[w.vmax,w.vmin]));const n=r.rdf(x,w.tmin),e=r.rdf(x,w.tmax),l=z.filter(n=>n[0]<=w.tmax&&n[0]>=w.tmin).map(n=>n[1]);let s=t.arrMin(l),u=t.arrMax(l);if(null!=C&&C[0]<=w.tmax&&C[0]>=w.tmin){const n=C[1]+r.ppr(x,w,w.asof);s=a(s,n),u=i(u,n)}const d=i(0,.015*(u-s)*2);let c=s-d,p=u+d;w.monotone&&w.dir>0?(c=t.arrMin([c,n,e]),p=t.arrMax([p,n,e])):(w.monotone&&w.dir,c=t.arrMin([c,n,e]),p=t.arrMax([p,n,e])),w.plotall&&w.tmin<=w.tini&&w.tini<=w.tmax&&w.tini in S&&(c=a(c,t.arrMin(S[w.tini].map(n=>n[1]))),p=i(p,t.arrMax(S[w.tini].map(n=>n[1])))),null==w.vmin&&null==w.vmax?(w.vmin=c,w.vmax=p,w.vmin==w.vmax?(w.vmin-=1,w.vmax+=1):w.vmin>w.vmax&&([w.vmin,w.vmax]=[w.vmax,w.vmin])):null==w.vmin?w.vmin=c<w.vmax?c:w.vmax-1:null==w.vmax&&(w.vmax=p>w.vmin?p:w.vmin+1)}(),""}this.reloadRoad=function(){const n=J();if(""!=n)return n;if(function(n,i){const a=i.yaw,l=i.dir,s=i.lane,f=i.delta,d=i.quantum,c=a>0&&l>0,p=a<0&&l<0,h=a<0&&l>0,g=a>0&&l<0,y=(n,r=a,i=4,e=2)=>null===d?t.shn(n,i,e,r):t.conservaround(n,d,r),v=(n,t=a,r=4,i=2)=>(n>=0?"+":"")+y(n,t,r,i);if(""!=i.error)return void(i.statsum=" error:    "+i.error+"\\n");const b=t.zip(i.road)[2];let w=t.arrMin(b),A=t.arrMax(b);if(e(w)>e(A)){const n=w;w=A,A=n}const R=t.shn(w,4,2),k=t.shn(A,4,2),M=t.shn(i.ravg,4,2),T=t.shn(i.rcur,4,2);i.ratesum=(w===A?R:"between "+R+" and "+k)+" per "+t.UNAM[i.runits]+(w!==A?" (current: "+T+", average: "+M+")":"");const E=t.daysnap(i.tini),S=t.daysnap(i.tcur),G=t.daysnap(i.tfin),U=i.vini,O=i.vcur,P=i.vfin;let N,L,D,K;N=E===G?"??":t.shn(t.rescale(S,E,G,0,100),1,1),L=U===P?O<U&&i.yaw>0||O>U&&i.yaw<0?"00":"100":e(U-P)<1e-7?O<(U+P)/2&&i.yaw>0||O>(U+P)/2&&i.yaw<0?"~0":"~100":t.shn(t.rescale(i.vcur,i.vini,i.vfin,0,100),1,1),i.progsum=N==L?N+"% done":N+"% done by time -- "+L+"% by value",i.cntdn<7?(D=u(i.rfin)*(i.vfin-i.vcur),K="To go to goal: "+y(D,0,2,1)+"."):K="Yellow Brick Rd = "+((D=r.rdf(x,i.tcur+i.siru)-r.rdf(x,i.tcur))>=0?"+":"")+t.shn(D,2,1,0)+" / "+t.UNAM[i.runits]+".",i.graphsum=y(i.vcur,0,3,1)+" on "+t.shd(i.tcur)+" ("+t.splur(i.numpts,"datapoint")+" in "+t.splur(1+o((i.tcur-i.tini)/m),"day")+") targeting "+y(i.vfin,0,3,1)+" on "+t.shd(i.tfin)+" ("+t.splur(i.cntdn,"more day")+"). "+K,i.deltasum=y(e(f),0)+" "+i.gunits+(f<0?" below":" above")+" the bright line";const $=i.safebuf,B=t.splur($,"day"),F=r.lim(x,i,c||p?$:0),H=r.limd(x,i,c||p?$:0);i.kyoom?(c&&(i.limsum=v(H)+" in "+B),p&&(i.limsum=v(H)+" in "+B),h&&(i.limsum=v(H)+" today"),g&&(i.limsum=v(H)+" today")):(c&&(i.limsum=v(H)+" in "+B+" ("+y(F)+")"),p&&(i.limsum=v(H)+" in "+B+" ("+y(F)+")"),h&&(i.limsum=v(H)+" today ("+y(F)+")"),g&&(i.limsum=v(H)+" today ("+y(F)+")")),i.safeblurb=a*l<0?"unknown days of safety buffer":$>999?"more than 999 days of safety buffer":"~"+B+" of safety buffer",i.titlesum=t.toTitleCase(i.color)+": bmndr.com/"+i.yoog+" is safe for ~"+B+(0===$?" (beemergency!)":""),i.headsum=i.titlesum,i.statsum=" progress: "+t.shd(i.tini)+"  "+(null==z?"?":t.shn(i.vini,4,2,0))+"\\n           "+t.shd(i.tcur)+"  "+t.shn(i.vcur,4,2,0)+"   ["+i.progsum+"]\\n           "+t.shd(i.tfin)+"  "+t.shn(i.vfin,4,2,0)+"\\n rate:     "+i.ratesum+"\\n lane:     "+(666==e(s)?"n/a":s)+"\\n safebuf:  "+i.safebuf+"\\n delta:    "+i.deltasum+"\\n ",i.statsum+=0==a?"limit:    ":a<0?"hard cap: ":"bare min: ",i.statsum+=i.limsum+"\\n"}(0,w),w.fullroad=w.road.slice(),w.fullroad.unshift([w.tini,w.vini,0,0]),""==w.error&&(w.pinkzone=[[w.asof,r.rdf(x,w.asof),0]],w.road.forEach(function(n){n[0]>w.asof&&n[0]<w.asof+t.AKH&&w.pinkzone.push([n[0],n[1],null])}),w.pinkzone.push([w.asof+t.AKH,r.rdf(x,w.asof+t.AKH),null]),w.pinkzone=r.fillroadall(w.pinkzone,w)),w.aura){const n=z.filter(n=>n[0]>=w.tmin),t=r.gapFill(n);w.auraf=r.smooth(t)}else w.auraf=(n=>0);w.dtdarray=r.dtdarray(x,w),w.isolines=[];for(let n=0;n<4;n++)w.isolines[n]=r.isoline(x,w.dtdarray,w,n);return""};let V={};this.getStats=function(){return t.deepcopy(V)},this.setRoadObj=function(n){if(0!=n.length){x=n,v.roads=x,w.road=[];for(let n=1;n<x.length;n++)w.road.push([x[n].sta[0],x[n].sta[1],x[n].slope]);v.gol=w,v.reloadRoad()}else console.log("id="+b+", setRoadObj(), null redline!")},function(e,l,o=null){try{null==o&&(o=n.utc().unix()),function(n){"goal"in n&&!("vfin"in n)&&(n.vfin=n.goal),"rate"in n&&!("rfin"in n)&&(n.rfin=n.rate),"usr"in n&&"graph"in n&&!("yoog"in n)&&(n.yoog=n.usr+"/"+n.graph)}(e),function(){z=[],C=null,k=[],S={},G={},U={},(w={}).siru=null,M=[],T=[],O={};for(const n in p)w[n]=p[n];for(const n in c)w[n]=c[n]}(),w.proctm=o,z=function(n,r){return["asof","tini","tfin","tmin","tmax"].map(r=>{r in n&&(n[r]=t.dayparse(n[r]))}),"road"in n&&t.listy(n.road)&&(n.road=n.road.map(D)),r.map((n,r)=>[t.dayparse(n[0]),n[1],n[2],r,n[1]]).sort((n,t)=>n[0]!==t[0]?n[0]-t[0]:n[3]-t[3])}(e,l);const s=[];for(const n in e)n in e&&(n in c||h.includes(n)?w[n]=e[n]:s.push(`${n}=${e[n]}`));s.length>0&&(w.error+=`Unknown param${1===s.length?"":"s"}: ${s.join(", ")}`),"aggday"in e||(e.aggday=w.kyoom?"sum":"last"),w.siru=t.SECS[w.runits],w.horizon=w.asof+t.AKH-m,w.waterbuf0=w.waterbuf,t.listy(w.road)&&w.road.push([w.tfin,w.vfin,w.rfin]),""==w.error&&(w.error=function(){const n=n=>JSON.stringify(n);let r;for(r=0;r<Y.length;r++){const t=Y[r];if(!t[1](w[t[0]]))return`'${t[0]}' ${t[2]}: ${n(w[t[0]])}`}const i=w.road;for(r=0;r<i.length;r++)if(a=i[r],!t.listy(a)||3!=a.length||!(null==a[0]&&t.nummy(a[1])&&t.nummy(a[2])||t.nummy(a[0])&&null==a[1]&&t.nummy(a[2])||t.nummy(a[0])&&t.nummy(a[1])&&null==a[2]))return"Invalid graph matrix row: "+W(i[r]);var a;const e=i.slice(1,i.length-1);if(e.length!=t.deldups(e).length){let n=e[0];for(r=1;r<e.length;r++){if(t.arrayEquals(e[r],n))return"Graph matrix has duplicate row: "+W(e[r]);n=e[r]}return"Graph matrix duplicate row error! Tell support!"}return w.kyoom&&w.odom?"The odometer setting doesn't make sense for an auto-summing goal!":w.tmin>w.asof?"You can't set the graph bounds to be solely in the future!":""}()),""==w.error&&(w.error=function(){if(!z||!z.length)return"No datapoints";const n=z.length;let i;for(i=0;i<n;i++){const n=z[i];if(!(t.nummy(n[0])&&n[0]>0&&t.nummy(n[1])&&t.stringy(n[2])))return"Invalid datapoint: "+n[0]+" "+n[1]+' "'+n[3];if(w.hashtags){const t=q(n[2]);if(0==t.size)continue;n[0]in O||(O[n[0]]=new Set);for(const r of t)O[n[0]].add(r)}}if(w.hashtags){P=[];for(const n in O)P.push([n,Array.from(O[n]).join(" ")])}for(T=(T=z.filter(n=>(function(n){return n.startsWith("RECOMMITTED")})(n[2]))).map(n=>n.slice()),i=0;i<T.length;i++)T[i][0]<1562299200&&(T[i][0]-=m);w.odom&&(M=z.filter(n=>0==n[1]).map(n=>n[0]),r.odomify(z));const a=z.filter(n=>n[0]<=w.asof);w.plotall&&(w.numpts=a.length),S={},G={};let e,l=[],o=z[0][0],s=[],u=0;for(r.rsk8=w.rfin*m/w.siru,i=0;i<=n;i++)if(i<n&&z[i][0]==o&&s.push(z[i].slice()),i>=z.length||z[i][0]!=o){let n=s.map(I),a=r.AGGR[w.aggday](n);e=l.length>0?l[l.length-1]:[o,a+u];let f=j(s,a);l.push([o,u+a,f[0],o<=w.asof?g.AGGPAST:g.AGGFUTURE,e[0],e[1],f[2],f[1]]),w.kyoom?("sum"===w.aggday?S[o]=t.accumulate(n).map((n,t)=>[o,n+u,s[t][2],s[t][3],s[t][4]]):S[o]=s.map(n=>[o,n[1]+u,n[2],n[3],n[4]]),G[o]=u+a,u+=a):(S[o]=s,G[o]=a);const m=S[o].map(n=>n[1]);U[o]=w.yaw<0?t.arrMax(m):t.arrMin(m),i<z.length&&(o=z[i][0],s=[z[i].slice()])}let f=[];for(let n in S)f=f.concat(S[n].map(t=>[Number(n),t[1],t[2],Number(n)<=w.asof?g.AGGPAST:g.AGGFUTURE,null,null,t[4],t[3]]));if(A=f,k=l.filter(n=>n[0]>w.asof),z=l.filter(n=>n[0]<=w.asof),w.plotall||(w.numpts=z.length),0==z.length)return w.tdat=w.tcur,w.mean=0,E=[],"";const d=r.gapFill(z).map(n=>n[1]);for(z.length>0&&(w.mean=t.mean(d)),z.length>1&&(w.meandelt=t.mean(t.partition(d,2,1).map(n=>n[1]-n[0]))),w.tdat=z[z.length-1][0],i=0;i<T.length;i++){const n=1562299200;(o=T[i][0]<n?T[i][0]+m:T[i][0])in U&&(T[i][1]=G[o])}return E=z.filter(n=>n[0]in S&&n[0]<w.asof&&!S[n[0]].map(n=>n[1]).includes(n[1])),""}()),""==w.error&&(w.error=function(n){const i=t.BDUSK;x=[];const e=n;if(!e)return"Road param missing";const l=e.length;let o,s=w.tini,u=w.vini;null!=e[0][0]&&e[0][0]<s&&(s=e[0][0],null!=e[0][1]&&(u=e[0][1])),(o={sta:[s,Number(u)],slope:0,auto:r.RP.SLOPE}).end=o.sta.slice(),o.sta[0]=t.daysnap(o.sta[0]-100*m*f),x.push(o);for(let n=0;n<l;n++){let t={};t.sta=x[x.length-1].end.slice();let l=null,o=null,s=null;l=e[n][0],o=e[n][1],s=e[n][2],null==l?(t.end=[0,Number(o)],t.slope=Number(s)/w.siru,0!=t.slope?t.end[0]=t.sta[0]+(t.end[1]-t.sta[1])/t.slope:(t.end[0]=i,t.end[1]=t.sta[1]),t.end[0]=a(i,t.end[0]),t.end[1]=t.sta[1]+t.slope*(t.end[0]-t.sta[0]),t.auto=r.RP.DATE):null==o?(t.end=[l,0],t.slope=Number(s)/w.siru,t.end[1]=t.sta[1]+t.slope*(t.end[0]-t.sta[0]),t.auto=r.RP.VALUE):null==s&&(t.end=[l,Number(o)],t.slope=r.segSlope(t),t.auto=r.RP.SLOPE),t.end[0]>=t.sta[0]&&x.push(t)}const d=x[x.length-1],c={sta:d.end.slice(),end:d.end.slice(),slope:0,auto:r.RP.VALUE};return c.end[0]=t.daysnap(c.end[0]+100*m*f),x.push(c),""}(e.road)),""==w.error&&(w.error=v.reloadRoad()),function(){if(!w.rosy||0==z.length)return;const n=i(0,w.stdflux);let r,a;w.dir>0?(r=B(z,n,-1),a=F(z,n,1)):(r=F(z,n,-1),a=B(z,n,1));const e=r.map(n=>n[1]),l=a.map(n=>n[1]),o=t.zip([e,l]).map(n=>(n[0]+n[1])/2),s=z.map(n=>n[0]);R=(R=t.zip([s,o])).map(n=>[n[0],n[1],"rosy data",g.RAWPAST,n[0],n[1],n[1]]);for(let n=1;n<R.length-1;n++)R[n][4]=R[n-1][0],R[n][5]=R[n-1][1]}()}finally{V=Object.assign({},p);for(const n in V)V[n]=w[n];!function(n){n.fullroad=n.fullroad.map(K),"razrmatr"in p&&(n.razrmatr=n.razrmatr.map(K)),n.pinkzone=n.pinkzone.map(K),n.tluz=t.dayify(n.tluz),n.tcur=t.dayify(n.tcur),n.tdat=t.dayify(n.tdat)}(V),L(V)}}(y.params,y.data),w.graphurl=t.BBURL,w.thumburl=t.BBURL,this.id=b,this.DPTYPE=g,this.roads=x,this.gol=w,this.data=z,this.rosydata=R,this.alldata=A,this.allvals=S,this.fuda=k,this.flad=C,this.oresets=M,this.derails=T,this.hollow=E,this.hashtags=P}});